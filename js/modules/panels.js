/**
 * GridDown Panels Module - All Panel Content
 */
const PanelsModule = (function() {
    'use strict';
    let container;
    let measurePanelEl = null;
    let initialized = false;
    let lastRenderedPanel = null;
    
    // Scroll preservation for panel re-renders
    let _savedPanelScroll = 0;
    function _saveScroll() { _savedPanelScroll = container ? container.scrollTop : 0; }
    function _restoreScroll() {
        const s = _savedPanelScroll;
        if (s > 0 && container) {
            requestAnimationFrame(() => { if (container) container.scrollTop = s; });
        }
    }
    
    // Cached DOM references to avoid repeated getElementById calls
    let modalContainer = null;
    
    // Lazy getter for dynamically created SSTV content element
    function getSstvContent() {
        if (!sstvContentEl || !sstvContentEl.isConnected) {
            sstvContentEl = document.getElementById('sstv-content');
        }
        return sstvContentEl;
    }
    let sstvContentEl = null;
    
    // Cached DOM references for dynamic panel elements.
    // Populated after panel renders, invalidated on panel switch.
    const domCache = {
        _refs: {},
        get(id) {
            let el = this._refs[id];
            if (!el || !el.isConnected) {
                el = document.getElementById(id);
                this._refs[id] = el;
            }
            return el;
        },
        clear() {
            this._refs = {};
        }
    };
    
    // Track delegated event handlers for cleanup
    let coordConverterState = {
        parsedCoords: null,
        inputTimeout: null
    };
    
    // Track visual feedback timeouts to prevent stacking on rapid clicks
    let feedbackTimeouts = {};

    function init() {
        // Prevent double initialization
        if (initialized) {
            console.debug('PanelsModule already initialized');
            return;
        }
        
        container = document.getElementById('panel-content');
        if (!container) return;
        
        // Cache hot DOM references
        modalContainer = document.getElementById('modal-container');
        
        // Inject persistent close button into panel element (above scrolling content)
        const panelEl = document.getElementById('panel');
        if (panelEl && !panelEl.querySelector('.panel__close-btn')) {
            const closeBtn = document.createElement('button');
            closeBtn.className = 'panel__close-btn';
            closeBtn.setAttribute('aria-label', 'Close panel');
            closeBtn.setAttribute('title', 'Close panel');
            closeBtn.innerHTML = Icons.get('close');
            closeBtn.onclick = () => State.UI.closePanel();
            panelEl.appendChild(closeBtn);
        }
        
        // Setup event delegation for panel interactions
        setupEventDelegation();
        
        render();
        State.subscribe(render, ['activePanel', 'waypoints', 'routes', 'mapLayers', 'selectedWaypoint', 'selectedVehicle', 'waypointFilter', 'mapRegions', 'teamMembers']);
        State.subscribe(updatePanelVisibility, ['isPanelOpen']);
        const offlineBtn = domCache.get('offline-toggle');
        if (offlineBtn) offlineBtn.onclick = () => { State.UI.toggleOffline(); updateOfflineToggle(); };
        updateOfflineToggle();
        
        // Set up measure panel event listeners
        setupMeasurePanel();
        
        // Subscribe to undo state changes to update UI
        if (typeof UndoModule !== 'undefined') {
            Events.on('undo:stateChange', () => {
                // Re-render if on waypoints or routes panel to update undo buttons
                const panel = State.get('activePanel');
                if (panel === 'waypoints' || panel === 'routes') {
                    updateUndoToolbar();
                }
            });
        }
        
        initialized = true;
    }
    
    /**
     * Setup event delegation for common panel interactions
     * This reduces memory usage by using a single listener instead of many
     */
    function setupEventDelegation() {
        // Handle click events via delegation
        container.addEventListener('click', handleDelegatedClick);
        
        // Handle change events via delegation
        container.addEventListener('change', handleDelegatedChange);
        
        // Handle input events via delegation
        container.addEventListener('input', handleDelegatedInput);
    }
    
    /**
     * Handle delegated click events
     */
    function handleDelegatedClick(e) {
        const target = e.target;
        
        // Coordinate converter example buttons
        if (target.closest('.coord-example')) {
            const btn = target.closest('.coord-example');
            const input = container.querySelector('#coord-input');
            if (input && btn.dataset.example) {
                input.value = btn.dataset.example;
                input.dispatchEvent(new Event('input', { bubbles: true }));
            }
            return;
        }
        
        // Coordinate copy buttons
        if (target.closest('.coord-copy-btn')) {
            const btn = target.closest('.coord-copy-btn');
            const format = btn.dataset.copy;
            const valueEl = container.querySelector(`#result-${format}`);
            if (valueEl && valueEl.textContent !== '--') {
                copyToClipboard(valueEl.textContent);
                showCoordToast(`${format.toUpperCase()} copied to clipboard`);
            }
            return;
        }
        
        // Coordinate format buttons
        if (target.closest('.coord-format-btn')) {
            const btn = target.closest('.coord-format-btn');
            const format = btn.dataset.format;
            if (typeof Coordinates !== 'undefined') {
                Coordinates.setFormat(format);
                container.querySelectorAll('.coord-format-btn').forEach(b => {
                    b.classList.toggle('coord-format-btn--active', b.dataset.format === format);
                });
                renderCoordinateConverter();
                showCoordToast(`Display format set to ${format.toUpperCase()}`);
            }
            return;
        }
        
        // Go button for coordinates
        if (target.closest('#coord-go-btn')) {
            if (coordConverterState.parsedCoords && typeof MapModule !== 'undefined') {
                MapModule.setCenter(coordConverterState.parsedCoords.lat, coordConverterState.parsedCoords.lon);
                showCoordToast('Map centered on coordinates');
            } else if (!coordConverterState.parsedCoords) {
                showCoordToast('Enter valid coordinates first', 'error');
            }
            return;
        }
        
        // Create waypoint from coordinates
        if (target.closest('#coord-create-waypoint')) {
            if (coordConverterState.parsedCoords && typeof ModalsModule !== 'undefined') {
                ModalsModule.openWaypointModal({
                    lat: coordConverterState.parsedCoords.lat,
                    lon: coordConverterState.parsedCoords.lon,
                    x: lonToX(coordConverterState.parsedCoords.lon),
                    y: latToY(coordConverterState.parsedCoords.lat)
                });
            }
            return;
        }
        
        // Distance calculator button
        if (target.closest('#calc-distance-btn')) {
            handleDistanceCalculation();
            return;
        }
        
        // ---- Communication Plan delegation ----
        
        // Save comm plan
        if (target.closest('#save-comm-plan')) {
            commPlan.emergency.distressWord = container.querySelector('#distress-word')?.value || 'MAYDAY';
            commPlan.emergency.duressWord = container.querySelector('#duress-word')?.value || '';
            commPlan.emergency.emergencyChannel = container.querySelector('#emergency-channel')?.value || '';
            commPlan.emergency.rallyPoint = container.querySelector('#rally-point')?.value || '';
            commPlan.schedule.missedCheckInProtocol = container.querySelector('#missed-protocol-text')?.value || '';
            commPlan.notes = container.querySelector('#comm-notes')?.value || '';
            saveCommPlan();
            return;
        }
        
        // Export comm plan
        if (target.closest('#comm-export-btn')) {
            exportCommPlan();
            return;
        }
        
        // Add buttons (channels, callsigns, check-ins, protocols)
        if (target.closest('#add-channel-btn')) { openChannelModal(); return; }
        if (target.closest('#add-callsign-btn')) { openCallSignModal(); return; }
        if (target.closest('#add-checkin-btn')) { openCheckInModal(); return; }
        if (target.closest('#add-protocol-btn')) { openProtocolModal(); return; }
        
        // Edit buttons (data-edit-*)
        const editChannel = target.closest('[data-edit-channel]');
        if (editChannel) {
            const channel = commPlan.channels.find(c => c.id === editChannel.dataset.editChannel);
            if (channel) openChannelModal(channel);
            return;
        }
        const editCallsign = target.closest('[data-edit-callsign]');
        if (editCallsign) {
            const cs = commPlan.callSigns.find(c => c.id === editCallsign.dataset.editCallsign);
            if (cs) openCallSignModal(cs);
            return;
        }
        const editCheckin = target.closest('[data-edit-checkin]');
        if (editCheckin) {
            const ck = commPlan.schedule.checkIns.find(c => c.id === editCheckin.dataset.editCheckin);
            if (ck) openCheckInModal(ck);
            return;
        }
        const editProtocol = target.closest('[data-edit-protocol]');
        if (editProtocol) {
            const ep = commPlan.emergency.protocols.find(p => p.id === editProtocol.dataset.editProtocol);
            if (ep) openProtocolModal(ep);
            return;
        }
        
        // Delete buttons (data-delete-*)
        const deleteChannel = target.closest('[data-delete-channel]');
        if (deleteChannel) {
            if (confirm('Delete this channel?')) {
                commPlan.channels = commPlan.channels.filter(c => c.id !== deleteChannel.dataset.deleteChannel);
                saveCommPlan();
                renderComms();
            }
            return;
        }
        const deleteCallsign = target.closest('[data-delete-callsign]');
        if (deleteCallsign) {
            if (confirm('Delete this call sign?')) {
                commPlan.callSigns = commPlan.callSigns.filter(c => c.id !== deleteCallsign.dataset.deleteCallsign);
                saveCommPlan();
                renderComms();
            }
            return;
        }
        const deleteCheckin = target.closest('[data-delete-checkin]');
        if (deleteCheckin) {
            if (confirm('Delete this check-in?')) {
                commPlan.schedule.checkIns = commPlan.schedule.checkIns.filter(c => c.id !== deleteCheckin.dataset.deleteCheckin);
                saveCommPlan();
                renderComms();
            }
            return;
        }
        const deleteProtocol = target.closest('[data-delete-protocol]');
        if (deleteProtocol) {
            if (confirm('Delete this protocol?')) {
                commPlan.emergency.protocols = commPlan.emergency.protocols.filter(p => p.id !== deleteProtocol.dataset.deleteProtocol);
                saveCommPlan();
                renderComms();
            }
            return;
        }
        
        // Data action buttons (copy-gps, copy-map, use-gps, use-map)
        const actionBtn = target.closest('[data-action]');
        if (actionBtn) {
            handleDataAction(actionBtn.dataset.action, actionBtn);
            return;
        }
    }
    
    /**
     * Handle delegated change events
     */
    function handleDelegatedChange(e) {
        const target = e.target;
        
        // Schedule enabled toggle
        if (target.id === 'schedule-enabled') {
            commPlan.schedule.enabled = target.checked;
            saveCommPlan();
            renderComms();
        }
    }
    
    /**
     * Handle delegated input events
     */
    function handleDelegatedInput(e) {
        const target = e.target;
        
        // Coordinate input
        if (target.id === 'coord-input') {
            clearTimeout(coordConverterState.inputTimeout);
            coordConverterState.inputTimeout = setTimeout(() => {
                handleCoordInput(target.value.trim());
            }, 300);
        }
    }
    
    /**
     * Handle coordinate input parsing
     */
    function handleCoordInput(value) {
        const statusEl = container.querySelector('#coord-input-status');
        const resultsEl = container.querySelector('#coord-results');
        
        if (!statusEl || !resultsEl) return;
        
        if (!value) {
            statusEl.innerHTML = '';
            statusEl.className = 'coord-input-status';
            resultsEl.style.display = 'none';
            coordConverterState.parsedCoords = null;
            return;
        }
        
        if (typeof Coordinates !== 'undefined') {
            const result = Coordinates.parse(value);
            if (result) {
                coordConverterState.parsedCoords = result;
                statusEl.innerHTML = `<span class="coord-status-success">‚úì Valid coordinates detected</span>`;
                statusEl.className = 'coord-input-status coord-input-status--success';
                updateConversionResults(result.lat, result.lon);
                resultsEl.style.display = 'block';
            } else {
                coordConverterState.parsedCoords = null;
                statusEl.innerHTML = `<span class="coord-status-error">‚úó Could not parse coordinates</span>`;
                statusEl.className = 'coord-input-status coord-input-status--error';
                resultsEl.style.display = 'none';
            }
        }
    }
    
    /**
     * Handle data action buttons
     */
    function handleDataAction(action, btn) {
        const input = container.querySelector('#coord-input');
        
        switch (action) {
            case 'copy-gps':
            case 'copy-map':
                const card = btn.closest('.coord-quick-card');
                const valueEl = card?.querySelector('.coord-quick-value');
                if (valueEl) {
                    copyToClipboard(valueEl.textContent);
                    showCoordToast('Coordinates copied');
                }
                break;
                
            case 'use-gps':
                if (typeof GPSModule !== 'undefined') {
                    const state = GPSModule.getState();
                    if (state.position && input) {
                        input.value = `${state.position.lat}, ${state.position.lon}`;
                        input.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                }
                break;
                
            case 'use-map':
                if (typeof MapModule !== 'undefined' && MapModule.getMapState && input) {
                    const mapState = MapModule.getMapState();
                    input.value = `${mapState.lat}, ${mapState.lon}`;
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                }
                break;
        }
    }
    
    /**
     * Handle distance calculation
     */
    function handleDistanceCalculation() {
        const fromInput = container.querySelector('#distance-from');
        const toInput = container.querySelector('#distance-to');
        const resultEl = container.querySelector('#distance-result');
        
        if (typeof Coordinates === 'undefined' || !fromInput || !toInput) return;
        
        const fromCoords = Coordinates.parse(fromInput.value);
        const toCoords = Coordinates.parse(toInput.value);
        
        if (!fromCoords) {
            showCoordToast('Invalid "From" coordinates', 'error');
            return;
        }
        if (!toCoords) {
            showCoordToast('Invalid "To" coordinates', 'error');
            return;
        }
        
        const dist = Coordinates.distance(fromCoords.lat, fromCoords.lon, toCoords.lat, toCoords.lon);
        const bear = Coordinates.bearing(fromCoords.lat, fromCoords.lon, toCoords.lat, toCoords.lon);
        
        const distValueEl = container.querySelector('#distance-value');
        const bearValueEl = container.querySelector('#bearing-value');
        
        if (distValueEl) distValueEl.textContent = formatDistanceResult(dist);
        if (bearValueEl) bearValueEl.textContent = Coordinates.formatBearing(bear);
        if (resultEl) resultEl.style.display = 'block';
    }
    
    /**
     * Render the undo/redo toolbar
     */
    function renderUndoToolbar() {
        if (typeof UndoModule === 'undefined') return '';
        
        const canUndo = UndoModule.canUndo();
        const canRedo = UndoModule.canRedo();
        const undoDesc = UndoModule.getUndoDescription();
        const redoDesc = UndoModule.getRedoDescription();
        
        return `
            <div class="undo-toolbar" style="display:flex;gap:8px;margin-bottom:12px;padding:8px;background:rgba(255,255,255,0.03);border-radius:8px;align-items:center">
                <button class="btn btn--secondary undo-btn" id="undo-btn" style="flex:1;padding:8px;${!canUndo ? 'opacity:0.4;cursor:not-allowed' : ''}" 
                    ${!canUndo ? 'disabled' : ''} title="${undoDesc ? 'Undo: ' + undoDesc : 'Nothing to undo (Ctrl+Z)'}">
                    ‚Ü©Ô∏è Undo
                </button>
                <button class="btn btn--secondary redo-btn" id="redo-btn" style="flex:1;padding:8px;${!canRedo ? 'opacity:0.4;cursor:not-allowed' : ''}"
                    ${!canRedo ? 'disabled' : ''} title="${redoDesc ? 'Redo: ' + redoDesc : 'Nothing to redo (Ctrl+Y)'}">
                    ‚Ü™Ô∏è Redo
                </button>
                <span style="font-size:10px;color:rgba(255,255,255,0.4);white-space:nowrap">Ctrl+Z/Y</span>
            </div>
        `;
    }
    
    /**
     * Update undo toolbar without full re-render
     */
    function updateUndoToolbar() {
        const undoBtn = container.querySelector('#undo-btn');
        const redoBtn = container.querySelector('#redo-btn');
        
        if (!undoBtn || !redoBtn || typeof UndoModule === 'undefined') return;
        
        const canUndo = UndoModule.canUndo();
        const canRedo = UndoModule.canRedo();
        const undoDesc = UndoModule.getUndoDescription();
        const redoDesc = UndoModule.getRedoDescription();
        
        undoBtn.disabled = !canUndo;
        undoBtn.style.opacity = canUndo ? '1' : '0.4';
        undoBtn.style.cursor = canUndo ? 'pointer' : 'not-allowed';
        undoBtn.title = undoDesc ? 'Undo: ' + undoDesc : 'Nothing to undo (Ctrl+Z)';
        
        redoBtn.disabled = !canRedo;
        redoBtn.style.opacity = canRedo ? '1' : '0.4';
        redoBtn.style.cursor = canRedo ? 'pointer' : 'not-allowed';
        redoBtn.title = redoDesc ? 'Redo: ' + redoDesc : 'Nothing to redo (Ctrl+Y)';
    }
    
    /**
     * Attach undo toolbar event handlers
     */
    function attachUndoHandlers() {
        const undoBtn = container.querySelector('#undo-btn');
        const redoBtn = container.querySelector('#redo-btn');
        
        if (undoBtn && typeof UndoModule !== 'undefined') {
            undoBtn.onclick = () => UndoModule.undo();
        }
        if (redoBtn && typeof UndoModule !== 'undefined') {
            redoBtn.onclick = () => UndoModule.redo();
        }
    }
    
    /**
     * Set up the floating measure panel
     */
    function setupMeasurePanel() {
        // Create the measure panel element
        measurePanelEl = document.createElement('div');
        measurePanelEl.id = 'measure-results-panel';
        measurePanelEl.className = 'measure-results-panel';
        measurePanelEl.style.display = 'none';
        document.getElementById('main').appendChild(measurePanelEl);
        
        // Listen for measure events
        if (typeof Events !== 'undefined') {
            Events.on('measure:toggle', (data) => {
                if (data.active) {
                    measurePanelEl.style.display = 'block';
                    updateMeasurePanel();
                } else {
                    measurePanelEl.style.display = 'none';
                }
            });
            
            Events.on('measure:pointAdded', updateMeasurePanel);
            Events.on('measure:pointRemoved', updateMeasurePanel);
            Events.on('measure:cleared', updateMeasurePanel);
            Events.on('measure:updated', updateMeasurePanel);
        }
    }
    
    /**
     * Update the measure panel content
     */
    function updateMeasurePanel() {
        if (!measurePanelEl || typeof MeasureModule === 'undefined') return;
        
        const html = MeasureModule.renderResultsPanel();
        measurePanelEl.innerHTML = `
            <div class="measure-results-panel__header">
                <span class="measure-results-panel__title">üìè Measure Tool</span>
                <button class="measure-results-panel__close" id="measure-close-btn">‚úï</button>
            </div>
            <div class="measure-results-panel__content">
                ${html}
            </div>
        `;
        
        // Bind events
        MeasureModule.bindResultsPanelEvents(measurePanelEl);
        
        // Close button
        const closeBtn = measurePanelEl.querySelector('#measure-close-btn');
        if (closeBtn) {
            closeBtn.onclick = () => {
                MeasureModule.toggle();
                measurePanelEl.style.display = 'none';
                MapModule.render();
                MapModule.renderControls();
            };
        }
    }

    function updateOfflineToggle() {
        const btn = domCache.get('offline-toggle');
        const icon = document.getElementById('offline-icon');
        const text = document.getElementById('offline-text');
        const offline = State.get('isOffline');
        btn.classList.toggle('offline-toggle--offline', offline);
        icon.innerHTML = Icons.get(offline ? 'offline' : 'satellite');
        text.textContent = offline ? 'Offline Mode' : 'Online';
    }

    function render() {
        domCache.clear();
        const panel = State.get('activePanel');
        
        // Preserve scroll position when re-rendering the same panel (e.g., tab switch)
        const isSamePanel = (panel === lastRenderedPanel);
        const savedScroll = isSamePanel && container ? container.scrollTop : 0;
        lastRenderedPanel = panel;
        
        switch (panel) {
            case 'sos': renderSOS(); break;
            case 'waypoints': renderWaypoints(); break;
            case 'routes': renderRoutes(); break;
            case 'logistics': renderLogistics(); break;
            case 'offline': renderOffline(); break;
            case 'team': renderTeam(); break;
            case 'rfsentinel': renderRFSentinel(); break;
            case 'sarsat': renderSarsat(); break;
            case 'settings': renderSettings(); break;
            case 'gps': renderGPS(); break;
            case 'weather': renderWeather(); break;
            case 'contingency': renderContingency(); break;
            case 'sunmoon': renderSunMoon(); break;
            case 'celestial': renderCelestial(); break;
            case 'navigation': renderNavigation(); break;
            case 'coords': renderCoordinateConverter(); break;
            case 'comms': renderComms(); break;
            case 'terrain': renderTerrain(); break;
            case 'radio': renderRadio(); break;
            case 'sstv': renderSSTV(); break;
            case 'medical': renderMedical(); break;
            case 'fieldguides': renderFieldGuides(); break;
            default: renderMapLayers();
        }
        
        // Restore scroll position for same-panel re-renders (tab switches, etc.)
        if (isSamePanel && savedScroll > 0 && container) {
            container.scrollTop = savedScroll;
        }
        
        updatePanelVisibility();
    }

    /**
     * Manage panel open/collapsed classes based on isPanelOpen state.
     * Mobile/tablet: toggles panel--open (transform-based slide).
     * Desktop: toggles panel--collapsed (width-based collapse).
     * Separated from render() so isPanelOpen changes don't trigger full content re-render.
     */
    function updatePanelVisibility() {
        const panelEl = document.getElementById('panel');
        if (!panelEl) return;
        
        const isPanelOpen = State.get('isPanelOpen');
        
        if (Helpers.isMobile()) {
            // Mobile/tablet: slide in/out via CSS transform
            if (isPanelOpen) panelEl.classList.add('panel--open');
            else panelEl.classList.remove('panel--open');
            panelEl.classList.remove('panel--collapsed');
        } else {
            // Desktop: collapse/expand in flex layout
            if (isPanelOpen) {
                panelEl.classList.remove('panel--collapsed');
            } else {
                panelEl.classList.add('panel--collapsed');
            }
        }
    }

    /**
     * Render SOS/Emergency Panel
     */
    function renderSOS() {
        if (typeof SOSModule === 'undefined') {
            container.innerHTML = `
                <div class="panel__header">
                    <h2 class="panel__title">üÜò Emergency</h2>
                </div>
                <div class="empty-state">
                    <div class="empty-state__icon">${Icons.get('alert')}</div>
                    <div class="empty-state__title">SOS Module Not Loaded</div>
                    <div class="empty-state__desc">Emergency features are not available</div>
                </div>
            `;
            return;
        }
        
        container.innerHTML = SOSModule.renderPanel();
        SOSModule.attachPanelListeners(container);
    }

    function renderMapLayers() {
        _saveScroll(); _restoreScroll();
        const layers = State.get('mapLayers');
        
        // Get current base layer
        const currentBase = layers.baseLayer || 'standard';
        const activeOverlays = layers.overlays || [];
        
        // Layer categories with metadata
        // NOTE: Esri basemaps removed for commercial licensing compliance
        // Only using OpenStreetMap (ODbL) and US Government public domain sources
        const layerCategories = {
            general: {
                name: 'General Maps',
                icon: 'üó∫Ô∏è',
                collapsed: false,
                baseLayers: [
                    { key: 'standard', name: 'OpenStreetMap', desc: 'Street map with roads & places', icon: 'map' },
                    { key: 'terrain', name: 'OpenTopoMap', desc: 'Topographic with contour lines', icon: 'terrain' }
                ]
            },
            usgs: {
                name: 'USGS (US Geological Survey)',
                icon: 'üèîÔ∏è',
                collapsed: true,
                baseLayers: [
                    { key: 'usgs_topo', name: 'USGS Topo', desc: 'Official USGS topographic maps (US)', icon: 'terrain' },
                    { key: 'usgs_imagery', name: 'USGS Imagery', desc: 'Satellite/aerial imagery (US)', icon: 'satellite' },
                    { key: 'usgs_imagery_topo', name: 'USGS Imagery + Topo', desc: 'Aerial with topo overlay (US)', icon: 'layers' }
                ],
                overlays: [
                    { key: 'usgs_hydro', name: 'Hydrography', desc: 'Rivers, streams, lakes (US)', icon: 'water' }
                ]
            },
            blm: {
                name: 'BLM (Bureau of Land Mgmt)',
                icon: 'üèúÔ∏è',
                collapsed: true,
                baseLayers: [],
                overlays: [
                    { key: 'blm_surface', name: 'Surface Management', desc: 'Federal land ownership (US)', icon: 'layers' }
                ]
            },
            overlays: {
                name: 'Map Overlays',
                icon: 'üìç',
                collapsed: false,
                baseLayers: [],
                overlays: [
                    { key: 'grid', name: 'Grid', desc: 'Reference grid overlay', icon: 'layers' }
                ]
            }
        };
        
        // Get expanded state from localStorage or default (with try-catch for private browsing)
        let expandedState = {};
        try {
            // Migrate from old key name if present
            const oldState = localStorage.getItem('gd_layer_expanded');
            if (oldState) {
                localStorage.setItem('griddown_layer_expanded', oldState);
                localStorage.removeItem('gd_layer_expanded');
            }
            expandedState = JSON.parse(localStorage.getItem('griddown_layer_expanded') || '{}');
        } catch (e) {
            console.warn('Could not read layer expanded state from localStorage:', e);
        }
        
        container.innerHTML = `
            <div class="panel__header"><h2 class="panel__title">Map Layers</h2></div>
            
            ${Object.entries(layerCategories).map(([catKey, cat]) => {
                const isExpanded = expandedState[catKey] !== undefined ? expandedState[catKey] : !cat.collapsed;
                const hasBaseLayers = cat.baseLayers && cat.baseLayers.length > 0;
                const hasOverlays = cat.overlays && cat.overlays.length > 0;
                const activeInCategory = (hasBaseLayers && cat.baseLayers.some(l => l.key === currentBase)) ||
                                         (hasOverlays && cat.overlays.some(l => activeOverlays.includes(l.key)));
                
                return `
                    <div class="layer-category ${isExpanded ? 'layer-category--expanded' : ''}" data-category="${catKey}">
                        <button class="layer-category__header" data-toggle-category="${catKey}">
                            <span class="layer-category__icon">${cat.icon}</span>
                            <span class="layer-category__name">${cat.name}</span>
                            ${activeInCategory ? '<span class="layer-category__active">‚óè</span>' : ''}
                            <span class="layer-category__arrow">${Icons.get('back')}</span>
                        </button>
                        <div class="layer-category__content" style="${isExpanded ? '' : 'display:none'}">
                            ${hasBaseLayers ? `
                                <div class="layer-group">
                                    ${catKey !== 'general' ? '<div class="layer-group__label">Base Maps</div>' : ''}
                                    ${cat.baseLayers.map(layer => `
                                        <button class="layer-btn ${currentBase === layer.key ? 'layer-btn--active' : ''}" 
                                                data-base="${layer.key}">
                                            <span class="layer-btn__icon">${Icons.get(layer.icon)}</span>
                                            <div class="layer-btn__text">
                                                <span class="layer-btn__label">${layer.name}</span>
                                                <span class="layer-btn__desc">${layer.desc}</span>
                                            </div>
                                            ${currentBase === layer.key ? `<span class="layer-btn__check">${Icons.get('check')}</span>` : ''}
                                        </button>
                                    `).join('')}
                                </div>
                            ` : ''}
                            ${hasOverlays ? `
                                <div class="layer-group">
                                    ${hasBaseLayers ? '<div class="layer-group__label">Overlays</div>' : ''}
                                    ${cat.overlays.map(layer => `
                                        <button class="layer-btn layer-btn--overlay ${activeOverlays.includes(layer.key) ? 'layer-btn--active' : ''}" 
                                                data-overlay="${layer.key}">
                                            <span class="layer-btn__icon">${Icons.get(layer.icon)}</span>
                                            <div class="layer-btn__text">
                                                <span class="layer-btn__label">${layer.name}</span>
                                                <span class="layer-btn__desc">${layer.desc}</span>
                                            </div>
                                            ${activeOverlays.includes(layer.key) ? `<span class="layer-btn__check">${Icons.get('check')}</span>` : ''}
                                        </button>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('')}
            
            <!-- Active Layers Summary -->
            <div class="divider"></div>
            <div class="section-label">Active Layers</div>
            <div style="padding:12px;background:rgba(255,255,255,0.03);border-radius:10px;font-size:12px">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                    <span style="color:#f97316">‚óè</span>
                    <span>Base: <strong>${getLayerDisplayName(currentBase)}</strong></span>
                </div>
                ${activeOverlays.length > 0 ? `
                    <div style="color:rgba(255,255,255,0.6)">
                        Overlays: ${activeOverlays.map(k => getLayerDisplayName(k)).join(', ')}
                    </div>
                ` : `
                    <div style="color:rgba(255,255,255,0.4)">No overlays active</div>
                `}
            </div>
            
            <!-- Quick Actions -->
            <div style="margin-top:16px;display:flex;gap:8px">
                <button class="btn btn--secondary" id="reset-layers" style="flex:1;font-size:12px">
                    Reset to Default
                </button>
            </div>
            
            <!-- Attribution Note -->
            <div style="margin-top:16px;padding:10px;font-size:10px;color:rgba(255,255,255,0.3);line-height:1.4">
                Map data ¬© OpenStreetMap contributors, USGS, USDA Forest Service, BLM. 
                Tiles are cached locally for offline use.
            </div>
        `;
        
        // Helper function for layer display names
        function getLayerDisplayName(key) {
            const names = {
                standard: 'OpenStreetMap',
                terrain: 'OpenTopoMap',
                satellite: 'Satellite',
                usgs_topo: 'USGS Topo',
                usgs_imagery: 'USGS Imagery',
                usgs_imagery_topo: 'USGS Imagery+Topo',
                usgs_hydro: 'Hydrography',
                usfs_topo: 'USA Topo',
                natgeo: 'Nat Geo',
                blm_surface: 'BLM Surface',
                hillshade: 'Hillshade',
                labels: 'Labels',
                transportation: 'Roads',
                grid: 'Grid'
            };
            return names[key] || key;
        }
        
        // Category collapse/expand handlers
        container.querySelectorAll('[data-toggle-category]').forEach(btn => {
            btn.onclick = () => {
                const catKey = btn.dataset.toggleCategory;
                const category = btn.closest('.layer-category');
                const content = category.querySelector('.layer-category__content');
                const isExpanded = content.style.display !== 'none';
                
                content.style.display = isExpanded ? 'none' : '';
                category.classList.toggle('layer-category--expanded', !isExpanded);
                
                // Save state (with try-catch for private browsing/quota)
                try {
                    const state = JSON.parse(localStorage.getItem('griddown_layer_expanded') || '{}');
                    state[catKey] = !isExpanded;
                    localStorage.setItem('griddown_layer_expanded', JSON.stringify(state));
                } catch (e) {
                    console.warn('Could not save layer expanded state to localStorage:', e);
                }
            };
        });
        
        // Base layer selection (radio-style - only one active)
        container.querySelectorAll('[data-base]').forEach(btn => {
            btn.onclick = (e) => {
                e.stopPropagation();
                const baseKey = btn.dataset.base;
                const newLayers = { 
                    ...layers, 
                    baseLayer: baseKey,
                    // Keep legacy flags for backwards compatibility
                    terrain: baseKey === 'terrain',
                    satellite: baseKey === 'satellite'
                };
                
                State.set('mapLayers', newLayers);
                MapModule.setBaseLayer(baseKey);
                MapModule.saveLayerPreferences();
                renderMapLayers();
            };
        });
        
        // Overlay toggles (checkbox-style)
        container.querySelectorAll('[data-overlay]').forEach(btn => {
            btn.onclick = (e) => {
                e.stopPropagation();
                const overlayKey = btn.dataset.overlay;
                const currentOverlays = layers.overlays || [];
                
                let newOverlays;
                if (currentOverlays.includes(overlayKey)) {
                    newOverlays = currentOverlays.filter(k => k !== overlayKey);
                } else {
                    newOverlays = [...currentOverlays, overlayKey];
                }
                
                const newLayers = { 
                    ...layers, 
                    overlays: newOverlays,
                    // Keep legacy flags
                    grid: newOverlays.includes('grid'),
                    contours: newOverlays.includes('hillshade')
                };
                
                State.set('mapLayers', newLayers);
                MapModule.saveLayerPreferences();
                renderMapLayers();
            };
        });
        
        // Reset button
        container.querySelector('#reset-layers').onclick = () => {
            const defaultLayers = {
                baseLayer: 'standard',
                overlays: [],
                terrain: false,
                satellite: false,
                grid: false,
                contours: false
            };
            State.set('mapLayers', defaultLayers);
            MapModule.setBaseLayer('standard');
            MapModule.saveLayerPreferences();
            renderMapLayers();
            ModalsModule.showToast('Layers reset to default', 'success');
        };
    }

    function renderWaypoints() {
        const wps = State.get('waypoints'), filter = State.get('waypointFilter'), sel = State.get('selectedWaypoint');
        
        // Apply type filter
        let filtered = filter === 'all' ? wps : 
                       filter === 'private' ? wps.filter(w => !w.visibility || w.visibility === 'private') :
                       filter === 'team' ? wps.filter(w => w.visibility === 'team') :
                       filter === 'community' ? wps.filter(w => w.visibility === 'community') :
                       wps.filter(w => w.type === filter);
        
        // Count by visibility
        const privateCount = wps.filter(w => !w.visibility || w.visibility === 'private').length;
        const teamCount = wps.filter(w => w.visibility === 'team').length;
        const communityCount = wps.filter(w => w.visibility === 'community').length;
        
        // Confidence level colors
        const confidenceColors = {
            1: '#ef4444', // Very Low - red
            2: '#f97316', // Low - orange
            3: '#eab308', // Medium - yellow
            4: '#22c55e', // High - green
            5: '#10b981'  // Very High - teal
        };
        
        // Visibility icons and colors
        const visibilityIcons = {
            private: { icon: 'üîí', color: '#6b7280', label: 'Private' },
            team: { icon: 'üë•', color: '#3b82f6', label: 'Team' },
            community: { icon: 'üåê', color: '#10b981', label: 'Community' }
        };
        
        // Helper to render visibility badge
        const renderVisibilityBadge = (wp) => {
            const visibility = wp.visibility || 'private';
            const vis = visibilityIcons[visibility];
            return `<span style="font-size:12px" title="${vis.label}">${vis.icon}</span>`;
        };
        
        // Helper to render mini confidence stars
        const renderConfidenceStars = (wp) => {
            const confidence = wp.confidence || 3;
            const color = confidenceColors[confidence] || '#eab308';
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                stars += `<span style="color:${i <= confidence ? color : 'rgba(255,255,255,0.15)'};font-size:10px">${i <= confidence ? '‚òÖ' : '‚òÜ'}</span>`;
            }
            return `<div style="display:flex;gap:1px;align-items:center" title="Confidence: ${confidence}/5">${stars}</div>`;
        };
        
        // Helper to format coordinates
        const formatCoords = (wp) => {
            if (wp.lat && wp.lon) {
                const latDir = wp.lat >= 0 ? 'N' : 'S';
                const lonDir = wp.lon >= 0 ? 'E' : 'W';
                return `${Math.abs(wp.lat).toFixed(4)}¬∞ ${latDir}, ${Math.abs(wp.lon).toFixed(4)}¬∞ ${lonDir}`;
            }
            return `${wp.x.toFixed(1)}%, ${wp.y.toFixed(1)}%`;
        };
        
        // Helper to render key structured fields for a waypoint type
        const renderKeyFields = (wp) => {
            const typeConfig = Constants.WAYPOINT_TYPES[wp.type];
            if (!typeConfig || !typeConfig.fields) return '';
            
            // Select 2-3 most important fields to display
            const keyFieldsMap = {
                water: ['flowRate', 'reliability', 'treatmentRequired'],
                fuel: ['fuelType', 'quantity', 'cacheType'],
                camp: ['capacity', 'cover', 'cellSignal'],
                resupply: ['storeType', 'hours'],
                hazard: ['hazardType', 'severity', 'vehicleImpact'],
                bailout: ['accessType', 'emsResponse', 'cellSignal'],
                custom: ['category']
            };
            
            const keyFields = keyFieldsMap[wp.type] || [];
            const fieldsHtml = keyFields
                .filter(key => wp[key] && wp[key] !== '' && wp[key] !== 'unknown')
                .map(key => {
                    const field = typeConfig.fields.find(f => f.key === key);
                    if (!field) return '';
                    const displayValue = Constants.getFieldDisplayValue(wp.type, key, wp[key]);
                    return `<span style="background:rgba(255,255,255,0.06);padding:2px 8px;border-radius:4px;font-size:10px">${displayValue}</span>`;
                })
                .filter(Boolean)
                .join('');
            
            if (!fieldsHtml) return '';
            return `<div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:8px">${fieldsHtml}</div>`;
        };
        
        // Helper to render photo thumbnails
        const renderPhotoThumbs = (wp) => {
            if (!wp.photos || wp.photos.length === 0) return '';
            const maxThumbs = 3;
            const displayPhotos = wp.photos.slice(0, maxThumbs);
            const remaining = wp.photos.length - maxThumbs;
            
            return `
                <div style="display:flex;gap:4px;margin-top:8px;align-items:center" data-wp-photos="${wp.id}">
                    ${displayPhotos.map(photo => `
                        <div class="wp-photo-thumb" data-photo-id="${photo.id}" style="
                            width:40px;
                            height:40px;
                            border-radius:4px;
                            overflow:hidden;
                            cursor:pointer;
                        ">
                            <img src="${photo.data}" alt="Photo" style="width:100%;height:100%;object-fit:cover">
                        </div>
                    `).join('')}
                    ${remaining > 0 ? `<span style="font-size:11px;color:rgba(255,255,255,0.5)">+${remaining} more</span>` : ''}
                </div>
            `;
        };
        
        container.innerHTML = `
            <div class="panel__header">
                <h2 class="panel__title" id="waypoints-title">Waypoints</h2>
                <button class="btn btn--primary" id="add-wp-btn" aria-label="Add new waypoint">${Icons.get('plus')} Add</button>
            </div>
            
            <!-- Undo/Redo Toolbar -->
            ${renderUndoToolbar()}
            
            <!-- Visibility Filter Row -->
            <div style="display:flex;gap:6px;margin-bottom:12px" role="group" aria-label="Filter by visibility">
                <button class="chip ${filter === 'all' ? 'chip--active' : ''}" data-filter="all" style="flex:1" aria-pressed="${filter === 'all'}">All (${wps.length})</button>
                ${privateCount > 0 ? `<button class="chip ${filter === 'private' ? 'chip--active' : ''}" data-filter="private" style="flex:1" aria-pressed="${filter === 'private'}" aria-label="Private waypoints: ${privateCount}">üîí ${privateCount}</button>` : ''}
                ${teamCount > 0 ? `<button class="chip ${filter === 'team' ? 'chip--active' : ''}" data-filter="team" style="flex:1" aria-pressed="${filter === 'team'}" aria-label="Team waypoints: ${teamCount}">üë• ${teamCount}</button>` : ''}
                ${communityCount > 0 ? `<button class="chip ${filter === 'community' ? 'chip--active' : ''}" data-filter="community" style="flex:1" aria-pressed="${filter === 'community'}" aria-label="Community waypoints: ${communityCount}">üåê ${communityCount}</button>` : ''}
            </div>
            
            <!-- Type Filter Row -->
            <div class="filter-chips" role="group" aria-label="Filter by type">
                ${Object.entries(Constants.WAYPOINT_TYPES).map(([k, t]) => { const c = wps.filter(w => w.type === k).length; return c ? `<button class="chip ${filter === k ? 'chip--active' : ''}" data-filter="${k}" aria-pressed="${filter === k}" aria-label="${t.label}: ${c}"><span aria-hidden="true">${t.icon}</span> ${c}</button>` : ''; }).join('')}
            </div>
            
            <div class="panel__scroll" role="list" aria-label="Waypoint list">${filtered.map(wp => { const t = Constants.WAYPOINT_TYPES[wp.type] || Constants.WAYPOINT_TYPES.custom; return `
                <article class="card ${sel?.id === wp.id ? 'card--selected' : ''}" data-wp="${wp.id}" style="margin-bottom:8px" role="listitem" aria-selected="${sel?.id === wp.id}" tabindex="0" aria-label="${wp.name}, ${t.label}">
                    <div class="card__header">
                        <div class="card__icon" style="background:${t.color}22" aria-hidden="true">${t.icon}</div>
                        <div style="flex:1;min-width:0">
                            <div class="card__title" style="display:flex;align-items:center;gap:6px">
                                ${renderVisibilityBadge(wp)}
                                <span>${wp.name}</span>
                                ${renderConfidenceStars(wp)}
                            </div>
                            <div class="card__subtitle">${t.label} ‚Ä¢ ${formatCoords(wp)}</div>
                        </div>
                        ${wp.photos && wp.photos.length > 0 ? `<span style="font-size:11px;color:rgba(255,255,255,0.4);margin-right:4px" aria-label="${wp.photos.length} photos">üì∑${wp.photos.length}</span>` : ''}
                        ${wp.verified ? `<span style="color:#22c55e;width:16px;height:16px;flex-shrink:0" aria-label="Verified" title="Verified">${Icons.get('check')}</span>` : ''}
                        <button class="btn btn--secondary" data-edit-wp="${wp.id}" style="padding:6px;margin-left:4px" title="Edit" aria-label="Edit ${wp.name}">‚úèÔ∏è</button>
                        <button class="btn btn--secondary" data-delete-wp="${wp.id}" style="padding:6px" title="Delete" aria-label="Delete ${wp.name}">üóëÔ∏è</button>
                    </div>
                    ${renderKeyFields(wp)}
                    ${wp.notes ? `<div class="card__notes">${wp.notes}</div>` : ''}
                    ${renderPhotoThumbs(wp)}
                </article>`; }).join('')}</div>
        `;
        
        // Attach undo/redo handlers
        attachUndoHandlers();
        
        container.querySelector('#add-wp-btn').onclick = () => ModalsModule.openWaypointModal();
        container.querySelectorAll('[data-filter]').forEach(b => b.onclick = () => State.set('waypointFilter', b.dataset.filter));
        
        // Card click selects waypoint (but not if clicking buttons or photos)
        container.querySelectorAll('[data-wp]').forEach(c => {
            c.onclick = (e) => {
                if (e.target.closest('[data-edit-wp]') || e.target.closest('[data-delete-wp]') || e.target.closest('.wp-photo-thumb')) return;
                State.Waypoints.select(wps.find(w => w.id === c.dataset.wp));
            };
        });
        
        // Photo thumbnail click handler - open photo in full view
        container.querySelectorAll('.wp-photo-thumb').forEach(thumb => {
            thumb.onclick = (e) => {
                e.stopPropagation();
                const wpId = thumb.closest('[data-wp-photos]')?.dataset.wpPhotos;
                const photoId = thumb.dataset.photoId;
                const wp = wps.find(w => w.id === wpId);
                const photo = wp?.photos?.find(p => p.id === photoId);
                if (photo) {
                    // Open full-size viewer
                    const viewer = document.createElement('div');
                    viewer.id = 'photo-viewer';
                    viewer.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.95);display:flex;align-items:center;justify-content:center;z-index:1000;cursor:pointer;';
                    viewer.innerHTML = `
                        <img src="${photo.data}" style="max-width:90%;max-height:90%;object-fit:contain;border-radius:8px">
                        <button style="position:absolute;top:20px;right:20px;width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,0.1);border:none;color:white;font-size:24px;cursor:pointer;">√ó</button>
                    `;
                    viewer.onclick = () => viewer.remove();
                    document.body.appendChild(viewer);
                }
            };
        });
        
        // Edit button handler
        container.querySelectorAll('[data-edit-wp]').forEach(btn => {
            btn.onclick = (e) => {
                e.stopPropagation();
                const wp = wps.find(w => w.id === btn.dataset.editWp);
                if (wp) ModalsModule.openWaypointModal(null, wp);
            };
        });
        
        // Delete button handler
        container.querySelectorAll('[data-delete-wp]').forEach(btn => {
            btn.onclick = (e) => {
                e.stopPropagation();
                const wp = wps.find(w => w.id === btn.dataset.deleteWp);
                if (wp) ModalsModule.confirmDeleteWaypoint(wp);
            };
        });
    }

    function renderRoutes() {
        _saveScroll(); _restoreScroll();
        const routes = State.get('routes');
        const waypoints = State.get('waypoints');
        const builderState = RouteBuilderModule.getState();
        const isBuilding = builderState.isBuilding;
        const currentRoute = builderState.currentRoute;

        container.innerHTML = `
            <div class="panel__header">
                <h2 class="panel__title">Routes</h2>
                ${!isBuilding ? `
                    <button class="btn btn--primary" id="new-route-btn">${Icons.get('plus')} New</button>
                ` : ''}
            </div>
            
            <!-- Undo/Redo Toolbar -->
            ${renderUndoToolbar()}
            
            <!-- Import/Export Section -->
            <div class="section-label">Import</div>
            <div style="display:flex;gap:8px;margin-bottom:12px">
                <label class="btn btn--secondary" style="flex:1;cursor:pointer">
                    ${Icons.get('download')} GPX
                    <input type="file" id="gpx-import" accept=".gpx" style="display:none">
                </label>
                <label class="btn btn--secondary" style="flex:1;cursor:pointer">
                    ${Icons.get('download')} KML/KMZ
                    <input type="file" id="kml-import" accept=".kml,.kmz" style="display:none">
                </label>
            </div>
            
            <div class="section-label">Export</div>
            <div style="display:flex;gap:8px;margin-bottom:16px">
                <button class="btn btn--secondary" id="gpx-export" style="flex:1" ${routes.length === 0 && waypoints.length === 0 ? 'disabled' : ''}>
                    ${Icons.get('export')} GPX
                </button>
                <button class="btn btn--secondary" id="kml-export" style="flex:1" ${routes.length === 0 && waypoints.length === 0 ? 'disabled' : ''}>
                    ${Icons.get('export')} KML
                </button>
            </div>
            
            ${isBuilding && currentRoute ? `
                <!-- Route Builder Mode -->
                <div style="padding:14px;background:rgba(249,115,22,0.1);border:1px solid rgba(249,115,22,0.3);border-radius:12px;margin-bottom:16px">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
                        <span style="font-size:12px;color:#f97316;font-weight:600">BUILDING ROUTE</span>
                        <span style="font-size:11px;color:rgba(255,255,255,0.5)">${currentRoute.points.length} points</span>
                    </div>
                    <input type="text" id="route-name-input" value="${currentRoute.name}" placeholder="Route name" 
                        style="margin-bottom:12px;background:rgba(0,0,0,0.3)">
                    
                    <div style="font-size:12px;color:rgba(255,255,255,0.6);margin-bottom:8px">
                        Click on the map to add points. Click near waypoints to link them.
                    </div>
                    
                    <!-- Route Stats -->
                    <div class="stat-grid stat-grid--3" style="margin-bottom:12px">
                        <div style="text-align:center;padding:8px;background:rgba(0,0,0,0.2);border-radius:6px">
                            <div style="font-size:14px;font-weight:600">${currentRoute.distance}</div>
                            <div style="font-size:9px;color:rgba(255,255,255,0.4)">MILES</div>
                        </div>
                        <div style="text-align:center;padding:8px;background:rgba(0,0,0,0.2);border-radius:6px">
                            <div style="font-size:14px;font-weight:600">${currentRoute.duration}</div>
                            <div style="font-size:9px;color:rgba(255,255,255,0.4)">TIME</div>
                        </div>
                        <div style="text-align:center;padding:8px;background:rgba(0,0,0,0.2);border-radius:6px">
                            <div style="font-size:14px;font-weight:600">${currentRoute.elevation}</div>
                            <div style="font-size:9px;color:rgba(255,255,255,0.4)">ELEV (FT)</div>
                        </div>
                    </div>
                    
                    <!-- Point List -->
                    ${currentRoute.points.length > 0 ? `
                        <div class="section-label">Route Points</div>
                        <div style="max-height:200px;overflow-y:auto;margin-bottom:12px">
                            ${currentRoute.points.map((pt, i) => {
                                const linkedWp = pt.waypointId ? waypoints.find(w => w.id === pt.waypointId) : null;
                                const wpType = linkedWp ? Constants.WAYPOINT_TYPES[linkedWp.type] : null;
                                return `
                                    <div class="list-item" style="margin-bottom:4px;padding:8px" data-point-index="${i}">
                                        <div style="display:flex;align-items:center;gap:8px;flex:1">
                                            <span style="font-size:11px;color:rgba(255,255,255,0.3);width:20px">${i + 1}</span>
                                            ${linkedWp ? `
                                                <span style="font-size:14px">${wpType?.icon || 'üìç'}</span>
                                                <span style="font-size:12px">${linkedWp.name}</span>
                                            ` : `
                                                <span style="font-size:12px;color:rgba(255,255,255,0.6)">${pt.lat.toFixed(4)}¬∞, ${pt.lon.toFixed(4)}¬∞</span>
                                            `}
                                        </div>
                                        <select data-terrain-index="${i}" style="width:80px;padding:4px;font-size:11px">
                                            <option value="highway" ${pt.terrain === 'highway' ? 'selected' : ''}>Highway</option>
                                            <option value="road" ${pt.terrain === 'road' ? 'selected' : ''}>Road</option>
                                            <option value="trail" ${pt.terrain === 'trail' ? 'selected' : ''}>Trail</option>
                                            <option value="crawl" ${pt.terrain === 'crawl' ? 'selected' : ''}>Technical</option>
                                        </select>
                                        <button class="btn btn--secondary" data-remove-point="${i}" style="padding:4px 8px;font-size:11px">‚úï</button>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : `
                        <div style="padding:20px;text-align:center;color:rgba(255,255,255,0.4);font-size:12px">
                            Click on the map to add your first point
                        </div>
                    `}
                    
                    <!-- Builder Actions -->
                    <div style="display:flex;gap:8px">
                        <button class="btn btn--secondary" id="reverse-route" style="flex:1" ${currentRoute.points.length < 2 ? 'disabled' : ''}>
                            ‚ÜîÔ∏è Reverse
                        </button>
                        <button class="btn btn--secondary" id="cancel-route" style="flex:1">
                            Cancel
                        </button>
                        <button class="btn btn--primary" id="finish-route" style="flex:1" ${currentRoute.points.length < 2 ? 'disabled' : ''}>
                            ‚úì Save
                        </button>
                    </div>
                </div>
            ` : ''}
            
            <!-- Existing Routes List -->
            ${routes.filter(r => !r.isBuilding).length === 0 && !isBuilding ? `
                <div class="empty-state">
                    <div class="empty-state__icon">${Icons.get('route')}</div>
                    <div class="empty-state__title">No routes yet</div>
                    <div class="empty-state__desc">Create a route or import a GPX file</div>
                </div>
            ` : `
                <div class="panel__scroll">
                    ${routes.filter(r => !r.isBuilding).map(r => `
                        <div class="card" style="margin-bottom:12px" data-route-id="${r.id}">
                            <div class="card__header">
                                <div class="card__icon" style="background:rgba(249,115,22,0.15);color:#f97316">${Icons.get('route')}</div>
                                <div style="flex:1">
                                    <div class="card__title">${r.name}</div>
                                    <div class="card__subtitle">${r.points?.length || 0} points ${r.source ? `‚Ä¢ ${r.source}` : ''}</div>
                                </div>
                                <button class="btn btn--secondary" data-elevation-route="${r.id}" style="padding:6px" title="Elevation Profile" aria-label="View elevation profile for ${Helpers.escapeHtml(r.name)}">üìà</button>
                                <button class="btn btn--secondary" data-edit-route="${r.id}" style="padding:6px" title="Edit route" aria-label="Edit ${Helpers.escapeHtml(r.name)}">‚úèÔ∏è</button>
                                <button class="btn btn--secondary" data-delete-route="${r.id}" style="padding:6px" title="Delete route" aria-label="Delete ${Helpers.escapeHtml(r.name)}">üóëÔ∏è</button>
                            </div>
                            <div class="stat-grid stat-grid--3" style="margin-top:12px;padding:12px;background:rgba(0,0,0,0.2);border-radius:8px">
                                <div style="text-align:center">
                                    <div style="font-size:16px;font-weight:600">${r.distance || '0'}</div>
                                    <div style="font-size:10px;color:rgba(255,255,255,0.4)">MILES</div>
                                </div>
                                <div style="text-align:center">
                                    <div style="font-size:16px;font-weight:600">${r.duration || '0h'}</div>
                                    <div style="font-size:10px;color:rgba(255,255,255,0.4)">EST TIME</div>
                                </div>
                                <div style="text-align:center">
                                    <div style="font-size:16px;font-weight:600">${r.elevation || '0'}</div>
                                    <div style="font-size:10px;color:rgba(255,255,255,0.4)">ELEV (FT)</div>
                                </div>
                            </div>
                            <!-- Elevation Profile Container (initially hidden) -->
                            <div id="elevation-profile-${r.id}" class="elevation-profile" style="display:none;margin-top:12px">
                                <div class="elevation-profile__loading" id="elevation-loading-${r.id}">
                                    ${Icons.get('elevation')}
                                    <div>Loading elevation data...</div>
                                </div>
                                <div class="elevation-profile__chart" id="elevation-chart-${r.id}" style="display:none">
                                    <canvas id="elevation-canvas-${r.id}"></canvas>
                                </div>
                                <div id="elevation-stats-${r.id}"></div>
                                <div id="hiking-time-${r.id}"></div>
                                <div id="elevation-grades-${r.id}"></div>
                                <div id="elevation-warnings-${r.id}"></div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `}
            
            <!-- Quick Create from Waypoints -->
            ${!isBuilding && waypoints.length >= 2 ? `
                <div class="divider"></div>
                <div class="section-label">Quick Create</div>
                <button class="btn btn--secondary btn--full" id="route-from-waypoints">
                    üìç Create Route from All Waypoints
                </button>
            ` : ''}
        `;
        
        // Attach undo/redo handlers
        attachUndoHandlers();
        
        // Event handlers
        const newRouteBtn = container.querySelector('#new-route-btn');
        if (newRouteBtn) {
            newRouteBtn.onclick = () => {
                RouteBuilderModule.startNewRoute();
                renderRoutes();
            };
        }
        
        // GPX Import
        const gpxImport = container.querySelector('#gpx-import');
        if (gpxImport) {
            gpxImport.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const result = await GPXModule.importFromFile(file);
                    
                    // Add imported waypoints
                    if (result.waypoints.length > 0) {
                        const existingWps = State.get('waypoints');
                        State.Waypoints.setAll([...existingWps, ...result.waypoints]);
                        await Storage.Waypoints.saveAll(result.waypoints);
                    }
                    
                    // Add imported routes
                    const importedRoutes = [...result.routes, ...result.tracks];
                    if (importedRoutes.length > 0) {
                        const existingRoutes = State.get('routes');
                        State.Routes.setAll([...existingRoutes, ...importedRoutes]);
                        for (const route of importedRoutes) {
                            await Storage.Routes.save(route);
                        }
                    }
                    
                    ModalsModule.showToast(
                        `Imported ${result.waypoints.length} waypoints, ${importedRoutes.length} routes`, 
                        'success'
                    );
                    
                    renderRoutes();
                    MapModule.render();
                    
                } catch (err) {
                    console.error('GPX import error:', err);
                    ModalsModule.showToast('Failed to import GPX: ' + err.message, 'error');
                }
                
                // Reset input
                e.target.value = '';
            };
        }
        
        // GPX Export
        const gpxExport = container.querySelector('#gpx-export');
        if (gpxExport) {
            gpxExport.onclick = () => {
                const allWaypoints = State.get('waypoints');
                const allRoutes = State.get('routes').filter(r => !r.isBuilding);
                GPXModule.downloadGPX(allWaypoints, allRoutes, 'griddown-export.gpx');
                ModalsModule.showToast('GPX file downloaded', 'success');
            };
        }
        
        // KML Import
        const kmlImport = container.querySelector('#kml-import');
        if (kmlImport) {
            kmlImport.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const result = await KMLModule.importFromFile(file);
                    
                    // Add imported waypoints
                    if (result.waypoints.length > 0) {
                        const existingWps = State.get('waypoints');
                        State.Waypoints.setAll([...existingWps, ...result.waypoints]);
                        await Storage.Waypoints.saveAll(result.waypoints);
                    }
                    
                    // Add imported routes
                    if (result.routes.length > 0) {
                        const existingRoutes = State.get('routes');
                        State.Routes.setAll([...existingRoutes, ...result.routes]);
                        for (const route of result.routes) {
                            await Storage.Routes.save(route);
                        }
                    }
                    
                    ModalsModule.showToast(
                        `Imported ${result.waypoints.length} waypoints, ${result.routes.length} routes from KML`, 
                        'success'
                    );
                    
                    renderRoutes();
                    MapModule.render();
                    
                } catch (err) {
                    console.error('KML import error:', err);
                    ModalsModule.showToast('Failed to import KML: ' + err.message, 'error');
                }
                
                // Reset input
                e.target.value = '';
            };
        }
        
        // KML Export
        const kmlExport = container.querySelector('#kml-export');
        if (kmlExport) {
            kmlExport.onclick = () => {
                const allWaypoints = State.get('waypoints');
                const allRoutes = State.get('routes').filter(r => !r.isBuilding);
                KMLModule.downloadKML(allWaypoints, allRoutes, 'griddown-export.kml');
                ModalsModule.showToast('KML file downloaded', 'success');
            };
        }
        
        // Route name input
        const routeNameInput = container.querySelector('#route-name-input');
        if (routeNameInput) {
            routeNameInput.onchange = (e) => {
                if (currentRoute) {
                    currentRoute.name = e.target.value || 'Unnamed Route';
                }
            };
        }
        
        // Terrain selectors
        container.querySelectorAll('[data-terrain-index]').forEach(sel => {
            sel.onchange = (e) => {
                const idx = parseInt(sel.dataset.terrainIndex);
                RouteBuilderModule.setSegmentTerrain(idx, e.target.value);
                renderRoutes();
            };
        });
        
        // Remove point buttons
        container.querySelectorAll('[data-remove-point]').forEach(btn => {
            btn.onclick = (e) => {
                e.stopPropagation();
                const idx = parseInt(btn.dataset.removePoint);
                RouteBuilderModule.removePoint(idx);
                renderRoutes();
            };
        });
        
        // Reverse route
        const reverseBtn = container.querySelector('#reverse-route');
        if (reverseBtn) {
            reverseBtn.onclick = () => {
                RouteBuilderModule.reverseRoute();
                renderRoutes();
            };
        }
        
        // Cancel route
        const cancelBtn = container.querySelector('#cancel-route');
        if (cancelBtn) {
            cancelBtn.onclick = () => {
                RouteBuilderModule.cancelRoute();
                renderRoutes();
            };
        }
        
        // Finish route
        const finishBtn = container.querySelector('#finish-route');
        if (finishBtn) {
            finishBtn.onclick = () => {
                RouteBuilderModule.finishRoute();
                renderRoutes();
            };
        }
        
        // Edit route
        container.querySelectorAll('[data-edit-route]').forEach(btn => {
            btn.onclick = (e) => {
                e.stopPropagation();
                RouteBuilderModule.editRoute(btn.dataset.editRoute);
                renderRoutes();
            };
        });
        
        // Delete route
        container.querySelectorAll('[data-delete-route]').forEach(btn => {
            btn.onclick = (e) => {
                e.stopPropagation();
                if (confirm('Delete this route?')) {
                    RouteBuilderModule.deleteRoute(btn.dataset.deleteRoute);
                    renderRoutes();
                }
            };
        });
        
        // Create from waypoints
        const fromWaypointsBtn = container.querySelector('#route-from-waypoints');
        if (fromWaypointsBtn) {
            fromWaypointsBtn.onclick = () => {
                const waypointIds = waypoints.map(w => w.id);
                RouteBuilderModule.createFromWaypoints(waypointIds);
                renderRoutes();
            };
        }
        
        // Elevation profile toggles
        container.querySelectorAll('[data-elevation-route]').forEach(btn => {
            btn.onclick = async (e) => {
                e.stopPropagation();
                const routeId = btn.dataset.elevationRoute;
                const profileContainer = document.getElementById(`elevation-profile-${routeId}`);
                const loadingEl = document.getElementById(`elevation-loading-${routeId}`);
                const chartContainer = document.getElementById(`elevation-chart-${routeId}`);
                const statsEl = document.getElementById(`elevation-stats-${routeId}`);
                const gradesEl = document.getElementById(`elevation-grades-${routeId}`);
                const warningsEl = document.getElementById(`elevation-warnings-${routeId}`);
                
                if (!profileContainer) return;
                
                // Toggle visibility
                const isVisible = profileContainer.style.display !== 'none';
                if (isVisible) {
                    profileContainer.style.display = 'none';
                    btn.style.background = '';
                    return;
                }
                
                // Show and load profile
                profileContainer.style.display = 'block';
                btn.style.background = 'rgba(249,115,22,0.15)';
                loadingEl.style.display = 'block';
                chartContainer.style.display = 'none';
                
                // Find the route
                const route = routes.find(r => r.id === routeId);
                if (!route || !route.points || route.points.length < 2) {
                    loadingEl.innerHTML = '<div style="color:rgba(255,255,255,0.5)">Route needs at least 2 points</div>';
                    return;
                }
                
                try {
                    // Analyze elevation profile
                    const profile = await ElevationModule.analyzeRoute(route, waypoints);
                    
                    if (!profile) {
                        loadingEl.innerHTML = '<div style="color:rgba(255,255,255,0.5)">Could not load elevation data</div>';
                        return;
                    }
                    
                    // Hide loading, show chart
                    loadingEl.style.display = 'none';
                    chartContainer.style.display = 'block';
                    
                    // Render elevation profile canvas
                    const canvas = document.getElementById(`elevation-canvas-${routeId}`);
                    if (canvas) {
                        ElevationModule.renderProfile(canvas, profile, { height: 150 });
                    }
                    
                    // Render stats
                    statsEl.innerHTML = `
                        <div class="stat-grid stat-grid--2" style="margin-top:12px">
                            <div class="stat-box" style="padding:12px">
                                <div style="font-size:18px;font-weight:600;color:#22c55e">+${Math.round(profile.totalElevationGain).toLocaleString()}'</div>
                                <div style="font-size:10px;color:rgba(255,255,255,0.4)">ELEVATION GAIN</div>
                            </div>
                            <div class="stat-box" style="padding:12px">
                                <div style="font-size:18px;font-weight:600;color:#3b82f6">-${Math.round(profile.totalElevationLoss).toLocaleString()}'</div>
                                <div style="font-size:10px;color:rgba(255,255,255,0.4)">ELEVATION LOSS</div>
                            </div>
                            <div class="stat-box" style="padding:12px">
                                <div style="font-size:16px;font-weight:600">${Math.round(profile.maxElevation).toLocaleString()}'</div>
                                <div style="font-size:10px;color:rgba(255,255,255,0.4)">MAX ELEVATION</div>
                            </div>
                            <div class="stat-box" style="padding:12px">
                                <div style="font-size:16px;font-weight:600">${Math.round(profile.minElevation).toLocaleString()}'</div>
                                <div style="font-size:10px;color:rgba(255,255,255,0.4)">MIN ELEVATION</div>
                            </div>
                        </div>
                    `;
                    
                    // Render hiking time estimate
                    const hikingTimeEl = document.getElementById(`hiking-time-${routeId}`);
                    if (hikingTimeEl && typeof HikingModule !== 'undefined') {
                        const hikingEstimate = HikingModule.estimateHikingTime(
                            profile.totalDistance,
                            profile.totalElevationGain,
                            profile.totalElevationLoss
                        );
                        const daylight = HikingModule.getDaylightInfo();
                        const turnaround = HikingModule.calculateTurnaround(
                            profile.totalDistance / 2,  // One-way for out-and-back
                            profile.totalElevationGain / 2,
                            profile.totalElevationLoss / 2
                        );
                        
                        hikingTimeEl.innerHTML = `
                            <div class="section-label" style="margin-top:12px">ü•æ Hiking Estimates</div>
                            ${HikingModule.renderTimeEstimate(hikingEstimate)}
                            <div style="margin-top:12px">
                                ${HikingModule.renderDaylightWidget(daylight)}
                            </div>
                            ${profile.totalDistance < 20 ? `
                                <div style="margin-top:12px">
                                    ${HikingModule.renderTurnaroundWidget(turnaround)}
                                </div>
                            ` : ''}
                            <div style="margin-top:12px">
                                ${HikingModule.renderPaceSelector('pace-selector-' + routeId)}
                            </div>
                        `;
                        
                        // Attach pace selector handlers
                        hikingTimeEl.querySelectorAll('[data-pace-preset]').forEach(paceBtn => {
                            paceBtn.onclick = () => {
                                const preset = paceBtn.dataset.pacePreset;
                                HikingModule.setPacePreset(preset);
                                // Re-render hiking estimates
                                const newEstimate = HikingModule.estimateHikingTime(
                                    profile.totalDistance,
                                    profile.totalElevationGain,
                                    profile.totalElevationLoss
                                );
                                const newTurnaround = HikingModule.calculateTurnaround(
                                    profile.totalDistance / 2,
                                    profile.totalElevationGain / 2,
                                    profile.totalElevationLoss / 2
                                );
                                hikingTimeEl.querySelector('.hiking-estimate').outerHTML = HikingModule.renderTimeEstimate(newEstimate);
                                const turnaroundWidget = hikingTimeEl.querySelector('.turnaround-widget');
                                if (turnaroundWidget) {
                                    turnaroundWidget.outerHTML = HikingModule.renderTurnaroundWidget(newTurnaround);
                                }
                                // Update button states
                                hikingTimeEl.querySelectorAll('[data-pace-preset]').forEach(b => {
                                    b.classList.toggle('btn--primary', b.dataset.pacePreset === preset);
                                    b.classList.toggle('btn--secondary', b.dataset.pacePreset !== preset);
                                });
                            };
                        });
                    }
                    
                    // Render grade distribution
                    gradesEl.innerHTML = `<div class="section-label" style="margin-top:12px">Grade Distribution</div>`;
                    const gradeContainer = document.createElement('div');
                    gradesEl.appendChild(gradeContainer);
                    ElevationModule.renderGradeDistribution(gradeContainer, profile);
                    
                    // Render warnings for steep sections
                    const impact = ElevationModule.getLogisticsImpact(profile);
                    if (impact.warnings.length > 0) {
                        warningsEl.innerHTML = `
                            <div class="section-label" style="margin-top:12px">‚ö†Ô∏è Steep Sections (${impact.warnings.length})</div>
                            ${impact.warnings.slice(0, 5).map(w => `
                                <div style="padding:8px 10px;background:${w.direction === 'uphill' ? 'rgba(239,68,68,0.1)' : 'rgba(59,130,246,0.1)'};border-radius:6px;margin-bottom:4px;font-size:12px">
                                    <span style="color:${w.direction === 'uphill' ? '#ef4444' : '#3b82f6'}">
                                        ${w.direction === 'uphill' ? '‚ÜóÔ∏è' : '‚ÜòÔ∏è'} ${w.grade}% grade
                                    </span>
                                    <span style="color:rgba(255,255,255,0.5)"> at mile ${w.location}</span>
                                    <span style="color:rgba(255,255,255,0.4);font-size:11px"> ‚Ä¢ ${w.impact}</span>
                                </div>
                            `).join('')}
                            ${impact.warnings.length > 5 ? `
                                <div style="font-size:11px;color:rgba(255,255,255,0.4);text-align:center;padding:4px">
                                    +${impact.warnings.length - 5} more steep sections
                                </div>
                            ` : ''}
                            <div style="margin-top:8px;padding:10px;background:rgba(249,115,22,0.1);border-radius:8px;font-size:12px">
                                <div style="color:#f97316;font-weight:500">Logistics Impact</div>
                                <div style="color:rgba(255,255,255,0.6);margin-top:4px">
                                    Fuel: √ó${impact.fuelMultiplier.toFixed(2)} ‚Ä¢ Time: √ó${impact.timeMultiplier.toFixed(2)}
                                </div>
                            </div>
                        `;
                    } else {
                        warningsEl.innerHTML = `
                            <div style="margin-top:12px;padding:10px;background:rgba(34,197,94,0.1);border-radius:8px;font-size:12px;color:#22c55e">
                                ‚úì No significant steep sections detected
                            </div>
                        `;
                    }
                    
                } catch (err) {
                    console.error('Elevation analysis error:', err);
                    loadingEl.innerHTML = `<div style="color:rgba(255,255,255,0.5)">Error: ${Helpers.escapeHtml(err.message)}</div>`;
                }
            };
        });
    }

    function renderLogistics() {
        _saveScroll(); _restoreScroll();
        const config = LogisticsModule.getConfig();
        const profiles = LogisticsModule.getProfiles();
        const routes = State.get('routes');
        const waypoints = State.get('waypoints');
        
        // Run analysis if we have a route
        let analysis = null;
        let report = null;
        if (routes.length > 0 && routes[0].points?.length >= 2) {
            analysis = LogisticsModule.analyzeRoute(routes[0], waypoints, config);
            report = LogisticsModule.generateReport(analysis);
        }
        
        const waterCount = waypoints.filter(w => w.type === 'water').length;
        const fuelCount = waypoints.filter(w => w.type === 'fuel').length;
        const bailCount = waypoints.filter(w => w.type === 'bailout').length;

        container.innerHTML = `
            <div class="panel__header"><h2 class="panel__title">Logistics Calculator</h2></div>
            
            <!-- Vehicle Selection -->
            <div class="section-label">Vehicle Profile</div>
            <div class="vehicle-grid">
                ${Object.entries(profiles.vehicles).map(([k, v]) => `
                    <button class="vehicle-btn ${config.vehicle === k ? 'vehicle-btn--selected' : ''}" data-vehicle="${k}">
                        <div class="vehicle-btn__name">${v.icon} ${v.name}</div>
                        <div class="vehicle-btn__specs">${v.fuelCapacity} gal ‚Ä¢ ${v.consumption.road} mpg</div>
                    </button>
                `).join('')}
            </div>
            
            <!-- Aux Fuel -->
            <div style="margin-top:12px;display:flex;align-items:center;gap:10px">
                <label style="font-size:12px;color:rgba(255,255,255,0.6)">Extra Fuel (gal):</label>
                <input type="number" id="aux-fuel" value="${config.auxFuel}" min="0" max="50" step="5" 
                    style="width:70px;padding:8px;font-size:14px;text-align:center">
            </div>
            
            <div class="divider"></div>
            
            <!-- Personnel -->
            <div class="section-label">Personnel</div>
            <div id="personnel-list">
                ${(config.personnel.length === 0 ? [{type: 'fit_adult', count: 1}] : config.personnel).map((p, i) => `
                    <div class="list-item" style="margin-bottom:8px;display:flex;align-items:center;gap:8px">
                        <select data-personnel-type="${i}" style="flex:1;padding:8px">
                            ${Object.entries(profiles.personnel).map(([k, v]) => 
                                `<option value="${k}" ${p.type === k ? 'selected' : ''}>${v.icon} ${v.name}</option>`
                            ).join('')}
                        </select>
                        <input type="number" data-personnel-count="${i}" value="${p.count || 1}" min="1" max="20" 
                            style="width:50px;padding:8px;text-align:center">
                        <button class="btn btn--secondary" data-remove-personnel="${i}" style="padding:8px">‚úï</button>
                    </div>
                `).join('')}
            </div>
            <button class="btn btn--secondary btn--full" id="add-personnel" style="margin-top:8px">
                ${Icons.get('plus')} Add Personnel
            </button>
            
            <!-- Weather Toggle -->
            <label class="checkbox-field" style="margin-top:12px">
                <input type="checkbox" id="hot-weather" ${config.hotWeather ? 'checked' : ''} style="width:auto">
                <span>Hot Weather (+50% water)</span>
            </label>
            
            <div class="divider"></div>
            
            <!-- Analysis Results -->
            ${analysis && report ? `
                <div class="status-card ${report.feasibility === 'FEASIBLE' ? 'status-card--success' : 'status-card--error'}">
                    <div class="status-card__icon">${Icons.get(report.feasibility === 'FEASIBLE' ? 'check' : 'alert')}</div>
                    <div>
                        <div class="status-card__title">${report.feasibility === 'FEASIBLE' ? 'Route Feasible' : 'Route NOT Feasible'}</div>
                        <div class="status-card__desc">${report.distance} ‚Ä¢ ${report.duration}</div>
                    </div>
                </div>
                
                <div class="section-label">Fuel Analysis</div>
                <div class="stat-grid stat-grid--2">
                    <div class="stat-box">
                        <div class="stat-box__icon" style="color:#f59e0b">${Icons.get('fuel')}</div>
                        <div class="stat-box__value">${report.fuel.required}</div>
                        <div class="stat-box__label">REQUIRED</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-box__icon" style="color:#3b82f6">${Icons.get('route')}</div>
                        <div class="stat-box__value">${report.fuel.reserve}</div>
                        <div class="stat-box__label">RESERVE</div>
                    </div>
                </div>
                ${report.fuel.deficit !== 'None' ? `
                    <div style="margin-top:8px;padding:10px;background:rgba(239,68,68,0.15);border-radius:8px;color:#ef4444;font-size:13px">
                        ‚ö†Ô∏è ${report.fuel.deficit}
                    </div>
                ` : ''}
                
                <div class="section-label" style="margin-top:16px">Water & Food</div>
                <div class="stat-grid stat-grid--2">
                    <div class="stat-box">
                        <div class="stat-box__value" style="color:#3b82f6">üíß ${report.water.required}</div>
                        <div class="stat-box__label">${report.water.perDay}/DAY</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-box__value" style="color:#22c55e">üçΩÔ∏è ${report.food.perDay}</div>
                        <div class="stat-box__label">CAL/DAY</div>
                    </div>
                </div>
                
                ${analysis.criticalPoints.length > 0 ? `
                    <div class="section-label" style="margin-top:16px">‚ö†Ô∏è Critical Points (${analysis.criticalPoints.length})</div>
                    ${analysis.criticalPoints.map(cp => `
                        <div style="padding:10px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.2);border-radius:8px;margin-bottom:8px">
                            <div style="font-size:13px;font-weight:500;color:#ef4444">${cp.severity}: ${cp.location}</div>
                            <div style="font-size:12px;color:rgba(255,255,255,0.5)">${cp.issue}</div>
                        </div>
                    `).join('')}
                ` : ''}
                
                <div class="divider"></div>
                
                <!-- What-If Scenarios -->
                <div class="section-label">What-If Scenarios</div>
                ${fuelCount > 0 ? `
                    <div id="scenario-results"></div>
                    <div style="display:flex;flex-direction:column;gap:8px">
                        ${waypoints.filter(w => w.type === 'fuel').map(w => `
                            <button class="btn btn--secondary" data-scenario-cache="${w.id}" style="text-align:left;justify-content:flex-start">
                                ‚õΩ What if "${w.name}" is empty?
                            </button>
                        `).join('')}
                    </div>
                ` : `
                    <div style="padding:14px;background:rgba(255,255,255,0.03);border-radius:10px;font-size:12px;color:rgba(255,255,255,0.5)">
                        Add fuel cache waypoints to enable scenario analysis
                    </div>
                `}
            ` : `
                <div class="empty-state">
                    <div class="empty-state__icon">${Icons.get('route')}</div>
                    <div class="empty-state__title">No Route Selected</div>
                    <div class="empty-state__desc">Create a route to analyze logistics</div>
                </div>
            `}
            
            <div class="divider"></div>
            
            <!-- Route Resources Summary -->
            <div class="section-label">Route Resources</div>
            <div class="list-item"><span class="list-item__label">üíß Water Sources</span><span class="list-item__value" style="color:#3b82f6">${waterCount}</span></div>
            <div class="list-item" style="margin-top:8px"><span class="list-item__label">‚õΩ Fuel Caches</span><span class="list-item__value" style="color:#f59e0b">${fuelCount}</span></div>
            <div class="list-item" style="margin-top:8px"><span class="list-item__label">üöÅ Bail-out Points</span><span class="list-item__value" style="color:#ec4899">${bailCount}</span></div>
        `;
        
        // Event handlers
        container.querySelectorAll('[data-vehicle]').forEach(btn => {
            btn.onclick = () => {
                LogisticsModule.setConfig({ vehicle: btn.dataset.vehicle });
                renderLogistics();
            };
        });
        
        container.querySelector('#aux-fuel').onchange = (e) => {
            LogisticsModule.setConfig({ auxFuel: parseFloat(e.target.value) || 0 });
            renderLogistics();
        };
        
        container.querySelector('#hot-weather').onchange = (e) => {
            LogisticsModule.setConfig({ hotWeather: e.target.checked });
            renderLogistics();
        };
        
        container.querySelector('#add-personnel').onclick = () => {
            const current = LogisticsModule.getConfig().personnel;
            LogisticsModule.setConfig({ 
                personnel: [...current, { type: 'average_adult', count: 1 }] 
            });
            renderLogistics();
        };
        
        container.querySelectorAll('[data-personnel-type]').forEach(sel => {
            sel.onchange = (e) => {
                const idx = parseInt(sel.dataset.personnelType);
                const current = LogisticsModule.getConfig().personnel;
                current[idx] = { ...current[idx], type: e.target.value };
                LogisticsModule.setConfig({ personnel: current });
                renderLogistics();
            };
        });
        
        container.querySelectorAll('[data-personnel-count]').forEach(inp => {
            inp.onchange = (e) => {
                const idx = parseInt(inp.dataset.personnelCount);
                const current = LogisticsModule.getConfig().personnel;
                current[idx] = { ...current[idx], count: parseInt(e.target.value) || 1 };
                LogisticsModule.setConfig({ personnel: current });
                renderLogistics();
            };
        });
        
        container.querySelectorAll('[data-remove-personnel]').forEach(btn => {
            btn.onclick = () => {
                const idx = parseInt(btn.dataset.removePersonnel);
                const current = LogisticsModule.getConfig().personnel;
                current.splice(idx, 1);
                LogisticsModule.setConfig({ personnel: current.length ? current : [{ type: 'fit_adult', count: 1 }] });
                renderLogistics();
            };
        });
        
        container.querySelectorAll('[data-scenario-cache]').forEach(btn => {
            btn.onclick = () => {
                const cacheId = btn.dataset.scenarioCache;
                const result = LogisticsModule.runScenario(routes[0], waypoints, {
                    type: 'cache_empty',
                    cacheId: cacheId
                });
                
                const resultsDiv = container.querySelector('#scenario-results');
                const cacheName = waypoints.find(w => w.id === cacheId)?.name || 'Cache';
                
                resultsDiv.innerHTML = `
                    <div style="padding:14px;background:${result.comparison.stillViable ? 'rgba(34,197,94,0.1)' : 'rgba(239,68,68,0.1)'};
                        border:1px solid ${result.comparison.stillViable ? 'rgba(34,197,94,0.2)' : 'rgba(239,68,68,0.2)'};
                        border-radius:10px;margin-bottom:12px">
                        <div style="font-size:13px;font-weight:600;color:${result.comparison.stillViable ? '#22c55e' : '#ef4444'}">
                            ${result.comparison.stillViable ? '‚úì Route still viable' : '‚úó Route NOT viable'}
                        </div>
                        <div style="font-size:12px;color:rgba(255,255,255,0.6);margin-top:4px">
                            If "${cacheName}" is empty: +${result.comparison.fuelDifference.toFixed(1)} gal needed
                        </div>
                        ${result.comparison.newCriticalPoints.length > 0 ? `
                            <div style="font-size:11px;color:#ef4444;margin-top:4px">
                                ${result.comparison.newCriticalPoints.length} new critical point(s)
                            </div>
                        ` : ''}
                    </div>
                `;
            };
        });
    }

    async function renderOffline() {
        _saveScroll(); _restoreScroll();
        const regions = State.get('mapRegions') || [];
        const downloadedRegions = regions.filter(r => r.status === 'downloaded' || r.status === 'partial');
        const isDownloading = OfflineModule.isDownloadInProgress();
        const progress = OfflineModule.getDownloadProgress();
        const drawingState = OfflineModule.getDrawingState();
        
        // Get storage stats
        let storageStats = { usedFormatted: '...', quotaFormatted: '...', percentUsed: 0 };
        try {
            storageStats = await OfflineModule.getStorageStats();
        } catch (e) {
            console.warn('Failed to get storage stats:', e);
        }
        
        // Calculate total downloaded size from regions
        const totalDownloaded = downloadedRegions.reduce((sum, r) => sum + (r.estimatedSize || 0), 0);
        
        container.innerHTML = `
            <div class="panel__header">
                <h2 class="panel__title">Offline Maps</h2>
            </div>
            
            <!-- Storage Usage -->
            <div class="storage-bar">
                <div class="storage-bar__header">
                    <span class="storage-bar__label">Storage Used</span>
                    <span class="storage-bar__value">${storageStats.usedFormatted}</span>
                </div>
                <div class="storage-bar__track">
                    <div class="storage-bar__fill" style="width:${Math.min(storageStats.percentUsed, 100)}%"></div>
                </div>
            </div>
            
            <!-- Download Progress (if active) -->
            ${isDownloading && progress ? `
                <div style="padding:14px;background:rgba(249,115,22,0.1);border:1px solid rgba(249,115,22,0.3);border-radius:12px;margin-bottom:16px">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
                        <div>
                            <div style="font-size:13px;font-weight:500">Downloading "${progress.region?.name || 'Region'}"</div>
                            <div style="font-size:11px;color:rgba(255,255,255,0.5)">${progress.downloaded.toLocaleString()} / ${progress.total.toLocaleString()} tiles</div>
                        </div>
                        <button class="btn btn--secondary" id="cancel-download" style="padding:6px 12px;font-size:11px">Cancel</button>
                    </div>
                    <div style="height:6px;background:rgba(255,255,255,0.1);border-radius:3px;overflow:hidden">
                        <div style="height:100%;width:${progress.progress}%;background:linear-gradient(90deg,#f97316,#ea580c);transition:width 0.3s"></div>
                    </div>
                    ${progress.errors > 0 ? `
                        <div style="margin-top:8px;font-size:11px;color:#ef4444">‚ö†Ô∏è ${progress.errors} tile(s) failed</div>
                    ` : ''}
                </div>
            ` : ''}
            
            <!-- Drawing Mode Banner -->
            ${drawingState.isDrawing ? `
                <div style="padding:14px;background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:12px;margin-bottom:16px">
                    <div style="font-size:13px;font-weight:500;color:#3b82f6;margin-bottom:8px">‚úèÔ∏è Draw Region on Map</div>
                    <div style="font-size:12px;color:rgba(255,255,255,0.6);margin-bottom:10px">
                        Click and drag on the map to select the area you want to download.
                    </div>
                    <button class="btn btn--secondary btn--full" id="cancel-drawing">Cancel Drawing</button>
                </div>
            ` : ''}
            
            <!-- Actions -->
            ${!drawingState.isDrawing && !isDownloading ? `
                <div style="display:flex;gap:8px;margin-bottom:20px">
                    <button class="btn btn--primary" id="draw-region" style="flex:1">
                        ${Icons.get('edit')} Draw Region
                    </button>
                    <button class="btn btn--secondary" id="download-view" style="flex:1">
                        ${Icons.get('download')} Current View
                    </button>
                </div>
            ` : ''}
            
            <div class="divider"></div>
            
            <!-- Downloaded Regions -->
            <div class="section-label">Downloaded Regions (${downloadedRegions.length})</div>
            
            ${regions.length === 0 ? `
                <div class="empty-state">
                    <div class="empty-state__icon">${Icons.get('download')}</div>
                    <div class="empty-state__title">No Offline Maps</div>
                    <div class="empty-state__desc">Draw a region on the map or download the current view to use maps offline.</div>
                </div>
            ` : `
                <div class="panel__scroll" style="max-height:300px">
                    ${regions.map(r => {
                        const statusColors = {
                            downloaded: { bg: 'rgba(34,197,94,0.15)', color: '#22c55e', icon: 'check' },
                            partial: { bg: 'rgba(245,158,11,0.15)', color: '#f59e0b', icon: 'alert' },
                            downloading: { bg: 'rgba(249,115,22,0.15)', color: '#f97316', icon: 'download' },
                            queued: { bg: 'rgba(59,130,246,0.15)', color: '#3b82f6', icon: 'clock' },
                            error: { bg: 'rgba(239,68,68,0.15)', color: '#ef4444', icon: 'alert' },
                            cancelled: { bg: 'rgba(255,255,255,0.05)', color: 'rgba(255,255,255,0.3)', icon: 'close' }
                        };
                        const status = statusColors[r.status] || statusColors.cancelled;
                        
                        return `
                            <div class="card" style="margin-bottom:10px" data-region-id="${r.id}">
                                <div class="card__header">
                                    <div class="card__icon" style="background:${status.bg};color:${status.color}">
                                        ${Icons.get(status.icon)}
                                    </div>
                                    <div style="flex:1">
                                        <div class="card__title">${r.name}</div>
                                        <div class="card__subtitle">
                                            ${r.tileCount?.toLocaleString() || '?'} tiles ‚Ä¢ 
                                            ~${OfflineModule.formatSize(r.estimatedSize || 0)} ‚Ä¢ 
                                            z${r.minZoom}-${r.maxZoom}
                                        </div>
                                    </div>
                                    <button class="btn btn--secondary" data-delete-region="${r.id}" style="padding:6px" title="Delete">
                                        ${Icons.get('trash')}
                                    </button>
                                </div>
                                ${r.status === 'downloaded' || r.status === 'partial' ? `
                                    <div style="margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.06);display:flex;justify-content:space-between;font-size:11px;color:rgba(255,255,255,0.4)">
                                        <span>Layers: ${(r.layers || []).join(', ')}</span>
                                        <span>${r.lastSync ? 'Synced ' + new Date(r.lastSync).toLocaleDateString() : ''}</span>
                                    </div>
                                ` : ''}
                                ${r.status === 'partial' ? `
                                    <div style="margin-top:8px;font-size:11px;color:#f59e0b">
                                        ‚ö†Ô∏è ${r.failedTiles || 0} tiles failed to download
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            `}
            
            <div class="divider"></div>
            
            <!-- Storage Management -->
            <div class="section-label">Storage Management</div>
            <div style="display:flex;flex-direction:column;gap:8px">
                <div class="list-item">
                    <span class="list-item__label">Cached Tiles</span>
                    <span class="list-item__value" style="color:#f97316">${storageStats.usedFormatted}</span>
                </div>
                <div class="list-item">
                    <span class="list-item__label">Downloaded Regions</span>
                    <span class="list-item__value">${downloadedRegions.length}</span>
                </div>
            </div>
            
            <button class="btn btn--secondary btn--full" id="clear-cache" style="margin-top:12px;color:#ef4444">
                ${Icons.get('trash')} Clear All Cached Tiles
            </button>
            
            <div class="divider"></div>
            
            <!-- Background Sync Status -->
            <div class="section-label">Background Sync</div>
            <div id="background-sync-status" style="padding:12px;background:rgba(255,255,255,0.03);border-radius:10px">
                <div style="font-size:12px;color:rgba(255,255,255,0.5)">Checking status...</div>
            </div>
        `;
        
        // Event handlers
        const drawRegionBtn = container.querySelector('#draw-region');
        if (drawRegionBtn) {
            drawRegionBtn.onclick = () => {
                OfflineModule.startDrawing((bounds) => {
                    showDownloadRegionModal(bounds);
                });
                renderOffline();
                ModalsModule.showToast('Click and drag on the map to select a region', 'info');
            };
        }
        
        const downloadViewBtn = container.querySelector('#download-view');
        if (downloadViewBtn) {
            downloadViewBtn.onclick = () => {
                const mapState = MapModule.getMapState();
                const canvas = document.getElementById('map-canvas');
                if (!canvas) return;
                
                const w = canvas.offsetWidth;
                const h = canvas.offsetHeight;
                const topLeft = MapModule.pixelToLatLon(0, 0);
                const bottomRight = MapModule.pixelToLatLon(w, h);
                
                const bounds = {
                    north: topLeft.lat,
                    south: bottomRight.lat,
                    west: topLeft.lon,
                    east: bottomRight.lon
                };
                
                showDownloadRegionModal(bounds);
            };
        }
        
        const cancelDrawingBtn = container.querySelector('#cancel-drawing');
        if (cancelDrawingBtn) {
            cancelDrawingBtn.onclick = () => {
                OfflineModule.cancelDrawing();
                renderOffline();
            };
        }
        
        const cancelDownloadBtn = container.querySelector('#cancel-download');
        if (cancelDownloadBtn) {
            cancelDownloadBtn.onclick = () => {
                OfflineModule.cancelDownload();
            };
        }
        
        // Delete region handlers
        container.querySelectorAll('[data-delete-region]').forEach(btn => {
            btn.onclick = async (e) => {
                e.stopPropagation();
                const regionId = btn.dataset.deleteRegion;
                if (confirm('Delete this offline region? Cached tiles will be removed.')) {
                    try {
                        await OfflineModule.deleteRegion(regionId);
                        ModalsModule.showToast('Region deleted', 'success');
                        renderOffline();
                    } catch (err) {
                        ModalsModule.showToast('Failed to delete region: ' + err.message, 'error');
                    }
                }
            };
        });
        
        // Clear cache handler
        const clearCacheBtn = container.querySelector('#clear-cache');
        if (clearCacheBtn) {
            clearCacheBtn.onclick = async () => {
                if (confirm('Clear all cached map tiles? You will need to re-download regions for offline use.')) {
                    try {
                        await caches.delete('griddown-tiles-v1');
                        await Storage.Settings.set('offlineRegions', []);
                        State.set('mapRegions', []);
                        ModalsModule.showToast('Cache cleared', 'success');
                        renderOffline();
                    } catch (err) {
                        ModalsModule.showToast('Failed to clear cache: ' + err.message, 'error');
                    }
                }
            };
        }
        
        // Background sync status
        updateBackgroundSyncStatus();
    }
    
    /**
     * Update background sync status display
     */
    async function updateBackgroundSyncStatus() {
        const statusContainer = document.getElementById('background-sync-status');
        if (!statusContainer) return;
        
        try {
            const status = await OfflineModule.getBackgroundSyncStatus();
            
            let html = '';
            
            // Support status
            if (status.supported) {
                html += `
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
                        <span style="color:#22c55e">‚úì</span>
                        <span style="font-size:12px">Background sync supported</span>
                    </div>
                `;
            } else {
                html += `
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
                        <span style="color:#f59e0b">‚ö†Ô∏è</span>
                        <span style="font-size:12px;color:rgba(255,255,255,0.5)">Background sync not available in this browser</span>
                    </div>
                `;
            }
            
            // Pending sync status
            if (status.hasPendingSync) {
                html += `
                    <div style="padding:12px;background:rgba(249,115,22,0.1);border:1px solid rgba(249,115,22,0.3);border-radius:8px;margin-bottom:10px">
                        <div style="font-size:13px;font-weight:500;margin-bottom:6px">
                            üì• Background download in progress
                        </div>
                        <div style="font-size:11px;color:rgba(255,255,255,0.6);margin-bottom:8px">
                            "${status.regionName}" - ${status.downloadedCount.toLocaleString()} / ${status.totalTiles.toLocaleString()} tiles (${status.progress}%)
                        </div>
                        <div style="height:4px;background:rgba(255,255,255,0.1);border-radius:2px;overflow:hidden;margin-bottom:10px">
                            <div style="height:100%;width:${status.progress}%;background:#f97316;transition:width 0.3s"></div>
                        </div>
                        <div style="display:flex;gap:8px">
                            <button class="btn btn--secondary" id="resume-sync" style="flex:1;padding:8px;font-size:11px">
                                ‚ñ∂Ô∏è Resume
                            </button>
                            <button class="btn btn--secondary" id="cancel-sync" style="flex:1;padding:8px;font-size:11px;color:#ef4444">
                                ‚úï Cancel
                            </button>
                        </div>
                    </div>
                `;
            } else {
                html += `
                    <div style="font-size:12px;color:rgba(255,255,255,0.4)">
                        No background downloads pending
                    </div>
                `;
            }
            
            // Periodic sync option (if supported)
            if (status.periodicSupported) {
                html += `
                    <div style="margin-top:10px">
                        <label style="display:flex;align-items:center;gap:10px;cursor:pointer">
                            <input type="checkbox" id="periodic-sync-toggle" style="width:auto;accent-color:#f97316">
                            <span style="font-size:12px">Auto-refresh tiles daily</span>
                        </label>
                    </div>
                `;
            }
            
            statusContainer.innerHTML = html;
            
            // Attach event handlers
            const resumeBtn = statusContainer.querySelector('#resume-sync');
            if (resumeBtn) {
                resumeBtn.onclick = async () => {
                    const result = await OfflineModule.resumeBackgroundDownload();
                    if (result.success) {
                        ModalsModule.showToast('Background download resumed', 'success');
                    } else {
                        ModalsModule.showToast(result.reason || 'Failed to resume', 'error');
                    }
                    updateBackgroundSyncStatus();
                };
            }
            
            const cancelBtn = statusContainer.querySelector('#cancel-sync');
            if (cancelBtn) {
                cancelBtn.onclick = async () => {
                    if (confirm('Cancel background download?')) {
                        await OfflineModule.cancelBackgroundDownload();
                        ModalsModule.showToast('Background download cancelled', 'info');
                        renderOffline();
                    }
                };
            }
            
        } catch (err) {
            console.error('Error updating sync status:', err);
            statusContainer.innerHTML = `
                <div style="font-size:12px;color:rgba(255,255,255,0.4)">
                    Unable to check sync status
                </div>
            `;
        }
    }
    
    /**
     * Show download configuration modal for a region
     */
    function showDownloadRegionModal(bounds) {
        // Uses cached modalContainer ref
        
        // Default settings
        const defaultMinZoom = 10;
        const defaultMaxZoom = 14;
        const defaultLayers = ['standard'];
        
        // Get initial preview
        const preview = OfflineModule.getDownloadPreview(bounds, defaultMinZoom, defaultMaxZoom, defaultLayers);
        
        modalContainer.innerHTML = `
            <div class="modal-backdrop" id="modal-backdrop" role="presentation">
                <div class="modal" role="dialog" aria-modal="true" style="max-width:420px">
                    <div class="modal__header">
                        <h3 class="modal__title">Download Region</h3>
                        <button class="modal__close" id="modal-close" aria-label="Close dialog">${Icons.get('close')}</button>
                    </div>
                    <div class="modal__body">
                        <!-- Region bounds preview -->
                        <div style="padding:12px;background:rgba(249,115,22,0.1);border-radius:10px;margin-bottom:16px;font-size:12px">
                            <div style="color:rgba(255,255,255,0.5);margin-bottom:4px">Selected Area</div>
                            <div style="font-family:monospace">
                                ${bounds.north.toFixed(4)}¬∞N to ${bounds.south.toFixed(4)}¬∞N<br>
                                ${bounds.west.toFixed(4)}¬∞W to ${bounds.east.toFixed(4)}¬∞W
                            </div>
                        </div>
                        
                        <!-- Region name -->
                        <div class="form-group">
                            <label>Region Name</label>
                            <input type="text" id="region-name" placeholder="e.g., Sierra Nevada" value="">
                        </div>
                        
                        <!-- Zoom levels -->
                        <div class="form-group">
                            <label>Zoom Levels</label>
                            <div style="display:flex;gap:10px;align-items:center">
                                <select id="min-zoom" style="flex:1">
                                    ${[8,9,10,11,12].map(z => `
                                        <option value="${z}" ${z === defaultMinZoom ? 'selected' : ''}>
                                            ${z} ${z <= 9 ? '(Overview)' : z <= 10 ? '(Region)' : '(Detail)'}
                                        </option>
                                    `).join('')}
                                </select>
                                <span style="color:rgba(255,255,255,0.4)">to</span>
                                <select id="max-zoom" style="flex:1">
                                    ${[12,13,14,15,16].map(z => `
                                        <option value="${z}" ${z === defaultMaxZoom ? 'selected' : ''}>
                                            ${z} ${z <= 13 ? '(Streets)' : z <= 14 ? '(Buildings)' : '(Max)'}
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>
                        
                        <!-- Map layers -->
                        <div class="form-group">
                            <label>Map Layers</label>
                            
                            <!-- General Maps -->
                            <div style="margin-bottom:12px">
                                <div style="font-size:11px;color:rgba(255,255,255,0.4);margin-bottom:6px">üó∫Ô∏è GENERAL</div>
                                <div style="display:flex;flex-direction:column;gap:6px;padding-left:8px">
                                    <label class="checkbox-field" style="margin:0;padding:8px 12px">
                                        <input type="checkbox" id="layer-standard" checked style="width:auto">
                                        <span>OpenStreetMap ~15KB/tile</span>
                                    </label>
                                    <label class="checkbox-field" style="margin:0;padding:8px 12px">
                                        <input type="checkbox" id="layer-terrain" style="width:auto">
                                        <span>OpenTopoMap ~25KB/tile</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- USGS -->
                            <div style="margin-bottom:12px">
                                <div style="font-size:11px;color:rgba(255,255,255,0.4);margin-bottom:6px">üèîÔ∏è USGS (US only)</div>
                                <div style="display:flex;flex-direction:column;gap:6px;padding-left:8px">
                                    <label class="checkbox-field" style="margin:0;padding:8px 12px">
                                        <input type="checkbox" id="layer-usgs_topo" style="width:auto">
                                        <span>USGS Topo ~30KB/tile</span>
                                    </label>
                                    <label class="checkbox-field" style="margin:0;padding:8px 12px">
                                        <input type="checkbox" id="layer-usgs_imagery" style="width:auto">
                                        <span>USGS Imagery ~45KB/tile</span>
                                    </label>
                                    <label class="checkbox-field" style="margin:0;padding:8px 12px">
                                        <input type="checkbox" id="layer-usgs_hydro" style="width:auto">
                                        <span>USGS Hydro (water) ~10KB/tile</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- BLM -->
                            <div style="margin-bottom:12px">
                                <div style="font-size:11px;color:rgba(255,255,255,0.4);margin-bottom:6px">üèúÔ∏è BLM (US only)</div>
                                <div style="display:flex;flex-direction:column;gap:6px;padding-left:8px">
                                    <label class="checkbox-field" style="margin:0;padding:8px 12px">
                                        <input type="checkbox" id="layer-blm_surface" style="width:auto">
                                        <span>Land Ownership ~15KB/tile</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Download preview -->
                        <div style="padding:14px;background:rgba(0,0,0,0.2);border-radius:10px;margin-top:16px">
                            <div style="display:flex;justify-content:space-between;margin-bottom:8px">
                                <span style="color:rgba(255,255,255,0.5)">Total Tiles</span>
                                <span id="preview-tiles" style="font-weight:600">${preview.totalTiles.toLocaleString()}</span>
                            </div>
                            <div style="display:flex;justify-content:space-between">
                                <span style="color:rgba(255,255,255,0.5)">Est. Size</span>
                                <span id="preview-size" style="font-weight:600;color:#f97316">${preview.estimatedSize}</span>
                            </div>
                        </div>
                        
                        <div id="size-warning" style="display:${preview.estimatedSizeKB > 500000 ? 'block' : 'none'};margin-top:12px;padding:10px;background:rgba(239,68,68,0.1);border-radius:8px;font-size:12px;color:#ef4444">
                            ‚ö†Ô∏è Large download. Consider reducing zoom levels or selecting a smaller area.
                        </div>
                        
                        <!-- Background sync option -->
                        <div id="background-sync-option" style="margin-top:16px;padding:14px;background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.2);border-radius:10px">
                            <label class="checkbox-field" style="margin:0">
                                <input type="checkbox" id="use-background-sync" style="width:auto" checked>
                                <span>Download in background</span>
                            </label>
                            <div style="font-size:11px;color:rgba(255,255,255,0.5);margin-top:6px;margin-left:24px">
                                Download continues even if you close the app
                            </div>
                        </div>
                    </div>
                    <div class="modal__footer">
                        <button class="btn btn--secondary" id="modal-cancel">Cancel</button>
                        <button class="btn btn--primary" id="modal-download">${Icons.get('download')} Download</button>
                    </div>
                </div>
            </div>
        `;
        
        // Check background sync support and update UI
        (async () => {
            const syncStatus = await OfflineModule.getBackgroundSyncStatus();
            const syncOption = document.getElementById('background-sync-option');
            const syncCheckbox = domCache.get('use-background-sync');
            
            if (!syncStatus.supported) {
                syncOption.innerHTML = `
                    <div style="display:flex;align-items:center;gap:8px">
                        <span style="color:#f59e0b">‚ö†Ô∏è</span>
                        <span style="font-size:12px;color:rgba(255,255,255,0.5)">
                            Background sync not available in this browser. 
                            Download will run in foreground.
                        </span>
                    </div>
                `;
            }
        })();
        
        // All available layer keys
        const allLayerKeys = [
            'standard', 'terrain', 'satellite',
            'usgs_topo', 'usgs_imagery', 'usgs_hydro',
            'usfs_topo', 'natgeo',
            'blm_surface',
            'hillshade', 'labels'
        ];
        
        // Helper to get selected layers
        const getSelectedLayers = () => {
            const layers = [];
            allLayerKeys.forEach(key => {
                const checkbox = document.getElementById(`layer-${key}`);
                if (checkbox && checkbox.checked) {
                    layers.push(key);
                }
            });
            return layers.length > 0 ? layers : ['standard'];
        };
        
        // Update preview when options change
        const updatePreview = () => {
            const minZoom = parseInt(domCache.get('min-zoom').value);
            const maxZoom = parseInt(domCache.get('max-zoom').value);
            const layers = getSelectedLayers();
            
            const newPreview = OfflineModule.getDownloadPreview(bounds, minZoom, maxZoom, layers);
            document.getElementById('preview-tiles').textContent = newPreview.totalTiles.toLocaleString();
            document.getElementById('preview-size').textContent = newPreview.estimatedSize;
            document.getElementById('size-warning').style.display = newPreview.estimatedSizeKB > 500000 ? 'block' : 'none';
        };
        
        // Attach change handlers to all layer checkboxes
        domCache.get('min-zoom').onchange = updatePreview;
        domCache.get('max-zoom').onchange = updatePreview;
        allLayerKeys.forEach(key => {
            const checkbox = document.getElementById(`layer-${key}`);
            if (checkbox) checkbox.onchange = updatePreview;
        });
        
        // Close modal
        const closeModal = () => { modalContainer.innerHTML = ''; };
        domCache.get('modal-close').onclick = closeModal;
        domCache.get('modal-cancel').onclick = closeModal;
        domCache.get('modal-backdrop').onclick = (e) => {
            if (e.target.id === 'modal-backdrop') closeModal();
        };
        
        // Start download
        document.getElementById('modal-download').onclick = async () => {
            const name = document.getElementById('region-name').value || `Region ${new Date().toLocaleDateString()}`;
            const minZoom = parseInt(domCache.get('min-zoom').value);
            const maxZoom = parseInt(domCache.get('max-zoom').value);
            const layers = getSelectedLayers();
            
            if (layers.length === 0) {
                ModalsModule.showToast('Select at least one map layer', 'error');
                return;
            }
            
            const regionConfig = { name, bounds, minZoom, maxZoom, layers };
            const useBackgroundSync = domCache.get('use-background-sync')?.checked;
            
            closeModal();
            
            // Try background sync first if enabled
            if (useBackgroundSync && OfflineModule.isBackgroundSyncSupported()) {
                try {
                    const result = await OfflineModule.queueBackgroundDownload(regionConfig);
                    
                    if (result.supported) {
                        ModalsModule.showToast(`Downloading ${result.tileCount.toLocaleString()} tiles in background`, 'success');
                        renderOffline();
                        return;
                    }
                } catch (err) {
                    console.warn('Background sync failed, falling back to foreground:', err);
                }
            }
            
            // Foreground download (fallback or explicitly selected)
            try {
                await OfflineModule.downloadRegion(regionConfig, (progress) => {
                    // Update panel every 2% or on completion
                    if (progress.phase === 'complete' || progress.phase === 'cancelled' || progress.progress % 2 === 0) {
                        renderOffline();
                    }
                });
                
                ModalsModule.showToast('Download complete!', 'success');
            } catch (err) {
                if (err.message !== 'Download cancelled') {
                    ModalsModule.showToast('Download failed: ' + err.message, 'error');
                }
            }
            
            renderOffline();
        };
    }

    // ==================== APRS Helper Functions ====================
    
    // =========================================================================
    // COT BRIDGE SECTION
    // =========================================================================
    
    /**
     * Render CoT Bridge section for Team panel
     */
    function renderTAKSection() {
        if (typeof TAKModule === 'undefined') {
            return '';
        }
        
        const status = TAKModule.getStatus();
        const sharingStatus = TAKModule.getSharingStatus();
        const isConnected = status.isConnected;
        const isConnecting = status.isConnecting;
        
        return `
            <div class="section-label" style="display:flex;align-items:center;gap:8px">
                üì° CoT Bridge
                <span style="font-size:10px;color:rgba(255,255,255,0.3);font-weight:400">Tactical SA interop</span>
            </div>
            
            <div style="padding:14px;background:${isConnected ? 'rgba(6,182,212,0.1)' : 'rgba(255,255,255,0.03)'};border:1px solid ${isConnected ? 'rgba(6,182,212,0.3)' : 'rgba(255,255,255,0.1)'};border-radius:12px;margin-bottom:16px">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:${isConnected ? '12px' : '0'}">
                    <div style="width:40px;height:40px;border-radius:10px;background:${isConnected ? 'rgba(6,182,212,0.2)' : 'rgba(255,255,255,0.05)'};display:flex;align-items:center;justify-content:center">
                        <span style="font-size:20px">${isConnected ? 'üéØ' : isConnecting ? '‚è≥' : 'üì°'}</span>
                    </div>
                    <div style="flex:1">
                        <div style="font-size:14px;font-weight:600;color:${isConnected ? '#06b6d4' : 'inherit'}">
                            ${isConnected ? 'CoT Bridge Connected' : isConnecting ? 'Connecting...' : 'CoT Bridge'}
                        </div>
                        <div style="font-size:11px;color:rgba(255,255,255,0.5)">
                            ${isConnected 
                                ? `${status.positionCount} positions ‚Ä¢ ${status.markerCount} markers` 
                                : 'Connect to receive CoT data from compatible apps'}
                        </div>
                    </div>
                </div>
                
                ${isConnected ? `
                    <!-- Position Sharing Section -->
                    <div style="background:rgba(0,0,0,0.2);border-radius:8px;padding:12px;margin-bottom:12px">
                        <div style="font-size:11px;color:rgba(255,255,255,0.5);margin-bottom:8px;text-transform:uppercase">
                            Bidirectional Sharing
                        </div>
                        
                        ${!sharingStatus.consented ? `
                            <!-- Consent Required -->
                            <div style="background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.3);border-radius:6px;padding:10px;margin-bottom:10px">
                                <div style="font-size:11px;color:#fbbf24;font-weight:500;margin-bottom:4px">
                                    ‚ö†Ô∏è Position Sharing Consent Required
                                </div>
                                <div style="font-size:10px;color:rgba(255,255,255,0.6);margin-bottom:8px">
                                    Enabling sharing will broadcast your GPS position to all devices on the CoT network. 
                                    Your location will be visible to other users.
                                </div>
                                <label style="display:flex;align-items:center;gap:8px;font-size:11px;cursor:pointer">
                                    <input type="checkbox" id="cot-share-consent" style="width:16px;height:16px">
                                    I understand and consent to sharing my position
                                </label>
                            </div>
                        ` : `
                            <!-- Sharing Controls -->
                            <div style="display:flex;gap:8px;margin-bottom:10px">
                                <input type="text" id="cot-callsign" placeholder="Callsign" 
                                       value="${sharingStatus.callsign || 'GridDown'}"
                                       style="flex:1;padding:6px 8px;font-size:11px">
                                <select id="cot-team" style="padding:6px 8px;font-size:11px;background:#1a1f2e;color:#fff;border:1px solid rgba(255,255,255,0.2);border-radius:6px">
                                    <option value="Cyan" ${sharingStatus.team === 'Cyan' ? 'selected' : ''}>Cyan</option>
                                    <option value="Green" ${sharingStatus.team === 'Green' ? 'selected' : ''}>Green</option>
                                    <option value="Blue" ${sharingStatus.team === 'Blue' ? 'selected' : ''}>Blue</option>
                                    <option value="Yellow" ${sharingStatus.team === 'Yellow' ? 'selected' : ''}>Yellow</option>
                                    <option value="Orange" ${sharingStatus.team === 'Orange' ? 'selected' : ''}>Orange</option>
                                    <option value="Red" ${sharingStatus.team === 'Red' ? 'selected' : ''}>Red</option>
                                    <option value="White" ${sharingStatus.team === 'White' ? 'selected' : ''}>White</option>
                                </select>
                            </div>
                            
                            <div style="display:flex;gap:8px">
                                ${sharingStatus.enabled ? `
                                    <button class="btn btn--secondary" id="cot-stop-sharing" style="flex:1;font-size:11px;padding:6px;background:rgba(239,68,68,0.2);border-color:rgba(239,68,68,0.3)">
                                        ‚èπÔ∏è Stop Sharing
                                    </button>
                                ` : `
                                    <button class="btn btn--primary" id="cot-start-sharing" style="flex:1;font-size:11px;padding:6px">
                                        üìç Start Sharing Position
                                    </button>
                                `}
                                <button class="btn btn--secondary" id="cot-send-once" style="font-size:11px;padding:6px">
                                    üì§ Send Once
                                </button>
                            </div>
                            
                            ${sharingStatus.enabled ? `
                                <div style="font-size:10px;color:#22c55e;margin-top:8px;text-align:center">
                                    üî¥ LIVE ‚Ä¢ Broadcasting every ${sharingStatus.intervalMs / 1000}s
                                    ${sharingStatus.positionsSent > 0 ? ` ‚Ä¢ ${sharingStatus.positionsSent} sent` : ''}
                                </div>
                            ` : ''}
                            
                            <div style="font-size:9px;color:rgba(255,255,255,0.3);margin-top:8px;text-align:center">
                                <a href="#" id="cot-revoke-consent" style="color:rgba(255,255,255,0.4)">Revoke sharing consent</a>
                            </div>
                        `}
                    </div>
                    
                    <div style="display:flex;gap:8px">
                        <button class="btn btn--secondary" id="tak-disconnect-btn" style="flex:1;font-size:11px;padding:6px;color:#ef4444">
                            Disconnect
                        </button>
                    </div>
                ` : `
                    <div style="margin-top:12px">
                        <!-- Setup Wizard Button -->
                        <button class="btn btn--primary" id="cot-setup-wizard-btn" style="width:100%;padding:12px;font-size:13px;margin-bottom:16px;display:flex;align-items:center;justify-content:center;gap:8px">
                            <span>üßô</span> Setup Wizard
                        </button>
                        
                        <div style="text-align:center;font-size:11px;color:rgba(255,255,255,0.3);margin-bottom:12px">‚Äî or connect manually ‚Äî</div>
                        
                        <div style="font-size:11px;color:rgba(255,255,255,0.4);margin-bottom:6px">BRIDGE WEBSOCKET URL</div>
                        <div style="display:flex;gap:8px">
                            <input type="text" id="tak-bridge-url" 
                                   placeholder="ws://192.168.1.100:8765" 
                                   value="${status.bridgeUrl || ''}"
                                   style="flex:1;padding:8px;font-size:11px;font-family:monospace">
                            <button class="btn btn--secondary" id="tak-connect-btn" style="padding:8px 16px;font-size:11px">
                                Connect
                            </button>
                        </div>
                        <div style="font-size:10px;color:rgba(255,255,255,0.3);margin-top:6px">
                            Run griddown-cot-bridge on a Raspberry Pi to receive CoT multicast
                        </div>
                    </div>
                `}
            </div>
            
            ${isConnected ? renderTAKPositions() : ''}
        `;
    }
    
    /**
     * Render CoT positions list
     */
    function renderTAKPositions() {
        if (typeof TAKModule === 'undefined') return '';
        
        const positions = TAKModule.getPositions();
        
        if (positions.length === 0) {
            return `
                <div style="padding:12px;background:rgba(255,255,255,0.02);border-radius:8px;margin-bottom:16px">
                    <div style="font-size:11px;color:rgba(255,255,255,0.4);text-align:center">
                        Waiting for CoT positions...
                    </div>
                </div>
            `;
        }
        
        return `
            <div style="margin-bottom:16px">
                <div style="font-size:10px;color:rgba(255,255,255,0.4);margin-bottom:8px;text-transform:uppercase">
                    CoT Units (${positions.length})
                </div>
                <div style="max-height:150px;overflow-y:auto">
                    ${positions.map(pos => {
                        const teamColor = pos.color || '#06b6d4';
                        const speedMph = pos.speed ? (pos.speed * 2.237).toFixed(1) : null;
                        
                        return `
                            <div class="card" style="margin-bottom:6px;padding:8px;cursor:pointer" 
                                 onclick="if(typeof MapModule!=='undefined'){MapModule.centerOnLocation(${pos.lat},${pos.lon},15)}">
                                <div style="display:flex;align-items:center;gap:10px">
                                    <div style="width:32px;height:32px;border-radius:50%;background:${teamColor}33;display:flex;align-items:center;justify-content:center;border:2px solid ${teamColor}">
                                        <span style="font-size:12px;color:${teamColor};font-weight:bold">T</span>
                                    </div>
                                    <div style="flex:1;min-width:0">
                                        <div style="font-size:12px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">
                                            ${pos.name}
                                        </div>
                                        <div style="font-size:10px;color:rgba(255,255,255,0.4)">
                                            ${pos.team || 'No Team'}
                                            ${speedMph ? ` ‚Ä¢ ${speedMph} mph` : ''}
                                        </div>
                                    </div>
                                    <div style="text-align:right">
                                        <div style="font-size:10px;color:rgba(255,255,255,0.5)">
                                            ${pos.lat.toFixed(4)}¬∞
                                        </div>
                                        <div style="font-size:10px;color:rgba(255,255,255,0.5)">
                                            ${pos.lon.toFixed(4)}¬∞
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    }
    
    /**
     * Get APRS station count
     */
    function getAPRSStationCount() {
        if (typeof APRSModule === 'undefined') return 0;
        return APRSModule.getStations().length;
    }
    
    /**
     * Render APRS section for Team panel
     */
    function renderAPRSSection() {
        if (typeof APRSModule === 'undefined') {
            return `
                <div class="section-label">üìª APRS (VHF Radio)</div>
                <div style="padding:14px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:12px;margin-bottom:16px">
                    <div style="font-size:12px;color:rgba(255,255,255,0.5);text-align:center">
                        APRS module not loaded
                    </div>
                </div>
            `;
        }
        
        const isConnected = APRSModule.isConnected();
        const isConnecting = APRSModule.isConnecting();
        const stations = APRSModule.getStations();
        const stats = APRSModule.getStats();
        const config = {
            callsign: APRSModule.getCallsign(),
            beaconEnabled: APRSModule.isBeaconEnabled(),
            beaconInterval: APRSModule.getBeaconInterval(),
            smartBeaconing: APRSModule.isSmartBeaconing()
        };
        
        // Check for Web Bluetooth support
        const hasBluetooth = 'bluetooth' in navigator;
        
        return `
            <div class="section-label" style="display:flex;align-items:center;gap:8px">
                üìª APRS (VHF Radio)
                <span style="font-size:10px;color:rgba(255,255,255,0.3);font-weight:400">144.390 MHz ‚Ä¢ Long range</span>
            </div>
            
            <!-- APRS Connection Card -->
            <div style="padding:14px;background:${isConnected ? 'rgba(59,130,246,0.1)' : 'rgba(255,255,255,0.03)'};border:1px solid ${isConnected ? 'rgba(59,130,246,0.3)' : 'rgba(255,255,255,0.1)'};border-radius:12px;margin-bottom:12px">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:${isConnected ? '12px' : '0'}">
                    <div style="width:40px;height:40px;border-radius:10px;background:${isConnected ? 'rgba(59,130,246,0.2)' : 'rgba(255,255,255,0.05)'};display:flex;align-items:center;justify-content:center">
                        <span style="font-size:20px">${isConnected ? 'üìª' : isConnecting ? '‚è≥' : 'üì¥'}</span>
                    </div>
                    <div style="flex:1">
                        <div style="font-size:14px;font-weight:600;color:${isConnected ? '#3b82f6' : 'inherit'}">
                            ${isConnected ? 'TNC Connected' : isConnecting ? 'Connecting...' : 'TNC Not Connected'}
                        </div>
                        <div style="font-size:11px;color:rgba(255,255,255,0.5)">
                            ${isConnected 
                                ? `${stats.packetsReceived} pkts received ‚Ä¢ ${stations.length} stations` 
                                : hasBluetooth 
                                    ? 'Connect Bluetooth TNC (Mobilinkd)' 
                                    : 'Web Bluetooth not supported'}
                        </div>
                    </div>
                </div>
                
                ${isConnected ? `
                    <!-- Connected Actions -->
                    <div style="display:flex;gap:8px;margin-bottom:12px">
                        <button class="btn btn--secondary aprs-beacon-btn" style="flex:1;font-size:12px;padding:8px;${config.beaconEnabled ? 'background:rgba(59,130,246,0.2);border-color:rgba(59,130,246,0.3)' : ''}">
                            ${config.beaconEnabled ? '‚è∏Ô∏è Stop Beacon' : '‚ñ∂Ô∏è Start Beacon'}
                        </button>
                        <button class="btn btn--secondary aprs-send-beacon-btn" style="font-size:12px;padding:8px">
                            üìç Send Now
                        </button>
                        <button class="btn btn--secondary aprs-disconnect-btn" style="font-size:12px;padding:8px;color:#ef4444">
                            ‚úï
                        </button>
                    </div>
                    
                    <!-- Beacon Status -->
                    ${config.beaconEnabled ? `
                        <div style="padding:8px;background:rgba(59,130,246,0.1);border-radius:6px;font-size:11px;color:rgba(255,255,255,0.6)">
                            üîÑ Beaconing as <strong>${config.callsign || 'NO CALL'}</strong> 
                            every ${config.smartBeaconing ? 'smart' : config.beaconInterval + 's'}
                        </div>
                    ` : ''}
                ` : `
                    <!-- Not Connected -->
                    ${!isConnecting ? `
                        <!-- Callsign Configuration -->
                        <div style="padding:12px;background:rgba(255,255,255,0.03);border-radius:10px;margin-bottom:12px">
                            <div style="font-size:11px;color:rgba(255,255,255,0.4);margin-bottom:8px">YOUR CALLSIGN (Required for TX)</div>
                            <div style="display:flex;gap:8px">
                                <input type="text" id="aprs-callsign" placeholder="W1ABC" value="${config.callsign.split('-')[0] || ''}" 
                                    style="flex:2;padding:8px;font-size:13px;text-transform:uppercase" maxlength="6">
                                <select id="aprs-ssid" style="flex:1;padding:8px;font-size:12px">
                                    <option value="0" ${config.callsign.endsWith('-0') || !config.callsign.includes('-') ? 'selected' : ''}>-0 (Fixed)</option>
                                    <option value="1" ${config.callsign.endsWith('-1') ? 'selected' : ''}>-1 (Digi)</option>
                                    <option value="5" ${config.callsign.endsWith('-5') ? 'selected' : ''}>-5 (Phone)</option>
                                    <option value="7" ${config.callsign.endsWith('-7') ? 'selected' : ''}>-7 (HT)</option>
                                    <option value="9" ${config.callsign.endsWith('-9') ? 'selected' : ''}>-9 (Mobile)</option>
                                    <option value="10" ${config.callsign.endsWith('-10') ? 'selected' : ''}>-10 (Net)</option>
                                    <option value="14" ${config.callsign.endsWith('-14') ? 'selected' : ''}>-14 (Truck)</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Connect Button -->
                        <button class="btn btn--primary btn--full aprs-connect-btn" ${!hasBluetooth ? 'disabled' : ''}>
                            ${Icons.get('satellite')} Connect Bluetooth TNC
                        </button>
                        
                        ${!hasBluetooth ? `
                            <div style="margin-top:8px;padding:10px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.2);border-radius:8px;font-size:12px;color:#ef4444">
                                ‚ö†Ô∏è Web Bluetooth requires Chrome or Edge
                            </div>
                        ` : `
                            <div style="margin-top:8px;font-size:10px;color:rgba(255,255,255,0.4);text-align:center">
                                Supports Mobilinkd TNC3/TNC4 and compatible devices
                            </div>
                        `}
                    ` : ''}
                `}
            </div>
            
            <!-- APRS Stations List (if any) -->
            ${stations.length > 0 ? `
                <div class="section-label" style="display:flex;justify-content:space-between;align-items:center">
                    <span>üì° APRS Stations (${stations.length})</span>
                    <button class="btn btn--secondary aprs-clear-stations-btn" style="padding:4px 8px;font-size:10px">Clear</button>
                </div>
                <div style="max-height:200px;overflow-y:auto;margin-bottom:12px">
                    ${(() => {
                        // Get current GPS or manual position for distance calculations
                        let myPos = null;
                        if (typeof GPSModule !== 'undefined') {
                            const gpsPos = GPSModule.getPosition();
                            if (gpsPos && gpsPos.lat && gpsPos.lon) {
                                myPos = { lat: gpsPos.lat, lon: gpsPos.lon };
                            }
                        }
                        
                        // Get stations with distance info (sorted by distance if GPS available)
                        const stationsWithDist = myPos ? APRSModule.getStationsWithDistance(myPos) : stations;
                        
                        return stationsWithDist.slice(0, 25).map(station => {
                            const symbolInfo = APRSModule.getSymbolInfo(station.symbol);
                            const age = Date.now() - station.lastHeard;
                            const ageStr = age < 60000 ? 'now' : 
                                          age < 3600000 ? Math.floor(age/60000) + 'm ago' : 
                                          Math.floor(age/3600000) + 'h ago';
                            const isFresh = age < 3600000;
                            
                            // Get distance info (either from sorted list or calculate)
                            let distInfo = station.distanceInfo;
                            if (!distInfo && myPos && station.lat && station.lon) {
                                distInfo = APRSModule.getDistanceToStation(station.callsign, myPos);
                            }
                            
                            return `
                                <div class="card" style="margin-bottom:6px;padding:10px;opacity:${isFresh ? 1 : 0.6}" data-aprs-station="${station.callsign}">
                                    <div style="display:flex;align-items:center;gap:10px">
                                        <div style="width:36px;height:36px;border-radius:10px;background:rgba(59,130,246,0.15);display:flex;align-items:center;justify-content:center;flex-shrink:0">
                                            <span style="font-size:18px">${symbolInfo.icon}</span>
                                        </div>
                                        <div style="flex:1;min-width:0">
                                            <div style="display:flex;align-items:center;gap:6px">
                                                <span style="font-size:13px;font-weight:600;font-family:'IBM Plex Mono',monospace">${station.callsign}</span>
                                                ${station.speed && station.speed > 2 ? `<span style="font-size:10px;color:#3b82f6">${Math.round(station.speed)} mph</span>` : ''}
                                            </div>
                                            <div style="font-size:10px;color:rgba(255,255,255,0.4);margin-top:2px">
                                                ${symbolInfo.name} ‚Ä¢ ${ageStr}
                                            </div>
                                            ${station.status ? `
                                                <div style="font-size:10px;color:rgba(255,255,255,0.5);margin-top:3px;font-style:italic;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">
                                                    "${station.status.slice(0, 40)}"
                                                </div>
                                            ` : ''}
                                        </div>
                                        ${distInfo ? `
                                            <div style="text-align:right;flex-shrink:0">
                                                <div style="font-size:14px;font-weight:600;color:#3b82f6">${distInfo.formatted}</div>
                                                <div style="font-size:10px;color:rgba(255,255,255,0.5)">${distInfo.compass} (${Math.round(distInfo.bearing)}¬∞)</div>
                                            </div>
                                        ` : ''}
                                        ${station.lat && station.lon ? `
                                            <button class="btn btn--secondary" data-goto-aprs="${station.callsign}" style="padding:6px 8px;font-size:11px;margin-left:4px" title="Go to location">üéØ</button>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('');
                    })()}
                    ${stations.length > 25 ? `
                        <div style="padding:8px;text-align:center;font-size:11px;color:rgba(255,255,255,0.4)">
                            +${stations.length - 25} more stations
                        </div>
                    ` : ''}
                </div>
                ${(() => {
                    // GPS status message for distance display
                    let myPos = null;
                    if (typeof GPSModule !== 'undefined') {
                        const gpsPos = GPSModule.getPosition();
                        if (gpsPos && gpsPos.lat && gpsPos.lon) {
                            myPos = gpsPos;
                        }
                    }
                    if (!myPos) {
                        return `
                            <div style="padding:8px;background:rgba(59,130,246,0.1);border-radius:8px;font-size:11px;color:rgba(255,255,255,0.5);text-align:center;margin-bottom:12px">
                                üìç Enable GPS or set manual position to see distance/bearing to stations
                            </div>
                        `;
                    }
                    return '';
                })()}
            ` : ''}
            
            <!-- APRS Info Box (collapsed by default) -->
            <details style="margin-bottom:12px">
                <summary style="cursor:pointer;font-size:11px;color:rgba(255,255,255,0.5);padding:8px;background:rgba(255,255,255,0.03);border-radius:8px">
                    ‚ÑπÔ∏è What is APRS?
                </summary>
                <div style="padding:10px;font-size:11px;color:rgba(255,255,255,0.5);line-height:1.5">
                    <p style="margin-bottom:8px"><strong>APRS</strong> (Automatic Packet Reporting System) is a digital communications protocol used by amateur radio operators.</p>
                    <p style="margin-bottom:8px">‚Ä¢ Operates on VHF (144.390 MHz in North America)</p>
                    <p style="margin-bottom:8px">‚Ä¢ Range: 50+ miles with digipeaters</p>
                    <p style="margin-bottom:8px">‚Ä¢ Requires ham radio license to transmit</p>
                    <p>‚Ä¢ Works completely offline - no internet needed</p>
                </div>
            </details>
        `;
    }
    
    /**
     * Attach APRS event handlers
     */
    function attachAPRSHandlers() {
        if (typeof APRSModule === 'undefined') return;
        
        // Connect button
        const connectBtn = container.querySelector('.aprs-connect-btn');
        if (connectBtn) {
            connectBtn.onclick = async () => {
                try {
                    // Save callsign first
                    const callsign = container.querySelector('#aprs-callsign')?.value || '';
                    const ssid = container.querySelector('#aprs-ssid')?.value || '9';
                    if (callsign) {
                        APRSModule.setCallsign(callsign, parseInt(ssid));
                    }
                    
                    await APRSModule.connectBluetooth();
                    ModalsModule.showToast('Connected to APRS TNC', 'success');
                    renderTeam();
                } catch (err) {
                    ModalsModule.showToast('APRS connection failed: ' + err.message, 'error');
                    renderTeam();
                }
            };
        }
        
        // Disconnect button
        const disconnectBtn = container.querySelector('.aprs-disconnect-btn');
        if (disconnectBtn) {
            disconnectBtn.onclick = () => {
                APRSModule.disconnect();
                ModalsModule.showToast('Disconnected from APRS TNC', 'info');
                renderTeam();
            };
        }
        
        // Toggle beacon
        const beaconBtn = container.querySelector('.aprs-beacon-btn');
        if (beaconBtn) {
            beaconBtn.onclick = () => {
                const enabled = APRSModule.isBeaconEnabled();
                APRSModule.setBeaconEnabled(!enabled);
                ModalsModule.showToast(enabled ? 'Beacon stopped' : 'Beacon started', 'info');
                renderTeam();
            };
        }
        
        // Send beacon now
        const sendBeaconBtn = container.querySelector('.aprs-send-beacon-btn');
        if (sendBeaconBtn) {
            sendBeaconBtn.onclick = async () => {
                try {
                    await APRSModule.sendBeacon(true);
                    ModalsModule.showToast('Position beacon sent', 'success');
                } catch (err) {
                    ModalsModule.showToast('Beacon failed: ' + err.message, 'error');
                }
            };
        }
        
        // Clear stations
        const clearBtn = container.querySelector('.aprs-clear-stations-btn');
        if (clearBtn) {
            clearBtn.onclick = () => {
                APRSModule.clearStations();
                ModalsModule.showToast('APRS stations cleared', 'info');
                renderTeam();
            };
        }
        
        // Go to APRS station
        container.querySelectorAll('[data-goto-aprs]').forEach(btn => {
            btn.onclick = () => {
                const station = APRSModule.getStation(btn.dataset.gotoAprs);
                if (station && station.lat && station.lon && typeof MapModule !== 'undefined') {
                    MapModule.setCenter(station.lat, station.lon, 15);
                    ModalsModule.showToast(`Centered on ${station.callsign}`, 'info');
                }
            };
        });
    }

    // ==================== Position Helper Functions ====================

    /**
     * Render Position section for Team panel
     * Supports GPS (internal/external) and manual position entry
     */
    function renderPositionSection() {
        if (typeof GPSModule === 'undefined') {
            return `
                <div class="section-label">üìç My Position</div>
                <div style="padding:14px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:12px;margin-bottom:16px">
                    <div style="font-size:12px;color:rgba(255,255,255,0.5);text-align:center">
                        GPS module not loaded
                    </div>
                </div>
            `;
        }
        
        const gpsState = GPSModule.getState();
        const currentPos = GPSModule.getPosition();
        const isGPSActive = GPSModule.isActive();
        const isUsingManual = GPSModule.isUsingManualPosition();
        const positionSource = GPSModule.getPositionSource();
        
        // Format current position for display
        let positionDisplay = 'No position set';
        let positionColor = 'rgba(255,255,255,0.4)';
        
        if (currentPos) {
            if (typeof Coordinates !== 'undefined') {
                positionDisplay = Coordinates.format(currentPos.lat, currentPos.lon);
            } else {
                positionDisplay = `${currentPos.lat.toFixed(6)}, ${currentPos.lon.toFixed(6)}`;
            }
            positionColor = isUsingManual ? '#a855f7' : '#22c55e';  // Purple for manual, green for GPS
        }
        
        // Source indicator
        const sourceIcon = isUsingManual ? 'üìå' : (isGPSActive ? 'üõ∞Ô∏è' : 'üìç');
        
        return `
            <div style="margin-bottom:20px">
                <div class="section-label" style="display:flex;align-items:center;gap:8px">
                    üìç My Position
                </div>
                
                <!-- Compact Position Card -->
                <div style="padding:12px;background:${currentPos ? 'rgba(34,197,94,0.05)' : 'rgba(255,255,255,0.03)'};border:1px solid ${currentPos ? (isUsingManual ? 'rgba(168,85,247,0.3)' : 'rgba(34,197,94,0.3)') : 'rgba(255,255,255,0.1)'};border-radius:12px">
                    
                    <div style="display:flex;align-items:center;gap:10px">
                        <div style="width:36px;height:36px;border-radius:8px;background:${currentPos ? (isUsingManual ? 'rgba(168,85,247,0.2)' : 'rgba(34,197,94,0.2)') : 'rgba(255,255,255,0.05)'};display:flex;align-items:center;justify-content:center">
                            <span style="font-size:18px">${sourceIcon}</span>
                        </div>
                        <div style="flex:1;min-width:0">
                            <div style="font-size:12px;font-weight:600;color:${positionColor};font-family:monospace;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">
                                ${positionDisplay}
                            </div>
                            <div style="font-size:10px;color:rgba(255,255,255,0.5)">
                                ${positionSource !== 'none' ? positionSource : 'Not set'}
                                ${gpsState.accuracy ? ` ‚Ä¢ ¬±${Math.round(gpsState.accuracy)}m` : ''}
                            </div>
                        </div>
                        ${currentPos ? `
                            <button class="btn btn--secondary position-center-btn" style="font-size:11px;padding:6px 8px" title="Center map">
                                üéØ
                            </button>
                        ` : ''}
                    </div>
                    
                    <!-- Quick Actions -->
                    <div style="display:flex;gap:6px;margin-top:10px">
                        ${!currentPos ? `
                            <button class="btn btn--primary position-goto-gps-btn" style="flex:1;font-size:11px;padding:6px">
                                ‚öôÔ∏è Set Position in GPS Panel
                            </button>
                        ` : `
                            <button class="btn btn--secondary position-goto-gps-btn" style="flex:1;font-size:11px;padding:6px">
                                ‚öôÔ∏è GPS Settings
                            </button>
                        `}
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * Attach Position section event handlers (simplified for Team panel)
     */
    function attachPositionHandlers() {
        if (typeof GPSModule === 'undefined') return;
        
        // Center map button
        const centerBtn = container.querySelector('.position-center-btn');
        if (centerBtn) {
            centerBtn.onclick = () => {
                const pos = GPSModule.getPosition();
                if (pos && typeof MapModule !== 'undefined') {
                    MapModule.setCenter(pos.lat, pos.lon);
                }
            };
        }
        
        // Go to GPS panel button
        const gotoGpsBtn = container.querySelector('.position-goto-gps-btn');
        if (gotoGpsBtn) {
            gotoGpsBtn.onclick = () => {
                // Switch to GPS panel
                State.set('activePanel', 'gps');
                render();
            };
        }
    }

    /**
     * Open manual position entry modal
     */
    function openManualPositionModal() {
        // Uses cached modalContainer ref
        if (!modalContainer) return;
        
        const currentManual = typeof GPSModule !== 'undefined' ? GPSModule.getManualPosition() : null;
        
        modalContainer.innerHTML = `
            <div class="modal-backdrop" id="modal-backdrop" role="presentation">
                <div class="modal" role="dialog" aria-modal="true" style="max-width:420px;width:90%">
                    <div class="modal__header">
                        <h3 class="modal__title">üìå Set Manual Position</h3>
                        <button class="modal__close" id="modal-close" aria-label="Close dialog">&times;</button>
                    </div>
                    <div class="modal__body">
                        <p style="font-size:12px;color:rgba(255,255,255,0.6);margin-bottom:16px">
                            Enter coordinates in any format: Decimal Degrees (37.4215, -119.1892), 
                            DMS (37¬∞ 25' 17.4" N, 119¬∞ 11' 21.1" W), UTM, or MGRS.
                        </p>
                        
                        <!-- Coordinate Input -->
                        <div style="margin-bottom:16px">
                            <label style="font-size:12px;color:rgba(255,255,255,0.5);margin-bottom:4px;display:block">Coordinates</label>
                            <input type="text" id="manual-position-input" 
                                placeholder="e.g., 37.4215, -119.1892"
                                value="${currentManual ? `${currentManual.lat}, ${currentManual.lon}` : ''}"
                                style="width:100%;padding:12px;font-size:14px;font-family:monospace;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:white;box-sizing:border-box">
                        </div>
                        
                        <!-- Quick Examples -->
                        <div style="margin-bottom:16px">
                            <div style="font-size:11px;color:rgba(255,255,255,0.4);margin-bottom:6px">SUPPORTED FORMATS</div>
                            <div style="display:flex;flex-wrap:wrap;gap:6px">
                                <button class="btn btn--secondary manual-pos-example" data-example="37.4215, -119.1892" style="font-size:10px;padding:4px 8px">DD</button>
                                <button class="btn btn--secondary manual-pos-example" data-example="37¬∞ 25' 17.4&quot; N, 119¬∞ 11' 21.1&quot; W" style="font-size:10px;padding:4px 8px">DMS</button>
                                <button class="btn btn--secondary manual-pos-example" data-example="11S 318234 4143234" style="font-size:10px;padding:4px 8px">UTM</button>
                                <button class="btn btn--secondary manual-pos-example" data-example="11SLA1823443234" style="font-size:10px;padding:4px 8px">MGRS</button>
                            </div>
                        </div>
                        
                        <!-- Optional Name -->
                        <div style="margin-bottom:16px">
                            <label style="font-size:12px;color:rgba(255,255,255,0.5);margin-bottom:4px;display:block">Location Name (optional)</label>
                            <input type="text" id="manual-position-name" 
                                placeholder="e.g., Base Camp, Observation Post"
                                value="${currentManual?.name || ''}"
                                style="width:100%;padding:10px;font-size:13px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:white;box-sizing:border-box">
                        </div>
                        
                        <!-- Optional Altitude -->
                        <div style="margin-bottom:20px">
                            <label style="font-size:12px;color:rgba(255,255,255,0.5);margin-bottom:4px;display:block">Altitude in meters (optional)</label>
                            <input type="number" id="manual-position-altitude" 
                                placeholder="e.g., 1500"
                                value="${currentManual?.altitude || ''}"
                                style="width:100%;padding:10px;font-size:13px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:white;box-sizing:border-box">
                        </div>
                        
                        <!-- Parse Preview -->
                        <div id="manual-position-preview" style="padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;margin-bottom:16px;min-height:40px">
                            <div style="font-size:11px;color:rgba(255,255,255,0.4)">Enter coordinates to preview...</div>
                        </div>
                    </div>
                    <div class="modal__footer">
                        <button class="btn btn--secondary" id="modal-cancel">Cancel</button>
                        <button class="btn btn--primary" id="manual-position-save-btn">üìå Set Position</button>
                    </div>
                </div>
            </div>
        `;
        
        const closeModal = () => { modalContainer.innerHTML = ''; };
        
        // Close handlers
        modalContainer.querySelector('#modal-close').onclick = closeModal;
        modalContainer.querySelector('#modal-cancel').onclick = closeModal;
        modalContainer.querySelector('#modal-backdrop').onclick = (e) => {
            if (e.target.id === 'modal-backdrop') closeModal();
        };
        
        // Setup event handlers
        const input = domCache.get('manual-position-input');
        const preview = document.getElementById('manual-position-preview');
        const saveBtn = document.getElementById('manual-position-save-btn');
        
        // Live preview of coordinate parsing
        if (input && preview) {
            const updatePreview = () => {
                const value = input.value.trim();
                if (!value) {
                    preview.innerHTML = '<div style="font-size:11px;color:rgba(255,255,255,0.4)">Enter coordinates to preview...</div>';
                    return;
                }
                
                if (typeof Coordinates !== 'undefined') {
                    const parsed = Coordinates.parse(value);
                    if (parsed) {
                        preview.innerHTML = `
                            <div style="font-size:11px;color:#22c55e;margin-bottom:4px">‚úì Valid coordinates detected</div>
                            <div style="font-size:13px;font-family:monospace;color:white">${parsed.lat.toFixed(6)}, ${parsed.lon.toFixed(6)}</div>
                            <div style="font-size:11px;color:rgba(255,255,255,0.5);margin-top:4px">${Coordinates.toDD(parsed.lat, parsed.lon)}</div>
                        `;
                    } else {
                        preview.innerHTML = '<div style="font-size:11px;color:#ef4444">‚úó Could not parse coordinates</div>';
                    }
                } else {
                    // Fallback: try simple decimal parsing
                    const match = value.match(/^([-\d.]+)[,\s]+([-\d.]+)$/);
                    if (match) {
                        const lat = parseFloat(match[1]);
                        const lon = parseFloat(match[2]);
                        if (!isNaN(lat) && !isNaN(lon)) {
                            preview.innerHTML = `
                                <div style="font-size:11px;color:#22c55e;margin-bottom:4px">‚úì Valid coordinates</div>
                                <div style="font-size:13px;font-family:monospace;color:white">${lat.toFixed(6)}, ${lon.toFixed(6)}</div>
                            `;
                        } else {
                            preview.innerHTML = '<div style="font-size:11px;color:#ef4444">‚úó Invalid coordinates</div>';
                        }
                    } else {
                        preview.innerHTML = '<div style="font-size:11px;color:#ef4444">‚úó Could not parse coordinates</div>';
                    }
                }
            };
            
            input.addEventListener('input', updatePreview);
            updatePreview();  // Initial preview if value exists
        }
        
        // Example buttons
        modalContainer.querySelectorAll('.manual-pos-example').forEach(btn => {
            btn.onclick = () => {
                if (input) {
                    input.value = btn.dataset.example;
                    input.dispatchEvent(new Event('input'));
                }
            };
        });
        
        // Save button
        if (saveBtn) {
            saveBtn.onclick = () => {
                const coordInput = domCache.get('manual-position-input');
                const nameInput = document.getElementById('manual-position-name');
                const altInput = document.getElementById('manual-position-altitude');
                
                if (!coordInput || !coordInput.value.trim()) {
                    if (typeof ModalsModule !== 'undefined') {
                        ModalsModule.showToast('Please enter coordinates', 'error');
                    }
                    return;
                }
                
                const options = {};
                if (nameInput && nameInput.value.trim()) {
                    options.name = nameInput.value.trim();
                }
                if (altInput && altInput.value) {
                    options.altitude = parseFloat(altInput.value);
                }
                
                let success = false;
                if (typeof GPSModule !== 'undefined') {
                    success = GPSModule.setManualPositionFromString(coordInput.value, options);
                }
                
                if (success) {
                    closeModal();
                    if (typeof ModalsModule !== 'undefined') {
                        ModalsModule.showToast('Manual position set', 'success');
                    }
                    
                    // Re-render appropriate panel
                    if (State.get('activePanel') === 'gps') {
                        renderGPS();
                    } else {
                        renderTeam();
                    }
                    
                    // Center map on new position
                    const pos = GPSModule.getPosition();
                    if (pos && typeof MapModule !== 'undefined') {
                        MapModule.setCenter(pos.lat, pos.lon);
                        MapModule.render();
                    }
                } else {
                    if (typeof ModalsModule !== 'undefined') {
                        ModalsModule.showToast('Could not parse coordinates. Check format.', 'error');
                    }
                }
            };
        }
        
        // Focus input
        if (input) input.focus();
    }

    // ==================== RadiaCode Helper Functions ====================

    /**
     * Render RadiaCode section for Team panel
     */
    function renderRadiaCodeSection() {
        if (typeof RadiaCodeModule === 'undefined') {
            return `
                <div class="section-label">‚ò¢Ô∏è RadiaCode (Radiation)</div>
                <div style="padding:14px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:12px;margin-bottom:16px">
                    <div style="font-size:12px;color:rgba(255,255,255,0.5);text-align:center">
                        RadiaCode module not loaded
                    </div>
                </div>
            `;
        }
        
        const isConnected = RadiaCodeModule.isConnected();
        const isConnecting = RadiaCodeModule.isConnecting();
        const isDemoMode = RadiaCodeModule.isDemoMode();
        const reading = RadiaCodeModule.getCurrentReading();
        const deviceInfo = RadiaCodeModule.getDeviceInfo();
        const alertLevel = RadiaCodeModule.getAlertLevel();
        const isRecording = RadiaCodeModule.isRecording();
        const tracks = RadiaCodeModule.getTracks();
        const stats = RadiaCodeModule.getStats();
        
        // Check for Web Bluetooth support
        const hasBluetooth = 'bluetooth' in navigator;
        
        // Get alert color
        const alertColors = {
            normal: '#22c55e',
            elevated: '#eab308',
            warning: '#f97316',
            alarm: '#ef4444'
        };
        const alertColor = alertColors[alertLevel] || alertColors.normal;
        
        return `
            <div class="section-label" style="display:flex;align-items:center;gap:8px">
                ‚ò¢Ô∏è RadiaCode (Radiation)
                <span style="font-size:10px;color:rgba(255,255,255,0.3);font-weight:400">Gamma dosimeter</span>
                ${isDemoMode ? '<span style="font-size:9px;padding:2px 6px;background:rgba(147,51,234,0.3);border-radius:4px;color:#a855f7">DEMO</span>' : ''}
            </div>
            
            <!-- RadiaCode Connection Card -->
            <div style="padding:14px;background:${isConnected ? (isDemoMode ? 'rgba(147,51,234,0.1)' : 'rgba(34,197,94,0.1)') : 'rgba(255,255,255,0.03)'};border:1px solid ${isConnected ? (isDemoMode ? 'rgba(147,51,234,0.3)' : 'rgba(34,197,94,0.3)') : 'rgba(255,255,255,0.1)'};border-radius:12px;margin-bottom:12px">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:${isConnected ? '12px' : '0'}">
                    <div style="width:40px;height:40px;border-radius:10px;background:${isConnected ? (isDemoMode ? 'rgba(147,51,234,0.2)' : 'rgba(34,197,94,0.2)') : 'rgba(255,255,255,0.05)'};display:flex;align-items:center;justify-content:center">
                        <span style="font-size:20px">${isConnected ? (isDemoMode ? 'üß™' : '‚ò¢Ô∏è') : isConnecting ? '‚è≥' : 'üì¥'}</span>
                    </div>
                    <div style="flex:1">
                        <div style="font-size:14px;font-weight:600;color:${isConnected ? (isDemoMode ? '#a855f7' : '#22c55e') : 'inherit'}">
                            ${isConnected 
                                ? (isDemoMode ? 'Demo Mode (Simulated)' : (deviceInfo.serialNumber || 'RadiaCode Connected'))
                                : isConnecting ? 'Connecting...' : 'RadiaCode Not Connected'}
                        </div>
                        <div style="font-size:11px;color:rgba(255,255,255,0.5)">
                            ${isConnected 
                                ? (isDemoMode 
                                    ? `Simulating RadiaCode-103 ‚Ä¢ ${stats.packetsReceived} readings`
                                    : `FW: ${deviceInfo.firmwareVersion || 'Unknown'} ‚Ä¢ ${stats.packetsReceived} readings`)
                                : hasBluetooth 
                                    ? 'Connect RadiaCode via Bluetooth' 
                                    : 'Web Bluetooth not supported'}
                        </div>
                    </div>
                </div>
                
                ${isConnected ? `
                    <!-- Live Reading Display -->
                    <div style="background:rgba(0,0,0,0.3);border-radius:10px;padding:12px;margin-bottom:12px">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                            <span style="font-size:10px;color:rgba(255,255,255,0.4);text-transform:uppercase">Dose Rate</span>
                            <span style="font-size:10px;padding:2px 6px;border-radius:4px;background:${alertColor};color:#000;font-weight:600">${alertLevel.toUpperCase()}</span>
                        </div>
                        <div style="font-size:28px;font-weight:700;color:${alertColor};font-family:'IBM Plex Mono',monospace;letter-spacing:-1px">
                            ${RadiaCodeModule.formatDoseRate(reading.doseRate)}
                        </div>
                        <div style="display:flex;gap:16px;margin-top:8px;font-size:11px;color:rgba(255,255,255,0.5)">
                            <span>CPS: ${RadiaCodeModule.formatCountRate(reading.countRate)}</span>
                            <span>Session: ${RadiaCodeModule.getDoseLog().currentSessionDose.toFixed(3)} ŒºSv</span>
                            <span>Lifetime: ${RadiaCodeModule.getDoseLog().cumulativeDose.toFixed(3)} ŒºSv</span>
                        </div>
                    </div>
                    
                    <!-- Recording & Actions -->
                    <div style="display:flex;gap:8px;margin-bottom:12px">
                        <button class="btn ${isRecording ? 'btn--danger' : 'btn--secondary'} radiacode-record-btn" style="flex:1;font-size:12px;padding:8px">
                            ${isRecording ? '‚èπÔ∏è Stop Recording' : '‚è∫Ô∏è Record Track'}
                        </button>
                        <button class="btn btn--secondary radiacode-spectrum-btn" style="font-size:12px;padding:8px" title="View Spectrum">
                            üìä
                        </button>
                        <button class="btn btn--secondary radiacode-disconnect-btn" style="font-size:12px;padding:8px;color:#ef4444" title="Disconnect">
                            ‚úï
                        </button>
                    </div>
                    
                    <!-- Recording Status -->
                    ${isRecording ? `
                        <div style="padding:8px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:6px;font-size:11px;color:rgba(255,255,255,0.7);margin-bottom:12px">
                            <span style="color:#ef4444">‚óè</span> Recording track ‚Ä¢ ${RadiaCodeModule.getCurrentTrack()?.points?.length || 0} points
                        </div>
                    ` : ''}
                    
                    <!-- Heatmap Toggle + Dose Log -->
                    <div style="display:flex;gap:8px;margin-bottom:12px;align-items:center">
                        <button class="btn btn--secondary radiacode-heatmap-btn" style="flex:1;font-size:11px;padding:6px;${RadiaCodeModule.isHeatmapEnabled() ? 'background:rgba(34,197,94,0.2);border-color:rgba(34,197,94,0.4)' : ''}">
                            üó∫Ô∏è Heatmap ${RadiaCodeModule.isHeatmapEnabled() ? 'ON' : 'OFF'}
                        </button>
                        <button class="btn btn--secondary radiacode-dose-reset-btn" style="font-size:11px;padding:6px" title="Reset cumulative dose log">
                            üîÑ Reset Dose
                        </button>
                    </div>
                ` : `
                    <!-- Not Connected -->
                    ${!isConnecting ? `
                        <button class="btn btn--primary btn--full radiacode-connect-btn" ${!hasBluetooth ? 'disabled' : ''}>
                            ‚ò¢Ô∏è Connect RadiaCode
                        </button>
                        
                        <button class="btn btn--secondary btn--full radiacode-demo-btn" style="margin-top:8px">
                            üß™ Start Demo Mode
                        </button>
                        
                        ${!hasBluetooth ? `
                            <div style="margin-top:8px;padding:10px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.2);border-radius:8px;font-size:12px;color:#ef4444">
                                ‚ö†Ô∏è Web Bluetooth requires Chrome or Edge. Use Demo Mode to test.
                            </div>
                        ` : `
                            <div style="margin-top:8px;font-size:10px;color:rgba(255,255,255,0.4);text-align:center">
                                Supports RadiaCode 101/102/103/110 devices
                            </div>
                        `}
                    ` : ''}
                `}
            </div>
            
            <!-- Radiation Tracks -->
            ${tracks.length > 0 ? `
                <div class="section-label" style="display:flex;justify-content:space-between;align-items:center">
                    <span>üìà Radiation Tracks (${tracks.length})</span>
                </div>
                <div style="max-height:120px;overflow-y:auto;margin-bottom:12px">
                    ${tracks.slice(-5).reverse().map(track => {
                        const duration = track.stats.duration ? Math.round(track.stats.duration / 60000) : 0;
                        const maxDose = track.stats.maxDoseRate || 0;
                        const avgDose = track.stats.avgDoseRate || 0;
                        const points = track.points?.length || 0;
                        const maxColor = RadiaCodeModule.getDoseColor(maxDose);
                        
                        return `
                            <div class="card" style="margin-bottom:6px;padding:10px" data-radiacode-track="${track.id}">
                                <div style="display:flex;align-items:center;gap:10px">
                                    <div style="width:36px;height:36px;border-radius:10px;background:rgba(34,197,94,0.15);display:flex;align-items:center;justify-content:center">
                                        <span style="font-size:16px">‚ò¢Ô∏è</span>
                                    </div>
                                    <div style="flex:1;min-width:0">
                                        <div style="font-size:12px;font-weight:500">${track.name}</div>
                                        <div style="font-size:10px;color:rgba(255,255,255,0.4)">
                                            ${duration} min ‚Ä¢ ${points} points ‚Ä¢ ${track.stats.distance?.toFixed(2) || 0} mi
                                        </div>
                                    </div>
                                    <div style="text-align:right">
                                        <div style="font-size:12px;font-weight:600;color:${maxColor}">${maxDose.toFixed(2)} ŒºSv/h</div>
                                        <div style="font-size:10px;color:rgba(255,255,255,0.4)">max</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            ` : ''}
            
            <!-- Radiation Info Box -->
            <details style="margin-bottom:12px">
                <summary style="cursor:pointer;font-size:11px;color:rgba(255,255,255,0.5);padding:8px;background:rgba(255,255,255,0.03);border-radius:8px">
                    ‚ÑπÔ∏è Radiation Reference Levels
                </summary>
                <div style="padding:10px;font-size:11px;color:rgba(255,255,255,0.5);line-height:1.6">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                        <div><span style="color:#22c55e">‚óè</span> Normal: &lt;0.3 ŒºSv/h</div>
                        <div><span style="color:#eab308">‚óè</span> Elevated: 0.3-2.5 ŒºSv/h</div>
                        <div><span style="color:#f97316">‚óè</span> Warning: 2.5-10 ŒºSv/h</div>
                        <div><span style="color:#ef4444">‚óè</span> Alarm: &gt;10 ŒºSv/h</div>
                    </div>
                    <div style="margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.1)">
                        <strong>Reference:</strong> Natural background is typically 0.1-0.3 ŒºSv/h. 
                        Annual limit for public is 1 mSv (1000 ŒºSv).
                    </div>
                </div>
            </details>
        `;
    }
    
    /**
     * Attach RadiaCode event handlers
     */
    function attachRadiaCodeHandlers() {
        if (typeof RadiaCodeModule === 'undefined') return;
        
        // Connect button
        const connectBtn = container.querySelector('.radiacode-connect-btn');
        if (connectBtn) {
            connectBtn.onclick = async () => {
                try {
                    await RadiaCodeModule.connect();
                    renderTeam();
                } catch (e) {
                    console.error('RadiaCode connection failed:', e);
                    if (typeof ModalsModule !== 'undefined') {
                        ModalsModule.showToast('Connection failed: ' + e.message, 'error');
                    }
                }
            };
        }
        
        // Demo mode button
        const demoBtn = container.querySelector('.radiacode-demo-btn');
        if (demoBtn) {
            demoBtn.onclick = () => {
                RadiaCodeModule.startDemo();
                renderTeam();
            };
        }
        
        // Disconnect button
        const disconnectBtn = container.querySelector('.radiacode-disconnect-btn');
        if (disconnectBtn) {
            disconnectBtn.onclick = () => {
                RadiaCodeModule.disconnect();
                renderTeam();
            };
        }
        
        // Record button
        const recordBtn = container.querySelector('.radiacode-record-btn');
        if (recordBtn) {
            recordBtn.onclick = () => {
                if (RadiaCodeModule.isRecording()) {
                    RadiaCodeModule.stopTrack();
                } else {
                    RadiaCodeModule.startTrack();
                }
                renderTeam();
            };
        }
        
        // Spectrum button
        const spectrumBtn = container.querySelector('.radiacode-spectrum-btn');
        if (spectrumBtn) {
            spectrumBtn.onclick = () => {
                openRadiaCodeSpectrumModal();
            };
        }
        
        // Track click handlers
        container.querySelectorAll('[data-radiacode-track]').forEach(el => {
            el.onclick = () => {
                const trackId = parseInt(el.dataset.radiacodeTrack);
                openRadiaCodeTrackModal(trackId);
            };
        });
        
        // Heatmap toggle
        const heatmapBtn = container.querySelector('.radiacode-heatmap-btn');
        if (heatmapBtn) {
            heatmapBtn.onclick = () => {
                RadiaCodeModule.setHeatmapEnabled(!RadiaCodeModule.isHeatmapEnabled());
                renderTeam();
                if (typeof MapModule !== 'undefined') MapModule.render();
            };
        }
        
        // Dose log reset
        const doseResetBtn = container.querySelector('.radiacode-dose-reset-btn');
        if (doseResetBtn) {
            doseResetBtn.onclick = () => {
                if (confirm('Reset cumulative dose log? This clears all session history.')) {
                    RadiaCodeModule.resetDoseLog();
                    renderTeam();
                    if (typeof ModalsModule !== 'undefined') {
                        ModalsModule.showToast('Dose log reset', 'info');
                    }
                }
            };
        }
    }
    
    /**
     * Open RadiaCode spectrum viewer modal
     */
    function openRadiaCodeSpectrumModal() {
        if (typeof RadiaCodeModule === 'undefined') return;
        if (!modalContainer) return;
        
        const spectrum = RadiaCodeModule.getSpectrum();
        const peaks = RadiaCodeModule.findPeaks();
        const isotopes = RadiaCodeModule.identifyIsotopes();
        
        // Total counts for display
        const totalCounts = spectrum.counts.reduce((a, b) => a + b, 0);
        
        modalContainer.innerHTML = `
            <div class="modal-backdrop" id="modal-backdrop" role="presentation">
                <div class="modal" role="dialog" aria-modal="true" style="max-width:660px;width:95%">
                    <div class="modal__header">
                        <h3 class="modal__title">üìä Gamma Spectrum</h3>
                        <button class="modal__close" id="modal-close" aria-label="Close dialog">&times;</button>
                    </div>
                    <div class="modal__body" style="padding:12px">
                        <div style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:12px;font-size:12px;color:rgba(255,255,255,0.6)">
                            <span>Duration: ${spectrum.duration.toFixed(1)}s</span>
                            <span>Total: ${totalCounts.toLocaleString()} counts</span>
                            <span>Peaks: ${peaks.length}</span>
                            <span>Isotopes: ${isotopes.length}</span>
                        </div>
                        
                        <!-- Scale Toggle -->
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                            <span style="font-size:11px;color:rgba(255,255,255,0.5)">Scale:</span>
                            <button id="spectrum-scale-toggle" class="btn btn--secondary" style="font-size:11px;padding:3px 10px;min-width:60px">Log</button>
                            <span style="flex:1"></span>
                            <span style="font-size:10px;color:rgba(255,255,255,0.3)">Tap chart for reading</span>
                        </div>
                        
                        <!-- Spectrum Chart -->
                        <div style="position:relative;background:rgba(0,0,0,0.4);border-radius:8px;padding:0;margin-bottom:12px;border:1px solid rgba(255,255,255,0.08)">
                            <canvas id="spectrum-canvas" style="width:100%;height:220px;display:block;cursor:crosshair"></canvas>
                            <div id="spectrum-tooltip" style="display:none;position:absolute;background:rgba(0,0,0,0.85);border:1px solid rgba(255,255,255,0.2);border-radius:6px;padding:6px 10px;font-size:11px;color:#fff;pointer-events:none;z-index:10;white-space:nowrap"></div>
                        </div>
                        
                        <!-- Identified Isotopes -->
                        ${isotopes.length > 0 ? `
                            <div style="font-size:12px;font-weight:600;color:rgba(255,255,255,0.7);margin-bottom:8px">‚ò¢Ô∏è Identified Isotopes</div>
                            <div style="display:grid;gap:6px;max-height:200px;overflow-y:auto">
                                ${isotopes.map(match => {
                                    const confPct = (match.confidence * 100).toFixed(0);
                                    const confColor = match.confidence > 0.7 ? '#22c55e' : match.confidence > 0.4 ? '#eab308' : '#f97316';
                                    return `
                                    <div style="padding:10px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.06);border-radius:8px;display:flex;align-items:center;gap:12px">
                                        <div style="width:40px;height:40px;border-radius:8px;background:rgba(34,197,94,0.15);display:flex;align-items:center;justify-content:center;flex-shrink:0">
                                            <span style="font-size:13px;font-weight:700;color:#22c55e">${match.isotope.name.split('-')[0]}</span>
                                        </div>
                                        <div style="flex:1;min-width:0">
                                            <div style="font-weight:600;font-size:13px">${match.isotope.name}
                                                <span style="font-size:10px;font-weight:400;color:rgba(255,255,255,0.4);margin-left:4px">t¬Ω ${match.isotope.halfLife}</span>
                                            </div>
                                            <div style="font-size:11px;color:rgba(255,255,255,0.5);margin-top:2px">${match.isotope.notes}</div>
                                        </div>
                                        <div style="text-align:right;flex-shrink:0">
                                            <div style="font-size:12px;font-family:'IBM Plex Mono',monospace">${match.peak.energy.toFixed(1)} keV</div>
                                            <div style="font-size:10px;color:${confColor};font-weight:600">${confPct}%</div>
                                            <div style="width:40px;height:3px;background:rgba(255,255,255,0.1);border-radius:2px;margin-top:3px">
                                                <div style="width:${confPct}%;height:100%;background:${confColor};border-radius:2px"></div>
                                            </div>
                                        </div>
                                    </div>
                                `}).join('')}
                            </div>
                        ` : `
                            <div style="padding:20px;text-align:center;color:rgba(255,255,255,0.4);font-size:13px">
                                No isotopes identified yet. Accumulate more counts for better analysis.
                            </div>
                        `}
                    </div>
                    <div class="modal__footer" style="display:flex;gap:8px;flex-wrap:wrap">
                        <button class="btn btn--secondary" id="spectrum-reset-btn" style="font-size:12px">
                            üîÑ Reset
                        </button>
                        <button class="btn btn--secondary" id="spectrum-refresh-btn" style="font-size:12px">
                            üì• Refresh
                        </button>
                        <span style="flex:1"></span>
                        <button class="btn btn--primary" id="modal-close-btn" style="font-size:12px">Close</button>
                    </div>
                </div>
            </div>
        `;
        
        const closeModal = () => { modalContainer.innerHTML = ''; };
        
        // Close handlers
        modalContainer.querySelector('#modal-close').onclick = closeModal;
        modalContainer.querySelector('#modal-close-btn').onclick = closeModal;
        modalContainer.querySelector('#modal-backdrop').onclick = (e) => {
            if (e.target.id === 'modal-backdrop') closeModal();
        };
        
        // Reset spectrum
        modalContainer.querySelector('#spectrum-reset-btn').onclick = () => {
            RadiaCodeModule.resetSpectrum();
            closeModal();
            if (typeof ModalsModule !== 'undefined') {
                ModalsModule.showToast('Spectrum reset', 'info');
            }
        };
        
        // Refresh data
        modalContainer.querySelector('#spectrum-refresh-btn').onclick = () => {
            RadiaCodeModule.requestSpectrum();
            if (typeof ModalsModule !== 'undefined') {
                ModalsModule.showToast('Requesting spectrum data...', 'info');
            }
            setTimeout(() => openRadiaCodeSpectrumModal(), 500);
        };
        
        // ==================== Spectrum Chart Rendering ====================
        let useLogScale = true;
        const canvas = document.getElementById('spectrum-canvas');
        const tooltip = document.getElementById('spectrum-tooltip');
        const scaleToggle = document.getElementById('spectrum-scale-toggle');
        
        if (!canvas) return;
        
        function drawSpectrum() {
            // High-DPI canvas sizing
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            const ctx = canvas.getContext('2d');
            ctx.scale(dpr, dpr);
            
            const W = rect.width;
            const H = rect.height;
            const PAD_L = 44;   // left padding for Y-axis labels
            const PAD_R = 10;
            const PAD_T = 16;   // top padding for isotope labels
            const PAD_B = 24;   // bottom for energy axis
            const chartW = W - PAD_L - PAD_R;
            const chartH = H - PAD_T - PAD_B;
            
            // Calibration-aware energy range
            const cal = spectrum.calibration;
            const maxEnergy = cal[0] + cal[1] * 1023 + cal[2] * 1023 * 1023;
            const energyRange = Math.ceil(maxEnergy / 500) * 500; // round up to nearest 500 keV
            
            // Channel to X pixel
            function chToX(ch) {
                const energy = cal[0] + cal[1] * ch + cal[2] * ch * ch;
                return PAD_L + (energy / energyRange) * chartW;
            }
            
            // Energy to X pixel
            function eToX(energy) {
                return PAD_L + (energy / energyRange) * chartW;
            }
            
            // Find max count for scaling
            const maxCount = Math.max(...spectrum.counts, 1);
            const logMax = Math.log10(Math.max(maxCount, 10));
            
            // Count to Y pixel
            function countToY(count) {
                if (useLogScale) {
                    if (count <= 0) return PAD_T + chartH;
                    const logVal = Math.log10(count);
                    return PAD_T + chartH - (logVal / logMax) * chartH;
                } else {
                    return PAD_T + chartH - (count / maxCount) * chartH;
                }
            }
            
            // Clear
            ctx.clearRect(0, 0, W, H);
            
            // Background grid
            ctx.strokeStyle = 'rgba(255,255,255,0.06)';
            ctx.lineWidth = 1;
            
            // Horizontal grid lines (Y-axis)
            if (useLogScale) {
                for (let exp = 0; exp <= logMax; exp++) {
                    const y = countToY(Math.pow(10, exp));
                    ctx.beginPath();
                    ctx.moveTo(PAD_L, y);
                    ctx.lineTo(W - PAD_R, y);
                    ctx.stroke();
                }
            } else {
                for (let i = 0; i <= 4; i++) {
                    const val = (maxCount / 4) * i;
                    const y = countToY(val);
                    ctx.beginPath();
                    ctx.moveTo(PAD_L, y);
                    ctx.lineTo(W - PAD_R, y);
                    ctx.stroke();
                }
            }
            
            // Vertical grid lines (energy)
            for (let keV = 500; keV < energyRange; keV += 500) {
                const x = eToX(keV);
                ctx.beginPath();
                ctx.moveTo(x, PAD_T);
                ctx.lineTo(x, PAD_T + chartH);
                ctx.stroke();
            }
            
            // Draw spectrum as filled area
            ctx.beginPath();
            ctx.moveTo(chToX(0), PAD_T + chartH);
            for (let ch = 0; ch < 1024; ch++) {
                const x = chToX(ch);
                const y = countToY(spectrum.counts[ch]);
                ctx.lineTo(x, y);
            }
            ctx.lineTo(chToX(1023), PAD_T + chartH);
            ctx.closePath();
            
            // Gradient fill
            const grad = ctx.createLinearGradient(0, PAD_T, 0, PAD_T + chartH);
            grad.addColorStop(0, 'rgba(34,197,94,0.5)');
            grad.addColorStop(1, 'rgba(34,197,94,0.05)');
            ctx.fillStyle = grad;
            ctx.fill();
            
            // Spectrum line
            ctx.beginPath();
            for (let ch = 0; ch < 1024; ch++) {
                const x = chToX(ch);
                const y = countToY(spectrum.counts[ch]);
                if (ch === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.strokeStyle = '#22c55e';
            ctx.lineWidth = 1.2;
            ctx.stroke();
            
            // Peak markers + energy labels
            ctx.font = '9px system-ui, sans-serif';
            ctx.textAlign = 'center';
            peaks.forEach(peak => {
                const x = chToX(peak.channel);
                const y = countToY(peak.counts);
                
                // Dashed vertical line at peak
                ctx.save();
                ctx.setLineDash([3, 3]);
                ctx.strokeStyle = 'rgba(239,68,68,0.5)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(x, y);
                ctx.lineTo(x, PAD_T + chartH);
                ctx.stroke();
                ctx.restore();
                
                // Peak dot
                ctx.beginPath();
                ctx.arc(x, y, 3, 0, Math.PI * 2);
                ctx.fillStyle = '#ef4444';
                ctx.fill();
                
                // Energy label above peak
                const label = peak.energy.toFixed(0) + ' keV';
                ctx.fillStyle = 'rgba(255,255,255,0.6)';
                ctx.fillText(label, x, Math.max(y - 8, PAD_T + 8));
            });
            
            // Isotope annotations on chart
            const labelledPositions = [];
            isotopes.forEach(match => {
                const x = eToX(match.isotope.energy);
                if (x < PAD_L || x > W - PAD_R) return;
                
                // Avoid overlapping labels
                const tooClose = labelledPositions.some(lx => Math.abs(lx - x) < 45);
                
                // Triangular marker at top
                ctx.beginPath();
                ctx.moveTo(x - 4, PAD_T + 2);
                ctx.lineTo(x + 4, PAD_T + 2);
                ctx.lineTo(x, PAD_T + 8);
                ctx.closePath();
                ctx.fillStyle = match.confidence > 0.5 ? '#fbbf24' : 'rgba(251,191,36,0.5)';
                ctx.fill();
                
                if (!tooClose) {
                    // Isotope name label
                    ctx.font = 'bold 10px system-ui, sans-serif';
                    ctx.fillStyle = '#fbbf24';
                    ctx.textAlign = 'center';
                    ctx.fillText(match.isotope.name, x, PAD_T - 2);
                    labelledPositions.push(x);
                }
            });
            
            // Y-axis labels (counts)
            ctx.font = '9px system-ui, sans-serif';
            ctx.fillStyle = 'rgba(255,255,255,0.4)';
            ctx.textAlign = 'right';
            if (useLogScale) {
                for (let exp = 0; exp <= logMax; exp++) {
                    const y = countToY(Math.pow(10, exp));
                    ctx.fillText(exp === 0 ? '1' : '10^' + exp, PAD_L - 4, y + 3);
                }
            } else {
                for (let i = 0; i <= 4; i++) {
                    const val = Math.round((maxCount / 4) * i);
                    const y = countToY(val);
                    ctx.fillText(val >= 1000 ? (val / 1000).toFixed(1) + 'k' : val.toString(), PAD_L - 4, y + 3);
                }
            }
            
            // X-axis labels (energy)
            ctx.textAlign = 'center';
            ctx.fillStyle = 'rgba(255,255,255,0.45)';
            ctx.font = '10px system-ui, sans-serif';
            const step = energyRange <= 1500 ? 200 : 500;
            for (let keV = 0; keV <= energyRange; keV += step) {
                const x = eToX(keV);
                if (x < PAD_L - 5 || x > W - PAD_R + 5) continue;
                ctx.fillText(keV + ' keV', x, H - 4);
            }
            
            // Axis lines
            ctx.strokeStyle = 'rgba(255,255,255,0.15)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(PAD_L, PAD_T);
            ctx.lineTo(PAD_L, PAD_T + chartH);
            ctx.lineTo(W - PAD_R, PAD_T + chartH);
            ctx.stroke();
        }
        
        // Initial draw
        drawSpectrum();
        
        // Scale toggle
        if (scaleToggle) {
            scaleToggle.onclick = () => {
                useLogScale = !useLogScale;
                scaleToggle.textContent = useLogScale ? 'Log' : 'Linear';
                drawSpectrum();
            };
        }
        
        // Crosshair tooltip on hover/tap
        if (canvas && tooltip) {
            const handlePointer = (e) => {
                const rect = canvas.getBoundingClientRect();
                const mx = e.clientX - rect.left;
                const PAD_L = 44, PAD_R = 10, PAD_T = 16, PAD_B = 24;
                const chartW = rect.width - PAD_L - PAD_R;
                
                if (mx < PAD_L || mx > rect.width - PAD_R) {
                    tooltip.style.display = 'none';
                    return;
                }
                
                const cal = spectrum.calibration;
                const maxEnergy = cal[0] + cal[1] * 1023 + cal[2] * 1023 * 1023;
                const energyRange = Math.ceil(maxEnergy / 500) * 500;
                const energy = ((mx - PAD_L) / chartW) * energyRange;
                
                // Find closest channel
                let bestCh = 0;
                let bestDiff = Infinity;
                for (let ch = 0; ch < 1024; ch++) {
                    const chE = cal[0] + cal[1] * ch + cal[2] * ch * ch;
                    const diff = Math.abs(chE - energy);
                    if (diff < bestDiff) { bestDiff = diff; bestCh = ch; }
                }
                
                const counts = spectrum.counts[bestCh];
                tooltip.innerHTML = `<strong>${energy.toFixed(1)} keV</strong> (ch ${bestCh})<br>Counts: ${counts.toLocaleString()}`;
                tooltip.style.display = 'block';
                
                // Position tooltip avoiding edges
                const ttW = tooltip.offsetWidth;
                let left = mx + 12;
                if (left + ttW > rect.width) left = mx - ttW - 12;
                tooltip.style.left = left + 'px';
                tooltip.style.top = (e.clientY - rect.top - 40) + 'px';
            };
            
            canvas.addEventListener('pointermove', handlePointer);
            canvas.addEventListener('pointerdown', handlePointer);
            canvas.addEventListener('pointerleave', () => { tooltip.style.display = 'none'; });
        }
    }
    
    /**
     * Open RadiaCode track detail modal
     */
    function openRadiaCodeTrackModal(trackId) {
        if (typeof RadiaCodeModule === 'undefined') return;
        
        // Uses cached modalContainer ref
        if (!modalContainer) return;
        
        const track = RadiaCodeModule.getTrack(trackId);
        if (!track) return;
        
        const duration = track.stats.duration ? Math.round(track.stats.duration / 60000) : 0;
        
        modalContainer.innerHTML = `
            <div class="modal-backdrop" id="modal-backdrop" role="presentation">
                <div class="modal" role="dialog" aria-modal="true" style="max-width:450px;width:90%">
                    <div class="modal__header">
                        <h3 class="modal__title">‚ò¢Ô∏è ${track.name}</h3>
                        <button class="modal__close" id="modal-close" aria-label="Close dialog">&times;</button>
                    </div>
                    <div class="modal__body">
                        <!-- Track Stats -->
                        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:16px">
                            <div style="padding:12px;background:rgba(255,255,255,0.05);border-radius:8px;text-align:center">
                                <div style="font-size:20px;font-weight:700;color:#22c55e">${track.stats.avgDoseRate?.toFixed(2) || 0}</div>
                                <div style="font-size:10px;color:rgba(255,255,255,0.5)">Avg ŒºSv/h</div>
                            </div>
                            <div style="padding:12px;background:rgba(255,255,255,0.05);border-radius:8px;text-align:center">
                                <div style="font-size:20px;font-weight:700;color:${RadiaCodeModule.getDoseColor(track.stats.maxDoseRate || 0)}">${track.stats.maxDoseRate?.toFixed(2) || 0}</div>
                                <div style="font-size:10px;color:rgba(255,255,255,0.5)">Max ŒºSv/h</div>
                            </div>
                            <div style="padding:12px;background:rgba(255,255,255,0.05);border-radius:8px;text-align:center">
                                <div style="font-size:20px;font-weight:700">${track.stats.totalDose?.toFixed(3) || 0}</div>
                                <div style="font-size:10px;color:rgba(255,255,255,0.5)">Total ŒºSv</div>
                            </div>
                            <div style="padding:12px;background:rgba(255,255,255,0.05);border-radius:8px;text-align:center">
                                <div style="font-size:20px;font-weight:700">${duration}</div>
                                <div style="font-size:10px;color:rgba(255,255,255,0.5)">Minutes</div>
                            </div>
                        </div>
                        
                        <div style="font-size:12px;color:rgba(255,255,255,0.5);margin-bottom:16px">
                            ${track.points?.length || 0} data points ‚Ä¢ ${track.stats.distance?.toFixed(2) || 0} miles
                        </div>
                        
                        ${track.notes ? `
                            <div style="padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;margin-bottom:16px;font-size:12px;font-style:italic">
                                "${track.notes}"
                            </div>
                        ` : ''}
                    </div>
                    <div class="modal__footer">
                        <button class="btn btn--secondary" id="export-track-csv" style="font-size:12px">
                            üìã CSV
                        </button>
                        <button class="btn btn--secondary" id="export-track-gpx" style="font-size:12px">
                            üó∫Ô∏è GPX
                        </button>
                        <button class="btn btn--secondary" id="export-track-geojson" style="font-size:12px">
                            üì§ GeoJSON
                        </button>
                        <span style="flex:1"></span>
                        <button class="btn btn--danger" id="delete-track-btn" style="font-size:12px">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        const closeModal = () => { modalContainer.innerHTML = ''; };
        
        // Close handlers
        modalContainer.querySelector('#modal-close').onclick = closeModal;
        modalContainer.querySelector('#modal-backdrop').onclick = (e) => {
            if (e.target.id === 'modal-backdrop') closeModal();
        };
        
        // Export GeoJSON
        modalContainer.querySelector('#export-track-geojson').onclick = () => {
            const geojson = RadiaCodeModule.exportTrackGeoJSON(trackId);
            if (geojson) {
                const blob = new Blob([JSON.stringify(geojson, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `radiation-track-${trackId}.geojson`;
                a.click();
                URL.revokeObjectURL(url);
                if (typeof ModalsModule !== 'undefined') {
                    ModalsModule.showToast('Track exported', 'success');
                }
            }
        };
        
        // Export CSV
        modalContainer.querySelector('#export-track-csv').onclick = () => {
            const csv = RadiaCodeModule.exportTrackCSV(trackId);
            if (csv) {
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `radiation-track-${trackId}.csv`;
                a.click();
                URL.revokeObjectURL(url);
                if (typeof ModalsModule !== 'undefined') {
                    ModalsModule.showToast('CSV exported', 'success');
                }
            }
        };
        
        // Export GPX
        modalContainer.querySelector('#export-track-gpx').onclick = () => {
            const gpx = RadiaCodeModule.exportTrackGPX(trackId);
            if (gpx) {
                const blob = new Blob([gpx], { type: 'application/gpx+xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `radiation-track-${trackId}.gpx`;
                a.click();
                URL.revokeObjectURL(url);
                if (typeof ModalsModule !== 'undefined') {
                    ModalsModule.showToast('GPX exported', 'success');
                }
            }
        };
        
        // Delete track
        modalContainer.querySelector('#delete-track-btn').onclick = () => {
            if (confirm('Delete this radiation track?')) {
                RadiaCodeModule.deleteTrack(trackId);
                closeModal();
                renderTeam();
                if (typeof ModalsModule !== 'undefined') {
                    ModalsModule.showToast('Track deleted', 'info');
                }
            }
        };
    }

    /**
     * Render Team Management section
     */
    function renderTeamManagementSection(currentTeam, isInTeam, myMember, teamMembers, rallyPoints, ROLES, RALLY_TYPES) {
        if (!isInTeam) {
            // Not in a team - show create/join options
            return `
                <div style="margin-bottom:20px">
                    <div class="section-label" style="display:flex;align-items:center;gap:8px">
                        üë• Team Management
                        <span style="font-size:10px;color:rgba(255,255,255,0.3);font-weight:400">Coordinate with your group</span>
                    </div>
                    
                    <!-- No Team State -->
                    <div style="padding:20px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:12px;text-align:center">
                        <div style="font-size:32px;margin-bottom:12px">üë•</div>
                        <div style="font-size:14px;font-weight:500;margin-bottom:4px">No Active Team</div>
                        <div style="font-size:12px;color:rgba(255,255,255,0.5);margin-bottom:16px">
                            Create a team or join an existing one to coordinate with your group
                        </div>
                        
                        <div style="display:flex;gap:8px;justify-content:center">
                            <button class="btn btn--primary" id="team-create-btn">
                                ‚ûï Create Team
                            </button>
                            <button class="btn btn--secondary" id="team-join-btn">
                                üîó Join Team
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="divider"></div>
            `;
        }
        
        // In a team - show team info
        const myRole = ROLES[myMember?.role] || ROLES.support;
        const isLeader = myMember?.role === 'leader' || myMember?.role === 'coleader';
        
        return `
            <div style="margin-bottom:20px">
                <div class="section-label" style="display:flex;align-items:center;gap:8px">
                    üë• Team Management
                    <span style="font-size:10px;color:rgba(255,255,255,0.3);font-weight:400">${currentTeam.id}</span>
                </div>
                
                <!-- Team Info Card -->
                <div style="padding:14px;background:linear-gradient(135deg,rgba(249,115,22,0.1),rgba(234,88,12,0.05));border:1px solid rgba(249,115,22,0.2);border-radius:12px;margin-bottom:12px">
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
                        <div style="width:44px;height:44px;border-radius:10px;background:rgba(249,115,22,0.2);display:flex;align-items:center;justify-content:center;font-size:22px">
                            üë•
                        </div>
                        <div style="flex:1">
                            <div style="font-size:16px;font-weight:600">${escapeHtml(currentTeam.name)}</div>
                            <div style="font-size:11px;color:rgba(255,255,255,0.5)">
                                ${teamMembers.length} member${teamMembers.length !== 1 ? 's' : ''} ‚Ä¢ ${rallyPoints.length} rally point${rallyPoints.length !== 1 ? 's' : ''}
                            </div>
                        </div>
                        <div style="text-align:right">
                            <div style="font-size:12px;font-weight:500;color:${myRole.color}">${myRole.icon} ${myRole.name}</div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div style="display:flex;gap:8px">
                        ${isLeader ? `
                            <button class="btn btn--secondary" id="team-invite-btn" style="flex:1;font-size:11px;padding:8px">
                                üì§ Invite
                            </button>
                        ` : ''}
                        <button class="btn btn--secondary" id="team-settings-btn" style="flex:1;font-size:11px;padding:8px">
                            ‚öôÔ∏è Settings
                        </button>
                        <button class="btn btn--secondary" id="team-leave-btn" style="font-size:11px;padding:8px;color:#ef4444">
                            üö™ Leave
                        </button>
                    </div>
                </div>
                
                <!-- Team Health Summary -->
                <div style="display:flex;gap:8px;margin-bottom:12px">
                    ${(() => {
                        const health = typeof TeamModule !== 'undefined' ? TeamModule.getTeamHealth() : { active: 0, stale: 0, offline: 0 };
                        return `
                            <div style="flex:1;padding:8px;background:rgba(34,197,94,0.1);border-radius:8px;text-align:center">
                                <div style="font-size:16px;font-weight:600;color:#22c55e">${health.active}</div>
                                <div style="font-size:9px;color:rgba(255,255,255,0.4)">ACTIVE</div>
                            </div>
                            <div style="flex:1;padding:8px;background:rgba(245,158,11,0.1);border-radius:8px;text-align:center">
                                <div style="font-size:16px;font-weight:600;color:#f59e0b">${health.stale}</div>
                                <div style="font-size:9px;color:rgba(255,255,255,0.4)">STALE</div>
                            </div>
                            <div style="flex:1;padding:8px;background:rgba(107,114,128,0.1);border-radius:8px;text-align:center">
                                <div style="font-size:16px;font-weight:600;color:#6b7280">${health.offline}</div>
                                <div style="font-size:9px;color:rgba(255,255,255,0.4)">OFFLINE</div>
                            </div>
                        `;
                    })()}
                </div>
                
                <!-- Team Members with Distance/Bearing -->
                <div style="margin-bottom:12px">
                    <div style="font-size:11px;color:rgba(255,255,255,0.4);margin-bottom:8px;display:flex;justify-content:space-between">
                        <span>MEMBERS</span>
                        <span>${teamMembers.length}/${typeof TeamModule !== 'undefined' ? '20' : '?'}</span>
                    </div>
                    <div style="display:flex;flex-direction:column;gap:6px">
                        ${(() => {
                            // Get current GPS position if available
                            const gpsState = typeof GPSModule !== 'undefined' ? GPSModule.getState() : null;
                            const myPos = gpsState?.position ? { lat: gpsState.position.lat, lon: gpsState.position.lon } : null;
                            
                            return teamMembers.map(m => {
                                const role = ROLES[m.role] || ROLES.support;
                                const isMe = m.id === myMember?.id;
                                const statusColor = m.status === 'active' ? '#22c55e' : m.status === 'stale' ? '#f59e0b' : '#6b7280';
                                
                                // Get distance/bearing if we have GPS
                                let distInfo = null;
                                if (!isMe && myPos && typeof TeamModule !== 'undefined') {
                                    distInfo = TeamModule.getDistanceToMember(m.id, myPos);
                                }
                                
                                // Format last seen time
                                let lastSeenText = '';
                                if (m.lastSeen) {
                                    const elapsed = Date.now() - new Date(m.lastSeen).getTime();
                                    if (elapsed < 60000) lastSeenText = 'Now';
                                    else if (elapsed < 3600000) lastSeenText = Math.floor(elapsed / 60000) + 'm';
                                    else if (elapsed < 86400000) lastSeenText = Math.floor(elapsed / 3600000) + 'h';
                                    else lastSeenText = Math.floor(elapsed / 86400000) + 'd';
                                }
                                
                                return `
                                    <div style="padding:10px;background:${isMe ? 'rgba(249,115,22,0.1)' : 'rgba(255,255,255,0.03)'};border:1px solid ${isMe ? 'rgba(249,115,22,0.2)' : 'transparent'};border-radius:10px;cursor:pointer" 
                                         data-team-member="${m.id}">
                                        <div style="display:flex;align-items:center;gap:10px">
                                            <!-- Role Icon & Status -->
                                            <div style="position:relative">
                                                <div style="width:36px;height:36px;border-radius:8px;background:${role.color}22;display:flex;align-items:center;justify-content:center;font-size:18px">
                                                    ${role.icon}
                                                </div>
                                                <div style="position:absolute;bottom:-2px;right:-2px;width:10px;height:10px;border-radius:50%;background:${statusColor};border:2px solid #0f1419"></div>
                                            </div>
                                            
                                            <!-- Member Info -->
                                            <div style="flex:1;min-width:0">
                                                <div style="display:flex;align-items:center;gap:6px">
                                                    <span style="font-size:13px;font-weight:500">${escapeHtml(m.shortName || m.name)}</span>
                                                    ${isMe ? '<span style="font-size:9px;padding:2px 6px;background:rgba(249,115,22,0.2);border-radius:4px;color:#f97316">YOU</span>' : ''}
                                                </div>
                                                <div style="font-size:10px;color:${role.color}">${role.name}${lastSeenText ? ' ‚Ä¢ ' + lastSeenText + ' ago' : ''}</div>
                                            </div>
                                            
                                            <!-- Distance/Bearing (if available) -->
                                            ${!isMe && distInfo ? `
                                                <div style="text-align:right">
                                                    <div style="font-size:14px;font-weight:600;color:#3b82f6">${distInfo.formatted}</div>
                                                    <div style="font-size:10px;color:rgba(255,255,255,0.5)">
                                                        ${distInfo.compass} (${Math.round(distInfo.bearing)}¬∞)
                                                    </div>
                                                </div>
                                            ` : !isMe && m.lat && m.lon ? `
                                                <div style="text-align:right">
                                                    <div style="font-size:10px;color:rgba(255,255,255,0.4)">üìç Has position</div>
                                                </div>
                                            ` : !isMe ? `
                                                <div style="text-align:right">
                                                    <div style="font-size:10px;color:rgba(255,255,255,0.3)">No position</div>
                                                </div>
                                            ` : ''}
                                            
                                            <!-- Go To Button -->
                                            ${!isMe && m.lat && m.lon ? `
                                                <button class="btn btn--secondary" data-goto-team="${m.id}" data-goto-lat="${m.lat}" data-goto-lon="${m.lon}" data-goto-name="${Helpers.escapeHtml(m.name)}" style="padding:6px 10px;font-size:11px" title="Go to location" aria-label="Go to ${Helpers.escapeHtml(m.name)} on map">
                                                    üéØ
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('');
                        })()}
                    </div>
                </div>
                
                <!-- Rally Points -->
                <div style="margin-bottom:12px">
                    <div style="font-size:11px;color:rgba(255,255,255,0.4);margin-bottom:8px;display:flex;justify-content:space-between;align-items:center">
                        <span>RALLY POINTS</span>
                        <button class="btn btn--secondary" id="team-add-rally-btn" style="padding:2px 8px;font-size:10px">+ Add</button>
                    </div>
                    ${rallyPoints.length === 0 ? `
                        <div style="padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;font-size:11px;color:rgba(255,255,255,0.4);text-align:center">
                            No rally points defined. Add one for emergency meetup locations.
                        </div>
                    ` : `
                        <div style="display:flex;flex-direction:column;gap:6px">
                            ${(() => {
                                const gpsState = typeof GPSModule !== 'undefined' ? GPSModule.getState() : null;
                                const myPos = gpsState?.position ? { lat: gpsState.position.lat, lon: gpsState.position.lon } : null;
                                
                                return rallyPoints.map(rp => {
                                    const rpType = RALLY_TYPES[rp.type] || RALLY_TYPES.primary;
                                    
                                    // Get distance/bearing if we have GPS
                                    let distInfo = null;
                                    if (myPos && typeof TeamModule !== 'undefined') {
                                        distInfo = TeamModule.getDistanceToRally(rp.id, myPos);
                                    }
                                    
                                    return `
                                        <div style="padding:10px;background:rgba(255,255,255,0.03);border:1px solid ${rpType.color}33;border-radius:10px;display:flex;align-items:center;gap:10px" data-rally-id="${rp.id}">
                                            <div style="width:36px;height:36px;border-radius:8px;background:${rpType.color}22;display:flex;align-items:center;justify-content:center;font-size:18px">
                                                ${rpType.icon}
                                            </div>
                                            <div style="flex:1;min-width:0">
                                                <div style="font-size:12px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escapeHtml(rp.name)}</div>
                                                <div style="font-size:10px;color:${rpType.color}">${rpType.name}${rp.schedule ? ' ‚Ä¢ ' + rp.schedule : ''}</div>
                                            </div>
                                            ${distInfo ? `
                                                <div style="text-align:right">
                                                    <div style="font-size:13px;font-weight:600;color:${rpType.color}">${distInfo.formatted}</div>
                                                    <div style="font-size:9px;color:rgba(255,255,255,0.5)">${distInfo.compass} (${Math.round(distInfo.bearing)}¬∞)</div>
                                                </div>
                                            ` : ''}
                                            <button class="btn btn--secondary" data-goto-rally="${rp.id}" style="padding:6px 10px;font-size:11px">üéØ</button>
                                        </div>
                                    `;
                                }).join('');
                            })()}
                        </div>
                    `}
                </div>
                
                <!-- Comm Plan Summary -->
                ${currentTeam.commPlan ? `
                    <div style="padding:12px;background:rgba(139,92,246,0.1);border:1px solid rgba(139,92,246,0.2);border-radius:10px">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                            <div style="font-size:10px;color:rgba(255,255,255,0.4)">COMM PLAN</div>
                            ${isLeader ? `<button class="btn btn--secondary" id="team-edit-commplan-btn" style="padding:2px 8px;font-size:9px">Edit</button>` : ''}
                        </div>
                        
                        <!-- Frequencies & Emergency Word -->
                        <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px">
                            ${currentTeam.commPlan.primaryFreq ? `
                                <div style="padding:4px 8px;background:rgba(255,255,255,0.05);border-radius:6px;font-size:11px">
                                    üìª ${currentTeam.commPlan.primaryFreq}
                                </div>
                            ` : ''}
                            ${currentTeam.commPlan.emergencyWord ? `
                                <div style="padding:4px 8px;background:rgba(239,68,68,0.15);border-radius:6px;font-size:11px;color:#ef4444">
                                    üÜò "${currentTeam.commPlan.emergencyWord}"
                                </div>
                            ` : ''}
                            ${currentTeam.meshChannel ? `
                                <div style="padding:4px 8px;background:rgba(255,255,255,0.05);border-radius:6px;font-size:11px">
                                    üì° Ch ${currentTeam.meshChannel}
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- Next Check-In -->
                        ${(() => {
                            const nextCheckIn = typeof TeamModule !== 'undefined' ? TeamModule.getNextCheckIn() : null;
                            if (nextCheckIn) {
                                return `
                                    <div style="padding:8px;background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.2);border-radius:6px;display:flex;align-items:center;gap:8px">
                                        <span style="font-size:16px">‚è∞</span>
                                        <div style="flex:1">
                                            <div style="font-size:11px;font-weight:500;color:#22c55e">Next Check-In</div>
                                            <div style="font-size:10px;color:rgba(255,255,255,0.5)">${nextCheckIn.formatted}</div>
                                        </div>
                                    </div>
                                `;
                            } else if (currentTeam.commPlan.checkInTimes && currentTeam.commPlan.checkInTimes.length > 0) {
                                return `
                                    <div style="font-size:10px;color:rgba(255,255,255,0.4)">
                                        ${currentTeam.commPlan.checkInTimes.length} scheduled check-in${currentTeam.commPlan.checkInTimes.length !== 1 ? 's' : ''}
                                    </div>
                                `;
                            }
                            return '';
                        })()}
                    </div>
                ` : ''}
            </div>
            
            <div class="divider"></div>
        `;
    }

    function renderTeam() {
        _saveScroll(); _restoreScroll();
        const team = State.get('teamMembers');
        const waypoints = State.get('waypoints') || [];
        const routes = State.get('routes') || [];
        
        // Get Team state
        const hasTeamModule = typeof TeamModule !== 'undefined';
        const currentTeam = hasTeamModule ? TeamModule.getCurrentTeam() : null;
        const isInTeam = hasTeamModule && TeamModule.isInTeam();
        const myMember = isInTeam ? TeamModule.getMyMember() : null;
        const teamMembers = isInTeam ? TeamModule.getMembers() : [];
        const rallyPoints = isInTeam ? TeamModule.getRallyPoints() : [];
        const ROLES = hasTeamModule ? TeamModule.ROLES : {};
        const RALLY_TYPES = hasTeamModule ? TeamModule.RALLY_TYPES : {};
        
        // Get Meshtastic connection state
        const meshState = typeof MeshtasticModule !== 'undefined' 
            ? MeshtasticModule.getConnectionState() 
            : { state: 'disconnected', type: null };
        const isConnected = meshState.state === 'connected';
        const isConnecting = meshState.state === 'connecting';
        
        // Check API support
        const apiSupport = typeof MeshtasticModule !== 'undefined' 
            ? MeshtasticModule.checkApiSupport() 
            : { bluetooth: false, serial: false };
        const hasApiSupport = apiSupport.bluetooth || apiSupport.serial;
        
        // Get messages
        const messages = typeof MeshtasticModule !== 'undefined' 
            ? MeshtasticModule.getMessages().slice(-10) 
            : [];
        
        // Phase 1.5: Get queue status
        const queueStatus = typeof MeshtasticModule !== 'undefined' 
            ? MeshtasticModule.getQueueStatus() 
            : { count: 0, isEmpty: true, meshStatus: 'unknown' };
        
        container.innerHTML = `
            <div class="panel__header"><h2 class="panel__title">Team & Mesh</h2></div>
            
            <!-- ========== TEAM MANAGEMENT SECTION ========== -->
            ${renderTeamManagementSection(currentTeam, isInTeam, myMember, teamMembers, rallyPoints, ROLES, RALLY_TYPES)}
            
            <!-- Meshtastic Connection Section -->
            <div style="margin-bottom:20px">
                <div class="section-label" style="display:flex;align-items:center;gap:8px">
                    üì° Meshtastic Connection
                    <span style="font-size:10px;color:rgba(255,255,255,0.3);font-weight:400">Off-grid mesh network</span>
                </div>
                
                <!-- Connection Status Card -->
                <div style="padding:14px;background:${isConnected ? 'rgba(34,197,94,0.1)' : 'rgba(255,255,255,0.03)'};border:1px solid ${isConnected ? 'rgba(34,197,94,0.3)' : 'rgba(255,255,255,0.1)'};border-radius:12px;margin-bottom:12px">
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:${isConnected ? '12px' : '0'}">
                        <div style="width:40px;height:40px;border-radius:10px;background:${isConnected ? 'rgba(34,197,94,0.2)' : 'rgba(255,255,255,0.05)'};display:flex;align-items:center;justify-content:center">
                            <span style="font-size:20px">${isConnected ? 'üì°' : isConnecting ? '‚è≥' : 'üì¥'}</span>
                        </div>
                        <div style="flex:1">
                            <div style="font-size:14px;font-weight:600;color:${isConnected ? '#22c55e' : 'inherit'}">
                                ${isConnected ? 'Connected' : isConnecting ? 'Connecting...' : 'Not Connected'}
                            </div>
                            <div style="font-size:11px;color:rgba(255,255,255,0.5)">
                                ${isConnected 
                                    ? `via ${meshState.type === 'bluetooth' ? 'Bluetooth' : 'Serial'} ‚Ä¢ ${meshState.nodeName || 'Unknown'}` 
                                    : hasApiSupport 
                                        ? 'Click Connect to pair your Meshtastic device' 
                                        : 'Web Bluetooth/Serial not supported in this browser'}
                            </div>
                        </div>
                    </div>
                    
                    ${isConnected ? `
                        <div style="display:flex;gap:8px;margin-bottom:8px">
                            <button class="btn btn--secondary" id="mesh-broadcast-btn" style="flex:1;font-size:12px;padding:8px">
                                üìç Broadcast Position
                            </button>
                            <button class="btn btn--secondary" id="mesh-config-btn" style="font-size:12px;padding:8px">
                                ‚öôÔ∏è Config
                            </button>
                            <button class="btn btn--secondary" id="mesh-disconnect-btn" style="font-size:12px;padding:8px;color:#ef4444">
                                Disconnect
                            </button>
                        </div>
                        <div style="display:flex;gap:8px">
                            <button class="btn btn--secondary" id="mesh-export-btn" style="flex:1;font-size:11px;padding:6px">
                                üìä Export Telemetry
                            </button>
                        </div>
                    ` : ''}
                </div>
                
                    ${!isConnected && !isConnecting ? `
                    <!-- Device Selection Help -->
                    ${renderDeviceConnectionHelp(apiSupport)}
                    
                    ${!hasApiSupport ? `
                        <div style="padding:10px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.2);border-radius:8px;font-size:12px;color:#ef4444;margin-bottom:12px">
                            ‚ö†Ô∏è Web Bluetooth/Serial requires Chrome or Edge browser
                        </div>
                    ` : ''}
                    
                    <!-- User Settings -->
                    <div style="padding:12px;background:rgba(255,255,255,0.03);border-radius:10px;margin-bottom:12px">
                        <div style="font-size:11px;color:rgba(255,255,255,0.4);margin-bottom:8px">YOUR NODE IDENTITY</div>
                        <div style="display:flex;gap:8px">
                            <input type="text" id="mesh-longname" placeholder="Your Name" value="${meshState.nodeName || 'GridDown User'}" style="flex:2;padding:8px;font-size:12px">
                            <input type="text" id="mesh-shortname" placeholder="ID" maxlength="4" value="${meshState.shortName || 'GDU'}" style="flex:1;padding:8px;font-size:12px;text-transform:uppercase">
                        </div>
                    </div>
                    
                    <!-- Phase 2: Scenario Selector -->
                    ${renderScenarioSelector()}
                    
                    <!-- Channel URL Import -->
                    <div style="padding:12px;background:rgba(255,255,255,0.03);border-radius:10px;margin-bottom:12px">
                        <div style="font-size:11px;color:rgba(255,255,255,0.4);margin-bottom:8px">IMPORT CHANNEL / JOIN TEAM</div>
                        <div style="display:flex;gap:8px;margin-bottom:8px">
                            <input type="text" id="mesh-channel-url" placeholder="meshtastic://... or paste URL" style="flex:1;padding:8px;font-size:11px">
                            <button class="btn btn--secondary" id="mesh-import-channel-btn" style="padding:8px 12px;font-size:11px">
                                üì• Import
                            </button>
                        </div>
                        <div style="display:flex;gap:8px">
                            <button class="btn btn--secondary" id="mesh-scan-qr-btn" style="flex:1;font-size:11px;padding:8px">
                                üì∑ Scan QR
                            </button>
                            <button class="btn btn--secondary" id="mesh-show-team-qr-btn" style="flex:1;font-size:11px;padding:8px">
                                üì± Share Team QR
                            </button>
                        </div>
                    </div>
                ` : ''}
                
                <!-- Phase 2: Mesh Health Widget (when connected) -->
                ${isConnected ? renderMeshHealthWidget() : ''}
                
                <!-- Traceroute Widget (when active) -->
                ${isConnected ? renderTracerouteWidget() : ''}
                
                <!-- Device Info (when connected) -->
                ${isConnected ? renderConnectedDeviceInfo() : ''}
            </div>
            
            <div class="divider"></div>
            
            <!-- My Position Section -->
            ${renderPositionSection()}
            
            <div class="divider"></div>
            
            <!-- APRS Section -->
            ${renderAPRSSection()}
            
            <div class="divider"></div>
            
            <!-- CoT Bridge Section -->
            ${renderTAKSection()}
            
            <div class="divider"></div>
            
            <!-- RadiaCode Section -->
            ${renderRadiaCodeSection()}
            
            <div class="divider"></div>
            
            <!-- Team Positions Section -->
            <div class="section-label" style="display:flex;justify-content:space-between;align-items:center">
                <span>Team Positions (${team.length + getAPRSStationCount()})</span>
                ${isConnected ? '<span style="font-size:10px;color:#22c55e">‚óè LIVE</span>' : ''}
            </div>
            
            <div style="max-height:200px;overflow-y:auto;margin-bottom:16px">
                ${team.length === 0 ? `
                    <div style="padding:20px;text-align:center;color:rgba(255,255,255,0.4);font-size:12px">
                        ${isConnected ? 'Waiting for team positions...' : 'Connect to Meshtastic to see team'}
                    </div>
                ` : team.map(m => {
                    // Get signal quality info if available
                    const signalColor = m.signalQuality ? getMeshSignalColor(m.signalQuality) : '#6b7280';
                    const signalText = m.snr !== undefined || m.rssi !== undefined 
                        ? `${m.snr !== undefined ? `SNR: ${m.snr.toFixed(1)}dB` : ''}${m.snr !== undefined && m.rssi !== undefined ? ' ‚Ä¢ ' : ''}${m.rssi !== undefined ? `RSSI: ${m.rssi}dBm` : ''}`
                        : '';
                    return `
                    <div class="card team-card ${m.status === 'active' ? 'team-card--active' : ''}" style="margin-bottom:8px;padding:10px" data-team-id="${m.id}">
                        <div style="display:flex;align-items:center;gap:10px">
                            <div style="width:36px;height:36px;border-radius:50%;background:${m.isMe ? 'rgba(249,115,22,0.2)' : 'rgba(255,255,255,0.05)'};display:flex;align-items:center;justify-content:center;position:relative">
                                <span style="font-size:16px">${m.isMe ? 'üìç' : 'üë§'}</span>
                                <div style="position:absolute;bottom:-2px;right:-2px;width:10px;height:10px;border-radius:50%;background:${m.status === 'active' ? '#22c55e' : m.status === 'stale' ? '#f59e0b' : '#6b7280'};border:2px solid var(--color-bg-secondary)"></div>
                            </div>
                            <div style="flex:1;min-width:0">
                                <div style="display:flex;align-items:center;gap:6px">
                                    <span style="font-size:13px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">
                                        ${m.name}${m.isMe ? ' (You)' : ''}
                                    </span>
                                    ${!m.isMe && signalText ? `
                                        <span style="font-size:9px;padding:2px 5px;background:${signalColor}22;color:${signalColor};border-radius:4px;white-space:nowrap" title="${signalText}">
                                            üì∂ ${m.signalQuality || 'N/A'}
                                        </span>
                                    ` : ''}
                                </div>
                                <div style="font-size:10px;color:rgba(255,255,255,0.4)">
                                    ${m.lastUpdate}${m.lat && m.lon ? ` ‚Ä¢ ${m.lat.toFixed(4)}¬∞, ${m.lon.toFixed(4)}¬∞` : ''}
                                </div>
                                ${!m.isMe && signalText ? `
                                    <div style="font-size:9px;color:rgba(255,255,255,0.35);margin-top:2px">${signalText}</div>
                                ` : ''}
                            </div>
                            <div style="display:flex;gap:4px">
                                ${!m.isMe && isConnected ? `
                                    <button class="btn btn--secondary traceroute-btn" data-traceroute-node="${m.id}" data-node-name="${escapeHtml(m.name)}" style="padding:6px 8px;font-size:10px" title="Trace route to ${m.name}">
                                        üîç
                                    </button>
                                ` : ''}
                                ${!m.isMe && m.lat && m.lon ? `
                                    <button class="btn btn--secondary" data-goto-team="${m.id}" data-goto-lat="${m.lat}" data-goto-lon="${m.lon}" data-goto-name="${escapeHtml(m.name)}" style="padding:6px 8px;font-size:10px" title="Go to location" aria-label="Go to ${escapeHtml(m.name)} on map">
                                        üéØ
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `}).join('')}
            </div>
            
            <!-- Quick Actions -->
            <div style="display:flex;gap:8px;margin-bottom:16px">
                <button class="btn ${isConnected ? 'btn--success' : 'btn--secondary'}" id="send-checkin-btn" style="flex:1" ${!isConnected ? 'disabled' : ''}>
                    ‚úì Check-In OK
                </button>
                <button class="btn btn--secondary" id="send-checkin-help-btn" style="flex:1;color:#f59e0b" ${!isConnected ? 'disabled' : ''}>
                    ‚ö†Ô∏è Need Help
                </button>
            </div>
            
            <div class="divider"></div>
            
            <!-- Mesh Messaging Section -->
            <div class="section-label" style="display:flex;justify-content:space-between;align-items:center">
                <span>üí¨ Mesh Messages</span>
                <div style="display:flex;gap:8px;align-items:center">
                    ${queueStatus.count > 0 ? `
                        <span style="font-size:10px;color:#f59e0b;background:rgba(245,158,11,0.2);padding:2px 6px;border-radius:4px" title="Messages waiting to send">
                            üïê ${queueStatus.count} queued
                        </span>
                    ` : ''}
                    ${messages.length > 0 ? `<span style="font-size:10px;color:rgba(255,255,255,0.4)">${messages.length} messages</span>` : ''}
                </div>
            </div>
            
            <!-- Queue Status Banner (if messages queued) -->
            ${queueStatus.count > 0 ? `
                <div style="padding:10px;margin-bottom:8px;background:rgba(245,158,11,0.15);border:1px solid rgba(245,158,11,0.3);border-radius:8px">
                    <div style="display:flex;align-items:center;justify-content:space-between">
                        <div style="display:flex;align-items:center;gap:8px">
                            <span style="font-size:16px">üïê</span>
                            <div>
                                <div style="font-size:12px;font-weight:600;color:#f59e0b">${queueStatus.count} Message${queueStatus.count > 1 ? 's' : ''} Queued</div>
                                <div style="font-size:10px;color:rgba(255,255,255,0.5)">
                                    ${queueStatus.meshStatus === 'disconnected' 
                                        ? 'Will send when connected' 
                                        : 'Sending when mesh available...'}
                                </div>
                            </div>
                        </div>
                        <button class="btn btn--secondary" id="clear-queue-btn" style="padding:4px 10px;font-size:10px" title="Clear all queued messages">
                            Clear
                        </button>
                    </div>
                </div>
            ` : ''}
            
            <div id="mesh-messages-container" style="max-height:150px;overflow-y:auto;margin-bottom:12px;background:rgba(0,0,0,0.2);border-radius:8px;padding:8px">
                ${messages.length === 0 ? `
                    <div style="padding:16px;text-align:center;color:rgba(255,255,255,0.3);font-size:11px">
                        ${isConnected ? 'No messages yet' : 'Connect to send/receive messages'}
                    </div>
                ` : messages.map(msg => {
                    const status = MeshtasticModule.getMessageStatus(msg.id);
                    const statusIcon = getMessageStatusIcon(status);
                    const statusColor = getMessageStatusColor(status);
                    return `
                    <div style="padding:6px 8px;margin-bottom:4px;background:${msg.isSent ? 'rgba(249,115,22,0.15)' : 'rgba(255,255,255,0.05)'};border-radius:6px;${msg.isSent ? 'margin-left:20px' : 'margin-right:20px'}">
                        <div style="font-size:10px;color:rgba(255,255,255,0.4);margin-bottom:2px;display:flex;justify-content:space-between;align-items:center">
                            <span>${msg.isSent ? 'You' : msg.fromName || 'Unknown'} ‚Ä¢ ${formatMeshTime(msg.timestamp)}</span>
                            ${msg.isSent ? `<span style="color:${statusColor};font-size:9px" title="${status}">${statusIcon}</span>` : ''}
                        </div>
                        <div style="font-size:12px;word-break:break-word">${escapeHtml(msg.text)}</div>
                    </div>
                `}).join('')}
            </div>
            
            <div style="display:flex;gap:8px;margin-bottom:8px">
                <input type="text" id="mesh-message-input" placeholder="${isConnected ? 'Type a message...' : 'Type to queue message...'}" 
                    style="flex:1;padding:10px;font-size:12px">
                <button class="btn ${isConnected ? 'btn--primary' : 'btn--secondary'}" id="mesh-send-btn" style="padding:10px 16px" title="${isConnected ? 'Send now' : 'Queue for later'}">
                    ${isConnected ? 'üì§' : 'üïê'}
                </button>
            </div>
            
            <!-- Phase 2: Canned Messages Bar -->
            ${renderCannedMessagesBar()}
            
            <div class="divider"></div>
            
            <!-- Share via Mesh Section -->
            <div class="section-label">üì§ Share via Mesh</div>
            <div style="display:flex;gap:8px;margin-bottom:16px">
                <button class="btn btn--secondary" id="mesh-share-waypoint-btn" style="flex:1;font-size:12px" ${!isConnected || waypoints.length === 0 ? 'disabled' : ''}>
                    üìç Share Waypoint
                </button>
                <button class="btn btn--secondary" id="mesh-share-route-btn" style="flex:1;font-size:12px" ${!isConnected || routes.length === 0 ? 'disabled' : ''}>
                    üõ§Ô∏è Share Route
                </button>
            </div>
            
            <div class="divider"></div>
            
            <!-- Plan Sharing Section (File-based) -->
            <div class="section-label" style="display:flex;align-items:center;gap:8px">
                üì¶ Plan Sharing
                <span style="font-size:10px;color:rgba(255,255,255,0.3);font-weight:400">Encrypted file transfer</span>
            </div>
            
            <!-- Current Plan Stats -->
            <div style="padding:12px;background:rgba(139,92,246,0.1);border:1px solid rgba(139,92,246,0.2);border-radius:10px;margin-bottom:12px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                    <span style="font-size:12px;color:rgba(255,255,255,0.6)">Current Plan</span>
                    <span style="font-size:10px;color:rgba(255,255,255,0.3)">${new Date().toLocaleDateString()}</span>
                </div>
                <div style="display:flex;gap:16px">
                    <div style="text-align:center">
                        <div style="font-size:18px;font-weight:600;color:#8b5cf6">${waypoints.length}</div>
                        <div style="font-size:10px;color:rgba(255,255,255,0.4)">Waypoints</div>
                    </div>
                    <div style="text-align:center">
                        <div style="font-size:18px;font-weight:600;color:#8b5cf6">${routes.length}</div>
                        <div style="font-size:10px;color:rgba(255,255,255,0.4)">Routes</div>
                    </div>
                </div>
            </div>
            
            <!-- Export Button -->
            <button class="btn btn--primary btn--full" id="export-plan-btn" style="margin-bottom:8px">
                ${Icons.get('export')} Export Plan Package
            </button>
            
            <!-- Import Button -->
            <label class="btn btn--secondary btn--full" style="cursor:pointer;margin-bottom:8px">
                ${Icons.get('download')} Import Plan Package
                <input type="file" id="import-plan-input" accept=".gdplan,.json" style="display:none">
            </label>
            
            <!-- Quick Actions -->
            <div style="display:flex;gap:8px">
                <button class="btn btn--secondary" id="export-gpx-btn" style="flex:1;font-size:12px;padding:10px">
                    GPX
                </button>
                <button class="btn btn--secondary" id="export-unencrypted-btn" style="flex:1;font-size:12px;padding:10px">
                    JSON
                </button>
                <button class="btn btn--secondary" id="copy-summary-btn" style="flex:1;font-size:12px;padding:10px">
                    üìã Summary
                </button>
            </div>
        `;
        
        // === TEAM MANAGEMENT EVENT HANDLERS ===
        
        // Create Team button
        const createTeamBtn = container.querySelector('#team-create-btn');
        if (createTeamBtn) {
            createTeamBtn.onclick = () => openCreateTeamModal();
        }
        
        // Join Team button
        const joinTeamBtn = container.querySelector('#team-join-btn');
        if (joinTeamBtn) {
            joinTeamBtn.onclick = () => openJoinTeamModal();
        }
        
        // Invite to Team button
        const inviteBtn = container.querySelector('#team-invite-btn');
        if (inviteBtn) {
            inviteBtn.onclick = () => openTeamInviteModal();
        }
        
        // Team Settings button
        const teamSettingsBtn = container.querySelector('#team-settings-btn');
        if (teamSettingsBtn) {
            teamSettingsBtn.onclick = () => openTeamSettingsModal();
        }
        
        // Comm Plan Edit button
        const commPlanEditBtn = container.querySelector('#team-edit-commplan-btn');
        if (commPlanEditBtn) {
            commPlanEditBtn.onclick = () => openCommPlanModal();
        }
        
        // Leave Team button
        const leaveTeamBtn = container.querySelector('#team-leave-btn');
        if (leaveTeamBtn) {
            leaveTeamBtn.onclick = () => {
                if (confirm('Are you sure you want to leave this team?')) {
                    try {
                        TeamModule.leaveTeam();
                        ModalsModule.showToast('Left the team', 'success');
                        renderTeam();
                    } catch (err) {
                        ModalsModule.showToast('Error: ' + err.message, 'error');
                    }
                }
            };
        }
        
        // Add Rally Point button
        const addRallyBtn = container.querySelector('#team-add-rally-btn');
        if (addRallyBtn) {
            addRallyBtn.onclick = () => openAddRallyPointModal();
        }
        
        // Go to Rally Point buttons
        container.querySelectorAll('[data-goto-rally]').forEach(btn => {
            btn.onclick = (e) => {
                e.stopPropagation();
                const rallyPoints = TeamModule.getRallyPoints();
                const rp = rallyPoints.find(r => r.id === btn.dataset.gotoRally);
                if (rp && rp.lat && rp.lon && typeof MapModule !== 'undefined') {
                    MapModule.setCenter(rp.lat, rp.lon, 15);
                    ModalsModule.showToast(`Centered on ${rp.name}`, 'info');
                }
            };
        });
        
        // Team member click (for details)
        container.querySelectorAll('[data-team-member]').forEach(el => {
            el.onclick = (e) => {
                // Don't trigger if clicking on the goto button
                if (e.target.closest('[data-goto-team]')) return;
                
                const members = TeamModule.getMembers();
                const member = members.find(m => m.id === el.dataset.teamMember);
                if (member) {
                    openTeamMemberDetailModal(member);
                }
            };
        });
        
        // === MESHTASTIC EVENT HANDLERS ===
        
        // Device type selection buttons
        const deviceTypeButtons = container.querySelectorAll('.device-type-btn');
        const helpMessage = container.querySelector('#device-help-message');
        const helpIcon = container.querySelector('#device-help-icon');
        const helpText = container.querySelector('#device-help-text');
        const serialBtn = container.querySelector('#mesh-connect-serial-btn');
        
        deviceTypeButtons.forEach(btn => {
            btn.onclick = () => {
                // Update selected state
                deviceTypeButtons.forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                
                const supportsSerial = btn.dataset.serial === 'true';
                const supportsBle = btn.dataset.ble === 'true';
                const deviceName = btn.textContent.trim();
                
                // Update Serial button state
                if (serialBtn) {
                    if (!supportsSerial) {
                        serialBtn.disabled = true;
                        serialBtn.title = `${deviceName} does not support Serial/USB connection`;
                        serialBtn.style.opacity = '0.5';
                    } else {
                        // Only enable if browser supports it
                        const apiSupport = typeof MeshtasticModule !== 'undefined' 
                            ? MeshtasticModule.checkApiSupport() 
                            : { serial: false };
                        serialBtn.disabled = !apiSupport.serial;
                        serialBtn.title = apiSupport.serial ? 'Connect via Serial/USB' : 'Web Serial not supported in this browser';
                        serialBtn.style.opacity = apiSupport.serial ? '1' : '0.5';
                    }
                }
                
                // Show help message
                if (helpMessage && helpText) {
                    if (!supportsSerial) {
                        helpMessage.style.display = 'block';
                        helpMessage.style.background = 'rgba(245,158,11,0.1)';
                        helpMessage.style.borderColor = 'rgba(245,158,11,0.3)';
                        helpIcon.textContent = '‚ö†Ô∏è';
                        helpIcon.parentElement.style.color = '#f59e0b';
                        helpText.innerHTML = `<strong>${Helpers.escapeHtml(deviceName)}</strong> only supports Bluetooth. The USB port is for charging only.`;
                    } else if (supportsBle && supportsSerial) {
                        helpMessage.style.display = 'block';
                        helpMessage.style.background = 'rgba(59,130,246,0.1)';
                        helpMessage.style.borderColor = 'rgba(59,130,246,0.2)';
                        helpIcon.textContent = '‚ÑπÔ∏è';
                        helpIcon.parentElement.style.color = '#3b82f6';
                        helpText.innerHTML = `<strong>${Helpers.escapeHtml(deviceName)}</strong> supports both Bluetooth and Serial/USB connections.`;
                    } else {
                        helpMessage.style.display = 'none';
                    }
                }
            };
        });
        
        // Bluetooth connect
        const connectBleBtn = container.querySelector('#mesh-connect-ble-btn');
        if (connectBleBtn) {
            connectBleBtn.onclick = async () => {
                try {
                    // Save user name first
                    const longName = container.querySelector('#mesh-longname')?.value || 'GridDown User';
                    const shortName = container.querySelector('#mesh-shortname')?.value || 'GDU';
                    MeshtasticModule.setUserName(longName, shortName);
                    
                    await MeshtasticModule.connectBluetooth();
                    ModalsModule.showToast('Connected to Meshtastic via Bluetooth', 'success');
                    renderTeam();
                } catch (err) {
                    ModalsModule.showToast('Connection failed: ' + err.message, 'error');
                    renderTeam();
                }
            };
        }
        
        // Serial connect
        const connectSerialBtn = container.querySelector('#mesh-connect-serial-btn');
        if (connectSerialBtn) {
            connectSerialBtn.onclick = async () => {
                // Check if a BLE-only device is selected
                const selectedDevice = container.querySelector('.device-type-btn.selected');
                if (selectedDevice && selectedDevice.dataset.serial === 'false') {
                    const deviceName = selectedDevice.textContent.trim();
                    ModalsModule.showToast(`${deviceName} doesn't support Serial - use Bluetooth`, 'warning');
                    return;
                }
                
                try {
                    const longName = container.querySelector('#mesh-longname')?.value || 'GridDown User';
                    const shortName = container.querySelector('#mesh-shortname')?.value || 'GDU';
                    MeshtasticModule.setUserName(longName, shortName);
                    
                    await MeshtasticModule.connectSerial();
                    ModalsModule.showToast('Connected to Meshtastic via Serial', 'success');
                    renderTeam();
                } catch (err) {
                    ModalsModule.showToast('Connection failed: ' + err.message, 'error');
                    renderTeam();
                }
            };
        }
        
        // New Device Setup
        const deviceSetupBtn = container.querySelector('#mesh-device-setup-btn');
        if (deviceSetupBtn) {
            deviceSetupBtn.onclick = () => openDeviceSetupModal();
        }
        
        // Disconnect
        const disconnectBtn = container.querySelector('#mesh-disconnect-btn');
        if (disconnectBtn) {
            disconnectBtn.onclick = async () => {
                try {
                    await MeshtasticModule.disconnect();
                    ModalsModule.showToast('Disconnected from Meshtastic', 'info');
                } catch (err) {
                    ModalsModule.showToast('Disconnect error: ' + err.message, 'error');
                }
                renderTeam();
            };
        }
        
        // Broadcast position
        const broadcastBtn = container.querySelector('#mesh-broadcast-btn');
        if (broadcastBtn) {
            broadcastBtn.onclick = async () => {
                try {
                    await MeshtasticModule.broadcastPosition();
                    ModalsModule.showToast('Position broadcast sent', 'success');
                } catch (err) {
                    ModalsModule.showToast('Broadcast failed: ' + err.message, 'error');
                }
            };
        }
        
        // Device Config button (Phase 1)
        const configBtn = container.querySelector('#mesh-config-btn');
        if (configBtn) {
            configBtn.onclick = () => {
                openMeshConfigModal();
            };
        }
        
        // Telemetry Export button
        const exportBtn = container.querySelector('#mesh-export-btn');
        if (exportBtn) {
            exportBtn.onclick = () => {
                openTelemetryExportModal();
            };
        }
        
        // CoT Bridge Setup Wizard button
        const cotSetupWizardBtn = container.querySelector('#cot-setup-wizard-btn');
        if (cotSetupWizardBtn) {
            cotSetupWizardBtn.onclick = () => {
                if (typeof TAKModule !== 'undefined' && TAKModule.openSetupWizard) {
                    TAKModule.openSetupWizard();
                }
            };
        }
        
        // CoT Bridge Connect button
        const takConnectBtn = container.querySelector('#tak-connect-btn');
        const takUrlInput = container.querySelector('#tak-bridge-url');
        if (takConnectBtn && takUrlInput) {
            takConnectBtn.onclick = () => {
                const url = takUrlInput.value.trim();
                if (!url) {
                    ModalsModule.showToast('Please enter a bridge URL', 'error');
                    return;
                }
                if (!url.startsWith('ws://') && !url.startsWith('wss://')) {
                    ModalsModule.showToast('URL must start with ws:// or wss://', 'error');
                    return;
                }
                TAKModule.connect(url);
                renderTeam();
            };
        }
        
        // CoT Bridge Disconnect button
        const takDisconnectBtn = container.querySelector('#tak-disconnect-btn');
        if (takDisconnectBtn) {
            takDisconnectBtn.onclick = () => {
                TAKModule.disconnect();
                renderTeam();
            };
        }
        
        // CoT Sharing - Consent checkbox
        const cotConsentCheckbox = container.querySelector('#cot-share-consent');
        if (cotConsentCheckbox) {
            cotConsentCheckbox.onchange = () => {
                if (cotConsentCheckbox.checked) {
                    TAKModule.setShareConsent(true);
                    renderTeam();
                }
            };
        }
        
        // CoT Sharing - Start sharing
        const cotStartSharing = container.querySelector('#cot-start-sharing');
        if (cotStartSharing) {
            cotStartSharing.onclick = () => {
                // Save callsign and team first
                const callsignInput = container.querySelector('#cot-callsign');
                const teamSelect = container.querySelector('#cot-team');
                if (callsignInput && teamSelect) {
                    TAKModule.configureSharing({
                        callsign: callsignInput.value.trim() || 'GridDown',
                        team: teamSelect.value
                    });
                }
                TAKModule.startSharing();
                renderTeam();
            };
        }
        
        // CoT Sharing - Stop sharing
        const cotStopSharing = container.querySelector('#cot-stop-sharing');
        if (cotStopSharing) {
            cotStopSharing.onclick = () => {
                TAKModule.stopSharing();
                renderTeam();
            };
        }
        
        // CoT Sharing - Send once
        const cotSendOnce = container.querySelector('#cot-send-once');
        if (cotSendOnce) {
            cotSendOnce.onclick = async () => {
                // Save callsign and team first
                const callsignInput = container.querySelector('#cot-callsign');
                const teamSelect = container.querySelector('#cot-team');
                if (callsignInput && teamSelect) {
                    TAKModule.configureSharing({
                        callsign: callsignInput.value.trim() || 'GridDown',
                        team: teamSelect.value
                    });
                }
                const sent = await TAKModule.sendPosition();
                if (sent) {
                    ModalsModule.showToast('üì§ Position sent to CoT network', 'success');
                }
            };
        }
        
        // CoT Sharing - Revoke consent
        const cotRevokeConsent = container.querySelector('#cot-revoke-consent');
        if (cotRevokeConsent) {
            cotRevokeConsent.onclick = (e) => {
                e.preventDefault();
                TAKModule.setShareConsent(false);
                renderTeam();
            };
        }
        
        // Channel URL Import button (Phase 1)
        const importChannelBtn = container.querySelector('#mesh-import-channel-btn');
        const channelUrlInput = container.querySelector('#mesh-channel-url');
        if (importChannelBtn && channelUrlInput) {
            importChannelBtn.onclick = async () => {
                const url = channelUrlInput.value.trim();
                if (!url) {
                    ModalsModule.showToast('Please enter a channel URL', 'error');
                    return;
                }
                try {
                    const channel = await MeshtasticModule.importChannelFromUrl(url);
                    ModalsModule.showToast(`Channel "${channel.name}" imported successfully`, 'success');
                    channelUrlInput.value = '';
                    renderTeam();
                } catch (err) {
                    ModalsModule.showToast('Invalid channel URL: ' + err.message, 'error');
                }
            };
        }
        
        // Check-in OK
        const checkinBtn = container.querySelector('#send-checkin-btn');
        if (checkinBtn) {
            checkinBtn.onclick = async () => {
                if (isConnected) {
                    try {
                        await MeshtasticModule.sendCheckin('OK');
                    } catch (err) {
                        ModalsModule.showToast('Check-in failed: ' + err.message, 'error');
                    }
                } else {
                    ModalsModule.showToast('Connect to Meshtastic first', 'error');
                }
            };
        }
        
        // Check-in Need Help
        const checkinHelpBtn = container.querySelector('#send-checkin-help-btn');
        if (checkinHelpBtn) {
            checkinHelpBtn.onclick = async () => {
                if (isConnected) {
                    try {
                        await MeshtasticModule.sendCheckin('NEED HELP');
                    } catch (err) {
                        ModalsModule.showToast('Check-in failed: ' + err.message, 'error');
                    }
                }
            };
        }
        
        // Send message (supports queueing when disconnected)
        const sendMsgBtn = container.querySelector('#mesh-send-btn');
        const msgInput = container.querySelector('#mesh-message-input');
        if (sendMsgBtn && msgInput) {
            const sendMessage = async () => {
                const text = msgInput.value.trim();
                if (text) {
                    try {
                        await MeshtasticModule.sendTextMessage(text);
                        msgInput.value = '';
                        
                        // Show feedback based on connection state
                        if (!isConnected) {
                            ModalsModule.showToast('Message queued - will send when connected', 'info');
                        }
                        
                        renderTeam(); // Refresh to show sent/queued message
                    } catch (err) {
                        ModalsModule.showToast('Failed to send: ' + err.message, 'error');
                    }
                }
            };
            sendMsgBtn.onclick = sendMessage;
            msgInput.onkeypress = (e) => { if (e.key === 'Enter') sendMessage(); };
        }
        
        // Clear queue button
        const clearQueueBtn = container.querySelector('#clear-queue-btn');
        if (clearQueueBtn) {
            clearQueueBtn.onclick = () => {
                if (typeof MeshtasticModule !== 'undefined') {
                    const count = MeshtasticModule.clearOutboundQueue(true);
                    ModalsModule.showToast(`Cleared ${count} queued message${count !== 1 ? 's' : ''}`, 'info');
                    renderTeam();
                }
            };
        }
        
        // Phase 2: Scenario selector buttons
        container.querySelectorAll('[data-scenario]').forEach(btn => {
            btn.onclick = async () => {
                const scenarioId = btn.dataset.scenario;
                if (typeof MeshtasticModule !== 'undefined') {
                    try {
                        await MeshtasticModule.applyScenarioPreset(scenarioId);
                        ModalsModule.showToast(`Applied ${scenarioId} preset`, 'success');
                    } catch (err) {
                        ModalsModule.showToast('Preset failed: ' + err.message, 'error');
                    }
                    renderTeam();
                }
            };
        });
        
        // Phase 2: Canned message buttons
        container.querySelectorAll('.canned-msg-btn').forEach(btn => {
            btn.onclick = async () => {
                const text = btn.dataset.cannedText;
                if (text && typeof MeshtasticModule !== 'undefined') {
                    try {
                        await MeshtasticModule.sendTextMessage(text);
                        ModalsModule.showToast(`Sent: ${text}`, 'success');
                        renderTeam();
                    } catch (e) {
                        ModalsModule.showToast(`Queued: ${text}`, 'info');
                        renderTeam();
                    }
                }
            };
        });
        
        // Phase 2: Team QR sharing button
        const teamQRBtn = container.querySelector('#mesh-show-team-qr-btn');
        if (teamQRBtn) {
            teamQRBtn.onclick = () => openTeamQRModal();
        }
        
        // Phase 2: Scan QR button
        const scanQRBtn = container.querySelector('#mesh-scan-qr-btn');
        if (scanQRBtn) {
            scanQRBtn.onclick = () => {
                // For now, prompt for URL input (camera scanning would require additional library)
                const url = prompt('Paste Meshtastic channel URL or QR data:');
                if (url && typeof MeshtasticModule !== 'undefined') {
                    const result = MeshtasticModule.joinFromQR(url);
                    if (result.success) {
                        ModalsModule.showToast('Joined team channel!', 'success');
                        renderTeam();
                    } else {
                        ModalsModule.showToast(`Failed: ${result.error}`, 'error');
                    }
                }
            };
        }
        
        // Share waypoint
        const shareWpBtn = container.querySelector('#mesh-share-waypoint-btn');
        if (shareWpBtn) {
            shareWpBtn.onclick = () => openMeshShareWaypointModal();
        }
        
        // Share route
        const shareRouteBtn = container.querySelector('#mesh-share-route-btn');
        if (shareRouteBtn) {
            shareRouteBtn.onclick = () => openMeshShareRouteModal();
        }
        
        // Go to team member location
        container.querySelectorAll('[data-goto-team]').forEach(btn => {
            btn.onclick = () => {
                const lat = parseFloat(btn.dataset.gotoLat);
                const lon = parseFloat(btn.dataset.gotoLon);
                const name = btn.dataset.gotoName || 'Member';
                if (lat && lon && typeof MapModule !== 'undefined') {
                    MapModule.setCenter(lat, lon, 15);
                    ModalsModule.showToast(`Centered on ${name}`, 'info');
                }
            };
        });
        
        // Traceroute buttons on team cards
        container.querySelectorAll('.traceroute-btn').forEach(btn => {
            btn.onclick = (e) => {
                e.stopPropagation();
                const nodeId = btn.dataset.tracerouteNode;
                const nodeName = btn.dataset.nodeName;
                openTracerouteModal(nodeId, nodeName);
            };
        });
        
        // Traceroute widget buttons
        const trHistoryBtn = container.querySelector('#traceroute-history-btn');
        if (trHistoryBtn) {
            trHistoryBtn.onclick = () => openTracerouteModal();
        }
        
        const trClearBtn = container.querySelector('#traceroute-clear-btn');
        if (trClearBtn) {
            trClearBtn.onclick = () => {
                if (typeof MeshtasticModule !== 'undefined') {
                    // Clear active traceroute
                    const state = MeshtasticModule.getState();
                    if (state) state.activeTraceroute = null;
                    renderTeam();
                }
            };
        }
        
        // === POSITION EVENT HANDLERS ===
        attachPositionHandlers();
        
        // === APRS EVENT HANDLERS ===
        attachAPRSHandlers();
        
        // === RADIACODE EVENT HANDLERS ===
        attachRadiaCodeHandlers();
        
        // === EXISTING PLAN SHARING HANDLERS ===
        
        // Export Plan Button
        container.querySelector('#export-plan-btn').onclick = () => {
            openExportModal();
        };
        
        // Import Plan Input
        container.querySelector('#import-plan-input').onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            try {
                const content = await file.text();
                const fileData = JSON.parse(content);
                
                if (fileData.encrypted) {
                    openImportModal(content, file.name);
                } else {
                    const planData = await PlanSharingModule.parsePlanFile(content);
                    showConflictResolution(planData, file.name);
                }
            } catch (err) {
                ModalsModule.showToast('Invalid plan file: ' + err.message, 'error');
            }
            
            e.target.value = '';
        };
        
        // GPX Export
        container.querySelector('#export-gpx-btn').onclick = () => {
            if (typeof GPXModule !== 'undefined') {
                GPXModule.downloadGPX(waypoints, routes, 'griddown-export.gpx');
                ModalsModule.showToast('GPX exported', 'success');
            } else {
                ModalsModule.showToast('GPX module not available', 'error');
            }
        };
        
        // Unencrypted Export
        container.querySelector('#export-unencrypted-btn').onclick = async () => {
            try {
                await PlanSharingModule.downloadPlan(null, {
                    planName: 'griddown-plan'
                });
                ModalsModule.showToast('Plan exported (unencrypted)', 'success');
            } catch (err) {
                ModalsModule.showToast('Export failed: ' + err.message, 'error');
            }
        };
        
        // Copy Summary
        container.querySelector('#copy-summary-btn').onclick = () => {
            const summary = PlanSharingModule.generatePlanSummary();
            navigator.clipboard.writeText(summary).then(() => {
                ModalsModule.showToast('Summary copied to clipboard', 'success');
            }).catch(() => {
                prompt('Copy this summary:', summary);
            });
        };
    }
    
    // Helper function for mesh message time formatting
    function formatMeshTime(timestamp) {
        if (!timestamp) return '';
        const date = new Date(timestamp);
        const now = new Date();
        const diff = now - date;
        
        if (diff < 60000) return 'now';
        if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
        if (diff < 86400000) return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        return date.toLocaleDateString();
    }
    
    // Helper to escape HTML in messages
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    /**
     * Get color for mesh signal quality
     */
    function getMeshSignalColor(quality) {
        switch (quality) {
            case 'excellent': return '#22c55e'; // Green
            case 'good': return '#84cc16';      // Lime
            case 'fair': return '#f59e0b';      // Amber
            case 'poor': return '#ef4444';      // Red
            default: return '#6b7280';          // Gray
        }
    }
    
    /**
     * Get icon for message delivery status
     * Phase 1.5: Added QUEUED status support
     */
    function getMessageStatusIcon(status) {
        switch (status) {
            case 'queued': return 'üïê';      // Clock - waiting in queue
            case 'pending': return '‚óã';       // Empty circle - about to send
            case 'sent': return '‚úì';          // Single check - sent to mesh
            case 'delivered': return '‚úì‚úì';    // Double check - delivered
            case 'read': return 'üëÅ';          // Eye - read by recipient
            case 'failed': return '‚úó';        // X - failed
            default: return '';
        }
    }
    
    /**
     * Get color for message delivery status
     * Phase 1.5: Added QUEUED status support
     */
    function getMessageStatusColor(status) {
        switch (status) {
            case 'queued': return '#f59e0b';   // Amber - waiting
            case 'pending': return '#6b7280';  // Gray - in progress
            case 'sent': return '#22c55e';     // Green - sent
            case 'delivered': return '#22c55e';// Green - delivered
            case 'read': return '#3b82f6';     // Blue - read
            case 'failed': return '#ef4444';   // Red - failed
            default: return '#6b7280';
        }
    }
    
    // =========================================================================
    // PHASE 2: QUICK SETUP & FIELD UX RENDERING
    // =========================================================================
    
    /**
     * Render scenario selector dropdown
     */
    function renderScenarioSelector() {
        const scenarios = typeof MeshtasticModule !== 'undefined' 
            ? MeshtasticModule.getScenarioPresets() 
            : [];
        const activeScenario = typeof MeshtasticModule !== 'undefined'
            ? MeshtasticModule.getActiveScenario()
            : { id: 'custom', name: 'Custom', icon: '‚öôÔ∏è' };
        
        return `
            <div style="padding:12px;background:rgba(255,255,255,0.03);border-radius:10px;margin-bottom:12px">
                <div style="font-size:11px;color:rgba(255,255,255,0.4);margin-bottom:8px">SCENARIO PRESET</div>
                <div style="display:flex;gap:8px;flex-wrap:wrap">
                    ${scenarios.map(s => `
                        <button class="btn ${s.id === activeScenario.id ? 'btn--primary' : 'btn--secondary'}" 
                            data-scenario="${s.id}"
                            style="padding:6px 10px;font-size:11px;flex:0 0 auto"
                            title="${s.description}">
                            ${s.icon} ${s.name}
                        </button>
                    `).join('')}
                </div>
                <div style="font-size:10px;color:rgba(255,255,255,0.3);margin-top:8px">
                    ${activeScenario.icon} <strong>${activeScenario.name}</strong>: ${activeScenario.description || 'User-defined settings'}
                </div>
            </div>
        `;
    }
    
    /**
     * Render mesh health widget
     */
    function renderMeshHealthWidget() {
        const health = typeof MeshtasticModule !== 'undefined'
            ? MeshtasticModule.getMeshHealth()
            : { status: 'unknown', score: 0, activeNodes: 0, totalNodes: 0 };
        
        const healthColor = typeof MeshtasticModule !== 'undefined'
            ? MeshtasticModule.getMeshHealthColor(health.status)
            : '#6b7280';
        
        const scenario = health.scenario || { icon: '‚öôÔ∏è', name: 'Custom' };
        
        return `
            <div style="padding:14px;background:rgba(${health.status === 'excellent' ? '34,197,94' : health.status === 'good' ? '132,204,22' : health.status === 'fair' ? '245,158,11' : '107,114,128'},0.1);border:1px solid ${healthColor}44;border-radius:12px;margin-bottom:12px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
                    <div style="font-size:11px;color:rgba(255,255,255,0.4)">MESH HEALTH</div>
                    <div style="display:flex;align-items:center;gap:6px">
                        <span style="font-size:10px;padding:2px 6px;background:${scenario.color || '#22c55e'}22;color:${scenario.color || '#22c55e'};border-radius:4px">
                            ${scenario.icon} ${scenario.name}
                        </span>
                    </div>
                </div>
                
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px">
                    <div style="width:50px;height:50px;border-radius:50%;background:${healthColor}22;display:flex;align-items:center;justify-content:center;border:2px solid ${healthColor}">
                        <span style="font-size:18px;font-weight:700;color:${healthColor}">${health.score}</span>
                    </div>
                    <div style="flex:1">
                        <div style="font-size:14px;font-weight:600;color:${healthColor};text-transform:capitalize">
                            ${health.status}
                        </div>
                        <div style="font-size:11px;color:rgba(255,255,255,0.5)">
                            ${health.activeNodes} active node${health.activeNodes !== 1 ? 's' : ''} ‚Ä¢ ${health.recentNodes || 0} updated recently
                        </div>
                    </div>
                </div>
                
                <!-- Signal Distribution -->
                ${health.activeNodes > 0 ? `
                    <div style="display:flex;gap:6px;margin-bottom:8px">
                        ${health.signalDistribution.excellent > 0 ? `<span style="font-size:10px;padding:2px 6px;background:#22c55e22;color:#22c55e;border-radius:4px">üì∂ ${health.signalDistribution.excellent} excellent</span>` : ''}
                        ${health.signalDistribution.good > 0 ? `<span style="font-size:10px;padding:2px 6px;background:#84cc1622;color:#84cc16;border-radius:4px">üì∂ ${health.signalDistribution.good} good</span>` : ''}
                        ${health.signalDistribution.fair > 0 ? `<span style="font-size:10px;padding:2px 6px;background:#f59e0b22;color:#f59e0b;border-radius:4px">üì∂ ${health.signalDistribution.fair} fair</span>` : ''}
                        ${health.signalDistribution.poor > 0 ? `<span style="font-size:10px;padding:2px 6px;background:#ef444422;color:#ef4444;border-radius:4px">üì∂ ${health.signalDistribution.poor} poor</span>` : ''}
                    </div>
                    <div style="font-size:10px;color:rgba(255,255,255,0.4)">
                        Avg: SNR ${health.averageSignal.snr}dB ‚Ä¢ RSSI ${health.averageSignal.rssi}dBm
                    </div>
                ` : `
                    <div style="font-size:11px;color:rgba(255,255,255,0.4)">
                        No other nodes detected yet
                    </div>
                `}
                
                <!-- Queue Status -->
                ${health.queueStatus && health.queueStatus.count > 0 ? `
                    <div style="margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.1)">
                        <span style="font-size:10px;color:#f59e0b">üïê ${health.queueStatus.count} message${health.queueStatus.count !== 1 ? 's' : ''} queued</span>
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    /**
     * Render canned messages bar
     */
    function renderCannedMessagesBar() {
        const messages = typeof MeshtasticModule !== 'undefined'
            ? MeshtasticModule.getCannedMessages()
            : [];
        
        if (messages.length === 0) return '';
        
        return `
            <div style="margin-bottom:12px">
                <div style="font-size:10px;color:rgba(255,255,255,0.4);margin-bottom:6px">QUICK MESSAGES</div>
                <div style="display:flex;gap:6px;flex-wrap:wrap">
                    ${messages.slice(0, 8).map(msg => `
                        <button class="btn btn--secondary canned-msg-btn" 
                            data-canned-id="${msg.id}"
                            data-canned-text="${escapeHtml(msg.text)}"
                            style="padding:6px 10px;font-size:11px"
                            title="Send: ${msg.text}">
                            ${msg.icon} ${msg.text.length > 10 ? msg.text.substring(0, 10) + '...' : msg.text}
                        </button>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    /**
     * Render device connection help with device selector
     */
    function renderDeviceConnectionHelp(apiSupport) {
        // Get common devices for help text
        const commonDevices = typeof MeshtasticModule !== 'undefined'
            ? MeshtasticModule.getCommonDevices()
            : [];
        
        // BLE-only devices that users commonly have
        const bleOnlyDevices = ['WisMesh Pocket', 'WisMesh Tap', 'T-Echo'];
        
        return `
            <div style="padding:12px;background:rgba(255,255,255,0.03);border-radius:10px;margin-bottom:12px">
                <div style="font-size:11px;color:rgba(255,255,255,0.4);margin-bottom:8px">SELECT YOUR DEVICE</div>
                
                <!-- Device Type Buttons -->
                <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px">
                    <button class="btn btn--secondary device-type-btn" data-device="wismesh_pocket" 
                        data-ble="true" data-serial="false"
                        style="padding:8px 12px;font-size:11px">
                        üì± WisMesh Pocket
                    </button>
                    <button class="btn btn--secondary device-type-btn" data-device="t_echo" 
                        data-ble="true" data-serial="false"
                        style="padding:8px 12px;font-size:11px">
                        üì± T-Echo
                    </button>
                    <button class="btn btn--secondary device-type-btn" data-device="t_beam" 
                        data-ble="true" data-serial="true"
                        style="padding:8px 12px;font-size:11px">
                        üì° T-Beam
                    </button>
                    <button class="btn btn--secondary device-type-btn" data-device="heltec" 
                        data-ble="true" data-serial="true"
                        style="padding:8px 12px;font-size:11px">
                        üì° Heltec
                    </button>
                    <button class="btn btn--secondary device-type-btn selected" data-device="other" 
                        data-ble="true" data-serial="true"
                        style="padding:8px 12px;font-size:11px">
                        üîß Other
                    </button>
                </div>
                
                <!-- Device-specific help message -->
                <div id="device-help-message" style="padding:8px 10px;background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.2);border-radius:6px;margin-bottom:12px;display:none">
                    <div style="font-size:11px;color:#3b82f6">
                        <span id="device-help-icon">‚ÑπÔ∏è</span>
                        <span id="device-help-text"></span>
                    </div>
                </div>
                
                <!-- Connect Buttons -->
                <div style="display:flex;gap:8px">
                    <button class="btn btn--primary" id="mesh-connect-ble-btn" style="flex:1" ${!apiSupport.bluetooth ? 'disabled' : ''}>
                        üì∂ Bluetooth
                    </button>
                    <button class="btn btn--secondary" id="mesh-connect-serial-btn" style="flex:1" ${!apiSupport.serial ? 'disabled' : ''}>
                        üîå Serial/USB
                    </button>
                </div>
                
                <!-- New Device Setup -->
                <button class="btn btn--secondary" id="mesh-device-setup-btn" style="width:100%;margin-top:8px;padding:10px;font-size:12px" ${!apiSupport.bluetooth && !apiSupport.serial ? 'disabled' : ''}>
                    üì± New Device Setup ‚Äî <span style="color:rgba(255,255,255,0.5)">skip the Meshtastic app</span>
                </button>
                
                <!-- Quick reference -->
                <div style="margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.1)">
                    <div style="font-size:10px;color:rgba(255,255,255,0.35)">
                        <strong>Bluetooth only:</strong> WisMesh Pocket/Tap, T-Echo, RAK Tracker<br>
                        <strong>Both supported:</strong> T-Beam, Heltec, Station G2, WisBlock
                    </div>
                </div>
            </div>
        `;
    }
    
    /**
     * Render connected device info card
     */
    function renderConnectedDeviceInfo() {
        const deviceCaps = typeof MeshtasticModule !== 'undefined'
            ? MeshtasticModule.getConnectedDeviceCapabilities()
            : null;
        
        if (!deviceCaps) return '';
        
        const config = typeof MeshtasticModule !== 'undefined'
            ? MeshtasticModule.getDeviceConfig()
            : {};
        
        const firmwareStatus = typeof MeshtasticModule !== 'undefined' && config.firmwareVersion
            ? MeshtasticModule.checkFirmwareStatus(config.firmwareVersion)
            : null;
        
        return `
            <div style="padding:12px;background:rgba(255,255,255,0.03);border-radius:10px;margin-top:12px">
                <div style="font-size:11px;color:rgba(255,255,255,0.4);margin-bottom:8px">CONNECTED DEVICE</div>
                
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
                    <div style="width:36px;height:36px;border-radius:8px;background:rgba(34,197,94,0.2);display:flex;align-items:center;justify-content:center">
                        <span style="font-size:18px">${deviceCaps.portable ? 'üì±' : 'üè†'}</span>
                    </div>
                    <div style="flex:1">
                        <div style="font-size:13px;font-weight:600">${deviceCaps.displayName || 'Unknown Device'}</div>
                        <div style="font-size:10px;color:rgba(255,255,255,0.5)">
                            ${config.firmwareVersion ? `Firmware ${config.firmwareVersion}` : 'Firmware unknown'}
                            ${firmwareStatus ? ` ‚Ä¢ <span style="color:${firmwareStatus.color}">${firmwareStatus.status === 'current' ? '‚úì Up to date' : firmwareStatus.status === 'update_available' ? '‚Üë Update available' : '‚ö† Outdated'}</span>` : ''}
                        </div>
                    </div>
                </div>
                
                <!-- Device Capabilities -->
                <div style="display:flex;gap:6px;flex-wrap:wrap">
                    ${deviceCaps.bluetooth ? '<span style="font-size:10px;padding:3px 6px;background:rgba(59,130,246,0.2);color:#3b82f6;border-radius:4px">üì∂ Bluetooth</span>' : ''}
                    ${deviceCaps.serial ? '<span style="font-size:10px;padding:3px 6px;background:rgba(139,92,246,0.2);color:#8b5cf6;border-radius:4px">üîå Serial</span>' : ''}
                    ${deviceCaps.gps ? '<span style="font-size:10px;padding:3px 6px;background:rgba(34,197,94,0.2);color:#22c55e;border-radius:4px">üìç GPS</span>' : ''}
                    ${deviceCaps.wifi ? '<span style="font-size:10px;padding:3px 6px;background:rgba(249,115,22,0.2);color:#f97316;border-radius:4px">üì° WiFi</span>' : ''}
                    ${deviceCaps.screen ? '<span style="font-size:10px;padding:3px 6px;background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.6);border-radius:4px">üñ•Ô∏è Screen</span>' : ''}
                </div>
                
                ${deviceCaps.notes ? `
                    <div style="font-size:10px;color:rgba(255,255,255,0.4);margin-top:8px;font-style:italic">
                        ${deviceCaps.notes}
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    // =========================================================================
    // TRACEROUTE VISUALIZATION
    // =========================================================================
    
    /**
     * Render traceroute result widget
     */
    function renderTracerouteWidget() {
        const traceroute = typeof MeshtasticModule !== 'undefined'
            ? MeshtasticModule.getActiveTraceroute()
            : null;
        
        if (!traceroute) return '';
        
        const display = MeshtasticModule.formatTracerouteDisplay(traceroute);
        if (!display) return '';
        
        const statusColors = {
            pending: '#6b7280',
            in_progress: '#3b82f6',
            completed: '#22c55e',
            timeout: '#f59e0b',
            error: '#ef4444'
        };
        
        const statusColor = statusColors[display.status] || '#6b7280';
        
        return `
            <div style="padding:12px;background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.2);border-radius:10px;margin-bottom:12px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
                    <div style="font-size:11px;color:rgba(255,255,255,0.4)">TRACEROUTE</div>
                    <div style="display:flex;align-items:center;gap:6px">
                        <span style="font-size:10px;color:${statusColor}">${display.statusIcon} ${display.status.toUpperCase()}</span>
                        ${display.rtt ? `<span style="font-size:10px;color:rgba(255,255,255,0.5)">${display.rtt}</span>` : ''}
                    </div>
                </div>
                
                <div style="font-size:12px;font-weight:500;margin-bottom:8px">
                    Route to ${display.targetName}
                    ${display.hops !== null ? `<span style="font-size:10px;color:rgba(255,255,255,0.5);font-weight:normal;margin-left:6px">${display.hops} hop${display.hops !== 1 ? 's' : ''}</span>` : ''}
                </div>
                
                <!-- Route Visualization -->
                <div style="position:relative;padding-left:20px">
                    ${display.route.map((hop, index) => `
                        <div style="display:flex;align-items:center;gap:8px;padding:6px 0;position:relative">
                            <!-- Vertical line -->
                            ${index < display.route.length - 1 ? `
                                <div style="position:absolute;left:5px;top:20px;bottom:-6px;width:2px;background:${hop.isDestination ? 'transparent' : 'rgba(59,130,246,0.3)'}"></div>
                            ` : ''}
                            
                            <!-- Hop indicator -->
                            <div style="position:absolute;left:0;width:12px;height:12px;border-radius:50%;background:${hop.isOrigin ? '#22c55e' : hop.isDestination ? '#f97316' : '#3b82f6'};border:2px solid ${hop.isOrigin ? '#22c55e55' : hop.isDestination ? '#f9731655' : '#3b82f655'}"></div>
                            
                            <!-- Hop info -->
                            <div style="flex:1;margin-left:20px">
                                <div style="font-size:11px;font-weight:500">${hop.displayName}</div>
                                <div style="font-size:9px;color:rgba(255,255,255,0.4)">${hop.hopLabel}</div>
                            </div>
                            
                            <!-- Signal badge -->
                            ${hop.signalBadge && !hop.isOrigin ? `
                                <span style="font-size:9px;padding:2px 5px;background:${getMeshSignalColor(hop.signalBadge)}22;color:${getMeshSignalColor(hop.signalBadge)};border-radius:4px">
                                    ${hop.signalBadge}
                                </span>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
                
                ${display.error ? `
                    <div style="font-size:10px;color:#ef4444;margin-top:8px">
                        ‚ö†Ô∏è ${display.error}
                    </div>
                ` : ''}
                
                <div style="display:flex;gap:6px;margin-top:10px">
                    <button class="btn btn--secondary" id="traceroute-history-btn" style="flex:1;font-size:10px;padding:6px">
                        üìú History
                    </button>
                    <button class="btn btn--secondary" id="traceroute-clear-btn" style="font-size:10px;padding:6px">
                        ‚úï Clear
                    </button>
                </div>
            </div>
        `;
    }
    
    /**
     * Open traceroute modal for selecting target node
     */
    function openTracerouteModal(preselectedNodeId = null, preselectedNodeName = null) {
        // Uses cached modalContainer ref
        if (!modalContainer) return;
        
        // Get available nodes
        const nodes = typeof MeshtasticModule !== 'undefined'
            ? MeshtasticModule.getNodesForTraceroute()
            : [];
        
        const nodeOptions = nodes.map(node => {
            const isSelected = preselectedNodeId && node.id === preselectedNodeId;
            const signalColor = node.signalQuality ? getMeshSignalColor(node.signalQuality) : '#6b7280';
            const timeAgo = formatTimeAgo(node.lastSeen);
            
            return `
                <button class="traceroute-node-btn ${isSelected ? 'selected' : ''} ${node.isActive ? 'active' : 'inactive'}" 
                    data-node-id="${node.id}" 
                    data-node-name="${escapeHtml(node.name)}">
                    <div style="display:flex;align-items:center;gap:10px;width:100%">
                        <div style="width:32px;height:32px;border-radius:50%;background:rgba(255,255,255,0.05);display:flex;align-items:center;justify-content:center">
                            <span style="font-size:14px">üë§</span>
                        </div>
                        <div style="flex:1;text-align:left">
                            <div style="font-size:12px;font-weight:500">${node.name}</div>
                            <div style="font-size:10px;color:rgba(255,255,255,0.4)">${timeAgo}${node.hopAway ? ` ‚Ä¢ ${node.hopAway} hop${node.hopAway !== 1 ? 's' : ''} away` : ''}</div>
                        </div>
                        ${node.signalQuality ? `
                            <span style="font-size:9px;padding:2px 6px;background:${signalColor}22;color:${signalColor};border-radius:4px">
                                ${node.signalQuality}
                            </span>
                        ` : ''}
                    </div>
                </button>
            `;
        }).join('');
        
        modalContainer.innerHTML = `
            <div class="modal-backdrop" id="traceroute-modal">
                <div class="modal" role="dialog" aria-modal="true" style="max-width:400px">
                    <div class="modal__header">
                        <h3 class="modal__title">üîç Trace Route</h3>
                        <button class="modal__close" id="close-traceroute-modal" aria-label="Close dialog">&times;</button>
                    </div>
                    <div class="modal__content">
                        <div style="font-size:12px;color:rgba(255,255,255,0.6);margin-bottom:12px">
                            Select a node to trace the mesh route. This shows how messages reach that node.
                        </div>
                        
                        ${nodes.length > 0 ? `
                            <div style="max-height:300px;overflow-y:auto;margin-bottom:16px">
                                ${nodeOptions}
                            </div>
                            
                            <button class="btn btn--primary btn--full" id="start-traceroute-btn" ${preselectedNodeId ? '' : 'disabled'}>
                                üîç Start Traceroute
                            </button>
                        ` : `
                            <div style="padding:30px;text-align:center;color:rgba(255,255,255,0.4)">
                                <div style="font-size:32px;margin-bottom:10px">üì°</div>
                                <div style="font-size:13px">No other nodes detected</div>
                                <div style="font-size:11px;margin-top:6px">Wait for nodes to appear on the mesh</div>
                            </div>
                        `}
                        
                        <!-- Recent Traceroutes -->
                        ${renderTracerouteHistoryInModal()}
                    </div>
                </div>
            </div>
            
            <style>
                .traceroute-node-btn {
                    display: flex;
                    width: 100%;
                    padding: 10px 12px;
                    background: rgba(255,255,255,0.03);
                    border: 1px solid rgba(255,255,255,0.1);
                    border-radius: 8px;
                    margin-bottom: 6px;
                    cursor: pointer;
                    transition: all 0.15s;
                }
                .traceroute-node-btn:hover {
                    background: rgba(255,255,255,0.06);
                    border-color: rgba(255,255,255,0.2);
                }
                .traceroute-node-btn.selected {
                    background: rgba(59,130,246,0.15);
                    border-color: rgba(59,130,246,0.4);
                }
                .traceroute-node-btn.inactive {
                    opacity: 0.6;
                }
            </style>
        `;
        
        // Event handlers
        let selectedNodeId = preselectedNodeId;
        let selectedNodeName = preselectedNodeName;
        
        document.getElementById('close-traceroute-modal').onclick = () => modalContainer.innerHTML = '';
        document.getElementById('traceroute-modal').onclick = (e) => {
            if (e.target.id === 'traceroute-modal') modalContainer.innerHTML = '';
        };
        
        // Node selection
        modalContainer.querySelectorAll('.traceroute-node-btn').forEach(btn => {
            btn.onclick = () => {
                modalContainer.querySelectorAll('.traceroute-node-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedNodeId = btn.dataset.nodeId;
                selectedNodeName = btn.dataset.nodeName;
                
                const startBtn = domCache.get('start-traceroute-btn');
                if (startBtn) startBtn.disabled = false;
            };
        });
        
        // Start traceroute
        const startBtn = domCache.get('start-traceroute-btn');
        if (startBtn) {
            startBtn.onclick = async () => {
                if (!selectedNodeId) return;
                
                startBtn.disabled = true;
                startBtn.innerHTML = '‚è≥ Tracing...';
                
                try {
                    await MeshtasticModule.requestTraceroute(selectedNodeId);
                    modalContainer.innerHTML = '';
                    
                    // Refresh the team panel to show traceroute widget
                    if (typeof renderTeam === 'function') {
                        renderTeam();
                    }
                } catch (e) {
                    startBtn.disabled = false;
                    startBtn.innerHTML = 'üîç Start Traceroute';
                    ModalsModule.showToast('Traceroute failed: ' + e.message, 'error');
                }
            };
        }
    }
    
    /**
     * Render traceroute history section for modal
     */
    function renderTracerouteHistoryInModal() {
        const history = typeof MeshtasticModule !== 'undefined'
            ? MeshtasticModule.getTracerouteHistory()
            : [];
        
        if (history.length === 0) return '';
        
        const statusIcons = {
            completed: '‚úÖ',
            timeout: '‚è±Ô∏è',
            error: '‚ùå'
        };
        
        return `
            <div style="margin-top:16px;padding-top:16px;border-top:1px solid rgba(255,255,255,0.1)">
                <div style="font-size:11px;color:rgba(255,255,255,0.4);margin-bottom:8px">RECENT TRACEROUTES</div>
                <div style="max-height:150px;overflow-y:auto">
                    ${history.slice(0, 5).map(tr => {
                        const display = MeshtasticModule.formatTracerouteDisplay(tr);
                        const timeAgo = formatTimeAgo(tr.startedAt);
                        return `
                            <div style="padding:8px;background:rgba(255,255,255,0.02);border-radius:6px;margin-bottom:4px">
                                <div style="display:flex;justify-content:space-between;align-items:center">
                                    <span style="font-size:11px">${statusIcons[tr.status] || '‚ùì'} ${tr.targetName}</span>
                                    <span style="font-size:10px;color:rgba(255,255,255,0.4)">${timeAgo}</span>
                                </div>
                                ${tr.status === 'completed' ? `
                                    <div style="font-size:10px;color:rgba(255,255,255,0.5);margin-top:2px">
                                        ${tr.hops} hop${tr.hops !== 1 ? 's' : ''} ‚Ä¢ ${tr.rtt}ms
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    }
    
    /**
     * Format time ago helper
     */
    function formatTimeAgo(timestamp) {
        if (!timestamp) return '';
        const diff = Date.now() - timestamp;
        if (diff < 60000) return 'just now';
        if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
        if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
        return 'long ago';
    }
    
    // =========================================================================
    // TELEMETRY EXPORT MODAL
    // =========================================================================
    
    /**
     * Open Telemetry Export Modal
     */
    function openTelemetryExportModal() {
        // Uses cached modalContainer ref
        if (!modalContainer) return;
        
        // Get export summary
        const summary = typeof MeshtasticModule !== 'undefined'
            ? MeshtasticModule.getExportSummary()
            : { nodesCount: 0, messagesCount: 0, traceroutesCount: 0, hasData: false };
        
        modalContainer.innerHTML = `
            <div class="modal-backdrop" id="export-modal">
                <div class="modal" role="dialog" aria-modal="true" style="max-width:450px">
                    <div class="modal__header">
                        <h3 class="modal__title">üìä Export Telemetry</h3>
                        <button class="modal__close" id="close-export-modal" aria-label="Close dialog">&times;</button>
                    </div>
                    <div class="modal__content">
                        <div style="font-size:12px;color:rgba(255,255,255,0.6);margin-bottom:16px">
                            Export mesh network data for analysis, reporting, or backup.
                        </div>
                        
                        <!-- Data Summary -->
                        <div style="display:flex;gap:12px;margin-bottom:20px">
                            <div style="flex:1;padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;text-align:center">
                                <div style="font-size:24px;font-weight:600;color:#3b82f6">${summary.nodesCount}</div>
                                <div style="font-size:10px;color:rgba(255,255,255,0.5)">Nodes</div>
                            </div>
                            <div style="flex:1;padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;text-align:center">
                                <div style="font-size:24px;font-weight:600;color:#22c55e">${summary.messagesCount}</div>
                                <div style="font-size:10px;color:rgba(255,255,255,0.5)">Messages</div>
                            </div>
                            <div style="flex:1;padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;text-align:center">
                                <div style="font-size:24px;font-weight:600;color:#f97316">${summary.traceroutesCount}</div>
                                <div style="font-size:10px;color:rgba(255,255,255,0.5)">Traceroutes</div>
                            </div>
                        </div>
                        
                        <!-- Export Options -->
                        <div style="font-size:11px;color:rgba(255,255,255,0.4);margin-bottom:8px;text-transform:uppercase">CSV Exports</div>
                        
                        <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px">
                            <button class="export-option-btn" id="export-nodes-csv" ${summary.nodesCount === 0 ? 'disabled' : ''}>
                                <div style="display:flex;align-items:center;gap:12px">
                                    <span style="font-size:24px">üë•</span>
                                    <div style="flex:1;text-align:left">
                                        <div style="font-size:13px;font-weight:500">Node List (CSV)</div>
                                        <div style="font-size:10px;color:rgba(255,255,255,0.5)">
                                            ${summary.nodesCount} nodes ‚Ä¢ Position, signal, battery, hardware
                                        </div>
                                    </div>
                                    <span style="font-size:12px;color:rgba(255,255,255,0.4)">üì•</span>
                                </div>
                            </button>
                            
                            <button class="export-option-btn" id="export-messages-csv" ${summary.messagesCount === 0 ? 'disabled' : ''}>
                                <div style="display:flex;align-items:center;gap:12px">
                                    <span style="font-size:24px">üí¨</span>
                                    <div style="flex:1;text-align:left">
                                        <div style="font-size:13px;font-weight:500">Message History (CSV)</div>
                                        <div style="font-size:10px;color:rgba(255,255,255,0.5)">
                                            ${summary.messagesCount} messages ‚Ä¢ Timestamps, sender, content
                                        </div>
                                    </div>
                                    <span style="font-size:12px;color:rgba(255,255,255,0.4)">üì•</span>
                                </div>
                            </button>
                        </div>
                        
                        <div style="font-size:11px;color:rgba(255,255,255,0.4);margin-bottom:8px;text-transform:uppercase">JSON Reports</div>
                        
                        <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px">
                            <button class="export-option-btn" id="export-health-json">
                                <div style="display:flex;align-items:center;gap:12px">
                                    <span style="font-size:24px">üè•</span>
                                    <div style="flex:1;text-align:left">
                                        <div style="font-size:13px;font-weight:500">Mesh Health Report</div>
                                        <div style="font-size:10px;color:rgba(255,255,255,0.5)">
                                            Health score, signal distribution, device config
                                        </div>
                                    </div>
                                    <span style="font-size:12px;color:rgba(255,255,255,0.4)">üì•</span>
                                </div>
                            </button>
                            
                            <button class="export-option-btn" id="export-full-json" ${!summary.hasData ? 'disabled' : ''}>
                                <div style="display:flex;align-items:center;gap:12px">
                                    <span style="font-size:24px">üìã</span>
                                    <div style="flex:1;text-align:left">
                                        <div style="font-size:13px;font-weight:500">Full Telemetry Report</div>
                                        <div style="font-size:10px;color:rgba(255,255,255,0.5)">
                                            Complete export with all nodes, messages, traceroutes
                                        </div>
                                    </div>
                                    <span style="font-size:12px;color:rgba(255,255,255,0.4)">üì•</span>
                                </div>
                            </button>
                        </div>
                        
                        ${!summary.hasData ? `
                            <div style="padding:12px;background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.2);border-radius:8px;font-size:11px;color:#f59e0b;text-align:center">
                                ‚ö†Ô∏è No data to export yet. Connect to mesh and discover nodes first.
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
            
            <style>
                .export-option-btn {
                    display: block;
                    width: 100%;
                    padding: 12px 14px;
                    background: rgba(255,255,255,0.03);
                    border: 1px solid rgba(255,255,255,0.1);
                    border-radius: 10px;
                    cursor: pointer;
                    transition: all 0.15s;
                    text-align: left;
                }
                .export-option-btn:hover:not(:disabled) {
                    background: rgba(255,255,255,0.06);
                    border-color: rgba(59,130,246,0.4);
                }
                .export-option-btn:active:not(:disabled) {
                    background: rgba(59,130,246,0.15);
                }
                .export-option-btn:disabled {
                    opacity: 0.4;
                    cursor: not-allowed;
                }
            </style>
        `;
        
        // Event handlers
        document.getElementById('close-export-modal').onclick = () => modalContainer.innerHTML = '';
        document.getElementById('export-modal').onclick = (e) => {
            if (e.target.id === 'export-modal') modalContainer.innerHTML = '';
        };
        
        // Export buttons
        const nodesBtn = document.getElementById('export-nodes-csv');
        if (nodesBtn && !nodesBtn.disabled) {
            nodesBtn.onclick = () => {
                MeshtasticModule.downloadNodesCSV();
                modalContainer.innerHTML = '';
            };
        }
        
        const messagesBtn = document.getElementById('export-messages-csv');
        if (messagesBtn && !messagesBtn.disabled) {
            messagesBtn.onclick = () => {
                MeshtasticModule.downloadMessagesCSV();
                modalContainer.innerHTML = '';
            };
        }
        
        const healthBtn = document.getElementById('export-health-json');
        if (healthBtn) {
            healthBtn.onclick = () => {
                MeshtasticModule.downloadHealthReport();
                modalContainer.innerHTML = '';
            };
        }
        
        const fullBtn = document.getElementById('export-full-json');
        if (fullBtn && !fullBtn.disabled) {
            fullBtn.onclick = () => {
                MeshtasticModule.downloadTelemetryReport();
                modalContainer.innerHTML = '';
            };
        }
    }
    
    /**
     * Open Team QR Code Modal for sharing
     */
    function openTeamQRModal() {
        // Uses cached modalContainer ref
        
        const qrData = typeof MeshtasticModule !== 'undefined'
            ? MeshtasticModule.generateTeamOnboardingQR()
            : null;
        
        if (!qrData) {
            ModalsModule.showToast('Unable to generate QR code', 'error');
            return;
        }
        
        const scenario = qrData.scenario || { icon: '‚öôÔ∏è', name: 'Custom' };
        
        modalContainer.innerHTML = `
            <div class="modal-backdrop" id="team-qr-modal">
                <div class="modal" role="dialog" aria-modal="true" style="max-width:400px">
                    <div class="modal__header">
                        <h3 class="modal__title">üì± Team Onboarding QR</h3>
                        <button class="modal__close" id="close-team-qr-modal" aria-label="Close dialog">&times;</button>
                    </div>
                    <div class="modal__content">
                        <div style="text-align:center;margin-bottom:16px">
                            <div style="padding:20px;background:white;border-radius:12px;display:inline-block;margin-bottom:12px">
                                <div id="team-qr-code" style="width:200px;height:200px;display:flex;align-items:center;justify-content:center;color:#333">
                                    <!-- QR code would be rendered here by a library -->
                                    <div style="font-size:12px;text-align:center">
                                        <div style="font-size:32px;margin-bottom:8px">üì±</div>
                                        QR Code Generation<br>
                                        <small>Requires QR library</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="font-size:14px;font-weight:600;color:#f97316">
                                ${qrData.channelName || 'GridDown Team'}
                            </div>
                            <div style="font-size:12px;color:rgba(255,255,255,0.5)">
                                ${scenario.icon} ${scenario.name} Preset
                            </div>
                        </div>
                        
                        <div style="padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;margin-bottom:12px">
                            <div style="font-size:11px;color:rgba(255,255,255,0.4);margin-bottom:4px">CHANNEL URL</div>
                            <div style="font-size:10px;word-break:break-all;color:rgba(255,255,255,0.7);font-family:monospace">
                                ${qrData.url}
                            </div>
                        </div>
                        
                        <div style="display:flex;gap:8px">
                            <button class="btn btn--secondary" id="copy-team-url-btn" style="flex:1">
                                üìã Copy URL
                            </button>
                            <button class="btn btn--primary" id="share-team-url-btn" style="flex:1">
                                üì§ Share
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Event handlers
        document.getElementById('close-team-qr-modal').onclick = () => modalContainer.innerHTML = '';
        document.getElementById('team-qr-modal').onclick = (e) => {
            if (e.target.id === 'team-qr-modal') modalContainer.innerHTML = '';
        };
        
        document.getElementById('copy-team-url-btn').onclick = () => {
            navigator.clipboard.writeText(qrData.url).then(() => {
                ModalsModule.showToast('URL copied to clipboard', 'success');
            }).catch(() => {
                ModalsModule.showToast('Could not copy URL', 'error');
            });
        };
        
        document.getElementById('share-team-url-btn').onclick = async () => {
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Join GridDown Team',
                        text: `Join our mesh network: ${qrData.channelName || 'GridDown'}`,
                        url: qrData.url
                    });
                } catch (e) {
                    if (e.name !== 'AbortError') {
                        ModalsModule.showToast('Share failed', 'error');
                    }
                }
            } else {
                navigator.clipboard.writeText(qrData.url).then(() => {
                    ModalsModule.showToast('URL copied (sharing not supported)', 'info');
                }).catch(() => {
                    ModalsModule.showToast('Could not copy URL', 'error');
                });
            }
        };
    }
    
    // =========================================================================
    // NEW DEVICE SETUP MODAL
    // =========================================================================
    
    /**
     * Full device setup for brand-new pre-flashed Meshtastic devices.
     * Eliminates the need to download the Meshtastic app.
     * Walks through: Connect ‚Üí Identity ‚Üí Region ‚Üí Radio ‚Üí Done
     */
    function openDeviceSetupModal() {
        const apiSupport = typeof MeshtasticModule !== 'undefined'
            ? MeshtasticModule.checkApiSupport()
            : { bluetooth: false, serial: false };
        
        const regionOptions = typeof MeshtasticModule !== 'undefined'
            ? MeshtasticModule.getRegionOptions()
            : [];
        
        const modemOptions = typeof MeshtasticModule !== 'undefined'
            ? MeshtasticModule.getModemPresetOptions()
            : [];
        
        // State for the wizard
        let setupState = {
            connected: false,
            connectionType: null,
            deviceConfig: null,
            firmwareVersion: null,
            hwModel: null,
            longName: '',
            shortName: '',
            region: 1, // US default
            modemPreset: 0, // LONG_FAST default
            txPower: 0, // device default
            hopLimit: 3,
            positionBroadcastSecs: 120,
            gpsEnabled: true
        };
        
        modalContainer.innerHTML = `
            <div class="modal-backdrop" id="modal-backdrop" role="presentation">
                <div class="modal" role="dialog" aria-modal="true" style="max-width:520px">
                    <div class="modal__header">
                        <h3 class="modal__title">üì± New Device Setup</h3>
                        <button class="modal__close" id="modal-close" aria-label="Close dialog">${Icons.get('close')}</button>
                    </div>
                    <div class="modal__body" style="max-height:75vh;overflow-y:auto">
                        
                        <!-- Step Progress -->
                        <div style="display:flex;justify-content:center;gap:4px;margin-bottom:20px">
                            <div class="setup-step active" data-setup-step="1">1</div>
                            <div style="width:24px;height:2px;background:rgba(255,255,255,0.1);align-self:center" class="setup-step-line" data-line="1"></div>
                            <div class="setup-step" data-setup-step="2">2</div>
                            <div style="width:24px;height:2px;background:rgba(255,255,255,0.1);align-self:center" class="setup-step-line" data-line="2"></div>
                            <div class="setup-step" data-setup-step="3">3</div>
                            <div style="width:24px;height:2px;background:rgba(255,255,255,0.1);align-self:center" class="setup-step-line" data-line="3"></div>
                            <div class="setup-step" data-setup-step="4">4</div>
                            <div style="width:24px;height:2px;background:rgba(255,255,255,0.1);align-self:center" class="setup-step-line" data-line="4"></div>
                            <div class="setup-step" data-setup-step="5">5</div>
                        </div>
                        
                        <!-- ===== STEP 1: CONNECT ===== -->
                        <div id="setup-step-1" class="setup-panel">
                            <div style="text-align:center;margin-bottom:20px">
                                <span style="font-size:48px">üì°</span>
                                <h4 style="margin:12px 0 4px">Connect Your Device</h4>
                                <p style="font-size:12px;color:rgba(255,255,255,0.5)">
                                    Power on your Meshtastic device and connect via Bluetooth or USB.
                                    No Meshtastic app required ‚Äî GridDown configures the device directly.
                                </p>
                            </div>
                            
                            <div style="display:flex;gap:12px;margin-bottom:16px">
                                <button class="btn btn--primary" id="setup-connect-ble" style="flex:1;padding:20px" ${!apiSupport.bluetooth ? 'disabled title="Bluetooth not supported in this browser"' : ''}>
                                    <div style="font-size:28px;margin-bottom:8px">üì∂</div>
                                    <div style="font-size:13px;font-weight:600">Bluetooth</div>
                                    <div style="font-size:10px;color:rgba(255,255,255,0.5);margin-top:4px">All Meshtastic devices</div>
                                </button>
                                <button class="btn btn--secondary" id="setup-connect-serial" style="flex:1;padding:20px" ${!apiSupport.serial ? 'disabled title="Web Serial not supported in this browser"' : ''}>
                                    <div style="font-size:28px;margin-bottom:8px">üîå</div>
                                    <div style="font-size:13px;font-weight:600">USB Cable</div>
                                    <div style="font-size:10px;color:rgba(255,255,255,0.5);margin-top:4px">T-Beam, Heltec, Station G2</div>
                                </button>
                            </div>
                            
                            <div id="setup-connect-status" style="text-align:center;padding:16px;background:rgba(255,255,255,0.03);border-radius:10px;margin-bottom:16px">
                                <div style="font-size:12px;color:rgba(255,255,255,0.4)">
                                    Make sure your device is powered on and in range
                                </div>
                            </div>
                            
                            <div style="padding:10px;background:rgba(59,130,246,0.08);border:1px solid rgba(59,130,246,0.15);border-radius:8px;font-size:11px;color:rgba(255,255,255,0.6)">
                                <strong style="color:#60a5fa">üí° Tip:</strong> If your device has never been configured, the Bluetooth name
                                will be "Meshtastic_XXXX". For USB, make sure the cable supports data (not just charging).
                            </div>
                        </div>
                        
                        <!-- ===== STEP 2: IDENTITY ===== -->
                        <div id="setup-step-2" class="setup-panel" style="display:none">
                            <div style="text-align:center;margin-bottom:16px">
                                <span style="font-size:48px">üë§</span>
                                <h4 style="margin:12px 0 4px">Device Identity</h4>
                                <p style="font-size:12px;color:rgba(255,255,255,0.5)">
                                    Set the name that other mesh users will see for this device
                                </p>
                            </div>
                            
                            <!-- Device info card -->
                            <div id="setup-device-info" style="padding:12px;background:rgba(34,197,94,0.08);border:1px solid rgba(34,197,94,0.15);border-radius:10px;margin-bottom:16px">
                                <div style="display:flex;align-items:center;gap:10px">
                                    <div style="font-size:24px">‚úÖ</div>
                                    <div>
                                        <div style="font-size:13px;font-weight:600;color:#22c55e">Device Connected</div>
                                        <div id="setup-device-details" style="font-size:11px;color:rgba(255,255,255,0.5)">Reading device info...</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-bottom:14px">
                                <label style="font-size:11px;color:rgba(255,255,255,0.4);display:block;margin-bottom:4px">DEVICE NAME</label>
                                <input type="text" id="setup-longname" placeholder="e.g., John's Radio" maxlength="36"
                                    style="width:100%;padding:12px;font-size:14px" aria-label="Device long name">
                                <div style="font-size:10px;color:rgba(255,255,255,0.3);margin-top:4px">Visible to other mesh users (up to 36 characters)</div>
                            </div>
                            
                            <div class="form-group" style="margin-bottom:20px">
                                <label style="font-size:11px;color:rgba(255,255,255,0.4);display:block;margin-bottom:4px">SHORT ID (4 characters)</label>
                                <input type="text" id="setup-shortname" placeholder="e.g., JOHN" maxlength="4"
                                    style="width:100%;padding:12px;font-size:14px;text-transform:uppercase;letter-spacing:2px;font-family:monospace" aria-label="Device short name">
                                <div style="font-size:10px;color:rgba(255,255,255,0.3);margin-top:4px">Shown on node list and map markers</div>
                            </div>
                            
                            <div style="display:flex;gap:8px">
                                <button class="btn btn--secondary" id="setup-back-2" style="flex:1">‚Üê Back</button>
                                <button class="btn btn--primary" id="setup-next-2" style="flex:2">Continue ‚Üí</button>
                            </div>
                        </div>
                        
                        <!-- ===== STEP 3: REGION ===== -->
                        <div id="setup-step-3" class="setup-panel" style="display:none">
                            <div style="text-align:center;margin-bottom:16px">
                                <span style="font-size:48px">üåç</span>
                                <h4 style="margin:12px 0 4px">Select Region</h4>
                                <p style="font-size:12px;color:rgba(255,255,255,0.5)">
                                    This sets the radio frequency for legal operation in your area
                                </p>
                            </div>
                            
                            <div style="padding:10px;background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.15);border-radius:8px;margin-bottom:16px;font-size:11px;color:#fca5a5">
                                <strong>‚ö†Ô∏è Important:</strong> Operating on the wrong frequency may violate local radio regulations.
                                Select the region that matches your physical location.
                            </div>
                            
                            <div class="form-group" style="margin-bottom:20px">
                                <select id="setup-region" style="width:100%;padding:14px;font-size:14px" aria-label="Radio frequency region">
                                    ${regionOptions.map(r => `
                                        <option value="${r.value}" ${r.value === 1 ? 'selected' : ''}>${r.label}</option>
                                    `).join('')}
                                </select>
                            </div>
                            
                            <div id="setup-region-info" style="padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;margin-bottom:20px">
                                <div style="font-size:11px;color:rgba(255,255,255,0.4)">
                                    <div style="margin-bottom:4px"><strong>Common regions:</strong></div>
                                    <div>üá∫üá∏ US ‚Äî 915 MHz ISM band</div>
                                    <div>üá™üá∫ EU 868 ‚Äî 868 MHz SRD band</div>
                                    <div>üá¶üá∫ ANZ ‚Äî 915 MHz (Australia/NZ)</div>
                                    <div>üåê LoRa 2.4 GHz ‚Äî Worldwide, shorter range</div>
                                </div>
                            </div>
                            
                            <div style="display:flex;gap:8px">
                                <button class="btn btn--secondary" id="setup-back-3" style="flex:1">‚Üê Back</button>
                                <button class="btn btn--primary" id="setup-next-3" style="flex:2">Continue ‚Üí</button>
                            </div>
                        </div>
                        
                        <!-- ===== STEP 4: RADIO SETTINGS ===== -->
                        <div id="setup-step-4" class="setup-panel" style="display:none">
                            <div style="text-align:center;margin-bottom:16px">
                                <span style="font-size:48px">üìª</span>
                                <h4 style="margin:12px 0 4px">Radio Settings</h4>
                                <p style="font-size:12px;color:rgba(255,255,255,0.5)">
                                    Configure range vs speed tradeoff and power output
                                </p>
                            </div>
                            
                            <div class="form-group" style="margin-bottom:16px">
                                <label style="font-size:11px;color:rgba(255,255,255,0.4);display:block;margin-bottom:4px">MODEM PRESET</label>
                                <select id="setup-modem" style="width:100%;padding:12px;font-size:13px" aria-label="Modem preset">
                                    ${modemOptions.map(m => `
                                        <option value="${m.value}" ${m.value === 0 ? 'selected' : ''}>
                                            ${m.label}
                                        </option>
                                    `).join('')}
                                </select>
                                <div id="setup-modem-desc" style="font-size:10px;color:rgba(255,255,255,0.3);margin-top:4px">
                                    Default ‚Äî Good balance of range and speed
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-bottom:16px">
                                <label style="font-size:11px;color:rgba(255,255,255,0.4);display:block;margin-bottom:4px">
                                    TX POWER ‚Äî <span id="setup-txpower-label">Device Default</span>
                                </label>
                                <input type="range" id="setup-txpower" min="0" max="30" value="0" style="width:100%" aria-label="Transmit power">
                                <div style="display:flex;justify-content:space-between;font-size:10px;color:rgba(255,255,255,0.3)">
                                    <span>Default</span>
                                    <span>Max (30 dBm)</span>
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-bottom:16px">
                                <label style="font-size:11px;color:rgba(255,255,255,0.4);display:block;margin-bottom:4px">
                                    HOP LIMIT ‚Äî <span id="setup-hoplimit-label">3 hops</span>
                                </label>
                                <input type="range" id="setup-hoplimit" min="1" max="7" value="3" style="width:100%" aria-label="Hop limit">
                                <div style="display:flex;justify-content:space-between;font-size:10px;color:rgba(255,255,255,0.3)">
                                    <span>1 (direct)</span>
                                    <span>7 (max relay)</span>
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-bottom:20px">
                                <label style="font-size:11px;color:rgba(255,255,255,0.4);display:block;margin-bottom:4px">POSITION BROADCAST</label>
                                <select id="setup-pos-interval" style="width:100%;padding:10px;font-size:12px" aria-label="Position broadcast interval">
                                    <option value="60">Every 1 minute (active tracking)</option>
                                    <option value="120" selected>Every 2 minutes (recommended)</option>
                                    <option value="300">Every 5 minutes (battery saver)</option>
                                    <option value="900">Every 15 minutes (minimal)</option>
                                </select>
                            </div>
                            
                            <div style="display:flex;gap:8px">
                                <button class="btn btn--secondary" id="setup-back-4" style="flex:1">‚Üê Back</button>
                                <button class="btn btn--primary" id="setup-next-4" style="flex:2">Review & Apply ‚Üí</button>
                            </div>
                        </div>
                        
                        <!-- ===== STEP 5: REVIEW & APPLY ===== -->
                        <div id="setup-step-5" class="setup-panel" style="display:none">
                            <div style="text-align:center;margin-bottom:16px">
                                <span style="font-size:48px">‚úÖ</span>
                                <h4 style="margin:12px 0 4px">Review Configuration</h4>
                                <p style="font-size:12px;color:rgba(255,255,255,0.5)">
                                    Confirm settings before writing to device
                                </p>
                            </div>
                            
                            <div id="setup-review-card" style="padding:16px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:10px;margin-bottom:16px">
                                <!-- Filled dynamically -->
                            </div>
                            
                            <div id="setup-apply-status" style="display:none;text-align:center;padding:16px;margin-bottom:16px">
                            </div>
                            
                            <div id="setup-apply-actions" style="display:flex;gap:8px">
                                <button class="btn btn--secondary" id="setup-back-5" style="flex:1">‚Üê Back</button>
                                <button class="btn btn--primary" id="setup-apply-btn" style="flex:2">
                                    ‚ö° Write to Device
                                </button>
                            </div>
                            
                            <div id="setup-done-actions" style="display:none;gap:8px">
                                <button class="btn btn--primary" id="setup-done-btn" style="width:100%">
                                    ‚úì Done ‚Äî Start Using GridDown
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Add styles
        const style = document.createElement('style');
        style.id = 'device-setup-styles';
        style.textContent = `
            .setup-step { width:30px; height:30px; border-radius:50%; background:rgba(255,255,255,0.08);
                display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:600;
                color:rgba(255,255,255,0.3); transition:all 0.2s; }
            .setup-step.active { background:#f97316; color:white; }
            .setup-step.complete { background:#22c55e; color:white; }
            .setup-step-line.complete { background:#22c55e !important; }
        `;
        if (!document.getElementById('device-setup-styles')) {
            document.head.appendChild(style);
        }
        
        const closeModal = () => {
            modalContainer.innerHTML = '';
            renderTeam();
        };
        
        let currentStep = 1;
        
        function showStep(step) {
            document.querySelectorAll('.setup-panel').forEach(p => p.style.display = 'none');
            const panel = document.getElementById(`setup-step-${step}`);
            if (panel) panel.style.display = 'block';
            
            document.querySelectorAll('.setup-step').forEach(s => {
                const sNum = parseInt(s.dataset.setupStep);
                s.classList.remove('active', 'complete');
                if (sNum < step) s.classList.add('complete');
                if (sNum === step) s.classList.add('active');
            });
            document.querySelectorAll('.setup-step-line').forEach(l => {
                const lNum = parseInt(l.dataset.line);
                l.classList.toggle('complete', lNum < step);
            });
            currentStep = step;
        }
        
        function updateReviewCard() {
            const modemNames = {
                0: 'Long Fast (default)', 1: 'Long Slow', 2: 'Very Long Slow',
                3: 'Medium Slow', 4: 'Medium Fast', 5: 'Short Slow',
                6: 'Short Fast', 7: 'Long Moderate'
            };
            const regionName = regionOptions.find(r => r.value === setupState.region)?.label || 'Unknown';
            const modemName = modemNames[setupState.modemPreset] || 'Unknown';
            const posLabel = { 60: '1 min', 120: '2 min', 300: '5 min', 900: '15 min' }[setupState.positionBroadcastSecs] || setupState.positionBroadcastSecs + 's';
            
            const card = document.getElementById('setup-review-card');
            if (!card) return;
            card.innerHTML = `
                <div style="display:grid;grid-template-columns:auto 1fr;gap:8px 16px;font-size:12px">
                    <span style="color:rgba(255,255,255,0.4)">Name</span>
                    <span style="font-weight:600">${Helpers.escapeHtml(setupState.longName)} (${Helpers.escapeHtml(setupState.shortName)})</span>
                    
                    <span style="color:rgba(255,255,255,0.4)">Region</span>
                    <span>${Helpers.escapeHtml(regionName)}</span>
                    
                    <span style="color:rgba(255,255,255,0.4)">Modem</span>
                    <span>${modemName}</span>
                    
                    <span style="color:rgba(255,255,255,0.4)">TX Power</span>
                    <span>${setupState.txPower === 0 ? 'Device Default' : setupState.txPower + ' dBm'}</span>
                    
                    <span style="color:rgba(255,255,255,0.4)">Hop Limit</span>
                    <span>${setupState.hopLimit} hops</span>
                    
                    <span style="color:rgba(255,255,255,0.4)">Position</span>
                    <span>Every ${posLabel}</span>
                    
                    ${setupState.firmwareVersion ? `
                        <span style="color:rgba(255,255,255,0.4)">Firmware</span>
                        <span>${setupState.firmwareVersion}${setupState.hwModel ? ' ‚Ä¢ ' + setupState.hwModel : ''}</span>
                    ` : ''}
                </div>
            `;
        }
        
        async function connectDevice(type) {
            const statusEl = document.getElementById('setup-connect-status');
            statusEl.innerHTML = `
                <div style="display:flex;align-items:center;justify-content:center;gap:8px">
                    <div style="width:16px;height:16px;border:2px solid #f97316;border-top-color:transparent;border-radius:50%;animation:spin 0.8s linear infinite"></div>
                    <span style="color:#f97316;font-size:13px">Connecting via ${type === 'ble' ? 'Bluetooth' : 'USB'}...</span>
                </div>
            `;
            
            try {
                if (type === 'ble') {
                    await MeshtasticModule.connectBluetooth();
                } else {
                    await MeshtasticModule.connectSerial();
                }
                
                setupState.connected = true;
                setupState.connectionType = type;
                
                // Read current device config
                statusEl.innerHTML = `
                    <div style="display:flex;align-items:center;justify-content:center;gap:8px">
                        <div style="width:16px;height:16px;border:2px solid #22c55e;border-top-color:transparent;border-radius:50%;animation:spin 0.8s linear infinite"></div>
                        <span style="color:#22c55e;font-size:13px">Connected! Reading device configuration...</span>
                    </div>
                `;
                
                // Wait for config to arrive
                await new Promise(r => setTimeout(r, 1500));
                
                const config = typeof MeshtasticModule !== 'undefined'
                    ? MeshtasticModule.getDeviceConfig() : {};
                const connState = typeof MeshtasticModule !== 'undefined'
                    ? MeshtasticModule.getConnectionState() : {};
                
                setupState.firmwareVersion = config.firmwareVersion || null;
                setupState.hwModel = config.hwModelName || null;
                
                // Pre-fill from device if it has existing config
                if (config.region && config.region !== 0) setupState.region = config.region;
                if (config.modemPreset !== undefined) setupState.modemPreset = config.modemPreset;
                if (config.txPower) setupState.txPower = config.txPower;
                if (config.hopLimit) setupState.hopLimit = config.hopLimit;
                if (config.positionBroadcastSecs) setupState.positionBroadcastSecs = config.positionBroadcastSecs;
                
                // Pre-fill name from existing device or GridDown state
                if (connState.nodeName && connState.nodeName !== 'GridDown User') {
                    setupState.longName = connState.nodeName;
                    setupState.shortName = connState.shortName || '';
                }
                
                // Update device info card on step 2
                const detailsEl = document.getElementById('setup-device-details');
                if (detailsEl) {
                    detailsEl.textContent = [
                        config.firmwareVersion ? `Firmware ${config.firmwareVersion}` : null,
                        config.hwModelName || null,
                        `via ${type === 'ble' ? 'Bluetooth' : 'USB'}`
                    ].filter(Boolean).join(' ‚Ä¢ ');
                }
                
                // Pre-fill form fields
                const longNameInput = document.getElementById('setup-longname');
                const shortNameInput = document.getElementById('setup-shortname');
                if (longNameInput && setupState.longName) longNameInput.value = setupState.longName;
                if (shortNameInput && setupState.shortName) shortNameInput.value = setupState.shortName;
                
                const regionSelect = document.getElementById('setup-region');
                if (regionSelect && setupState.region) regionSelect.value = setupState.region;
                
                const modemSelect = document.getElementById('setup-modem');
                if (modemSelect) modemSelect.value = setupState.modemPreset;
                
                const txSlider = document.getElementById('setup-txpower');
                if (txSlider) txSlider.value = setupState.txPower;
                
                const hopSlider = document.getElementById('setup-hoplimit');
                if (hopSlider) hopSlider.value = setupState.hopLimit;
                
                const posSelect = document.getElementById('setup-pos-interval');
                if (posSelect) posSelect.value = setupState.positionBroadcastSecs;
                
                showStep(2);
                
            } catch (err) {
                statusEl.innerHTML = `
                    <div style="padding:12px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.2);border-radius:8px">
                        <div style="font-size:13px;font-weight:600;color:#ef4444;margin-bottom:4px">Connection Failed</div>
                        <div style="font-size:11px;color:rgba(255,255,255,0.5)">${Helpers.escapeHtml(err.message)}</div>
                        <div style="font-size:10px;color:rgba(255,255,255,0.3);margin-top:8px">
                            Make sure the device is powered on, not connected to another app, and in range.
                        </div>
                    </div>
                `;
            }
        }
        
        async function applyConfig() {
            const statusEl = document.getElementById('setup-apply-status');
            const actionsEl = document.getElementById('setup-apply-actions');
            const doneEl = document.getElementById('setup-done-actions');
            
            statusEl.style.display = 'block';
            actionsEl.style.display = 'none';
            
            // Show single "writing" status ‚Äî the device WILL reboot mid-write
            // when LoRa config changes are committed. This is normal firmware behavior.
            // We treat BLE disconnect during write as success (= device is rebooting to apply).
            statusEl.innerHTML = `
                <div style="display:flex;align-items:center;justify-content:center;gap:8px">
                    <div style="width:16px;height:16px;border:2px solid #f97316;border-top-color:transparent;border-radius:50%;animation:spin 0.8s linear infinite"></div>
                    <span style="color:#f97316;font-size:12px">Writing configuration to device...</span>
                </div>
                <div style="margin-top:8px;height:4px;background:rgba(255,255,255,0.1);border-radius:2px;overflow:hidden">
                    <div style="height:100%;width:10%;background:#f97316;border-radius:2px;transition:width 0.3s"></div>
                </div>
                <div style="font-size:10px;color:rgba(255,255,255,0.3);text-align:center;margin-top:8px">
                    Device will reboot automatically to apply radio changes
                </div>
            `;
            
            // Set local GridDown name (always succeeds, no device write)
            await MeshtasticModule.setUserName(setupState.longName, setupState.shortName);
            
            let configWritten = false;
            
            // Build config payloads
            const posConfig = {};
            if (setupState.positionBroadcastSecs) posConfig.positionBroadcastSecs = setupState.positionBroadcastSecs;
            posConfig.gpsUpdateInterval = Math.max(30, Math.floor(setupState.positionBroadcastSecs / 2));
            if (setupState.gpsEnabled !== undefined) posConfig.gpsEnabled = setupState.gpsEnabled;
            
            const loraValue = {};
            if (setupState.region !== undefined) loraValue.region = setupState.region;
            if (setupState.modemPreset !== undefined) {
                loraValue.modemPreset = setupState.modemPreset;
                loraValue.usePreset = true;
            }
            if (setupState.txPower !== undefined) loraValue.txPower = setupState.txPower;
            if (setupState.hopLimit !== undefined) loraValue.hopLimit = setupState.hopLimit;
            
            try {
                if (typeof MeshtasticClient !== 'undefined' && MeshtasticClient.batchWriteConfigs) {
                    // === Single call through public API ===
                    // batchWriteConfigs handles internally:
                    //   beginEditSettings ‚Üí setOwner ‚Üí setConfig(position)
                    //   ‚Üí setConfig(lora) ‚Üí commitEditSettings
                    // All in ONE edit session via the internal device reference.
                    // commitEditSettings will trigger auto-reboot on RAK and most
                    // Meshtastic firmwares when LoRa changes are detected.
                    // BLE disconnect = device is rebooting = success.
                    await MeshtasticClient.batchWriteConfigs(
                        [
                            { payloadVariant: { case: 'position', value: posConfig } },
                            { payloadVariant: { case: 'lora', value: loraValue } }
                        ],
                        500, // delay between writes
                        {    // ownerInfo ‚Äî written inside the same edit session
                            longName: setupState.longName,
                            shortName: setupState.shortName || setupState.longName.substring(0, 4).toUpperCase()
                        }
                    );
                    
                    // If we reach here, firmware didn't auto-reboot. Trigger manually.
                    try {
                        await MeshtasticClient.rebootDevice(2);
                    } catch (rebootErr) {
                        // BLE disconnect during reboot = expected
                        console.log('[DeviceSetup] Reboot disconnect (expected):', rebootErr.message);
                    }
                    
                    configWritten = true;
                    
                } else {
                    // Fallback: no batchWriteConfigs ‚Äî use individual calls with try/catch each
                    if (typeof MeshtasticClient !== 'undefined' && MeshtasticClient.setOwner) {
                        try { await MeshtasticClient.setOwner(setupState.longName, setupState.shortName); } catch (e) { /* non-fatal */ }
                        await new Promise(r => setTimeout(r, 500));
                    }
                    if (typeof MeshtasticClient !== 'undefined' && MeshtasticClient.setPositionConfig) {
                        try {
                            await MeshtasticClient.setPositionConfig(
                                setupState.positionBroadcastSecs,
                                Math.max(30, Math.floor(setupState.positionBroadcastSecs / 2)),
                                setupState.gpsEnabled
                            );
                        } catch (e) { /* may disconnect */ }
                        await new Promise(r => setTimeout(r, 1000));
                    }
                    try {
                        await MeshtasticModule.setRadioConfig({
                            region: setupState.region,
                            modemPreset: setupState.modemPreset,
                            txPower: setupState.txPower,
                            hopLimit: setupState.hopLimit
                        });
                    } catch (e) { /* will likely disconnect on reboot */ }
                    configWritten = true;
                }
                
            } catch (err) {
                // BLE disconnect during config write = the device rebooted to apply LoRa changes.
                // This is EXPECTED and means the config was written successfully.
                const msg = (err.message || '').toLowerCase();
                if (msg.includes('disconnect') || msg.includes('gatt') || msg.includes('bluetooth') ||
                    msg.includes('not connected') || msg.includes('network error') ||
                    msg.includes('connection') || msg.includes('abort')) {
                    console.log('[DeviceSetup] BLE disconnected during config write ‚Äî device is rebooting (expected)');
                    configWritten = true;
                } else {
                    console.error('[DeviceSetup] Unexpected config write error:', err);
                }
            }
            
            // Update GridDown local state
            if (typeof MeshtasticModule !== 'undefined') {
                const dc = MeshtasticModule.getDeviceConfig();
                if (dc) {
                    dc.region = setupState.region;
                    dc.modemPreset = setupState.modemPreset;
                    dc.txPower = setupState.txPower;
                    dc.hopLimit = setupState.hopLimit;
                    dc.positionBroadcastSecs = setupState.positionBroadcastSecs;
                }
            }
            
            if (configWritten) {
                statusEl.innerHTML = `
                    <div style="padding:16px;background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.2);border-radius:10px">
                        <div style="font-size:32px;text-align:center;margin-bottom:8px">üéâ</div>
                        <div style="font-size:14px;font-weight:600;color:#22c55e;text-align:center;margin-bottom:4px">
                            Device Configured Successfully!
                        </div>
                        <div style="font-size:11px;color:rgba(255,255,255,0.5);text-align:center">
                            Your device is rebooting to apply radio configuration.
                            It will rejoin the mesh automatically in a few seconds.
                        </div>
                    </div>
                `;
                doneEl.style.display = 'flex';
            } else {
                statusEl.innerHTML = `
                    <div style="padding:16px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.2);border-radius:10px">
                        <div style="font-size:14px;font-weight:600;color:#ef4444;text-align:center;margin-bottom:4px">
                            Configuration failed
                        </div>
                        <div style="font-size:11px;color:rgba(255,255,255,0.5);text-align:center">
                            Could not write settings to device. Check the console for details.
                        </div>
                    </div>
                `;
                doneEl.style.display = 'flex';
            }
        }
        
        // === EVENT HANDLERS ===
        
        document.getElementById('modal-close').onclick = closeModal;
        document.getElementById('modal-backdrop').onclick = (e) => {
            if (e.target.id === 'modal-backdrop') closeModal();
        };
        
        // Step 1: Connect
        document.getElementById('setup-connect-ble').onclick = () => connectDevice('ble');
        document.getElementById('setup-connect-serial').onclick = () => connectDevice('serial');
        
        // Step 2: Identity
        document.getElementById('setup-back-2').onclick = () => showStep(1);
        document.getElementById('setup-next-2').onclick = () => {
            const longName = document.getElementById('setup-longname').value.trim();
            const shortName = document.getElementById('setup-shortname').value.trim().toUpperCase();
            
            if (!longName) {
                ModalsModule.showToast('Please enter a device name', 'error');
                return;
            }
            
            setupState.longName = longName;
            setupState.shortName = shortName || longName.substring(0, 4).toUpperCase();
            showStep(3);
        };
        
        // Auto-fill short name from long name
        document.getElementById('setup-longname').addEventListener('input', (e) => {
            const shortInput = document.getElementById('setup-shortname');
            if (!shortInput.value || shortInput.dataset.autoFilled === 'true') {
                shortInput.value = e.target.value.substring(0, 4).toUpperCase();
                shortInput.dataset.autoFilled = 'true';
            }
        });
        document.getElementById('setup-shortname').addEventListener('input', () => {
            document.getElementById('setup-shortname').dataset.autoFilled = 'false';
        });
        
        // Step 3: Region
        document.getElementById('setup-back-3').onclick = () => showStep(2);
        document.getElementById('setup-next-3').onclick = () => {
            setupState.region = parseInt(document.getElementById('setup-region').value);
            showStep(4);
        };
        
        // Step 4: Radio
        document.getElementById('setup-back-4').onclick = () => showStep(3);
        
        document.getElementById('setup-modem').onchange = (e) => {
            setupState.modemPreset = parseInt(e.target.value);
            const descriptions = {
                0: 'Default ‚Äî Good balance of range and speed',
                1: 'Maximum range, slower message delivery',
                2: 'Extreme range, very slow ‚Äî best for remote areas',
                3: 'Balanced range and speed',
                4: 'Faster messages, reduced range',
                5: 'Dense areas with many nodes',
                6: 'High throughput, shortest range',
                7: 'Long range with better speed than Long Slow'
            };
            const descEl = document.getElementById('setup-modem-desc');
            if (descEl) descEl.textContent = descriptions[setupState.modemPreset] || '';
        };
        
        document.getElementById('setup-txpower').oninput = (e) => {
            setupState.txPower = parseInt(e.target.value);
            const label = document.getElementById('setup-txpower-label');
            if (label) label.textContent = setupState.txPower === 0 ? 'Device Default' : `${setupState.txPower} dBm`;
        };
        
        document.getElementById('setup-hoplimit').oninput = (e) => {
            setupState.hopLimit = parseInt(e.target.value);
            const label = document.getElementById('setup-hoplimit-label');
            if (label) label.textContent = `${setupState.hopLimit} hop${setupState.hopLimit !== 1 ? 's' : ''}`;
        };
        
        document.getElementById('setup-next-4').onclick = () => {
            setupState.modemPreset = parseInt(document.getElementById('setup-modem').value);
            setupState.txPower = parseInt(document.getElementById('setup-txpower').value);
            setupState.hopLimit = parseInt(document.getElementById('setup-hoplimit').value);
            setupState.positionBroadcastSecs = parseInt(document.getElementById('setup-pos-interval').value);
            updateReviewCard();
            showStep(5);
        };
        
        // Step 5: Review & Apply
        document.getElementById('setup-back-5').onclick = () => showStep(4);
        document.getElementById('setup-apply-btn').onclick = () => applyConfig();
        
        // Done button
        const doneEl = document.getElementById('setup-done-btn');
        if (doneEl) {
            doneEl.onclick = closeModal;
        }
    }
    
    /**
     * Open First-Run Wizard Modal
     */
    function openMeshWizardModal() {
        // Uses cached modalContainer ref
        
        const scenarios = typeof MeshtasticModule !== 'undefined'
            ? MeshtasticModule.getScenarioPresets()
            : [];
        
        const regionOptions = typeof MeshtasticModule !== 'undefined'
            ? MeshtasticModule.getRegionOptions()
            : [];
        
        const apiSupport = typeof MeshtasticModule !== 'undefined'
            ? MeshtasticModule.checkApiSupport()
            : { bluetooth: false, serial: false };
        
        modalContainer.innerHTML = `
            <div class="modal-backdrop" id="mesh-wizard-modal">
                <div class="modal" role="dialog" aria-modal="true" style="max-width:500px">
                    <div class="modal__header">
                        <h3 class="modal__title">üì° Meshtastic Quick Setup</h3>
                        <button class="modal__close" id="close-wizard-modal" aria-label="Close dialog">&times;</button>
                    </div>
                    <div class="modal__content">
                        <!-- Step indicator -->
                        <div style="display:flex;justify-content:center;gap:8px;margin-bottom:20px">
                            <div class="wizard-step active" data-step="1">1</div>
                            <div class="wizard-step" data-step="2">2</div>
                            <div class="wizard-step" data-step="3">3</div>
                            <div class="wizard-step" data-step="4">4</div>
                        </div>
                        
                        <!-- Step 1: Name -->
                        <div id="wizard-step-1" class="wizard-panel">
                            <div style="text-align:center;margin-bottom:20px">
                                <span style="font-size:48px">üë§</span>
                                <h4 style="margin:12px 0 4px">Your Identity</h4>
                                <p style="font-size:12px;color:rgba(255,255,255,0.5)">How you'll appear on the mesh network</p>
                            </div>
                            
                            <div style="margin-bottom:16px">
                                <label style="font-size:11px;color:rgba(255,255,255,0.4);display:block;margin-bottom:4px">YOUR NAME</label>
                                <input type="text" id="wizard-longname" placeholder="John Smith" style="width:100%;padding:12px;font-size:14px">
                            </div>
                            
                            <div style="margin-bottom:20px">
                                <label style="font-size:11px;color:rgba(255,255,255,0.4);display:block;margin-bottom:4px">SHORT ID (4 chars max)</label>
                                <input type="text" id="wizard-shortname" placeholder="JOHN" maxlength="4" style="width:100%;padding:12px;font-size:14px;text-transform:uppercase">
                            </div>
                            
                            <button class="btn btn--primary btn--full" id="wizard-next-1">
                                Continue ‚Üí
                            </button>
                        </div>
                        
                        <!-- Step 2: Region -->
                        <div id="wizard-step-2" class="wizard-panel" style="display:none">
                            <div style="text-align:center;margin-bottom:20px">
                                <span style="font-size:48px">üåç</span>
                                <h4 style="margin:12px 0 4px">Select Region</h4>
                                <p style="font-size:12px;color:rgba(255,255,255,0.5)">Required for legal radio operation</p>
                            </div>
                            
                            <div style="margin-bottom:20px">
                                <select id="wizard-region" style="width:100%;padding:12px;font-size:14px">
                                    ${regionOptions.map(r => `
                                        <option value="${r.value}" ${r.value === 1 ? 'selected' : ''}>${r.label}</option>
                                    `).join('')}
                                </select>
                            </div>
                            
                            <div style="display:flex;gap:8px">
                                <button class="btn btn--secondary" id="wizard-back-2" style="flex:1">‚Üê Back</button>
                                <button class="btn btn--primary" id="wizard-next-2" style="flex:2">Continue ‚Üí</button>
                            </div>
                        </div>
                        
                        <!-- Step 3: Pair Device -->
                        <div id="wizard-step-3" class="wizard-panel" style="display:none">
                            <div style="text-align:center;margin-bottom:20px">
                                <span style="font-size:48px">üì°</span>
                                <h4 style="margin:12px 0 4px">Connect Device</h4>
                                <p style="font-size:12px;color:rgba(255,255,255,0.5)">Pair your Meshtastic radio</p>
                            </div>
                            
                            <div style="display:flex;gap:12px;margin-bottom:20px">
                                <button class="btn btn--primary" id="wizard-connect-ble" style="flex:1;padding:20px" ${!apiSupport.bluetooth ? 'disabled' : ''}>
                                    <div style="font-size:24px;margin-bottom:8px">üì∂</div>
                                    Bluetooth
                                </button>
                                <button class="btn btn--secondary" id="wizard-connect-serial" style="flex:1;padding:20px" ${!apiSupport.serial ? 'disabled' : ''}>
                                    <div style="font-size:24px;margin-bottom:8px">üîå</div>
                                    USB/Serial
                                </button>
                            </div>
                            
                            <div id="wizard-connection-status" style="text-align:center;padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;margin-bottom:16px">
                                <span style="color:rgba(255,255,255,0.5)">Not connected</span>
                            </div>
                            
                            <div style="display:flex;gap:8px">
                                <button class="btn btn--secondary" id="wizard-back-3" style="flex:1">‚Üê Back</button>
                                <button class="btn btn--secondary" id="wizard-skip-3" style="flex:1">Skip for now</button>
                            </div>
                        </div>
                        
                        <!-- Step 4: Scenario -->
                        <div id="wizard-step-4" class="wizard-panel" style="display:none">
                            <div style="text-align:center;margin-bottom:20px">
                                <span style="font-size:48px">üéØ</span>
                                <h4 style="margin:12px 0 4px">Choose Scenario</h4>
                                <p style="font-size:12px;color:rgba(255,255,255,0.5)">Optimized settings for your use case</p>
                            </div>
                            
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:20px">
                                ${scenarios.filter(s => s.id !== 'custom').map(s => `
                                    <button class="btn btn--secondary wizard-scenario-btn" data-scenario="${s.id}" style="padding:12px;text-align:left">
                                        <div style="font-size:20px;margin-bottom:4px">${s.icon}</div>
                                        <div style="font-size:12px;font-weight:600">${s.name}</div>
                                        <div style="font-size:10px;color:rgba(255,255,255,0.5)">${s.description}</div>
                                    </button>
                                `).join('')}
                            </div>
                            
                            <div style="display:flex;gap:8px">
                                <button class="btn btn--secondary" id="wizard-back-4" style="flex:1">‚Üê Back</button>
                                <button class="btn btn--primary" id="wizard-finish" style="flex:2">Complete Setup ‚úì</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Add wizard step styles
        const style = document.createElement('style');
        style.textContent = `
            .wizard-step { width:28px; height:28px; border-radius:50%; background:rgba(255,255,255,0.1); display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:600; }
            .wizard-step.active { background:#f97316; color:white; }
            .wizard-step.complete { background:#22c55e; color:white; }
            .wizard-scenario-btn.selected { border-color:#f97316; background:rgba(249,115,22,0.1); }
        `;
        document.head.appendChild(style);
        
        let currentStep = 1;
        let selectedScenario = 'field_exercise';
        
        function showStep(step) {
            document.querySelectorAll('.wizard-panel').forEach(p => p.style.display = 'none');
            document.getElementById(`wizard-step-${step}`).style.display = 'block';
            
            document.querySelectorAll('.wizard-step').forEach((s, i) => {
                s.classList.remove('active', 'complete');
                if (i + 1 < step) s.classList.add('complete');
                if (i + 1 === step) s.classList.add('active');
            });
            currentStep = step;
        }
        
        // Event handlers
        document.getElementById('close-wizard-modal').onclick = () => modalContainer.innerHTML = '';
        document.getElementById('mesh-wizard-modal').onclick = (e) => {
            if (e.target.id === 'mesh-wizard-modal') modalContainer.innerHTML = '';
        };
        
        // Navigation
        document.getElementById('wizard-next-1').onclick = () => {
            const longName = document.getElementById('wizard-longname').value.trim();
            const shortName = document.getElementById('wizard-shortname').value.trim().toUpperCase();
            if (longName && typeof MeshtasticModule !== 'undefined') {
                MeshtasticModule.setUserName(longName, shortName || longName.substring(0, 4).toUpperCase());
            }
            showStep(2);
        };
        
        document.getElementById('wizard-back-2').onclick = () => showStep(1);
        document.getElementById('wizard-next-2').onclick = () => {
            const region = parseInt(document.getElementById('wizard-region').value);
            if (typeof MeshtasticModule !== 'undefined') {
                MeshtasticModule.setRegion(region);
            }
            showStep(3);
        };
        
        document.getElementById('wizard-back-3').onclick = () => showStep(2);
        document.getElementById('wizard-skip-3').onclick = () => showStep(4);
        
        document.getElementById('wizard-connect-ble').onclick = async () => {
            const statusEl = domCache.get('wizard-connection-status');
            statusEl.innerHTML = '<span style="color:#f59e0b">Connecting...</span>';
            try {
                await MeshtasticModule.connectBluetooth();
                statusEl.innerHTML = '<span style="color:#22c55e">‚úì Connected!</span>';
                setTimeout(() => showStep(4), 1000);
            } catch (e) {
                statusEl.innerHTML = `<span style="color:#ef4444">Failed: ${Helpers.escapeHtml(e.message)}</span>`;
            }
        };
        
        document.getElementById('wizard-connect-serial').onclick = async () => {
            const statusEl = domCache.get('wizard-connection-status');
            statusEl.innerHTML = '<span style="color:#f59e0b">Connecting...</span>';
            try {
                await MeshtasticModule.connectSerial();
                statusEl.innerHTML = '<span style="color:#22c55e">‚úì Connected!</span>';
                setTimeout(() => showStep(4), 1000);
            } catch (e) {
                statusEl.innerHTML = `<span style="color:#ef4444">Failed: ${Helpers.escapeHtml(e.message)}</span>`;
            }
        };
        
        document.getElementById('wizard-back-4').onclick = () => showStep(3);
        
        // Scenario selection
        document.querySelectorAll('.wizard-scenario-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.wizard-scenario-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedScenario = btn.dataset.scenario;
            };
        });
        
        document.getElementById('wizard-finish').onclick = async () => {
            if (typeof MeshtasticModule !== 'undefined') {
                await MeshtasticModule.applyScenarioPreset(selectedScenario);
                await MeshtasticModule.completeWizard();
            }
            modalContainer.innerHTML = '';
            ModalsModule.showToast('Setup complete! You\'re ready to mesh.', 'success');
            renderTeam();
        };
    }
    
    // =========================================================================
    // PHASE 1: MESHTASTIC CONFIGURATION MODAL
    // =========================================================================
    
    /**
     * Open Meshtastic Device Configuration Modal
     */
    function openMeshConfigModal() {
        // Uses cached modalContainer ref
        
        // Get current config
        const config = typeof MeshtasticModule !== 'undefined' 
            ? MeshtasticModule.getDeviceConfig() 
            : {};
        
        // Get options
        const regionOptions = typeof MeshtasticModule !== 'undefined'
            ? MeshtasticModule.getRegionOptions()
            : [];
        
        const modemOptions = typeof MeshtasticModule !== 'undefined'
            ? MeshtasticModule.getModemPresetOptions()
            : [];
        
        // Get firmware status
        const firmwareStatus = typeof MeshtasticModule !== 'undefined'
            ? MeshtasticModule.getMyFirmwareStatus()
            : { status: 'unknown', message: 'Not connected' };
        
        // Get nodes for signal quality display
        const nodes = typeof MeshtasticModule !== 'undefined'
            ? MeshtasticModule.getNodes()
            : [];
        
        modalContainer.innerHTML = `
            <div class="modal-backdrop" id="modal-backdrop" role="presentation">
                <div class="modal" role="dialog" aria-modal="true" style="max-width:500px;display:flex;flex-direction:column;max-height:85vh">
                    <div class="modal__header">
                        <h3 class="modal__title">‚öôÔ∏è Meshtastic Configuration</h3>
                        <button class="modal__close" id="modal-close" aria-label="Close dialog">${Icons.get('close')}</button>
                    </div>
                    <div class="modal__body" style="flex:1;min-height:0;overflow-y:auto;padding:16px">
                        
                        <!-- Firmware Status -->
                        <div style="padding:12px;background:${firmwareStatus.status === 'current' ? 'rgba(34,197,94,0.1)' : firmwareStatus.status === 'outdated' ? 'rgba(239,68,68,0.1)' : 'rgba(249,115,22,0.1)'};border:1px solid ${firmwareStatus.color || 'rgba(255,255,255,0.1)'}44;border-radius:10px;margin-bottom:16px">
                            <div style="display:flex;align-items:center;gap:10px">
                                <span style="font-size:24px">${firmwareStatus.status === 'current' ? '‚úÖ' : firmwareStatus.status === 'outdated' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}</span>
                                <div>
                                    <div style="font-size:13px;font-weight:600;color:${firmwareStatus.color || 'inherit'}">
                                        Firmware: ${config.firmwareVersion || 'Unknown'}
                                    </div>
                                    <div style="font-size:11px;color:rgba(255,255,255,0.5)">
                                        ${firmwareStatus.message}
                                    </div>
                                </div>
                            </div>
                            ${config.hwModelName ? `
                                <div style="font-size:10px;color:rgba(255,255,255,0.4);margin-top:8px">
                                    Hardware: ${config.hwModelName}
                                    ${config.hasGPS ? ' ‚Ä¢ GPS' : ''}
                                    ${config.hasWifi ? ' ‚Ä¢ WiFi' : ''}
                                    ${config.hasBluetooth ? ' ‚Ä¢ BLE' : ''}
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- Radio Configuration -->
                        <div class="section-label">üìª Radio Settings</div>
                        
                        <div class="form-group">
                            <label>Region</label>
                            <select id="mesh-config-region" style="width:100%;padding:10px;font-size:13px">
                                ${regionOptions.map(opt => `
                                    <option value="${opt.value}" ${config.region === opt.value ? 'selected' : ''}>
                                        ${opt.label}
                                    </option>
                                `).join('')}
                            </select>
                            <div style="font-size:10px;color:rgba(255,255,255,0.4);margin-top:4px">
                                ‚ö†Ô∏è Must match your local regulations
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Modem Preset</label>
                            <select id="mesh-config-modem" style="width:100%;padding:10px;font-size:13px">
                                ${modemOptions.map(opt => `
                                    <option value="${opt.value}" ${config.modemPreset === opt.value ? 'selected' : ''}>
                                        ${opt.name} (${opt.range} range, ${opt.speed})
                                    </option>
                                `).join('')}
                            </select>
                            <div style="font-size:10px;color:rgba(255,255,255,0.4);margin-top:4px">
                                All devices in your mesh must use the same preset
                            </div>
                        </div>
                        
                        <div style="display:flex;gap:12px">
                            <div class="form-group" style="flex:1">
                                <label>TX Power (dBm)</label>
                                <select id="mesh-config-txpower" style="width:100%;padding:10px;font-size:13px">
                                    <option value="0" ${config.txPower === 0 ? 'selected' : ''}>Device Default</option>
                                    ${[1, 2, 5, 7, 10, 12, 14, 17, 20, 22, 27, 30].map(p => `
                                        <option value="${p}" ${config.txPower === p ? 'selected' : ''}>${p} dBm</option>
                                    `).join('')}
                                </select>
                            </div>
                            <div class="form-group" style="flex:1">
                                <label>Hop Limit</label>
                                <select id="mesh-config-hoplimit" style="width:100%;padding:10px;font-size:13px">
                                    ${[1, 2, 3, 4, 5, 6, 7].map(h => `
                                        <option value="${h}" ${config.hopLimit === h ? 'selected' : ''}>${h} hops</option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>
                        
                        <div style="padding:10px;background:rgba(59,130,246,0.1);border-radius:8px;font-size:11px;color:rgba(255,255,255,0.6);margin-bottom:16px">
                            üí° <strong>Hop Limit:</strong> Higher = longer range but more battery drain. 3 is recommended for most use cases.
                        </div>
                        
                        <!-- Channel Management -->
                        <div class="section-label" style="margin-top:16px">üì° Channel Export</div>
                        
                        <div style="display:flex;gap:8px;margin-bottom:16px">
                            <button class="btn btn--secondary" id="mesh-export-channel-btn" style="flex:1;font-size:12px">
                                üì§ Export Channel URL
                            </button>
                            <button class="btn btn--secondary" id="mesh-show-qr-btn" style="flex:1;font-size:12px">
                                üì± Show QR Code
                            </button>
                        </div>
                        
                        <!-- Node Signal Quality -->
                        ${nodes.length > 0 ? `
                            <div class="section-label" style="margin-top:16px">üì∂ Node Signal Quality</div>
                            <div style="max-height:150px;overflow-y:auto;background:rgba(0,0,0,0.2);border-radius:8px;padding:8px">
                                ${nodes.filter(n => n.id !== MeshtasticModule.getConnectionState().nodeId).map(node => {
                                    const signalColor = getMeshSignalColor(node.signalQuality);
                                    return `
                                        <div style="display:flex;align-items:center;justify-content:space-between;padding:8px;background:rgba(255,255,255,0.03);border-radius:6px;margin-bottom:4px">
                                            <div>
                                                <div style="font-size:12px;font-weight:500">${node.name || node.shortName || 'Unknown'}</div>
                                                <div style="font-size:10px;color:rgba(255,255,255,0.4)">
                                                    ${node.hwModelName || ''} ${node.firmwareVersion ? `‚Ä¢ v${node.firmwareVersion}` : ''}
                                                </div>
                                            </div>
                                            <div style="text-align:right">
                                                <div style="font-size:11px;font-weight:500;color:${signalColor}">
                                                    ${node.signalQuality ? node.signalQuality.toUpperCase() : 'N/A'}
                                                </div>
                                                <div style="font-size:9px;color:rgba(255,255,255,0.4)">
                                                    ${node.snr !== undefined ? `SNR: ${node.snr.toFixed(1)}dB` : ''}
                                                    ${node.rssi !== undefined ? ` RSSI: ${node.rssi}dBm` : ''}
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('') || '<div style="padding:12px;text-align:center;color:rgba(255,255,255,0.4);font-size:11px">No other nodes detected</div>'}
                            </div>
                        ` : ''}
                        
                        <!-- Reset / Danger Zone -->
                        <div class="section-label" style="margin-top:24px;color:#ef4444">‚ö†Ô∏è Reset</div>
                        <div style="padding:12px;background:rgba(239,68,68,0.06);border:1px solid rgba(239,68,68,0.15);border-radius:10px">
                            <div style="display:flex;gap:8px;align-items:stretch">
                                <div style="flex:1">
                                    <button class="btn btn--secondary" id="mesh-reset-app-btn" style="width:100%;font-size:12px;border-color:rgba(239,68,68,0.3);color:#f87171">
                                        üóëÔ∏è Reset App Data
                                    </button>
                                    <div style="font-size:9px;color:rgba(255,255,255,0.35);margin-top:4px;text-align:center">
                                        Clears messages, keys, channels
                                    </div>
                                </div>
                                <div style="flex:1">
                                    <button class="btn btn--secondary" id="mesh-factory-reset-btn" style="width:100%;font-size:12px;border-color:rgba(239,68,68,0.3);color:#f87171" ${!(typeof MeshtasticModule !== 'undefined' && MeshtasticModule.isConnected()) ? 'disabled title="Connect to a device first"' : ''}>
                                        üîÑ Factory Reset Device
                                    </button>
                                    <div style="font-size:9px;color:rgba(255,255,255,0.35);margin-top:4px;text-align:center">
                                        Erases all device settings
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                    <div class="modal__footer">
                        <button class="btn btn--secondary" id="modal-cancel">Cancel</button>
                        <button class="btn btn--primary" id="modal-save-config">Save Configuration</button>
                    </div>
                </div>
            </div>
        `;
        
        const closeModal = () => { modalContainer.innerHTML = ''; };
        
        // Close handlers ‚Äî use getElementById directly for reliability
        const closeBtn = document.getElementById('modal-close');
        const cancelBtn = document.getElementById('modal-cancel');
        const backdropEl = document.getElementById('modal-backdrop');
        
        if (closeBtn) closeBtn.onclick = closeModal;
        if (cancelBtn) cancelBtn.onclick = closeModal;
        if (backdropEl) backdropEl.onclick = (e) => {
            if (e.target.id === 'modal-backdrop') closeModal();
        };
        
        // Save config ‚Äî always close modal afterward
        document.getElementById('modal-save-config').onclick = async () => {
            try {
                const region = parseInt(document.getElementById('mesh-config-region').value);
                const modemPreset = parseInt(document.getElementById('mesh-config-modem').value);
                const txPower = parseInt(document.getElementById('mesh-config-txpower').value);
                const hopLimit = parseInt(document.getElementById('mesh-config-hoplimit').value);
                
                // Single batch write + reboot (instead of 4 individual writes)
                await MeshtasticModule.setRadioConfig({ region, modemPreset, txPower, hopLimit });
                
                ModalsModule.showToast('Configuration saved ‚Äî device rebooting to apply radio changes', 'success');
            } catch (err) {
                ModalsModule.showToast('Failed to save: ' + err.message, 'error');
            }
            closeModal();
            renderTeam();
        };
        
        // Export channel URL
        document.getElementById('mesh-export-channel-btn').onclick = () => {
            const activeChannel = MeshtasticModule.getActiveChannel();
            if (!activeChannel) {
                ModalsModule.showToast('No active channel', 'error');
                return;
            }
            const urls = MeshtasticModule.exportChannelAsUrl(activeChannel.id);
            if (!urls || !urls.web) {
                ModalsModule.showToast('Could not generate channel URL', 'error');
                return;
            }
            
            // Copy to clipboard with safe fallback
            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(urls.web).then(() => {
                        ModalsModule.showToast('Channel URL copied to clipboard', 'success');
                    }).catch(() => {
                        prompt('Channel URL:', urls.web);
                    });
                } else {
                    // Clipboard API not available (non-HTTPS, older browser, etc.)
                    prompt('Channel URL:', urls.web);
                }
            } catch (e) {
                prompt('Channel URL:', urls.web);
            }
        };
        
        // Show QR code using QRGenerator
        document.getElementById('mesh-show-qr-btn').onclick = () => {
            const activeChannel = MeshtasticModule.getActiveChannel();
            if (!activeChannel) {
                ModalsModule.showToast('No active channel', 'error');
                return;
            }
            const urls = MeshtasticModule.exportChannelAsUrl(activeChannel.id);
            if (!urls) {
                ModalsModule.showToast('Could not generate channel URL', 'error');
                return;
            }
            
            // Use QRGenerator if available, otherwise fall back to clipboard copy
            if (typeof QRGenerator !== 'undefined' && QRGenerator.toDataURL) {
                try {
                    const qrDataUrl = QRGenerator.toDataURL(urls.web, 5);
                    
                    // Show QR code in a sub-modal overlay
                    const qrOverlay = document.createElement('div');
                    qrOverlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:10001;cursor:pointer';
                    qrOverlay.innerHTML = `
                        <div style="background:#1a1a2e;border-radius:16px;padding:24px;text-align:center;max-width:320px;width:90%" onclick="event.stopPropagation()">
                            <div style="font-size:14px;font-weight:600;margin-bottom:12px;color:#e2e8f0">üì± Scan to Join Channel</div>
                            <div style="background:white;border-radius:12px;padding:16px;display:inline-block;margin-bottom:12px">
                                <img src="${qrDataUrl}" alt="Channel QR Code" style="display:block;image-rendering:pixelated;width:200px;height:200px">
                            </div>
                            <div style="font-size:10px;color:rgba(255,255,255,0.4);margin-bottom:12px;word-break:break-all;padding:0 8px">${Helpers.escapeHtml(urls.web)}</div>
                            <button style="padding:8px 20px;background:#3b82f6;color:white;border:none;border-radius:8px;font-size:12px;cursor:pointer" id="qr-copy-url-btn">üìã Copy URL</button>
                        </div>
                    `;
                    qrOverlay.onclick = () => qrOverlay.remove();
                    document.body.appendChild(qrOverlay);
                    
                    qrOverlay.querySelector('#qr-copy-url-btn').onclick = (e) => {
                        e.stopPropagation();
                        try {
                            if (navigator.clipboard && navigator.clipboard.writeText) {
                                navigator.clipboard.writeText(urls.web).then(() => {
                                    ModalsModule.showToast('Channel URL copied', 'success');
                                }).catch(() => {
                                    prompt('Channel URL:', urls.web);
                                });
                            } else {
                                prompt('Channel URL:', urls.web);
                            }
                        } catch (clipErr) {
                            prompt('Channel URL:', urls.web);
                        }
                    };
                } catch (qrErr) {
                    console.warn('[MeshConfig] QR generation failed:', qrErr);
                    ModalsModule.showToast('QR generation failed ‚Äî URL copied to clipboard', 'info');
                    try {
                        if (navigator.clipboard && navigator.clipboard.writeText) {
                            navigator.clipboard.writeText(urls.web).catch(() => prompt('Channel URL:', urls.web));
                        } else {
                            prompt('Channel URL:', urls.web);
                        }
                    } catch (clipErr) {
                        prompt('Channel URL:', urls.web);
                    }
                }
            } else {
                // No QR generator available ‚Äî copy to clipboard
                try {
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(urls.web).then(() => {
                            ModalsModule.showToast('Channel URL copied to clipboard (QR library not available)', 'info');
                        }).catch(() => {
                            prompt('Channel URL:', urls.web);
                        });
                    } else {
                        prompt('Channel URL:', urls.web);
                    }
                } catch (clipErr) {
                    prompt('Channel URL:', urls.web);
                }
            }
        };
        
        // Reset App Data handler
        document.getElementById('mesh-reset-app-btn').onclick = () => {
            // Show confirmation
            const btn = document.getElementById('mesh-reset-app-btn');
            if (btn.dataset.confirmed !== 'true') {
                btn.innerHTML = '‚ö†Ô∏è Confirm Reset?';
                btn.style.background = 'rgba(239,68,68,0.2)';
                btn.dataset.confirmed = 'true';
                // Auto-revert after 3 seconds
                setTimeout(() => {
                    if (btn.dataset.confirmed === 'true') {
                        btn.innerHTML = 'üóëÔ∏è Reset App Data';
                        btn.style.background = '';
                        btn.dataset.confirmed = '';
                    }
                }, 3000);
                return;
            }
            
            // Confirmed ‚Äî execute reset
            btn.innerHTML = '‚è≥ Resetting...';
            btn.disabled = true;
            
            MeshtasticModule.resetAppState().then(result => {
                if (result.success) {
                    ModalsModule.showToast(`App data cleared: ${result.cleared.join(', ')}`, 'success');
                    closeModal();
                    renderTeam();
                } else {
                    ModalsModule.showToast('Reset failed: ' + (result.error || 'Unknown error'), 'error');
                    btn.innerHTML = 'üóëÔ∏è Reset App Data';
                    btn.disabled = false;
                    btn.dataset.confirmed = '';
                }
            });
        };
        
        // Factory Reset Device handler
        const factoryBtn = document.getElementById('mesh-factory-reset-btn');
        if (factoryBtn && !factoryBtn.disabled) {
            factoryBtn.onclick = () => {
                // Two-step confirmation for destructive device operation
                if (factoryBtn.dataset.confirmed !== 'true') {
                    factoryBtn.innerHTML = '‚ö†Ô∏è Confirm? All device settings will be erased';
                    factoryBtn.style.background = 'rgba(239,68,68,0.2)';
                    factoryBtn.dataset.confirmed = 'true';
                    setTimeout(() => {
                        if (factoryBtn.dataset.confirmed === 'true') {
                            factoryBtn.innerHTML = 'üîÑ Factory Reset Device';
                            factoryBtn.style.background = '';
                            factoryBtn.dataset.confirmed = '';
                        }
                    }, 4000);
                    return;
                }
                
                factoryBtn.innerHTML = '‚è≥ Resetting device...';
                factoryBtn.disabled = true;
                
                MeshtasticModule.factoryResetDevice().then(result => {
                    if (result.success) {
                        ModalsModule.showToast('Device factory reset ‚Äî rebooting to defaults. Reconnect when ready.', 'success');
                        closeModal();
                        renderTeam();
                    } else {
                        ModalsModule.showToast('Factory reset failed: ' + (result.error || 'Unknown error'), 'error');
                        factoryBtn.innerHTML = 'üîÑ Factory Reset Device';
                        factoryBtn.disabled = false;
                        factoryBtn.dataset.confirmed = '';
                    }
                });
            };
        }
    }
    
    // =========================================================================
    // TEAM MANAGEMENT MODALS
    // =========================================================================
    
    /**
     * Open Create Team modal
     */
    function openCreateTeamModal() {
        // Uses cached modalContainer ref
        
        modalContainer.innerHTML = `
            <div class="modal-backdrop" id="modal-backdrop" role="presentation">
                <div class="modal" role="dialog" aria-modal="true" style="max-width:420px">
                    <div class="modal__header">
                        <h3 class="modal__title">‚ûï Create New Team</h3>
                        <button class="modal__close" id="modal-close" aria-label="Close dialog">${Icons.get('close')}</button>
                    </div>
                    <div class="modal__body">
                        <div class="form-group">
                            <label>Team Name</label>
                            <input type="text" id="team-name" placeholder="e.g., Sierra Expedition" maxlength="30">
                        </div>
                        
                        <div class="form-group">
                            <label>Description (optional)</label>
                            <input type="text" id="team-desc" placeholder="Brief description of the mission">
                        </div>
                        
                        <div class="form-group">
                            <label>Your Name</label>
                            <input type="text" id="team-my-name" placeholder="Your display name" value="${typeof MeshtasticModule !== 'undefined' ? MeshtasticModule.getConnectionState().nodeName || '' : ''}">
                        </div>
                        
                        <div class="form-group">
                            <label>Your Short Name (4 chars)</label>
                            <input type="text" id="team-my-short" placeholder="e.g., LEAD" maxlength="4" style="text-transform:uppercase">
                        </div>
                        
                        <div style="padding:12px;background:rgba(249,115,22,0.1);border:1px solid rgba(249,115,22,0.2);border-radius:8px;margin-top:16px">
                            <div style="font-size:11px;color:rgba(255,255,255,0.6);margin-bottom:8px">
                                üí° A unique Team ID and passphrase will be auto-generated. Share these with your team members to let them join.
                            </div>
                        </div>
                    </div>
                    <div class="modal__footer">
                        <button class="btn btn--secondary" id="modal-cancel">Cancel</button>
                        <button class="btn btn--primary" id="modal-create">Create Team</button>
                    </div>
                </div>
            </div>
        `;
        
        const closeModal = () => { modalContainer.innerHTML = ''; };
        
        modalContainer.querySelector('#modal-close').onclick = closeModal;
        modalContainer.querySelector('#modal-cancel').onclick = closeModal;
        modalContainer.querySelector('#modal-backdrop').onclick = (e) => {
            if (e.target.id === 'modal-backdrop') closeModal();
        };
        
        modalContainer.querySelector('#modal-create').onclick = () => {
            const name = modalContainer.querySelector('#team-name').value.trim();
            const desc = modalContainer.querySelector('#team-desc').value.trim();
            const myName = modalContainer.querySelector('#team-my-name').value.trim();
            const myShort = modalContainer.querySelector('#team-my-short').value.trim().toUpperCase();
            
            if (!name) {
                ModalsModule.showToast('Please enter a team name', 'error');
                return;
            }
            
            if (!myName) {
                ModalsModule.showToast('Please enter your name', 'error');
                return;
            }
            
            try {
                const team = TeamModule.createTeam({
                    name: name,
                    description: desc,
                    creatorName: myName,
                    creatorShortName: myShort || myName.substring(0, 4).toUpperCase()
                });
                
                closeModal();
                ModalsModule.showToast(`Team "${team.name}" created!`, 'success');
                
                // Show invite modal immediately
                setTimeout(() => openTeamInviteModal(), 500);
                
                renderTeam();
            } catch (err) {
                ModalsModule.showToast('Error: ' + err.message, 'error');
            }
        };
    }
    
    /**
     * Open Join Team modal
     */
    function openJoinTeamModal() {
        // Uses cached modalContainer ref
        
        modalContainer.innerHTML = `
            <div class="modal-backdrop" id="modal-backdrop" role="presentation">
                <div class="modal" role="dialog" aria-modal="true" style="max-width:420px">
                    <div class="modal__header">
                        <h3 class="modal__title">üîó Join a Team</h3>
                        <button class="modal__close" id="modal-close" aria-label="Close dialog">${Icons.get('close')}</button>
                    </div>
                    <div class="modal__body">
                        <p style="font-size:12px;color:rgba(255,255,255,0.5);margin-bottom:16px">
                            Enter a team invite code, paste package data, or import a .gdteam file.
                        </p>
                        
                        <div class="form-group">
                            <label>Invite Code or Package Data</label>
                            <textarea id="team-import-data" rows="4" placeholder="GDTEAM:eyJ0Ijoi... or paste JSON package"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Passphrase (if required)</label>
                            <input type="text" id="team-passphrase" placeholder="e.g., alpha-bravo-42">
                        </div>
                        
                        <div style="text-align:center;margin:16px 0">
                            <span style="color:rgba(255,255,255,0.3);font-size:12px">‚Äî or ‚Äî</span>
                        </div>
                        
                        <label class="btn btn--secondary btn--full" style="cursor:pointer">
                            üìÅ Import .gdteam File
                            <input type="file" id="team-file-input" accept=".gdteam,.json" style="display:none">
                        </label>
                    </div>
                    <div class="modal__footer">
                        <button class="btn btn--secondary" id="modal-cancel">Cancel</button>
                        <button class="btn btn--primary" id="modal-join">Join Team</button>
                    </div>
                </div>
            </div>
        `;
        
        const closeModal = () => { modalContainer.innerHTML = ''; };
        
        modalContainer.querySelector('#modal-close').onclick = closeModal;
        modalContainer.querySelector('#modal-cancel').onclick = closeModal;
        modalContainer.querySelector('#modal-backdrop').onclick = (e) => {
            if (e.target.id === 'modal-backdrop') closeModal();
        };
        
        // File import
        modalContainer.querySelector('#team-file-input').onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            try {
                const pkg = await TeamModule.importFromFile(file);
                modalContainer.querySelector('#team-import-data').value = JSON.stringify(pkg);
                ModalsModule.showToast('File loaded, enter passphrase and click Join', 'info');
            } catch (err) {
                ModalsModule.showToast('Error reading file: ' + err.message, 'error');
            }
        };
        
        // Join button
        modalContainer.querySelector('#modal-join').onclick = async () => {
            const data = modalContainer.querySelector('#team-import-data').value.trim();
            const passphrase = modalContainer.querySelector('#team-passphrase').value.trim();
            
            if (!data) {
                ModalsModule.showToast('Please enter invite code or package data', 'error');
                return;
            }
            
            try {
                let packageData = data;
                
                // Try to parse as JSON if not an invite code
                if (!data.startsWith('GDTEAM:')) {
                    try {
                        packageData = JSON.parse(data);
                    } catch (e) {
                        // Keep as string
                    }
                }
                
                const team = await TeamModule.importTeamPackage(packageData, passphrase || undefined);
                
                closeModal();
                ModalsModule.showToast(`Joined team "${team.name}"!`, 'success');
                renderTeam();
            } catch (err) {
                ModalsModule.showToast('Error: ' + err.message, 'error');
            }
        };
    }
    
    /**
     * Open Team Invite modal (for sharing)
     */
    function openTeamInviteModal() {
        if (!TeamModule.isInTeam()) return;
        
        const team = TeamModule.getCurrentTeam();
        const inviteCode = TeamModule.generateInviteCode();
        // Uses cached modalContainer ref
        
        modalContainer.innerHTML = `
            <div class="modal-backdrop" id="modal-backdrop" role="presentation">
                <div class="modal" role="dialog" aria-modal="true" style="max-width:420px">
                    <div class="modal__header">
                        <h3 class="modal__title">üì§ Invite to Team</h3>
                        <button class="modal__close" id="modal-close" aria-label="Close dialog">${Icons.get('close')}</button>
                    </div>
                    <div class="modal__body">
                        <div style="text-align:center;margin-bottom:20px">
                            <div style="font-size:24px;margin-bottom:8px">üë•</div>
                            <div style="font-size:16px;font-weight:600">${escapeHtml(team.name)}</div>
                            <div style="font-size:12px;color:rgba(255,255,255,0.5)">Team ID: ${team.id}</div>
                        </div>
                        
                        <!-- QR Code -->
                        <div style="text-align:center;margin-bottom:20px">
                            <div id="team-qr-container" style="display:inline-block;padding:16px;background:#fff;border-radius:12px">
                                <div style="color:#000;font-size:12px">Loading QR...</div>
                            </div>
                        </div>
                        
                        <!-- Passphrase -->
                        <div style="padding:12px;background:rgba(249,115,22,0.1);border:1px solid rgba(249,115,22,0.2);border-radius:8px;margin-bottom:16px">
                            <div style="font-size:10px;color:rgba(255,255,255,0.5);margin-bottom:4px">PASSPHRASE (share separately)</div>
                            <div style="font-size:16px;font-weight:600;font-family:monospace;letter-spacing:1px">${team.passphrase}</div>
                        </div>
                        
                        <!-- Invite Code -->
                        <div class="form-group">
                            <label>Invite Code</label>
                            <textarea id="invite-code-text" rows="3" readonly style="font-size:10px;font-family:monospace">${inviteCode}</textarea>
                        </div>
                        
                        <div style="display:flex;gap:8px">
                            <button class="btn btn--secondary" id="copy-invite-code" style="flex:1">
                                üìã Copy Code
                            </button>
                            <button class="btn btn--secondary" id="download-team-file" style="flex:1">
                                üìÅ Download .gdteam
                            </button>
                        </div>
                    </div>
                    <div class="modal__footer">
                        <button class="btn btn--primary btn--full" id="modal-close-btn">Done</button>
                    </div>
                </div>
            </div>
        `;
        
        const closeModal = () => { modalContainer.innerHTML = ''; };
        
        modalContainer.querySelector('#modal-close').onclick = closeModal;
        modalContainer.querySelector('#modal-close-btn').onclick = closeModal;
        modalContainer.querySelector('#modal-backdrop').onclick = (e) => {
            if (e.target.id === 'modal-backdrop') closeModal();
        };
        
        // Generate QR code
        TeamModule.generateTeamQR(180).then(qrDataUrl => {
            const qrContainer = modalContainer.querySelector('#team-qr-container');
            if (qrContainer) {
                qrContainer.innerHTML = `<img src="${Helpers.escapeHtml(qrDataUrl)}" alt="Team QR Code" style="display:block">`;
            }
        }).catch(err => {
            console.warn('[Panels] Team QR generation failed:', err.message);
            const qrContainer = modalContainer.querySelector('#team-qr-container');
            if (qrContainer) {
                qrContainer.innerHTML = '<p style="color:#ef4444;text-align:center">QR generation failed</p>';
            }
        });
        
        // Copy invite code
        modalContainer.querySelector('#copy-invite-code').onclick = () => {
            const code = modalContainer.querySelector('#invite-code-text').value;
            navigator.clipboard.writeText(code).then(() => {
                ModalsModule.showToast('Invite code copied!', 'success');
            }).catch(() => {
                modalContainer.querySelector('#invite-code-text').select();
                document.execCommand('copy');
                ModalsModule.showToast('Invite code copied!', 'success');
            });
        };
        
        // Download file
        modalContainer.querySelector('#download-team-file').onclick = () => {
            TeamModule.downloadTeamPackage();
            ModalsModule.showToast('Team file downloaded', 'success');
        };
    }
    
    /**
     * Open Team Settings modal
     */
    function openTeamSettingsModal() {
        if (!TeamModule.isInTeam()) return;
        
        const team = TeamModule.getCurrentTeam();
        const myMember = TeamModule.getMyMember();
        const isLeader = myMember?.role === 'leader';
        // Uses cached modalContainer ref
        
        modalContainer.innerHTML = `
            <div class="modal-backdrop" id="modal-backdrop" role="presentation">
                <div class="modal" role="dialog" aria-modal="true" style="max-width:420px">
                    <div class="modal__header">
                        <h3 class="modal__title">‚öôÔ∏è Team Settings</h3>
                        <button class="modal__close" id="modal-close" aria-label="Close dialog">${Icons.get('close')}</button>
                    </div>
                    <div class="modal__body">
                        <!-- Team Info -->
                        <div style="padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;margin-bottom:16px">
                            <div style="display:flex;justify-content:space-between;margin-bottom:8px">
                                <span style="font-size:11px;color:rgba(255,255,255,0.5)">Team ID</span>
                                <span style="font-size:12px;font-family:monospace">${team.id}</span>
                            </div>
                            <div style="display:flex;justify-content:space-between;margin-bottom:8px">
                                <span style="font-size:11px;color:rgba(255,255,255,0.5)">Mesh Channel</span>
                                <span style="font-size:12px">Channel ${team.meshChannel}</span>
                            </div>
                            <div style="display:flex;justify-content:space-between">
                                <span style="font-size:11px;color:rgba(255,255,255,0.5)">Passphrase</span>
                                <span style="font-size:12px;font-family:monospace">${team.passphrase}</span>
                            </div>
                        </div>
                        
                        <!-- Comm Plan -->
                        <div class="section-label">Communication Plan</div>
                        <div class="form-group">
                            <label>Primary Frequency</label>
                            <input type="text" id="comm-primary" value="${team.commPlan?.primaryFreq || ''}" placeholder="e.g., 146.520 MHz" ${!isLeader ? 'disabled' : ''}>
                        </div>
                        <div class="form-group">
                            <label>Emergency Word</label>
                            <input type="text" id="comm-emergency" value="${team.commPlan?.emergencyWord || ''}" placeholder="e.g., MAYDAY" ${!isLeader ? 'disabled' : ''}>
                        </div>
                        
                        ${isLeader ? `
                            <div class="divider"></div>
                            <div class="section-label" style="color:#ef4444">Danger Zone</div>
                            <button class="btn btn--secondary btn--full" id="dissolve-team-btn" style="color:#ef4444;border-color:rgba(239,68,68,0.3)">
                                ‚ö†Ô∏è Dissolve Team
                            </button>
                        ` : ''}
                    </div>
                    <div class="modal__footer">
                        <button class="btn btn--secondary" id="modal-cancel">Cancel</button>
                        ${isLeader ? `<button class="btn btn--primary" id="modal-save">Save Changes</button>` : ''}
                    </div>
                </div>
            </div>
        `;
        
        const closeModal = () => { modalContainer.innerHTML = ''; };
        
        modalContainer.querySelector('#modal-close').onclick = closeModal;
        modalContainer.querySelector('#modal-cancel').onclick = closeModal;
        modalContainer.querySelector('#modal-backdrop').onclick = (e) => {
            if (e.target.id === 'modal-backdrop') closeModal();
        };
        
        // Save changes
        const saveBtn = modalContainer.querySelector('#modal-save');
        if (saveBtn) {
            saveBtn.onclick = () => {
                try {
                    TeamModule.updateTeam({
                        commPlan: {
                            primaryFreq: modalContainer.querySelector('#comm-primary').value.trim(),
                            emergencyWord: modalContainer.querySelector('#comm-emergency').value.trim()
                        }
                    });
                    closeModal();
                    ModalsModule.showToast('Settings saved', 'success');
                    renderTeam();
                } catch (err) {
                    ModalsModule.showToast('Error: ' + err.message, 'error');
                }
            };
        }
        
        // Dissolve team
        const dissolveBtn = modalContainer.querySelector('#dissolve-team-btn');
        if (dissolveBtn) {
            dissolveBtn.onclick = () => {
                if (confirm('Are you sure you want to dissolve this team? This action cannot be undone.')) {
                    if (confirm('All members will be removed. Type "DISSOLVE" in the next prompt to confirm.')) {
                        const confirmation = prompt('Type DISSOLVE to confirm:');
                        if (confirmation === 'DISSOLVE') {
                            try {
                                TeamModule.dissolveTeam();
                                closeModal();
                                ModalsModule.showToast('Team dissolved', 'success');
                                renderTeam();
                            } catch (err) {
                                ModalsModule.showToast('Error: ' + err.message, 'error');
                            }
                        }
                    }
                }
            };
        }
    }
    
    /**
     * Open Add Rally Point modal
     */
    function openAddRallyPointModal() {
        if (!TeamModule.isInTeam()) return;
        
        const RALLY_TYPES = TeamModule.RALLY_TYPES;
        // Uses cached modalContainer ref
        
        // Get current map center for default coordinates
        const mapState = typeof MapModule !== 'undefined' ? MapModule.getMapState() : { lat: 37.4215, lon: -119.1892 };
        
        modalContainer.innerHTML = `
            <div class="modal-backdrop" id="modal-backdrop" role="presentation">
                <div class="modal" role="dialog" aria-modal="true" style="max-width:420px">
                    <div class="modal__header">
                        <h3 class="modal__title">üèÅ Add Rally Point</h3>
                        <button class="modal__close" id="modal-close" aria-label="Close dialog">${Icons.get('close')}</button>
                    </div>
                    <div class="modal__body">
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" id="rally-name" placeholder="e.g., Trailhead Parking">
                        </div>
                        
                        <div class="form-group">
                            <label>Type</label>
                            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
                                ${Object.entries(RALLY_TYPES).map(([key, rt]) => `
                                    <button class="btn btn--secondary rally-type-btn ${key === 'primary' ? 'rally-type-btn--selected' : ''}" 
                                            data-rally-type="${key}" 
                                            style="padding:10px;flex-direction:column;gap:4px;${key === 'primary' ? 'border-color:' + rt.color : ''}">
                                        <span style="font-size:18px">${rt.icon}</span>
                                        <span style="font-size:10px">${rt.name.split(' ')[0]}</span>
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div style="display:flex;gap:8px">
                            <div class="form-group" style="flex:1">
                                <label>Latitude</label>
                                <input type="number" id="rally-lat" step="0.0001" value="${mapState.lat.toFixed(4)}">
                            </div>
                            <div class="form-group" style="flex:1">
                                <label>Longitude</label>
                                <input type="number" id="rally-lon" step="0.0001" value="${mapState.lon.toFixed(4)}">
                            </div>
                        </div>
                        
                        <button class="btn btn--secondary btn--full" id="use-gps-btn" style="margin-bottom:16px">
                            üìç Use Current GPS Location
                        </button>
                        
                        <div class="form-group">
                            <label>Schedule (optional)</label>
                            <input type="text" id="rally-schedule" placeholder="e.g., Every 2 hours, or 0800 daily">
                        </div>
                        
                        <div class="form-group">
                            <label>Notes</label>
                            <textarea id="rally-notes" rows="2" placeholder="Additional instructions..."></textarea>
                        </div>
                    </div>
                    <div class="modal__footer">
                        <button class="btn btn--secondary" id="modal-cancel">Cancel</button>
                        <button class="btn btn--primary" id="modal-add">Add Rally Point</button>
                    </div>
                </div>
            </div>
        `;
        
        const closeModal = () => { modalContainer.innerHTML = ''; };
        let selectedType = 'primary';
        
        modalContainer.querySelector('#modal-close').onclick = closeModal;
        modalContainer.querySelector('#modal-cancel').onclick = closeModal;
        modalContainer.querySelector('#modal-backdrop').onclick = (e) => {
            if (e.target.id === 'modal-backdrop') closeModal();
        };
        
        // Type selection
        modalContainer.querySelectorAll('.rally-type-btn').forEach(btn => {
            btn.onclick = () => {
                modalContainer.querySelectorAll('.rally-type-btn').forEach(b => {
                    b.classList.remove('rally-type-btn--selected');
                    b.style.borderColor = '';
                });
                btn.classList.add('rally-type-btn--selected');
                btn.style.borderColor = RALLY_TYPES[btn.dataset.rallyType].color;
                selectedType = btn.dataset.rallyType;
            };
        });
        
        // Use GPS button
        modalContainer.querySelector('#use-gps-btn').onclick = () => {
            // First check GPSModule for existing position (including manual)
            if (typeof GPSModule !== 'undefined') {
                const gpsPos = GPSModule.getPosition();
                if (gpsPos && gpsPos.lat && gpsPos.lon) {
                    modalContainer.querySelector('#rally-lat').value = gpsPos.lat.toFixed(4);
                    modalContainer.querySelector('#rally-lon').value = gpsPos.lon.toFixed(4);
                    ModalsModule.showToast(gpsPos.isManual ? 'Manual position set' : 'GPS location set', 'success');
                    return;
                }
            }
            
            // Fallback to browser geolocation
            if ('geolocation' in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        modalContainer.querySelector('#rally-lat').value = pos.coords.latitude.toFixed(4);
                        modalContainer.querySelector('#rally-lon').value = pos.coords.longitude.toFixed(4);
                        ModalsModule.showToast('GPS location set', 'success');
                    },
                    (err) => {
                        ModalsModule.showToast('Could not get GPS. Try setting manual position in Team panel.', 'error');
                    },
                    { enableHighAccuracy: true }
                );
            } else {
                ModalsModule.showToast('Geolocation not supported. Set manual position in Team panel.', 'error');
            }
        };
        
        // Add button
        modalContainer.querySelector('#modal-add').onclick = () => {
            const name = modalContainer.querySelector('#rally-name').value.trim();
            const lat = parseFloat(modalContainer.querySelector('#rally-lat').value);
            const lon = parseFloat(modalContainer.querySelector('#rally-lon').value);
            const schedule = modalContainer.querySelector('#rally-schedule').value.trim();
            const notes = modalContainer.querySelector('#rally-notes').value.trim();
            
            if (!name) {
                ModalsModule.showToast('Please enter a name', 'error');
                return;
            }
            
            if (isNaN(lat) || isNaN(lon)) {
                ModalsModule.showToast('Please enter valid coordinates', 'error');
                return;
            }
            
            try {
                TeamModule.addRallyPoint({
                    name: name,
                    type: selectedType,
                    lat: lat,
                    lon: lon,
                    schedule: schedule,
                    notes: notes
                });
                
                closeModal();
                ModalsModule.showToast('Rally point added', 'success');
                renderTeam();
            } catch (err) {
                ModalsModule.showToast('Error: ' + err.message, 'error');
            }
        };
    }
    
    /**
     * Open Team Member detail modal
     */
    function openTeamMemberModal(member) {
        const ROLES = TeamModule.ROLES;
        const role = ROLES[member.role] || ROLES.support;
        const myMember = TeamModule.getMyMember();
        const canEdit = myMember?.role === 'leader' || myMember?.role === 'coleader';
        const isMe = member.id === myMember?.id;
        // Uses cached modalContainer ref
        
        const lastSeenText = member.lastSeen 
            ? formatMeshTime(member.lastSeen)
            : 'Unknown';
        
        modalContainer.innerHTML = `
            <div class="modal-backdrop" id="modal-backdrop" role="presentation">
                <div class="modal" role="dialog" aria-modal="true" style="max-width:380px">
                    <div class="modal__header">
                        <h3 class="modal__title">${role.icon} ${escapeHtml(member.name)}</h3>
                        <button class="modal__close" id="modal-close" aria-label="Close dialog">${Icons.get('close')}</button>
                    </div>
                    <div class="modal__body">
                        <div style="text-align:center;margin-bottom:20px">
                            <div style="width:60px;height:60px;border-radius:50%;background:${role.color}22;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;font-size:28px">
                                ${role.icon}
                            </div>
                            <div style="font-size:14px;color:${role.color}">${role.name}</div>
                            <div style="font-size:11px;color:rgba(255,255,255,0.4)">
                                ${member.shortName || 'N/A'} ‚Ä¢ ${isMe ? 'This is you' : `Last seen: ${lastSeenText}`}
                            </div>
                        </div>
                        
                        ${member.lat && member.lon ? `
                            <div style="padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;margin-bottom:16px">
                                <div style="font-size:11px;color:rgba(255,255,255,0.4);margin-bottom:4px">LAST KNOWN POSITION</div>
                                <div style="font-size:13px;font-family:monospace">${member.lat.toFixed(4)}¬∞, ${member.lon.toFixed(4)}¬∞</div>
                            </div>
                            <button class="btn btn--secondary btn--full" id="goto-member-btn" style="margin-bottom:16px">
                                üéØ Go to Location
                            </button>
                        ` : ''}
                        
                        ${canEdit && !isMe ? `
                            <div class="section-label">Change Role</div>
                            <select id="member-role-select" style="margin-bottom:16px">
                                ${Object.entries(ROLES).map(([key, r]) => `
                                    <option value="${key}" ${member.role === key ? 'selected' : ''}>${r.icon} ${r.name}</option>
                                `).join('')}
                            </select>
                            
                            <button class="btn btn--secondary btn--full" id="remove-member-btn" style="color:#ef4444;border-color:rgba(239,68,68,0.3)">
                                Remove from Team
                            </button>
                        ` : ''}
                    </div>
                    <div class="modal__footer">
                        <button class="btn btn--secondary btn--full" id="modal-close-btn">Close</button>
                    </div>
                </div>
            </div>
        `;
        
        const closeModal = () => { modalContainer.innerHTML = ''; };
        
        modalContainer.querySelector('#modal-close').onclick = closeModal;
        modalContainer.querySelector('#modal-close-btn').onclick = closeModal;
        modalContainer.querySelector('#modal-backdrop').onclick = (e) => {
            if (e.target.id === 'modal-backdrop') closeModal();
        };
        
        // Go to location
        const gotoBtn = modalContainer.querySelector('#goto-member-btn');
        if (gotoBtn) {
            gotoBtn.onclick = () => {
                if (member.lat && member.lon && typeof MapModule !== 'undefined') {
                    MapModule.setCenter(member.lat, member.lon, 15);
                    closeModal();
                    ModalsModule.showToast(`Centered on ${member.name}`, 'info');
                }
            };
        }
        
        // Change role
        const roleSelect = modalContainer.querySelector('#member-role-select');
        if (roleSelect) {
            roleSelect.onchange = () => {
                try {
                    TeamModule.setMemberRole(member.id, roleSelect.value);
                    ModalsModule.showToast('Role updated', 'success');
                    closeModal();
                    renderTeam();
                } catch (err) {
                    ModalsModule.showToast('Error: ' + err.message, 'error');
                }
            };
        }
        
        // Remove member
        const removeBtn = modalContainer.querySelector('#remove-member-btn');
        if (removeBtn) {
            removeBtn.onclick = () => {
                if (confirm(`Remove ${member.name} from the team?`)) {
                    try {
                        TeamModule.removeMember(member.id);
                        closeModal();
                        ModalsModule.showToast('Member removed', 'success');
                        renderTeam();
                    } catch (err) {
                        ModalsModule.showToast('Error: ' + err.message, 'error');
                    }
                }
            };
        }
    }

    /**
     * Open detailed team member modal with distance/bearing
     */
    function openTeamMemberDetailModal(member) {
        const ROLES = TeamModule.ROLES;
        const role = ROLES[member.role] || ROLES.support;
        const myMember = TeamModule.getMyMember();
        const canEdit = myMember?.role === 'leader' || myMember?.role === 'coleader';
        const isMe = member.id === myMember?.id;
        // Uses cached modalContainer ref
        
        // Get GPS position for distance/bearing
        const gpsState = typeof GPSModule !== 'undefined' ? GPSModule.getState() : null;
        const myPos = gpsState?.position ? { lat: gpsState.position.lat, lon: gpsState.position.lon } : null;
        
        // Calculate distance/bearing
        let distInfo = null;
        if (!isMe && myPos && member.lat && member.lon) {
            distInfo = TeamModule.getDistanceToMember(member.id, myPos);
        }
        
        const lastSeenText = member.lastSeen ? formatMeshTime(member.lastSeen) : 'Unknown';
        const statusColor = member.status === 'active' ? '#22c55e' : member.status === 'stale' ? '#f59e0b' : '#6b7280';
        const statusText = member.status === 'active' ? 'Active' : member.status === 'stale' ? 'Stale' : 'Offline';
        
        modalContainer.innerHTML = `
            <div class="modal-backdrop" id="modal-backdrop" role="presentation">
                <div class="modal" role="dialog" aria-modal="true" style="max-width:400px">
                    <div class="modal__header">
                        <h3 class="modal__title">${role.icon} ${escapeHtml(member.name)}</h3>
                        <button class="modal__close" id="modal-close" aria-label="Close dialog">${Icons.get('close')}</button>
                    </div>
                    <div class="modal__body">
                        <!-- Member Header -->
                        <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px">
                            <div style="position:relative">
                                <div style="width:64px;height:64px;border-radius:12px;background:${role.color}22;display:flex;align-items:center;justify-content:center;font-size:32px">
                                    ${role.icon}
                                </div>
                                <div style="position:absolute;bottom:-4px;right:-4px;width:16px;height:16px;border-radius:50%;background:${statusColor};border:3px solid #1a1f2e"></div>
                            </div>
                            <div style="flex:1">
                                <div style="font-size:16px;font-weight:600">${escapeHtml(member.name)}</div>
                                <div style="font-size:12px;color:${role.color}">${role.name}</div>
                                <div style="font-size:11px;color:rgba(255,255,255,0.4)">
                                    ${member.shortName || 'N/A'} ‚Ä¢ ${statusText}
                                </div>
                            </div>
                        </div>
                        
                        ${isMe ? `
                            <div style="padding:12px;background:rgba(249,115,22,0.1);border:1px solid rgba(249,115,22,0.2);border-radius:10px;text-align:center;margin-bottom:16px">
                                <span style="font-size:12px;color:#f97316">This is you</span>
                            </div>
                        ` : ''}
                        
                        <!-- Distance/Bearing Card -->
                        ${!isMe && distInfo ? `
                            <div style="padding:16px;background:linear-gradient(135deg,rgba(59,130,246,0.1),rgba(59,130,246,0.05));border:1px solid rgba(59,130,246,0.2);border-radius:12px;margin-bottom:16px">
                                <div style="display:flex;justify-content:space-between;align-items:center">
                                    <div>
                                        <div style="font-size:24px;font-weight:700;color:#3b82f6">${distInfo.formatted}</div>
                                        <div style="font-size:11px;color:rgba(255,255,255,0.5)">Distance from you</div>
                                    </div>
                                    <div style="text-align:center;padding:12px;background:rgba(0,0,0,0.2);border-radius:8px">
                                        <div style="font-size:20px;font-weight:600">${distInfo.compass}</div>
                                        <div style="font-size:10px;color:rgba(255,255,255,0.4)">${Math.round(distInfo.bearing)}¬∞</div>
                                    </div>
                                </div>
                            </div>
                        ` : !isMe && member.lat && member.lon && !myPos ? `
                            <div style="padding:12px;background:rgba(255,255,255,0.03);border-radius:10px;text-align:center;margin-bottom:16px;font-size:11px;color:rgba(255,255,255,0.4)">
                                Enable GPS to see distance and bearing
                            </div>
                        ` : ''}
                        
                        <!-- Position Info -->
                        ${member.lat && member.lon ? `
                            <div style="padding:12px;background:rgba(255,255,255,0.03);border-radius:10px;margin-bottom:16px">
                                <div style="font-size:10px;color:rgba(255,255,255,0.4);margin-bottom:6px">LAST KNOWN POSITION</div>
                                <div style="font-size:13px;font-family:'IBM Plex Mono',monospace">${member.lat.toFixed(5)}¬∞, ${member.lon.toFixed(5)}¬∞</div>
                                <div style="font-size:10px;color:rgba(255,255,255,0.3);margin-top:4px">Updated ${lastSeenText}</div>
                            </div>
                            <button class="btn btn--primary btn--full" id="goto-member-btn" style="margin-bottom:16px">
                                üéØ Go to Location on Map
                            </button>
                        ` : `
                            <div style="padding:16px;background:rgba(255,255,255,0.03);border-radius:10px;text-align:center;margin-bottom:16px">
                                <div style="font-size:24px;margin-bottom:8px">üìç</div>
                                <div style="font-size:12px;color:rgba(255,255,255,0.4)">No position data available</div>
                            </div>
                        `}
                        
                        <!-- Role Management (for leaders) -->
                        ${canEdit && !isMe ? `
                            <div class="divider" style="margin:16px 0"></div>
                            
                            <div class="section-label">Member Management</div>
                            
                            <div style="margin-bottom:12px">
                                <label style="font-size:11px;color:rgba(255,255,255,0.4);display:block;margin-bottom:6px">Change Role</label>
                                <select id="member-role-select" style="width:100%">
                                    ${Object.entries(ROLES).map(([key, r]) => `
                                        <option value="${key}" ${member.role === key ? 'selected' : ''}>${r.icon} ${r.name}</option>
                                    `).join('')}
                                </select>
                            </div>
                            
                            <button class="btn btn--secondary btn--full" id="remove-member-btn" style="color:#ef4444;border-color:rgba(239,68,68,0.3)">
                                üö´ Remove from Team
                            </button>
                        ` : ''}
                    </div>
                    <div class="modal__footer">
                        <button class="btn btn--secondary btn--full" id="modal-close-btn">Close</button>
                    </div>
                </div>
            </div>
        `;
        
        const closeModal = () => { modalContainer.innerHTML = ''; };
        
        modalContainer.querySelector('#modal-close').onclick = closeModal;
        modalContainer.querySelector('#modal-close-btn').onclick = closeModal;
        modalContainer.querySelector('#modal-backdrop').onclick = (e) => {
            if (e.target.id === 'modal-backdrop') closeModal();
        };
        
        // Go to location
        const gotoBtn = modalContainer.querySelector('#goto-member-btn');
        if (gotoBtn) {
            gotoBtn.onclick = () => {
                if (member.lat && member.lon && typeof MapModule !== 'undefined') {
                    MapModule.setCenter(member.lat, member.lon, 15);
                    closeModal();
                    ModalsModule.showToast(`Centered on ${member.name}`, 'info');
                }
            };
        }
        
        // Change role
        const roleSelect = modalContainer.querySelector('#member-role-select');
        if (roleSelect) {
            roleSelect.onchange = () => {
                try {
                    TeamModule.setMemberRole(member.id, roleSelect.value);
                    ModalsModule.showToast('Role updated', 'success');
                    closeModal();
                    renderTeam();
                } catch (err) {
                    ModalsModule.showToast('Error: ' + err.message, 'error');
                }
            };
        }
        
        // Remove member
        const removeBtn = modalContainer.querySelector('#remove-member-btn');
        if (removeBtn) {
            removeBtn.onclick = () => {
                if (confirm(`Remove ${member.name} from the team?`)) {
                    try {
                        TeamModule.removeMember(member.id);
                        ModalsModule.showToast('Member removed', 'success');
                        closeModal();
                        renderTeam();
                    } catch (err) {
                        ModalsModule.showToast('Error: ' + err.message, 'error');
                    }
                }
            };
        }
    }

    /**
     * Open comm plan editing modal
     */
    function openCommPlanModal() {
        const currentTeam = TeamModule.getCurrentTeam();
        if (!currentTeam) return;
        
        const commPlan = currentTeam.commPlan || {};
        // Uses cached modalContainer ref
        
        modalContainer.innerHTML = `
            <div class="modal-backdrop" id="modal-backdrop" role="presentation">
                <div class="modal" role="dialog" aria-modal="true" style="max-width:450px">
                    <div class="modal__header">
                        <h3 class="modal__title">üì° Comm Plan</h3>
                        <button class="modal__close" id="modal-close" aria-label="Close dialog">${Icons.get('close')}</button>
                    </div>
                    <div class="modal__body">
                        <!-- Frequencies -->
                        <div class="section-label">Radio Frequencies</div>
                        <div class="form-group">
                            <label>Primary Frequency</label>
                            <input type="text" id="comm-primary-freq" value="${commPlan.primaryFreq || ''}" 
                                placeholder="e.g., 146.520 MHz">
                        </div>
                        <div class="form-group">
                            <label>Backup Frequency</label>
                            <input type="text" id="comm-backup-freq" value="${commPlan.backupFreq || ''}" 
                                placeholder="e.g., 462.5625 MHz">
                        </div>
                        
                        <div class="divider"></div>
                        
                        <!-- Emergency Word -->
                        <div class="section-label">Emergency Protocol</div>
                        <div class="form-group">
                            <label>Emergency Code Word</label>
                            <input type="text" id="comm-emergency-word" value="${commPlan.emergencyWord || ''}" 
                                placeholder="e.g., AVALANCHE">
                            <div style="font-size:10px;color:rgba(255,255,255,0.4);margin-top:4px">
                                Say this word to trigger emergency response
                            </div>
                        </div>
                        
                        <div class="divider"></div>
                        
                        <!-- Check-In Times -->
                        <div class="section-label" style="display:flex;justify-content:space-between;align-items:center">
                            <span>Scheduled Check-Ins</span>
                            <button class="btn btn--secondary" id="add-checkin-btn" style="padding:2px 8px;font-size:10px">+ Add</button>
                        </div>
                        
                        <div id="checkin-list" style="margin-bottom:16px">
                            ${(commPlan.checkInTimes || []).map((ci, i) => `
                                <div style="display:flex;align-items:center;gap:8px;padding:8px;background:rgba(255,255,255,0.03);border-radius:8px;margin-bottom:6px" data-checkin-index="${i}">
                                    <span style="font-size:14px">‚è∞</span>
                                    <input type="time" value="${ci.time || ''}" data-checkin-time="${i}" style="flex:1">
                                    <select data-checkin-freq="${i}" style="width:90px;padding:6px">
                                        <option value="daily" ${ci.frequency === 'daily' ? 'selected' : ''}>Daily</option>
                                        <option value="hourly" ${ci.frequency === 'hourly' ? 'selected' : ''}>Hourly</option>
                                        <option value="once" ${ci.frequency === 'once' ? 'selected' : ''}>Once</option>
                                    </select>
                                    <button class="btn btn--secondary" data-remove-checkin="${i}" style="padding:4px 8px;color:#ef4444">‚úï</button>
                                </div>
                            `).join('')}
                            ${(commPlan.checkInTimes || []).length === 0 ? `
                                <div style="padding:12px;text-align:center;font-size:11px;color:rgba(255,255,255,0.4)">
                                    No scheduled check-ins
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="divider"></div>
                        
                        <!-- Signal Plan -->
                        <div class="section-label">Signal Plan Notes</div>
                        <div class="form-group" style="margin-bottom:0">
                            <textarea id="comm-signal-plan" rows="3" 
                                placeholder="Visual/audio signals, contingency procedures...">${commPlan.signalPlan || ''}</textarea>
                        </div>
                    </div>
                    <div class="modal__footer">
                        <button class="btn btn--secondary" id="modal-cancel">Cancel</button>
                        <button class="btn btn--primary" id="save-commplan-btn">Save Changes</button>
                    </div>
                </div>
            </div>
        `;
        
        const closeModal = () => { modalContainer.innerHTML = ''; };
        
        modalContainer.querySelector('#modal-close').onclick = closeModal;
        modalContainer.querySelector('#modal-cancel').onclick = closeModal;
        modalContainer.querySelector('#modal-backdrop').onclick = (e) => {
            if (e.target.id === 'modal-backdrop') closeModal();
        };
        
        // Add check-in
        modalContainer.querySelector('#add-checkin-btn').onclick = () => {
            const list = modalContainer.querySelector('#checkin-list');
            const emptyMsg = list.querySelector('div[style*="text-align:center"]');
            if (emptyMsg) emptyMsg.remove();
            
            const index = list.children.length;
            const newItem = document.createElement('div');
            newItem.style.cssText = 'display:flex;align-items:center;gap:8px;padding:8px;background:rgba(255,255,255,0.03);border-radius:8px;margin-bottom:6px';
            newItem.dataset.checkinIndex = index;
            newItem.innerHTML = `
                <span style="font-size:14px">‚è∞</span>
                <input type="time" value="08:00" data-checkin-time="${index}" style="flex:1">
                <select data-checkin-freq="${index}" style="width:90px;padding:6px">
                    <option value="daily" selected>Daily</option>
                    <option value="hourly">Hourly</option>
                    <option value="once">Once</option>
                </select>
                <button class="btn btn--secondary" data-remove-checkin="${index}" style="padding:4px 8px;color:#ef4444">‚úï</button>
            `;
            list.appendChild(newItem);
            
            // Attach remove handler
            newItem.querySelector('[data-remove-checkin]').onclick = function() {
                newItem.remove();
            };
        };
        
        // Remove check-in handlers
        modalContainer.querySelectorAll('[data-remove-checkin]').forEach(btn => {
            btn.onclick = () => {
                btn.closest('[data-checkin-index]').remove();
            };
        });
        
        // Save
        modalContainer.querySelector('#save-commplan-btn').onclick = () => {
            // Gather check-in times
            const checkInTimes = [];
            modalContainer.querySelectorAll('[data-checkin-index]').forEach(item => {
                const timeInput = item.querySelector('[data-checkin-time]');
                const freqSelect = item.querySelector('[data-checkin-freq]');
                if (timeInput?.value) {
                    checkInTimes.push({
                        id: Helpers.generateId(),
                        time: timeInput.value,
                        frequency: freqSelect?.value || 'daily'
                    });
                }
            });
            
            const updates = {
                primaryFreq: modalContainer.querySelector('#comm-primary-freq').value.trim(),
                backupFreq: modalContainer.querySelector('#comm-backup-freq').value.trim(),
                emergencyWord: modalContainer.querySelector('#comm-emergency-word').value.trim().toUpperCase(),
                signalPlan: modalContainer.querySelector('#comm-signal-plan').value.trim(),
                checkInTimes: checkInTimes
            };
            
            try {
                TeamModule.updateCommPlan(updates);
                ModalsModule.showToast('Comm plan saved', 'success');
                closeModal();
                renderTeam();
            } catch (err) {
                ModalsModule.showToast('Error: ' + err.message, 'error');
            }
        };
    }

    /**
     * Open modal to select waypoint for mesh sharing
     */
    function openMeshShareWaypointModal() {
        const waypoints = State.get('waypoints') || [];
        // Uses cached modalContainer ref
        
        modalContainer.innerHTML = `
            <div class="modal-backdrop" id="modal-backdrop" role="presentation">
                <div class="modal" role="dialog" aria-modal="true" style="max-width:400px">
                    <div class="modal__header">
                        <h3 class="modal__title">üìç Share Waypoint via Mesh</h3>
                        <button class="modal__close" id="modal-close" aria-label="Close dialog">${Icons.get('close')}</button>
                    </div>
                    <div class="modal__body">
                        <p style="font-size:12px;color:rgba(255,255,255,0.5);margin-bottom:12px">
                            Select a waypoint to share with your team over the mesh network.
                        </p>
                        <div style="max-height:300px;overflow-y:auto">
                            ${waypoints.map(wp => {
                                const type = Constants.WAYPOINT_TYPES[wp.type] || Constants.WAYPOINT_TYPES.custom;
                                return `
                                    <div class="card" style="margin-bottom:8px;cursor:pointer" data-share-wp="${wp.id}">
                                        <div class="card__header">
                                            <div class="card__icon" style="background:${type.color}22">${type.icon}</div>
                                            <div>
                                                <div class="card__title">${wp.name}</div>
                                                <div class="card__subtitle">${type.label}</div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    <div class="modal__footer">
                        <button class="btn btn--secondary" id="modal-cancel">Cancel</button>
                    </div>
                </div>
            </div>
        `;
        
        const closeModal = () => { modalContainer.innerHTML = ''; };
        
        modalContainer.querySelector('#modal-close').onclick = closeModal;
        modalContainer.querySelector('#modal-cancel').onclick = closeModal;
        modalContainer.querySelector('#modal-backdrop').onclick = (e) => {
            if (e.target.id === 'modal-backdrop') closeModal();
        };
        
        modalContainer.querySelectorAll('[data-share-wp]').forEach(card => {
            card.onclick = async () => {
                const wp = waypoints.find(w => w.id === card.dataset.shareWp);
                if (wp) {
                    closeModal();
                    await MeshtasticModule.shareWaypoint(wp);
                }
            };
        });
    }
    
    /**
     * Open modal to select route for mesh sharing
     */
    function openMeshShareRouteModal() {
        const routes = State.get('routes') || [];
        // Uses cached modalContainer ref
        
        modalContainer.innerHTML = `
            <div class="modal-backdrop" id="modal-backdrop" role="presentation">
                <div class="modal" role="dialog" aria-modal="true" style="max-width:400px">
                    <div class="modal__header">
                        <h3 class="modal__title">üõ§Ô∏è Share Route via Mesh</h3>
                        <button class="modal__close" id="modal-close" aria-label="Close dialog">${Icons.get('close')}</button>
                    </div>
                    <div class="modal__body">
                        <p style="font-size:12px;color:rgba(255,255,255,0.5);margin-bottom:12px">
                            Select a route to share. Large routes will be sent in chunks.
                        </p>
                        <div style="max-height:300px;overflow-y:auto">
                            ${routes.filter(r => !r.isBuilding).map(route => `
                                <div class="card" style="margin-bottom:8px;cursor:pointer" data-share-route="${route.id}">
                                    <div class="card__header">
                                        <div class="card__icon" style="background:rgba(249,115,22,0.15);color:#f97316">${Icons.get('route')}</div>
                                        <div>
                                            <div class="card__title">${route.name}</div>
                                            <div class="card__subtitle">${route.distance || '?'} mi ‚Ä¢ ${route.points?.length || 0} points</div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="modal__footer">
                        <button class="btn btn--secondary" id="modal-cancel">Cancel</button>
                    </div>
                </div>
            </div>
        `;
        
        const closeModal = () => { modalContainer.innerHTML = ''; };
        
        modalContainer.querySelector('#modal-close').onclick = closeModal;
        modalContainer.querySelector('#modal-cancel').onclick = closeModal;
        modalContainer.querySelector('#modal-backdrop').onclick = (e) => {
            if (e.target.id === 'modal-backdrop') closeModal();
        };
        
        modalContainer.querySelectorAll('[data-share-route]').forEach(card => {
            card.onclick = async () => {
                const route = routes.find(r => r.id === card.dataset.shareRoute);
                if (route) {
                    closeModal();
                    await MeshtasticModule.shareRoute(route);
                }
            };
        });
    }
    
    /**
     * Open Export Plan Modal
     */
    function openExportModal() {
        const waypoints = State.get('waypoints') || [];
        const routes = State.get('routes') || [];
        
        // Uses cached modalContainer ref
        modalContainer.innerHTML = `
            <div class="modal-backdrop" id="modal-backdrop" role="presentation">
                <div class="modal" role="dialog" aria-modal="true" style="max-width:420px">
                    <div class="modal__header">
                        <h3 class="modal__title">üì¶ Export Plan Package</h3>
                        <button class="modal__close" id="modal-close" aria-label="Close dialog">${Icons.get('close')}</button>
                    </div>
                    <div class="modal__body">
                        <p style="font-size:13px;color:rgba(255,255,255,0.6);margin-bottom:16px">
                            Create an encrypted package to share with your team via AirDrop, email, SD card, or mesh.
                        </p>
                        
                        <div class="form-group">
                            <label>Plan Name</label>
                            <input type="text" id="export-plan-name" value="Mission Plan" placeholder="Enter plan name">
                        </div>
                        
                        <div class="form-group">
                            <label>Your Name (optional)</label>
                            <input type="text" id="export-creator-name" placeholder="e.g., Alpha-1">
                        </div>
                        
                        <div class="form-group">
                            <label>Description (optional)</label>
                            <textarea id="export-description" rows="2" placeholder="Brief description of this plan..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Encryption Passphrase *</label>
                            <input type="password" id="export-passphrase" placeholder="Min 4 characters">
                            <div style="font-size:11px;color:rgba(255,255,255,0.4);margin-top:4px">
                                Share this passphrase with your team separately
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Confirm Passphrase *</label>
                            <input type="password" id="export-passphrase-confirm" placeholder="Confirm passphrase">
                        </div>
                        
                        <!-- What's Included -->
                        <div style="padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;margin-top:12px">
                            <div style="font-size:11px;color:rgba(255,255,255,0.5);margin-bottom:8px">PACKAGE CONTENTS</div>
                            <div style="display:flex;gap:16px;font-size:13px">
                                <span>üìç ${waypoints.length} waypoints</span>
                                <span>üõ£Ô∏è ${routes.length} routes</span>
                            </div>
                        </div>
                    </div>
                    <div class="modal__footer">
                        <button class="btn btn--secondary" id="modal-cancel">Cancel</button>
                        <button class="btn btn--primary" id="modal-export">
                            ${Icons.get('export')} Export
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        const closeModal = () => { modalContainer.innerHTML = ''; };
        
        modalContainer.querySelector('#modal-close').onclick = closeModal;
        modalContainer.querySelector('#modal-cancel').onclick = closeModal;
        modalContainer.querySelector('#modal-backdrop').onclick = (e) => {
            if (e.target.id === 'modal-backdrop') closeModal();
        };
        
        modalContainer.querySelector('#modal-export').onclick = async () => {
            const planName = modalContainer.querySelector('#export-plan-name').value || 'Mission Plan';
            const creatorName = modalContainer.querySelector('#export-creator-name').value;
            const description = modalContainer.querySelector('#export-description').value;
            const passphrase = modalContainer.querySelector('#export-passphrase').value;
            const passphraseConfirm = modalContainer.querySelector('#export-passphrase-confirm').value;
            
            if (passphrase.length < 4) {
                ModalsModule.showToast('Passphrase must be at least 4 characters', 'error');
                return;
            }
            
            if (passphrase !== passphraseConfirm) {
                ModalsModule.showToast('Passphrases do not match', 'error');
                return;
            }
            
            try {
                const filename = await PlanSharingModule.downloadPlan(passphrase, {
                    planName,
                    creatorName,
                    description
                });
                closeModal();
                ModalsModule.showToast(`Plan exported: ${filename}`, 'success');
            } catch (err) {
                ModalsModule.showToast('Export failed: ' + err.message, 'error');
            }
        };
    }
    
    /**
     * Open Import Modal (for encrypted files)
     */
    function openImportModal(fileContent, filename) {
        // Uses cached modalContainer ref
        modalContainer.innerHTML = `
            <div class="modal-backdrop" id="modal-backdrop" role="presentation">
                <div class="modal" role="dialog" aria-modal="true" style="max-width:400px">
                    <div class="modal__header">
                        <h3 class="modal__title">üîê Decrypt Plan</h3>
                        <button class="modal__close" id="modal-close" aria-label="Close dialog">${Icons.get('close')}</button>
                    </div>
                    <div class="modal__body">
                        <p style="font-size:13px;color:rgba(255,255,255,0.6);margin-bottom:16px">
                            This plan package is encrypted. Enter the passphrase to decrypt it.
                        </p>
                        
                        <div style="padding:10px;background:rgba(255,255,255,0.03);border-radius:8px;margin-bottom:16px">
                            <div style="font-size:11px;color:rgba(255,255,255,0.4)">FILE</div>
                            <div style="font-size:13px;word-break:break-all">${filename}</div>
                        </div>
                        
                        <div class="form-group">
                            <label>Passphrase</label>
                            <input type="password" id="import-passphrase" placeholder="Enter passphrase" autofocus>
                        </div>
                    </div>
                    <div class="modal__footer">
                        <button class="btn btn--secondary" id="modal-cancel">Cancel</button>
                        <button class="btn btn--primary" id="modal-decrypt">
                            üîì Decrypt & Import
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        const closeModal = () => { modalContainer.innerHTML = ''; };
        
        modalContainer.querySelector('#modal-close').onclick = closeModal;
        modalContainer.querySelector('#modal-cancel').onclick = closeModal;
        modalContainer.querySelector('#modal-backdrop').onclick = (e) => {
            if (e.target.id === 'modal-backdrop') closeModal();
        };
        
        modalContainer.querySelector('#modal-decrypt').onclick = async () => {
            const passphrase = modalContainer.querySelector('#import-passphrase').value;
            
            if (!passphrase) {
                ModalsModule.showToast('Please enter the passphrase', 'error');
                return;
            }
            
            try {
                const planData = await PlanSharingModule.parsePlanFile(fileContent, passphrase);
                closeModal();
                showConflictResolution(planData, filename);
            } catch (err) {
                ModalsModule.showToast('Decryption failed. Check passphrase.', 'error');
            }
        };
        
        // Allow Enter key to submit
        modalContainer.querySelector('#import-passphrase').onkeypress = (e) => {
            if (e.key === 'Enter') {
                modalContainer.querySelector('#modal-decrypt').click();
            }
        };
    }
    
    /**
     * Show Conflict Resolution UI
     */
    function showConflictResolution(planData, filename) {
        const conflicts = PlanSharingModule.analyzeConflicts(planData);
        const hasConflicts = conflicts.waypoints.length > 0 || conflicts.routes.length > 0;
        
        // Uses cached modalContainer ref
        modalContainer.innerHTML = `
            <div class="modal-backdrop" id="modal-backdrop" role="presentation">
                <div class="modal" role="dialog" aria-modal="true" style="max-width:500px;max-height:85vh">
                    <div class="modal__header">
                        <h3 class="modal__title">üì• Import Plan</h3>
                        <button class="modal__close" id="modal-close" aria-label="Close dialog">${Icons.get('close')}</button>
                    </div>
                    <div class="modal__body" style="max-height:60vh;overflow-y:auto">
                        <!-- Plan Info -->
                        <div style="padding:12px;background:rgba(139,92,246,0.1);border:1px solid rgba(139,92,246,0.2);border-radius:10px;margin-bottom:16px">
                            <div style="font-size:14px;font-weight:600;margin-bottom:4px">${planData.planName || 'Imported Plan'}</div>
                            <div style="font-size:12px;color:rgba(255,255,255,0.5)">
                                ${planData.creator ? `From: ${planData.creator} ‚Ä¢ ` : ''}
                                ${new Date(planData.created).toLocaleString()}
                            </div>
                            ${planData.description ? `<div style="font-size:12px;color:rgba(255,255,255,0.6);margin-top:8px">${planData.description}</div>` : ''}
                        </div>
                        
                        <!-- Summary -->
                        <div style="display:flex;gap:12px;margin-bottom:16px">
                            <div style="flex:1;padding:12px;background:rgba(34,197,94,0.1);border-radius:8px;text-align:center">
                                <div style="font-size:20px;font-weight:600;color:#22c55e">${conflicts.newWaypoints.length}</div>
                                <div style="font-size:11px;color:rgba(255,255,255,0.5)">New Waypoints</div>
                            </div>
                            <div style="flex:1;padding:12px;background:rgba(34,197,94,0.1);border-radius:8px;text-align:center">
                                <div style="font-size:20px;font-weight:600;color:#22c55e">${conflicts.newRoutes.length}</div>
                                <div style="font-size:11px;color:rgba(255,255,255,0.5)">New Routes</div>
                            </div>
                            ${hasConflicts ? `
                                <div style="flex:1;padding:12px;background:rgba(249,115,22,0.1);border-radius:8px;text-align:center">
                                    <div style="font-size:20px;font-weight:600;color:#f97316">${conflicts.waypoints.length + conflicts.routes.length}</div>
                                    <div style="font-size:11px;color:rgba(255,255,255,0.5)">Conflicts</div>
                                </div>
                            ` : ''}
                        </div>
                        
                        ${hasConflicts ? `
                            <!-- Conflicts Section -->
                            <div class="section-label" style="color:#f97316">‚ö†Ô∏è Resolve Conflicts</div>
                            
                            ${conflicts.waypoints.map((c, i) => `
                                <div style="padding:12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:8px;margin-bottom:8px">
                                    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px">
                                        <div>
                                            <div style="font-size:13px;font-weight:500">üìç ${c.imported.name}</div>
                                            <div style="font-size:11px;color:rgba(255,255,255,0.4)">
                                                ${c.type === 'name_collision' ? 'Name already exists' : 'Modified version exists'}
                                            </div>
                                        </div>
                                    </div>
                                    <div style="display:flex;gap:6px">
                                        <button class="btn btn--secondary conflict-btn" data-conflict="waypoint_${c.imported.id}" data-action="skip" style="flex:1;padding:8px;font-size:11px">
                                            Skip
                                        </button>
                                        <button class="btn btn--secondary conflict-btn" data-conflict="waypoint_${c.imported.id}" data-action="replace" style="flex:1;padding:8px;font-size:11px">
                                            Replace
                                        </button>
                                        <button class="btn btn--secondary conflict-btn" data-conflict="waypoint_${c.imported.id}" data-action="keep_both" style="flex:1;padding:8px;font-size:11px">
                                            Keep Both
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                            
                            ${conflicts.routes.map((c, i) => `
                                <div style="padding:12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:8px;margin-bottom:8px">
                                    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px">
                                        <div>
                                            <div style="font-size:13px;font-weight:500">üõ£Ô∏è ${c.imported.name}</div>
                                            <div style="font-size:11px;color:rgba(255,255,255,0.4)">
                                                ${c.type === 'name_collision' ? 'Name already exists' : 'Modified version exists'}
                                            </div>
                                        </div>
                                    </div>
                                    <div style="display:flex;gap:6px">
                                        <button class="btn btn--secondary conflict-btn" data-conflict="route_${c.imported.id}" data-action="skip" style="flex:1;padding:8px;font-size:11px">
                                            Skip
                                        </button>
                                        <button class="btn btn--secondary conflict-btn" data-conflict="route_${c.imported.id}" data-action="replace" style="flex:1;padding:8px;font-size:11px">
                                            Replace
                                        </button>
                                        <button class="btn btn--secondary conflict-btn" data-conflict="route_${c.imported.id}" data-action="keep_both" style="flex:1;padding:8px;font-size:11px">
                                            Keep Both
                                        </button>
                                        <button class="btn btn--secondary conflict-btn" data-conflict="route_${c.imported.id}" data-action="merge" style="flex:1;padding:8px;font-size:11px">
                                            Merge
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        ` : `
                            <div style="padding:20px;text-align:center;color:rgba(255,255,255,0.5)">
                                <div style="font-size:24px;margin-bottom:8px">‚úì</div>
                                <div>No conflicts detected. Ready to import!</div>
                            </div>
                        `}
                    </div>
                    <div class="modal__footer">
                        <button class="btn btn--secondary" id="modal-cancel">Cancel</button>
                        <button class="btn btn--success" id="modal-import">
                            ${Icons.get('download')} Import ${conflicts.newWaypoints.length + conflicts.newRoutes.length + conflicts.waypoints.length + conflicts.routes.length} Items
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        // Track conflict resolutions
        const resolutions = {};
        
        // Set default resolutions to 'skip' for conflicts, implicit 'add' for new items
        conflicts.waypoints.forEach(c => { resolutions[`waypoint_${c.imported.id}`] = 'skip'; });
        conflicts.routes.forEach(c => { resolutions[`route_${c.imported.id}`] = 'skip'; });
        
        const closeModal = () => { modalContainer.innerHTML = ''; };
        
        modalContainer.querySelector('#modal-close').onclick = closeModal;
        modalContainer.querySelector('#modal-cancel').onclick = closeModal;
        modalContainer.querySelector('#modal-backdrop').onclick = (e) => {
            if (e.target.id === 'modal-backdrop') closeModal();
        };
        
        // Conflict resolution buttons
        modalContainer.querySelectorAll('.conflict-btn').forEach(btn => {
            btn.onclick = () => {
                const conflictId = btn.dataset.conflict;
                const action = btn.dataset.action;
                
                // Update resolution
                resolutions[conflictId] = action;
                
                // Update button states
                const siblings = btn.parentElement.querySelectorAll('.conflict-btn');
                siblings.forEach(s => {
                    s.classList.remove('btn--primary');
                    s.classList.add('btn--secondary');
                });
                btn.classList.remove('btn--secondary');
                btn.classList.add('btn--primary');
            };
        });
        
        // Import button
        modalContainer.querySelector('#modal-import').onclick = async () => {
            try {
                const result = await PlanSharingModule.mergePlan(planData, resolutions);
                closeModal();
                
                const total = result.waypoints.added + result.waypoints.updated + 
                              result.routes.added + result.routes.updated;
                
                ModalsModule.showToast(
                    `Imported: ${result.waypoints.added} waypoints, ${result.routes.added} routes`,
                    'success'
                );
                
                // Refresh the map and panels
                if (typeof MapModule !== 'undefined') MapModule.render();
                renderTeam();
                
            } catch (err) {
                ModalsModule.showToast('Import failed: ' + err.message, 'error');
            }
        };
    }

    /**
     * GPS Panel - Location tracking, breadcrumbs, and navigation
     */
    /**
     * Render Manual Position card for GPS panel
     */
    function renderManualPositionCard() {
        if (typeof GPSModule === 'undefined') return '';
        
        const manualPos = GPSModule.getManualPosition();
        const isUsingManual = GPSModule.isUsingManualPosition();
        const preferManual = GPSModule.isPreferManual();
        const gpsState = GPSModule.getState();
        const hasGPSFix = gpsState.currentPosition !== null;
        
        return `
            <div style="margin-bottom:16px">
                <div class="section-label" style="display:flex;align-items:center;gap:8px">
                    üìå Manual Position
                    <span style="font-size:10px;color:rgba(255,255,255,0.3);font-weight:400">For use without GPS</span>
                </div>
                
                <div style="padding:14px;background:${manualPos ? 'rgba(168,85,247,0.1)' : 'rgba(255,255,255,0.03)'};border:1px solid ${manualPos ? 'rgba(168,85,247,0.3)' : 'rgba(255,255,255,0.1)'};border-radius:12px">
                    
                    ${manualPos ? `
                        <!-- Manual Position Set -->
                        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
                            <div style="width:40px;height:40px;border-radius:10px;background:rgba(168,85,247,0.2);display:flex;align-items:center;justify-content:center">
                                <span style="font-size:18px">üìå</span>
                            </div>
                            <div style="flex:1">
                                <div style="font-size:13px;font-weight:600;color:#a855f7;font-family:monospace">
                                    ${manualPos.lat.toFixed(6)}, ${manualPos.lon.toFixed(6)}
                                </div>
                                <div style="font-size:11px;color:rgba(255,255,255,0.5)">
                                    ${manualPos.name ? manualPos.name : 'Manual position'}
                                    ${manualPos.altitude ? ` ‚Ä¢ ${Math.round(manualPos.altitude)}m alt` : ''}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Position Formats -->
                        <div style="padding:10px;background:rgba(0,0,0,0.2);border-radius:8px;margin-bottom:12px;font-size:11px;font-family:monospace">
                            ${typeof Coordinates !== 'undefined' ? `
                                <div style="margin-bottom:4px"><span style="color:rgba(255,255,255,0.4)">DD:</span> ${Coordinates.toDD(manualPos.lat, manualPos.lon)}</div>
                                <div style="margin-bottom:4px"><span style="color:rgba(255,255,255,0.4)">DMS:</span> ${Coordinates.toDMS(manualPos.lat, manualPos.lon)}</div>
                                <div style="margin-bottom:4px"><span style="color:rgba(255,255,255,0.4)">UTM:</span> ${Coordinates.toUTM(manualPos.lat, manualPos.lon)}</div>
                                <div><span style="color:rgba(255,255,255,0.4)">MGRS:</span> ${Coordinates.toMGRS(manualPos.lat, manualPos.lon)}</div>
                            ` : `${manualPos.lat.toFixed(6)}, ${manualPos.lon.toFixed(6)}`}
                        </div>
                        
                        <!-- Status Indicator -->
                        <div style="padding:8px;background:${isUsingManual ? 'rgba(168,85,247,0.15)' : 'rgba(34,197,94,0.15)'};border-radius:6px;font-size:11px;text-align:center;margin-bottom:12px;color:${isUsingManual ? '#a855f7' : '#22c55e'}">
                            ${isUsingManual 
                                ? '‚úì Using manual position' + (preferManual ? ' (preferred)' : ' (GPS inactive)')
                                : '‚úì GPS active - using GPS position'}
                        </div>
                        
                        <!-- Prefer Manual Toggle -->
                        <label style="display:flex;align-items:center;gap:8px;font-size:12px;color:rgba(255,255,255,0.7);cursor:pointer;margin-bottom:12px;padding:8px;background:rgba(255,255,255,0.03);border-radius:6px">
                            <input type="checkbox" id="gps-prefer-manual" ${preferManual ? 'checked' : ''} style="width:16px;height:16px">
                            <span>Always prefer manual position over GPS</span>
                        </label>
                        
                        <!-- Buttons -->
                        <div style="display:flex;gap:8px">
                            <button class="btn btn--secondary" id="gps-edit-manual" style="flex:1;font-size:12px">
                                ‚úèÔ∏è Edit Position
                            </button>
                            <button class="btn btn--secondary" id="gps-clear-manual" style="font-size:12px;color:#ef4444">
                                ‚úï Clear
                            </button>
                        </div>
                    ` : `
                        <!-- No Manual Position -->
                        <div style="text-align:center;padding:8px 0 12px 0">
                            <div style="font-size:13px;color:rgba(255,255,255,0.6);margin-bottom:4px">No manual position set</div>
                            <div style="font-size:11px;color:rgba(255,255,255,0.4)">
                                ${hasGPSFix 
                                    ? 'Using GPS position. Set manual for GPS-denied environments.'
                                    : 'Set a manual position when GPS is unavailable.'}
                            </div>
                        </div>
                        
                        <button class="btn btn--primary btn--full" id="gps-set-manual" style="font-size:13px">
                            üìå Set Manual Position
                        </button>
                        
                        <div style="margin-top:10px;font-size:10px;color:rgba(255,255,255,0.4);text-align:center">
                            Supports: Decimal, DMS, UTM, MGRS formats
                        </div>
                    `}
                </div>
            </div>
            
            <div class="divider"></div>
        `;
    }

    function renderGPS() {
        _saveScroll(); _restoreScroll();
        // Check GPS module availability
        if (typeof GPSModule === 'undefined') {
            container.innerHTML = `
                <div class="panel__header"><h2 class="panel__title">GPS</h2></div>
                <div class="empty-state">
                    <div class="empty-state__icon">${Icons.get('alert')}</div>
                    <div class="empty-state__title">GPS Module Not Loaded</div>
                    <div class="empty-state__desc">GPS functionality is not available.</div>
                </div>
            `;
            return;
        }
        
        const gpsState = GPSModule.getState();
        const position = gpsState.currentPosition;
        const isTracking = gpsState.isTracking;
        const isRecording = gpsState.isRecording;
        const recordedTrack = GPSModule.getRecordedTrack();
        const waypoints = State.get('waypoints') || [];
        const selectedNavTarget = State.get('gpsNavTarget');
        
        // Get navigation info if we have a target
        let navInfo = null;
        if (selectedNavTarget && position) {
            const targetWp = waypoints.find(w => w.id === selectedNavTarget);
            if (targetWp) {
                const targetLat = targetWp.lat || (37.4215 + (targetWp.y - 50) * 0.002);
                const targetLon = targetWp.lon || (-119.1892 + (targetWp.x - 50) * 0.004);
                navInfo = GPSModule.getNavigationTo(targetLat, targetLon);
                navInfo.waypoint = targetWp;
            }
        }
        
        // Get all waypoint distances for the list
        let waypointDistances = [];
        if (position) {
            waypointDistances = waypoints.map(wp => {
                const lat = wp.lat || (37.4215 + (wp.y - 50) * 0.002);
                const lon = wp.lon || (-119.1892 + (wp.x - 50) * 0.004);
                const nav = GPSModule.getNavigationTo(lat, lon);
                return { ...wp, nav };
            }).filter(wp => wp.nav).sort((a, b) => a.nav.distance - b.nav.distance);
        }
        
        // Format position display
        const formatCoord = (lat, lon) => {
            const latDir = lat >= 0 ? 'N' : 'S';
            const lonDir = lon >= 0 ? 'E' : 'W';
            return `${Math.abs(lat).toFixed(5)}¬∞ ${latDir}, ${Math.abs(lon).toFixed(5)}¬∞ ${lonDir}`;
        };
        
        container.innerHTML = `
            <div class="panel__header">
                <h2 class="panel__title">GPS</h2>
                ${isTracking ? `
                    <span style="padding:4px 10px;background:rgba(34,197,94,0.15);border-radius:12px;font-size:11px;color:#22c55e;font-weight:500">
                        ‚óè ACTIVE
                    </span>
                ` : ''}
            </div>
            
            <!-- GPS Status Card -->
            <div class="status-card ${position ? 'status-card--success' : (gpsState.error ? 'status-card--error' : '')}" style="margin-bottom:16px">
                <div class="status-card__icon">
                    ${Icons.get(position ? 'check' : (gpsState.error ? 'alert' : 'locate'))}
                </div>
                <div>
                    <div class="status-card__title">
                        ${position ? 'GPS Signal Acquired' : (gpsState.error || 'No GPS Signal')}
                    </div>
                    <div class="status-card__desc">
                        ${position ? `Fix: ${gpsState.fix || '3D'} ‚Ä¢ Accuracy: ${GPSModule.formatAccuracy(gpsState.accuracy)}` : 
                          (gpsState.error ? 'Check location permissions' : 'Waiting for signal...')}
                    </div>
                </div>
            </div>
            
            <!-- Current Position -->
            ${position ? `
                <div style="padding:14px;background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.2);border-radius:12px;margin-bottom:16px">
                    <div style="font-size:11px;color:rgba(255,255,255,0.5);margin-bottom:6px">CURRENT POSITION</div>
                    <div style="font-size:14px;font-family:monospace;margin-bottom:8px">
                        ${formatCoord(position.lat, position.lon)}
                    </div>
                    <div class="stat-grid stat-grid--3">
                        <div style="text-align:center">
                            <div style="font-size:16px;font-weight:600">${gpsState.altitude ? Math.round(gpsState.altitude * 3.28084) : '--'}</div>
                            <div style="font-size:9px;color:rgba(255,255,255,0.4)">ALT (FT)</div>
                        </div>
                        <div style="text-align:center">
                            <div style="font-size:16px;font-weight:600">${gpsState.speed ? GPSModule.formatSpeed(gpsState.speed) : '--'}</div>
                            <div style="font-size:9px;color:rgba(255,255,255,0.4)">SPEED</div>
                        </div>
                        <div style="text-align:center">
                            <div style="font-size:16px;font-weight:600">${gpsState.heading !== null ? Math.round(gpsState.heading) + '¬∞' : '--'}</div>
                            <div style="font-size:9px;color:rgba(255,255,255,0.4)">HEADING</div>
                        </div>
                    </div>
                </div>
            ` : ''}
            
            <!-- Manual Position Section -->
            ${renderManualPositionCard()}
            
            <!-- Tracking Controls -->
            <div style="display:flex;gap:8px;margin-bottom:16px">
                ${!isTracking ? `
                    <button class="btn btn--primary" id="gps-start" style="flex:1">
                        ${Icons.get('locate')} Start Tracking
                    </button>
                ` : `
                    <button class="btn btn--secondary" id="gps-stop" style="flex:1;color:#ef4444">
                        ${Icons.get('close')} Stop Tracking
                    </button>
                `}
                <button class="btn btn--secondary" id="gps-center" ${!position ? 'disabled' : ''} title="Center map on position">
                    ${Icons.get('locate')}
                </button>
            </div>
            
            <div class="divider"></div>
            
            <!-- Breadcrumb Trail Recording -->
            <div class="section-label">Breadcrumb Trail</div>
            <div style="padding:14px;background:var(--color-bg-elevated);border-radius:12px;margin-bottom:16px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                    <div>
                        <div style="font-size:13px;font-weight:500">${isRecording ? 'Recording...' : 'Not Recording'}</div>
                        <div style="font-size:11px;color:rgba(255,255,255,0.5)">
                            ${recordedTrack.length} points ${isRecording && recordedTrack.length > 1 ? 
                                `‚Ä¢ ${GPSModule.formatDistance(GPSModule.haversineDistance(
                                    recordedTrack[0].lat, recordedTrack[0].lon,
                                    recordedTrack[recordedTrack.length-1].lat, recordedTrack[recordedTrack.length-1].lon
                                ))}` : ''}
                        </div>
                    </div>
                    ${isRecording ? `
                        <div style="width:12px;height:12px;background:#ef4444;border-radius:50%;animation:pulse 1s infinite"></div>
                    ` : ''}
                </div>
                
                <div style="display:flex;gap:8px">
                    ${!isRecording ? `
                        <button class="btn btn--success" id="trail-start" style="flex:1" ${!isTracking ? 'disabled' : ''}>
                            ‚óè Start Recording
                        </button>
                    ` : `
                        <button class="btn btn--secondary" id="trail-stop" style="flex:1">
                            ‚ñ† Stop & Save
                        </button>
                    `}
                    <button class="btn btn--secondary" id="trail-clear" ${recordedTrack.length === 0 ? 'disabled' : ''}>
                        ${Icons.get('trash')}
                    </button>
                </div>
            </div>
            
            ${recordedTrack.length > 1 ? `
                <button class="btn btn--secondary btn--full" id="trail-to-route" style="margin-bottom:16px">
                    ${Icons.get('route')} Convert Trail to Route
                </button>
            ` : ''}
            
            <div class="divider"></div>
            
            <!-- Navigation to Waypoint -->
            <div class="section-label">Navigate to Waypoint</div>
            
            ${navInfo ? `
                <!-- Active Navigation -->
                <div style="padding:16px;background:linear-gradient(135deg,rgba(249,115,22,0.15),rgba(234,88,12,0.1));border:1px solid rgba(249,115,22,0.3);border-radius:14px;margin-bottom:16px">
                    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px">
                        <div>
                            <div style="font-size:11px;color:rgba(255,255,255,0.5)">NAVIGATING TO</div>
                            <div style="font-size:16px;font-weight:600;color:#f97316">${navInfo.waypoint.name}</div>
                        </div>
                        <button class="btn btn--secondary" id="nav-stop" style="padding:6px">‚úï</button>
                    </div>
                    
                    <div style="display:flex;gap:16px;margin-bottom:12px">
                        <!-- Distance -->
                        <div style="flex:1;text-align:center;padding:12px;background:rgba(0,0,0,0.2);border-radius:10px">
                            <div style="font-size:28px;font-weight:700;color:#fff">${navInfo.distanceFormatted}</div>
                            <div style="font-size:10px;color:rgba(255,255,255,0.5)">DISTANCE</div>
                        </div>
                        
                        <!-- Bearing -->
                        <div style="flex:1;text-align:center;padding:12px;background:rgba(0,0,0,0.2);border-radius:10px">
                            <div style="font-size:28px;font-weight:700;color:#fff">${navInfo.bearingFormatted}</div>
                            <div style="font-size:10px;color:rgba(255,255,255,0.5)">BEARING</div>
                        </div>
                    </div>
                    
                    ${navInfo.eta ? `
                        <div style="text-align:center;padding:8px;background:rgba(0,0,0,0.15);border-radius:8px">
                            <span style="color:rgba(255,255,255,0.6)">ETA:</span>
                            <span style="font-weight:600;margin-left:6px">${navInfo.etaFormatted}</span>
                        </div>
                    ` : ''}
                    
                    ${navInfo.relativeBearing !== null ? `
                        <!-- Compass Arrow -->
                        <div style="margin-top:12px;display:flex;justify-content:center">
                            <div style="width:60px;height:60px;border-radius:50%;background:rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;position:relative">
                                <div style="position:absolute;top:4px;font-size:10px;color:rgba(255,255,255,0.4)">N</div>
                                <div style="transform:rotate(${navInfo.relativeBearing}deg);transition:transform 0.3s">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="#f97316">
                                        <path d="M12 2 L20 20 L12 16 L4 20 Z"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div style="text-align:center;margin-top:6px;font-size:11px;color:rgba(255,255,255,0.5)">
                            ${navInfo.relativeBearing > 0 ? `Turn ${Math.abs(Math.round(navInfo.relativeBearing))}¬∞ right` :
                              navInfo.relativeBearing < 0 ? `Turn ${Math.abs(Math.round(navInfo.relativeBearing))}¬∞ left` : 'Straight ahead'}
                        </div>
                    ` : ''}
                </div>
            ` : ''}
            
            <!-- Waypoint List with Distances -->
            ${waypoints.length > 0 ? `
                <div style="max-height:250px;overflow-y:auto">
                    ${waypointDistances.slice(0, 10).map(wp => {
                        const type = Constants.WAYPOINT_TYPES[wp.type] || Constants.WAYPOINT_TYPES.custom;
                        const isTarget = selectedNavTarget === wp.id;
                        return `
                            <div class="card ${isTarget ? 'card--selected' : ''}" style="margin-bottom:8px;cursor:pointer" data-nav-wp="${wp.id}">
                                <div class="card__header">
                                    <div class="card__icon" style="background:${type.color}22;font-size:16px">${type.icon}</div>
                                    <div style="flex:1">
                                        <div class="card__title">${wp.name}</div>
                                        <div class="card__subtitle">${wp.nav ? wp.nav.bearingFormatted : '--'}</div>
                                    </div>
                                    <div style="text-align:right">
                                        <div style="font-size:14px;font-weight:600;color:#f97316">${wp.nav ? wp.nav.distanceFormatted : '--'}</div>
                                        ${wp.nav && wp.nav.eta ? `<div style="font-size:10px;color:rgba(255,255,255,0.4)">${wp.nav.etaFormatted}</div>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                ${waypointDistances.length > 10 ? `
                    <div style="text-align:center;padding:8px;font-size:11px;color:rgba(255,255,255,0.4)">
                        + ${waypointDistances.length - 10} more waypoints
                    </div>
                ` : ''}
            ` : `
                <div class="empty-state" style="padding:20px">
                    <div style="font-size:12px;color:rgba(255,255,255,0.5)">No waypoints to navigate to</div>
                </div>
            `}
            
            <div class="divider"></div>
            
            <!-- Barometric Altimeter -->
            <div class="section-label">üìä Barometric Altimeter</div>
            <div id="barometer-section" style="margin-bottom:16px">
                ${typeof BarometerModule !== 'undefined' ? BarometerModule.renderPanel() : `
                    <div style="padding:12px;background:var(--color-bg-elevated);border-radius:8px;text-align:center;font-size:12px;color:rgba(255,255,255,0.5)">
                        Barometer module not available
                    </div>
                `}
            </div>
            
            <div class="divider"></div>
            
            <!-- GPS Source Selection -->
            <div class="section-label">GPS Source</div>
            <div style="display:flex;flex-direction:column;gap:8px">
                <button class="btn ${gpsState.source === 'internal' ? 'btn--primary' : 'btn--secondary'}" id="gps-internal" style="justify-content:flex-start">
                    üì± Internal GPS (Device)
                </button>
                ${GPSModule.isSerialAvailable && GPSModule.isSerialAvailable() ? `
                    <button class="btn ${gpsState.source === 'serial' ? 'btn--primary' : 'btn--secondary'}" id="gps-serial" style="justify-content:flex-start">
                        üîå External GPS (USB/Serial)
                    </button>
                ` : ''}
                <button class="btn ${gpsState.source === 'simulation' ? 'btn--primary' : 'btn--secondary'}" id="gps-simulate" style="justify-content:flex-start">
                    üß™ Simulate GPS (Testing)
                </button>
            </div>
        `;
        
        // Event handlers
        
        // Start/Stop tracking
        const startBtn = container.querySelector('#gps-start');
        if (startBtn) {
            startBtn.onclick = () => {
                GPSModule.startInternalGPS();
                // Set up continuous UI updates
                setupGPSUpdates();
            };
        }
        
        const stopBtn = container.querySelector('#gps-stop');
        if (stopBtn) {
            stopBtn.onclick = () => {
                GPSModule.stop();
                resetGPSCenterFlag();  // Reset so next start will auto-center again
                renderGPS();
            };
        }
        
        // Center map
        const centerBtn = container.querySelector('#gps-center');
        if (centerBtn) {
            centerBtn.onclick = () => {
                if (position) {
                    MapModule.setCenter(position.lat, position.lon);
                }
            };
        }
        
        // Trail recording
        const trailStartBtn = container.querySelector('#trail-start');
        if (trailStartBtn) {
            trailStartBtn.onclick = () => {
                GPSModule.startRecording();
                renderGPS();
            };
        }
        
        const trailStopBtn = container.querySelector('#trail-stop');
        if (trailStopBtn) {
            trailStopBtn.onclick = () => {
                const track = GPSModule.stopRecording();
                if (track && track.points.length > 1) {
                    ModalsModule.showToast(`Trail saved: ${track.points.length} points, ${GPSModule.formatDistance(track.distance)}`, 'success');
                }
                renderGPS();
            };
        }
        
        const trailClearBtn = container.querySelector('#trail-clear');
        if (trailClearBtn) {
            trailClearBtn.onclick = () => {
                if (confirm('Clear the recorded trail?')) {
                    GPSModule.clearRecordedTrack();
                    renderGPS();
                }
            };
        }
        
        // Convert trail to route
        const trailToRouteBtn = container.querySelector('#trail-to-route');
        if (trailToRouteBtn) {
            trailToRouteBtn.onclick = () => {
                const route = GPSModule.trackToRoute('GPS Trail ' + new Date().toLocaleString());
                if (route) {
                    State.Routes.add(route);
                    Storage.Routes.save(route);
                    GPSModule.clearRecordedTrack();
                    ModalsModule.showToast('Trail converted to route!', 'success');
                    renderGPS();
                }
            };
        }
        
        // Navigation target selection
        container.querySelectorAll('[data-nav-wp]').forEach(card => {
            card.onclick = () => {
                const wpId = card.dataset.navWp;
                if (State.get('gpsNavTarget') === wpId) {
                    State.set('gpsNavTarget', null); // Deselect
                } else {
                    State.set('gpsNavTarget', wpId);
                }
                renderGPS();
            };
        });
        
        // Barometer handlers
        const baroSection = container.querySelector('#barometer-section');
        if (baroSection && typeof BarometerModule !== 'undefined') {
            BarometerModule.attachHandlers(baroSection);
            
            // Subscribe to barometer updates
            BarometerModule.subscribe((event, data) => {
                if (event === 'reading' || event === 'start' || event === 'stop' || event === 'calibrate' || event === 'error') {
                    baroSection.innerHTML = BarometerModule.renderPanel();
                    BarometerModule.attachHandlers(baroSection);
                }
            });
        }
        
        // Stop navigation
        const navStopBtn = container.querySelector('#nav-stop');
        if (navStopBtn) {
            navStopBtn.onclick = () => {
                State.set('gpsNavTarget', null);
                renderGPS();
            };
        }
        
        // GPS source selection
        const internalBtn = container.querySelector('#gps-internal');
        if (internalBtn) {
            internalBtn.onclick = () => {
                GPSModule.stop();
                GPSModule.startInternalGPS();
                setupGPSUpdates();
            };
        }
        
        const serialBtn = container.querySelector('#gps-serial');
        if (serialBtn) {
            serialBtn.onclick = async () => {
                try {
                    GPSModule.stop();
                    await GPSModule.connectSerialGPS();
                    setupGPSUpdates();
                    ModalsModule.showToast('External GPS connected!', 'success');
                } catch (e) {
                    ModalsModule.showToast(e.message, 'error');
                }
            };
        }
        
        const simulateBtn = container.querySelector('#gps-simulate');
        if (simulateBtn) {
            simulateBtn.onclick = () => {
                GPSModule.stop();
                GPSModule.startSimulation();
                setupGPSUpdates();
                ModalsModule.showToast('GPS simulation started', 'info');
            };
        }
        
        // Manual position handlers
        const setManualBtn = container.querySelector('#gps-set-manual');
        if (setManualBtn) {
            setManualBtn.onclick = () => {
                openManualPositionModal();
            };
        }
        
        const editManualBtn = container.querySelector('#gps-edit-manual');
        if (editManualBtn) {
            editManualBtn.onclick = () => {
                openManualPositionModal();
            };
        }
        
        const clearManualBtn = container.querySelector('#gps-clear-manual');
        if (clearManualBtn) {
            clearManualBtn.onclick = () => {
                GPSModule.clearManualPosition();
                ModalsModule.showToast('Manual position cleared', 'info');
                renderGPS();
                if (typeof MapModule !== 'undefined') MapModule.render();
            };
        }
        
        const preferManualCheckbox = container.querySelector('#gps-prefer-manual');
        if (preferManualCheckbox) {
            preferManualCheckbox.onchange = () => {
                GPSModule.setPreferManual(preferManualCheckbox.checked);
                renderGPS();
                if (typeof MapModule !== 'undefined') MapModule.render();
            };
        }
    }
    
    // GPS update subscription
    let gpsUpdateUnsubscribe = null;
    let initialGPSCenterDone = false;  // Track if we've centered on first fix
    
    function setupGPSUpdates(resetInitialCenter = true) {
        // Reset the initial center flag when starting fresh
        if (resetInitialCenter) {
            initialGPSCenterDone = false;
        }
        
        if (gpsUpdateUnsubscribe) return; // Already subscribed
        
        gpsUpdateUnsubscribe = GPSModule.subscribe((gpsState) => {
            // Auto-center map on first valid GPS fix
            if (!initialGPSCenterDone && gpsState.currentPosition && gpsState.isTracking) {
                initialGPSCenterDone = true;
                MapModule.setCenter(
                    gpsState.currentPosition.lat, 
                    gpsState.currentPosition.lon, 
                    15  // Zoom level 15 for good local detail
                );
                ModalsModule.showToast('GPS fix acquired - map centered', 'success');
            }
            
            // Only re-render GPS panel if it's active
            if (State.get('activePanel') === 'gps') {
                renderGPS();
            }
            // Always update map for position
            MapModule.render();
        });
    }
    
    // Reset initial center flag when GPS stops
    function resetGPSCenterFlag() {
        initialGPSCenterDone = false;
    }

    // Weather panel state
    let weatherData = null;
    let routeWeatherData = null;
    let weatherLoading = false;
    let weatherError = null;
    
    // Air Quality state
    let aqiData = null;
    let aqiLoading = false;
    let aqiError = null;
    
    // Satellite/Radar imagery state
    let activeSatLayer = null;
    let satLayerOpacity = 0.7;
    
    // AQI map layer state
    let aqiLayerActive = false;

    async function renderWeather() {
        _saveScroll(); _restoreScroll();
        // Check WeatherModule availability
        if (typeof WeatherModule === 'undefined') {
            container.innerHTML = `
                <div class="panel__header"><h2 class="panel__title">Weather</h2></div>
                <div class="empty-state">
                    <div class="empty-state__icon">${Icons.get('alert')}</div>
                    <div class="empty-state__title">Weather Module Not Loaded</div>
                    <div class="empty-state__desc">Weather functionality is not available.</div>
                </div>
            `;
            return;
        }

        const routes = State.get('routes').filter(r => !r.isBuilding);
        const waypoints = State.get('waypoints');
        const selectedRoute = routes.length > 0 ? routes[0] : null;

        container.innerHTML = `
            <div class="panel__header">
                <h2 class="panel__title">Weather</h2>
                <button class="btn btn--secondary" id="weather-refresh" style="padding:6px 10px">
                    ${Icons.get('locate')} Refresh
                </button>
            </div>
            
            ${weatherLoading ? `
                <div style="padding:40px;text-align:center">
                    <div style="font-size:24px;margin-bottom:12px">üå§Ô∏è</div>
                    <div style="color:rgba(255,255,255,0.6)">Loading weather data...</div>
                </div>
            ` : weatherError ? `
                <div class="status-card status-card--error" style="margin-bottom:16px">
                    <div class="status-card__icon">${Icons.get('alert')}</div>
                    <div>
                        <div class="status-card__title">Weather Error</div>
                        <div class="status-card__desc">${weatherError}</div>
                    </div>
                </div>
            ` : ''}
            
            ${!weatherLoading && weatherData ? `
                <!-- Current Conditions -->
                <div class="section-label">Current Conditions</div>
                <div style="padding:16px;background:linear-gradient(135deg,rgba(59,130,246,0.15),rgba(37,99,235,0.1));border:1px solid rgba(59,130,246,0.3);border-radius:14px;margin-bottom:16px">
                    <div style="display:flex;align-items:center;gap:16px;margin-bottom:12px">
                        <div style="font-size:48px">${weatherData.current.weather.icon}</div>
                        <div>
                            <div style="font-size:36px;font-weight:700">${WeatherModule.formatTemp(weatherData.current.temperature)}</div>
                            <div style="font-size:13px;color:rgba(255,255,255,0.6)">${weatherData.current.weather.desc}</div>
                        </div>
                    </div>
                    
                    <div class="stat-grid stat-grid--3">
                        <div style="text-align:center;padding:8px;background:rgba(0,0,0,0.2);border-radius:8px">
                            <div style="font-size:14px;font-weight:600">${WeatherModule.formatTemp(weatherData.current.feelsLike)}</div>
                            <div style="font-size:9px;color:rgba(255,255,255,0.4)">FEELS LIKE</div>
                        </div>
                        <div style="text-align:center;padding:8px;background:rgba(0,0,0,0.2);border-radius:8px">
                            <div style="font-size:14px;font-weight:600">${weatherData.current.humidity}%</div>
                            <div style="font-size:9px;color:rgba(255,255,255,0.4)">HUMIDITY</div>
                        </div>
                        <div style="text-align:center;padding:8px;background:rgba(0,0,0,0.2);border-radius:8px">
                            <div style="font-size:14px;font-weight:600">${Math.round(weatherData.current.windSpeed)} mph ${WeatherModule.windDirectionToCardinal(weatherData.current.windDirection)}</div>
                            <div style="font-size:9px;color:rgba(255,255,255,0.4)">WIND</div>
                        </div>
                        <div style="text-align:center;padding:8px;background:rgba(0,0,0,0.2);border-radius:8px">
                            <div style="font-size:14px;font-weight:600">${weatherData.current.dewpoint != null ? WeatherModule.formatTemp(weatherData.current.dewpoint) : '--'}</div>
                            <div style="font-size:9px;color:rgba(255,255,255,0.4)">DEWPOINT</div>
                        </div>
                        <div style="text-align:center;padding:8px;background:rgba(0,0,0,0.2);border-radius:8px">
                            <div style="font-size:14px;font-weight:600">${weatherData.current.uvIndex != null ? weatherData.current.uvIndex.toFixed(1) : '--'}</div>
                            <div style="font-size:9px;color:rgba(255,255,255,0.4)">UV INDEX</div>
                        </div>
                        <div style="text-align:center;padding:8px;background:rgba(0,0,0,0.2);border-radius:8px">
                            <div style="font-size:14px;font-weight:600">${weatherData.current.cloudCover}%</div>
                            <div style="font-size:9px;color:rgba(255,255,255,0.4)">CLOUD COVER</div>
                        </div>
                    </div>
                    
                    ${weatherData.current.windGusts > weatherData.current.windSpeed + 5 ? `
                        <div style="margin-top:8px;padding:8px;background:rgba(245,158,11,0.15);border-radius:6px;font-size:12px;color:#f59e0b">
                            üí® Gusts up to ${Math.round(weatherData.current.windGusts)} mph
                        </div>
                    ` : ''}
                </div>
                
                <!-- Air Quality Index -->
                <div class="section-label" style="display:flex;align-items:center;justify-content:space-between">
                    <span>Air Quality</span>
                    <button class="btn btn--ghost" id="aqi-refresh" style="padding:2px 6px;font-size:10px" title="Refresh AQI data">
                        ${Icons.get('locate')}
                    </button>
                </div>
                <div id="aqi-container" style="margin-bottom:16px">
                    ${aqiLoading ? `
                        <div style="padding:16px;text-align:center;background:var(--color-bg-elevated);border-radius:10px">
                            <div style="color:rgba(255,255,255,0.5);font-size:12px">Loading air quality data...</div>
                        </div>
                    ` : aqiData ? (
                        aqiData.available ? 
                            AirQualityModule.renderAQIBadge(aqiData) : 
                            AirQualityModule.renderUnavailable(aqiData)
                    ) : `
                        <div style="padding:12px;background:var(--color-bg-elevated);border-radius:10px;text-align:center">
                            <div style="font-size:12px;color:rgba(255,255,255,0.5)">
                                ${typeof AirQualityModule !== 'undefined' ? 
                                    'Click refresh to load AQI data' : 
                                    'Air quality module not available'}
                            </div>
                        </div>
                    `}
                </div>
                
                <!-- 7-Day Forecast -->
                <div class="section-label">7-Day Forecast</div>
                <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px">
                    ${weatherData.daily.slice(0, 7).map((day, i) => `
                        <div style="display:flex;align-items:center;padding:10px;background:var(--color-bg-elevated);border-radius:8px">
                            <div style="width:70px;font-size:12px;color:rgba(255,255,255,0.6)">
                                ${i === 0 ? 'Today' : WeatherModule.formatDate(day.date)}
                            </div>
                            <div style="font-size:20px;width:40px;text-align:center">${day.weather.icon}</div>
                            <div style="flex:1;font-size:12px;color:rgba(255,255,255,0.5)">${day.weather.desc}</div>
                            <div style="text-align:right">
                                <span style="font-weight:600">${Math.round(day.tempMax)}¬∞</span>
                                <span style="color:rgba(255,255,255,0.4);margin-left:4px">${Math.round(day.tempMin)}¬∞</span>
                            </div>
                            ${day.precipProbability > 20 ? `
                                <div style="width:40px;text-align:right;font-size:11px;color:#3b82f6">
                                    üíß${day.precipProbability}%
                                </div>
                            ` : '<div style="width:40px"></div>'}
                        </div>
                    `).join('')}
                </div>
                
                <!-- Hourly Forecast (next 24 hours) -->
                <div class="section-label">Next 24 Hours</div>
                <div style="display:flex;overflow-x:auto;gap:8px;padding-bottom:8px;margin-bottom:16px">
                    ${weatherData.hourly.slice(0, 24).map((hour, i) => {
                        const time = new Date(hour.time);
                        const hourStr = i === 0 ? 'Now' : time.toLocaleTimeString('en-US', { hour: 'numeric', hour12: true });
                        return `
                            <div style="flex-shrink:0;width:60px;padding:10px 8px;background:var(--color-bg-elevated);border-radius:8px;text-align:center">
                                <div style="font-size:10px;color:rgba(255,255,255,0.5);margin-bottom:4px">${hourStr}</div>
                                <div style="font-size:18px;margin-bottom:4px">${hour.weather.icon}</div>
                                <div style="font-size:14px;font-weight:600">${Math.round(hour.temperature)}¬∞</div>
                                ${hour.precipProbability > 20 ? `
                                    <div style="font-size:10px;color:#3b82f6;margin-top:2px">üíß${hour.precipProbability}%</div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            ` : !weatherLoading ? `
                <div class="empty-state" style="padding:30px">
                    <div style="font-size:40px;margin-bottom:12px">üå§Ô∏è</div>
                    <div class="empty-state__title">No Weather Data</div>
                    <div class="empty-state__desc">Click refresh to load current conditions</div>
                </div>
            ` : ''}
            
            <div class="divider"></div>
            
            <!-- Route Weather Analysis -->
            <div class="section-label">Route Weather Analysis</div>
            
            ${selectedRoute ? `
                <div style="padding:12px;background:var(--color-bg-elevated);border-radius:10px;margin-bottom:12px">
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
                        <span style="color:#f97316">${Icons.get('route')}</span>
                        <span style="font-weight:500">${selectedRoute.name}</span>
                    </div>
                    <button class="btn btn--primary btn--full" id="analyze-route-weather">
                        üå¶Ô∏è Analyze Route Weather
                    </button>
                </div>
                
                ${routeWeatherData ? `
                    <!-- Route Weather Summary -->
                    <div class="status-card ${
                        routeWeatherData.summary.status === 'good' ? 'status-card--success' : 
                        routeWeatherData.summary.status === 'hazardous' ? 'status-card--error' : ''
                    }" style="margin-bottom:16px;background:${
                        routeWeatherData.summary.status === 'fair' ? 'rgba(59,130,246,0.1)' : 
                        routeWeatherData.summary.status === 'poor' ? 'rgba(245,158,11,0.1)' : ''
                    };border-color:${
                        routeWeatherData.summary.status === 'fair' ? 'rgba(59,130,246,0.2)' :
                        routeWeatherData.summary.status === 'poor' ? 'rgba(245,158,11,0.2)' : ''
                    }">
                        <div class="status-card__icon" style="color:${WeatherModule.getStatusColor(routeWeatherData.summary.status)}">
                            ${routeWeatherData.summary.dominantCondition.icon}
                        </div>
                        <div>
                            <div class="status-card__title" style="color:${WeatherModule.getStatusColor(routeWeatherData.summary.status)}">
                                ${routeWeatherData.summary.status.charAt(0).toUpperCase() + routeWeatherData.summary.status.slice(1)} Conditions
                            </div>
                            <div class="status-card__desc">${routeWeatherData.summary.message}</div>
                        </div>
                    </div>
                    
                    <!-- Weather Alerts -->
                    ${routeWeatherData.alerts.length > 0 ? `
                        <div class="section-label">‚ö†Ô∏è Weather Alerts (${routeWeatherData.alerts.length})</div>
                        <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px">
                            ${routeWeatherData.alerts.slice(0, 5).map(alert => `
                                <div style="padding:12px;background:${
                                    alert.severity === 'critical' ? 'rgba(239,68,68,0.15)' :
                                    alert.severity === 'warning' ? 'rgba(245,158,11,0.15)' : 'rgba(59,130,246,0.1)'
                                };border:1px solid ${
                                    alert.severity === 'critical' ? 'rgba(239,68,68,0.3)' :
                                    alert.severity === 'warning' ? 'rgba(245,158,11,0.3)' : 'rgba(59,130,246,0.2)'
                                };border-radius:10px">
                                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
                                        <span style="font-size:18px">${alert.icon}</span>
                                        <span style="font-weight:600;color:${WeatherModule.getSeverityColor(alert.severity)}">${alert.message}</span>
                                    </div>
                                    <div style="font-size:11px;color:rgba(255,255,255,0.5);margin-bottom:4px">üìç ${alert.location}</div>
                                    <div style="font-size:12px;color:rgba(255,255,255,0.7)">${alert.recommendation}</div>
                                </div>
                            `).join('')}
                        </div>
                    ` : `
                        <div style="padding:12px;background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.2);border-radius:10px;margin-bottom:16px;text-align:center">
                            <span style="color:#22c55e">‚úÖ No weather alerts for this route</span>
                        </div>
                    `}
                    
                    <!-- Recommendations -->
                    ${routeWeatherData.recommendations.length > 0 ? `
                        <div class="section-label">üìã Recommendations</div>
                        <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:16px">
                            ${routeWeatherData.recommendations.map(rec => `
                                <div style="padding:10px 12px;background:var(--color-bg-elevated);border-radius:8px;display:flex;align-items:flex-start;gap:10px">
                                    <span style="font-size:16px">${rec.icon}</span>
                                    <span style="font-size:12px;color:rgba(255,255,255,0.8);line-height:1.4">${rec.text}</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    <!-- Best Travel Windows -->
                    ${routeWeatherData.bestWindows.length > 0 ? `
                        <div class="section-label">üïê Best Travel Windows</div>
                        <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px">
                            ${routeWeatherData.bestWindows.map((window, i) => {
                                const startTime = window.start.toLocaleString('en-US', { 
                                    weekday: 'short', hour: 'numeric', hour12: true 
                                });
                                const endTime = window.end.toLocaleTimeString('en-US', { 
                                    hour: 'numeric', hour12: true 
                                });
                                const scoreColor = window.score >= 70 ? '#22c55e' : window.score >= 50 ? '#f59e0b' : '#ef4444';
                                return `
                                    <div style="padding:12px;background:var(--color-bg-elevated);border-radius:10px;${i === 0 ? 'border:1px solid rgba(34,197,94,0.3)' : ''}">
                                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                                            <span style="font-weight:500">${startTime} - ${endTime}</span>
                                            <span style="padding:2px 8px;background:${scoreColor}22;color:${scoreColor};border-radius:10px;font-size:11px;font-weight:600">
                                                ${window.score}% favorable
                                            </span>
                                        </div>
                                        <div style="font-size:12px;color:rgba(255,255,255,0.5)">
                                            Avg temp: ${Math.round(window.avgTemp)}¬∞F
                                            ${window.issues.length > 0 ? ' ‚Ä¢ Issues: ' + window.issues.join(', ') : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : ''}
                    
                    <!-- Weather Along Route -->
                    <div class="section-label">Weather Along Route</div>
                    <div style="display:flex;flex-direction:column;gap:8px">
                        ${routeWeatherData.points.map(point => {
                            const hasAqi = point.aqi?.available;
                            const aqiColor = hasAqi ? point.aqi.category.color : null;
                            const aqiBg = hasAqi ? aqiColor + '22' : null;
                            return `
                            <div style="padding:10px 12px;background:var(--color-bg-elevated);border-radius:8px;display:flex;align-items:center;gap:12px${hasAqi && point.aqi.aqi > 100 ? `;border-left:3px solid ${aqiColor}` : ''}">
                                <div style="font-size:24px">${point.weather?.current?.weather?.icon || '‚ùì'}</div>
                                <div style="flex:1">
                                    <div style="font-size:13px;font-weight:500">${point.name}</div>
                                    <div style="font-size:11px;color:rgba(255,255,255,0.5)">
                                        ${point.weather?.current ? point.weather.current.weather.desc : 'No data'}
                                    </div>
                                </div>
                                <div style="text-align:right">
                                    <div style="font-size:16px;font-weight:600">
                                        ${point.weather?.current ? Math.round(point.weather.current.temperature) + '¬∞' : '--'}
                                    </div>
                                    <div style="font-size:10px;color:rgba(255,255,255,0.4)">
                                        ${point.weather?.current ? Math.round(point.weather.current.windSpeed) + ' mph' : ''}
                                    </div>
                                </div>
                                ${hasAqi ? `
                                    <div style="padding:4px 8px;background:${aqiBg};border-radius:6px;text-align:center;min-width:50px">
                                        <div style="font-size:12px;font-weight:600;color:${aqiColor}">${point.aqi.aqi}</div>
                                        <div style="font-size:9px;color:rgba(255,255,255,0.5)">AQI</div>
                                    </div>
                                ` : ''}
                            </div>
                        `}).join('')}
                    </div>
                ` : ''}
            ` : `
                <div class="empty-state" style="padding:20px">
                    <div style="font-size:12px;color:rgba(255,255,255,0.5)">Create a route to analyze weather conditions</div>
                </div>
            `}
            
            <div class="divider"></div>
            
            <!-- Waypoint Weather -->
            ${waypoints.length > 0 ? `
                <div class="section-label">Waypoint Weather</div>
                <div style="font-size:12px;color:rgba(255,255,255,0.5);margin-bottom:12px">
                    Click a waypoint to view weather & air quality
                </div>
                <div style="display:flex;flex-direction:column;gap:8px">
                    ${waypoints.slice(0, 5).map(wp => {
                        const type = Constants.WAYPOINT_TYPES[wp.type] || Constants.WAYPOINT_TYPES.custom;
                        return `
                            <button class="card" style="text-align:left" data-weather-wp="${wp.id}">
                                <div class="card__header">
                                    <div class="card__icon" style="background:${type.color}22">${type.icon}</div>
                                    <div style="flex:1">
                                        <div class="card__title">${wp.name}</div>
                                        <div class="card__subtitle">Click to load weather</div>
                                    </div>
                                    <div class="wp-aqi-badge" style="display:none;padding:4px 8px;border-radius:6px;text-align:center;min-width:40px;margin-right:8px">
                                        <div class="wp-aqi-value" style="font-size:12px;font-weight:600"></div>
                                        <div style="font-size:8px;opacity:0.7">AQI</div>
                                    </div>
                                    <span class="wp-weather-icon" style="font-size:18px">üå§Ô∏è</span>
                                </div>
                            </button>
                        `;
                    }).join('')}
                </div>
                ${waypoints.length > 5 ? `
                    <div style="text-align:center;padding:8px;font-size:11px;color:rgba(255,255,255,0.4)">
                        + ${waypoints.length - 5} more waypoints
                    </div>
                ` : ''}
            ` : ''}
            
            <div class="divider"></div>
            
            <!-- Satellite & Radar Imagery -->
            <div class="section-label">üõ∞Ô∏è Satellite & Radar Imagery</div>
            <div style="margin-bottom:16px">
                ${typeof SatWeatherModule !== 'undefined' ? `
                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px">
                        <button class="btn ${activeSatLayer === 'nexrad_composite' ? 'btn--primary' : 'btn--secondary'}" 
                                data-sat-layer="nexrad_composite"
                                style="padding:12px 10px;display:flex;flex-direction:column;align-items:center;gap:4px">
                            <span style="font-size:20px">üì°</span>
                            <span style="font-size:11px">NEXRAD</span>
                        </button>
                        <button class="btn ${activeSatLayer === 'viirs_true_color' ? 'btn--primary' : 'btn--secondary'}" 
                                data-sat-layer="viirs_true_color"
                                style="padding:12px 10px;display:flex;flex-direction:column;align-items:center;gap:4px">
                            <span style="font-size:20px">üõ∞Ô∏è</span>
                            <span style="font-size:11px">Satellite</span>
                        </button>
                        <button class="btn ${activeSatLayer === 'modis_terra_true_color' ? 'btn--primary' : 'btn--secondary'}" 
                                data-sat-layer="modis_terra_true_color"
                                style="padding:12px 10px;display:flex;flex-direction:column;align-items:center;gap:4px">
                            <span style="font-size:20px">üåç</span>
                            <span style="font-size:11px">Terra</span>
                        </button>
                    </div>
                    
                    ${activeSatLayer ? `
                        <div style="padding:10px;background:var(--color-bg-elevated);border-radius:8px;margin-bottom:12px">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                                <span style="font-size:12px;font-weight:500">${SatWeatherModule.getProduct(activeSatLayer)?.name || activeSatLayer}</span>
                                <button class="btn btn--secondary" id="clear-sat-layer" style="padding:4px 8px;font-size:10px">
                                    Clear
                                </button>
                            </div>
                            <div style="display:flex;align-items:center;gap:10px">
                                <span style="font-size:10px;color:rgba(255,255,255,0.5)">Opacity</span>
                                <input type="range" id="sat-opacity" min="10" max="100" value="${Math.round(satLayerOpacity * 100)}" 
                                       style="flex:1;height:4px;accent-color:#f97316">
                                <span style="font-size:10px;color:rgba(255,255,255,0.5)">${Math.round(satLayerOpacity * 100)}%</span>
                            </div>
                        </div>
                    ` : `
                        <div style="padding:12px;background:var(--color-bg-elevated);border-radius:8px;text-align:center">
                            <span style="font-size:12px;color:rgba(255,255,255,0.5)">Select an overlay to view on map</span>
                        </div>
                    `}
                    
                    <div style="font-size:10px;color:rgba(255,255,255,0.4);text-align:center">
                        NEXRAD: NOAA/IEM (US) ‚Ä¢ Satellite: NASA GIBS (Global, Daily)
                    </div>
                ` : `
                    <div style="padding:16px;background:var(--color-bg-elevated);border-radius:8px;text-align:center">
                        <span style="color:rgba(255,255,255,0.5)">Satellite imagery module not available</span>
                    </div>
                `}
            </div>
            
            <!-- AQI Map Layer -->
            ${typeof AirQualityModule !== 'undefined' ? `
                <div class="section-label">üå¨Ô∏è Air Quality Overlay</div>
                <div style="margin-bottom:16px">
                    <button class="btn ${aqiLayerActive ? 'btn--primary' : 'btn--secondary'} btn--full" 
                            id="toggle-aqi-layer"
                            style="padding:12px;display:flex;align-items:center;justify-content:center;gap:10px">
                        <span style="font-size:20px">üí®</span>
                        <span>${aqiLayerActive ? 'Hide AQI Stations' : 'Show AQI Stations'}</span>
                    </button>
                    ${aqiLayerActive ? `
                        <div style="margin-top:10px;padding:10px;background:var(--color-bg-elevated);border-radius:8px">
                            <div style="font-size:11px;color:rgba(255,255,255,0.6);margin-bottom:8px">
                                Tap markers for details. Pan map to load more stations.
                            </div>
                            <div style="display:flex;flex-wrap:wrap;gap:6px;justify-content:center">
                                <span style="display:inline-flex;align-items:center;gap:4px;font-size:10px">
                                    <span style="width:10px;height:10px;border-radius:50%;background:#00E400"></span>Good
                                </span>
                                <span style="display:inline-flex;align-items:center;gap:4px;font-size:10px">
                                    <span style="width:10px;height:10px;border-radius:50%;background:#FFFF00"></span>Moderate
                                </span>
                                <span style="display:inline-flex;align-items:center;gap:4px;font-size:10px">
                                    <span style="width:10px;height:10px;border-radius:50%;background:#FF7E00"></span>USG
                                </span>
                                <span style="display:inline-flex;align-items:center;gap:4px;font-size:10px">
                                    <span style="width:10px;height:10px;border-radius:50%;background:#FF0000"></span>Unhealthy
                                </span>
                                <span style="display:inline-flex;align-items:center;gap:4px;font-size:10px">
                                    <span style="width:10px;height:10px;border-radius:50%;background:#8F3F97"></span>V.Unhealthy
                                </span>
                                <span style="display:inline-flex;align-items:center;gap:4px;font-size:10px">
                                    <span style="width:10px;height:10px;border-radius:50%;background:#7E0023"></span>Hazardous
                                </span>
                            </div>
                        </div>
                    ` : `
                        <div style="margin-top:8px;font-size:10px;color:rgba(255,255,255,0.4);text-align:center">
                            Shows EPA AirNow monitoring stations (US, Canada, Mexico)
                        </div>
                    `}
                </div>
            ` : ''}
            
            <!-- Weather Alerts & Monitoring -->
            ${typeof WeatherModule !== 'undefined' && typeof AlertModule !== 'undefined' ? (() => {
                const wxMonitoring = WeatherModule.isWeatherMonitoringEnabled();
                const wxSettings = WeatherModule.getWeatherMonitoringSettings();
                const wxAlertHistory = AlertModule.getHistory({ source: 'weather' }).slice(0, 5);
                const wxIntervalMin = Math.round((wxSettings.intervalMs || 1800000) / 60000);
                const wxLastCheck = wxSettings.lastCheck ? new Date(wxSettings.lastCheck) : null;
                const wxLastCond = wxSettings.lastConditions;
                const wxNws = wxSettings.nws || {};
                const wxWpEnabled = wxSettings.waypointMonitoring !== false;
                const wxWpCount = wxSettings.waypointCount || 0;
                const wxWpIntervalMin = Math.round((wxSettings.waypointIntervalMs || 3600000) / 60000);
                const wxWpLastCheck = wxSettings.waypointLastCheck ? new Date(wxSettings.waypointLastCheck) : null;
                const wxTh = wxSettings.thresholds || {};
                
                return `
                <div class="section-label">üå©Ô∏è Weather Alerts & Monitoring</div>
                <div style="margin-bottom:16px">
                    <!-- Monitoring Toggle -->
                    <div style="display:flex;gap:8px;margin-bottom:12px">
                        <button class="btn ${wxMonitoring ? 'btn--primary' : 'btn--secondary'}" 
                                id="toggle-weather-monitoring" style="flex:1;padding:10px">
                            ${wxMonitoring ? 'üîî Monitoring ON' : 'üîï Monitoring OFF'}
                        </button>
                        <button class="btn btn--secondary" id="weather-check-now" 
                                style="padding:10px" title="Check weather conditions now">
                            üîÑ
                        </button>
                    </div>
                    
                    ${wxMonitoring ? `
                        <!-- Monitoring Status -->
                        <div style="padding:10px;background:rgba(34,197,94,0.1);border-radius:8px;margin-bottom:12px">
                            <div style="display:flex;justify-content:space-between;font-size:11px;margin-bottom:6px">
                                <span style="color:rgba(255,255,255,0.6)">üìç Current location</span>
                                <span style="color:#22c55e">Every ${wxIntervalMin} min</span>
                            </div>
                            <!-- Alert Source Indicator -->
                            <div style="display:flex;justify-content:space-between;font-size:10px;margin-bottom:4px">
                                <span style="color:rgba(255,255,255,0.5)">Alert source</span>
                                ${wxNws.source === 'fisb' ? `
                                    <span style="color:#22c55e">üì° RF Sentinel FIS-B</span>
                                ` : `
                                    <span style="color:#3b82f6">üåê NWS API${wxNws.alertCount > 0 ? ` (${wxNws.alertCount} active)` : ''}</span>
                                `}
                            </div>
                            ${wxLastCheck ? `
                                <div style="display:flex;justify-content:space-between;font-size:10px;color:rgba(255,255,255,0.4)">
                                    <span>Last check</span>
                                    <span>${wxLastCheck.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                                </div>
                            ` : ''}
                            ${wxLastCond ? `
                                <div style="margin-top:6px;padding-top:6px;border-top:1px solid rgba(255,255,255,0.08);font-size:11px;color:rgba(255,255,255,0.6)">
                                    ${wxLastCond.icon || ''} ${wxLastCond.desc || ''} ¬∑ ${Math.round(wxLastCond.temperature || 0)}¬∞F ¬∑ Wind ${Math.round(wxLastCond.windSpeed || 0)} mph${wxLastCond.windGusts >= 30 ? ` (gusts ${Math.round(wxLastCond.windGusts)})` : ''}
                                </div>
                            ` : ''}
                            <!-- Waypoint Status -->
                            <div style="margin-top:6px;padding-top:6px;border-top:1px solid rgba(255,255,255,0.08);display:flex;justify-content:space-between;font-size:10px">
                                <span style="color:rgba(255,255,255,0.5)">üìå Waypoints (${wxWpCount})</span>
                                ${wxWpEnabled ? `
                                    <span style="color:#22c55e">Every ${wxWpIntervalMin} min${wxWpLastCheck ? ` ¬∑ ${wxWpLastCheck.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}` : ''}</span>
                                ` : `
                                    <span style="color:rgba(255,255,255,0.4)">Off</span>
                                `}
                            </div>
                        </div>
                    ` : `
                        <div style="padding:10px;background:var(--color-bg-elevated);border-radius:8px;margin-bottom:12px">
                            <div style="font-size:11px;color:rgba(255,255,255,0.5);text-align:center">
                                Monitors temperature, wind, and severe weather at your current position and waypoints. Triggers audible alerts when dangerous conditions are detected.
                                Uses NWS Weather Alerts API when RF Sentinel is disconnected.
                            </div>
                        </div>
                    `}
                    
                    <!-- Interval Selector -->
                    <div style="padding:12px;background:var(--color-bg-elevated);border-radius:8px;margin-bottom:12px">
                        <div style="font-size:11px;font-weight:600;margin-bottom:8px;color:rgba(255,255,255,0.7)">Position Check Interval</div>
                        <div style="display:flex;gap:6px">
                            ${[15, 30, 60].map(min => `
                                <button class="btn ${wxIntervalMin === min ? 'btn--primary' : 'btn--secondary'} weather-interval-btn" 
                                        data-interval="${min}" style="flex:1;padding:8px;font-size:11px">
                                    ${min} min
                                </button>
                            `).join('')}
                        </div>
                        <!-- Waypoint Monitoring Toggle -->
                        <div style="margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.1)">
                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                                <input type="checkbox" id="wx-waypoint-monitoring" ${wxWpEnabled ? 'checked' : ''}>
                                <span style="font-size:11px">Monitor waypoints (every ${wxWpIntervalMin} min)</span>
                                <span style="font-size:10px;color:rgba(255,255,255,0.4);margin-left:auto">${wxWpCount} saved</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Alert Thresholds Configuration -->
                    <div style="padding:12px;background:var(--color-bg-elevated);border-radius:8px;margin-bottom:12px">
                        <div style="font-size:11px;font-weight:600;margin-bottom:10px;color:rgba(255,255,255,0.7)">Alert Thresholds</div>
                        
                        <!-- Temperature -->
                        <div style="margin-bottom:10px">
                            <div style="font-size:10px;color:rgba(255,255,255,0.5);margin-bottom:6px">üå°Ô∏è Temperature (¬∞F)</div>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">
                                <div style="display:flex;align-items:center;gap:4px">
                                    <span style="width:8px;height:8px;border-radius:50%;background:#ef4444"></span>
                                    <span style="font-size:10px;color:rgba(255,255,255,0.5);white-space:nowrap">Ext Heat ‚â•</span>
                                    <input type="number" id="wx-th-extreme-heat" value="${wxTh.temperature?.extremeHeat ?? 100}" 
                                           style="width:48px;padding:3px;font-size:11px;text-align:center" min="80" max="130">
                                </div>
                                <div style="display:flex;align-items:center;gap:4px">
                                    <span style="width:8px;height:8px;border-radius:50%;background:#f59e0b"></span>
                                    <span style="font-size:10px;color:rgba(255,255,255,0.5);white-space:nowrap">Heat ‚â•</span>
                                    <input type="number" id="wx-th-heat" value="${wxTh.temperature?.heat ?? 90}" 
                                           style="width:48px;padding:3px;font-size:11px;text-align:center" min="70" max="120">
                                </div>
                                <div style="display:flex;align-items:center;gap:4px">
                                    <span style="width:8px;height:8px;border-radius:50%;background:#f59e0b"></span>
                                    <span style="font-size:10px;color:rgba(255,255,255,0.5);white-space:nowrap">Cold ‚â§</span>
                                    <input type="number" id="wx-th-cold" value="${wxTh.temperature?.cold ?? 32}" 
                                           style="width:48px;padding:3px;font-size:11px;text-align:center" min="-20" max="50">
                                </div>
                                <div style="display:flex;align-items:center;gap:4px">
                                    <span style="width:8px;height:8px;border-radius:50%;background:#ef4444"></span>
                                    <span style="font-size:10px;color:rgba(255,255,255,0.5);white-space:nowrap">Ext Cold ‚â§</span>
                                    <input type="number" id="wx-th-extreme-cold" value="${wxTh.temperature?.extremeCold ?? 10}" 
                                           style="width:48px;padding:3px;font-size:11px;text-align:center" min="-40" max="32">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Wind & Visibility -->
                        <div style="margin-bottom:10px">
                            <div style="font-size:10px;color:rgba(255,255,255,0.5);margin-bottom:6px">üí® Wind (mph) & üëÅÔ∏è Visibility (mi)</div>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">
                                <div style="display:flex;align-items:center;gap:4px">
                                    <span style="width:8px;height:8px;border-radius:50%;background:#ef4444"></span>
                                    <span style="font-size:10px;color:rgba(255,255,255,0.5);white-space:nowrap">Gusts ‚â•</span>
                                    <input type="number" id="wx-th-wind-extreme" value="${wxTh.wind?.extreme ?? 50}" 
                                           style="width:48px;padding:3px;font-size:11px;text-align:center" min="30" max="100">
                                </div>
                                <div style="display:flex;align-items:center;gap:4px">
                                    <span style="width:8px;height:8px;border-radius:50%;background:#f59e0b"></span>
                                    <span style="font-size:10px;color:rgba(255,255,255,0.5);white-space:nowrap">Wind ‚â•</span>
                                    <input type="number" id="wx-th-wind-high" value="${wxTh.wind?.high ?? 30}" 
                                           style="width:48px;padding:3px;font-size:11px;text-align:center" min="15" max="80">
                                </div>
                                <div style="display:flex;align-items:center;gap:4px">
                                    <span style="width:8px;height:8px;border-radius:50%;background:#3b82f6"></span>
                                    <span style="font-size:10px;color:rgba(255,255,255,0.5);white-space:nowrap">Vis ‚â§</span>
                                    <input type="number" id="wx-th-visibility" value="${wxTh.visibility?.poor ?? 1}" step="0.5"
                                           style="width:48px;padding:3px;font-size:11px;text-align:center" min="0.1" max="5">
                                </div>
                            </div>
                        </div>
                        
                        <button class="btn btn--secondary btn--full" id="save-wx-thresholds" style="padding:8px;font-size:11px">
                            Save Thresholds
                        </button>
                    </div>
                    
                    <!-- Alert History -->
                    ${wxAlertHistory.length > 0 ? `
                        <div style="padding:12px;background:var(--color-bg-elevated);border-radius:8px">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
                                <span style="font-size:11px;font-weight:600;color:rgba(255,255,255,0.7)">Recent Alerts</span>
                                <button class="btn btn--secondary" id="clear-weather-history" style="padding:4px 8px;font-size:10px">Clear</button>
                            </div>
                            <div style="max-height:150px;overflow-y:auto">
                                ${wxAlertHistory.map(alert => {
                                    const time = new Date(alert.timestamp);
                                    const timeStr = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                                    const dateStr = time.toLocaleDateString([], { month: 'short', day: 'numeric' });
                                    const severityColor = {
                                        caution: '#3b82f6',
                                        warning: '#f59e0b',
                                        critical: '#ef4444',
                                        emergency: '#7f1d1d'
                                    }[alert.severity] || '#3b82f6';
                                    
                                    return `
                                        <div style="padding:8px;border-left:3px solid ${severityColor};margin-bottom:6px;background:rgba(0,0,0,0.2);border-radius:0 6px 6px 0">
                                            <div style="display:flex;justify-content:space-between;font-size:10px;color:rgba(255,255,255,0.5)">
                                                <span>${dateStr} ${timeStr}</span>
                                                <span style="color:${severityColor}">${alert.severity}</span>
                                            </div>
                                            <div style="font-size:11px;margin-top:2px">${alert.title}: ${alert.message}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    ` : `
                        <div style="padding:12px;background:var(--color-bg-elevated);border-radius:8px;text-align:center">
                            <span style="font-size:11px;color:rgba(255,255,255,0.5)">No recent weather alerts</span>
                        </div>
                    `}
                </div>
                `;
            })() : ''}
            
            <!-- AQI Alerts & Monitoring -->
            ${typeof AirQualityModule !== 'undefined' && typeof AlertModule !== 'undefined' ? `
                <div class="section-label">üîî AQI Alerts & Monitoring</div>
                <div style="margin-bottom:16px">
                    ${AirQualityModule.getApiKey() ? (() => {
                        const monitoring = AirQualityModule.isMonitoringEnabled();
                        const settings = AirQualityModule.getMonitoringSettings();
                        const alertHistory = typeof AlertModule !== 'undefined' ? 
                            AlertModule.getHistory({ source: 'aqi' }).slice(0, 5) : [];
                        
                        return `
                            <!-- Monitoring Toggle -->
                            <div style="display:flex;gap:8px;margin-bottom:12px">
                                <button class="btn ${monitoring ? 'btn--primary' : 'btn--secondary'}" 
                                        id="toggle-aqi-monitoring" style="flex:1;padding:10px">
                                    ${monitoring ? 'üîî Monitoring ON' : 'üîï Monitoring OFF'}
                                </button>
                                <button class="btn btn--secondary" id="aqi-check-now" 
                                        style="padding:10px" title="Check all locations now">
                                    üîÑ
                                </button>
                            </div>
                            
                            ${monitoring ? `
                                <!-- Monitoring Status -->
                                <div style="padding:10px;background:rgba(34,197,94,0.1);border-radius:8px;margin-bottom:12px">
                                    <div style="display:flex;justify-content:space-between;font-size:11px;margin-bottom:6px">
                                        <span style="color:rgba(255,255,255,0.6)">üìç Current location</span>
                                        <span style="color:#22c55e">Every ${Math.round(settings.currentLocationInterval / 60000)} min</span>
                                    </div>
                                    <div style="display:flex;justify-content:space-between;font-size:11px">
                                        <span style="color:rgba(255,255,255,0.6)">üìå All waypoints</span>
                                        <span style="color:#22c55e">Every ${Math.round(settings.waypointInterval / 60000)} min</span>
                                    </div>
                                </div>
                            ` : ''}
                            
                            <!-- Settings -->
                            <div style="padding:12px;background:var(--color-bg-elevated);border-radius:8px;margin-bottom:12px">
                                <div style="font-size:11px;font-weight:600;margin-bottom:10px;color:rgba(255,255,255,0.7)">Alert Thresholds</div>
                                
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px">
                                    <div style="display:flex;align-items:center;gap:6px">
                                        <span style="width:8px;height:8px;border-radius:50%;background:#FF7E00"></span>
                                        <span style="font-size:10px;color:rgba(255,255,255,0.5)">Caution</span>
                                        <input type="number" id="aqi-threshold-caution" value="${settings.thresholds.caution}" 
                                               style="width:50px;padding:4px;font-size:11px;text-align:center" min="1" max="500">
                                    </div>
                                    <div style="display:flex;align-items:center;gap:6px">
                                        <span style="width:8px;height:8px;border-radius:50%;background:#FF0000"></span>
                                        <span style="font-size:10px;color:rgba(255,255,255,0.5)">Warning</span>
                                        <input type="number" id="aqi-threshold-warning" value="${settings.thresholds.warning}" 
                                               style="width:50px;padding:4px;font-size:11px;text-align:center" min="1" max="500">
                                    </div>
                                    <div style="display:flex;align-items:center;gap:6px">
                                        <span style="width:8px;height:8px;border-radius:50%;background:#8F3F97"></span>
                                        <span style="font-size:10px;color:rgba(255,255,255,0.5)">Critical</span>
                                        <input type="number" id="aqi-threshold-critical" value="${settings.thresholds.critical}" 
                                               style="width:50px;padding:4px;font-size:11px;text-align:center" min="1" max="500">
                                    </div>
                                    <div style="display:flex;align-items:center;gap:6px">
                                        <span style="width:8px;height:8px;border-radius:50%;background:#7E0023"></span>
                                        <span style="font-size:10px;color:rgba(255,255,255,0.5)">Emergency</span>
                                        <input type="number" id="aqi-threshold-emergency" value="${settings.thresholds.emergency}" 
                                               style="width:50px;padding:4px;font-size:11px;text-align:center" min="1" max="500">
                                    </div>
                                </div>
                                
                                <button class="btn btn--secondary btn--full" id="save-aqi-thresholds" style="padding:8px;font-size:11px">
                                    Save Thresholds
                                </button>
                                
                                <div style="margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.1)">
                                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                                        <input type="checkbox" id="aqi-sensitive-groups" ${settings.sensitiveGroups ? 'checked' : ''}>
                                        <span style="font-size:11px">Sensitive Groups Mode (lower thresholds)</span>
                                    </label>
                                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin-top:8px">
                                        <input type="checkbox" id="aqi-forecast-alerts" ${settings.forecastAlerts ? 'checked' : ''}>
                                        <span style="font-size:11px">Include forecast alerts</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Alert History -->
                            ${alertHistory.length > 0 ? `
                                <div style="padding:12px;background:var(--color-bg-elevated);border-radius:8px">
                                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
                                        <span style="font-size:11px;font-weight:600;color:rgba(255,255,255,0.7)">Recent Alerts</span>
                                        <button class="btn btn--secondary" id="clear-aqi-history" style="padding:4px 8px;font-size:10px">Clear</button>
                                    </div>
                                    <div style="max-height:150px;overflow-y:auto">
                                        ${alertHistory.map(alert => {
                                            const time = new Date(alert.timestamp);
                                            const timeStr = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                                            const dateStr = time.toLocaleDateString([], { month: 'short', day: 'numeric' });
                                            const severityColor = {
                                                caution: '#FF7E00',
                                                warning: '#FF0000',
                                                critical: '#8F3F97',
                                                emergency: '#7E0023'
                                            }[alert.severity] || '#3b82f6';
                                            
                                            return `
                                                <div style="padding:8px;border-left:3px solid ${severityColor};margin-bottom:6px;background:rgba(0,0,0,0.2);border-radius:0 6px 6px 0">
                                                    <div style="display:flex;justify-content:space-between;font-size:10px;color:rgba(255,255,255,0.5)">
                                                        <span>${dateStr} ${timeStr}</span>
                                                        <span>AQI ${alert.data?.aqi || '--'}</span>
                                                    </div>
                                                    <div style="font-size:11px;margin-top:2px">${alert.data?.locationName || 'Unknown'}</div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            ` : `
                                <div style="padding:12px;background:var(--color-bg-elevated);border-radius:8px;text-align:center">
                                    <span style="font-size:11px;color:rgba(255,255,255,0.5)">No recent AQI alerts</span>
                                </div>
                            `}
                            
                            <!-- Push Notifications -->
                            ${typeof AlertModule !== 'undefined' && 'Notification' in window ? `
                                <div style="margin-top:12px;padding:10px;background:var(--color-bg-elevated);border-radius:8px">
                                    <div style="display:flex;justify-content:space-between;align-items:center">
                                        <span style="font-size:11px;color:rgba(255,255,255,0.6)">Push Notifications</span>
                                        ${AlertModule.isNotificationsEnabled() ? `
                                            <span style="font-size:10px;color:#22c55e">‚úì Enabled</span>
                                        ` : `
                                            <button class="btn btn--secondary" id="enable-aqi-notifications" style="padding:4px 10px;font-size:10px">
                                                Enable
                                            </button>
                                        `}
                                    </div>
                                </div>
                            ` : ''}
                        `;
                    })() : `
                        <div style="padding:16px;background:var(--color-bg-elevated);border-radius:8px;text-align:center">
                            <div style="font-size:24px;margin-bottom:8px">üîë</div>
                            <div style="font-size:12px;color:rgba(255,255,255,0.6);margin-bottom:12px">
                                API key required for AQI monitoring
                            </div>
                            <button class="btn btn--primary" onclick="State.set('activePanel','settings');PanelsModule.render();" style="padding:8px 16px;font-size:12px">
                                Configure in Settings
                            </button>
                        </div>
                    `}
                </div>
            ` : ''}
            
            <div class="divider"></div>
            
            <!-- USGS Stream Gauges -->
            <div class="section-label">üíß USGS Stream Gauges</div>
            <div id="stream-gauge-section" style="margin-bottom:16px">
                ${typeof StreamGaugeModule !== 'undefined' ? StreamGaugeModule.renderPanel() : `
                    <div style="padding:16px;background:var(--color-bg-elevated);border-radius:8px;text-align:center">
                        <span style="color:rgba(255,255,255,0.5)">Stream gauge module not available</span>
                    </div>
                `}
            </div>
            
            <div style="margin-top:20px;padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;text-align:center">
                <div style="font-size:11px;color:rgba(255,255,255,0.4)">
                    Weather data from Open-Meteo ‚Ä¢ Stream data from USGS NWIS
                </div>
            </div>
        `;

        // Event handlers
        
        // Refresh weather
        container.querySelector('#weather-refresh').onclick = async () => {
            await loadCurrentWeather();
        };
        
        // Refresh AQI only
        const aqiRefreshBtn = container.querySelector('#aqi-refresh');
        if (aqiRefreshBtn) {
            aqiRefreshBtn.onclick = async (e) => {
                e.stopPropagation();
                await loadAQIData();
            };
        }
        
        // Analyze route weather
        const analyzeBtn = container.querySelector('#analyze-route-weather');
        if (analyzeBtn) {
            analyzeBtn.onclick = async () => {
                if (!selectedRoute) return;
                
                analyzeBtn.disabled = true;
                analyzeBtn.innerHTML = '‚è≥ Analyzing...';
                
                try {
                    routeWeatherData = await WeatherModule.analyzeRouteWeather(selectedRoute, waypoints, {
                        travelDate: new Date(),
                        estimatedHours: parseFloat(selectedRoute.duration) || 8
                    });
                    
                    // Fetch AQI data for each route point if AirQualityModule is available
                    if (typeof AirQualityModule !== 'undefined' && routeWeatherData?.points) {
                        analyzeBtn.innerHTML = '‚è≥ Checking air quality...';
                        
                        const aqiPromises = routeWeatherData.points.map(async (point) => {
                            try {
                                const aqi = await AirQualityModule.fetchAQI(point.lat, point.lon);
                                point.aqi = aqi;
                                
                                // Add AQI alerts for unhealthy conditions
                                if (aqi?.available && aqi.aqi > 100) {
                                    const aqiAlert = {
                                        type: 'air_quality',
                                        severity: aqi.aqi > 200 ? 'critical' : aqi.aqi > 150 ? 'warning' : 'caution',
                                        location: point.name,
                                        icon: aqi.category.icon,
                                        message: `${aqi.category.label} Air Quality (AQI ${aqi.aqi})`,
                                        recommendation: aqi.category.guidance
                                    };
                                    routeWeatherData.alerts.push(aqiAlert);
                                }
                            } catch (aqiErr) {
                                console.debug('Could not fetch AQI for route point:', point.name, aqiErr);
                                point.aqi = null;
                            }
                        });
                        
                        await Promise.all(aqiPromises);
                        
                        // Sort alerts by severity
                        const severityOrder = { critical: 0, warning: 1, caution: 2 };
                        routeWeatherData.alerts.sort((a, b) => 
                            (severityOrder[a.severity] ?? 3) - (severityOrder[b.severity] ?? 3)
                        );
                    }
                    
                    renderWeather();
                } catch (err) {
                    console.error('Route weather analysis failed:', err);
                    ModalsModule.showToast('Failed to analyze route weather', 'error');
                    analyzeBtn.disabled = false;
                    analyzeBtn.innerHTML = 'üå¶Ô∏è Analyze Route Weather';
                }
            };
        }
        
        // Waypoint weather
        container.querySelectorAll('[data-weather-wp]').forEach(btn => {
            btn.onclick = async () => {
                const wpId = btn.dataset.weatherWp;
                const wp = waypoints.find(w => w.id === wpId);
                if (!wp) return;
                
                btn.querySelector('.card__subtitle').textContent = 'Loading...';
                const aqiBadge = btn.querySelector('.wp-aqi-badge');
                const weatherIcon = btn.querySelector('.wp-weather-icon');
                
                try {
                    const wpWeather = await WeatherModule.getWaypointWeather(wp);
                    let displayText = '';
                    
                    if (wpWeather?.current) {
                        displayText = `${Math.round(wpWeather.current.temperature)}¬∞F ‚Ä¢ ${wpWeather.current.weather.desc}`;
                        if (weatherIcon) weatherIcon.textContent = wpWeather.current.weather.icon;
                    }
                    
                    // Also fetch AQI if available
                    if (typeof AirQualityModule !== 'undefined' && wp.lat && wp.lon) {
                        try {
                            const wpAqi = await AirQualityModule.fetchAQI(wp.lat, wp.lon);
                            if (wpAqi?.available && aqiBadge) {
                                const cat = wpAqi.category;
                                aqiBadge.style.display = 'block';
                                aqiBadge.style.background = cat.color + '22';
                                aqiBadge.querySelector('.wp-aqi-value').textContent = wpAqi.aqi;
                                aqiBadge.querySelector('.wp-aqi-value').style.color = cat.color;
                                
                                // Update weather icon to show AQI warning if unhealthy
                                if (wpAqi.aqi > 100 && weatherIcon) {
                                    weatherIcon.textContent = cat.icon;
                                }
                            }
                        } catch (aqiErr) {
                            console.debug('Could not fetch AQI for waypoint:', aqiErr);
                        }
                    }
                    
                    btn.querySelector('.card__subtitle').textContent = displayText || 'Weather loaded';
                } catch (err) {
                    btn.querySelector('.card__subtitle').textContent = 'Failed to load';
                }
            };
        });
        
        // Satellite/Radar layer buttons
        container.querySelectorAll('[data-sat-layer]').forEach(btn => {
            btn.onclick = async () => {
                const layerKey = btn.dataset.satLayer;
                if (typeof SatWeatherModule !== 'undefined') {
                    // Toggle layer
                    if (activeSatLayer === layerKey) {
                        // Clear layer
                        SatWeatherModule.removeSatelliteLayer(layerKey);
                        activeSatLayer = null;
                    } else {
                        // Remove previous layer
                        if (activeSatLayer) {
                            SatWeatherModule.removeSatelliteLayer(activeSatLayer);
                        }
                        // Add new layer (async for RainViewer products)
                        const success = await SatWeatherModule.addSatelliteLayer(layerKey, satLayerOpacity);
                        if (success) {
                            activeSatLayer = layerKey;
                        } else {
                            // Show error toast
                            if (typeof ModalsModule !== 'undefined') {
                                const product = SatWeatherModule.getProduct(layerKey);
                                if (product?.source === 'owm') {
                                    ModalsModule.showToast('OpenWeatherMap API key required. Configure in Settings.', 'error');
                                } else {
                                    ModalsModule.showToast('Failed to load weather layer', 'error');
                                }
                            }
                        }
                    }
                    renderWeather();
                }
            };
        });
        
        // Clear satellite layer button
        const clearSatBtn = container.querySelector('#clear-sat-layer');
        if (clearSatBtn) {
            clearSatBtn.onclick = () => {
                if (activeSatLayer && typeof SatWeatherModule !== 'undefined') {
                    SatWeatherModule.removeSatelliteLayer(activeSatLayer);
                    activeSatLayer = null;
                    renderWeather();
                }
            };
        }
        
        // Satellite layer opacity slider
        const opacitySlider = container.querySelector('#sat-opacity');
        if (opacitySlider) {
            opacitySlider.oninput = (e) => {
                satLayerOpacity = parseInt(e.target.value, 10) / 100;
                if (activeSatLayer && typeof SatWeatherModule !== 'undefined') {
                    SatWeatherModule.setLayerOpacity(activeSatLayer, satLayerOpacity);
                }
                // Update display
                const display = opacitySlider.nextElementSibling;
                if (display) {
                    display.textContent = `${Math.round(satLayerOpacity * 100)}%`;
                }
            };
        }
        
        // AQI Map Layer toggle
        const aqiLayerBtn = container.querySelector('#toggle-aqi-layer');
        if (aqiLayerBtn) {
            aqiLayerBtn.onclick = async () => {
                if (typeof AirQualityModule === 'undefined') return;
                
                // Check for API key
                if (!AirQualityModule.getApiKey()) {
                    if (typeof ModalsModule !== 'undefined') {
                        ModalsModule.showToast('AirNow API key required. Configure in Settings.', 'error');
                    }
                    return;
                }
                
                aqiLayerBtn.disabled = true;
                aqiLayerBtn.innerHTML = '<span style="font-size:20px">‚è≥</span><span>Loading...</span>';
                
                try {
                    if (aqiLayerActive) {
                        AirQualityModule.removeMapLayer();
                        aqiLayerActive = false;
                    } else {
                        const success = await AirQualityModule.addMapLayer();
                        if (success) {
                            aqiLayerActive = true;
                        } else {
                            if (typeof ModalsModule !== 'undefined') {
                                ModalsModule.showToast('Failed to load AQI stations', 'error');
                            }
                        }
                    }
                    renderWeather();
                } catch (err) {
                    console.error('AQI layer toggle failed:', err);
                    if (typeof ModalsModule !== 'undefined') {
                        ModalsModule.showToast('Error loading AQI layer', 'error');
                    }
                    aqiLayerBtn.disabled = false;
                    aqiLayerBtn.innerHTML = '<span style="font-size:20px">üí®</span><span>Show AQI Stations</span>';
                }
            };
        }
        
        // Weather Monitoring toggle
        const wxMonitoringBtn = container.querySelector('#toggle-weather-monitoring');
        if (wxMonitoringBtn) {
            wxMonitoringBtn.onclick = () => {
                if (typeof WeatherModule === 'undefined') return;
                
                if (WeatherModule.isWeatherMonitoringEnabled()) {
                    WeatherModule.stopWeatherMonitoring();
                    if (typeof ModalsModule !== 'undefined') {
                        ModalsModule.showToast('Weather monitoring stopped', 'info');
                    }
                } else {
                    WeatherModule.startWeatherMonitoring();
                    if (typeof ModalsModule !== 'undefined') {
                        ModalsModule.showToast('Weather monitoring started', 'success');
                    }
                }
                renderWeather();
            };
        }
        
        // Weather Check Now button
        const wxCheckNowBtn = container.querySelector('#weather-check-now');
        if (wxCheckNowBtn) {
            wxCheckNowBtn.onclick = async () => {
                if (typeof WeatherModule === 'undefined') return;
                wxCheckNowBtn.disabled = true;
                wxCheckNowBtn.textContent = '‚è≥';
                await WeatherModule.checkWeatherNow();
                wxCheckNowBtn.disabled = false;
                wxCheckNowBtn.textContent = 'üîÑ';
                renderWeather();
            };
        }
        
        // Weather Interval buttons
        container.querySelectorAll('.weather-interval-btn').forEach(btn => {
            btn.onclick = () => {
                if (typeof WeatherModule === 'undefined') return;
                const minutes = parseInt(btn.dataset.interval);
                if (!minutes) return;
                
                WeatherModule.setWeatherMonitoringInterval(minutes * 60 * 1000);
                if (typeof ModalsModule !== 'undefined') {
                    ModalsModule.showToast(`Weather check interval: ${minutes} min`, 'info');
                }
                renderWeather();
            };
        });
        
        // Clear Weather Alert History
        const clearWxHistoryBtn = container.querySelector('#clear-weather-history');
        if (clearWxHistoryBtn) {
            clearWxHistoryBtn.onclick = () => {
                if (typeof AlertModule !== 'undefined') {
                    AlertModule.clearHistory('weather');
                    if (typeof ModalsModule !== 'undefined') {
                        ModalsModule.showToast('Weather alert history cleared', 'info');
                    }
                    renderWeather();
                }
            };
        }
        
        // Save Weather Alert Thresholds
        const saveWxThresholdsBtn = container.querySelector('#save-wx-thresholds');
        if (saveWxThresholdsBtn) {
            saveWxThresholdsBtn.onclick = () => {
                if (typeof WeatherModule === 'undefined') return;
                
                const thresholds = {
                    temperature: {
                        extremeHeat: parseFloat(container.querySelector('#wx-th-extreme-heat')?.value) || 100,
                        heat: parseFloat(container.querySelector('#wx-th-heat')?.value) || 90,
                        cold: parseFloat(container.querySelector('#wx-th-cold')?.value) || 32,
                        extremeCold: parseFloat(container.querySelector('#wx-th-extreme-cold')?.value) || 10
                    },
                    wind: {
                        extreme: parseFloat(container.querySelector('#wx-th-wind-extreme')?.value) || 50,
                        high: parseFloat(container.querySelector('#wx-th-wind-high')?.value) || 30
                    },
                    visibility: {
                        poor: parseFloat(container.querySelector('#wx-th-visibility')?.value) || 1
                    }
                };
                
                WeatherModule.setAlertThresholds(thresholds);
                if (typeof ModalsModule !== 'undefined') {
                    ModalsModule.showToast('Weather alert thresholds saved', 'success');
                }
            };
        }
        
        // Waypoint Monitoring checkbox
        const wxWaypointChk = container.querySelector('#wx-waypoint-monitoring');
        if (wxWaypointChk) {
            wxWaypointChk.onchange = () => {
                if (typeof WeatherModule !== 'undefined') {
                    WeatherModule.setWaypointMonitoring(wxWaypointChk.checked);
                    if (typeof ModalsModule !== 'undefined') {
                        ModalsModule.showToast(
                            wxWaypointChk.checked ? 'Waypoint monitoring enabled' : 'Waypoint monitoring disabled',
                            'info'
                        );
                    }
                    renderWeather();
                }
            };
        }
        
        // AQI Monitoring toggle
        const aqiMonitoringBtn = container.querySelector('#toggle-aqi-monitoring');
        if (aqiMonitoringBtn) {
            aqiMonitoringBtn.onclick = () => {
                if (typeof AirQualityModule === 'undefined') return;
                
                if (AirQualityModule.isMonitoringEnabled()) {
                    AirQualityModule.stopMonitoring();
                    if (typeof ModalsModule !== 'undefined') {
                        ModalsModule.showToast('AQI monitoring stopped', 'info');
                    }
                } else {
                    AirQualityModule.startMonitoring();
                    if (typeof ModalsModule !== 'undefined') {
                        ModalsModule.showToast('AQI monitoring started', 'success');
                    }
                }
                renderWeather();
            };
        }
        
        // AQI Check Now button
        const aqiCheckNowBtn = container.querySelector('#aqi-check-now');
        if (aqiCheckNowBtn) {
            aqiCheckNowBtn.onclick = async () => {
                if (typeof AirQualityModule !== 'undefined') {
                    aqiCheckNowBtn.disabled = true;
                    aqiCheckNowBtn.textContent = '‚è≥';
                    await AirQualityModule.checkNow();
                    aqiCheckNowBtn.disabled = false;
                    aqiCheckNowBtn.textContent = 'üîÑ';
                    renderWeather();
                }
            };
        }
        
        // AQI Thresholds save
        const saveThresholdsBtn = container.querySelector('#save-aqi-thresholds');
        if (saveThresholdsBtn) {
            saveThresholdsBtn.onclick = () => {
                if (typeof AirQualityModule === 'undefined') return;
                
                const caution = parseInt(container.querySelector('#aqi-threshold-caution')?.value) || 101;
                const warning = parseInt(container.querySelector('#aqi-threshold-warning')?.value) || 151;
                const critical = parseInt(container.querySelector('#aqi-threshold-critical')?.value) || 201;
                const emergency = parseInt(container.querySelector('#aqi-threshold-emergency')?.value) || 301;
                
                AirQualityModule.setThresholds({ caution, warning, critical, emergency });
                
                if (typeof ModalsModule !== 'undefined') {
                    ModalsModule.showToast('AQI thresholds saved', 'success');
                }
            };
        }
        
        // Sensitive Groups checkbox
        const sensitiveGroupsChk = container.querySelector('#aqi-sensitive-groups');
        if (sensitiveGroupsChk) {
            sensitiveGroupsChk.onchange = () => {
                if (typeof AirQualityModule !== 'undefined') {
                    AirQualityModule.setSensitiveGroups(sensitiveGroupsChk.checked);
                }
            };
        }
        
        // Forecast Alerts checkbox
        const forecastAlertsChk = container.querySelector('#aqi-forecast-alerts');
        if (forecastAlertsChk) {
            forecastAlertsChk.onchange = () => {
                if (typeof AirQualityModule !== 'undefined') {
                    const settings = AirQualityModule.getMonitoringSettings();
                    settings.forecastAlerts = forecastAlertsChk.checked;
                    if (typeof Storage !== 'undefined' && Storage.Settings) {
                        Storage.Settings.set('aqiMonitoringSettings', settings);
                    }
                }
            };
        }
        
        // Clear AQI History
        const clearHistoryBtn = container.querySelector('#clear-aqi-history');
        if (clearHistoryBtn) {
            clearHistoryBtn.onclick = () => {
                if (typeof AlertModule !== 'undefined') {
                    AlertModule.clearHistory('aqi');
                    if (typeof ModalsModule !== 'undefined') {
                        ModalsModule.showToast('AQI alert history cleared', 'info');
                    }
                    renderWeather();
                }
            };
        }
        
        // Enable Push Notifications
        const enableNotificationsBtn = container.querySelector('#enable-aqi-notifications');
        if (enableNotificationsBtn) {
            enableNotificationsBtn.onclick = async () => {
                if (typeof AlertModule !== 'undefined') {
                    const granted = await AlertModule.requestNotificationPermission();
                    if (granted) {
                        if (typeof ModalsModule !== 'undefined') {
                            ModalsModule.showToast('Push notifications enabled', 'success');
                        }
                    } else {
                        if (typeof ModalsModule !== 'undefined') {
                            ModalsModule.showToast('Notification permission denied', 'error');
                        }
                    }
                    renderWeather();
                }
            };
        }
        
        // Stream Gauge handlers
        const streamGaugeSection = container.querySelector('#stream-gauge-section');
        if (streamGaugeSection && typeof StreamGaugeModule !== 'undefined') {
            StreamGaugeModule.attachHandlers(streamGaugeSection);
            
            // Subscribe to updates to re-render section
            StreamGaugeModule.subscribe((event, data) => {
                if (event === 'update' || event === 'select' || event === 'stations' || event === 'error') {
                    streamGaugeSection.innerHTML = StreamGaugeModule.renderPanel();
                    StreamGaugeModule.attachHandlers(streamGaugeSection);
                }
            });
        }
    }

    async function loadCurrentWeather() {
        weatherLoading = true;
        weatherError = null;
        renderWeather();
        
        try {
            weatherData = await WeatherModule.getMapCenterWeather();
            weatherLoading = false;
            renderWeather();
            
            // Also load AQI data (non-blocking)
            loadAQIData();
        } catch (err) {
            weatherLoading = false;
            weatherError = err.message || 'Failed to load weather';
            renderWeather();
        }
    }
    
    async function loadAQIData() {
        if (typeof AirQualityModule === 'undefined') {
            console.debug('AirQualityModule not available');
            return;
        }
        
        aqiLoading = true;
        aqiError = null;
        renderWeather();
        
        try {
            aqiData = await AirQualityModule.getMapCenterAQI();
            aqiLoading = false;
            renderWeather();
        } catch (err) {
            aqiLoading = false;
            aqiError = err.message || 'Failed to load AQI';
            aqiData = {
                available: false,
                reason: 'fetch_error',
                message: aqiError
            };
            renderWeather();
        }
    }

    async function renderSettings() {
        _saveScroll(); _restoreScroll();
        // Load current settings
        const units = await Storage.Settings.get('units', 'imperial');
        const coordFormat = await Storage.Settings.get('coordinateFormat', 'dd');
        const defaultZoom = await Storage.Settings.get('defaultZoom', 12);
        const homeLocation = await Storage.Settings.get('homeLocation', null);
        
        // Set the format in Coordinates module
        if (typeof Coordinates !== 'undefined') {
            Coordinates.setFormat(coordFormat);
        }
        
        // Sample coordinates for preview
        const sampleLat = 37.4215;
        const sampleLon = -119.1892;
        
        // Calculate storage usage
        const waypoints = State.get('waypoints');
        const routes = State.get('routes');
        const waypointCount = waypoints.length;
        const routeCount = routes.filter(r => !r.isBuilding).length;
        
        // Estimate storage size
        let storageEstimate = 'Calculating...';
        try {
            if (navigator.storage && navigator.storage.estimate) {
                const estimate = await navigator.storage.estimate();
                const usedMB = (estimate.usage / (1024 * 1024)).toFixed(2);
                const quotaMB = (estimate.quota / (1024 * 1024)).toFixed(0);
                storageEstimate = `${usedMB} MB / ${quotaMB} MB`;
            }
        } catch (e) {
            storageEstimate = 'Unknown';
        }
        
        container.innerHTML = `
            <div class="panel__header">
                <h2 class="panel__title">Settings</h2>
            </div>
            
            <!-- Units & Format -->
            <div class="section-label">Units & Format</div>
            
            <div class="settings-group">
                <div class="settings-row">
                    <span class="settings-row__label">Distance Units</span>
                    <div class="settings-row__control">
                        <select id="setting-units" class="settings-select" aria-label="Distance units">
                            <option value="imperial" ${units === 'imperial' ? 'selected' : ''}>Miles / Feet</option>
                            <option value="metric" ${units === 'metric' ? 'selected' : ''}>Kilometers / Meters</option>
                        </select>
                    </div>
                </div>
                
                <div class="settings-row" style="flex-direction:column;align-items:stretch">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                        <span class="settings-row__label">Coordinate Format</span>
                        <select id="setting-coord-format" class="settings-select" style="width:auto" aria-label="Coordinate format">
                            <option value="dd" ${coordFormat === 'dd' ? 'selected' : ''}>Decimal (DD)</option>
                            <option value="dms" ${coordFormat === 'dms' ? 'selected' : ''}>Deg Min Sec (DMS)</option>
                            <option value="ddm" ${coordFormat === 'ddm' ? 'selected' : ''}>Deg Dec Min (DDM)</option>
                            <option value="utm" ${coordFormat === 'utm' ? 'selected' : ''}>UTM</option>
                            <option value="mgrs" ${coordFormat === 'mgrs' ? 'selected' : ''}>MGRS (Military)</option>
                        </select>
                    </div>
                    <div id="coord-format-preview" style="padding:10px;background:rgba(0,0,0,0.2);border-radius:8px;font-family:'IBM Plex Mono',monospace;font-size:12px;color:#f97316;text-align:center">
                        ${typeof Coordinates !== 'undefined' ? Coordinates.format(sampleLat, sampleLon, { format: coordFormat }) : '37.4215¬∞ N, 119.1892¬∞ W'}
                    </div>
                </div>
            </div>
            
            <div class="divider"></div>
            
            <!-- Night Mode Settings -->
            <div class="section-label">Display Mode</div>
            
            <div class="settings-group" id="night-mode-settings">
                ${typeof NightModeModule !== 'undefined' ? NightModeModule.renderSettingsPanel() : `
                    <div style="padding:12px;text-align:center;color:var(--color-text-muted)">
                        Night mode not available
                    </div>
                `}
            </div>
            
            <div class="divider"></div>
            
            <!-- Coordinate Converter Tool -->
            <div class="section-label">Coordinate Converter</div>
            
            <div class="settings-group">
                <div style="margin-bottom:12px">
                    <input type="text" id="coord-input" placeholder="Enter coordinates in any format..." 
                        style="font-family:'IBM Plex Mono',monospace;font-size:13px">
                    <div style="font-size:10px;color:rgba(255,255,255,0.4);margin-top:4px">
                        Accepts: DD, DMS, DDM, UTM, MGRS formats
                    </div>
                </div>
                <button class="btn btn--secondary btn--full" id="convert-coords-btn">
                    Convert Coordinates
                </button>
                <div id="coord-convert-results" style="display:none;margin-top:12px;padding:12px;background:rgba(0,0,0,0.2);border-radius:8px">
                    <!-- Results will be inserted here -->
                </div>
            </div>
            
            <div class="divider"></div>
            
            <!-- Magnetic Declination -->
            <div class="section-label">Magnetic Declination</div>
            
            <div class="settings-group">
                ${typeof DeclinationModule !== 'undefined' ? (() => {
                    const current = DeclinationModule.getCurrent();
                    const modelInfo = DeclinationModule.getModelInfo();
                    const statusColor = {
                        valid: '#22c55e',
                        degraded: '#f59e0b',
                        expired: '#ef4444',
                        invalid: '#ef4444'
                    }[modelInfo.status] || '#6b7280';
                    
                    return `
                        <!-- Current Values -->
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
                            <div style="padding:14px;background:rgba(34,197,94,0.1);border-radius:10px;text-align:center">
                                <div style="font-size:22px;font-weight:600;color:#22c55e">${DeclinationModule.formatDeclination(current.declination)}</div>
                                <div style="font-size:10px;color:rgba(255,255,255,0.5);margin-top:2px">DECLINATION</div>
                            </div>
                            <div style="padding:14px;background:rgba(59,130,246,0.1);border-radius:10px;text-align:center">
                                <div style="font-size:22px;font-weight:600;color:#3b82f6">${DeclinationModule.formatInclination(current.inclination)}</div>
                                <div style="font-size:10px;color:rgba(255,255,255,0.5);margin-top:2px">INCLINATION</div>
                            </div>
                        </div>
                        
                        <!-- Explanation -->
                        <div style="padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;margin-bottom:12px;font-size:12px;color:rgba(255,255,255,0.7)">
                            ${current.declination !== null ? (current.declination >= 0 
                                ? `Magnetic north is <strong style="color:#f97316">${Math.abs(current.declination).toFixed(1)}¬∞ EAST</strong> of true north` 
                                : `Magnetic north is <strong style="color:#f97316">${Math.abs(current.declination).toFixed(1)}¬∞ WEST</strong> of true north`)
                            : 'Move map to calculate declination'}
                        </div>
                        
                        <!-- Bearing Converter -->
                        <div style="font-size:11px;color:rgba(255,255,255,0.5);margin-bottom:8px">Bearing Converter</div>
                        <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
                            <div style="flex:1">
                                <input type="number" id="settings-true-bearing" min="0" max="360" step="1" placeholder="True ¬∞" 
                                    style="padding:10px;font-family:'IBM Plex Mono',monospace;text-align:center;font-size:14px">
                            </div>
                            <div style="display:flex;flex-direction:column;gap:4px">
                                <button class="btn btn--secondary" id="settings-to-mag" style="padding:4px 8px;font-size:10px">‚Üí</button>
                                <button class="btn btn--secondary" id="settings-to-true" style="padding:4px 8px;font-size:10px">‚Üê</button>
                            </div>
                            <div style="flex:1">
                                <input type="number" id="settings-mag-bearing" min="0" max="360" step="1" placeholder="Mag ¬∞" 
                                    style="padding:10px;font-family:'IBM Plex Mono',monospace;text-align:center;font-size:14px">
                            </div>
                        </div>
                        
                        <!-- Quick Reference Card -->
                        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:12px">
                            ${[0, 90, 180, 270].map(trueBrg => {
                                const magBrg = current.declination !== null 
                                    ? DeclinationModule.trueToMagnetic(trueBrg, current.declination) 
                                    : trueBrg;
                                const compass = ['N', 'E', 'S', 'W'][trueBrg / 90];
                                return `
                                    <div style="padding:8px;background:rgba(255,255,255,0.03);border-radius:6px;text-align:center">
                                        <div style="font-size:12px;font-weight:600">${compass}</div>
                                        <div style="font-size:9px;color:rgba(255,255,255,0.4);margin-top:2px">T: ${trueBrg}¬∞</div>
                                        <div style="font-size:9px;color:#22c55e">M: ${Math.round(magBrg)}¬∞</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <!-- Model Info -->
                        <div style="padding:10px;background:rgba(255,255,255,0.02);border-radius:8px;font-size:10px;color:rgba(255,255,255,0.5)">
                            <div style="display:flex;justify-content:space-between">
                                <span>Model: ${modelInfo.model}</span>
                                <span style="color:${statusColor}">${modelInfo.status.toUpperCase()}</span>
                            </div>
                            ${modelInfo.warning ? `<div style="margin-top:6px;color:#f59e0b">‚ö†Ô∏è ${modelInfo.warning}</div>` : ''}
                        </div>
                    `;
                })() : `
                    <div style="padding:16px;text-align:center;color:rgba(255,255,255,0.4)">
                        Declination module not available
                    </div>
                `}
            </div>
            
            <div class="divider"></div>
            
            <!-- Map Preferences -->
            <div class="section-label">Map Preferences</div>
            
            <div class="settings-group">
                <div class="settings-row">
                    <span class="settings-row__label">Default Zoom</span>
                    <div class="settings-row__control">
                        <select id="setting-default-zoom" class="settings-select" aria-label="Default zoom level">
                            ${[8,9,10,11,12,13,14,15,16].map(z => 
                                `<option value="${z}" ${defaultZoom === z ? 'selected' : ''}>${z} ${z <= 10 ? '(Region)' : z <= 13 ? '(Area)' : '(Detail)'}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
                
                <div class="settings-row">
                    <div style="flex:1">
                        <span class="settings-row__label">Home Location</span>
                        <div style="font-size:11px;color:rgba(255,255,255,0.4);margin-top:2px">
                            ${homeLocation 
                                ? (typeof Coordinates !== 'undefined' 
                                    ? Coordinates.formatShort(homeLocation.lat, homeLocation.lon)
                                    : `${homeLocation.lat.toFixed(4)}¬∞, ${homeLocation.lon.toFixed(4)}¬∞`)
                                : 'Not set'}
                        </div>
                    </div>
                    <button class="btn btn--secondary" id="set-home-btn" style="padding:8px 12px;font-size:12px">
                        ${homeLocation ? 'Update' : 'Set Current'}
                    </button>
                </div>
                
                ${homeLocation ? `
                    <button class="btn btn--secondary btn--full" id="go-home-btn" style="margin-top:8px">
                        üè† Go to Home Location
                    </button>
                ` : ''}
            </div>
            
            <div class="divider"></div>
            
            <!-- API Keys -->
            <div class="section-label">API Keys</div>
            
            <div class="settings-group">
                <p style="font-size:11px;color:rgba(255,255,255,0.5);margin-bottom:12px">
                    Optional API keys for enhanced features. All services offer free tiers.
                </p>
                
                <!-- AirNow API Key -->
                <div class="settings-row" style="flex-direction:column;align-items:stretch">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                        <div>
                            <span class="settings-row__label">AirNow (Air Quality)</span>
                            <div style="font-size:10px;color:rgba(255,255,255,0.4)">EPA air quality data for US/Canada/Mexico</div>
                        </div>
                        <span style="font-size:10px;padding:2px 6px;border-radius:4px;${typeof AirQualityModule !== 'undefined' && AirQualityModule.getApiKey() ? 'background:rgba(34,197,94,0.2);color:#22c55e' : 'background:rgba(107,114,128,0.2);color:#9ca3af'}">
                            ${typeof AirQualityModule !== 'undefined' && AirQualityModule.getApiKey() ? '‚úì Configured' : 'Not Set'}
                        </span>
                    </div>
                    <div style="display:flex;gap:8px">
                        <input type="password" id="airnow-api-key" 
                               placeholder="Enter AirNow API key..." 
                               value="${typeof AirQualityModule !== 'undefined' && AirQualityModule.getApiKey() ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : ''}"
                               style="flex:1;font-size:12px">
                        <button class="btn btn--secondary" id="save-airnow-key" style="padding:8px 12px;font-size:11px">
                            Save
                        </button>
                    </div>
                    <div style="font-size:10px;color:rgba(255,255,255,0.4);margin-top:6px">
                        <a href="https://docs.airnowapi.org/account/request/" target="_blank" rel="noopener" style="color:#f97316">
                            Get free API key ‚Üí
                        </a>
                        (instant approval)
                    </div>
                </div>
            </div>
            
            <div class="divider"></div>
            
            <!-- Print / Export -->
            <div class="section-label">Print / Export PDF</div>
            
            <div class="settings-group">
                <p style="font-size:11px;color:rgba(255,255,255,0.5);margin-bottom:12px">
                    Generate printable documents for paper backup. Use browser's "Save as PDF" to create PDF files.
                </p>
                
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                    <button class="btn btn--secondary" id="print-full-plan-btn">
                        üìã Full Plan
                    </button>
                    <button class="btn btn--secondary" id="print-route-card-btn" ${routeCount === 0 ? 'disabled' : ''}>
                        üó∫Ô∏è Route Card
                    </button>
                    <button class="btn btn--secondary" id="print-waypoints-btn" ${waypointCount === 0 ? 'disabled' : ''}>
                        üìç Waypoints
                    </button>
                    <button class="btn btn--secondary" id="print-comm-btn">
                        üìª Comm Plan
                    </button>
                    <button class="btn btn--secondary" id="print-quick-ref-btn">
                        üìá Quick Ref
                    </button>
                    <button class="btn btn--primary" id="print-modal-btn">
                        üñ®Ô∏è More Options...
                    </button>
                </div>
            </div>
            
            <div class="divider"></div>
            
            <!-- Data Management -->
            <div class="section-label">Data Management</div>
            
            <div class="settings-group">
                <div style="display:flex;gap:8px;margin-bottom:12px">
                    <div style="flex:1;padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;text-align:center">
                        <div style="font-size:20px;font-weight:600;color:#f97316">${waypointCount}</div>
                        <div style="font-size:10px;color:rgba(255,255,255,0.4)">WAYPOINTS</div>
                    </div>
                    <div style="flex:1;padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;text-align:center">
                        <div style="font-size:20px;font-weight:600;color:#3b82f6">${routeCount}</div>
                        <div style="font-size:10px;color:rgba(255,255,255,0.4)">ROUTES</div>
                    </div>
                </div>
                
                <div style="display:flex;gap:8px">
                    <button class="btn btn--secondary" id="export-json-btn" style="flex:1">
                        ${Icons.get('export')} Export JSON
                    </button>
                    <label class="btn btn--secondary" style="flex:1;cursor:pointer">
                        ${Icons.get('download')} Import JSON
                        <input type="file" id="import-json-input" accept=".json" style="display:none">
                    </label>
                </div>
            </div>
            
            <div class="divider"></div>
            
            <!-- Danger Zone -->
            <div class="section-label" style="color:#ef4444">Danger Zone</div>
            
            <div class="settings-group" style="border-color:rgba(239,68,68,0.2)">
                <button class="btn btn--secondary btn--full" id="clear-waypoints-btn" style="margin-bottom:8px;color:#ef4444">
                    Clear All Waypoints (${waypointCount})
                </button>
                <button class="btn btn--secondary btn--full" id="clear-routes-btn" style="margin-bottom:8px;color:#ef4444">
                    Clear All Routes (${routeCount})
                </button>
                <button class="btn btn--full" id="clear-all-btn" style="background:rgba(239,68,68,0.15);color:#ef4444;border:1px solid rgba(239,68,68,0.3)">
                    üóëÔ∏è Clear All Data
                </button>
            </div>
            
            <div class="divider"></div>
            
            <!-- Help & Guidance -->
            <div class="section-label">Help</div>
            
            <div class="settings-group">
                <button class="btn btn--secondary btn--full" id="restart-tour-btn" style="margin-bottom:8px">
                    üéì Restart Feature Tour
                </button>
                <div style="padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;margin-bottom:8px">
                    <div style="font-size:12px;font-weight:500;margin-bottom:8px">Keyboard Shortcuts</div>
                    <div style="display:grid;grid-template-columns:auto 1fr;gap:6px 12px;font-size:11px">
                        <kbd style="padding:2px 6px;background:rgba(255,255,255,0.1);border-radius:4px;font-family:monospace">Ctrl+K</kbd>
                        <span style="color:rgba(255,255,255,0.6)">Global Search</span>
                        <kbd style="padding:2px 6px;background:rgba(255,255,255,0.1);border-radius:4px;font-family:monospace">Ctrl+Z</kbd>
                        <span style="color:rgba(255,255,255,0.6)">Undo</span>
                        <kbd style="padding:2px 6px;background:rgba(255,255,255,0.1);border-radius:4px;font-family:monospace">Ctrl+Shift+Z</kbd>
                        <span style="color:rgba(255,255,255,0.6)">Redo</span>
                        <kbd style="padding:2px 6px;background:rgba(255,255,255,0.1);border-radius:4px;font-family:monospace">Esc</kbd>
                        <span style="color:rgba(255,255,255,0.6)">Close Dialog/Cancel</span>
                    </div>
                </div>
            </div>
            
            <div class="divider"></div>
            
            <!-- App Info -->
            <div class="section-label">About</div>
            
            <div class="settings-group">
                <div class="settings-row">
                    <span class="settings-row__label">Version</span>
                    <span id="app-version" style="font-size:13px;color:rgba(255,255,255,0.6)">Loading...</span>
                </div>
                <div class="settings-row">
                    <span class="settings-row__label">Storage Used</span>
                    <span style="font-size:13px;color:rgba(255,255,255,0.6)">${storageEstimate}</span>
                </div>
                <button class="btn btn--secondary btn--full" id="clear-cache-btn" style="margin-top:8px">
                    Clear Tile Cache
                </button>
            </div>
            
            <div style="margin-top:24px;padding:16px;background:rgba(249,115,22,0.1);border:1px solid rgba(249,115,22,0.2);border-radius:12px;text-align:center">
                <div style="font-size:24px;margin-bottom:8px">üß≠</div>
                <div style="font-size:14px;font-weight:600;color:#f97316">GridDown</div>
                <div style="font-size:11px;color:rgba(255,255,255,0.5);margin-top:4px">Offline Tactical Navigation</div>
                <div style="font-size:10px;color:rgba(255,255,255,0.3);margin-top:8px">
                    <a href="https://github.com/BlackDotTechnology/GridDown" target="_blank" rel="noopener" style="color:rgba(255,255,255,0.4);text-decoration:none">MIT License</a> ‚Ä¢ BlackDot Technology ‚Ä¢ 2025
                </div>
            </div>
            
            <div class="divider" style="margin-top:16px"></div>
            
            <!-- Diagnostics -->
            <div class="section-label">Diagnostics</div>
            
            <div class="settings-group">
                <div class="settings-row">
                    <span class="settings-row__label">Log Level</span>
                    <select id="diag-log-level" aria-label="Console log level" style="background:rgba(255,255,255,0.08);color:#fff;border:1px solid rgba(255,255,255,0.15);border-radius:8px;padding:4px 8px;font-size:13px">
                        ${['error','warn','info','log','debug'].map(lvl => 
                            `<option value="${lvl}" ${typeof Log !== 'undefined' && Log.getLevel() === lvl ? 'selected' : ''}>${lvl.charAt(0).toUpperCase() + lvl.slice(1)}${lvl === 'warn' ? ' (default)' : ''}${lvl === 'debug' ? ' (verbose)' : ''}</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="settings-row">
                    <span class="settings-row__label">Logs Suppressed</span>
                    <span id="diag-suppressed" style="font-size:13px;color:rgba(255,255,255,0.6)">${typeof Log !== 'undefined' ? Log.getStats().suppressed : 'N/A'}</span>
                </div>
                <div class="settings-row">
                    <span class="settings-row__label">Errors Captured</span>
                    <span id="diag-error-count" style="font-size:13px;color:rgba(255,255,255,0.6)">${typeof ErrorBoundary !== 'undefined' ? ErrorBoundary.getErrors().length : 'N/A'}</span>
                </div>
                <button class="btn btn--secondary btn--full" id="diag-view-errors" style="margin-top:8px">
                    View Error Log
                </button>
                <button class="btn btn--secondary btn--full" id="diag-copy-errors" style="margin-top:4px">
                    Copy Error Report
                </button>
            </div>
        `;
        
        // Load version from manifest
        fetch('manifest.json')
            .then(r => r.json())
            .then(manifest => {
                const versionEl = container.querySelector('#app-version');
                if (versionEl) versionEl.textContent = manifest.version || 'Unknown';
            })
            .catch(() => {
                const versionEl = container.querySelector('#app-version');
                if (versionEl) versionEl.textContent = '6.18.4';
            });
        
        // Event Handlers
        
        // Units setting
        container.querySelector('#setting-units').onchange = async (e) => {
            await Storage.Settings.set('units', e.target.value);
            ModalsModule.showToast('Units updated', 'success');
        };
        
        // Coordinate format setting
        container.querySelector('#setting-coord-format').onchange = async (e) => {
            const newFormat = e.target.value;
            await Storage.Settings.set('coordinateFormat', newFormat);
            
            // Update Coordinates module
            if (typeof Coordinates !== 'undefined') {
                Coordinates.setFormat(newFormat);
                
                // Update preview
                const preview = container.querySelector('#coord-format-preview');
                if (preview) {
                    preview.textContent = Coordinates.format(37.4215, -119.1892, { format: newFormat });
                }
            }
            
            ModalsModule.showToast('Coordinate format updated', 'success');
        };
        
        // Night mode settings listeners
        const nightModeContainer = container.querySelector('#night-mode-settings');
        if (nightModeContainer && typeof NightModeModule !== 'undefined') {
            NightModeModule.attachSettingsListeners(nightModeContainer);
        }
        
        // Coordinate converter
        const convertBtn = container.querySelector('#convert-coords-btn');
        const coordInput = container.querySelector('#coord-input');
        const resultsDiv = container.querySelector('#coord-convert-results');
        
        if (convertBtn && coordInput && resultsDiv) {
            const doConvert = () => {
                const input = coordInput.value.trim();
                if (!input) {
                    ModalsModule.showToast('Enter coordinates to convert', 'error');
                    return;
                }
                
                if (typeof Coordinates === 'undefined') {
                    ModalsModule.showToast('Coordinates module not loaded', 'error');
                    return;
                }
                
                const parsed = Coordinates.parse(input);
                if (!parsed) {
                    resultsDiv.style.display = 'block';
                    resultsDiv.innerHTML = `
                        <div style="color:#ef4444;text-align:center">
                            ‚ùå Could not parse coordinates<br>
                            <span style="font-size:11px;color:rgba(255,255,255,0.5)">
                                Try formats like: 37.4215, -119.1892 or 37¬∞25'17"N 119¬∞11'21"W
                            </span>
                        </div>
                    `;
                    return;
                }
                
                // Show all format conversions
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = `
                    <div style="margin-bottom:8px;font-size:11px;color:rgba(255,255,255,0.5);text-align:center">
                        Parsed: ${parsed.lat.toFixed(6)}, ${parsed.lon.toFixed(6)}
                    </div>
                    <div style="display:flex;flex-direction:column;gap:6px">
                        <div class="coord-result" data-value="${Coordinates.toDD(parsed.lat, parsed.lon)}" style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:rgba(255,255,255,0.03);border-radius:6px;cursor:pointer">
                            <span style="font-size:10px;color:rgba(255,255,255,0.4);width:50px">DD</span>
                            <span style="font-family:'IBM Plex Mono',monospace;font-size:12px;flex:1">${Coordinates.toDD(parsed.lat, parsed.lon)}</span>
                            <span style="font-size:10px;color:rgba(255,255,255,0.3)">üìã</span>
                        </div>
                        <div class="coord-result" data-value="${Coordinates.toDMS(parsed.lat, parsed.lon)}" style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:rgba(255,255,255,0.03);border-radius:6px;cursor:pointer">
                            <span style="font-size:10px;color:rgba(255,255,255,0.4);width:50px">DMS</span>
                            <span style="font-family:'IBM Plex Mono',monospace;font-size:12px;flex:1">${Coordinates.toDMS(parsed.lat, parsed.lon)}</span>
                            <span style="font-size:10px;color:rgba(255,255,255,0.3)">üìã</span>
                        </div>
                        <div class="coord-result" data-value="${Coordinates.toDDM(parsed.lat, parsed.lon)}" style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:rgba(255,255,255,0.03);border-radius:6px;cursor:pointer">
                            <span style="font-size:10px;color:rgba(255,255,255,0.4);width:50px">DDM</span>
                            <span style="font-family:'IBM Plex Mono',monospace;font-size:12px;flex:1">${Coordinates.toDDM(parsed.lat, parsed.lon)}</span>
                            <span style="font-size:10px;color:rgba(255,255,255,0.3)">üìã</span>
                        </div>
                        <div class="coord-result" data-value="${Coordinates.toUTM(parsed.lat, parsed.lon)}" style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:rgba(255,255,255,0.03);border-radius:6px;cursor:pointer">
                            <span style="font-size:10px;color:rgba(255,255,255,0.4);width:50px">UTM</span>
                            <span style="font-family:'IBM Plex Mono',monospace;font-size:12px;flex:1">${Coordinates.toUTM(parsed.lat, parsed.lon)}</span>
                            <span style="font-size:10px;color:rgba(255,255,255,0.3)">üìã</span>
                        </div>
                        <div class="coord-result" data-value="${Coordinates.toMGRS(parsed.lat, parsed.lon)}" style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:rgba(255,255,255,0.03);border-radius:6px;cursor:pointer">
                            <span style="font-size:10px;color:rgba(255,255,255,0.4);width:50px">MGRS</span>
                            <span style="font-family:'IBM Plex Mono',monospace;font-size:12px;flex:1">${Coordinates.toMGRS(parsed.lat, parsed.lon)}</span>
                            <span style="font-size:10px;color:rgba(255,255,255,0.3)">üìã</span>
                        </div>
                    </div>
                    <div style="margin-top:8px;display:flex;gap:8px">
                        <button class="btn btn--secondary" id="goto-coords-btn" style="flex:1;padding:8px;font-size:12px">
                            üó∫Ô∏è Go to Location
                        </button>
                        <button class="btn btn--secondary" id="create-wp-coords-btn" style="flex:1;padding:8px;font-size:12px">
                            üìç Create Waypoint
                        </button>
                    </div>
                `;
                
                // Copy on click
                resultsDiv.querySelectorAll('.coord-result').forEach(el => {
                    el.onclick = () => {
                        const value = el.dataset.value;
                        navigator.clipboard.writeText(value).then(() => {
                            ModalsModule.showToast('Copied to clipboard', 'success');
                        }).catch(() => {
                            ModalsModule.showToast('Copy failed', 'error');
                        });
                    };
                });
                
                // Go to location
                const gotoBtn = resultsDiv.querySelector('#goto-coords-btn');
                if (gotoBtn) {
                    gotoBtn.onclick = () => {
                        MapModule.setCenter(parsed.lat, parsed.lon, 14);
                        ModalsModule.showToast('Map centered on coordinates', 'success');
                        
                        // Switch to map panel
                        State.UI.setActivePanel('map');
                        if (Helpers.isMobile()) State.UI.closePanel();
                    };
                }
                
                // Create waypoint
                const createWpBtn = resultsDiv.querySelector('#create-wp-coords-btn');
                if (createWpBtn) {
                    createWpBtn.onclick = () => {
                        // Add waypoint at coordinates
                        const wp = {
                            id: Helpers.generateId(),
                            name: 'Imported Location',
                            lat: parsed.lat,
                            lon: parsed.lon,
                            x: 50 + (parsed.lon + 119.1892) / 0.004,
                            y: 50 + (parsed.lat - 37.4215) / 0.002,
                            type: 'custom',
                            notes: `Created from: ${input}`,
                            verified: false
                        };
                        
                        State.Waypoints.add(wp);
                        Storage.Waypoints.save(wp);
                        
                        ModalsModule.showToast('Waypoint created', 'success');
                        
                        // Switch to waypoints panel
                        State.UI.setActivePanel('waypoints');
                        State.Waypoints.select(wp);
                        
                        // Center map on new waypoint
                        MapModule.setCenter(parsed.lat, parsed.lon, 14);
                    };
                }
            };
            
            convertBtn.onclick = doConvert;
            
            // Also convert on Enter key
            coordInput.onkeydown = (e) => {
                if (e.key === 'Enter') doConvert();
            };
        }
        
        // Declination bearing converter
        const toMagBtn = container.querySelector('#settings-to-mag');
        const toTrueBtn = container.querySelector('#settings-to-true');
        const trueBearingInput = container.querySelector('#settings-true-bearing');
        const magBearingInput = container.querySelector('#settings-mag-bearing');
        
        if (toMagBtn && toTrueBtn && trueBearingInput && magBearingInput && typeof DeclinationModule !== 'undefined') {
            const current = DeclinationModule.getCurrent();
            
            toMagBtn.onclick = () => {
                const trueBrg = parseFloat(trueBearingInput.value);
                if (!isNaN(trueBrg) && current.declination !== null) {
                    magBearingInput.value = Math.round(DeclinationModule.trueToMagnetic(trueBrg, current.declination));
                }
            };
            
            toTrueBtn.onclick = () => {
                const magBrg = parseFloat(magBearingInput.value);
                if (!isNaN(magBrg) && current.declination !== null) {
                    trueBearingInput.value = Math.round(DeclinationModule.magneticToTrue(magBrg, current.declination));
                }
            };
            
            trueBearingInput.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    const trueBrg = parseFloat(trueBearingInput.value);
                    if (!isNaN(trueBrg) && current.declination !== null) {
                        magBearingInput.value = Math.round(DeclinationModule.trueToMagnetic(trueBrg, current.declination));
                    }
                }
            };
            
            magBearingInput.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    const magBrg = parseFloat(magBearingInput.value);
                    if (!isNaN(magBrg) && current.declination !== null) {
                        trueBearingInput.value = Math.round(DeclinationModule.magneticToTrue(magBrg, current.declination));
                    }
                }
            };
        }
        
        // Default zoom setting
        container.querySelector('#setting-default-zoom').onchange = async (e) => {
            await Storage.Settings.set('defaultZoom', parseInt(e.target.value));
            ModalsModule.showToast('Default zoom updated', 'success');
        };
        
        // Set home location
        container.querySelector('#set-home-btn').onclick = async () => {
            const mapState = MapModule.getMapState();
            await Storage.Settings.set('homeLocation', {
                lat: mapState.lat,
                lon: mapState.lon,
                zoom: mapState.zoom
            });
            ModalsModule.showToast('Home location saved', 'success');
            renderSettings(); // Re-render to show updated location
        };
        
        // Go to home location
        const goHomeBtn = container.querySelector('#go-home-btn');
        if (goHomeBtn) {
            goHomeBtn.onclick = async () => {
                const home = await Storage.Settings.get('homeLocation');
                if (home) {
                    MapModule.setCenter(home.lat, home.lon, home.zoom);
                    ModalsModule.showToast('Navigated to home', 'success');
                }
            };
        }
        
        // AirNow API Key handler
        const saveAirnowBtn = container.querySelector('#save-airnow-key');
        if (saveAirnowBtn) {
            saveAirnowBtn.onclick = () => {
                const input = container.querySelector('#airnow-api-key');
                const key = input?.value?.trim();
                
                // Don't save if it's the masked placeholder
                if (key && key !== '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' && key.length > 0) {
                    if (typeof AirQualityModule !== 'undefined') {
                        AirQualityModule.setApiKey(key);
                        ModalsModule.showToast('AirNow API key saved', 'success');
                        renderSettings(); // Re-render to show updated status
                    }
                } else if (key === '' || key === null) {
                    // Clear the key
                    if (typeof AirQualityModule !== 'undefined') {
                        AirQualityModule.setApiKey(null);
                        ModalsModule.showToast('AirNow API key removed', 'info');
                        renderSettings();
                    }
                }
            };
            
            // Also allow Enter key to save
            const airnowInput = container.querySelector('#airnow-api-key');
            if (airnowInput) {
                airnowInput.onkeypress = (e) => {
                    if (e.key === 'Enter') {
                        saveAirnowBtn.click();
                    }
                };
                // Clear placeholder on focus
                airnowInput.onfocus = () => {
                    if (airnowInput.value === '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {
                        airnowInput.value = '';
                        airnowInput.type = 'text';
                    }
                };
            }
        }
        
        // Print button handlers
        container.querySelector('#print-full-plan-btn').onclick = () => {
            if (typeof PrintModule !== 'undefined') {
                PrintModule.printFullPlan({});
            } else {
                ModalsModule.showToast('Print module not available', 'error');
            }
        };
        
        const printRouteBtn = container.querySelector('#print-route-card-btn');
        if (printRouteBtn) {
            printRouteBtn.onclick = () => {
                if (typeof PrintModule !== 'undefined') {
                    const routes = State.get('routes').filter(r => !r.isBuilding);
                    if (routes.length > 0) {
                        PrintModule.printRouteCard(routes[0], {});
                    }
                }
            };
        }
        
        const printWaypointsBtn = container.querySelector('#print-waypoints-btn');
        if (printWaypointsBtn) {
            printWaypointsBtn.onclick = () => {
                if (typeof PrintModule !== 'undefined') {
                    const waypoints = State.get('waypoints');
                    PrintModule.printWaypointList(waypoints, {});
                }
            };
        }
        
        container.querySelector('#print-comm-btn').onclick = () => {
            if (typeof PrintModule !== 'undefined') {
                PrintModule.printCommPlan({});
            }
        };
        
        container.querySelector('#print-quick-ref-btn').onclick = () => {
            if (typeof PrintModule !== 'undefined') {
                PrintModule.printQuickRef({});
            }
        };
        
        container.querySelector('#print-modal-btn').onclick = () => {
            if (typeof PrintModule !== 'undefined') {
                PrintModule.showPrintModal();
            }
        };
        
        // Export JSON
        container.querySelector('#export-json-btn').onclick = async () => {
            try {
                const data = await Storage.exportData();
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `griddown-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                ModalsModule.showToast('Data exported', 'success');
            } catch (e) {
                console.error('Export failed:', e);
                ModalsModule.showToast('Export failed', 'error');
            }
        };
        
        // Import JSON
        container.querySelector('#import-json-input').onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const success = await Storage.importData(text);
                
                if (success) {
                    // Reload state from storage
                    const waypoints = await Storage.Waypoints.getAll();
                    const routes = await Storage.Routes.getAll();
                    State.Waypoints.setAll(waypoints);
                    State.Routes.setAll(routes);
                    
                    ModalsModule.showToast('Data imported successfully', 'success');
                    renderSettings(); // Re-render to show new counts
                    MapModule.render();
                } else {
                    ModalsModule.showToast('Invalid file format', 'error');
                }
            } catch (err) {
                console.error('Import failed:', err);
                ModalsModule.showToast('Import failed: ' + err.message, 'error');
            }
            
            // Reset input
            e.target.value = '';
        };
        
        // Clear waypoints
        container.querySelector('#clear-waypoints-btn').onclick = () => {
            if (waypointCount === 0) {
                ModalsModule.showToast('No waypoints to clear', 'info');
                return;
            }
            showClearConfirmation('waypoints', waypointCount);
        };
        
        // Clear routes
        container.querySelector('#clear-routes-btn').onclick = () => {
            if (routeCount === 0) {
                ModalsModule.showToast('No routes to clear', 'info');
                return;
            }
            showClearConfirmation('routes', routeCount);
        };
        
        // Clear all data
        container.querySelector('#clear-all-btn').onclick = () => {
            if (waypointCount === 0 && routeCount === 0) {
                ModalsModule.showToast('No data to clear', 'info');
                return;
            }
            showClearConfirmation('all', waypointCount + routeCount);
        };
        
        // Clear cache
        container.querySelector('#clear-cache-btn').onclick = async () => {
            try {
                if ('caches' in window) {
                    const keys = await caches.keys();
                    const tileCache = keys.find(k => k.includes('tiles'));
                    if (tileCache) {
                        await caches.delete(tileCache);
                        ModalsModule.showToast('Tile cache cleared', 'success');
                    } else {
                        ModalsModule.showToast('No tile cache found', 'info');
                    }
                }
            } catch (e) {
                console.error('Cache clear failed:', e);
                ModalsModule.showToast('Failed to clear cache', 'error');
            }
        };
        
        // Restart feature tour
        const restartTourBtn = container.querySelector('#restart-tour-btn');
        if (restartTourBtn) {
            restartTourBtn.onclick = async () => {
                if (typeof OnboardingModule !== 'undefined') {
                    await OnboardingModule.reset();
                    OnboardingModule.start();
                } else {
                    ModalsModule.showToast('Onboarding module not available', 'error');
                }
            };
        }
        
        // Diagnostics: Log level control
        const logLevelSelect = container.querySelector('#diag-log-level');
        if (logLevelSelect) {
            logLevelSelect.onchange = (e) => {
                if (typeof Log !== 'undefined') {
                    Log.setLevel(e.target.value);
                    ModalsModule.showToast(`Log level: ${e.target.value}`, 'success');
                }
            };
        }

        // Diagnostics: View error log
        const diagViewBtn = container.querySelector('#diag-view-errors');
        if (diagViewBtn) {
            diagViewBtn.onclick = () => {
                if (typeof ErrorBoundary === 'undefined') {
                    ModalsModule.showToast('Error boundary not available', 'info');
                    return;
                }
                const errs = ErrorBoundary.getErrors(20);
                const stats = ErrorBoundary.getStats();
                const statsLine = `Total: ${stats.total} ‚Ä¢ Captured: ${stats.captured} ‚Ä¢ Suppressed: ${stats.suppressed}`;
                
                const errHtml = errs.length === 0 
                    ? '<p style="color:rgba(255,255,255,0.5);text-align:center;padding:16px">No errors captured this session.</p>'
                    : errs.map(e => {
                        const time = new Date(e.timestamp).toLocaleTimeString();
                        const typeColor = e.type === 'error' ? '#ef4444' : '#f59e0b';
                        return `<div style="margin-bottom:8px;padding:8px;background:rgba(0,0,0,0.3);border-radius:6px;font-size:11px;font-family:monospace">
                            <div><span style="color:${typeColor}">[${Helpers.escapeHtml(e.type)}]</span> <span style="color:#60a5fa">[${Helpers.escapeHtml(e.module)}]</span> <span style="color:rgba(255,255,255,0.4)">${time}</span></div>
                            <div style="color:rgba(255,255,255,0.8);margin-top:4px">${Helpers.escapeHtml(e.message)}</div>
                            ${e.source && e.line ? `<div style="color:rgba(255,255,255,0.3);margin-top:2px">at ${Helpers.escapeHtml(e.source)}:${e.line}</div>` : ''}
                        </div>`;
                    }).join('');

                ModalsModule.showModal('Error Log', `
                    <div style="font-size:12px;color:rgba(255,255,255,0.5);margin-bottom:12px">${Helpers.escapeHtml(statsLine)}</div>
                    <div style="max-height:400px;overflow-y:auto">${errHtml}</div>
                `);
            };
        }

        // Diagnostics: Copy error report
        const diagCopyBtn = container.querySelector('#diag-copy-errors');
        if (diagCopyBtn) {
            diagCopyBtn.onclick = () => {
                if (typeof ErrorBoundary === 'undefined') {
                    ModalsModule.showToast('Error boundary not available', 'info');
                    return;
                }
                const report = ErrorBoundary.formatReport();
                navigator.clipboard.writeText(report).then(() => {
                    ModalsModule.showToast('Error report copied to clipboard', 'success');
                }).catch(() => {
                    ModalsModule.showToast('Could not copy report', 'error');
                });
            };
        }
    }
    
    /**
     * Show confirmation dialog for clearing data
     */
    function showClearConfirmation(type, count) {
        // Uses cached modalContainer ref
        const typeLabel = type === 'all' ? 'all data' : type;
        
        modalContainer.innerHTML = `
            <div class="modal-backdrop" id="modal-backdrop" role="presentation">
                <div class="modal" role="dialog" aria-modal="true" style="max-width:360px">
                    <div class="modal__header">
                        <h3 class="modal__title">Clear ${type === 'all' ? 'All Data' : type.charAt(0).toUpperCase() + type.slice(1)}?</h3>
                        <button class="modal__close" id="modal-close" aria-label="Close dialog">${Icons.get('close')}</button>
                    </div>
                    <div class="modal__body" style="text-align:center;padding:24px">
                        <div style="width:56px;height:56px;margin:0 auto 16px;background:rgba(239,68,68,0.15);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:28px">
                            üóëÔ∏è
                        </div>
                        <div style="font-size:14px;color:rgba(255,255,255,0.7);margin-bottom:8px">
                            This will permanently delete <strong style="color:#ef4444">${count}</strong> ${type === 'all' ? 'items' : type}.
                        </div>
                        <div style="font-size:12px;color:rgba(255,255,255,0.4)">
                            This action cannot be undone.
                        </div>
                    </div>
                    <div class="modal__footer" style="justify-content:center">
                        <button class="btn btn--secondary" id="modal-cancel" style="min-width:100px">Cancel</button>
                        <button class="btn" id="modal-confirm" style="min-width:100px;background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff">Delete</button>
                    </div>
                </div>
            </div>
        `;
        
        const closeModal = () => { modalContainer.innerHTML = ''; };
        
        modalContainer.querySelector('#modal-close').onclick = closeModal;
        modalContainer.querySelector('#modal-cancel').onclick = closeModal;
        modalContainer.querySelector('#modal-backdrop').onclick = (e) => {
            if (e.target.id === 'modal-backdrop') closeModal();
        };
        
        modalContainer.querySelector('#modal-confirm').onclick = async () => {
            try {
                if (type === 'waypoints' || type === 'all') {
                    const waypoints = State.get('waypoints');
                    for (const wp of waypoints) {
                        await Storage.Waypoints.delete(wp.id);
                    }
                    State.Waypoints.setAll([]);
                }
                
                if (type === 'routes' || type === 'all') {
                    const routes = State.get('routes');
                    for (const r of routes) {
                        await Storage.Routes.delete(r.id);
                    }
                    State.Routes.setAll([]);
                }
                
                closeModal();
                ModalsModule.showToast(`${type === 'all' ? 'All data' : type.charAt(0).toUpperCase() + type.slice(1)} cleared`, 'success');
                renderSettings();
                MapModule.render();
            } catch (e) {
                console.error('Clear failed:', e);
                ModalsModule.showToast('Failed to clear data', 'error');
            }
        };
        
        // Keyboard support
        const keyHandler = (e) => {
            if (e.key === 'Escape') {
                closeModal();
                document.removeEventListener('keydown', keyHandler);
            }
        };
        document.addEventListener('keydown', keyHandler);
    }

    // =========================================================================
    // CONTINGENCY PLANNING PANEL
    // =========================================================================

    function renderContingency() {
        const routes = State.get('routes').filter(r => !r.isBuilding);
        const waypoints = State.get('waypoints');
        const bailoutPoints = waypoints.filter(w => w.type === 'bailout');
        
        container.innerHTML = `
            <div class="panel__header">
                <h2 class="panel__title">Contingency Planning</h2>
            </div>
            
            <!-- Status Overview -->
            ${routes.length === 0 ? `
                <div class="status-card status-card--error" style="margin-bottom:20px">
                    <div class="status-card__icon">${Icons.get('alert')}</div>
                    <div>
                        <div class="status-card__title">No Routes Available</div>
                        <div class="status-card__desc">Create a route to enable contingency planning</div>
                    </div>
                </div>
            ` : bailoutPoints.length === 0 ? `
                <div class="status-card status-card--error" style="margin-bottom:20px">
                    <div class="status-card__icon">${Icons.get('alert')}</div>
                    <div>
                        <div class="status-card__title">No Bail-out Points</div>
                        <div class="status-card__desc">Add bail-out waypoints (üöÅ) for emergency exit analysis</div>
                    </div>
                </div>
            ` : `
                <div class="status-card status-card--success" style="margin-bottom:20px">
                    <div class="status-card__icon">${Icons.get('check')}</div>
                    <div>
                        <div class="status-card__title">Ready for Planning</div>
                        <div class="status-card__desc">${routes.length} route(s), ${bailoutPoints.length} bail-out point(s)</div>
                    </div>
                </div>
            `}
            
            <!-- Section: Bail-out Analysis -->
            <div class="section-label" style="display:flex;align-items:center;gap:8px">
                üöÅ Bail-out Analysis
            </div>
            <div style="padding:14px;background:rgba(255,255,255,0.03);border-radius:12px;margin-bottom:20px">
                ${routes.length > 0 ? `
                    <div style="margin-bottom:12px">
                        <label style="font-size:12px;color:rgba(255,255,255,0.5);display:block;margin-bottom:6px">Select Route</label>
                        <select id="bailout-route-select" style="width:100%">
                            ${routes.map((r, i) => `<option value="${i}">${r.name}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div style="margin-bottom:12px">
                        <label style="font-size:12px;color:rgba(255,255,255,0.5);display:block;margin-bottom:6px">Check at Mile Marker</label>
                        <div style="display:flex;gap:8px">
                            <input type="number" id="bailout-mile-input" placeholder="e.g., 15" min="0" step="0.1" style="flex:1">
                            <button class="btn btn--primary" id="check-bailout-btn">Check</button>
                        </div>
                    </div>
                    
                    <button class="btn btn--secondary btn--full" id="full-bailout-analysis-btn">
                        üìä Full Route Bail-out Analysis
                    </button>
                    
                    <div id="bailout-results" style="margin-top:12px"></div>
                ` : `
                    <div style="text-align:center;padding:20px;color:rgba(255,255,255,0.4)">
                        Create a route to analyze bail-out options
                    </div>
                `}
            </div>
            
            <!-- Section: Route Comparison -->
            <div class="section-label" style="display:flex;align-items:center;gap:8px">
                ‚ÜîÔ∏è Route Comparison
            </div>
            <div style="padding:14px;background:rgba(255,255,255,0.03);border-radius:12px;margin-bottom:20px">
                ${routes.length >= 2 ? `
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
                        <div>
                            <label style="font-size:12px;color:rgba(255,255,255,0.5);display:block;margin-bottom:6px">Primary Route</label>
                            <select id="primary-route-select" style="width:100%">
                                ${routes.map((r, i) => `<option value="${i}">${r.name}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label style="font-size:12px;color:rgba(255,255,255,0.5);display:block;margin-bottom:6px">Alternate Route</label>
                            <select id="alternate-route-select" style="width:100%">
                                ${routes.map((r, i) => `<option value="${i}" ${i === 1 ? 'selected' : ''}>${r.name}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <button class="btn btn--primary btn--full" id="compare-routes-btn">
                        Compare Routes
                    </button>
                    <div id="route-comparison-results" style="margin-top:12px"></div>
                ` : `
                    <div style="text-align:center;padding:20px;color:rgba(255,255,255,0.4)">
                        ${routes.length === 0 ? 'Create routes to compare them' : 'Create a second route to enable comparison'}
                    </div>
                `}
            </div>
            
            <!-- Section: Time Checkpoints -->
            <div class="section-label" style="display:flex;align-items:center;gap:8px">
                ‚è±Ô∏è Time-Based Checkpoints
            </div>
            <div style="padding:14px;background:rgba(255,255,255,0.03);border-radius:12px;margin-bottom:20px">
                ${routes.length > 0 ? `
                    <div style="margin-bottom:12px">
                        <label style="font-size:12px;color:rgba(255,255,255,0.5);display:block;margin-bottom:6px">Select Route</label>
                        <select id="checkpoint-route-select" style="width:100%">
                            ${routes.map((r, i) => `<option value="${i}">${r.name}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
                        <div>
                            <label style="font-size:12px;color:rgba(255,255,255,0.5);display:block;margin-bottom:6px">Departure Date</label>
                            <input type="date" id="departure-date" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        <div>
                            <label style="font-size:12px;color:rgba(255,255,255,0.5);display:block;margin-bottom:6px">Departure Time</label>
                            <input type="time" id="departure-time" value="08:00">
                        </div>
                    </div>
                    
                    <div style="margin-bottom:12px">
                        <label style="font-size:12px;color:rgba(255,255,255,0.5);display:block;margin-bottom:6px">Checkpoint Interval (miles)</label>
                        <input type="number" id="checkpoint-interval" value="10" min="1" max="50">
                    </div>
                    
                    <button class="btn btn--primary btn--full" id="generate-checkpoints-btn">
                        Generate Checkpoints
                    </button>
                    
                    <div id="checkpoint-results" style="margin-top:12px"></div>
                ` : `
                    <div style="text-align:center;padding:20px;color:rgba(255,255,255,0.4)">
                        Create a route to generate checkpoints
                    </div>
                `}
            </div>
            
            <!-- Section: Itinerary Generator -->
            <div class="section-label" style="display:flex;align-items:center;gap:8px">
                üìã Trip Itinerary
            </div>
            <div style="padding:14px;background:rgba(255,255,255,0.03);border-radius:12px;margin-bottom:20px">
                ${routes.length > 0 ? `
                    <div style="margin-bottom:12px">
                        <label style="font-size:12px;color:rgba(255,255,255,0.5);display:block;margin-bottom:6px">Select Route</label>
                        <select id="itinerary-route-select" style="width:100%">
                            ${routes.map((r, i) => `<option value="${i}">${r.name}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div style="margin-bottom:12px">
                        <label style="font-size:12px;color:rgba(255,255,255,0.5);display:block;margin-bottom:6px">Traveler Name</label>
                        <input type="text" id="traveler-name" placeholder="Your Name">
                    </div>
                    
                    <div style="margin-bottom:12px">
                        <label style="font-size:12px;color:rgba(255,255,255,0.5);display:block;margin-bottom:6px">Vehicle Description</label>
                        <input type="text" id="vehicle-info" placeholder="e.g., Red Toyota 4Runner, License ABC123">
                    </div>
                    
                    <div style="margin-bottom:12px">
                        <label style="font-size:12px;color:rgba(255,255,255,0.5);display:block;margin-bottom:6px">Emergency Contact 1</label>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                            <input type="text" id="emergency-name-1" placeholder="Name">
                            <input type="tel" id="emergency-phone-1" placeholder="Phone">
                        </div>
                    </div>
                    
                    <div style="margin-bottom:12px">
                        <label style="font-size:12px;color:rgba(255,255,255,0.5);display:block;margin-bottom:6px">Emergency Contact 2 (Optional)</label>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                            <input type="text" id="emergency-name-2" placeholder="Name">
                            <input type="tel" id="emergency-phone-2" placeholder="Phone">
                        </div>
                    </div>
                    
                    <div style="margin-bottom:12px">
                        <label style="font-size:12px;color:rgba(255,255,255,0.5);display:block;margin-bottom:6px">Additional Notes</label>
                        <textarea id="itinerary-notes" rows="2" placeholder="Any special instructions or notes..."></textarea>
                    </div>
                    
                    <button class="btn btn--primary btn--full" id="generate-itinerary-btn" style="margin-bottom:8px">
                        üìã Generate Itinerary
                    </button>
                    
                    <div id="itinerary-preview" style="margin-top:12px"></div>
                ` : `
                    <div style="text-align:center;padding:20px;color:rgba(255,255,255,0.4)">
                        Create a route to generate an itinerary
                    </div>
                `}
            </div>
            
            <!-- Quick Tips -->
            <div class="section-label">üí° Planning Tips</div>
            <div style="padding:14px;background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.2);border-radius:12px;font-size:12px;color:rgba(255,255,255,0.7)">
                <p style="margin-bottom:8px">‚Ä¢ Add bail-out points (üöÅ) at highway junctions, ranger stations, or areas with cell service</p>
                <p style="margin-bottom:8px">‚Ä¢ Share your itinerary with emergency contacts before departure</p>
                <p style="margin-bottom:8px">‚Ä¢ Set realistic checkpoint times - better to arrive early than be marked overdue</p>
                <p>‚Ä¢ Include vehicle description and license plate for search teams</p>
            </div>
        `;
        
        // Attach event handlers
        attachContingencyHandlers(routes, waypoints);
    }
    
    /**
     * Attach event handlers for contingency panel
     */
    function attachContingencyHandlers(routes, waypoints) {
        // Bail-out at mile
        const checkBailoutBtn = container.querySelector('#check-bailout-btn');
        if (checkBailoutBtn) {
            checkBailoutBtn.onclick = () => {
                const routeIdx = parseInt(container.querySelector('#bailout-route-select').value);
                const mileMarker = parseFloat(container.querySelector('#bailout-mile-input').value);
                
                if (isNaN(mileMarker) || mileMarker < 0) {
                    ModalsModule.showToast('Enter a valid mile marker', 'error');
                    return;
                }
                
                const result = ContingencyModule.getBailoutAtMile(routes[routeIdx], waypoints, mileMarker);
                displayBailoutAtMile(result);
            };
        }
        
        // Full bailout analysis
        const fullBailoutBtn = container.querySelector('#full-bailout-analysis-btn');
        if (fullBailoutBtn) {
            fullBailoutBtn.onclick = () => {
                const routeIdx = parseInt(container.querySelector('#bailout-route-select').value);
                const result = ContingencyModule.analyzeBailouts(routes[routeIdx], waypoints);
                displayFullBailoutAnalysis(result);
            };
        }
        
        // Route comparison
        const compareBtn = container.querySelector('#compare-routes-btn');
        if (compareBtn) {
            compareBtn.onclick = () => {
                const primaryIdx = parseInt(container.querySelector('#primary-route-select').value);
                const alternateIdx = parseInt(container.querySelector('#alternate-route-select').value);
                
                if (primaryIdx === alternateIdx) {
                    ModalsModule.showToast('Select different routes to compare', 'error');
                    return;
                }
                
                const result = ContingencyModule.compareRoutes(routes[primaryIdx], routes[alternateIdx], waypoints);
                displayRouteComparison(result);
            };
        }
        
        // Generate checkpoints
        const checkpointBtn = container.querySelector('#generate-checkpoints-btn');
        if (checkpointBtn) {
            checkpointBtn.onclick = () => {
                const routeIdx = parseInt(container.querySelector('#checkpoint-route-select').value);
                const dateStr = container.querySelector('#departure-date').value;
                const timeStr = container.querySelector('#departure-time').value;
                const interval = parseInt(container.querySelector('#checkpoint-interval').value) || 10;
                
                const departureTime = new Date(`${dateStr}T${timeStr}`);
                
                const result = ContingencyModule.generateCheckpoints(routes[routeIdx], waypoints, {
                    departureTime,
                    intervalMiles: interval
                });
                
                displayCheckpoints(result);
            };
        }
        
        // Generate itinerary
        const itineraryBtn = container.querySelector('#generate-itinerary-btn');
        if (itineraryBtn) {
            itineraryBtn.onclick = () => {
                const routeIdx = parseInt(container.querySelector('#itinerary-route-select').value);
                const dateStr = container.querySelector('#departure-date')?.value || new Date().toISOString().split('T')[0];
                const timeStr = container.querySelector('#departure-time')?.value || '08:00';
                
                const travelerName = container.querySelector('#traveler-name').value || 'Traveler';
                const vehicleInfo = container.querySelector('#vehicle-info').value || 'Vehicle not specified';
                const notes = container.querySelector('#itinerary-notes').value || '';
                
                // Collect emergency contacts
                const emergencyContacts = [];
                const name1 = container.querySelector('#emergency-name-1').value;
                const phone1 = container.querySelector('#emergency-phone-1').value;
                if (name1 && phone1) {
                    emergencyContacts.push({ name: name1, phone: phone1 });
                }
                const name2 = container.querySelector('#emergency-name-2').value;
                const phone2 = container.querySelector('#emergency-phone-2').value;
                if (name2 && phone2) {
                    emergencyContacts.push({ name: name2, phone: phone2 });
                }
                
                const departureTime = new Date(`${dateStr}T${timeStr}`);
                
                const itinerary = ContingencyModule.generateItinerary(routes[routeIdx], waypoints, {
                    departureTime,
                    travelerName,
                    vehicleInfo,
                    emergencyContacts,
                    notes
                });
                
                displayItineraryPreview(itinerary);
            };
        }
    }
    
    /**
     * Display bail-out at mile result
     */
    function displayBailoutAtMile(result) {
        const resultsDiv = container.querySelector('#bailout-results');
        if (!resultsDiv) return;
        
        if (result.error) {
            resultsDiv.innerHTML = `
                <div style="padding:12px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.2);border-radius:8px;color:#ef4444">
                    ${Helpers.escapeHtml(result.error)}${result.recommendation ? `<br><small>${Helpers.escapeHtml(result.recommendation)}</small>` : ''}
                </div>
            `;
            return;
        }
        
        const bp = result.nearestBailout;
        const risk = result.riskLevel;
        
        resultsDiv.innerHTML = `
            <div style="padding:14px;background:${risk.color}15;border:1px solid ${risk.color}30;border-radius:10px">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
                    <span style="font-size:20px">üöÅ</span>
                    <div>
                        <div style="font-weight:600;color:${risk.color}">${risk.label}</div>
                        <div style="font-size:11px;color:rgba(255,255,255,0.5)">At Mile ${result.actualMileMarker.toFixed(1)}</div>
                    </div>
                </div>
                
                ${bp ? `
                    <div style="padding:12px;background:rgba(0,0,0,0.2);border-radius:8px;margin-bottom:12px">
                        <div style="font-weight:500;margin-bottom:4px">${bp.name}</div>
                        <div style="font-size:12px;color:rgba(255,255,255,0.6)">
                            üìç ${bp.distance.toFixed(1)} miles away<br>
                            üß≠ Bearing: ${Math.round(bp.bearing)}¬∞ (${getCardinalDirection(bp.bearing)})<br>
                            ‚è±Ô∏è Est. travel time: ${bp.estimatedTime < 1 ? Math.round(bp.estimatedTime * 60) + ' min' : bp.estimatedTime.toFixed(1) + ' hours'}
                        </div>
                        ${bp.notes ? `<div style="margin-top:8px;font-size:11px;color:rgba(255,255,255,0.4)">Note: ${bp.notes}</div>` : ''}
                    </div>
                ` : ''}
                
                ${result.alternatives && result.alternatives.length > 0 ? `
                    <div style="font-size:11px;color:rgba(255,255,255,0.5);margin-bottom:6px">Alternatives:</div>
                    ${result.alternatives.map(alt => `
                        <div style="font-size:12px;padding:6px 8px;background:rgba(0,0,0,0.1);border-radius:4px;margin-bottom:4px">
                            ${alt.name} - ${alt.distance.toFixed(1)} mi ${getCardinalDirection(alt.bearing)}
                        </div>
                    `).join('')}
                ` : ''}
            </div>
        `;
    }
    
    /**
     * Display full bail-out analysis
     */
    function displayFullBailoutAnalysis(result) {
        const resultsDiv = container.querySelector('#bailout-results');
        if (!resultsDiv) return;
        
        if (result.error) {
            resultsDiv.innerHTML = `
                <div style="padding:12px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.2);border-radius:8px;color:#ef4444">
                    ${Helpers.escapeHtml(result.error)}${result.recommendation ? `<br><small>${Helpers.escapeHtml(result.recommendation)}</small>` : ''}
                </div>
            `;
            return;
        }
        
        const summary = result.summary;
        const overallColor = summary.overallRisk === 'high' ? '#ef4444' : summary.overallRisk === 'moderate' ? '#f59e0b' : '#22c55e';
        
        resultsDiv.innerHTML = `
            <div style="padding:14px;background:${overallColor}15;border:1px solid ${overallColor}30;border-radius:10px;margin-bottom:12px">
                <div style="font-weight:600;color:${overallColor};margin-bottom:8px">
                    Overall Risk: ${summary.overallRisk.toUpperCase()}
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px">
                    <div>
                        <span style="color:rgba(255,255,255,0.5)">Avg Distance:</span>
                        <span style="font-weight:500"> ${summary.avgDistanceToBailout.toFixed(1)} mi</span>
                    </div>
                    <div>
                        <span style="color:rgba(255,255,255,0.5)">Max Distance:</span>
                        <span style="font-weight:500"> ${summary.maxDistanceToBailout.toFixed(1)} mi</span>
                    </div>
                    <div>
                        <span style="color:rgba(255,255,255,0.5)">Critical Sections:</span>
                        <span style="font-weight:500"> ${summary.criticalSectionCount}</span>
                    </div>
                    <div>
                        <span style="color:rgba(255,255,255,0.5)">Critical Miles:</span>
                        <span style="font-weight:500"> ${summary.criticalMiles.toFixed(1)} mi</span>
                    </div>
                </div>
            </div>
            
            ${result.criticalSections.length > 0 ? `
                <div style="font-size:12px;font-weight:500;margin-bottom:8px;color:#ef4444">
                    ‚ö†Ô∏è Critical Sections (far from exits):
                </div>
                ${result.criticalSections.map(sec => `
                    <div style="padding:10px;background:rgba(239,68,68,0.1);border-radius:6px;margin-bottom:6px;font-size:12px">
                        Mile ${sec.startMile.toFixed(1)} - ${sec.endMile.toFixed(1)} (${sec.length.toFixed(1)} mi)<br>
                        <span style="color:rgba(255,255,255,0.5)">Max distance to exit: ${sec.maxDistanceToBailout.toFixed(1)} mi</span>
                    </div>
                `).join('')}
            ` : `
                <div style="padding:12px;background:rgba(34,197,94,0.1);border-radius:8px;color:#22c55e;font-size:12px">
                    ‚úì Good bail-out coverage throughout route
                </div>
            `}
        `;
    }
    
    /**
     * Display route comparison
     */
    function displayRouteComparison(result) {
        const resultsDiv = container.querySelector('#route-comparison-results');
        if (!resultsDiv) return;
        
        if (result.error) {
            resultsDiv.innerHTML = `<div style="color:#ef4444">${Helpers.escapeHtml(result.error)}</div>`;
            return;
        }
        
        const p = result.primary;
        const a = result.alternate;
        const d = result.differences;
        const rec = result.recommendation;
        
        const recColor = rec.choice === 'primary' ? '#22c55e' : rec.choice === 'alternate' ? '#3b82f6' : '#f59e0b';
        
        resultsDiv.innerHTML = `
            <!-- Recommendation -->
            <div style="padding:12px;background:${recColor}20;border:1px solid ${recColor}40;border-radius:10px;margin-bottom:12px">
                <div style="font-weight:600;color:${recColor};margin-bottom:4px">
                    ${rec.choice === 'primary' ? '‚úì Primary Recommended' : rec.choice === 'alternate' ? '‚úì Alternate Recommended' : '‚âà Either Route Viable'}
                </div>
                <div style="font-size:12px;color:rgba(255,255,255,0.7)">${rec.reason}</div>
            </div>
            
            <!-- Comparison Table -->
            <div style="background:rgba(0,0,0,0.2);border-radius:10px;overflow:hidden">
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;font-size:11px;text-transform:uppercase;color:rgba(255,255,255,0.4);padding:10px;border-bottom:1px solid rgba(255,255,255,0.1)">
                    <div>Metric</div>
                    <div style="text-align:center">${p.name}</div>
                    <div style="text-align:center">${a.name}</div>
                </div>
                
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;padding:10px;border-bottom:1px solid rgba(255,255,255,0.05);font-size:12px">
                    <div style="color:rgba(255,255,255,0.6)">Distance</div>
                    <div style="text-align:center;font-weight:500">${p.totalDistance.toFixed(1)} mi</div>
                    <div style="text-align:center;font-weight:500;color:${d.distance < 0 ? '#22c55e' : d.distance > 0 ? '#ef4444' : 'inherit'}">${a.totalDistance.toFixed(1)} mi</div>
                </div>
                
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;padding:10px;border-bottom:1px solid rgba(255,255,255,0.05);font-size:12px">
                    <div style="color:rgba(255,255,255,0.6)">Est. Time</div>
                    <div style="text-align:center;font-weight:500">${ContingencyModule.formatDuration(p.estimatedTime)}</div>
                    <div style="text-align:center;font-weight:500;color:${d.time < 0 ? '#22c55e' : d.time > 0 ? '#ef4444' : 'inherit'}">${ContingencyModule.formatDuration(a.estimatedTime)}</div>
                </div>
                
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;padding:10px;border-bottom:1px solid rgba(255,255,255,0.05);font-size:12px">
                    <div style="color:rgba(255,255,255,0.6)">Est. Fuel</div>
                    <div style="text-align:center;font-weight:500">${p.estimatedFuel.toFixed(1)} gal</div>
                    <div style="text-align:center;font-weight:500;color:${d.fuel < 0 ? '#22c55e' : d.fuel > 0 ? '#ef4444' : 'inherit'}">${a.estimatedFuel.toFixed(1)} gal</div>
                </div>
                
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;padding:10px;font-size:12px">
                    <div style="color:rgba(255,255,255,0.6)">Risk Score</div>
                    <div style="text-align:center;font-weight:500">${p.riskScore}</div>
                    <div style="text-align:center;font-weight:500;color:${d.riskScore < 0 ? '#22c55e' : d.riskScore > 0 ? '#ef4444' : 'inherit'}">${a.riskScore}</div>
                </div>
            </div>
        `;
    }
    
    /**
     * Display checkpoints
     */
    function displayCheckpoints(result) {
        const resultsDiv = container.querySelector('#checkpoint-results');
        if (!resultsDiv) return;
        
        if (result.error) {
            resultsDiv.innerHTML = `<div style="color:#ef4444">${Helpers.escapeHtml(result.error)}</div>`;
            return;
        }
        
        resultsDiv.innerHTML = `
            <div style="padding:14px;background:rgba(249,115,22,0.1);border:1px solid rgba(249,115,22,0.2);border-radius:10px;margin-bottom:12px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                    <span style="font-weight:600;color:#f97316">${result.routeName}</span>
                    <span style="font-size:12px;color:rgba(255,255,255,0.5)">${result.totalDistance.toFixed(1)} miles</span>
                </div>
                <div style="font-size:12px">
                    <div>üöó Departure: <strong>${ContingencyModule.formatDateTime(result.departureTime)}</strong></div>
                    <div>üèÅ ETA: <strong>${ContingencyModule.formatDateTime(result.estimatedArrival)}</strong></div>
                    <div>‚è±Ô∏è Duration: <strong>${ContingencyModule.formatDuration(result.estimatedDuration)}</strong></div>
                </div>
            </div>
            
            <div style="font-size:12px;font-weight:500;margin-bottom:8px">Checkpoints (${result.checkpoints.length})</div>
            <div style="max-height:300px;overflow-y:auto">
                ${result.checkpoints.map((cp, i) => {
                    const icon = cp.type === 'start' ? 'üö©' : cp.type === 'end' ? 'üèÅ' : 'üìç';
                    return `
                        <div style="padding:10px;background:rgba(0,0,0,0.2);border-radius:8px;margin-bottom:6px">
                            <div style="display:flex;justify-content:space-between;align-items:center">
                                <span style="font-weight:500">${icon} ${cp.name}</span>
                                <span style="font-size:11px;color:rgba(255,255,255,0.4)">Mile ${cp.mileMarker.toFixed(1)}</span>
                            </div>
                            <div style="font-size:11px;color:rgba(255,255,255,0.6);margin-top:4px">
                                Expected: ${ContingencyModule.formatDateTime(cp.expectedTime)}<br>
                                <span style="color:#f59e0b">Overdue if not here by: ${ContingencyModule.formatDateTime(cp.overdueTime)}</span>
                            </div>
                            ${cp.searchArea ? `
                                <div style="font-size:10px;color:rgba(255,255,255,0.4);margin-top:4px">
                                    üîç ${cp.searchArea.description}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('')}
            </div>
        `;
    }
    
    /**
     * Display itinerary preview
     */
    function displayItineraryPreview(itinerary) {
        const previewDiv = container.querySelector('#itinerary-preview');
        if (!previewDiv) return;
        
        if (itinerary.error) {
            previewDiv.innerHTML = `<div style="color:#ef4444">${Helpers.escapeHtml(itinerary.error)}</div>`;
            return;
        }
        
        previewDiv.innerHTML = `
            <div style="padding:14px;background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.2);border-radius:10px;margin-bottom:12px">
                <div style="font-weight:600;color:#22c55e;margin-bottom:8px">‚úì Itinerary Generated</div>
                <div style="font-size:12px">
                    <div><strong>${itinerary.summary.route}</strong></div>
                    <div style="color:rgba(255,255,255,0.6)">${itinerary.summary.totalDistance} ‚Ä¢ ${itinerary.summary.estimatedDuration}</div>
                    <div style="color:rgba(255,255,255,0.6)">Departure: ${itinerary.summary.departureTime}</div>
                    <div style="color:rgba(255,255,255,0.6)">ETA: ${itinerary.summary.expectedArrival}</div>
                </div>
            </div>
            
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                <button class="btn btn--primary" id="download-itinerary-text">
                    üìÑ Download Text
                </button>
                <button class="btn btn--secondary" id="download-itinerary-json">
                    üíæ Download JSON
                </button>
            </div>
            
            <div style="margin-top:12px">
                <button class="btn btn--secondary btn--full" id="preview-itinerary-text">
                    üëÅÔ∏è Preview Text
                </button>
            </div>
            
            <div id="itinerary-text-preview" style="margin-top:12px"></div>
        `;
        
        // Download handlers
        previewDiv.querySelector('#download-itinerary-text').onclick = () => {
            ContingencyModule.downloadItinerary(itinerary, 'text');
            ModalsModule.showToast('Itinerary downloaded', 'success');
        };
        
        previewDiv.querySelector('#download-itinerary-json').onclick = () => {
            ContingencyModule.downloadItinerary(itinerary, 'json');
            ModalsModule.showToast('JSON downloaded', 'success');
        };
        
        previewDiv.querySelector('#preview-itinerary-text').onclick = () => {
            const textPreview = previewDiv.querySelector('#itinerary-text-preview');
            const text = ContingencyModule.exportItineraryAsText(itinerary);
            textPreview.innerHTML = `
                <div style="padding:12px;background:#000;border-radius:8px;font-family:'IBM Plex Mono',monospace;font-size:10px;white-space:pre-wrap;max-height:400px;overflow-y:auto;color:#0f0">
${text}
                </div>
            `;
        };
    }
    
    // ==================== Sun/Moon Panel ====================
    
    // Track current date for sun/moon panel
    let sunMoonDate = new Date();
    
    /**
     * Render Sun/Moon Calculator Panel
     */
    function renderSunMoon() {
        _saveScroll(); _restoreScroll();
        // Initialize module if needed
        if (typeof SunMoonModule !== 'undefined') {
            SunMoonModule.init();
            
            // Sync with map location if available
            if (typeof MapModule !== 'undefined') {
                const mapState = MapModule.getMapState();
                if (mapState) {
                    SunMoonModule.setLocation(mapState.lat, mapState.lon);
                }
            }
        }
        
        container.innerHTML = `
            <div class="panel__header">
                <h2 class="panel__title">‚òÄÔ∏è Sun & Moon</h2>
            </div>
            ${typeof SunMoonModule !== 'undefined' ? SunMoonModule.renderPanel(sunMoonDate) : `
                <div style="padding:40px;text-align:center;color:rgba(255,255,255,0.5)">
                    <div style="font-size:32px;margin-bottom:12px">‚òÄÔ∏è</div>
                    <div style="font-size:13px">Sun/Moon module not loaded</div>
                </div>
            `}
        `;
        
        // Bind events
        if (typeof SunMoonModule !== 'undefined') {
            SunMoonModule.bindPanelEvents(
                container, 
                sunMoonDate, 
                (newDate) => {
                    sunMoonDate = newDate;
                    renderSunMoon();
                },
                (lat, lon) => {
                    renderSunMoon();
                }
            );
        }
    }
    
    // ==================== CELESTIAL NAVIGATION PANEL ====================
    
    // Celestial panel state
    let celestialState = {
        activeTab: 'almanac',
        observerLat: null,
        observerLon: null,
        selectedDate: new Date()
    };
    
    /**
     * Render Celestial Navigation Panel
     */
    function renderCelestial() {
        _saveScroll(); _restoreScroll();
        // Check if module is available
        if (typeof CelestialModule === 'undefined') {
            container.innerHTML = `
                <div class="panel__header">
                    <h2 class="panel__title">üåü Celestial Navigation</h2>
                </div>
                <div class="empty-state">
                    <div class="empty-state__icon">${Icons.get('star')}</div>
                    <div class="empty-state__title">Celestial Module Not Loaded</div>
                    <div class="empty-state__desc">Celestial navigation features are not available</div>
                </div>
            `;
            return;
        }
        
        // Get current position from map or GPS
        let lat = celestialState.observerLat;
        let lon = celestialState.observerLon;
        
        if (lat === null || lon === null) {
            if (typeof MapModule !== 'undefined') {
                const mapState = MapModule.getMapState();
                if (mapState) {
                    lat = mapState.lat;
                    lon = mapState.lon;
                    celestialState.observerLat = lat;
                    celestialState.observerLon = lon;
                }
            }
        }
        
        // Default to San Francisco if no position
        if (lat === null) lat = 37.7749;
        if (lon === null) lon = -122.4194;
        
        const date = celestialState.selectedDate;
        const activeTab = celestialState.activeTab;
        
        // Tab definitions
        const tabs = [
            { id: 'almanac', icon: 'üìñ', label: 'Almanac' },
            { id: 'observe', icon: 'üî≠', label: 'Observe' },
            { id: 'fix', icon: 'üìç', label: 'Fix' },
            { id: 'tools', icon: 'üß≠', label: 'Tools' },
            { id: 'dr', icon: 'üìê', label: 'DR' },
            { id: 'inertial', icon: 'üì±', label: 'IMU' },
            { id: 'training', icon: 'üéì', label: 'Training' }
        ];
        
        container.innerHTML = `
            <div class="panel__header">
                <h2 class="panel__title">üåü Celestial Navigation</h2>
            </div>
            
            <!-- Position Display -->
            <div style="padding:12px;background:var(--color-bg-elevated);border-radius:10px;margin:12px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                    <div style="font-size:12px;color:rgba(255,255,255,0.5)">Observer Position</div>
                    <button id="celestial-sync-pos" class="btn btn--secondary" style="padding:4px 8px;font-size:10px">
                        üìç Sync from Map
                    </button>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                    <div>
                        <label style="font-size:9px;color:rgba(255,255,255,0.4)">Latitude</label>
                        <input type="number" id="celestial-lat" value="${lat.toFixed(4)}" step="0.0001" 
                               style="width:100%;padding:6px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);border-radius:4px;color:white;font-size:12px">
                    </div>
                    <div>
                        <label style="font-size:9px;color:rgba(255,255,255,0.4)">Longitude</label>
                        <input type="number" id="celestial-lon" value="${lon.toFixed(4)}" step="0.0001"
                               style="width:100%;padding:6px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);border-radius:4px;color:white;font-size:12px">
                    </div>
                </div>
                <div style="margin-top:8px;font-size:10px;color:rgba(255,255,255,0.4);text-align:center">
                    UTC: ${date.toISOString().replace('T', ' ').substr(0, 19)}
                </div>
            </div>
            
            <!-- Tab Navigation -->
            <div style="display:flex;gap:4px;padding:0 12px;margin-bottom:12px;overflow-x:auto">
                ${tabs.map(tab => `
                    <button class="celestial-tab btn ${activeTab === tab.id ? 'btn--primary' : 'btn--secondary'}" 
                            data-tab="${tab.id}"
                            style="flex:1;padding:8px 4px;font-size:10px;white-space:nowrap;min-width:60px">
                        <span style="display:block;font-size:16px">${tab.icon}</span>
                        ${tab.label}
                    </button>
                `).join('')}
            </div>
            
            <!-- Tab Content -->
            <div id="celestial-content" style="padding:0 12px 12px">
                ${renderCelestialTabContent(activeTab, lat, lon, date)}
            </div>
        `;
        
        // Bind events
        bindCelestialEvents();
    }
    
    /**
     * Render content for active celestial tab
     */
    function renderCelestialTabContent(tab, lat, lon, date) {
        switch (tab) {
            case 'almanac':
                return renderCelestialAlmanac(lat, lon, date);
            case 'observe':
                return renderCelestialObserve(lat, lon, date);
            case 'fix':
                return renderCelestialFix(lat, lon, date);
            case 'tools':
                return renderCelestialTools(lat, lon, date);
            case 'dr':
                return renderCelestialDR(lat, lon, date);
            case 'inertial':
                return renderCelestialInertial(lat, lon, date);
            case 'training':
                return renderCelestialTraining(lat, lon, date);
            default:
                return renderCelestialAlmanac(lat, lon, date);
        }
    }
    
    /**
     * Render Almanac tab
     */
    function renderCelestialAlmanac(lat, lon, date) {
        const almanac = CelestialModule.getAlmanac(date);
        const visible = CelestialModule.getVisibleBodies(lat, lon, date);
        const recommended = CelestialModule.getRecommendedBodies(lat, lon, date, 5);
        
        return `
            <div style="background:var(--color-bg-elevated);border-radius:10px;padding:12px;margin-bottom:12px">
                <div style="font-size:14px;font-weight:600;margin-bottom:12px">‚òÄÔ∏è Sun & Moon</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                    <div style="padding:10px;background:rgba(251,191,36,0.1);border-radius:8px">
                        <div style="font-size:11px;color:rgba(255,255,255,0.5)">Sun</div>
                        <div style="font-size:12px;margin-top:4px">GHA: ${almanac.sun.formatted.GHA}</div>
                        <div style="font-size:12px">Dec: ${almanac.sun.formatted.dec}</div>
                    </div>
                    <div style="padding:10px;background:rgba(148,163,184,0.1);border-radius:8px">
                        <div style="font-size:11px;color:rgba(255,255,255,0.5)">Moon</div>
                        <div style="font-size:12px;margin-top:4px">GHA: ${almanac.moon.formatted.GHA}</div>
                        <div style="font-size:12px">Dec: ${almanac.moon.formatted.dec}</div>
                    </div>
                </div>
            </div>
            
            <div style="background:var(--color-bg-elevated);border-radius:10px;padding:12px;margin-bottom:12px">
                <div style="font-size:14px;font-weight:600;margin-bottom:12px">‚≠ê Recommended for Observation</div>
                <div style="font-size:10px;color:rgba(255,255,255,0.5);margin-bottom:8px">
                    ${recommended.length} bodies with good geometry
                </div>
                ${recommended.length > 0 ? `
                    <div style="display:flex;flex-direction:column;gap:8px">
                        ${recommended.map(body => `
                            <div style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:rgba(0,0,0,0.2);border-radius:6px">
                                <div>
                                    <div style="font-size:12px;font-weight:600">${body.name}</div>
                                    <div style="font-size:10px;color:rgba(255,255,255,0.5)">${body.body}</div>
                                </div>
                                <div style="text-align:right">
                                    <div style="font-size:11px">Alt: ${body.altitude.toFixed(1)}¬∞</div>
                                    <div style="font-size:11px">Az: ${body.azimuth.toFixed(1)}¬∞</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : `
                    <div style="text-align:center;padding:20px;color:rgba(255,255,255,0.4)">
                        No bodies currently visible
                    </div>
                `}
            </div>
            
            <div style="background:var(--color-bg-elevated);border-radius:10px;padding:12px">
                <div style="font-size:14px;font-weight:600;margin-bottom:12px">üåç Planets</div>
                <div style="display:grid;grid-template-columns:repeat(2, 1fr);gap:8px">
                    ${['venus', 'mars', 'jupiter', 'saturn'].map(planet => {
                        const pos = CelestialModule.getPlanetPosition(planet, date);
                        return `
                            <div style="padding:8px;background:rgba(0,0,0,0.2);border-radius:6px">
                                <div style="font-size:11px;font-weight:600">${planet.charAt(0).toUpperCase() + planet.slice(1)}</div>
                                <div style="font-size:10px;color:rgba(255,255,255,0.5)">GHA: ${pos.formatted?.GHA || 'N/A'}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    }
    
    /**
     * Render Observe tab
     */
    function renderCelestialObserve(lat, lon, date) {
        const sightLog = CelestialModule.getSightLog();
        const currentObs = CelestialModule.getCurrentObservation();
        
        // Get camera sextant widget if module is available
        const cameraSextantWidget = (typeof CameraSextantModule !== 'undefined') 
            ? CameraSextantModule.renderWidget() 
            : '';
        
        return `
            ${cameraSextantWidget}
            
            <div style="background:var(--color-bg-elevated);border-radius:10px;padding:12px;margin-bottom:12px">
                <div style="font-size:14px;font-weight:600;margin-bottom:12px">üìù Manual Observation</div>
                
                ${currentObs ? `
                    <div style="padding:12px;background:rgba(59,130,246,0.1);border-radius:8px;margin-bottom:12px">
                        <div style="font-size:12px;color:#3b82f6;font-weight:600">Observation in Progress</div>
                        <div style="font-size:11px;margin-top:4px">Body: ${currentObs.bodyName}</div>
                        <div style="font-size:11px">Readings: ${currentObs.altitudes?.length || 0}</div>
                        <div style="display:flex;gap:8px;margin-top:8px">
                            <button id="celestial-complete-obs" class="btn btn--primary" style="flex:1;padding:8px">
                                ‚úì Complete
                            </button>
                            <button id="celestial-cancel-obs" class="btn btn--secondary" style="padding:8px">
                                ‚úó Cancel
                            </button>
                        </div>
                    </div>
                ` : `
                    <div style="margin-bottom:12px">
                        <label style="font-size:10px;color:rgba(255,255,255,0.5);display:block;margin-bottom:4px">Select Body</label>
                        <select id="celestial-body-select" style="width:100%;padding:8px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);border-radius:6px;color:white">
                            <option value="Sun">‚òÄÔ∏è Sun</option>
                            <option value="Moon">üåô Moon</option>
                            <optgroup label="Planets">
                                <option value="Venus">Venus</option>
                                <option value="Mars">Mars</option>
                                <option value="Jupiter">Jupiter</option>
                                <option value="Saturn">Saturn</option>
                            </optgroup>
                            <optgroup label="Stars">
                                ${Object.keys(CelestialModule.NAVIGATION_STARS).slice(0, 20).map(star => 
                                    `<option value="${star}">‚≠ê ${star}</option>`
                                ).join('')}
                            </optgroup>
                        </select>
                    </div>
                    
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">
                        <div>
                            <label style="font-size:10px;color:rgba(255,255,255,0.5);display:block;margin-bottom:4px">Altitude (¬∞)</label>
                            <input type="number" id="celestial-obs-alt-deg" placeholder="45" min="0" max="90"
                                   style="width:100%;padding:8px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);border-radius:6px;color:white">
                        </div>
                        <div>
                            <label style="font-size:10px;color:rgba(255,255,255,0.5);display:block;margin-bottom:4px">Minutes (')</label>
                            <input type="number" id="celestial-obs-alt-min" placeholder="30.0" min="0" max="59.9" step="0.1"
                                   style="width:100%;padding:8px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);border-radius:6px;color:white">
                        </div>
                    </div>
                    
                    <div style="margin-bottom:12px">
                        <label style="font-size:10px;color:rgba(255,255,255,0.5);display:block;margin-bottom:4px">Eye Height (m)</label>
                        <input type="number" id="celestial-eye-height" placeholder="3" min="0" step="0.1" value="3"
                               style="width:100%;padding:8px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);border-radius:6px;color:white">
                    </div>
                    
                    <button id="celestial-record-sight" class="btn btn--primary btn--full" style="padding:10px">
                        üìù Record Sight
                    </button>
                `}
            </div>
            
            <div style="background:var(--color-bg-elevated);border-radius:10px;padding:12px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                    <div style="font-size:14px;font-weight:600">üìã Sight Log (${sightLog.length})</div>
                    ${sightLog.length > 0 ? `
                        <button id="celestial-clear-log" class="btn btn--secondary" style="padding:4px 8px;font-size:10px">
                            üóëÔ∏è Clear
                        </button>
                    ` : ''}
                </div>
                
                ${sightLog.length > 0 ? `
                    <div style="display:flex;flex-direction:column;gap:8px;max-height:200px;overflow-y:auto">
                        ${sightLog.map((sight, i) => `
                            <div style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:rgba(0,0,0,0.2);border-radius:6px">
                                <div>
                                    <div style="font-size:12px;font-weight:600">${sight.bodyName}</div>
                                    <div style="font-size:10px;color:rgba(255,255,255,0.5)">
                                        Ho: ${CelestialModule.formatAngle(sight.Ho)}
                                    </div>
                                </div>
                                <div style="text-align:right;font-size:10px;color:rgba(255,255,255,0.5)">
                                    ${new Date(sight.time).toLocaleTimeString()}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : `
                    <div style="text-align:center;padding:20px;color:rgba(255,255,255,0.4)">
                        No sights recorded
                    </div>
                `}
            </div>
        `;
    }
    
    /**
     * Render Fix tab
     */
    function renderCelestialFix(lat, lon, date) {
        const sightLog = CelestialModule.getSightLog();
        const lops = CelestialModule.getLOPs();
        
        return `
            <div style="background:var(--color-bg-elevated);border-radius:10px;padding:12px;margin-bottom:12px">
                <div style="font-size:14px;font-weight:600;margin-bottom:12px">üìê Sight Reduction</div>
                
                ${sightLog.length === 0 ? `
                    <div style="padding:20px;text-align:center;color:rgba(255,255,255,0.4)">
                        <div style="font-size:24px;margin-bottom:8px">üî≠</div>
                        <div>No observations recorded</div>
                        <div style="font-size:11px;margin-top:4px">Go to Observe tab to take sights</div>
                    </div>
                ` : `
                    <div style="margin-bottom:12px">
                        <label style="font-size:10px;color:rgba(255,255,255,0.5);display:block;margin-bottom:4px">
                            Assumed Position for Reduction
                        </label>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                            <input type="number" id="celestial-ap-lat" placeholder="Lat" value="${lat.toFixed(2)}" step="0.01"
                                   style="width:100%;padding:8px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);border-radius:6px;color:white">
                            <input type="number" id="celestial-ap-lon" placeholder="Lon" value="${lon.toFixed(2)}" step="0.01"
                                   style="width:100%;padding:8px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);border-radius:6px;color:white">
                        </div>
                    </div>
                    
                    <button id="celestial-reduce-sights" class="btn btn--primary btn--full" style="padding:10px;margin-bottom:12px">
                        üìä Reduce All Sights
                    </button>
                `}
            </div>
            
            <div style="background:var(--color-bg-elevated);border-radius:10px;padding:12px;margin-bottom:12px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                    <div style="font-size:14px;font-weight:600">üìç Lines of Position (${lops.length})</div>
                    ${lops.length > 0 ? `
                        <button id="celestial-clear-lops" class="btn btn--secondary" style="padding:4px 8px;font-size:10px">
                            üóëÔ∏è Clear
                        </button>
                    ` : ''}
                </div>
                
                ${lops.length > 0 ? `
                    <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:12px">
                        ${lops.map((lop, i) => `
                            <div style="padding:8px;background:rgba(0,0,0,0.2);border-radius:6px">
                                <div style="display:flex;justify-content:space-between">
                                    <span style="font-size:12px;font-weight:600">${lop.bodyName}</span>
                                    <span style="font-size:10px;color:rgba(255,255,255,0.5)">Zn: ${lop.Zn.toFixed(1)}¬∞</span>
                                </div>
                                <div style="font-size:10px;color:rgba(255,255,255,0.5);margin-top:2px">
                                    Intercept: ${lop.intercept.toFixed(1)}' ${lop.intercept >= 0 ? 'Toward' : 'Away'}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    ${lops.length >= 2 ? `
                        <button id="celestial-calc-fix" class="btn btn--primary btn--full" style="padding:10px">
                            üìç Calculate Fix
                        </button>
                    ` : `
                        <div style="text-align:center;padding:8px;color:rgba(255,255,255,0.4);font-size:11px">
                            Need at least 2 LOPs for a fix
                        </div>
                    `}
                ` : `
                    <div style="text-align:center;padding:20px;color:rgba(255,255,255,0.4)">
                        No LOPs calculated
                    </div>
                `}
            </div>
            
            <div id="celestial-fix-result"></div>
            
            <!-- Emergency Methods -->
            <div style="background:var(--color-bg-elevated);border-radius:10px;padding:12px">
                <div style="font-size:14px;font-weight:600;margin-bottom:12px">üÜò Emergency Methods</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                    <button id="celestial-noon-sight" class="btn btn--secondary" style="padding:10px;font-size:11px">
                        ‚òÄÔ∏è Noon Sight
                    </button>
                    <button id="celestial-polaris" class="btn btn--secondary" style="padding:10px;font-size:11px">
                        ‚≠ê Polaris Lat
                    </button>
                </div>
            </div>
        `;
    }
    
    /**
     * Render Tools tab
     */
    function renderCelestialTools(lat, lon, date) {
        // Get Star ID widget if module is available
        const starIdWidget = (typeof StarIDModule !== 'undefined') 
            ? StarIDModule.renderWidget() 
            : '';
        
        // Get Star ID recommendations if module is available
        const starIdRecs = (typeof StarIDModule !== 'undefined') 
            ? StarIDModule.renderRecommendations() 
            : '';
        
        return `
            ${starIdWidget}
            
            <div style="background:var(--color-bg-elevated);border-radius:10px;padding:12px;margin-bottom:12px">
                ${CelestialModule.renderSunCompassWidget(lat, lon, date)}
            </div>
            
            <div style="background:var(--color-bg-elevated);border-radius:10px;padding:12px;margin-bottom:12px">
                ${CelestialModule.renderPolarisFinderWidget(lat, lon, date)}
            </div>
            
            <div style="background:var(--color-bg-elevated);border-radius:10px;padding:12px">
                ${CelestialModule.renderStarChartWidget(lat, lon, date)}
            </div>
        `;
    }
    
    /**
     * Render Dead Reckoning tab
     */
    function renderCelestialDR(lat, lon, date) {
        const drState = CelestialModule.getDRState();
        
        return `
            ${CelestialModule.renderDRStatusWidget()}
            
            <div style="margin-top:12px">
                ${CelestialModule.renderDRInputWidget(drState.course || 0, drState.speed || 0)}
            </div>
            
            <div style="margin-top:12px">
                ${CelestialModule.renderNavigationPlanWidget()}
            </div>
            
            ${!drState.lastFix ? `
                <div style="margin-top:12px;background:var(--color-bg-elevated);border-radius:10px;padding:12px">
                    <div style="font-size:14px;font-weight:600;margin-bottom:12px">üìç Initialize Position</div>
                    <p style="font-size:11px;color:rgba(255,255,255,0.6);margin-bottom:12px">
                        Start dead reckoning from your current position
                    </p>
                    <button id="celestial-init-dr" class="btn btn--primary btn--full" style="padding:10px">
                        üöÄ Initialize from Current Position
                    </button>
                </div>
            ` : ''}
        `;
    }
    
    /**
     * Render Training tab - primitive navigation methods
     */
    function renderCelestialTraining(lat, lon, date) {
        const solarNoon = CelestialModule.calculateSolarNoon(lon, date);
        const watchMethod = CelestialModule.calculateWatchMethod(date, lat);
        const horizon = CelestialModule.calculateHorizonDistance(6);  // 6 ft standing
        
        return `
            <div style="background:var(--color-bg-elevated);border-radius:10px;padding:12px;margin-bottom:12px">
                <div style="font-size:16px;font-weight:700;margin-bottom:8px">üéì Primitive Navigation</div>
                <p style="font-size:11px;color:rgba(255,255,255,0.6);margin-bottom:12px">
                    Learn to navigate without instruments using traditional methods
                </p>
            </div>
            
            <!-- Shadow Stick Method -->
            <div style="background:var(--color-bg-elevated);border-radius:10px;padding:12px;margin-bottom:12px">
                <div style="font-size:14px;font-weight:600;margin-bottom:8px">üåø Shadow Stick Method</div>
                <p style="font-size:11px;color:rgba(255,255,255,0.6);margin-bottom:12px">
                    Find East-West direction using the sun and a stick
                </p>
                <div style="background:rgba(0,0,0,0.2);border-radius:8px;padding:12px;margin-bottom:12px">
                    <ol style="font-size:11px;margin:0;padding-left:16px;color:rgba(255,255,255,0.8)">
                        <li style="margin-bottom:4px">Place a vertical stick in the ground</li>
                        <li style="margin-bottom:4px">Mark the shadow tip with a stone</li>
                        <li style="margin-bottom:4px">Wait 15-30 minutes</li>
                        <li style="margin-bottom:4px">Mark the new shadow tip</li>
                        <li style="margin-bottom:4px">Connect the marks: this is your East-West line</li>
                        <li>First mark = West, Second mark = East</li>
                    </ol>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;text-align:center;font-size:11px">
                    <div style="background:rgba(34,197,94,0.1);padding:8px;border-radius:6px">
                        <div style="color:#22c55e;font-weight:600">Best Time</div>
                        <div>15-30 min wait</div>
                    </div>
                    <div style="background:rgba(59,130,246,0.1);padding:8px;border-radius:6px">
                        <div style="color:#3b82f6;font-weight:600">Accuracy</div>
                        <div>¬±5¬∞ typical</div>
                    </div>
                </div>
            </div>
            
            <!-- Solar Noon -->
            <div style="background:var(--color-bg-elevated);border-radius:10px;padding:12px;margin-bottom:12px">
                <div style="font-size:14px;font-weight:600;margin-bottom:8px">‚òÄÔ∏è Solar Noon</div>
                <p style="font-size:11px;color:rgba(255,255,255,0.6);margin-bottom:12px">
                    At solar noon, shadows point true North (N. hemisphere)
                </p>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">
                    <div style="background:rgba(251,191,36,0.1);padding:10px;border-radius:6px;text-align:center">
                        <div style="font-size:10px;color:rgba(255,255,255,0.5)">Solar Noon Today</div>
                        <div style="font-size:18px;font-weight:700;color:#fbbf24">${solarNoon.formatted.time}</div>
                    </div>
                    <div style="background:rgba(0,0,0,0.2);padding:10px;border-radius:6px;text-align:center">
                        <div style="font-size:10px;color:rgba(255,255,255,0.5)">Equation of Time</div>
                        <div style="font-size:18px;font-weight:700">${solarNoon.formatted.EoT}</div>
                    </div>
                </div>
                <div style="font-size:10px;color:rgba(255,255,255,0.5);text-align:center">
                    For longitude ${lon.toFixed(1)}¬∞
                </div>
            </div>
            
            <!-- Watch Method -->
            <div style="background:var(--color-bg-elevated);border-radius:10px;padding:12px;margin-bottom:12px">
                <div style="font-size:14px;font-weight:600;margin-bottom:8px">‚åö Watch Method</div>
                <p style="font-size:11px;color:rgba(255,255,255,0.6);margin-bottom:12px">
                    Find direction using an analog watch
                </p>
                <div style="background:rgba(0,0,0,0.2);border-radius:8px;padding:12px;margin-bottom:12px">
                    ${lat >= 0 ? `
                        <div style="font-size:11px;color:rgba(255,255,255,0.8)">
                            <strong>Northern Hemisphere:</strong>
                            <ol style="margin:8px 0 0;padding-left:16px">
                                <li style="margin-bottom:4px">Point the hour hand at the sun</li>
                                <li style="margin-bottom:4px">Bisect angle between hour hand and 12</li>
                                <li>This line points South</li>
                            </ol>
                        </div>
                    ` : `
                        <div style="font-size:11px;color:rgba(255,255,255,0.8)">
                            <strong>Southern Hemisphere:</strong>
                            <ol style="margin:8px 0 0;padding-left:16px">
                                <li style="margin-bottom:4px">Point 12 o'clock at the sun</li>
                                <li style="margin-bottom:4px">Bisect angle between 12 and hour hand</li>
                                <li>This line points North</li>
                            </ol>
                        </div>
                    `}
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;text-align:center;font-size:11px">
                    <div style="background:rgba(0,0,0,0.2);padding:8px;border-radius:6px">
                        <div style="color:rgba(255,255,255,0.5)">Current Hour</div>
                        <div style="font-weight:600">${watchMethod.formatted.hourHand}</div>
                    </div>
                    <div style="background:rgba(34,197,94,0.1);padding:8px;border-radius:6px">
                        <div style="color:#22c55e">Points</div>
                        <div style="font-weight:600">${watchMethod.formatted.direction}</div>
                    </div>
                </div>
            </div>
            
            <!-- Hand Measurement -->
            <div style="background:var(--color-bg-elevated);border-radius:10px;padding:12px;margin-bottom:12px">
                <div style="font-size:14px;font-weight:600;margin-bottom:8px">‚úã Hand Measurement</div>
                <p style="font-size:11px;color:rgba(255,255,255,0.6);margin-bottom:12px">
                    Measure angles using your hand at arm's length
                </p>
                <div style="display:grid;grid-template-columns:repeat(4, 1fr);gap:8px;text-align:center;margin-bottom:12px">
                    <div style="background:rgba(0,0,0,0.2);padding:8px;border-radius:6px">
                        <div style="font-size:16px">üëÜ</div>
                        <div style="font-size:10px">1 finger</div>
                        <div style="font-size:12px;font-weight:600">2¬∞</div>
                    </div>
                    <div style="background:rgba(0,0,0,0.2);padding:8px;border-radius:6px">
                        <div style="font-size:16px">ü§ü</div>
                        <div style="font-size:10px">3 fingers</div>
                        <div style="font-size:12px;font-weight:600">5¬∞</div>
                    </div>
                    <div style="background:rgba(0,0,0,0.2);padding:8px;border-radius:6px">
                        <div style="font-size:16px">‚úä</div>
                        <div style="font-size:10px">Fist</div>
                        <div style="font-size:12px;font-weight:600">10¬∞</div>
                    </div>
                    <div style="background:rgba(0,0,0,0.2);padding:8px;border-radius:6px">
                        <div style="font-size:16px">ü§ô</div>
                        <div style="font-size:10px">Span</div>
                        <div style="font-size:12px;font-weight:600">20¬∞</div>
                    </div>
                </div>
                <div style="background:rgba(59,130,246,0.1);padding:10px;border-radius:6px;font-size:11px;text-align:center">
                    <strong>Polaris Altitude ‚âà Your Latitude</strong><br>
                    Count fists from horizon to Polaris
                </div>
            </div>
            
            <!-- Horizon Distance -->
            <div style="background:var(--color-bg-elevated);border-radius:10px;padding:12px">
                <div style="font-size:14px;font-weight:600;margin-bottom:8px">üëÅÔ∏è Horizon Distance</div>
                <p style="font-size:11px;color:rgba(255,255,255,0.6);margin-bottom:12px">
                    How far can you see to the horizon?
                </p>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">
                    <div style="background:rgba(0,0,0,0.2);padding:10px;border-radius:6px;text-align:center">
                        <div style="font-size:10px;color:rgba(255,255,255,0.5)">Standing (6 ft)</div>
                        <div style="font-size:16px;font-weight:700">${horizon.formatted.distance}</div>
                        <div style="font-size:10px;color:rgba(255,255,255,0.5)">${horizon.formatted.distanceKm}</div>
                    </div>
                    <div style="background:rgba(0,0,0,0.2);padding:10px;border-radius:6px;text-align:center">
                        <div style="font-size:10px;color:rgba(255,255,255,0.5)">Mast (20 ft)</div>
                        <div style="font-size:16px;font-weight:700">5.2 nm</div>
                        <div style="font-size:10px;color:rgba(255,255,255,0.5)">9.7 km</div>
                    </div>
                </div>
                <div style="font-size:10px;color:rgba(255,255,255,0.5);text-align:center">
                    Formula: 1.17 √ó ‚àö(height in feet) = nautical miles
                </div>
            </div>
        `;
    }
    
    /**
     * Render Inertial Navigation tab (Phase 8)
     */
    function renderCelestialInertial(lat, lon, date) {
        const state = CelestialModule.getInertialState();
        const sensors = CelestialModule.checkSensorAvailability();
        
        return `
            <div style="background:var(--color-bg-elevated);border-radius:10px;padding:12px;margin-bottom:12px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                    <div style="font-size:16px;font-weight:700">üì± Inertial Navigation</div>
                    <div style="padding:4px 8px;border-radius:4px;font-size:10px;background:${state.isTracking ? 'rgba(34,197,94,0.2)' : 'rgba(239,68,68,0.2)'};color:${state.isTracking ? '#22c55e' : '#ef4444'}">
                        ${state.isTracking ? '‚óè TRACKING' : '‚óã STOPPED'}
                    </div>
                </div>
                <p style="font-size:11px;color:rgba(255,255,255,0.6);margin-bottom:12px">
                    GPS-denied navigation using device sensors (accelerometer, gyroscope, magnetometer)
                </p>
                
                <!-- Sensor Status -->
                <div style="display:flex;gap:8px;margin-bottom:12px">
                    <div style="flex:1;padding:8px;background:rgba(0,0,0,0.2);border-radius:6px;text-align:center">
                        <div style="font-size:16px;opacity:${sensors.accelerometer ? 1 : 0.3}">üì±</div>
                        <div style="font-size:9px;color:rgba(255,255,255,0.6)">Accelerometer</div>
                        <div style="font-size:8px;color:${sensors.accelerometer ? '#22c55e' : '#ef4444'}">${sensors.accelerometer ? 'Available' : 'N/A'}</div>
                    </div>
                    <div style="flex:1;padding:8px;background:rgba(0,0,0,0.2);border-radius:6px;text-align:center">
                        <div style="font-size:16px;opacity:${sensors.gyroscope ? 1 : 0.3}">üîÑ</div>
                        <div style="font-size:9px;color:rgba(255,255,255,0.6)">Gyroscope</div>
                        <div style="font-size:8px;color:${sensors.gyroscope || state.sensorsAvailable.gyroscope ? '#22c55e' : '#f59e0b'}">${sensors.gyroscope || state.sensorsAvailable.gyroscope ? 'Available' : 'Check'}</div>
                    </div>
                    <div style="flex:1;padding:8px;background:rgba(0,0,0,0.2);border-radius:6px;text-align:center">
                        <div style="font-size:16px;opacity:${sensors.magnetometer ? 1 : 0.3}">üß≠</div>
                        <div style="font-size:9px;color:rgba(255,255,255,0.6)">Magnetometer</div>
                        <div style="font-size:8px;color:${sensors.magnetometer ? '#22c55e' : '#f59e0b'}">${sensors.magnetometer ? 'Available' : 'Check'}</div>
                    </div>
                </div>
            </div>
            
            ${state.isTracking ? `
                <!-- Current Status -->
                <div style="background:var(--color-bg-elevated);border-radius:10px;padding:12px;margin-bottom:12px">
                    <div style="font-size:14px;font-weight:600;margin-bottom:12px">üìç Current Position</div>
                    
                    <div style="background:rgba(0,0,0,0.3);border-radius:8px;padding:12px;margin-bottom:12px">
                        <div style="font-size:12px;font-weight:600;text-align:center;margin-bottom:4px">
                            ${state.formatted.position}
                        </div>
                        <div style="font-size:10px;color:rgba(255,255,255,0.5);text-align:center">
                            Relative: ${state.formatted.relativePosition}
                        </div>
                    </div>
                    
                    <div style="display:grid;grid-template-columns:repeat(3, 1fr);gap:8px;margin-bottom:12px">
                        <div style="text-align:center;padding:10px;background:rgba(59,130,246,0.1);border-radius:6px">
                            <div style="font-size:20px;font-weight:700;color:#3b82f6">${state.heading.toFixed(0)}¬∞</div>
                            <div style="font-size:9px;color:rgba(255,255,255,0.5)">Heading</div>
                            <div style="font-size:8px;color:rgba(255,255,255,0.4)">${state.headingSource}</div>
                        </div>
                        <div style="text-align:center;padding:10px;background:rgba(34,197,94,0.1);border-radius:6px">
                            <div style="font-size:20px;font-weight:700;color:#22c55e">${state.formatted.speed}</div>
                            <div style="font-size:9px;color:rgba(255,255,255,0.5)">Speed</div>
                        </div>
                        <div style="text-align:center;padding:10px;background:rgba(251,191,36,0.1);border-radius:6px">
                            <div style="font-size:20px;font-weight:700;color:#fbbf24">${state.stepCount}</div>
                            <div style="font-size:9px;color:rgba(255,255,255,0.5)">Steps</div>
                        </div>
                    </div>
                    
                    <div style="display:grid;grid-template-columns:repeat(2, 1fr);gap:8px;margin-bottom:12px">
                        <div style="text-align:center;padding:10px;background:rgba(0,0,0,0.2);border-radius:6px">
                            <div style="font-size:16px;font-weight:600">${state.formatted.distance}</div>
                            <div style="font-size:9px;color:rgba(255,255,255,0.5)">Total Distance</div>
                        </div>
                        <div style="text-align:center;padding:10px;background:rgba(0,0,0,0.2);border-radius:6px">
                            <div style="font-size:16px;font-weight:600">${state.formatted.duration}</div>
                            <div style="font-size:9px;color:rgba(255,255,255,0.5)">Duration</div>
                        </div>
                    </div>
                    
                    <!-- Confidence Bar -->
                    <div style="margin-bottom:12px">
                        <div style="display:flex;justify-content:space-between;font-size:10px;margin-bottom:4px">
                            <span style="color:rgba(255,255,255,0.5)">Position Confidence</span>
                            <span>${state.formatted.confidence} (${state.formatted.drift})</span>
                        </div>
                        <div style="height:8px;background:rgba(0,0,0,0.3);border-radius:4px;overflow:hidden">
                            <div style="height:100%;width:${state.confidence * 100}%;background:${state.confidence > 0.5 ? '#22c55e' : state.confidence > 0.25 ? '#f59e0b' : '#ef4444'};border-radius:4px;transition:width 0.3s"></div>
                        </div>
                        <div style="font-size:9px;color:rgba(255,255,255,0.4);margin-top:4px;text-align:center">
                            Confidence degrades with distance traveled. Update with a known fix to reset.
                        </div>
                    </div>
                    
                    <!-- Controls -->
                    <div style="display:flex;gap:8px">
                        <button id="inertial-zupt" class="btn btn--secondary" style="flex:1;padding:10px;font-size:11px">
                            ‚è∏Ô∏è ZUPT (Stopped)
                        </button>
                        <button id="inertial-stop" class="btn btn--secondary" style="flex:1;padding:10px;font-size:11px;color:#ef4444;border-color:#ef4444">
                            ‚èπÔ∏è Stop Tracking
                        </button>
                    </div>
                </div>
                
                <!-- Update Fix -->
                <div style="background:var(--color-bg-elevated);border-radius:10px;padding:12px;margin-bottom:12px">
                    <div style="font-size:14px;font-weight:600;margin-bottom:8px">üéØ Update with Known Fix</div>
                    <p style="font-size:10px;color:rgba(255,255,255,0.5);margin-bottom:12px">
                        Apply a known position (from GPS, celestial fix, or landmark) to reset drift
                    </p>
                    <button id="inertial-update-from-map" class="btn btn--primary btn--full" style="padding:10px">
                        üìç Use Current Map Position
                    </button>
                </div>
            ` : `
                <!-- Not Tracking -->
                <div style="background:var(--color-bg-elevated);border-radius:10px;padding:12px;margin-bottom:12px">
                    <div style="font-size:14px;font-weight:600;margin-bottom:12px">‚ñ∂Ô∏è Start Tracking</div>
                    
                    <p style="font-size:11px;color:rgba(255,255,255,0.6);margin-bottom:12px">
                        Initialize inertial navigation to track your position using device motion sensors.
                        Works without GPS in tunnels, buildings, and during signal jamming.
                    </p>
                    
                    <div style="background:rgba(0,0,0,0.2);border-radius:8px;padding:12px;margin-bottom:12px">
                        <div style="font-size:11px;font-weight:600;margin-bottom:8px">Starting Position</div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                            <div>
                                <label style="font-size:9px;color:rgba(255,255,255,0.4)">Latitude</label>
                                <input type="number" id="inertial-start-lat" value="${lat.toFixed(5)}" step="0.00001"
                                       style="width:100%;padding:6px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);border-radius:4px;color:white;font-size:11px">
                            </div>
                            <div>
                                <label style="font-size:9px;color:rgba(255,255,255,0.4)">Longitude</label>
                                <input type="number" id="inertial-start-lon" value="${lon.toFixed(5)}" step="0.00001"
                                       style="width:100%;padding:6px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);border-radius:4px;color:white;font-size:11px">
                            </div>
                        </div>
                        <button id="inertial-sync-start" class="btn btn--secondary btn--full" style="margin-top:8px;padding:6px;font-size:10px">
                            üìç Sync from Map
                        </button>
                    </div>
                    
                    <button id="inertial-start" class="btn btn--primary btn--full" style="padding:12px;font-size:14px">
                        ‚ñ∂Ô∏è Start Inertial Tracking
                    </button>
                </div>
            `}
            
            <!-- Calibration -->
            <div style="background:var(--color-bg-elevated);border-radius:10px;padding:12px;margin-bottom:12px">
                <div style="font-size:14px;font-weight:600;margin-bottom:12px">‚öôÔ∏è Calibration</div>
                
                <!-- Step Length -->
                <div style="margin-bottom:12px">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                        <div>
                            <div style="font-size:11px;font-weight:600">Step Length</div>
                            <div style="font-size:10px;color:rgba(255,255,255,0.5)">Current: ${(state.stepLength * 100).toFixed(0)} cm</div>
                        </div>
                        <div style="padding:4px 8px;border-radius:4px;font-size:9px;background:${state.isCalibrated !== false ? 'rgba(34,197,94,0.2)' : 'rgba(251,191,36,0.2)'};color:${state.isCalibrated !== false ? '#22c55e' : '#f59e0b'}">
                            ${state.isCalibrated !== false ? '‚úì Calibrated' : 'Default'}
                        </div>
                    </div>
                    <div style="display:flex;gap:8px">
                        <input type="number" id="calibration-distance" placeholder="Known distance (m)" min="5" step="1"
                               style="flex:1;padding:8px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);border-radius:6px;color:white;font-size:11px">
                        <button id="calibrate-step-btn" class="btn btn--secondary" style="padding:8px 12px;font-size:11px">
                            Calibrate
                        </button>
                    </div>
                    <div style="font-size:9px;color:rgba(255,255,255,0.4);margin-top:4px">
                        Walk a known distance, then enter it. Need ${state.stepCount < 10 ? (10 - state.stepCount) + ' more' : '‚úì'} steps.
                    </div>
                </div>
                
                <!-- Gyro Calibration -->
                <div style="border-top:1px solid rgba(255,255,255,0.1);padding-top:12px">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                        <div style="font-size:11px;font-weight:600">Gyroscope Bias</div>
                        <div style="font-size:9px;color:rgba(255,255,255,0.5)">
                            ${state.sensorsAvailable?.gyroscope ? (state.calibrationData?.gyroCalibrated ? '‚úì Calibrated' : 'Not calibrated') : 'N/A'}
                        </div>
                    </div>
                    <button id="calibrate-gyro-btn" class="btn btn--secondary btn--full" style="padding:8px;font-size:11px" ${!state.sensorsAvailable?.gyroscope ? 'disabled' : ''}>
                        üîÑ Calibrate Gyro (hold device still for 5s)
                    </button>
                </div>
            </div>
            
            <!-- How It Works -->
            <div style="background:var(--color-bg-elevated);border-radius:10px;padding:12px">
                <div style="font-size:14px;font-weight:600;margin-bottom:8px">‚ÑπÔ∏è How It Works</div>
                <div style="font-size:10px;color:rgba(255,255,255,0.6);line-height:1.5">
                    <p style="margin-bottom:8px">
                        <strong>Pedestrian Dead Reckoning (PDR)</strong> tracks your position by detecting footsteps and measuring heading changes.
                    </p>
                    <ul style="margin:0;padding-left:16px">
                        <li style="margin-bottom:4px"><strong>Accelerometer:</strong> Detects footsteps</li>
                        <li style="margin-bottom:4px"><strong>Gyroscope:</strong> Tracks heading changes (magnetic-free)</li>
                        <li style="margin-bottom:4px"><strong>Magnetometer:</strong> Provides absolute heading reference</li>
                        <li style="margin-bottom:4px"><strong>ZUPT:</strong> Zero Velocity Update when stopped reduces drift</li>
                    </ul>
                    <p style="margin-top:8px;color:rgba(255,255,255,0.4)">
                        Accuracy: ~2-5% of distance traveled. Update with known fixes to reset drift.
                    </p>
                </div>
            </div>
        `;
    }
    
    /**
     * Bind celestial panel events
     */
    function bindCelestialEvents() {
        // Tab switching
        container.querySelectorAll('.celestial-tab').forEach(btn => {
            btn.onclick = () => {
                celestialState.activeTab = btn.dataset.tab;
                renderCelestial();
            };
        });
        
        // Sync position from map
        const syncBtn = container.querySelector('#celestial-sync-pos');
        if (syncBtn) {
            syncBtn.onclick = () => {
                if (typeof MapModule !== 'undefined') {
                    const mapState = MapModule.getMapState();
                    if (mapState) {
                        celestialState.observerLat = mapState.lat;
                        celestialState.observerLon = mapState.lon;
                        renderCelestial();
                    }
                }
            };
        }
        
        // Position input changes
        const latInput = container.querySelector('#celestial-lat');
        const lonInput = container.querySelector('#celestial-lon');
        if (latInput) {
            latInput.onchange = () => {
                celestialState.observerLat = parseFloat(latInput.value);
            };
        }
        if (lonInput) {
            lonInput.onchange = () => {
                celestialState.observerLon = parseFloat(lonInput.value);
            };
        }
        
        // Record sight button
        const recordBtn = container.querySelector('#celestial-record-sight');
        if (recordBtn) {
            recordBtn.onclick = () => {
                const body = container.querySelector('#celestial-body-select')?.value;
                const altDeg = parseFloat(container.querySelector('#celestial-obs-alt-deg')?.value) || 0;
                const altMin = parseFloat(container.querySelector('#celestial-obs-alt-min')?.value) || 0;
                const eyeHeight = parseFloat(container.querySelector('#celestial-eye-height')?.value) || 3;
                
                if (!body) {
                    alert('Please select a celestial body');
                    return;
                }
                
                const Hs = altDeg + altMin / 60;
                const date = new Date();
                
                // Start and complete observation in one step for manual entry
                CelestialModule.startObservation(body, { eyeHeight });
                CelestialModule.recordSight(Hs);
                CelestialModule.completeObservation();
                
                renderCelestial();
            };
        }
        
        // Complete/Cancel observation
        const completeBtn = container.querySelector('#celestial-complete-obs');
        if (completeBtn) {
            completeBtn.onclick = () => {
                CelestialModule.completeObservation();
                renderCelestial();
            };
        }
        
        const cancelBtn = container.querySelector('#celestial-cancel-obs');
        if (cancelBtn) {
            cancelBtn.onclick = () => {
                CelestialModule.cancelObservation();
                renderCelestial();
            };
        }
        
        // Clear sight log
        const clearLogBtn = container.querySelector('#celestial-clear-log');
        if (clearLogBtn) {
            clearLogBtn.onclick = () => {
                if (confirm('Clear all recorded sights?')) {
                    CelestialModule.clearSightLog();
                    renderCelestial();
                }
            };
        }
        
        // Reduce sights
        const reduceBtn = container.querySelector('#celestial-reduce-sights');
        if (reduceBtn) {
            reduceBtn.onclick = () => {
                const apLat = parseFloat(container.querySelector('#celestial-ap-lat')?.value) || celestialState.observerLat;
                const apLon = parseFloat(container.querySelector('#celestial-ap-lon')?.value) || celestialState.observerLon;
                
                const results = CelestialModule.reduceAllSights(apLat, apLon);
                
                if (results.length === 0) {
                    alert('No sights to reduce');
                    return;
                }
                
                // Store LOPs
                results.forEach(r => {
                    if (!r.error) {
                        CelestialModule.storeLOP(r);
                    }
                });
                
                renderCelestial();
            };
        }
        
        // Clear LOPs
        const clearLopsBtn = container.querySelector('#celestial-clear-lops');
        if (clearLopsBtn) {
            clearLopsBtn.onclick = () => {
                if (confirm('Clear all Lines of Position?')) {
                    CelestialModule.clearLOPs();
                    renderCelestial();
                }
            };
        }
        
        // Calculate fix
        const calcFixBtn = container.querySelector('#celestial-calc-fix');
        if (calcFixBtn) {
            calcFixBtn.onclick = () => {
                const lops = CelestialModule.getLOPs();
                if (lops.length < 2) {
                    alert('Need at least 2 LOPs');
                    return;
                }
                
                const fix = CelestialModule.calculateLOPIntersection(lops[0], lops[1]);
                
                const resultDiv = container.querySelector('#celestial-fix-result');
                if (resultDiv && fix && !fix.error) {
                    resultDiv.innerHTML = `
                        <div style="background:rgba(34,197,94,0.1);border-radius:10px;padding:12px;margin-bottom:12px">
                            <div style="font-size:14px;font-weight:600;color:#22c55e;margin-bottom:8px">üìç Fix Calculated!</div>
                            <div style="font-size:16px;font-weight:700">
                                ${CelestialModule.formatAngle(fix.lat, true)}, ${CelestialModule.formatAngle(Math.abs(fix.lon))}${fix.lon >= 0 ? 'E' : 'W'}
                            </div>
                            <div style="font-size:11px;color:rgba(255,255,255,0.5);margin-top:4px">
                                Angle: ${fix.angle?.toFixed(1) || 'N/A'}¬∞
                            </div>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div style="background:rgba(239,68,68,0.1);border-radius:10px;padding:12px;margin-bottom:12px">
                            <div style="color:#ef4444">Fix calculation failed: ${fix?.error || 'Unknown error'}</div>
                        </div>
                    `;
                }
            };
        }
        
        // Initialize DR
        const initDRBtn = container.querySelector('#celestial-init-dr');
        if (initDRBtn) {
            initDRBtn.onclick = () => {
                const lat = celestialState.observerLat || 37.7749;
                const lon = celestialState.observerLon || -122.4194;
                
                CelestialModule.initializeDR(
                    { lat, lon }, 
                    new Date(), 
                    'manual', 
                    { course: 0, speed: 0 }
                );
                
                renderCelestial();
            };
        }
        
        // DR course/speed apply
        const applyCSBtn = container.querySelector('.dr-apply-cs');
        if (applyCSBtn) {
            applyCSBtn.onclick = () => {
                const course = parseFloat(container.querySelector('#dr-course')?.value) || 0;
                const speed = parseFloat(container.querySelector('#dr-speed')?.value) || 0;
                
                CelestialModule.updateCourseSpeed(course, speed);
                renderCelestial();
            };
        }
        
        // Quick course buttons
        container.querySelectorAll('.dr-quick-course').forEach(btn => {
            btn.onclick = () => {
                const courseInput = container.querySelector('#dr-course');
                if (courseInput) {
                    courseInput.value = btn.dataset.course;
                }
            };
        });
        
        // ETA calculation
        const etaBtn = container.querySelector('.calculate-eta-btn');
        if (etaBtn) {
            etaBtn.onclick = () => {
                const wpLat = parseFloat(container.querySelector('#wp-lat')?.value);
                const wpLon = parseFloat(container.querySelector('#wp-lon')?.value);
                
                if (isNaN(wpLat) || isNaN(wpLon)) {
                    alert('Please enter waypoint coordinates');
                    return;
                }
                
                const eta = CelestialModule.calculateETA({ lat: wpLat, lon: wpLon });
                
                const resultDiv = container.querySelector('#eta-result');
                if (resultDiv) {
                    resultDiv.style.display = 'block';
                    resultDiv.innerHTML = CelestialModule.renderETAResult(eta);
                }
            };
        }
        
        // Emergency methods
        const noonSightBtn = container.querySelector('#celestial-noon-sight');
        if (noonSightBtn) {
            noonSightBtn.onclick = () => {
                const lon = celestialState.observerLon || -122;
                const passage = CelestialModule.calculateMeridianPassage(lon, new Date());
                
                alert(`Meridian Passage at ${lon.toFixed(1)}¬∞:\n\n` +
                      `Time: ${passage.formatted.timeUTC}\n` +
                      `EoT: ${passage.EoT.toFixed(1)} min\n` +
                      `Sun Dec: ${passage.formatted.sunDec}\n\n` +
                      `At this time, measure sun's maximum altitude.\n` +
                      `Latitude = 90¬∞ - altitude + declination`);
            };
        }
        
        const polarisBtn = container.querySelector('#celestial-polaris');
        if (polarisBtn) {
            polarisBtn.onclick = () => {
                const lat = celestialState.observerLat || 37;
                const lon = celestialState.observerLon || -122;
                
                if (lat < 0) {
                    alert('Polaris is not visible from the Southern Hemisphere.\n\nUse the Southern Cross instead.');
                    return;
                }
                
                const finder = CelestialModule.calculatePolarisFinder(lat, lon, new Date());
                
                alert(`Polaris Finder:\n\n` +
                      `Current Polaris Altitude: ${finder.formatted.polarisAlt}\n` +
                      `Look toward: ${finder.formatted.polarisAz}\n\n` +
                      `Your latitude ‚âà Polaris altitude\n\n` +
                      `How to find:\n` +
                      finder.instructions.slice(0, 4).join('\n'));
            };
        }
        
        // ===== Inertial Navigation Events =====
        
        // Start inertial tracking
        const inertialStartBtn = container.querySelector('#inertial-start');
        if (inertialStartBtn) {
            inertialStartBtn.onclick = async () => {
                const startLat = parseFloat(container.querySelector('#inertial-start-lat')?.value) || celestialState.observerLat || 37;
                const startLon = parseFloat(container.querySelector('#inertial-start-lon')?.value) || celestialState.observerLon || -122;
                
                const initResult = await CelestialModule.initInertialNav({
                    startPosition: { lat: startLat, lon: startLon },
                    magneticDeclination: celestialState.magneticDeclination || 0
                });
                
                if (!initResult.success) {
                    alert('Failed to initialize inertial nav: ' + initResult.error);
                    return;
                }
                
                const startResult = CelestialModule.startInertialTracking();
                if (startResult.success) {
                    renderCelestial();
                } else {
                    alert('Failed to start tracking: ' + startResult.error);
                }
            };
        }
        
        // Sync start position from map
        const inertialSyncStartBtn = container.querySelector('#inertial-sync-start');
        if (inertialSyncStartBtn) {
            inertialSyncStartBtn.onclick = () => {
                if (typeof MapModule !== 'undefined') {
                    const mapState = MapModule.getMapState();
                    if (mapState && mapState.lat !== undefined) {
                        const latInput = container.querySelector('#inertial-start-lat');
                        const lonInput = container.querySelector('#inertial-start-lon');
                        if (latInput) latInput.value = mapState.lat.toFixed(5);
                        if (lonInput) lonInput.value = mapState.lon.toFixed(5);
                    }
                }
            };
        }
        
        // Stop inertial tracking
        const inertialStopBtn = container.querySelector('#inertial-stop');
        if (inertialStopBtn) {
            inertialStopBtn.onclick = () => {
                const result = CelestialModule.stopInertialTracking();
                if (result.success) {
                    alert(`Tracking stopped.\n\n` +
                          `Steps: ${result.summary.stepCount}\n` +
                          `Distance: ${result.summary.totalDistance.toFixed(0)} m\n` +
                          `Duration: ${(result.summary.duration / 60).toFixed(1)} min`);
                }
                renderCelestial();
            };
        }
        
        // ZUPT (Zero Velocity Update)
        const zuptBtn = container.querySelector('#inertial-zupt');
        if (zuptBtn) {
            zuptBtn.onclick = () => {
                const result = CelestialModule.performZUPT();
                if (result.success) {
                    renderCelestial();
                }
            };
        }
        
        // Update from map position
        const updateFromMapBtn = container.querySelector('#inertial-update-from-map');
        if (updateFromMapBtn) {
            updateFromMapBtn.onclick = () => {
                if (typeof MapModule !== 'undefined') {
                    const mapState = MapModule.getMapState();
                    if (mapState && mapState.lat !== undefined) {
                        const result = CelestialModule.updateInertialFix(
                            { lat: mapState.lat, lon: mapState.lon },
                            'map'
                        );
                        if (result.success) {
                            alert(`Position updated!\n\nError from DR: ${result.formatted.error}`);
                            renderCelestial();
                        }
                    }
                }
            };
        }
        
        // Calibrate step length
        const calibrateStepBtn = container.querySelector('#calibrate-step-btn');
        if (calibrateStepBtn) {
            calibrateStepBtn.onclick = () => {
                const distance = parseFloat(container.querySelector('#calibration-distance')?.value);
                
                if (isNaN(distance) || distance < 5) {
                    alert('Please enter a distance of at least 5 meters');
                    return;
                }
                
                const result = CelestialModule.calibrateStepLength(distance);
                
                if (result.success) {
                    alert(`Step length calibrated!\n\nNew step length: ${result.formatted.stepLength}`);
                    renderCelestial();
                } else {
                    alert('Calibration failed: ' + result.error);
                }
            };
        }
        
        // Calibrate gyroscope
        const calibrateGyroBtn = container.querySelector('#calibrate-gyro-btn');
        if (calibrateGyroBtn) {
            calibrateGyroBtn.onclick = async () => {
                calibrateGyroBtn.disabled = true;
                calibrateGyroBtn.textContent = 'üîÑ Calibrating... Hold still!';
                
                const result = await CelestialModule.calibrateGyroBias(5);
                
                if (result.success) {
                    alert(`Gyroscope calibrated!\n\nBias: ${result.formatted.bias}`);
                } else {
                    alert('Calibration failed: ' + result.error);
                }
                
                renderCelestial();
            };
        }
        
        // ===== Camera Sextant Events (Phase 8c) =====
        bindCameraSextantEvents();
        
        // ===== Star ID Events (Phase 8e) =====
        bindStarIDEvents();
    }
    
    /**
     * Bind Star ID events
     */
    function bindStarIDEvents() {
        if (typeof StarIDModule === 'undefined') return;
        
        // Track star ID state
        let starIdActive = false;
        let selectedObject = null;
        
        // Update info display periodically
        let updateInterval = null;
        
        // Start star ID
        const startBtn = container.querySelector('#star-id-start');
        if (startBtn) {
            startBtn.onclick = async () => {
                const videoElement = container.querySelector('#star-id-video');
                const canvasElement = container.querySelector('#star-id-canvas');
                const containerEl = container.querySelector('#star-id-container');
                const activeControls = container.querySelector('#star-id-active-controls');
                
                if (!videoElement || !canvasElement) return;
                
                // Show loading state
                startBtn.disabled = true;
                startBtn.innerHTML = '‚è≥ Starting...';
                
                // Get observer position
                const lat = celestialState.observerLat || 37.7749;
                const lon = celestialState.observerLon || -122.4194;
                
                try {
                    const result = await StarIDModule.startSession(videoElement, canvasElement, {
                        lat: lat,
                        lon: lon,
                        onSelectionChange: (obj) => {
                            selectedObject = obj;
                            updateSelectionDisplay(obj);
                        },
                        onError: (error) => {
                            console.error('Star ID error:', error);
                        }
                    });
                    
                    if (result.success) {
                        starIdActive = true;
                        
                        // Resize canvas to match video
                        videoElement.onloadedmetadata = () => {
                            canvasElement.width = videoElement.videoWidth || 640;
                            canvasElement.height = videoElement.videoHeight || 480;
                        };
                        
                        // Show UI
                        containerEl.style.display = 'block';
                        startBtn.style.display = 'none';
                        activeControls.style.display = 'block';
                        
                        // Start update interval
                        updateInterval = setInterval(() => {
                            const state = StarIDModule.getState();
                            const pointingEl = container.querySelector('#star-id-pointing');
                            const countEl = container.querySelector('#star-id-count');
                            
                            if (pointingEl) {
                                pointingEl.textContent = `Az ${state.cameraAzimuth.toFixed(0)}¬∞ Alt ${state.cameraAltitude.toFixed(0)}¬∞`;
                            }
                            if (countEl) {
                                countEl.textContent = state.identifiedCount.toString();
                            }
                        }, 500);
                        
                    } else {
                        alert('Failed to start Star ID: ' + result.error);
                        startBtn.disabled = false;
                        startBtn.innerHTML = 'üî≠ Start Star ID';
                    }
                } catch (e) {
                    alert('Error: ' + e.message);
                    startBtn.disabled = false;
                    startBtn.innerHTML = 'üî≠ Start Star ID';
                }
            };
        }
        
        // Stop star ID
        const stopBtn = container.querySelector('#star-id-stop');
        if (stopBtn) {
            stopBtn.onclick = () => {
                StarIDModule.stopSession();
                starIdActive = false;
                
                if (updateInterval) {
                    clearInterval(updateInterval);
                    updateInterval = null;
                }
                
                // Hide UI
                const containerEl = container.querySelector('#star-id-container');
                const startBtnRef = container.querySelector('#star-id-start');
                const activeControls = container.querySelector('#star-id-active-controls');
                const selectionDiv = container.querySelector('#star-id-selection');
                
                if (containerEl) containerEl.style.display = 'none';
                if (startBtnRef) {
                    startBtnRef.style.display = 'block';
                    startBtnRef.disabled = false;
                    startBtnRef.innerHTML = 'üî≠ Start Star ID';
                }
                if (activeControls) activeControls.style.display = 'none';
                if (selectionDiv) selectionDiv.style.display = 'none';
            };
        }
        
        // Refresh recommendations
        const refreshRecsBtn = container.querySelector('#star-id-refresh-recs');
        if (refreshRecsBtn) {
            refreshRecsBtn.onclick = () => {
                // Update observer position
                StarIDModule.setObserverPosition(
                    celestialState.observerLat || 37.7749,
                    celestialState.observerLon || -122.4194
                );
                
                const recsDiv = container.querySelector('#star-id-recommendations');
                if (recsDiv) {
                    recsDiv.innerHTML = StarIDModule.renderRecommendations();
                    bindRecommendationClicks();
                }
            };
            
            // Initial load of recommendations
            setTimeout(() => {
                const recsDiv = container.querySelector('#star-id-recommendations');
                if (recsDiv) {
                    StarIDModule.setObserverPosition(
                        celestialState.observerLat || 37.7749,
                        celestialState.observerLon || -122.4194
                    );
                    recsDiv.innerHTML = StarIDModule.renderRecommendations();
                    bindRecommendationClicks();
                }
            }, 100);
        }
        
        // Bind recommendation clicks
        function bindRecommendationClicks() {
            container.querySelectorAll('.star-id-rec-item').forEach(item => {
                item.onclick = () => {
                    const name = item.dataset.name;
                    selectedObject = { name };
                    updateSelectionDisplay(selectedObject);
                };
            });
        }
        
        // Update selection display
        function updateSelectionDisplay(obj) {
            const selectionDiv = container.querySelector('#star-id-selection');
            const nameEl = container.querySelector('#star-id-selected-name');
            const infoEl = container.querySelector('#star-id-selected-info');
            
            if (obj) {
                if (selectionDiv) selectionDiv.style.display = 'block';
                if (nameEl) nameEl.textContent = obj.name;
                if (infoEl) {
                    let info = [];
                    if (obj.altitude !== undefined) info.push(`Alt: ${obj.altitude.toFixed(1)}¬∞`);
                    if (obj.azimuth !== undefined) info.push(`Az: ${obj.azimuth.toFixed(1)}¬∞`);
                    if (obj.magnitude !== undefined) info.push(`Mag: ${obj.magnitude.toFixed(1)}`);
                    if (obj.constellation) info.push(obj.constellation);
                    infoEl.textContent = info.join(' | ');
                }
            } else {
                if (selectionDiv) selectionDiv.style.display = 'none';
            }
        }
        
        // Observe selected object
        const observeBtn = container.querySelector('#star-id-observe');
        if (observeBtn) {
            observeBtn.onclick = () => {
                if (!selectedObject) {
                    alert('No object selected. Select an object first.');
                    return;
                }
                
                // Switch to observe tab with the selected body
                celestialState.activeTab = 'observe';
                renderCelestial();
                
                // Set the body in the dropdown after render
                setTimeout(() => {
                    const bodySelect = container.querySelector('#celestial-body-select');
                    if (bodySelect && selectedObject.name) {
                        // Try to find matching option
                        for (const option of bodySelect.options) {
                            if (option.value === selectedObject.name || 
                                option.text.includes(selectedObject.name)) {
                                bodySelect.value = option.value;
                                break;
                            }
                        }
                    }
                }, 100);
            };
        }
    }
    
    /**
     * Bind camera sextant events
     */
    function bindCameraSextantEvents() {
        if (typeof CameraSextantModule === 'undefined') return;
        
        // Track camera sextant state
        let cameraSextantActive = false;
        let lastCapturedMeasurement = null;
        
        // Start camera sextant
        const startBtn = container.querySelector('#camera-sextant-start');
        if (startBtn) {
            startBtn.onclick = async () => {
                const videoElement = container.querySelector('#camera-sextant-video');
                const overlayContainer = container.querySelector('#camera-sextant-overlay-container');
                const cameraContainer = container.querySelector('#camera-sextant-container');
                const activeControls = container.querySelector('#camera-sextant-active-controls');
                
                if (!videoElement) return;
                
                // Show loading state
                startBtn.disabled = true;
                startBtn.innerHTML = '‚è≥ Starting camera...';
                
                try {
                    const result = await CameraSextantModule.startSession(videoElement, {
                        onAltitudeUpdate: (data) => {
                            // Update overlay display
                            CameraSextantModule.updateOverlayDisplay(data);
                        },
                        onCapture: (measurement) => {
                            lastCapturedMeasurement = measurement;
                        },
                        onError: (error) => {
                            console.error('Camera Sextant error:', error);
                        }
                    });
                    
                    if (result.success) {
                        cameraSextantActive = true;
                        
                        // Show camera view
                        cameraContainer.style.display = 'block';
                        startBtn.style.display = 'none';
                        activeControls.style.display = 'block';
                        
                        // Add overlay
                        overlayContainer.innerHTML = CameraSextantModule.renderOverlay();
                        
                    } else {
                        alert('Failed to start camera: ' + result.error);
                        startBtn.disabled = false;
                        startBtn.innerHTML = 'üì∑ Start Camera Sextant';
                    }
                } catch (e) {
                    alert('Error: ' + e.message);
                    startBtn.disabled = false;
                    startBtn.innerHTML = 'üì∑ Start Camera Sextant';
                }
            };
        }
        
        // Stop camera sextant
        const stopBtn = container.querySelector('#camera-sextant-stop');
        if (stopBtn) {
            stopBtn.onclick = () => {
                CameraSextantModule.stopSession();
                cameraSextantActive = false;
                
                // Hide camera view
                const cameraContainer = container.querySelector('#camera-sextant-container');
                const startBtn = container.querySelector('#camera-sextant-start');
                const activeControls = container.querySelector('#camera-sextant-active-controls');
                
                if (cameraContainer) cameraContainer.style.display = 'none';
                if (startBtn) {
                    startBtn.style.display = 'block';
                    startBtn.disabled = false;
                    startBtn.innerHTML = 'üì∑ Start Camera Sextant';
                }
                if (activeControls) activeControls.style.display = 'none';
            };
        }
        
        // Calibrate horizon
        const calibrateBtn = container.querySelector('#camera-sextant-calibrate');
        if (calibrateBtn) {
            calibrateBtn.onclick = () => {
                const result = CameraSextantModule.calibrateHorizon();
                
                // Update accuracy display
                const accuracy = document.getElementById('camera-sextant-accuracy');
                if (accuracy) {
                    accuracy.textContent = `Calibrated! Offset: ${result.offset.toFixed(1)}¬∞`;
                    accuracy.style.color = 'rgba(100,255,100,0.8)';
                }
                
                // Visual feedback
                calibrateBtn.innerHTML = '‚úì Calibrated';
                clearTimeout(feedbackTimeouts.calibrate);
                feedbackTimeouts.calibrate = setTimeout(() => {
                    calibrateBtn.innerHTML = 'üéØ Calibrate Horizon';
                }, 2000);
            };
        }
        
        // Capture altitude
        const captureBtn = container.querySelector('#camera-sextant-capture');
        if (captureBtn) {
            captureBtn.onclick = () => {
                const measurement = CameraSextantModule.captureAltitude();
                lastCapturedMeasurement = measurement;
                
                // Show result
                const resultDiv = container.querySelector('#camera-sextant-result');
                const resultValue = container.querySelector('#camera-sextant-result-value');
                const resultAccuracy = container.querySelector('#camera-sextant-result-accuracy');
                
                if (resultDiv) resultDiv.style.display = 'block';
                if (resultValue) {
                    resultValue.textContent = CameraSextantModule.formatAltitude(measurement.altitude);
                }
                if (resultAccuracy) {
                    resultAccuracy.textContent = `Est. accuracy: ¬±${measurement.estimatedAccuracy.toFixed(1)}¬∞ | ` +
                                                 `${measurement.calibrated ? 'Calibrated' : 'Uncalibrated'} | ` +
                                                 `Roll: ${Math.abs(measurement.roll).toFixed(1)}¬∞`;
                }
                
                // Visual feedback on capture button
                captureBtn.innerHTML = '‚úì Captured!';
                clearTimeout(feedbackTimeouts.capture);
                feedbackTimeouts.capture = setTimeout(() => {
                    captureBtn.innerHTML = 'üì∏ Capture Altitude';
                }, 1000);
            };
        }
        
        // Use captured measurement
        const useBtn = container.querySelector('#camera-sextant-use');
        if (useBtn) {
            useBtn.onclick = () => {
                if (!lastCapturedMeasurement) {
                    alert('No measurement captured. Please capture an altitude first.');
                    return;
                }
                
                // Populate the manual observation form
                const altDegInput = container.querySelector('#celestial-obs-alt-deg');
                const altMinInput = container.querySelector('#celestial-obs-alt-min');
                
                if (altDegInput && altMinInput) {
                    const deg = Math.floor(Math.abs(lastCapturedMeasurement.altitude));
                    const min = ((Math.abs(lastCapturedMeasurement.altitude) % 1) * 60);
                    
                    altDegInput.value = deg;
                    altMinInput.value = min.toFixed(1);
                    
                    // Visual feedback
                    useBtn.innerHTML = '‚úì Applied!';
                    clearTimeout(feedbackTimeouts.useMeasurement);
                    feedbackTimeouts.useMeasurement = setTimeout(() => {
                        useBtn.innerHTML = 'Use This Measurement';
                    }, 1500);
                    
                    // Scroll to the manual observation form
                    altDegInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    altDegInput.focus();
                }
                
                // Stop camera session to save resources
                CameraSextantModule.stopSession();
                cameraSextantActive = false;
                
                // Update UI
                const cameraContainer = container.querySelector('#camera-sextant-container');
                const startBtnRef = container.querySelector('#camera-sextant-start');
                const activeControls = container.querySelector('#camera-sextant-active-controls');
                const resultDiv = container.querySelector('#camera-sextant-result');
                
                if (cameraContainer) cameraContainer.style.display = 'none';
                if (startBtnRef) {
                    startBtnRef.style.display = 'block';
                    startBtnRef.disabled = false;
                    startBtnRef.innerHTML = 'üì∑ Start Camera Sextant';
                }
                if (activeControls) activeControls.style.display = 'none';
                if (resultDiv) resultDiv.style.display = 'none';
            };
        }
    }
    
    /**
     * Get cardinal direction from bearing
     */
    function getCardinalDirection(bearing) {
        const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE',
                          'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
        const index = Math.round(bearing / 22.5) % 16;
        return directions[index];
    }

    /**
     * Render Navigation Panel
     */
    function renderNavigation() {
        _saveScroll(); _restoreScroll();
        const routes = State.get('routes').filter(r => !r.isBuilding);
        const waypoints = State.get('waypoints');
        
        // Get navigation state
        const navState = typeof NavigationModule !== 'undefined' ? NavigationModule.getState() : null;
        const isActive = navState?.isActive || false;
        const currentRoute = navState?.route || null;
        const navInfo = typeof NavigationModule !== 'undefined' ? NavigationModule.getNavigationInfo() : null;
        
        container.innerHTML = `
            <div class="panel__header">
                <h2 class="panel__title">üß≠ Navigation</h2>
            </div>
            
            <!-- Navigation Status -->
            <div class="nav-status-indicator ${isActive ? 'nav-status-indicator--active' : 'nav-status-indicator--inactive'}">
                <div class="nav-status-indicator__dot ${isActive ? 'nav-status-indicator__dot--active' : 'nav-status-indicator__dot--inactive'}"></div>
                <div>
                    <div style="font-size:13px;font-weight:500">${isActive ? 'Navigating' : 'Navigation Inactive'}</div>
                    <div style="font-size:11px;color:rgba(255,255,255,0.5)">
                        ${isActive && currentRoute ? currentRoute.name : 'Select a route to begin'}
                    </div>
                </div>
            </div>
            
            ${isActive && navInfo ? `
                <!-- Active Navigation Info -->
                <div style="padding:16px;background:rgba(249,115,22,0.1);border:1px solid rgba(249,115,22,0.3);border-radius:12px;margin-bottom:16px">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                        <span style="font-size:12px;color:rgba(255,255,255,0.5)">NEXT WAYPOINT</span>
                        <span style="font-size:12px;color:#f97316">${navInfo.currentPointIndex + 1} / ${navInfo.totalPoints}</span>
                    </div>
                    
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
                        <div style="font-size:24px">${getNextWaypointIcon(navInfo, waypoints)}</div>
                        <div>
                            <div style="font-size:15px;font-weight:600">${getNextWaypointName(navInfo, waypoints)}</div>
                            <div style="font-size:24px;font-weight:700;color:#f97316">${formatNavDistance(navInfo.distanceToNext)}</div>
                        </div>
                    </div>
                    
                    <div style="display:flex;justify-content:space-around;padding:12px;background:rgba(0,0,0,0.2);border-radius:8px">
                        <div style="text-align:center">
                            <div style="font-size:16px;font-weight:600">${formatNavBearing(navInfo.bearingToNext)}</div>
                            <div style="font-size:9px;color:rgba(255,255,255,0.4)">BEARING</div>
                        </div>
                        <div style="text-align:center">
                            <div style="font-size:16px;font-weight:600">${formatNavDistance(navInfo.distanceRemaining)}</div>
                            <div style="font-size:9px;color:rgba(255,255,255,0.4)">REMAINING</div>
                        </div>
                        <div style="text-align:center">
                            <div style="font-size:16px;font-weight:600">${formatNavTime(navInfo.timeRemaining)}</div>
                            <div style="font-size:9px;color:rgba(255,255,255,0.4)">ETA</div>
                        </div>
                    </div>
                    
                    ${navInfo.isOffRoute ? `
                        <div style="margin-top:12px;padding:10px;background:rgba(239,68,68,0.2);border:1px solid rgba(239,68,68,0.3);border-radius:8px;color:#ef4444;font-size:12px;font-weight:600;text-align:center">
                            ‚ö†Ô∏è OFF ROUTE - ${formatNavDistance(navInfo.offRouteDistance)} from path
                        </div>
                    ` : ''}
                </div>
                
                <!-- Waypoint Progress List -->
                <div class="section-label">Route Progress</div>
                <div class="nav-waypoint-list">
                    ${currentRoute && currentRoute.points ? currentRoute.points.map((pt, i) => {
                        const isCompleted = i < navInfo.currentPointIndex;
                        const isCurrent = i === navInfo.currentPointIndex;
                        const linkedWp = pt.waypointId ? waypoints.find(w => w.id === pt.waypointId) : null;
                        const wpType = linkedWp ? Constants.WAYPOINT_TYPES[linkedWp.type] : null;
                        return `
                            <div class="nav-waypoint-item ${isCurrent ? 'nav-waypoint-item--current' : ''} ${isCompleted ? 'nav-waypoint-item--completed' : ''}"
                                 data-waypoint-index="${i}">
                                <div class="nav-waypoint-item__index">${isCompleted ? '‚úì' : (i + 1)}</div>
                                <div class="nav-waypoint-item__icon">${wpType?.icon || 'üìç'}</div>
                                <div class="nav-waypoint-item__info">
                                    <div class="nav-waypoint-item__name">${linkedWp?.name || `Point ${i + 1}`}</div>
                                    ${!isCompleted ? `<div class="nav-waypoint-item__dist">${isCurrent ? 'Next' : ''}</div>` : ''}
                                </div>
                            </div>
                        `;
                    }).join('') : '<div style="padding:10px;color:rgba(255,255,255,0.4);font-size:12px">No waypoints</div>'}
                </div>
                
                <!-- Navigation Controls -->
                <div style="display:flex;gap:8px;margin-top:16px">
                    <button class="btn btn--secondary" id="nav-prev-btn" ${navInfo.currentPointIndex === 0 ? 'disabled' : ''} style="flex:1">
                        ‚èÆÔ∏è Prev
                    </button>
                    <button class="btn btn--secondary" id="nav-stop-btn" style="flex:1;background:rgba(239,68,68,0.15);border-color:rgba(239,68,68,0.3);color:#ef4444">
                        ‚èπÔ∏è Stop
                    </button>
                    <button class="btn btn--secondary" id="nav-next-btn" ${navInfo.currentPointIndex >= navInfo.totalPoints - 1 ? 'disabled' : ''} style="flex:1">
                        Next ‚è≠Ô∏è
                    </button>
                </div>
                
                <!-- Stats -->
                <div class="divider"></div>
                <div class="section-label">Trip Statistics</div>
                <div class="stat-grid stat-grid--2">
                    <div class="stat-box">
                        <div class="stat-box__value">${formatNavDistance(navInfo.stats?.distanceTraveled || 0)}</div>
                        <div class="stat-box__label">TRAVELED</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-box__value">${formatNavTime((navInfo.stats?.elapsedTime || 0) / 3600)}</div>
                        <div class="stat-box__label">ELAPSED</div>
                    </div>
                </div>
            ` : `
                <!-- Route Selection -->
                ${routes.length > 0 ? `
                    <div class="section-label">Select Route to Navigate</div>
                    <div class="nav-route-selector">
                        ${routes.map(route => `
                            <div class="nav-route-card" data-route-id="${route.id}">
                                <div style="display:flex;align-items:center;gap:12px">
                                    <div style="width:40px;height:40px;background:rgba(249,115,22,0.15);border-radius:10px;display:flex;align-items:center;justify-content:center;color:#f97316">
                                        ${Icons.get('route')}
                                    </div>
                                    <div style="flex:1">
                                        <div style="font-size:14px;font-weight:500">${route.name}</div>
                                        <div style="font-size:11px;color:rgba(255,255,255,0.5)">
                                            ${route.points?.length || 0} points ‚Ä¢ ${route.distance || '?'} mi ‚Ä¢ ${route.duration || '?'}
                                        </div>
                                    </div>
                                    <button class="btn btn--primary" data-start-nav="${route.id}" style="padding:8px 16px;font-size:12px">
                                        ‚ñ∂Ô∏è Start
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : `
                    <div class="empty-state">
                        <div class="empty-state__icon">${Icons.get('route')}</div>
                        <div class="empty-state__title">No Routes Available</div>
                        <div class="empty-state__desc">Create a route first to begin navigation</div>
                    </div>
                `}
            `}
            
            <div class="divider"></div>
            
            <!-- Navigation Settings -->
            <div class="section-label">Navigation Settings</div>
            <label class="checkbox-field" style="margin-bottom:8px">
                <input type="checkbox" id="nav-voice" ${navState?.settings?.voiceGuidance ? 'checked' : ''} style="width:auto">
                <span>Voice Guidance</span>
            </label>
            <label class="checkbox-field" style="margin-bottom:8px">
                <input type="checkbox" id="nav-offroute" ${navState?.settings?.offRouteAlerts !== false ? 'checked' : ''} style="width:auto">
                <span>Off-Route Alerts</span>
            </label>
            <label class="checkbox-field" style="margin-bottom:8px">
                <input type="checkbox" id="nav-autoadvance" ${navState?.settings?.autoAdvance !== false ? 'checked' : ''} style="width:auto">
                <span>Auto-Advance to Next Point</span>
            </label>
            <label class="checkbox-field" style="margin-bottom:8px">
                <input type="checkbox" id="nav-screenon" ${navState?.settings?.keepScreenOn ? 'checked' : ''} style="width:auto">
                <span>Keep Screen On</span>
            </label>
            <label class="checkbox-field" style="margin-bottom:8px">
                <input type="checkbox" id="nav-center" ${navState?.settings?.centerOnPosition !== false ? 'checked' : ''} style="width:auto">
                <span>Center Map on Position</span>
            </label>
            <label class="checkbox-field">
                <input type="checkbox" id="nav-breadcrumbs" ${navState?.settings?.showBreadcrumbs !== false ? 'checked' : ''} style="width:auto">
                <span>Show Track Breadcrumbs</span>
            </label>
            
            <!-- Active Hike Widget -->
            ${typeof HikingModule !== 'undefined' ? `
                <div class="divider"></div>
                <div class="section-label">ü•æ Hiking Mode</div>
                <div id="active-hike-widget">
                    ${HikingModule.renderActiveHikeWidget()}
                </div>
                ${HikingModule.isHikeActive() ? `
                    <div style="margin-top:12px">
                        ${HikingModule.renderTrailLegend()}
                    </div>
                ` : ''}
            ` : ''}
            
            <!-- Daylight Remaining Widget -->
            ${typeof HikingModule !== 'undefined' ? `
                <div class="divider"></div>
                <div class="section-label">‚òÄÔ∏è Daylight Status</div>
                <div id="nav-daylight-widget">
                    ${HikingModule.renderDaylightWidget()}
                </div>
            ` : ''}
            
            <!-- Rangefinder Resection (GPS-Denied Position Fix) -->
            ${typeof RangefinderModule !== 'undefined' ? `
                <div class="divider"></div>
                <div class="section-label">üìê GPS-Denied Position</div>
                <div id="resection-widget">
                    ${RangefinderModule.renderWidget()}
                </div>
            ` : ''}
            
            <!-- GPS Status Reminder -->
            <div style="margin-top:16px;padding:12px;background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.2);border-radius:10px">
                <div style="font-size:12px;color:#3b82f6;display:flex;align-items:center;gap:8px">
                    ${Icons.get('locate')}
                    <span>Navigation requires GPS. Check GPS panel for status.</span>
                </div>
            </div>
        `;
        
        // Bind event handlers
        bindNavigationEvents();
    }
    
    /**
     * Bind navigation panel event handlers
     */
    function bindNavigationEvents() {
        // Start navigation buttons
        container.querySelectorAll('[data-start-nav]').forEach(btn => {
            btn.onclick = (e) => {
                e.stopPropagation();
                const routeId = btn.dataset.startNav;
                if (typeof NavigationModule !== 'undefined') {
                    NavigationModule.startNavigation(routeId);
                    renderNavigation();
                    // Show HUD on map
                    MapModule.render();
                }
            };
        });
        
        // Stop navigation
        const stopBtn = container.querySelector('#nav-stop-btn');
        if (stopBtn) {
            stopBtn.onclick = () => {
                if (typeof NavigationModule !== 'undefined') {
                    NavigationModule.stopNavigation();
                    renderNavigation();
                    MapModule.render();
                }
            };
        }
        
        // Previous waypoint
        const prevBtn = container.querySelector('#nav-prev-btn');
        if (prevBtn) {
            prevBtn.onclick = () => {
                if (typeof NavigationModule !== 'undefined') {
                    NavigationModule.previousWaypoint();
                    renderNavigation();
                }
            };
        }
        
        // Next waypoint
        const nextBtn = container.querySelector('#nav-next-btn');
        if (nextBtn) {
            nextBtn.onclick = () => {
                if (typeof NavigationModule !== 'undefined') {
                    NavigationModule.nextWaypoint();
                    renderNavigation();
                }
            };
        }
        
        // Waypoint click to jump
        container.querySelectorAll('[data-waypoint-index]').forEach(item => {
            item.onclick = () => {
                const index = parseInt(item.dataset.waypointIndex);
                if (typeof NavigationModule !== 'undefined') {
                    NavigationModule.goToWaypoint(index);
                    renderNavigation();
                }
            };
        });
        
        // Settings toggles
        const settingsMap = {
            'nav-voice': 'voiceGuidance',
            'nav-offroute': 'offRouteAlerts',
            'nav-autoadvance': 'autoAdvance',
            'nav-screenon': 'keepScreenOn',
            'nav-center': 'centerOnPosition',
            'nav-breadcrumbs': 'showBreadcrumbs'
        };
        
        Object.entries(settingsMap).forEach(([id, setting]) => {
            const checkbox = container.querySelector(`#${id}`);
            if (checkbox) {
                checkbox.onchange = () => {
                    if (typeof NavigationModule !== 'undefined') {
                        NavigationModule.updateSettings({ [setting]: checkbox.checked });
                    }
                };
            }
        });
        
        // Start Hike button
        const startHikeBtn = container.querySelector('#start-hike-btn');
        if (startHikeBtn) {
            startHikeBtn.onclick = () => {
                if (typeof HikingModule === 'undefined') return;
                
                // Create inline modal for hike configuration
                const modalOverlay = document.createElement('div');
                modalOverlay.id = 'hike-config-modal';
                modalOverlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px';
                
                modalOverlay.innerHTML = `
                    <div style="background:var(--color-bg-elevated, #1f2937);border-radius:16px;max-width:400px;width:100%;max-height:90vh;overflow-y:auto">
                        <div style="padding:16px;border-bottom:1px solid rgba(255,255,255,0.1)">
                            <div style="font-size:16px;font-weight:600">ü•æ Start Hiking</div>
                        </div>
                        <div style="padding:16px">
                            <div style="margin-bottom:16px">
                                <label style="display:block;font-size:12px;color:rgba(255,255,255,0.6);margin-bottom:6px">Target Distance (one-way, miles)</label>
                                <input type="number" id="hike-target-distance" value="2" min="0.1" max="50" step="0.1" 
                                       style="width:100%;padding:10px;font-size:14px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:white">
                            </div>
                            <div style="margin-bottom:16px">
                                <label style="display:block;font-size:12px;color:rgba(255,255,255,0.6);margin-bottom:6px">Expected Elevation Gain (feet)</label>
                                <input type="number" id="hike-elev-gain" value="500" min="0" max="10000" step="100" 
                                       style="width:100%;padding:10px;font-size:14px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:white">
                            </div>
                            <div style="margin-bottom:16px">
                                <label style="display:block;font-size:12px;color:rgba(255,255,255,0.6);margin-bottom:6px">Expected Elevation Loss (feet)</label>
                                <input type="number" id="hike-elev-loss" value="100" min="0" max="10000" step="100" 
                                       style="width:100%;padding:10px;font-size:14px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:white">
                            </div>
                            <label style="display:flex;align-items:center;gap:8px;margin-bottom:16px;cursor:pointer">
                                <input type="checkbox" id="hike-out-and-back" checked style="width:18px;height:18px">
                                <span style="font-size:12px">Out-and-back hike (return same way)</span>
                            </label>
                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                                <input type="checkbox" id="hike-turnaround-alerts" checked style="width:18px;height:18px">
                                <span style="font-size:12px">Enable turnaround time alerts</span>
                            </label>
                        </div>
                        <div style="padding:16px;border-top:1px solid rgba(255,255,255,0.1);display:flex;gap:12px;justify-content:flex-end">
                            <button id="hike-cancel-btn" class="btn btn--secondary" style="padding:10px 20px">Cancel</button>
                            <button id="hike-start-btn" class="btn btn--primary" style="padding:10px 20px">Start Hike</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modalOverlay);
                
                // Focus first input
                setTimeout(() => {
                    const distInput = domCache.get('hike-target-distance');
                    if (distInput) distInput.focus();
                }, 100);
                
                // Cancel button
                document.getElementById('hike-cancel-btn').onclick = () => {
                    modalOverlay.remove();
                };
                
                // Click overlay to close
                modalOverlay.onclick = (e) => {
                    if (e.target === modalOverlay) {
                        modalOverlay.remove();
                    }
                };
                
                // Start button
                document.getElementById('hike-start-btn').onclick = () => {
                    const distance = parseFloat(domCache.get('hike-target-distance').value) || 2;
                    const gain = parseFloat(document.getElementById('hike-elev-gain').value) || 0;
                    const loss = parseFloat(document.getElementById('hike-elev-loss').value) || 0;
                    const outAndBack = document.getElementById('hike-out-and-back').checked;
                    const alerts = document.getElementById('hike-turnaround-alerts').checked;
                    
                    HikingModule.updateSettings({ turnaroundAlerts: alerts });
                    HikingModule.startHike({
                        targetDistance: distance,
                        elevationGain: gain,
                        elevationLoss: loss,
                        outAndBack: outAndBack
                    });
                    
                    modalOverlay.remove();
                    renderNavigation();
                    
                    if (typeof ModalsModule !== 'undefined') {
                        ModalsModule.showToast('Hike started! Trail recording active.', 'success');
                    }
                };
            };
        }
        
        // Stop Hike button
        const stopHikeBtn = container.querySelector('#stop-hike-btn');
        if (stopHikeBtn) {
            stopHikeBtn.onclick = () => {
                if (typeof HikingModule === 'undefined') return;
                
                const summary = HikingModule.stopHike();
                renderNavigation();
                
                if (summary && typeof ModalsModule !== 'undefined') {
                    const stats = summary.trail?.length > 1 ? HikingModule.getTrailStats() : null;
                    ModalsModule.showToast(
                        `Hike complete! ${stats ? stats.totalDistance.toFixed(2) + ' mi, ' + HikingModule.formatDuration(summary.duration / 60) : 'Trail saved.'}`,
                        'success',
                        5000
                    );
                }
            };
        }
        
        // ===== Rangefinder Resection Events =====
        bindRangefinderEvents();
    }
    
    /**
     * Bind rangefinder resection events
     */
    function bindRangefinderEvents() {
        if (typeof RangefinderModule === 'undefined') return;
        
        // Add from waypoint button
        const addWpBtn = container.querySelector('#resection-add-waypoint');
        if (addWpBtn) {
            addWpBtn.onclick = () => {
                const waypoints = State.get('waypoints');
                
                // Create modal for waypoint selection
                const modalOverlay = document.createElement('div');
                modalOverlay.id = 'resection-wp-modal';
                modalOverlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px';
                
                modalOverlay.innerHTML = `
                    <div style="background:var(--color-bg-elevated, #1f2937);border-radius:16px;max-width:400px;width:100%;max-height:80vh;overflow:hidden;display:flex;flex-direction:column">
                        <div style="padding:16px;border-bottom:1px solid rgba(255,255,255,0.1);display:flex;justify-content:space-between;align-items:center">
                            <div style="font-size:16px;font-weight:600">üìå Select Landmark</div>
                            <button id="resection-wp-close" style="background:none;border:none;color:rgba(255,255,255,0.6);cursor:pointer;font-size:18px">‚úï</button>
                        </div>
                        <div style="padding:16px;overflow-y:auto;flex:1">
                            ${RangefinderModule.renderWaypointSelector(waypoints)}
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modalOverlay);
                
                // Close button
                modalOverlay.querySelector('#resection-wp-close').onclick = () => {
                    modalOverlay.remove();
                };
                
                // Click outside to close
                modalOverlay.onclick = (e) => {
                    if (e.target === modalOverlay) modalOverlay.remove();
                };
                
                // Waypoint selection
                modalOverlay.querySelectorAll('.resection-wp-option').forEach(option => {
                    option.onclick = () => {
                        const wpId = option.dataset.wpId;
                        const wp = waypoints.find(w => w.id === wpId);
                        if (wp) {
                            RangefinderModule.addFromWaypoint(wp);
                            modalOverlay.remove();
                            refreshResectionWidget();
                        }
                    };
                });
            };
        }
        
        // Add from map button
        const addMapBtn = container.querySelector('#resection-add-map');
        if (addMapBtn) {
            addMapBtn.onclick = () => {
                // Set map to "add landmark" mode
                if (typeof MapModule !== 'undefined') {
                    MapModule.setInteractionMode('resection-landmark');
                    
                    // Show toast
                    if (typeof ModalsModule !== 'undefined') {
                        ModalsModule.showToast('Tap on map to add landmark', 'info', 3000);
                    }
                    
                    // Close panel to show map
                    const sidebar = document.getElementById('sidebar');
                    if (sidebar) sidebar.classList.remove('open');
                }
            };
        }
        
        // Clear all button
        const clearAllBtn = container.querySelector('#resection-clear-all');
        if (clearAllBtn) {
            clearAllBtn.onclick = () => {
                if (confirm('Clear all landmarks?')) {
                    RangefinderModule.clearLandmarks();
                    refreshResectionWidget();
                }
            };
        }
        
        // Remove individual landmark buttons
        container.querySelectorAll('.resection-remove-lm').forEach(btn => {
            btn.onclick = (e) => {
                e.stopPropagation();
                const id = btn.dataset.id;
                RangefinderModule.removeLandmark(id);
                refreshResectionWidget();
            };
        });
        
        // Distance input fields
        container.querySelectorAll('.resection-distance-input').forEach(input => {
            input.onchange = () => {
                const id = input.dataset.id;
                const distance = parseFloat(input.value);
                if (!isNaN(distance) && distance > 0) {
                    RangefinderModule.updateDistance(id, distance);
                    refreshResectionWidget();
                }
            };
            
            // Also update on blur
            input.onblur = input.onchange;
        });
        
        // Calculate button
        const calcBtn = container.querySelector('#resection-calculate');
        if (calcBtn) {
            calcBtn.onclick = () => {
                const result = RangefinderModule.calculateFix();
                
                if (result.error) {
                    if (typeof ModalsModule !== 'undefined') {
                        ModalsModule.showToast(result.error, 'error', 3000);
                    } else {
                        alert(result.error);
                    }
                } else {
                    refreshResectionWidget();
                    
                    if (typeof ModalsModule !== 'undefined') {
                        ModalsModule.showToast(
                            `Position fix: ${result.position.lat.toFixed(4)}¬∞, ${result.position.lon.toFixed(4)}¬∞ (¬±${result.accuracy.toFixed(0)}m)`,
                            'success',
                            5000
                        );
                    }
                }
            };
        }
        
        // Apply fix button
        const applyBtn = container.querySelector('#resection-apply-fix');
        if (applyBtn) {
            applyBtn.onclick = () => {
                const fix = RangefinderModule.getLastFix();
                if (!fix) return;
                
                // Update map center
                if (typeof MapModule !== 'undefined') {
                    MapModule.setCenter(fix.position.lat, fix.position.lon);
                    MapModule.render();
                }
                
                // Optionally set as manual GPS position
                if (typeof GPSModule !== 'undefined' && GPSModule.setManualPosition) {
                    GPSModule.setManualPosition(fix.position.lat, fix.position.lon);
                }
                
                if (typeof ModalsModule !== 'undefined') {
                    ModalsModule.showToast('Position applied to map', 'success', 2000);
                }
            };
        }
        
        // Show details button
        const detailsBtn = container.querySelector('#resection-show-details');
        if (detailsBtn) {
            detailsBtn.onclick = () => {
                const modalOverlay = document.createElement('div');
                modalOverlay.id = 'resection-details-modal';
                modalOverlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px';
                
                modalOverlay.innerHTML = `
                    <div style="background:var(--color-bg-elevated, #1f2937);border-radius:16px;max-width:400px;width:100%;max-height:80vh;overflow:hidden">
                        <div style="padding:16px;border-bottom:1px solid rgba(255,255,255,0.1);display:flex;justify-content:space-between;align-items:center">
                            <div style="font-size:16px;font-weight:600">üìê Fix Details</div>
                            <button id="resection-details-close" style="background:none;border:none;color:rgba(255,255,255,0.6);cursor:pointer;font-size:18px">‚úï</button>
                        </div>
                        <div style="overflow-y:auto;max-height:60vh">
                            ${RangefinderModule.renderFixDetails()}
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modalOverlay);
                
                modalOverlay.querySelector('#resection-details-close').onclick = () => {
                    modalOverlay.remove();
                };
                
                modalOverlay.onclick = (e) => {
                    if (e.target === modalOverlay) modalOverlay.remove();
                };
            };
        }
        
        // Helper to refresh widget
        function refreshResectionWidget() {
            const widget = container.querySelector('#resection-widget');
            if (widget) {
                widget.innerHTML = RangefinderModule.renderWidget();
                bindRangefinderEvents();  // Rebind events
            }
        }
    }
    
    /**
     * Get next waypoint icon from navigation info
     */
    function getNextWaypointIcon(navInfo, waypoints) {
        if (!navInfo || !navInfo.route || !navInfo.route.points) return 'üìç';
        const currentPoint = navInfo.route.points[navInfo.currentPointIndex];
        if (!currentPoint) return 'üìç';
        if (currentPoint.waypointId) {
            const wp = waypoints.find(w => w.id === currentPoint.waypointId);
            if (wp) {
                const wpType = Constants.WAYPOINT_TYPES[wp.type];
                return wpType?.icon || 'üìç';
            }
        }
        return 'üìç';
    }
    
    /**
     * Get next waypoint name from navigation info
     */
    function getNextWaypointName(navInfo, waypoints) {
        if (!navInfo || !navInfo.route || !navInfo.route.points) return 'Unknown';
        const currentPoint = navInfo.route.points[navInfo.currentPointIndex];
        if (!currentPoint) return 'Unknown';
        if (currentPoint.waypointId) {
            const wp = waypoints.find(w => w.id === currentPoint.waypointId);
            if (wp) return wp.name;
        }
        return currentPoint.name || `Point ${navInfo.currentPointIndex + 1}`;
    }
    
    /**
     * Format navigation distance
     */
    function formatNavDistance(miles) {
        if (miles === null || miles === undefined) return '--';
        if (miles < 0.1) {
            return `${Math.round(miles * 5280)} ft`;
        } else if (miles < 10) {
            return `${miles.toFixed(2)} mi`;
        } else {
            return `${miles.toFixed(1)} mi`;
        }
    }
    
    /**
     * Format navigation bearing
     */
    function formatNavBearing(degrees) {
        if (degrees === null || degrees === undefined) return '--';
        const dir = getCardinalDirection(degrees);
        return `${Math.round(degrees)}¬∞ ${dir}`;
    }
    
    /**
     * Format navigation time (hours to readable)
     */
    function formatNavTime(hours) {
        if (hours === null || hours === undefined) return '--';
        if (hours < 1/60) {
            return `${Math.round(hours * 3600)}s`;
        } else if (hours < 1) {
            return `${Math.round(hours * 60)}m`;
        } else {
            const h = Math.floor(hours);
            const m = Math.round((hours - h) * 60);
            return m > 0 ? `${h}h ${m}m` : `${h}h`;
        }
    }

    // ==================== COORDINATE CONVERTER ====================

    /**
     * Render the Coordinate Converter panel
     */
    function renderCoordinateConverter() {
        const currentFormat = typeof Coordinates !== 'undefined' ? Coordinates.getFormat() : 'dd';
        const formats = typeof Coordinates !== 'undefined' ? Coordinates.FORMATS : {
            DD: 'dd', DMS: 'dms', DDM: 'ddm', UTM: 'utm', MGRS: 'mgrs'
        };
        
        // Get GPS position if available
        let gpsLat = null, gpsLon = null, gpsAccuracy = null;
        if (typeof GPSModule !== 'undefined') {
            const gpsState = GPSModule.getState();
            if (gpsState.position) {
                gpsLat = gpsState.position.lat;
                gpsLon = gpsState.position.lon;
                gpsAccuracy = gpsState.position.accuracy;
            }
        }
        
        // Get map center
        let mapLat = 37.4215, mapLon = -119.1892;
        if (typeof MapModule !== 'undefined' && MapModule.getMapState) {
            const mapState = MapModule.getMapState();
            mapLat = mapState.lat;
            mapLon = mapState.lon;
        }

        container.innerHTML = `
            <div class="panel__header">
                <h2 class="panel__title">Coordinate Converter</h2>
            </div>
            
            <!-- Input Section -->
            <div class="coord-converter-section">
                <div class="section-label">Enter Coordinates</div>
                <div class="coord-input-group">
                    <input type="text" 
                        id="coord-input" 
                        class="coord-input" 
                        placeholder="Enter any format: DD, DMS, UTM, MGRS..."
                        autocomplete="off"
                        spellcheck="false">
                    <button class="btn btn--primary coord-input-go" id="coord-go-btn" title="Go to location">
                        ${Icons.get('arrowRight')}
                    </button>
                </div>
                <div id="coord-input-status" class="coord-input-status"></div>
                <div class="coord-input-examples">
                    <span class="coord-example-label">Examples:</span>
                    <button class="coord-example" data-example="37.4215, -119.1892">DD</button>
                    <button class="coord-example" data-example="37¬∞ 25' 17.4&quot; N, 119¬∞ 11' 21.1&quot; W">DMS</button>
                    <button class="coord-example" data-example="11S 318234 4143234">UTM</button>
                    <button class="coord-example" data-example="11S LA 18234 43234">MGRS</button>
                </div>
            </div>
            
            <!-- Conversion Results -->
            <div id="coord-results" class="coord-results" style="display:none">
                <div class="section-label">Converted Coordinates</div>
                <div class="coord-results-list">
                    <div class="coord-result-item" data-format="dd">
                        <div class="coord-result-label">Decimal Degrees (DD)</div>
                        <div class="coord-result-row">
                            <div class="coord-result-value" id="result-dd">--</div>
                            <button class="coord-copy-btn" data-copy="dd" title="Copy DD coordinates" aria-label="Copy decimal degrees">${Icons.get('copy')}</button>
                        </div>
                    </div>
                    <div class="coord-result-item" data-format="dms">
                        <div class="coord-result-label">Degrees Minutes Seconds (DMS)</div>
                        <div class="coord-result-row">
                            <div class="coord-result-value" id="result-dms">--</div>
                            <button class="coord-copy-btn" data-copy="dms" title="Copy DMS coordinates" aria-label="Copy degrees minutes seconds">${Icons.get('copy')}</button>
                        </div>
                    </div>
                    <div class="coord-result-item" data-format="ddm">
                        <div class="coord-result-label">Degrees Decimal Minutes (DDM)</div>
                        <div class="coord-result-row">
                            <div class="coord-result-value" id="result-ddm">--</div>
                            <button class="coord-copy-btn" data-copy="ddm" title="Copy DDM coordinates" aria-label="Copy degrees decimal minutes">${Icons.get('copy')}</button>
                        </div>
                    </div>
                    <div class="coord-result-item" data-format="utm">
                        <div class="coord-result-label">UTM</div>
                        <div class="coord-result-row">
                            <div class="coord-result-value" id="result-utm">--</div>
                            <button class="coord-copy-btn" data-copy="utm" title="Copy UTM coordinates" aria-label="Copy UTM">${Icons.get('copy')}</button>
                        </div>
                    </div>
                    <div class="coord-result-item" data-format="mgrs">
                        <div class="coord-result-label">MGRS</div>
                        <div class="coord-result-row">
                            <div class="coord-result-value" id="result-mgrs">--</div>
                            <button class="coord-copy-btn" data-copy="mgrs" title="Copy MGRS coordinates" aria-label="Copy MGRS">${Icons.get('copy')}</button>
                        </div>
                    </div>
                </div>
                
                <!-- Actions -->
                <div class="coord-actions">
                    <button class="btn btn--secondary btn--full" id="coord-create-waypoint">
                        ${Icons.get('waypoint')} Create Waypoint Here
                    </button>
                </div>
            </div>
            
            <div class="divider"></div>
            
            <!-- Quick Access: GPS Position -->
            ${gpsLat !== null ? `
                <div class="coord-quick-section">
                    <div class="section-label">üìç Current GPS Position</div>
                    <div class="coord-quick-card coord-quick-card--gps" id="gps-position-card">
                        <div class="coord-quick-info">
                            <div class="coord-quick-value">${formatCoordForDisplay(gpsLat, gpsLon, currentFormat)}</div>
                            <div class="coord-quick-meta">Accuracy: ¬±${gpsAccuracy ? gpsAccuracy.toFixed(0) : '?'}m</div>
                        </div>
                        <div class="coord-quick-actions">
                            <button class="coord-quick-btn" data-action="copy-gps" title="Copy" aria-label="Copy GPS coordinates">${Icons.get('copy')}</button>
                            <button class="coord-quick-btn" data-action="use-gps" title="Use this" aria-label="Use GPS coordinates">${Icons.get('arrowRight')}</button>
                        </div>
                    </div>
                </div>
            ` : `
                <div class="coord-quick-section">
                    <div class="section-label">üìç Current GPS Position</div>
                    <div class="coord-quick-card coord-quick-card--inactive">
                        <div class="coord-quick-info">
                            <div class="coord-quick-value" style="color:var(--color-text-muted)">GPS not active</div>
                            <div class="coord-quick-meta">Enable GPS in the GPS panel to see your position</div>
                        </div>
                    </div>
                </div>
            `}
            
            <!-- Quick Access: Map Center -->
            <div class="coord-quick-section">
                <div class="section-label">üó∫Ô∏è Map Center</div>
                <div class="coord-quick-card" id="map-center-card">
                    <div class="coord-quick-info">
                        <div class="coord-quick-value">${formatCoordForDisplay(mapLat, mapLon, currentFormat)}</div>
                        <div class="coord-quick-meta">Current map viewport center</div>
                    </div>
                    <div class="coord-quick-actions">
                        <button class="coord-quick-btn" data-action="copy-map" title="Copy" aria-label="Copy map coordinates">${Icons.get('copy')}</button>
                        <button class="coord-quick-btn" data-action="use-map" title="Use this" aria-label="Use map coordinates">${Icons.get('arrowRight')}</button>
                    </div>
                </div>
            </div>
            
            <div class="divider"></div>
            
            <!-- Display Format Preference -->
            <div class="coord-settings-section">
                <div class="section-label">Display Format Preference</div>
                <div class="coord-format-selector">
                    ${Object.entries(formats).map(([key, value]) => `
                        <button class="coord-format-btn ${currentFormat === value ? 'coord-format-btn--active' : ''}" 
                            data-format="${value}">
                            ${key}
                        </button>
                    `).join('')}
                </div>
                <div class="coord-format-desc">
                    This format will be used across the app for displaying coordinates.
                </div>
            </div>
            
            <div class="divider"></div>
            
            <!-- Distance Calculator -->
            <div class="coord-distance-section">
                <div class="section-label">Distance & Bearing Calculator</div>
                <div class="coord-distance-inputs">
                    <div class="form-group">
                        <label>From (Point A)</label>
                        <input type="text" id="distance-from" placeholder="Enter coordinates" class="coord-input-small">
                    </div>
                    <div class="form-group">
                        <label>To (Point B)</label>
                        <input type="text" id="distance-to" placeholder="Enter coordinates" class="coord-input-small">
                    </div>
                </div>
                <button class="btn btn--secondary btn--full" id="calc-distance-btn">
                    ${Icons.get('ruler')} Calculate Distance & Bearing
                </button>
                <div id="distance-result" class="coord-distance-result" style="display:none">
                    <div class="coord-distance-stat">
                        <span class="coord-distance-label">Distance:</span>
                        <span class="coord-distance-value" id="distance-value">--</span>
                    </div>
                    <div class="coord-distance-stat">
                        <span class="coord-distance-label">Bearing:</span>
                        <span class="coord-distance-value" id="bearing-value">--</span>
                    </div>
                </div>
            </div>
            
            <div class="divider"></div>
            
            <!-- Reference Info -->
            <div class="coord-reference-section">
                <div class="section-label">Quick Reference</div>
                <div class="coord-reference-list">
                    <div class="coord-reference-item">
                        <strong>DD</strong> - Decimal Degrees: 37.4215¬∞ N, 119.1892¬∞ W
                    </div>
                    <div class="coord-reference-item">
                        <strong>DMS</strong> - Degrees Minutes Seconds: 37¬∞ 25' 17.4" N
                    </div>
                    <div class="coord-reference-item">
                        <strong>DDM</strong> - Degrees Decimal Minutes: 37¬∞ 25.290' N
                    </div>
                    <div class="coord-reference-item">
                        <strong>UTM</strong> - Universal Transverse Mercator: 11S 318234 4143234
                    </div>
                    <div class="coord-reference-item">
                        <strong>MGRS</strong> - Military Grid Reference: 11SLA1823443234
                    </div>
                </div>
            </div>
        `;
        
        // Bind event handlers
        bindCoordinateConverterEvents();
    }
    
    /**
     * Format coordinate for display using current or specified format
     */
    function formatCoordForDisplay(lat, lon, format) {
        if (typeof Coordinates === 'undefined') {
            return `${lat.toFixed(4)}¬∞, ${lon.toFixed(4)}¬∞`;
        }
        return Coordinates.format(lat, lon, { format: format, compact: true });
    }
    
    /**
     * Bind event handlers for the coordinate converter.
     * All click, input, and change events are handled by setupEventDelegation().
     * This function resets state when the panel renders.
     */
    function bindCoordinateConverterEvents() {
        // Reset parsed coords state when panel renders
        coordConverterState.parsedCoords = null;
    }
    
    /**
     * Update conversion results display
     */
    function updateConversionResults(lat, lon) {
        if (typeof Coordinates === 'undefined') return;
        
        container.querySelector('#result-dd').textContent = Coordinates.toDD(lat, lon);
        container.querySelector('#result-dms').textContent = Coordinates.toDMS(lat, lon);
        container.querySelector('#result-ddm').textContent = Coordinates.toDDM(lat, lon);
        container.querySelector('#result-utm').textContent = Coordinates.toUTM(lat, lon);
        container.querySelector('#result-mgrs').textContent = Coordinates.toMGRS(lat, lon);
    }
    
    /**
     * Copy text to clipboard
     */
    function copyToClipboard(text) {
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).catch(err => {
                console.warn('Clipboard write failed:', err);
                fallbackCopy(text);
            });
        } else {
            fallbackCopy(text);
        }
    }
    
    /**
     * Fallback copy using textarea
     */
    function fallbackCopy(text) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        try {
            document.execCommand('copy');
        } catch (err) {
            console.error('Fallback copy failed:', err);
        }
        document.body.removeChild(textarea);
    }
    
    /**
     * Show toast message for coordinate converter
     */
    function showCoordToast(message, type = 'success') {
        if (typeof ModalsModule !== 'undefined' && ModalsModule.showToast) {
            ModalsModule.showToast(message, type);
        }
    }
    
    /**
     * Format distance result with appropriate units
     */
    function formatDistanceResult(miles) {
        if (miles < 0.1) {
            const feet = miles * 5280;
            return `${feet.toFixed(0)} ft (${(feet * 0.3048).toFixed(0)} m)`;
        } else if (miles < 1) {
            const feet = miles * 5280;
            return `${feet.toFixed(0)} ft (${miles.toFixed(2)} mi)`;
        } else {
            const km = miles * 1.60934;
            return `${miles.toFixed(2)} mi (${km.toFixed(2)} km)`;
        }
    }
    
    /**
     * Convert longitude to approximate X coordinate (for waypoint creation)
     */
    function lonToX(lon) {
        return 50 + (lon + 119.1892) / 0.004;
    }
    
    /**
     * Convert latitude to approximate Y coordinate (for waypoint creation)
     */
    function latToY(lat) {
        return 50 + (lat - 37.4215) / 0.002;
    }

    // ==================== COMMUNICATION PLAN ====================

    // Comm plan state (loaded from storage)
    let commPlan = null;
    let commPlanLoaded = false;

    /**
     * Default comm plan structure
     */
    function getDefaultCommPlan() {
        return {
            channels: [
                { id: 'ch1', name: 'Primary', frequency: '146.520', mode: 'FM', tone: '', power: 'High', isPrimary: true, notes: 'National simplex calling frequency' },
                { id: 'ch2', name: 'Tactical', frequency: '147.450', mode: 'FM', tone: '100.0', power: 'Medium', isPrimary: false, notes: 'Team tactical channel' },
                { id: 'ch3', name: 'Emergency', frequency: '146.460', mode: 'FM', tone: '', power: 'High', isPrimary: false, notes: 'Emergency backup' }
            ],
            callSigns: [
                { id: 'cs1', name: 'Team Lead', callSign: 'Alpha-1', role: 'Command', notes: '' },
                { id: 'cs2', name: 'Scout', callSign: 'Bravo-2', role: 'Reconnaissance', notes: '' },
                { id: 'cs3', name: 'Support', callSign: 'Charlie-3', role: 'Logistics', notes: '' }
            ],
            schedule: {
                enabled: true,
                checkIns: [
                    { id: 'ck1', time: '08:00', channel: 'ch1', type: 'routine', notes: 'Morning check-in' },
                    { id: 'ck2', time: '12:00', channel: 'ch1', type: 'routine', notes: 'Midday status' },
                    { id: 'ck3', time: '18:00', channel: 'ch1', type: 'routine', notes: 'Evening check-in' }
                ],
                missedCheckInProtocol: 'Wait 15 minutes, then attempt contact on backup channel. After 30 minutes with no contact, initiate search protocol.'
            },
            emergency: {
                distressWord: 'MAYDAY',
                duressWord: 'UNCLE',
                rallyPoint: 'Primary bail-out point (Highway Junction)',
                emergencyChannel: 'ch3',
                protocols: [
                    { id: 'ep1', situation: 'Medical Emergency', procedure: '1. Broadcast MAYDAY on primary\n2. Give location & nature of emergency\n3. Switch to emergency channel\n4. Maintain radio watch' },
                    { id: 'ep2', situation: 'Lost/Separated', procedure: '1. Stop and stay put\n2. Three short broadcasts on primary\n3. If no response, move to high ground\n4. Activate PLB if available' },
                    { id: 'ep3', situation: 'Vehicle Breakdown', procedure: '1. Report position on primary\n2. Assess repair options\n3. Coordinate pickup/support\n4. Set up rally point if needed' }
                ]
            },
            notes: ''
        };
    }

    /**
     * Load comm plan from storage
     */
    async function loadCommPlan() {
        if (commPlanLoaded) return commPlan;
        try {
            const saved = await Storage.Settings.get('commPlan');
            commPlan = saved || getDefaultCommPlan();
            commPlanLoaded = true;
        } catch (e) {
            console.error('Failed to load comm plan:', e);
            commPlan = getDefaultCommPlan();
        }
        return commPlan;
    }

    /**
     * Save comm plan to storage
     */
    async function saveCommPlan() {
        try {
            await Storage.Settings.set('commPlan', commPlan);
            showCommToast('Communication plan saved');
        } catch (e) {
            console.error('Failed to save comm plan:', e);
            showCommToast('Failed to save', 'error');
        }
    }

    /**
     * Show toast for comm module
     */
    function showCommToast(message, type = 'success') {
        if (typeof ModalsModule !== 'undefined' && ModalsModule.showToast) {
            ModalsModule.showToast(message, type);
        }
    }

    /**
     * Render the Communication Plan panel
     */
    async function renderComms() {
        _saveScroll(); _restoreScroll();
        // Load comm plan if not loaded
        if (!commPlanLoaded) {
            await loadCommPlan();
        }

        const plan = commPlan;
        const primaryChannel = plan.channels.find(c => c.isPrimary) || plan.channels[0];
        const emergencyChannel = plan.channels.find(c => c.id === plan.emergency.emergencyChannel);
        const nextCheckIn = getNextCheckIn(plan.schedule.checkIns);

        container.innerHTML = `
            <div class="panel__header">
                <h2 class="panel__title">Communication Plan</h2>
                <button class="btn btn--secondary" id="comm-export-btn" title="Export Plan">
                    ${Icons.get('export')}
                </button>
            </div>

            <!-- Quick Reference Card -->
            <div class="comm-quick-ref">
                <div class="comm-quick-ref__header">
                    ${Icons.get('broadcast')} Quick Reference
                </div>
                <div class="comm-quick-ref__grid">
                    <div class="comm-quick-ref__item">
                        <div class="comm-quick-ref__label">Primary Channel</div>
                        <div class="comm-quick-ref__value comm-quick-ref__value--primary">
                            ${primaryChannel ? `${primaryChannel.frequency} MHz` : 'Not set'}
                        </div>
                        <div class="comm-quick-ref__sub">${primaryChannel?.name || ''}</div>
                    </div>
                    <div class="comm-quick-ref__item">
                        <div class="comm-quick-ref__label">Next Check-in</div>
                        <div class="comm-quick-ref__value ${nextCheckIn ? '' : 'comm-quick-ref__value--muted'}">
                            ${nextCheckIn ? nextCheckIn.time : 'None scheduled'}
                        </div>
                        <div class="comm-quick-ref__sub">${nextCheckIn?.notes || ''}</div>
                    </div>
                </div>
                <div class="comm-quick-ref__emergency">
                    <span class="comm-quick-ref__emergency-label">Emergency:</span>
                    <span class="comm-quick-ref__emergency-word">${plan.emergency.distressWord}</span>
                    <span class="comm-quick-ref__emergency-freq">${emergencyChannel ? emergencyChannel.frequency + ' MHz' : 'Use primary'}</span>
                </div>
            </div>

            <!-- Channels Section -->
            <div class="comm-section">
                <div class="comm-section__header">
                    <span class="comm-section__title">${Icons.get('antenna')} Radio Channels</span>
                    <button class="btn btn--secondary btn--sm" id="add-channel-btn">
                        ${Icons.get('plus')} Add
                    </button>
                </div>
                <div class="comm-channel-list">
                    ${plan.channels.map(ch => `
                        <div class="comm-channel ${ch.isPrimary ? 'comm-channel--primary' : ''}" data-channel-id="${ch.id}">
                            <div class="comm-channel__header">
                                <div class="comm-channel__name">
                                    ${ch.isPrimary ? '<span class="comm-channel__badge">PRIMARY</span>' : ''}
                                    ${ch.name}
                                </div>
                                <div class="comm-channel__actions">
                                    <button class="comm-action-btn" data-edit-channel="${ch.id}" title="Edit" aria-label="Edit channel ${Helpers.escapeHtml(ch.name)}">
                                        ${Icons.get('edit')}
                                    </button>
                                    <button class="comm-action-btn comm-action-btn--danger" data-delete-channel="${ch.id}" title="Delete" aria-label="Delete channel ${Helpers.escapeHtml(ch.name)}">
                                        ${Icons.get('trash')}
                                    </button>
                                </div>
                            </div>
                            <div class="comm-channel__details">
                                <div class="comm-channel__freq">${ch.frequency} MHz</div>
                                <div class="comm-channel__meta">
                                    <span class="comm-tag">${ch.mode}</span>
                                    ${ch.tone ? `<span class="comm-tag">CTCSS ${ch.tone}</span>` : ''}
                                    <span class="comm-tag">${ch.power}</span>
                                </div>
                            </div>
                            ${ch.notes ? `<div class="comm-channel__notes">${ch.notes}</div>` : ''}
                        </div>
                    `).join('')}
                </div>
            </div>

            <!-- Call Signs Section -->
            <div class="comm-section">
                <div class="comm-section__header">
                    <span class="comm-section__title">${Icons.get('userCheck')} Call Signs</span>
                    <button class="btn btn--secondary btn--sm" id="add-callsign-btn">
                        ${Icons.get('plus')} Add
                    </button>
                </div>
                <div class="comm-callsign-list">
                    ${plan.callSigns.map(cs => `
                        <div class="comm-callsign" data-callsign-id="${cs.id}">
                            <div class="comm-callsign__sign">${cs.callSign}</div>
                            <div class="comm-callsign__info">
                                <div class="comm-callsign__name">${cs.name}</div>
                                <div class="comm-callsign__role">${cs.role}</div>
                            </div>
                            <div class="comm-callsign__actions">
                                <button class="comm-action-btn" data-edit-callsign="${cs.id}" title="Edit" aria-label="Edit call sign ${Helpers.escapeHtml(cs.callSign)}">
                                    ${Icons.get('edit')}
                                </button>
                                <button class="comm-action-btn comm-action-btn--danger" data-delete-callsign="${cs.id}" title="Delete" aria-label="Delete call sign ${Helpers.escapeHtml(cs.callSign)}">
                                    ${Icons.get('trash')}
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>

            <!-- Check-in Schedule Section -->
            <div class="comm-section">
                <div class="comm-section__header">
                    <span class="comm-section__title">${Icons.get('calendar')} Check-in Schedule</span>
                    <button class="btn btn--secondary btn--sm" id="add-checkin-btn">
                        ${Icons.get('plus')} Add
                    </button>
                </div>
                <label class="checkbox-field" style="margin-bottom: 12px;">
                    <input type="checkbox" id="schedule-enabled" ${plan.schedule.enabled ? 'checked' : ''} style="width:auto">
                    <span>Enable scheduled check-ins</span>
                </label>
                ${plan.schedule.enabled ? `
                    <div class="comm-schedule-list">
                        ${plan.schedule.checkIns.map(ck => {
                            const ch = plan.channels.find(c => c.id === ck.channel);
                            return `
                                <div class="comm-checkin" data-checkin-id="${ck.id}">
                                    <div class="comm-checkin__time">${ck.time}</div>
                                    <div class="comm-checkin__info">
                                        <div class="comm-checkin__channel">${ch?.name || 'Unknown channel'} (${ch?.frequency || '?'} MHz)</div>
                                        <div class="comm-checkin__notes">${ck.notes}</div>
                                    </div>
                                    <div class="comm-checkin__type comm-checkin__type--${ck.type}">${ck.type}</div>
                                    <div class="comm-checkin__actions">
                                        <button class="comm-action-btn" data-edit-checkin="${ck.id}" title="Edit" aria-label="Edit check-in">
                                            ${Icons.get('edit')}
                                        </button>
                                        <button class="comm-action-btn comm-action-btn--danger" data-delete-checkin="${ck.id}" title="Delete" aria-label="Delete check-in">
                                            ${Icons.get('trash')}
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div class="comm-missed-protocol">
                        <div class="comm-missed-protocol__label">Missed Check-in Protocol:</div>
                        <textarea id="missed-protocol-text" class="comm-missed-protocol__text" rows="3">${plan.schedule.missedCheckInProtocol}</textarea>
                    </div>
                ` : `
                    <div class="comm-schedule-disabled">
                        Check-in schedule is disabled. Enable above to set scheduled radio check-ins.
                    </div>
                `}
            </div>

            <!-- Emergency Protocols Section -->
            <div class="comm-section">
                <div class="comm-section__header">
                    <span class="comm-section__title">${Icons.get('alertTriangle')} Emergency Protocols</span>
                </div>
                
                <div class="comm-emergency-words">
                    <div class="comm-emergency-word">
                        <label>Distress Word</label>
                        <input type="text" id="distress-word" value="${plan.emergency.distressWord}" placeholder="e.g., MAYDAY">
                        <div class="comm-emergency-word__hint">Spoken to indicate a real emergency</div>
                    </div>
                    <div class="comm-emergency-word">
                        <label>Duress Word</label>
                        <input type="text" id="duress-word" value="${plan.emergency.duressWord}" placeholder="e.g., UNCLE">
                        <div class="comm-emergency-word__hint">Covert signal indicating distress under duress</div>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 16px;">
                    <label>Emergency Channel</label>
                    <select id="emergency-channel">
                        ${plan.channels.map(ch => `
                            <option value="${ch.id}" ${ch.id === plan.emergency.emergencyChannel ? 'selected' : ''}>
                                ${ch.name} (${ch.frequency} MHz)
                            </option>
                        `).join('')}
                    </select>
                </div>

                <div class="form-group">
                    <label>Rally Point</label>
                    <input type="text" id="rally-point" value="${plan.emergency.rallyPoint}" placeholder="Enter rally point location">
                </div>

                <div class="comm-protocols-list">
                    <div class="section-label" style="margin-top: 16px;">Emergency Procedures</div>
                    ${plan.emergency.protocols.map(ep => `
                        <div class="comm-protocol" data-protocol-id="${ep.id}">
                            <div class="comm-protocol__header">
                                <div class="comm-protocol__situation">${ep.situation}</div>
                                <div class="comm-protocol__actions">
                                    <button class="comm-action-btn" data-edit-protocol="${ep.id}" title="Edit" aria-label="Edit protocol ${Helpers.escapeHtml(ep.name)}">
                                        ${Icons.get('edit')}
                                    </button>
                                    <button class="comm-action-btn comm-action-btn--danger" data-delete-protocol="${ep.id}" title="Delete" aria-label="Delete protocol ${Helpers.escapeHtml(ep.name)}">
                                        ${Icons.get('trash')}
                                    </button>
                                </div>
                            </div>
                            <div class="comm-protocol__procedure">${ep.procedure.replace(/\n/g, '<br>')}</div>
                        </div>
                    `).join('')}
                    <button class="btn btn--secondary btn--full" id="add-protocol-btn" style="margin-top: 12px;">
                        ${Icons.get('plus')} Add Emergency Procedure
                    </button>
                </div>
            </div>

            <!-- Notes Section -->
            <div class="comm-section">
                <div class="comm-section__header">
                    <span class="comm-section__title">${Icons.get('edit')} Additional Notes</span>
                </div>
                <textarea id="comm-notes" class="comm-notes-textarea" rows="4" placeholder="Additional communication notes, frequencies, or instructions...">${plan.notes}</textarea>
            </div>

            <!-- Save Button -->
            <button class="btn btn--primary btn--full" id="save-comm-plan" style="margin-top: 20px;">
                ${Icons.get('check')} Save Communication Plan
            </button>
        `;

        // Bind event handlers
        bindCommsEvents();
    }

    /**
     * Get the next scheduled check-in
     */
    function getNextCheckIn(checkIns) {
        if (!checkIns || checkIns.length === 0) return null;
        
        const now = new Date();
        const currentMinutes = now.getHours() * 60 + now.getMinutes();
        
        // Sort by time and find next one
        const sorted = [...checkIns].sort((a, b) => {
            const [aH, aM] = a.time.split(':').map(Number);
            const [bH, bM] = b.time.split(':').map(Number);
            return (aH * 60 + aM) - (bH * 60 + bM);
        });
        
        for (const ck of sorted) {
            const [h, m] = ck.time.split(':').map(Number);
            if (h * 60 + m > currentMinutes) {
                return ck;
            }
        }
        
        // If all check-ins passed, return first one (next day)
        return sorted[0];
    }

    /**
     * Bind event handlers for communication plan.
     * All click/change events are now handled by setupEventDelegation().
     * This function is retained for any future non-delegatable bindings.
     */
    function bindCommsEvents() {
        // All comm plan events are now handled via event delegation in
        // handleDelegatedClick() and handleDelegatedChange()
    }

    /**
     * Open channel edit modal
     */
    function openChannelModal(channel = null) {
        const isNew = !channel;
        const ch = channel || { id: '', name: '', frequency: '', mode: 'FM', tone: '', power: 'High', isPrimary: false, notes: '' };
        
        // Uses cached modalContainer ref
        modalContainer.innerHTML = `
            <div class="modal-backdrop" id="comm-modal-backdrop" role="presentation">
                <div class="modal">
                    <div class="modal__header">
                        <h3 class="modal__title">${isNew ? 'Add Channel' : 'Edit Channel'}</h3>
                        <button class="modal__close" id="comm-modal-close" aria-label="Close dialog">${Icons.get('close')}</button>
                    </div>
                    <div class="modal__body">
                        <div class="form-group">
                            <label>Channel Name</label>
                            <input type="text" id="ch-name" value="${ch.name}" placeholder="e.g., Primary, Tactical">
                        </div>
                        <div class="form-group">
                            <label>Frequency (MHz)</label>
                            <input type="text" id="ch-freq" value="${ch.frequency}" placeholder="e.g., 146.520">
                        </div>
                        <div class="form-group">
                            <label>Mode</label>
                            <select id="ch-mode">
                                <option value="FM" ${ch.mode === 'FM' ? 'selected' : ''}>FM</option>
                                <option value="NFM" ${ch.mode === 'NFM' ? 'selected' : ''}>NFM (Narrow FM)</option>
                                <option value="AM" ${ch.mode === 'AM' ? 'selected' : ''}>AM</option>
                                <option value="SSB" ${ch.mode === 'SSB' ? 'selected' : ''}>SSB</option>
                                <option value="DMR" ${ch.mode === 'DMR' ? 'selected' : ''}>DMR</option>
                                <option value="P25" ${ch.mode === 'P25' ? 'selected' : ''}>P25</option>
                                <option value="FRS" ${ch.mode === 'FRS' ? 'selected' : ''}>FRS/GMRS</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>CTCSS/DCS Tone (optional)</label>
                            <input type="text" id="ch-tone" value="${ch.tone}" placeholder="e.g., 100.0 or D023">
                        </div>
                        <div class="form-group">
                            <label>Power Level</label>
                            <select id="ch-power">
                                <option value="Low" ${ch.power === 'Low' ? 'selected' : ''}>Low</option>
                                <option value="Medium" ${ch.power === 'Medium' ? 'selected' : ''}>Medium</option>
                                <option value="High" ${ch.power === 'High' ? 'selected' : ''}>High</option>
                            </select>
                        </div>
                        <label class="checkbox-field">
                            <input type="checkbox" id="ch-primary" ${ch.isPrimary ? 'checked' : ''} style="width:auto">
                            <span>Primary channel</span>
                        </label>
                        <div class="form-group" style="margin-top:12px">
                            <label>Notes</label>
                            <textarea id="ch-notes" rows="2" placeholder="Additional notes...">${ch.notes}</textarea>
                        </div>
                    </div>
                    <div class="modal__footer">
                        <button class="btn btn--secondary" id="comm-modal-cancel">Cancel</button>
                        <button class="btn btn--primary" id="comm-modal-save">${isNew ? 'Add Channel' : 'Save Changes'}</button>
                    </div>
                </div>
            </div>
        `;

        // Bind modal events
        modalContainer.querySelector('#comm-modal-close').onclick = () => modalContainer.innerHTML = '';
        modalContainer.querySelector('#comm-modal-cancel').onclick = () => modalContainer.innerHTML = '';
        modalContainer.querySelector('#comm-modal-backdrop').onclick = (e) => {
            if (e.target.id === 'comm-modal-backdrop') modalContainer.innerHTML = '';
        };

        modalContainer.querySelector('#comm-modal-save').onclick = async () => {
            const newChannel = {
                id: ch.id || Helpers.generateId(),
                name: modalContainer.querySelector('#ch-name').value || 'Unnamed',
                frequency: modalContainer.querySelector('#ch-freq').value || '',
                mode: modalContainer.querySelector('#ch-mode').value,
                tone: modalContainer.querySelector('#ch-tone').value,
                power: modalContainer.querySelector('#ch-power').value,
                isPrimary: modalContainer.querySelector('#ch-primary').checked,
                notes: modalContainer.querySelector('#ch-notes').value
            };

            // If this is primary, unset others
            if (newChannel.isPrimary) {
                commPlan.channels.forEach(c => c.isPrimary = false);
            }

            if (isNew) {
                commPlan.channels.push(newChannel);
            } else {
                const idx = commPlan.channels.findIndex(c => c.id === ch.id);
                if (idx >= 0) commPlan.channels[idx] = newChannel;
            }

            await saveCommPlan();
            modalContainer.innerHTML = '';
            renderComms();
        };
    }

    /**
     * Open call sign edit modal
     */
    function openCallSignModal(callSign = null) {
        const isNew = !callSign;
        const cs = callSign || { id: '', name: '', callSign: '', role: '', notes: '' };
        
        // Uses cached modalContainer ref
        modalContainer.innerHTML = `
            <div class="modal-backdrop" id="comm-modal-backdrop" role="presentation">
                <div class="modal">
                    <div class="modal__header">
                        <h3 class="modal__title">${isNew ? 'Add Call Sign' : 'Edit Call Sign'}</h3>
                        <button class="modal__close" id="comm-modal-close" aria-label="Close dialog">${Icons.get('close')}</button>
                    </div>
                    <div class="modal__body">
                        <div class="form-group">
                            <label>Name / Identifier</label>
                            <input type="text" id="cs-name" value="${cs.name}" placeholder="e.g., Team Lead, John">
                        </div>
                        <div class="form-group">
                            <label>Call Sign</label>
                            <input type="text" id="cs-callsign" value="${cs.callSign}" placeholder="e.g., Alpha-1, KD6ABC">
                        </div>
                        <div class="form-group">
                            <label>Role</label>
                            <input type="text" id="cs-role" value="${cs.role}" placeholder="e.g., Command, Scout, Support">
                        </div>
                        <div class="form-group">
                            <label>Notes</label>
                            <textarea id="cs-notes" rows="2" placeholder="Additional notes...">${cs.notes}</textarea>
                        </div>
                    </div>
                    <div class="modal__footer">
                        <button class="btn btn--secondary" id="comm-modal-cancel">Cancel</button>
                        <button class="btn btn--primary" id="comm-modal-save">${isNew ? 'Add Call Sign' : 'Save Changes'}</button>
                    </div>
                </div>
            </div>
        `;

        modalContainer.querySelector('#comm-modal-close').onclick = () => modalContainer.innerHTML = '';
        modalContainer.querySelector('#comm-modal-cancel').onclick = () => modalContainer.innerHTML = '';
        modalContainer.querySelector('#comm-modal-backdrop').onclick = (e) => {
            if (e.target.id === 'comm-modal-backdrop') modalContainer.innerHTML = '';
        };

        modalContainer.querySelector('#comm-modal-save').onclick = async () => {
            const newCS = {
                id: cs.id || Helpers.generateId(),
                name: modalContainer.querySelector('#cs-name').value || 'Unnamed',
                callSign: modalContainer.querySelector('#cs-callsign').value || '',
                role: modalContainer.querySelector('#cs-role').value || '',
                notes: modalContainer.querySelector('#cs-notes').value
            };

            if (isNew) {
                commPlan.callSigns.push(newCS);
            } else {
                const idx = commPlan.callSigns.findIndex(c => c.id === cs.id);
                if (idx >= 0) commPlan.callSigns[idx] = newCS;
            }

            await saveCommPlan();
            modalContainer.innerHTML = '';
            renderComms();
        };
    }

    /**
     * Open check-in schedule modal
     */
    function openCheckInModal(checkIn = null) {
        const isNew = !checkIn;
        const ck = checkIn || { id: '', time: '12:00', channel: commPlan.channels[0]?.id || '', type: 'routine', notes: '' };
        
        // Uses cached modalContainer ref
        modalContainer.innerHTML = `
            <div class="modal-backdrop" id="comm-modal-backdrop" role="presentation">
                <div class="modal">
                    <div class="modal__header">
                        <h3 class="modal__title">${isNew ? 'Add Check-in' : 'Edit Check-in'}</h3>
                        <button class="modal__close" id="comm-modal-close" aria-label="Close dialog">${Icons.get('close')}</button>
                    </div>
                    <div class="modal__body">
                        <div class="form-group">
                            <label>Time</label>
                            <input type="time" id="ck-time" value="${ck.time}">
                        </div>
                        <div class="form-group">
                            <label>Channel</label>
                            <select id="ck-channel">
                                ${commPlan.channels.map(ch => `
                                    <option value="${ch.id}" ${ch.id === ck.channel ? 'selected' : ''}>
                                        ${ch.name} (${ch.frequency} MHz)
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Type</label>
                            <select id="ck-type">
                                <option value="routine" ${ck.type === 'routine' ? 'selected' : ''}>Routine</option>
                                <option value="mandatory" ${ck.type === 'mandatory' ? 'selected' : ''}>Mandatory</option>
                                <option value="optional" ${ck.type === 'optional' ? 'selected' : ''}>Optional</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Notes</label>
                            <input type="text" id="ck-notes" value="${ck.notes}" placeholder="e.g., Morning check-in">
                        </div>
                    </div>
                    <div class="modal__footer">
                        <button class="btn btn--secondary" id="comm-modal-cancel">Cancel</button>
                        <button class="btn btn--primary" id="comm-modal-save">${isNew ? 'Add Check-in' : 'Save Changes'}</button>
                    </div>
                </div>
            </div>
        `;

        modalContainer.querySelector('#comm-modal-close').onclick = () => modalContainer.innerHTML = '';
        modalContainer.querySelector('#comm-modal-cancel').onclick = () => modalContainer.innerHTML = '';
        modalContainer.querySelector('#comm-modal-backdrop').onclick = (e) => {
            if (e.target.id === 'comm-modal-backdrop') modalContainer.innerHTML = '';
        };

        modalContainer.querySelector('#comm-modal-save').onclick = async () => {
            const newCK = {
                id: ck.id || Helpers.generateId(),
                time: modalContainer.querySelector('#ck-time').value || '12:00',
                channel: modalContainer.querySelector('#ck-channel').value,
                type: modalContainer.querySelector('#ck-type').value,
                notes: modalContainer.querySelector('#ck-notes').value
            };

            if (isNew) {
                commPlan.schedule.checkIns.push(newCK);
            } else {
                const idx = commPlan.schedule.checkIns.findIndex(c => c.id === ck.id);
                if (idx >= 0) commPlan.schedule.checkIns[idx] = newCK;
            }

            await saveCommPlan();
            modalContainer.innerHTML = '';
            renderComms();
        };
    }

    /**
     * Open emergency protocol modal
     */
    function openProtocolModal(protocol = null) {
        const isNew = !protocol;
        const ep = protocol || { id: '', situation: '', procedure: '' };
        
        // Uses cached modalContainer ref
        modalContainer.innerHTML = `
            <div class="modal-backdrop" id="comm-modal-backdrop" role="presentation">
                <div class="modal">
                    <div class="modal__header">
                        <h3 class="modal__title">${isNew ? 'Add Emergency Protocol' : 'Edit Protocol'}</h3>
                        <button class="modal__close" id="comm-modal-close" aria-label="Close dialog">${Icons.get('close')}</button>
                    </div>
                    <div class="modal__body">
                        <div class="form-group">
                            <label>Situation</label>
                            <input type="text" id="ep-situation" value="${ep.situation}" placeholder="e.g., Medical Emergency, Lost/Separated">
                        </div>
                        <div class="form-group">
                            <label>Procedure</label>
                            <textarea id="ep-procedure" rows="6" placeholder="Step-by-step procedure...">${ep.procedure}</textarea>
                        </div>
                    </div>
                    <div class="modal__footer">
                        <button class="btn btn--secondary" id="comm-modal-cancel">Cancel</button>
                        <button class="btn btn--primary" id="comm-modal-save">${isNew ? 'Add Protocol' : 'Save Changes'}</button>
                    </div>
                </div>
            </div>
        `;

        modalContainer.querySelector('#comm-modal-close').onclick = () => modalContainer.innerHTML = '';
        modalContainer.querySelector('#comm-modal-cancel').onclick = () => modalContainer.innerHTML = '';
        modalContainer.querySelector('#comm-modal-backdrop').onclick = (e) => {
            if (e.target.id === 'comm-modal-backdrop') modalContainer.innerHTML = '';
        };

        modalContainer.querySelector('#comm-modal-save').onclick = async () => {
            const newEP = {
                id: ep.id || Helpers.generateId(),
                situation: modalContainer.querySelector('#ep-situation').value || 'Unnamed',
                procedure: modalContainer.querySelector('#ep-procedure').value || ''
            };

            if (isNew) {
                commPlan.emergency.protocols.push(newEP);
            } else {
                const idx = commPlan.emergency.protocols.findIndex(p => p.id === ep.id);
                if (idx >= 0) commPlan.emergency.protocols[idx] = newEP;
            }

            await saveCommPlan();
            modalContainer.innerHTML = '';
            renderComms();
        };
    }

    /**
     * Export communication plan as text/JSON
     */
    function exportCommPlan() {
        const plan = commPlan;
        
        // Generate readable text export
        let text = `COMMUNICATION PLAN\n`;
        text += `==================\n`;
        text += `Generated: ${new Date().toLocaleString()}\n\n`;
        
        text += `RADIO CHANNELS\n`;
        text += `--------------\n`;
        plan.channels.forEach(ch => {
            text += `${ch.isPrimary ? '[PRIMARY] ' : ''}${ch.name}: ${ch.frequency} MHz ${ch.mode}`;
            if (ch.tone) text += ` (CTCSS ${ch.tone})`;
            text += ` - ${ch.power} power\n`;
            if (ch.notes) text += `  Notes: ${ch.notes}\n`;
        });
        
        text += `\nCALL SIGNS\n`;
        text += `----------\n`;
        plan.callSigns.forEach(cs => {
            text += `${cs.callSign}: ${cs.name} (${cs.role})\n`;
        });
        
        if (plan.schedule.enabled) {
            text += `\nCHECK-IN SCHEDULE\n`;
            text += `-----------------\n`;
            plan.schedule.checkIns.forEach(ck => {
                const ch = plan.channels.find(c => c.id === ck.channel);
                text += `${ck.time} - ${ch?.name || 'Unknown'} (${ck.type}) ${ck.notes}\n`;
            });
            text += `\nMissed Check-in Protocol:\n${plan.schedule.missedCheckInProtocol}\n`;
        }
        
        text += `\nEMERGENCY PROTOCOLS\n`;
        text += `-------------------\n`;
        text += `Distress Word: ${plan.emergency.distressWord}\n`;
        text += `Duress Word: ${plan.emergency.duressWord}\n`;
        text += `Rally Point: ${plan.emergency.rallyPoint}\n`;
        const emergCh = plan.channels.find(c => c.id === plan.emergency.emergencyChannel);
        text += `Emergency Channel: ${emergCh?.name || 'Primary'} (${emergCh?.frequency || ''} MHz)\n\n`;
        
        plan.emergency.protocols.forEach(ep => {
            text += `${ep.situation}:\n`;
            text += `${ep.procedure}\n\n`;
        });
        
        if (plan.notes) {
            text += `\nADDITIONAL NOTES\n`;
            text += `----------------\n`;
            text += plan.notes + '\n';
        }
        
        // Download as file
        const blob = new Blob([text], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `comm-plan-${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showCommToast('Communication plan exported');
    }

    // ==================== Terrain Analysis Panel ====================
    
    // Terrain analysis state
    let terrainAnalysis = null;
    let terrainAnalyzing = false;
    let terrainProgress = 0;
    let terrainLocation = null;
    
    /**
     * Render the Terrain Analysis panel
     */
    async function renderTerrain() {
        // Use getPosition() for synchronous access to cached position
        // (getCurrentPosition() returns a Promise)
        const gpsPos = GPSModule.getPosition();
        const selectedWp = State.get('selectedWaypoint');
        
        // Determine analysis location
        let analyzeLocation = terrainLocation;
        if (!analyzeLocation && gpsPos) {
            analyzeLocation = { lat: gpsPos.lat, lon: gpsPos.lon, source: 'GPS' };
        } else if (!analyzeLocation && selectedWp) {
            const lat = selectedWp.lat || (37.4215 + (selectedWp.y - 50) * 0.002);
            const lon = selectedWp.lon || (-119.1892 + (selectedWp.x - 50) * 0.004);
            analyzeLocation = { lat, lon, source: selectedWp.name };
        }
        
        container.innerHTML = `
            <div class="panel__header">
                <h2 class="panel__title">${Icons.get('mountain')} Terrain Analysis</h2>
            </div>
            
            <!-- Location Selection -->
            <div class="terrain-section">
                <div class="terrain-section__header">
                    <span class="terrain-section__title">üìç Analysis Location</span>
                </div>
                
                <div class="terrain-location-selector">
                    ${analyzeLocation ? `
                        <div class="terrain-location-current">
                            <div class="terrain-location-coords">
                                <span class="terrain-coord-value">${analyzeLocation.lat.toFixed(5)}¬∞</span>
                                <span class="terrain-coord-value">${analyzeLocation.lon.toFixed(5)}¬∞</span>
                            </div>
                            <div class="terrain-location-source">Source: ${analyzeLocation.source || 'Manual'}</div>
                        </div>
                    ` : `
                        <div class="terrain-no-location">
                            No location selected. Use GPS or select a waypoint.
                        </div>
                    `}
                    
                    <div class="terrain-location-actions">
                        <button class="btn btn--secondary" id="terrain-use-gps" ${!gpsPos ? 'disabled' : ''}>
                            ${Icons.get('locate')} Use GPS
                        </button>
                        <button class="btn btn--secondary" id="terrain-use-map">
                            ${Icons.get('map')} Pick on Map
                        </button>
                    </div>
                    
                    <div class="terrain-manual-coords" style="margin-top:12px">
                        <div style="display:flex;gap:8px">
                            <input type="number" id="terrain-lat" placeholder="Latitude" 
                                value="${analyzeLocation?.lat?.toFixed(6) || ''}" step="0.000001" style="flex:1">
                            <input type="number" id="terrain-lon" placeholder="Longitude" 
                                value="${analyzeLocation?.lon?.toFixed(6) || ''}" step="0.000001" style="flex:1">
                        </div>
                        <button class="btn btn--secondary btn--full" id="terrain-set-coords" style="margin-top:8px">
                            Set Coordinates
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Analysis Options -->
            <div class="terrain-section">
                <div class="terrain-section__header">
                    <span class="terrain-section__title">‚öôÔ∏è Analysis Options</span>
                </div>
                
                <div class="terrain-options">
                    <div class="terrain-option">
                        <label>Analysis Radius</label>
                        <select id="terrain-radius">
                            <option value="250">250m (Quick)</option>
                            <option value="500" selected>500m (Standard)</option>
                            <option value="1000">1km (Extended)</option>
                            <option value="2000">2km (Wide Area)</option>
                        </select>
                    </div>
                    
                    <div class="terrain-option">
                        <label>Grid Resolution</label>
                        <select id="terrain-resolution">
                            <option value="20">20m (High Detail)</option>
                            <option value="30" selected>30m (Standard)</option>
                            <option value="50">50m (Fast)</option>
                        </select>
                    </div>
                    
                    <div class="terrain-checkboxes">
                        <label class="terrain-checkbox">
                            <input type="checkbox" id="terrain-opt-viewshed" checked>
                            <span>Viewshed Analysis</span>
                        </label>
                        <label class="terrain-checkbox">
                            <input type="checkbox" id="terrain-opt-flood" checked>
                            <span>Flood Risk</span>
                        </label>
                        <label class="terrain-checkbox">
                            <input type="checkbox" id="terrain-opt-cover" checked>
                            <span>Cover & Concealment</span>
                        </label>
                    </div>
                </div>
                
                <button class="btn btn--primary btn--full" id="terrain-analyze" 
                    ${!analyzeLocation || terrainAnalyzing ? 'disabled' : ''}>
                    ${terrainAnalyzing ? `Analyzing... ${terrainProgress}%` : `${Icons.get('layers')} Analyze Terrain`}
                </button>
                
                ${terrainAnalyzing ? `
                    <div class="terrain-progress">
                        <div class="terrain-progress__bar" style="width:${terrainProgress}%"></div>
                    </div>
                ` : ''}
            </div>
            
            ${terrainAnalysis ? renderTerrainResults(terrainAnalysis) : `
                <div class="terrain-section">
                    <div class="terrain-empty-state">
                        <div class="terrain-empty-icon">${Icons.get('mountain')}</div>
                        <div class="terrain-empty-text">Select a location and run analysis to see terrain characteristics</div>
                    </div>
                </div>
            `}
        `;
        
        // Event handlers
        setupTerrainEventHandlers(analyzeLocation, gpsPos, selectedWp);
    }
    
    /**
     * Render terrain analysis results
     */
    function renderTerrainResults(analysis) {
        const point = analysis.pointAnalysis || {};
        const slope = analysis.slope?.statistics || {};
        const viewshed = analysis.viewshed || {};
        const flood = analysis.floodRisk || {};
        const cover = analysis.coverConcealment || {};
        const solar = analysis.solarExposure || {};
        const traffic = analysis.trafficability || {};
        
        return `
            <!-- Point Summary -->
            <div class="terrain-section terrain-results">
                <div class="terrain-section__header">
                    <span class="terrain-section__title">üìä Point Summary</span>
                </div>
                
                <div class="terrain-summary-grid">
                    <div class="terrain-summary-item">
                        <div class="terrain-summary-label">Elevation</div>
                        <div class="terrain-summary-value">${Math.round(analysis.centerElevation || 0)}m</div>
                        <div class="terrain-summary-sub">${Math.round((analysis.centerElevation || 0) * 3.281)}ft</div>
                    </div>
                    <div class="terrain-summary-item">
                        <div class="terrain-summary-label">Slope</div>
                        <div class="terrain-summary-value ${getSlopeColorClass(point.slope)}">${point.slope?.toFixed(1) || 0}¬∞</div>
                        <div class="terrain-summary-sub">${point.slopeClass || 'flat'}</div>
                    </div>
                    <div class="terrain-summary-item">
                        <div class="terrain-summary-label">Aspect</div>
                        <div class="terrain-summary-value">${point.aspectClass || 'N/A'}</div>
                        <div class="terrain-summary-sub">${Math.round(point.aspect || 0)}¬∞</div>
                    </div>
                    <div class="terrain-summary-item">
                        <div class="terrain-summary-label">Visibility</div>
                        <div class="terrain-summary-value ${viewshed.coverage > 50 ? 'terrain-good' : 'terrain-warn'}">${viewshed.coverage || 0}%</div>
                        <div class="terrain-summary-sub">coverage</div>
                    </div>
                </div>
            </div>
            
            <!-- Slope Analysis -->
            <div class="terrain-section">
                <div class="terrain-section__header">
                    <span class="terrain-section__title">‚õ∞Ô∏è Slope Analysis</span>
                    <button class="terrain-collapse-btn" data-section="slope">‚ñº</button>
                </div>
                
                <div class="terrain-section__content" id="terrain-slope-content">
                    <div class="terrain-slope-stats">
                        <div class="terrain-stat-row">
                            <span class="terrain-stat-label">Min Slope</span>
                            <span class="terrain-stat-value">${slope.min?.toFixed(1) || 0}¬∞</span>
                        </div>
                        <div class="terrain-stat-row">
                            <span class="terrain-stat-label">Max Slope</span>
                            <span class="terrain-stat-value">${slope.max?.toFixed(1) || 0}¬∞</span>
                        </div>
                        <div class="terrain-stat-row">
                            <span class="terrain-stat-label">Average Slope</span>
                            <span class="terrain-stat-value">${slope.mean?.toFixed(1) || 0}¬∞</span>
                        </div>
                    </div>
                    
                    <div class="terrain-slope-distribution">
                        <div class="terrain-dist-label">Slope Distribution</div>
                        <div class="terrain-dist-bars">
                            ${renderSlopeDistribution(slope.distribution, slope.percentages)}
                        </div>
                    </div>
                    
                    <!-- Slope thresholds reference -->
                    <div class="terrain-reference">
                        <div class="terrain-ref-title">Slope Classification</div>
                        <div class="terrain-ref-items">
                            <span class="terrain-ref-item terrain-slope-flat">0-5¬∞ Flat</span>
                            <span class="terrain-ref-item terrain-slope-gentle">5-15¬∞ Gentle</span>
                            <span class="terrain-ref-item terrain-slope-moderate">15-25¬∞ Moderate</span>
                            <span class="terrain-ref-item terrain-slope-steep">25-35¬∞ Steep</span>
                            <span class="terrain-ref-item terrain-slope-extreme">35¬∞+ Extreme</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Trafficability -->
            <div class="terrain-section">
                <div class="terrain-section__header">
                    <span class="terrain-section__title">üöó Trafficability</span>
                    <button class="terrain-collapse-btn" data-section="traffic">‚ñº</button>
                </div>
                
                <div class="terrain-section__content" id="terrain-traffic-content">
                    <div class="terrain-traffic-grid">
                        ${renderTrafficability(traffic)}
                    </div>
                </div>
            </div>
            
            <!-- Viewshed -->
            ${viewshed.coverage !== undefined ? `
                <div class="terrain-section">
                    <div class="terrain-section__header">
                        <span class="terrain-section__title">üëÅÔ∏è Viewshed Analysis</span>
                        <button class="terrain-collapse-btn" data-section="viewshed">‚ñº</button>
                    </div>
                    
                    <div class="terrain-section__content" id="terrain-viewshed-content">
                        <div class="terrain-viewshed-summary">
                            <div class="terrain-viewshed-coverage">
                                <div class="terrain-viewshed-percent">${viewshed.coverage}%</div>
                                <div class="terrain-viewshed-label">Terrain Visible</div>
                            </div>
                            <div class="terrain-viewshed-stats">
                                <div class="terrain-stat-row">
                                    <span class="terrain-stat-label">Max Visible Range</span>
                                    <span class="terrain-stat-value">${viewshed.maxVisibleDistance ? Math.round(viewshed.maxVisibleDistance) + 'm' : 'N/A'}</span>
                                </div>
                                <div class="terrain-stat-row">
                                    <span class="terrain-stat-label">Visible Points</span>
                                    <span class="terrain-stat-value">${viewshed.visible?.length || 0}</span>
                                </div>
                                <div class="terrain-stat-row">
                                    <span class="terrain-stat-label">Hidden Points</span>
                                    <span class="terrain-stat-value">${viewshed.hidden?.length || 0}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="terrain-viewshed-assessment">
                            ${viewshed.coverage > 70 ? `
                                <div class="terrain-assessment terrain-assessment--good">
                                    ${Icons.get('check')} Excellent observation point with wide field of view
                                </div>
                            ` : viewshed.coverage > 40 ? `
                                <div class="terrain-assessment terrain-assessment--moderate">
                                    ${Icons.get('alert')} Moderate visibility - some terrain masked
                                </div>
                            ` : `
                                <div class="terrain-assessment terrain-assessment--poor">
                                    ${Icons.get('alert')} Limited visibility - significant blind spots
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            ` : ''}
            
            <!-- Solar Exposure -->
            ${solar.exposureScore !== undefined ? `
                <div class="terrain-section">
                    <div class="terrain-section__header">
                        <span class="terrain-section__title">‚òÄÔ∏è Solar Exposure</span>
                        <button class="terrain-collapse-btn" data-section="solar">‚ñº</button>
                    </div>
                    
                    <div class="terrain-section__content" id="terrain-solar-content">
                        <div class="terrain-solar-summary">
                            <div class="terrain-solar-score ${getSolarScoreClass(solar.exposureScore)}">
                                <div class="terrain-solar-value">${solar.exposureScore}%</div>
                                <div class="terrain-solar-label">${solar.exposureClass?.replace('-', ' ') || 'Unknown'}</div>
                            </div>
                            <div class="terrain-solar-details">
                                <div class="terrain-stat-row">
                                    <span class="terrain-stat-label">Est. Sun Hours</span>
                                    <span class="terrain-stat-value">${solar.estimatedSunHours || 0}h</span>
                                </div>
                                <div class="terrain-stat-row">
                                    <span class="terrain-stat-label">Best Sun Direction</span>
                                    <span class="terrain-stat-value">${solar.sunDirection || 'South'}</span>
                                </div>
                                <div class="terrain-stat-row">
                                    <span class="terrain-stat-label">Aspect Alignment</span>
                                    <span class="terrain-stat-value">${solar.aspectAlignment || 0}%</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="terrain-solar-recommendations">
                            ${solar.idealForCamping ? `
                                <div class="terrain-rec terrain-rec--good">
                                    ‚úì Good exposure for camping - balanced sun/shade
                                </div>
                            ` : ''}
                            ${solar.shaded ? `
                                <div class="terrain-rec terrain-rec--info">
                                    ‚ÑπÔ∏è Mostly shaded - good for hot weather, cold in winter
                                </div>
                            ` : ''}
                            ${solar.exposureScore > 80 ? `
                                <div class="terrain-rec terrain-rec--warn">
                                    ‚ö†Ô∏è High sun exposure - consider shade/shelter needs
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            ` : ''}
            
            <!-- Flood Risk -->
            ${flood.riskLevel ? `
                <div class="terrain-section">
                    <div class="terrain-section__header">
                        <span class="terrain-section__title">üíß Flood Risk Assessment</span>
                        <button class="terrain-collapse-btn" data-section="flood">‚ñº</button>
                    </div>
                    
                    <div class="terrain-section__content" id="terrain-flood-content">
                        <div class="terrain-flood-summary ${getFloodRiskClass(flood.riskLevel)}">
                            <div class="terrain-flood-level">${flood.riskLevel?.toUpperCase()}</div>
                            <div class="terrain-flood-score">Risk Score: ${flood.riskScore || 0}/100</div>
                        </div>
                        
                        ${flood.risks?.length > 0 ? `
                            <div class="terrain-flood-factors">
                                <div class="terrain-factors-title">Risk Factors</div>
                                ${flood.risks.map(r => `
                                    <div class="terrain-factor terrain-factor--${r.severity}">
                                        <span class="terrain-factor-type">${r.type.replace('-', ' ')}</span>
                                        <span class="terrain-factor-desc">${r.description}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        <div class="terrain-flood-rec">
                            <strong>Recommendation:</strong> ${flood.recommendation || 'No specific concerns.'}
                        </div>
                    </div>
                </div>
            ` : ''}
            
            <!-- Cover & Concealment -->
            ${cover.defilade ? `
                <div class="terrain-section">
                    <div class="terrain-section__header">
                        <span class="terrain-section__title">üõ°Ô∏è Cover & Concealment</span>
                        <button class="terrain-collapse-btn" data-section="cover">‚ñº</button>
                    </div>
                    
                    <div class="terrain-section__content" id="terrain-cover-content">
                        <div class="terrain-cover-summary">
                            <div class="terrain-cover-rating">
                                <div class="terrain-cover-score">${cover.concealmentRating || 0}%</div>
                                <div class="terrain-cover-label">Concealment Rating</div>
                            </div>
                            <div class="terrain-cover-details">
                                <div class="terrain-stat-row">
                                    <span class="terrain-stat-label">Terrain Masking</span>
                                    <span class="terrain-stat-value">${cover.terrainMasking || 0}%</span>
                                </div>
                                <div class="terrain-stat-row">
                                    <span class="terrain-stat-label">Defilade Type</span>
                                    <span class="terrain-stat-value">${cover.defilade?.replace('-', ' ') || 'None'}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="terrain-cover-directions">
                            <div class="terrain-dir-title">Coverage by Direction</div>
                            <div class="terrain-dir-compass">
                                ${renderCoverageCompass(cover.coverDirections, cover.exposedDirections)}
                            </div>
                        </div>
                        
                        ${cover.tacticalNotes?.length > 0 ? `
                            <div class="terrain-tactical-notes">
                                <div class="terrain-notes-title">Tactical Notes</div>
                                ${cover.tacticalNotes.map(note => `
                                    <div class="terrain-note">${note}</div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
            ` : ''}
            
            <!-- Export/Actions -->
            <div class="terrain-section">
                <div class="terrain-actions">
                    <button class="btn btn--secondary" id="terrain-export">
                        ${Icons.get('export')} Export Report
                    </button>
                    <button class="btn btn--secondary" id="terrain-save-waypoint">
                        ${Icons.get('waypoint')} Save as Waypoint
                    </button>
                </div>
            </div>
        `;
    }
    
    /**
     * Setup terrain panel event handlers
     */
    function setupTerrainEventHandlers(analyzeLocation, gpsPos, selectedWp) {
        // Use GPS button
        const useGpsBtn = container.querySelector('#terrain-use-gps');
        if (useGpsBtn) {
            useGpsBtn.onclick = () => {
                if (gpsPos) {
                    terrainLocation = { lat: gpsPos.lat, lon: gpsPos.lon, source: 'GPS' };
                    terrainAnalysis = null;
                    renderTerrain();
                }
            };
        }
        
        // Use map picker
        const useMapBtn = container.querySelector('#terrain-use-map');
        if (useMapBtn) {
            useMapBtn.onclick = () => {
                ModalsModule.showToast('Click on the map to select location', 'info');
                // Set up one-time map click listener
                const handler = (coords) => {
                    terrainLocation = { 
                        lat: coords.lat, 
                        lon: coords.lon, 
                        source: 'Map Selection' 
                    };
                    terrainAnalysis = null;
                    Events.off(Events.EVENTS.MAP_CLICK, handler);
                    State.UI.setActivePanel('terrain');
                    renderTerrain();
                };
                Events.once(Events.EVENTS.MAP_CLICK, handler);
                // Switch to map view on mobile
                if (Helpers.isMobile()) {
                    State.UI.closePanel();
                }
            };
        }
        
        // Set manual coordinates
        const setCoordsBtn = container.querySelector('#terrain-set-coords');
        if (setCoordsBtn) {
            setCoordsBtn.onclick = () => {
                const lat = parseFloat(container.querySelector('#terrain-lat').value);
                const lon = parseFloat(container.querySelector('#terrain-lon').value);
                if (!isNaN(lat) && !isNaN(lon) && lat >= -90 && lat <= 90 && lon >= -180 && lon <= 180) {
                    terrainLocation = { lat, lon, source: 'Manual Entry' };
                    terrainAnalysis = null;
                    renderTerrain();
                } else {
                    ModalsModule.showToast('Invalid coordinates', 'error');
                }
            };
        }
        
        // Analyze button
        const analyzeBtn = container.querySelector('#terrain-analyze');
        if (analyzeBtn) {
            analyzeBtn.onclick = async () => {
                if (!analyzeLocation || terrainAnalyzing) return;
                
                // Read UI options BEFORE renderTerrain() rebuilds the DOM
                const radius = parseInt(container.querySelector('#terrain-radius')?.value || 500);
                const resolution = parseInt(container.querySelector('#terrain-resolution')?.value || 30);
                const includeViewshed = container.querySelector('#terrain-opt-viewshed')?.checked !== false;
                const includeFlood = container.querySelector('#terrain-opt-flood')?.checked !== false;
                const includeCover = container.querySelector('#terrain-opt-cover')?.checked !== false;
                
                terrainAnalyzing = true;
                terrainProgress = 0;
                renderTerrain();
                
                try {
                    terrainAnalysis = await TerrainModule.analyzeSite(
                        analyzeLocation.lat,
                        analyzeLocation.lon,
                        {
                            radius,
                            resolution,
                            includeViewshed,
                            includeFlood,
                            includeCover
                        }
                    );
                    
                    ModalsModule.showToast('Terrain analysis complete', 'success');
                } catch (e) {
                    console.error('Terrain analysis failed:', e);
                    ModalsModule.showToast('Analysis failed: ' + e.message, 'error');
                }
                
                terrainAnalyzing = false;
                terrainProgress = 100;
                renderTerrain();
            };
        }
        
        // Export report
        const exportBtn = container.querySelector('#terrain-export');
        if (exportBtn) {
            exportBtn.onclick = () => exportTerrainReport();
        }
        
        // Save as waypoint
        const saveWpBtn = container.querySelector('#terrain-save-waypoint');
        if (saveWpBtn) {
            saveWpBtn.onclick = () => {
                if (terrainLocation && terrainAnalysis) {
                    const wp = {
                        id: Helpers.generateId(),
                        name: `Terrain Analysis Point`,
                        type: 'custom',
                        lat: terrainLocation.lat,
                        lon: terrainLocation.lon,
                        x: 50 + (terrainLocation.lon + 119.1892) / 0.004,
                        y: 50 + (terrainLocation.lat - 37.4215) / 0.002,
                        notes: `Elevation: ${Math.round(terrainAnalysis.centerElevation || 0)}m, Slope: ${terrainAnalysis.pointAnalysis?.slope?.toFixed(1) || 0}¬∞, Aspect: ${terrainAnalysis.pointAnalysis?.aspectClass || 'N/A'}`,
                        verified: false
                    };
                    State.Waypoints.add(wp);
                    Storage.Waypoints.save(wp);
                    ModalsModule.showToast('Waypoint saved', 'success');
                }
            };
        }
        
        // Collapse toggles
        container.querySelectorAll('.terrain-collapse-btn').forEach(btn => {
            btn.onclick = () => {
                const section = btn.dataset.section;
                const content = container.querySelector(`#terrain-${section}-content`);
                if (content) {
                    content.classList.toggle('collapsed');
                    btn.textContent = content.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
                }
            };
        });
    }
    
    /**
     * Render slope distribution bars
     */
    function renderSlopeDistribution(distribution, percentages) {
        if (!distribution) return '<div class="terrain-no-data">No data available</div>';
        
        const classes = ['flat', 'gentle', 'moderate', 'steep', 'extreme'];
        const colors = {
            flat: '#22c55e',
            gentle: '#84cc16',
            moderate: '#f59e0b',
            steep: '#ef4444',
            extreme: '#7c2d12'
        };
        
        return classes.map(cls => `
            <div class="terrain-dist-bar-container">
                <div class="terrain-dist-bar-label">${cls}</div>
                <div class="terrain-dist-bar-track">
                    <div class="terrain-dist-bar-fill" style="width:${percentages?.[cls] || 0}%;background:${colors[cls]}"></div>
                </div>
                <div class="terrain-dist-bar-value">${percentages?.[cls] || 0}%</div>
            </div>
        `).join('');
    }
    
    /**
     * Render trafficability grid
     */
    function renderTrafficability(traffic) {
        if (!traffic) return '<div class="terrain-no-data">No data available</div>';
        
        const vehicles = [
            { key: 'foot', name: 'On Foot', icon: 'üö∂' },
            { key: 'atv', name: 'ATV/UTV', icon: 'üèçÔ∏è' },
            { key: 'vehicle_4x4', name: '4x4 Vehicle', icon: 'üöô' },
            { key: 'vehicle_standard', name: 'Standard Vehicle', icon: 'üöó' }
        ];
        
        return vehicles.map(v => {
            const data = traffic[v.key];
            if (!data) return '';
            
            const ratingClass = data.passable ? 
                (data.rating === 'easy' ? 'terrain-traffic--pass' : 'terrain-traffic--diff') :
                'terrain-traffic--fail';
            const badge = data.passable ? 
                (data.rating === 'easy' ? '‚úì' : '‚ö†') : '‚úó';
            
            return `
                <div class="terrain-traffic-item ${ratingClass}">
                    <div class="terrain-traffic-icon">${v.icon}</div>
                    <div class="terrain-traffic-info">
                        <div class="terrain-traffic-name">${v.name}</div>
                        <div class="terrain-traffic-status">${data.rating} ‚Äî ${data.description}</div>
                    </div>
                    <div class="terrain-traffic-badge">${badge}</div>
                </div>
            `;
        }).join('');
    }
    
    /**
     * Render coverage compass
     */
    function renderCoverageCompass(covered, exposed) {
        const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
        covered = covered || [];
        exposed = exposed || [];
        
        return `
            <div class="terrain-compass">
                ${directions.map((dir, i) => {
                    const isCovered = covered.includes(dir);
                    const angle = i * 45;
                    return `
                        <div class="terrain-compass-dir" 
                            style="transform:rotate(${angle}deg) translateY(-35px)"
                            data-dir="${dir}">
                            <div class="terrain-compass-marker ${isCovered ? 'covered' : 'exposed'}" 
                                style="transform:rotate(-${angle}deg)">
                                ${dir}
                            </div>
                        </div>
                    `;
                }).join('')}
                <div class="terrain-compass-center">
                    <div class="terrain-compass-legend">
                        <span class="covered">‚óè Covered</span>
                        <span class="exposed">‚óè Exposed</span>
                    </div>
                </div>
            </div>
        `;
    }
    
    /**
     * Get slope color class
     */
    function getSlopeColorClass(slope) {
        if (!slope) return '';
        if (slope < 5) return 'terrain-slope-flat';
        if (slope < 15) return 'terrain-slope-gentle';
        if (slope < 25) return 'terrain-slope-moderate';
        if (slope < 35) return 'terrain-slope-steep';
        return 'terrain-slope-extreme';
    }
    
    /**
     * Get solar score class
     */
    function getSolarScoreClass(score) {
        if (score >= 80) return 'terrain-solar--high';
        if (score >= 50) return 'terrain-solar--medium';
        return 'terrain-solar--low';
    }
    
    /**
     * Get flood risk class
     */
    function getFloodRiskClass(level) {
        switch (level) {
            case 'high': return 'terrain-flood--high';
            case 'moderate': return 'terrain-flood--moderate';
            case 'low': return 'terrain-flood--low';
            default: return 'terrain-flood--minimal';
        }
    }
    
    /**
     * Export terrain report
     */
    function exportTerrainReport() {
        if (!terrainAnalysis || !terrainLocation) {
            ModalsModule.showToast('No analysis to export', 'error');
            return;
        }
        
        const a = terrainAnalysis;
        const p = a.pointAnalysis || {};
        
        let report = `TERRAIN ANALYSIS REPORT\n`;
        report += `========================\n\n`;
        report += `Generated: ${new Date().toLocaleString()}\n`;
        report += `Location: ${terrainLocation.lat.toFixed(6)}¬∞, ${terrainLocation.lon.toFixed(6)}¬∞\n`;
        report += `Source: ${terrainLocation.source || 'Manual'}\n\n`;
        
        report += `POINT SUMMARY\n`;
        report += `-------------\n`;
        report += `Elevation: ${Math.round(a.centerElevation || 0)}m (${Math.round((a.centerElevation || 0) * 3.281)}ft)\n`;
        report += `Slope: ${p.slope?.toFixed(1) || 0}¬∞ (${p.slopeClass || 'flat'})\n`;
        report += `Aspect: ${p.aspectClass || 'N/A'} (${Math.round(p.aspect || 0)}¬∞)\n\n`;
        
        if (a.slope?.statistics) {
            const s = a.slope.statistics;
            report += `SLOPE ANALYSIS\n`;
            report += `--------------\n`;
            report += `Min: ${s.min?.toFixed(1)}¬∞ | Max: ${s.max?.toFixed(1)}¬∞ | Avg: ${s.mean?.toFixed(1)}¬∞\n`;
            report += `Distribution:\n`;
            Object.entries(s.percentages || {}).forEach(([k, v]) => {
                report += `  ${k}: ${v}%\n`;
            });
            report += `\n`;
        }
        
        if (a.viewshed?.coverage !== undefined) {
            report += `VIEWSHED\n`;
            report += `--------\n`;
            report += `Coverage: ${a.viewshed.coverage}%\n`;
            report += `Max Visible: ${a.viewshed.maxVisibleDistance ? Math.round(a.viewshed.maxVisibleDistance) + 'm' : 'N/A'}\n\n`;
        }
        
        if (a.solarExposure) {
            report += `SOLAR EXPOSURE\n`;
            report += `--------------\n`;
            report += `Score: ${a.solarExposure.exposureScore}%\n`;
            report += `Est. Sun Hours: ${a.solarExposure.estimatedSunHours}h\n`;
            report += `Best Direction: ${a.solarExposure.sunDirection}\n\n`;
        }
        
        if (a.floodRisk?.riskLevel) {
            report += `FLOOD RISK\n`;
            report += `----------\n`;
            report += `Level: ${a.floodRisk.riskLevel?.toUpperCase()}\n`;
            report += `Score: ${a.floodRisk.riskScore}/100\n`;
            report += `Recommendation: ${a.floodRisk.recommendation}\n\n`;
        }
        
        if (a.coverConcealment?.defilade) {
            report += `COVER & CONCEALMENT\n`;
            report += `-------------------\n`;
            report += `Rating: ${a.coverConcealment.concealmentRating}%\n`;
            report += `Terrain Masking: ${a.coverConcealment.terrainMasking}%\n`;
            report += `Defilade: ${a.coverConcealment.defilade}\n`;
            if (a.coverConcealment.coverDirections?.length) {
                report += `Covered from: ${a.coverConcealment.coverDirections.join(', ')}\n`;
            }
            if (a.coverConcealment.exposedDirections?.length) {
                report += `Exposed to: ${a.coverConcealment.exposedDirections.join(', ')}\n`;
            }
            report += `\n`;
        }
        
        if (a.trafficability) {
            report += `TRAFFICABILITY\n`;
            report += `--------------\n`;
            Object.entries(a.trafficability).forEach(([k, v]) => {
                const label = k.replace(/_/g, ' ');
                report += `${label}: ${v.rating}${v.passable ? '' : ' (IMPASSABLE)'} ‚Äî ${v.description}\n`;
            });
        }
        
        // Download
        const blob = new Blob([report], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `terrain-report-${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        ModalsModule.showToast('Report exported', 'success');
    }

    // ==========================================
    // RADIO FREQUENCY REFERENCE PANEL
    // ==========================================

    let radioActiveTab = 'emergency';
    let radioSearchQuery = '';
    let radioInitialized = false;

    async function renderRadio() {
        _saveScroll(); _restoreScroll();
        // Initialize RadioModule if needed
        if (typeof RadioModule !== 'undefined' && !radioInitialized) {
            await RadioModule.init();
            radioInitialized = true;
        }

        if (typeof RadioModule === 'undefined') {
            container.innerHTML = `
                <div class="panel__header">
                    <h2 class="panel__title">üìª Radio Reference</h2>
                </div>
                <div class="empty-state">
                    <div class="empty-state__icon">${Icons.get('antenna')}</div>
                    <div class="empty-state__title">Radio Module Not Loaded</div>
                    <div class="empty-state__desc">Frequency reference is not available</div>
                </div>
            `;
            return;
        }

        const tabs = [
            { id: 'emergency', label: 'üö® Emergency', icon: 'alert' },
            { id: 'frs', label: 'FRS', icon: 'radio' },
            { id: 'gmrs', label: 'GMRS', icon: 'radio' },
            { id: 'murs', label: 'MURS', icon: 'radio' },
            { id: 'cb', label: 'CB', icon: 'radio' },
            { id: 'weather', label: 'üå§Ô∏è WX', icon: 'weather' },
            { id: 'meshtastic', label: 'üì° Mesh', icon: 'broadcast' },
            { id: 'ham', label: 'üìª Ham', icon: 'antenna' },
            { id: 'repeaters', label: 'üìç Repeaters', icon: 'antenna' },
            { id: 'rflos', label: 'üì° LOS', icon: 'antenna' },
            { id: 'rally', label: 'üéØ Rally', icon: 'target' },
            { id: 'custom', label: '‚≠ê Custom', icon: 'star' }
        ];

        container.innerHTML = `
            <div class="panel__header">
                <h2 class="panel__title">üìª Radio Reference</h2>
                <button class="btn btn--secondary" id="radio-export-btn" title="Export Data">
                    ${Icons.get('export')}
                </button>
            </div>

            <!-- Search -->
            <div class="form-group" style="margin-bottom:12px">
                <div style="position:relative">
                    <input type="text" id="radio-search" placeholder="Search all frequencies..." 
                        value="${radioSearchQuery}" style="padding-left:36px">
                    <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);opacity:0.4">
                        ${Icons.get('zoomIn')}
                    </span>
                </div>
            </div>

            <!-- Tabs -->
            <div class="radio-tabs" style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:16px">
                ${tabs.map(tab => `
                    <button class="chip ${radioActiveTab === tab.id ? 'chip--active' : ''}" 
                        data-radio-tab="${tab.id}">
                        ${tab.label}
                    </button>
                `).join('')}
            </div>

            <!-- Content Area -->
            <div id="radio-content">
                ${renderRadioTabContent()}
            </div>
        `;

        // Event handlers
        container.querySelectorAll('[data-radio-tab]').forEach(btn => {
            btn.onclick = () => {
                radioActiveTab = btn.dataset.radioTab;
                radioSearchQuery = '';
                renderRadio();
            };
        });

        const searchInput = container.querySelector('#radio-search');
        searchInput.oninput = (e) => {
            radioSearchQuery = e.target.value;
            if (radioSearchQuery.length >= 2) {
                radioActiveTab = 'search';
            }
            domCache.get('radio-content').innerHTML = renderRadioTabContent();
            attachRadioContentHandlers();
        };

        container.querySelector('#radio-export-btn').onclick = () => {
            const data = RadioModule.exportData();
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `radio-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            ModalsModule.showToast('Radio data exported', 'success');
        };

        attachRadioContentHandlers();
    }

    function renderRadioTabContent() {
        if (radioSearchQuery.length >= 2) {
            return renderRadioSearchResults();
        }

        switch (radioActiveTab) {
            case 'emergency': return renderRadioEmergency();
            case 'frs': return renderRadioFRS();
            case 'gmrs': return renderRadioGMRS();
            case 'murs': return renderRadioMURS();
            case 'cb': return renderRadioCB();
            case 'weather': return renderRadioWeather();
            case 'meshtastic': return renderRadioMeshtastic();
            case 'ham': return renderRadioHam();
            case 'repeaters': return renderRadioRepeaters();
            case 'rflos': return renderRadioRFLOS();
            case 'rally': return renderRadioRallyPoints();
            case 'custom': return renderRadioCustom();
            default: return renderRadioEmergency();
        }
    }

    function renderRadioSearchResults() {
        const results = RadioModule.searchAll(radioSearchQuery);
        
        if (results.length === 0) {
            return `
                <div class="empty-state" style="padding:20px">
                    <div class="empty-state__title">No results found</div>
                    <div class="empty-state__desc">Try a different search term</div>
                </div>
            `;
        }

        return `
            <div class="section-label">Search Results (${results.length})</div>
            <div class="radio-freq-list">
                ${results.map(r => `
                    <div class="radio-freq-item">
                        <div class="radio-freq-item__main">
                            <div class="radio-freq-item__freq">${r.freq ? RadioModule.formatFreq(r.freq, 4) : r.channel || ''}</div>
                            <div class="radio-freq-item__name">${r.name || r.channel || ''}</div>
                        </div>
                        <div class="radio-freq-item__meta">
                            <span class="comm-tag">${r._category}</span>
                            ${r.notes ? `<span style="opacity:0.6;font-size:11px">${r.notes}</span>` : ''}
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }

    function renderRadioEmergency() {
        const freqs = RadioModule.EMERGENCY_FREQUENCIES;
        const critical = freqs.filter(f => f.priority === 'critical');
        const high = freqs.filter(f => f.priority === 'high');
        const medium = freqs.filter(f => f.priority === 'medium');

        return `
            <div class="status-card status-card--error" style="margin-bottom:16px">
                <div class="status-card__icon">${Icons.get('alertTriangle')}</div>
                <div>
                    <div class="status-card__title">Emergency Frequencies</div>
                    <div class="status-card__desc">For life-threatening emergencies only</div>
                </div>
            </div>

            <div class="section-label">üî¥ Critical (Distress)</div>
            <div class="radio-freq-list">
                ${critical.map(f => renderFrequencyItem(f, 'critical')).join('')}
            </div>

            <div class="section-label" style="margin-top:16px">üü† High Priority</div>
            <div class="radio-freq-list">
                ${high.map(f => renderFrequencyItem(f, 'high')).join('')}
            </div>

            <div class="section-label" style="margin-top:16px">üü° Standard Emergency</div>
            <div class="radio-freq-list">
                ${medium.map(f => renderFrequencyItem(f, 'medium')).join('')}
            </div>

            <div style="margin-top:20px;padding:14px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.2);border-radius:10px;font-size:12px">
                <strong style="color:#ef4444">‚ö†Ô∏è Important:</strong> 
                Use emergency frequencies only for genuine emergencies. 
                False distress calls are illegal and can result in prosecution.
            </div>
        `;
    }

    function renderRadioFRS() {
        const channels = RadioModule.FRS_CHANNELS;
        
        return `
            <div style="padding:12px;background:rgba(59,130,246,0.1);border-radius:10px;margin-bottom:16px;font-size:12px">
                <strong>FRS (Family Radio Service)</strong><br>
                No license required. Max 2W on Ch 1-7 & 15-22, 0.5W on Ch 8-14.
                Channels 1-7 and 15-22 are shared with GMRS.
            </div>

            <div class="radio-freq-list">
                ${channels.map(ch => `
                    <div class="radio-freq-item">
                        <div class="radio-freq-item__main">
                            <div class="radio-freq-item__channel">Ch ${ch.channel}</div>
                            <div class="radio-freq-item__freq">${ch.freq.toFixed(4)} MHz</div>
                        </div>
                        <div class="radio-freq-item__meta">
                            <span class="comm-tag">${ch.power}</span>
                            ${ch.shared ? `<span class="comm-tag comm-tag--secondary">${ch.shared}</span>` : ''}
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }

    function renderRadioGMRS() {
        const channels = RadioModule.GMRS_CHANNELS;
        
        return `
            <div style="padding:12px;background:rgba(249,115,22,0.1);border-radius:10px;margin-bottom:16px;font-size:12px">
                <strong>GMRS (General Mobile Radio Service)</strong><br>
                FCC license required ($35 for 10 years, covers family).
                Up to 50W on repeater channels. Channel 19 is calling/emergency.
            </div>

            <div class="section-label">Simplex Channels (5W)</div>
            <div class="radio-freq-list">
                ${channels.filter(ch => !ch.repeater).map(ch => `
                    <div class="radio-freq-item">
                        <div class="radio-freq-item__main">
                            <div class="radio-freq-item__channel">Ch ${ch.channel}</div>
                            <div class="radio-freq-item__freq">${ch.freq.toFixed(4)} MHz</div>
                        </div>
                        <div class="radio-freq-item__meta">
                            <span class="comm-tag">${ch.power}</span>
                        </div>
                    </div>
                `).join('')}
            </div>

            <div class="section-label" style="margin-top:16px">Repeater Channels (50W)</div>
            <div class="radio-freq-list">
                ${channels.filter(ch => ch.repeater).map(ch => `
                    <div class="radio-freq-item ${ch.channel === 19 ? 'radio-freq-item--highlight' : ''}">
                        <div class="radio-freq-item__main">
                            <div class="radio-freq-item__channel">Ch ${ch.channel}</div>
                            <div class="radio-freq-item__freq">${ch.freq.toFixed(4)} MHz</div>
                        </div>
                        <div class="radio-freq-item__meta">
                            <span class="comm-tag">${ch.power}</span>
                            <span class="comm-tag comm-tag--secondary">RPT</span>
                        </div>
                        ${ch.notes ? `<div class="radio-freq-item__notes">${ch.notes}</div>` : ''}
                    </div>
                `).join('')}
            </div>
        `;
    }

    function renderRadioMURS() {
        const channels = RadioModule.MURS_CHANNELS;
        
        return `
            <div style="padding:12px;background:rgba(34,197,94,0.1);border-radius:10px;margin-bottom:16px;font-size:12px">
                <strong>MURS (Multi-Use Radio Service)</strong><br>
                No license required. Max 2W. Less congested than FRS.
                Good for voice communication in rural areas.
            </div>

            <div class="radio-freq-list">
                ${channels.map(ch => `
                    <div class="radio-freq-item">
                        <div class="radio-freq-item__main">
                            <div class="radio-freq-item__channel">Ch ${ch.channel}</div>
                            <div class="radio-freq-item__freq">${ch.freq.toFixed(3)} MHz</div>
                        </div>
                        <div class="radio-freq-item__meta">
                            <span class="comm-tag">${ch.power}</span>
                            <span class="comm-tag comm-tag--secondary">${ch.bandwidth}</span>
                        </div>
                        ${ch.notes ? `<div class="radio-freq-item__notes">${ch.notes}</div>` : ''}
                    </div>
                `).join('')}
            </div>
        `;
    }

    function renderRadioCB() {
        const channels = RadioModule.CB_CHANNELS;
        const highlighted = [9, 19]; // Emergency and trucker channel
        
        return `
            <div style="padding:12px;background:rgba(139,92,246,0.1);border-radius:10px;margin-bottom:16px;font-size:12px">
                <strong>CB (Citizens Band) Radio</strong><br>
                No license required. 4W AM / 12W SSB.
                Ch 9 = Emergency, Ch 19 = Truckers/Highway.
            </div>

            <div class="section-label">Key Channels</div>
            <div class="radio-freq-list">
                ${channels.filter(ch => highlighted.includes(ch.channel)).map(ch => `
                    <div class="radio-freq-item radio-freq-item--highlight">
                        <div class="radio-freq-item__main">
                            <div class="radio-freq-item__channel">Ch ${ch.channel}</div>
                            <div class="radio-freq-item__freq">${ch.freq.toFixed(3)} MHz</div>
                        </div>
                        <div class="radio-freq-item__meta">
                            <span class="comm-tag">${ch.mode}</span>
                        </div>
                        ${ch.notes ? `<div class="radio-freq-item__notes">${ch.notes}</div>` : ''}
                    </div>
                `).join('')}
            </div>

            <div class="section-label" style="margin-top:16px">All Channels</div>
            <div class="radio-freq-list" style="max-height:400px;overflow-y:auto">
                ${channels.map(ch => `
                    <div class="radio-freq-item ${highlighted.includes(ch.channel) ? 'radio-freq-item--highlight' : ''}">
                        <div class="radio-freq-item__main">
                            <div class="radio-freq-item__channel">Ch ${ch.channel}</div>
                            <div class="radio-freq-item__freq">${ch.freq.toFixed(3)} MHz</div>
                        </div>
                        <div class="radio-freq-item__meta">
                            <span class="comm-tag">${ch.mode}</span>
                            ${ch.notes ? `<span style="opacity:0.6;font-size:10px">${ch.notes}</span>` : ''}
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }

    function renderRadioWeather() {
        const channels = RadioModule.WEATHER_FREQUENCIES;
        
        return `
            <div style="padding:12px;background:rgba(59,130,246,0.1);border-radius:10px;margin-bottom:16px;font-size:12px">
                <strong>NOAA Weather Radio</strong><br>
                Continuous broadcasts of weather information, warnings, and alerts.
                Coverage varies by region - scan to find active channel.
            </div>

            <div class="radio-freq-list">
                ${channels.map(ch => `
                    <div class="radio-freq-item">
                        <div class="radio-freq-item__main">
                            <div class="radio-freq-item__channel">${ch.channel}</div>
                            <div class="radio-freq-item__freq">${ch.freq.toFixed(3)} MHz</div>
                        </div>
                        <div class="radio-freq-item__meta">
                            <span class="comm-tag">Receive Only</span>
                        </div>
                    </div>
                `).join('')}
            </div>

            <div style="margin-top:16px;padding:14px;background:var(--color-bg-elevated);border-radius:10px">
                <strong style="font-size:13px">üìç Finding Your Local Station</strong>
                <ol style="margin:8px 0 0 16px;font-size:12px;color:var(--color-text-secondary)">
                    <li>Turn on weather radio</li>
                    <li>Scan through WX1-WX7</li>
                    <li>Listen for strongest/clearest signal</li>
                    <li>Note which channel works best for your area</li>
                </ol>
            </div>
        `;
    }

    function renderRadioMeshtastic() {
        const channels = RadioModule.MESHTASTIC_CHANNELS;
        
        return `
            <div style="padding:12px;background:rgba(236,72,153,0.1);border-radius:10px;margin-bottom:16px;font-size:12px">
                <strong>Meshtastic / LoRa (915 MHz ISM Band)</strong><br>
                Off-grid mesh network for text messaging. No license required.
                Range: 1-10+ miles depending on terrain and settings.
            </div>

            <div class="section-label">Preset Channels (US Region)</div>
            <div class="radio-freq-list">
                ${channels.map(ch => `
                    <div class="radio-freq-item">
                        <div class="radio-freq-item__main">
                            <div class="radio-freq-item__name" style="font-weight:500">${ch.name}</div>
                            <div class="radio-freq-item__freq">${ch.freq.toFixed(3)} MHz</div>
                        </div>
                        <div class="radio-freq-item__meta">
                            <span class="comm-tag">SF${ch.sf}</span>
                            <span class="comm-tag">${ch.bw}kHz</span>
                        </div>
                        <div class="radio-freq-item__notes">${ch.notes}</div>
                    </div>
                `).join('')}
            </div>

            <div style="margin-top:16px;padding:14px;background:var(--color-bg-elevated);border-radius:10px">
                <strong style="font-size:13px">üîß Settings Guide</strong>
                <div style="margin-top:8px;font-size:12px;color:var(--color-text-secondary)">
                    <div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--color-border)">
                        <span>LongFast</span><span>Best for most uses</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--color-border)">
                        <span>LongSlow</span><span>Maximum range</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;padding:4px 0">
                        <span>ShortFast</span><span>High traffic areas</span>
                    </div>
                </div>
            </div>
        `;
    }

    function renderRadioHam() {
        const vhf = RadioModule.HAM_FREQUENCIES.vhf;
        const uhf = RadioModule.HAM_FREQUENCIES.uhf;
        const hf = RadioModule.HAM_FREQUENCIES.hf;
        
        return `
            <div style="padding:12px;background:rgba(249,115,22,0.1);border-radius:10px;margin-bottom:16px;font-size:12px">
                <strong>Amateur (Ham) Radio</strong><br>
                FCC license required to transmit. Listen-only is permitted.
                These are common calling and simplex frequencies.
            </div>

            <div class="section-label">2m VHF (144-148 MHz)</div>
            <div class="radio-freq-list">
                ${vhf.map(f => `
                    <div class="radio-freq-item ${f.freq === 146.520 ? 'radio-freq-item--highlight' : ''}">
                        <div class="radio-freq-item__main">
                            <div class="radio-freq-item__freq">${f.freq.toFixed(3)} MHz</div>
                            <div class="radio-freq-item__name">${f.name}</div>
                        </div>
                        <div class="radio-freq-item__meta">
                            <span class="comm-tag">${f.mode}</span>
                        </div>
                    </div>
                `).join('')}
            </div>

            <div class="section-label" style="margin-top:16px">70cm UHF (420-450 MHz)</div>
            <div class="radio-freq-list">
                ${uhf.map(f => `
                    <div class="radio-freq-item ${f.freq === 446.000 ? 'radio-freq-item--highlight' : ''}">
                        <div class="radio-freq-item__main">
                            <div class="radio-freq-item__freq">${f.freq.toFixed(3)} MHz</div>
                            <div class="radio-freq-item__name">${f.name}</div>
                        </div>
                        <div class="radio-freq-item__meta">
                            <span class="comm-tag">${f.mode}</span>
                        </div>
                    </div>
                `).join('')}
            </div>

            <div class="section-label" style="margin-top:16px">HF (Long Distance)</div>
            <div class="radio-freq-list">
                ${hf.map(f => `
                    <div class="radio-freq-item">
                        <div class="radio-freq-item__main">
                            <div class="radio-freq-item__freq">${f.freq.toFixed(3)} MHz</div>
                            <div class="radio-freq-item__name">${f.name}</div>
                        </div>
                        <div class="radio-freq-item__meta">
                            <span class="comm-tag">${f.mode}</span>
                        </div>
                        ${f.notes ? `<div class="radio-freq-item__notes">${f.notes}</div>` : ''}
                    </div>
                `).join('')}
            </div>
        `;
    }

    function renderRadioRepeaters() {
        const repeaters = RadioModule.getRepeaters();
        
        return `
            <div style="padding:12px;background:rgba(59,130,246,0.1);border-radius:10px;margin-bottom:16px;font-size:12px">
                <strong>Amateur Repeaters</strong><br>
                Pre-loaded repeaters for the Sierra Nevada region.
                Add custom repeaters for your area.
            </div>

            <button class="btn btn--primary btn--full" id="add-repeater-btn" style="margin-bottom:16px">
                ${Icons.get('plus')} Add Repeater
            </button>

            <div class="radio-freq-list">
                ${repeaters.map(r => `
                    <div class="radio-freq-item">
                        <div class="radio-freq-item__main">
                            <div class="radio-freq-item__channel">${r.callsign}</div>
                            <div class="radio-freq-item__freq">${r.freq.toFixed(3)} MHz</div>
                        </div>
                        <div class="radio-freq-item__meta">
                            <span class="comm-tag">${r.offset}</span>
                            ${r.tone ? `<span class="comm-tag">T ${r.tone}</span>` : ''}
                            ${r.isCustom ? `<button class="comm-action-btn comm-action-btn--danger" data-delete-repeater="${r.id}" style="margin-left:auto">${Icons.get('trash')}</button>` : ''}
                        </div>
                        <div class="radio-freq-item__notes">${r.location}</div>
                    </div>
                `).join('')}
            </div>
        `;
    }

    function renderRadioRFLOS() {
        if (typeof RFLOSModule === 'undefined') {
            return `
                <div class="empty-state" style="padding:20px">
                    <div class="empty-state__icon">üì°</div>
                    <div class="empty-state__title">RF LOS Module Not Loaded</div>
                    <div class="empty-state__desc">Line of sight analysis is not available</div>
                </div>
            `;
        }
        
        return `<div id="rflos-panel-container">${RFLOSModule.renderPanel()}</div>`;
    }

    function renderRadioRallyPoints() {
        const rallyPoints = RadioModule.getRallyPoints();
        const waypoints = State.get('waypoints');
        
        return `
            <div style="padding:12px;background:rgba(236,72,153,0.1);border-radius:10px;margin-bottom:16px;font-size:12px">
                <strong>Rally Point Frequencies</strong><br>
                Assign frequencies and codenames to rally points.
                Link to waypoints for coordinate reference.
            </div>

            <button class="btn btn--primary btn--full" id="add-rally-btn" style="margin-bottom:16px">
                ${Icons.get('plus')} Add Rally Point
            </button>

            ${rallyPoints.length === 0 ? `
                <div class="empty-state" style="padding:30px">
                    <div class="empty-state__icon">${Icons.get('target')}</div>
                    <div class="empty-state__title">No Rally Points</div>
                    <div class="empty-state__desc">Add frequencies for your team's rally points</div>
                </div>
            ` : `
                <div class="radio-freq-list">
                    ${rallyPoints.map(rp => {
                        const linkedWp = rp.waypointId ? waypoints.find(w => w.id === rp.waypointId) : null;
                        return `
                            <div class="radio-freq-item">
                                <div class="radio-freq-item__main">
                                    <div class="radio-freq-item__name" style="font-weight:600">${rp.codename || rp.name}</div>
                                    <div class="radio-freq-item__freq">${rp.freq.toFixed(4)} MHz</div>
                                </div>
                                <div class="radio-freq-item__meta">
                                    ${rp.tone ? `<span class="comm-tag">T ${rp.tone}</span>` : ''}
                                    ${linkedWp ? `<span class="comm-tag comm-tag--secondary">üìç ${linkedWp.name}</span>` : ''}
                                    <button class="comm-action-btn" data-edit-rally="${rp.id}" style="margin-left:auto">${Icons.get('edit')}</button>
                                    <button class="comm-action-btn comm-action-btn--danger" data-delete-rally="${rp.id}">${Icons.get('trash')}</button>
                                </div>
                                ${rp.notes ? `<div class="radio-freq-item__notes">${rp.notes}</div>` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            `}
        `;
    }

    function renderRadioCustom() {
        const custom = RadioModule.getCustomFrequencies();
        
        return `
            <div style="padding:12px;background:rgba(139,92,246,0.1);border-radius:10px;margin-bottom:16px;font-size:12px">
                <strong>Custom Frequencies</strong><br>
                Save frequently used frequencies for quick reference.
            </div>

            <button class="btn btn--primary btn--full" id="add-custom-freq-btn" style="margin-bottom:16px">
                ${Icons.get('plus')} Add Frequency
            </button>

            ${custom.length === 0 ? `
                <div class="empty-state" style="padding:30px">
                    <div class="empty-state__icon">${Icons.get('star')}</div>
                    <div class="empty-state__title">No Custom Frequencies</div>
                    <div class="empty-state__desc">Add your own frequencies for quick access</div>
                </div>
            ` : `
                <div class="radio-freq-list">
                    ${custom.map(f => `
                        <div class="radio-freq-item">
                            <div class="radio-freq-item__main">
                                <div class="radio-freq-item__name">${f.name || 'Unnamed'}</div>
                                <div class="radio-freq-item__freq">${f.freq.toFixed(4)} MHz</div>
                            </div>
                            <div class="radio-freq-item__meta">
                                <span class="comm-tag">${f.mode}</span>
                                ${f.tone ? `<span class="comm-tag">T ${f.tone}</span>` : ''}
                                ${f.category ? `<span class="comm-tag comm-tag--secondary">${f.category}</span>` : ''}
                                <button class="comm-action-btn" data-edit-custom="${f.id}" style="margin-left:auto">${Icons.get('edit')}</button>
                                <button class="comm-action-btn comm-action-btn--danger" data-delete-custom="${f.id}">${Icons.get('trash')}</button>
                            </div>
                            ${f.notes ? `<div class="radio-freq-item__notes">${f.notes}</div>` : ''}
                        </div>
                    `).join('')}
                </div>
            `}
        `;
    }

    function renderFrequencyItem(f, priority) {
        const colors = {
            critical: '#ef4444',
            high: '#f59e0b',
            medium: '#3b82f6'
        };
        
        return `
            <div class="radio-freq-item" style="border-left:3px solid ${colors[priority] || '#666'}">
                <div class="radio-freq-item__main">
                    <div class="radio-freq-item__freq">${f.freq.toFixed(3)} MHz</div>
                    <div class="radio-freq-item__name">${f.name}</div>
                </div>
                <div class="radio-freq-item__meta">
                    <span class="comm-tag">${f.service}</span>
                </div>
                ${f.notes ? `<div class="radio-freq-item__notes">${f.notes}</div>` : ''}
            </div>
        `;
    }

    function attachRadioContentHandlers() {
        // Add custom frequency button
        const addCustomBtn = container.querySelector('#add-custom-freq-btn');
        if (addCustomBtn) {
            addCustomBtn.onclick = () => showAddFrequencyModal();
        }

        // Add rally point button
        const addRallyBtn = container.querySelector('#add-rally-btn');
        if (addRallyBtn) {
            addRallyBtn.onclick = () => showAddRallyPointModal();
        }

        // Add repeater button
        const addRepeaterBtn = container.querySelector('#add-repeater-btn');
        if (addRepeaterBtn) {
            addRepeaterBtn.onclick = () => showAddRepeaterModal();
        }

        // Delete handlers
        container.querySelectorAll('[data-delete-custom]').forEach(btn => {
            btn.onclick = (e) => {
                e.stopPropagation();
                if (confirm('Delete this frequency?')) {
                    RadioModule.deleteCustomFrequency(btn.dataset.deleteCustom);
                    domCache.get('radio-content').innerHTML = renderRadioTabContent();
                    attachRadioContentHandlers();
                }
            };
        });

        container.querySelectorAll('[data-delete-rally]').forEach(btn => {
            btn.onclick = (e) => {
                e.stopPropagation();
                if (confirm('Delete this rally point?')) {
                    RadioModule.deleteRallyPoint(btn.dataset.deleteRally);
                    domCache.get('radio-content').innerHTML = renderRadioTabContent();
                    attachRadioContentHandlers();
                }
            };
        });

        container.querySelectorAll('[data-delete-repeater]').forEach(btn => {
            btn.onclick = (e) => {
                e.stopPropagation();
                if (confirm('Delete this repeater?')) {
                    const repeaters = RadioModule.getRepeaters();
                    const rpt = repeaters.find(r => r.id === btn.dataset.deleteRepeater);
                    if (rpt) {
                        // Remove from array (would need proper delete method)
                        domCache.get('radio-content').innerHTML = renderRadioTabContent();
                        attachRadioContentHandlers();
                    }
                }
            };
        });
        
        // RF LOS panel handlers
        const rflosContainer = container.querySelector('#rflos-panel-container');
        if (rflosContainer && typeof RFLOSModule !== 'undefined') {
            RFLOSModule.attachHandlers(rflosContainer);
            
            // Subscribe to RFLOS events to re-render panel
            RFLOSModule.subscribe((event, data) => {
                if (event === 'update' || event === 'pointSet' || event === 'clear' || event === 'selecting') {
                    const panelContainer = document.querySelector('#rflos-panel-container');
                    if (panelContainer) {
                        panelContainer.innerHTML = RFLOSModule.renderPanel();
                        RFLOSModule.attachHandlers(panelContainer);
                    }
                    // Request map redraw for overlay
                    if (typeof MapModule !== 'undefined' && MapModule.requestRender) {
                        MapModule.requestRender();
                    }
                }
            });
        }
    }

    function showAddFrequencyModal() {
        // Uses cached modalContainer ref
        modalContainer.innerHTML = `
            <div class="modal-backdrop" id="modal-backdrop" role="presentation">
                <div class="modal">
                    <div class="modal__header">
                        <h3 class="modal__title">Add Custom Frequency</h3>
                        <button class="modal__close" id="modal-close" aria-label="Close dialog">${Icons.get('close')}</button>
                    </div>
                    <div class="modal__body">
                        <div class="form-group">
                            <label>Frequency (MHz)</label>
                            <input type="number" id="freq-input" step="0.0001" placeholder="146.5200">
                        </div>
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" id="freq-name" placeholder="My frequency">
                        </div>
                        <div class="form-group">
                            <label>Mode</label>
                            <select id="freq-mode">
                                <option value="FM">FM</option>
                                <option value="AM">AM</option>
                                <option value="USB">USB</option>
                                <option value="LSB">LSB</option>
                                <option value="Digital">Digital</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>CTCSS Tone (optional)</label>
                            <select id="freq-tone">
                                <option value="">None</option>
                                ${RadioModule.CTCSS_TONES.map(t => `<option value="${t}">${t} Hz</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <input type="text" id="freq-category" placeholder="e.g., Local, Work, Club">
                        </div>
                        <div class="form-group">
                            <label>Notes</label>
                            <textarea id="freq-notes" rows="2" placeholder="Additional notes..."></textarea>
                        </div>
                    </div>
                    <div class="modal__footer">
                        <button class="btn btn--secondary" id="modal-cancel">Cancel</button>
                        <button class="btn btn--primary" id="modal-save">Add Frequency</button>
                    </div>
                </div>
            </div>
        `;

        modalContainer.querySelector('#modal-close').onclick = () => modalContainer.innerHTML = '';
        modalContainer.querySelector('#modal-cancel').onclick = () => modalContainer.innerHTML = '';
        modalContainer.querySelector('#modal-backdrop').onclick = (e) => {
            if (e.target.id === 'modal-backdrop') modalContainer.innerHTML = '';
        };

        modalContainer.querySelector('#modal-save').onclick = () => {
            const freq = parseFloat(modalContainer.querySelector('#freq-input').value);
            if (!freq || freq <= 0) {
                ModalsModule.showToast('Enter a valid frequency', 'error');
                return;
            }

            RadioModule.addCustomFrequency({
                freq,
                name: modalContainer.querySelector('#freq-name').value,
                mode: modalContainer.querySelector('#freq-mode').value,
                tone: modalContainer.querySelector('#freq-tone').value || null,
                category: modalContainer.querySelector('#freq-category').value,
                notes: modalContainer.querySelector('#freq-notes').value
            });

            modalContainer.innerHTML = '';
            ModalsModule.showToast('Frequency added', 'success');
            domCache.get('radio-content').innerHTML = renderRadioTabContent();
            attachRadioContentHandlers();
        };
    }

    function showAddRallyPointModal() {
        const waypoints = State.get('waypoints');
        // Uses cached modalContainer ref
        
        modalContainer.innerHTML = `
            <div class="modal-backdrop" id="modal-backdrop" role="presentation">
                <div class="modal">
                    <div class="modal__header">
                        <h3 class="modal__title">Add Rally Point</h3>
                        <button class="modal__close" id="modal-close" aria-label="Close dialog">${Icons.get('close')}</button>
                    </div>
                    <div class="modal__body">
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" id="rally-name" placeholder="Rally Point Alpha">
                        </div>
                        <div class="form-group">
                            <label>Codename (optional)</label>
                            <input type="text" id="rally-codename" placeholder="PHOENIX">
                        </div>
                        <div class="form-group">
                            <label>Frequency (MHz)</label>
                            <input type="number" id="rally-freq" step="0.0001" placeholder="462.5625">
                        </div>
                        <div class="form-group">
                            <label>CTCSS Tone (optional)</label>
                            <select id="rally-tone">
                                <option value="">None</option>
                                ${RadioModule.CTCSS_TONES.map(t => `<option value="${t}">${t} Hz</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Link to Waypoint (optional)</label>
                            <select id="rally-waypoint">
                                <option value="">None</option>
                                ${waypoints.map(w => `<option value="${w.id}">${w.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Notes</label>
                            <textarea id="rally-notes" rows="2" placeholder="Check-in times, procedures..."></textarea>
                        </div>
                    </div>
                    <div class="modal__footer">
                        <button class="btn btn--secondary" id="modal-cancel">Cancel</button>
                        <button class="btn btn--primary" id="modal-save">Add Rally Point</button>
                    </div>
                </div>
            </div>
        `;

        modalContainer.querySelector('#modal-close').onclick = () => modalContainer.innerHTML = '';
        modalContainer.querySelector('#modal-cancel').onclick = () => modalContainer.innerHTML = '';
        modalContainer.querySelector('#modal-backdrop').onclick = (e) => {
            if (e.target.id === 'modal-backdrop') modalContainer.innerHTML = '';
        };

        modalContainer.querySelector('#modal-save').onclick = () => {
            const name = modalContainer.querySelector('#rally-name').value;
            const freq = parseFloat(modalContainer.querySelector('#rally-freq').value);
            
            if (!name) {
                ModalsModule.showToast('Enter a name', 'error');
                return;
            }
            if (!freq || freq <= 0) {
                ModalsModule.showToast('Enter a valid frequency', 'error');
                return;
            }

            RadioModule.addRallyPoint({
                name,
                codename: modalContainer.querySelector('#rally-codename').value,
                freq,
                tone: modalContainer.querySelector('#rally-tone').value || null,
                waypointId: modalContainer.querySelector('#rally-waypoint').value || null,
                notes: modalContainer.querySelector('#rally-notes').value
            });

            modalContainer.innerHTML = '';
            ModalsModule.showToast('Rally point added', 'success');
            domCache.get('radio-content').innerHTML = renderRadioTabContent();
            attachRadioContentHandlers();
        };
    }

    function showAddRepeaterModal() {
        // Uses cached modalContainer ref
        
        modalContainer.innerHTML = `
            <div class="modal-backdrop" id="modal-backdrop" role="presentation">
                <div class="modal">
                    <div class="modal__header">
                        <h3 class="modal__title">Add Repeater</h3>
                        <button class="modal__close" id="modal-close" aria-label="Close dialog">${Icons.get('close')}</button>
                    </div>
                    <div class="modal__body">
                        <div class="form-group">
                            <label>Callsign</label>
                            <input type="text" id="rpt-callsign" placeholder="W6ABC">
                        </div>
                        <div class="form-group">
                            <label>Output Frequency (MHz)</label>
                            <input type="number" id="rpt-freq" step="0.0001" placeholder="146.940">
                        </div>
                        <div class="form-group">
                            <label>Offset</label>
                            <select id="rpt-offset">
                                <option value="-">- (minus)</option>
                                <option value="+">+ (plus)</option>
                                <option value="0">Simplex</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>CTCSS Tone</label>
                            <select id="rpt-tone">
                                <option value="">None</option>
                                ${RadioModule.CTCSS_TONES.map(t => `<option value="${t}">${t} Hz</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Location</label>
                            <input type="text" id="rpt-location" placeholder="Mt. Wilson, CA">
                        </div>
                        <div class="form-group">
                            <label>Notes</label>
                            <textarea id="rpt-notes" rows="2" placeholder="Coverage area, linked systems..."></textarea>
                        </div>
                    </div>
                    <div class="modal__footer">
                        <button class="btn btn--secondary" id="modal-cancel">Cancel</button>
                        <button class="btn btn--primary" id="modal-save">Add Repeater</button>
                    </div>
                </div>
            </div>
        `;

        modalContainer.querySelector('#modal-close').onclick = () => modalContainer.innerHTML = '';
        modalContainer.querySelector('#modal-cancel').onclick = () => modalContainer.innerHTML = '';
        modalContainer.querySelector('#modal-backdrop').onclick = (e) => {
            if (e.target.id === 'modal-backdrop') modalContainer.innerHTML = '';
        };

        modalContainer.querySelector('#modal-save').onclick = () => {
            const freq = parseFloat(modalContainer.querySelector('#rpt-freq').value);
            
            if (!freq || freq <= 0) {
                ModalsModule.showToast('Enter a valid frequency', 'error');
                return;
            }

            RadioModule.addRepeater({
                callsign: modalContainer.querySelector('#rpt-callsign').value,
                freq,
                offset: modalContainer.querySelector('#rpt-offset').value,
                tone: modalContainer.querySelector('#rpt-tone').value || null,
                location: modalContainer.querySelector('#rpt-location').value,
                notes: modalContainer.querySelector('#rpt-notes').value
            });

            modalContainer.innerHTML = '';
            ModalsModule.showToast('Repeater added', 'success');
            domCache.get('radio-content').innerHTML = renderRadioTabContent();
            attachRadioContentHandlers();
        };
    }

    // =========================================================================
    // MEDICAL REFERENCE PANEL
    // =========================================================================
    
    let medicalState = {
        searchQuery: '',
        activeCategory: null,
        activeView: 'categories', // 'categories', 'search', 'protocol', 'medication', 'bookmarks'
        selectedProtocol: null,
        selectedMedication: null,
        bookmarks: []
    };

    // Load bookmarks from storage
    async function loadMedicalBookmarks() {
        try {
            const saved = await Storage.Settings.get('medical_bookmarks');
            if (saved) {
                medicalState.bookmarks = saved;
            }
        } catch (e) {
            console.error('Failed to load medical bookmarks:', e);
        }
    }

    // Save bookmarks to storage
    async function saveMedicalBookmarks() {
        try {
            await Storage.Settings.set('medical_bookmarks', medicalState.bookmarks);
        } catch (e) {
            console.error('Failed to save medical bookmarks:', e);
        }
    }

    // ==========================================
    // SSTV PANEL
    // ==========================================
    
    let sstvInitialized = false;
    let sstvActiveTab = 'receive';
    let sstvEnhanceInitialized = false;
    let sstvEnhanceMethod = 'local-2x';
    let sstvEnhanceDenoiseStrength = 0.3;
    let sstvEnhanceOCR = true;
    let sstvEnhanceSelectedImage = null;
    let sstvEnhanceProcessing = false;
    let sstvTransmitMode = 'Robot36';
    let sstvTransmitSource = 'camera';
    
    // TX image state - persists across re-renders
    let sstvCapturedImageData = null;  // Stored ImageData for TX preview
    let sstvCameraCapturing = false;   // Flag to prevent re-renders during capture
    let sstvRestorePending = false;    // Flag to prevent multiple restore operations
    let sstvPreviewDisplayed = false;  // Flag to track if preview is currently shown
    
    // Annotation state
    let sstvAnnotationTool = 'pen';
    let sstvAnnotationColor = '#ff0000';
    let sstvAnnotationWidth = 4;
    let sstvAnnotationHistory = []; // For undo
    let sstvIsDrawing = false;
    let sstvDrawStart = { x: 0, y: 0 };
    let sstvLastPoint = { x: 0, y: 0 };

    async function renderSSTV() {
        _saveScroll(); _restoreScroll();
        // Initialize SSTVModule if needed
        if (typeof SSTVModule !== 'undefined' && !sstvInitialized) {
            await SSTVModule.init();
            sstvInitialized = true;
            
            // Subscribe to SSTV events
            if (typeof Events !== 'undefined') {
                Events.on('sstv:status', handleSSTVStatus);
                Events.on('sstv:modeDetected', handleSSTVModeDetected);
                Events.on('sstv:progress', handleSSTVProgress);
                Events.on('sstv:imageComplete', handleSSTVImageComplete);
                Events.on('sstv:transmitStarted', handleSSTVTransmitStarted);
                Events.on('sstv:transmitComplete', handleSSTVTransmitComplete);
            }
        }

        if (typeof SSTVModule === 'undefined') {
            container.innerHTML = `
                <div class="panel__header">
                    <h2 class="panel__title">üì∫ SSTV</h2>
                </div>
                <div class="empty-state">
                    <div class="empty-state__icon">${Icons.get('camera')}</div>
                    <div class="empty-state__title">SSTV Module Not Loaded</div>
                    <div class="empty-state__desc">Slow Scan Television features are not available</div>
                </div>
            `;
            return;
        }

        const settings = SSTVModule.getSettings();
        const receivedImages = SSTVModule.getReceivedImages();
        const isReceiving = SSTVModule.isReceiving();
        const isTransmitting = SSTVModule.isTransmitting();

        const tabs = [
            { id: 'receive', label: 'üì• Receive', icon: 'download' },
            { id: 'transmit', label: 'üì§ Transmit', icon: 'upload' },
            { id: 'enhance', label: '‚ú® AI Enhance', icon: 'zoomIn' },
            { id: 'history', label: 'üñºÔ∏è History', icon: 'image' },
            { id: 'settings', label: '‚öôÔ∏è Settings', icon: 'settings' }
        ];

        container.innerHTML = `
            <div class="panel__header">
                <h2 class="panel__title">üì∫ SSTV</h2>
                <div style="display:flex;gap:8px;align-items:center">
                    ${settings.callsign ? `<span class="chip chip--small">${settings.callsign}</span>` : ''}
                </div>
            </div>

            <!-- Status Banner -->
            ${isReceiving ? `
                <div class="alert alert--info" style="margin-bottom:12px">
                    <span>üé§ Receiving...</span>
                    <span id="sstv-rx-status">Waiting for signal</span>
                </div>
            ` : ''}
            ${isTransmitting ? `
                <div class="alert alert--warning" style="margin-bottom:12px">
                    <span>üì° Transmitting...</span>
                    <span id="sstv-tx-status">Sending image</span>
                </div>
            ` : ''}

            <!-- Tabs -->
            <div class="radio-tabs" style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:16px">
                ${tabs.map(tab => `
                    <button class="chip ${sstvActiveTab === tab.id ? 'chip--active' : ''}" 
                        data-sstv-tab="${tab.id}">
                        ${tab.label}
                    </button>
                `).join('')}
            </div>

            <!-- Content Area -->
            <div id="sstv-content">
                ${renderSSTVTabContent()}
            </div>
        `;

        // Tab handlers
        container.querySelectorAll('[data-sstv-tab]').forEach(btn => {
            btn.onclick = () => {
                sstvActiveTab = btn.dataset.sstvTab;
                
                // Update tab button active states
                container.querySelectorAll('[data-sstv-tab]').forEach(b => {
                    b.classList.toggle('chip--active', b.dataset.sstvTab === sstvActiveTab);
                });
                
                getSstvContent().innerHTML = renderSSTVTabContent();
                attachSSTVHandlers();
            };
        });

        attachSSTVHandlers();
    }

    function renderSSTVTabContent() {
        // Reset preview displayed flag when content is re-rendered (canvas gets recreated)
        if (sstvActiveTab === 'transmit') {
            sstvPreviewDisplayed = false;
        }
        
        switch (sstvActiveTab) {
            case 'receive': return renderSSTVReceive();
            case 'transmit': return renderSSTVTransmit();
            case 'enhance': return renderSSTVEnhance();
            case 'history': return renderSSTVHistory();
            case 'settings': return renderSSTVSettings();
            default: return '';
        }
    }

    function renderSSTVReceive() {
        const isReceiving = typeof SSTVModule !== 'undefined' && SSTVModule.isReceiving();
        const decoderState = typeof SSTVModule !== 'undefined' ? SSTVModule.getDecoderState() : {};
        const dspAvailable = typeof SSTVDSPModule !== 'undefined';
        const waterfallRunning = dspAvailable && SSTVDSPModule.isWaterfallRunning();
        const slantEnabled = dspAvailable && SSTVDSPModule.isSlantCorrectionEnabled();

        return `
            <div class="card" style="margin-bottom:16px">
                <div class="card__title">Audio Input</div>
                <p style="color:var(--text-secondary);font-size:13px;margin-bottom:12px">
                    Connect your radio's audio output to your device's microphone input via audio cable.
                </p>
                
                <!-- Signal Meter -->
                <div style="margin-bottom:16px">
                    <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                        <span style="font-size:12px;color:var(--text-secondary)">Signal Level</span>
                        <span id="sstv-signal-level" style="font-size:12px;font-family:var(--font-mono)">--</span>
                    </div>
                    <div style="background:var(--bg-secondary);border-radius:4px;height:8px;overflow:hidden">
                        <div id="sstv-signal-bar" style="background:var(--accent);height:100%;width:0%;transition:width 0.1s"></div>
                    </div>
                    <div id="sstv-signal-guidance" style="font-size:11px;color:var(--text-secondary);margin-top:4px;min-height:14px"></div>
                </div>

                <!-- Waterfall Display -->
                ${dspAvailable ? `
                <div style="margin-bottom:16px">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                        <span style="font-size:12px;font-weight:500">üìä Waterfall Display</span>
                        <div style="display:flex;gap:4px;align-items:center">
                            <select id="sstv-waterfall-colormap" style="font-size:11px;padding:2px 4px;border-radius:4px;background:var(--bg-secondary);border:1px solid var(--border);color:var(--text-primary)">
                                <option value="viridis" selected>Viridis</option>
                                <option value="plasma">Plasma</option>
                                <option value="thermal">Thermal</option>
                                <option value="grayscale">Grayscale</option>
                            </select>
                            <button id="sstv-waterfall-expand" class="btn btn--icon btn--small" title="Expand waterfall" style="padding:4px 6px;min-width:auto">
                                ‚õ∂
                            </button>
                        </div>
                    </div>
                    <div id="sstv-waterfall-container" style="background:#000;border-radius:8px;padding:4px;position:relative">
                        <canvas id="sstv-waterfall-canvas" width="400" height="150" style="width:100%;height:150px;display:block;border-radius:4px"></canvas>
                        <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--text-secondary);margin-top:4px;padding:0 4px">
                            <span>1100 Hz</span>
                            <span>SYNC</span>
                            <span>BLACK</span>
                            <span>VIS</span>
                            <span>WHITE</span>
                            <span>2400 Hz</span>
                        </div>
                    </div>
                    <div id="sstv-dominant-freq" style="font-size:11px;color:var(--accent);margin-top:4px;text-align:center">--</div>
                </div>
                ` : ''}

                <!-- Decoder Status -->
                <div style="background:var(--bg-secondary);border-radius:8px;padding:12px;margin-bottom:16px">
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px">
                        <span>Status:</span>
                        <span id="sstv-rx-phase" style="font-weight:500">${decoderState.phase || 'IDLE'}</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px">
                        <span>Mode:</span>
                        <span id="sstv-rx-mode" style="font-weight:500">${decoderState.mode || '--'}</span>
                    </div>
                    <div style="display:flex;justify-content:space-between">
                        <span>Progress:</span>
                        <span id="sstv-rx-progress" style="font-weight:500">${decoderState.mode ? 
                            `${decoderState.currentLine || 0}/${SSTVModule.MODES[decoderState.mode]?.height || 0}` : '--'}</span>
                    </div>
                </div>

                <!-- Preview -->
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                    <span style="font-size:12px;font-weight:500">üñºÔ∏è Received Image</span>
                    <button id="sstv-preview-expand" class="btn btn--icon btn--small" title="Expand image" style="padding:4px 6px;min-width:auto">
                        ‚õ∂
                    </button>
                </div>
                <div id="sstv-rx-preview" style="background:#000;border-radius:8px;aspect-ratio:4/3;display:flex;align-items:center;justify-content:center;margin-bottom:16px;position:relative">
                    <canvas id="sstv-rx-canvas" style="max-width:100%;max-height:100%;display:none"></canvas>
                    <span id="sstv-rx-placeholder" style="color:var(--text-secondary)">No image</span>
                </div>

                <!-- Controls -->
                <div style="display:flex;gap:8px">
                    ${isReceiving ? `
                        <button class="btn btn--danger" id="sstv-stop-rx" style="flex:1">
                            ${Icons.get('stop')} Stop
                        </button>
                    ` : `
                        <button class="btn btn--primary" id="sstv-start-rx" style="flex:1">
                            ${Icons.get('antenna')} Start Receive
                        </button>
                    `}
                </div>
            </div>

            <!-- Slant Correction -->
            ${dspAvailable ? `
            <div class="card" style="margin-bottom:16px">
                <div class="card__title">üîß Auto-Slant Correction</div>
                <p style="color:var(--text-secondary);font-size:12px;margin-bottom:12px">
                    Automatically corrects image skew caused by sample rate mismatches between your device and the transmitter.
                </p>
                
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;flex:1">
                        <input type="checkbox" id="sstv-slant-enabled" ${slantEnabled ? 'checked' : ''}>
                        <span>Enable auto-correction</span>
                    </label>
                </div>
                
                <div id="sstv-slant-info" style="background:var(--bg-secondary);border-radius:8px;padding:12px;font-size:12px">
                    <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                        <span>Expected line time:</span>
                        <span id="sstv-slant-expected">--</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                        <span>Measured line time:</span>
                        <span id="sstv-slant-measured">--</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px">
                        <span>Correction:</span>
                        <span id="sstv-slant-correction" style="font-weight:500;color:var(--accent)">0.00%</span>
                    </div>
                    <div style="display:flex;gap:8px">
                        <button class="btn btn--secondary btn--small" id="sstv-slant-reset" style="flex:1">
                            Reset Analysis
                        </button>
                    </div>
                </div>
                
                <!-- Manual Correction -->
                <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">
                    <div style="font-size:12px;margin-bottom:8px">Manual Correction</div>
                    <div style="display:flex;align-items:center;gap:8px">
                        <input type="range" id="sstv-slant-manual" min="-5" max="5" step="0.1" value="0" 
                            style="flex:1" title="Manual slant adjustment">
                        <span id="sstv-slant-manual-value" style="font-family:var(--font-mono);font-size:11px;min-width:50px;text-align:right">0.0%</span>
                    </div>
                    <p style="font-size:10px;color:var(--text-secondary);margin-top:4px">
                        Use this to manually correct slant on completed images in History.
                    </p>
                </div>
            </div>

            <!-- Frequency Drift Compensation -->
            <div class="card" style="margin-bottom:16px">
                <div class="card__title">üì° Frequency Drift Compensation</div>
                <p style="color:var(--text-secondary);font-size:12px;margin-bottom:12px">
                    Compensates for transmitter frequency drift by tracking the sync pulse frequency.
                </p>
                
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;flex:1">
                        <input type="checkbox" id="sstv-drift-enabled" ${SSTVDSPModule.isDriftCorrectionEnabled() ? 'checked' : ''}>
                        <span>Enable auto-correction</span>
                    </label>
                </div>
                
                <div id="sstv-drift-info" style="background:var(--bg-secondary);border-radius:8px;padding:12px;font-size:12px">
                    <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                        <span>Expected sync:</span>
                        <span>1200 Hz</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                        <span>Measured sync:</span>
                        <span id="sstv-drift-measured">-- Hz</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                        <span>Drift:</span>
                        <span id="sstv-drift-value" style="font-weight:500;color:var(--accent)">0.0 Hz</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px">
                        <span>Confidence:</span>
                        <span id="sstv-drift-confidence">--</span>
                    </div>
                    <div style="display:flex;gap:8px">
                        <button class="btn btn--secondary btn--small" id="sstv-drift-reset" style="flex:1">
                            Reset
                        </button>
                    </div>
                </div>
                
                <!-- Manual Drift Adjustment -->
                <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">
                    <div style="font-size:12px;margin-bottom:8px">Manual Adjustment</div>
                    <div style="display:flex;align-items:center;gap:8px">
                        <input type="range" id="sstv-drift-manual" min="-50" max="50" step="1" value="0" 
                            style="flex:1" title="Manual drift adjustment">
                        <span id="sstv-drift-manual-value" style="font-family:var(--font-mono);font-size:11px;min-width:50px;text-align:right">0 Hz</span>
                    </div>
                </div>
            </div>
            ` : ''}

            <div class="card">
                <div class="card__title">Connection Guide</div>
                <ol style="padding-left:20px;color:var(--text-secondary);font-size:13px;line-height:1.6">
                    <li>Connect audio cable from radio headphone/speaker jack to device mic input</li>
                    <li>Set radio to SSTV frequency (e.g., 14.230 MHz USB, 145.500 MHz FM)</li>
                    <li>Adjust radio volume to moderate level</li>
                    <li>Click "Start Receive" and wait for SSTV signal</li>
                </ol>
            </div>
        `;
    }

    function renderSSTVTransmit() {
        const settings = typeof SSTVModule !== 'undefined' ? SSTVModule.getSettings() : {};
        const isTransmitting = typeof SSTVModule !== 'undefined' && SSTVModule.isTransmitting();
        const modes = typeof SSTVModule !== 'undefined' ? SSTVModule.MODES : {};

        return `
            <div class="card" style="margin-bottom:16px">
                <div class="card__title">Transmit Settings</div>
                
                ${!settings.callsign ? `
                    <div class="alert alert--warning" style="margin-bottom:12px">
                        ‚ö†Ô∏è Callsign required for transmission. Set in Settings tab.
                    </div>
                ` : ''}

                <!-- Mode Selection -->
                <div class="form-group">
                    <label class="form-label">Mode</label>
                    <select id="sstv-tx-mode" class="form-select">
                        ${Object.entries(modes).map(([key, mode]) => `
                            <option value="${key}" ${sstvTransmitMode === key ? 'selected' : ''}>
                                ${mode.name} (${mode.width}√ó${mode.height}, ${mode.totalTime}s)
                            </option>
                        `).join('')}
                    </select>
                    <div style="font-size:12px;color:var(--text-secondary);margin-top:4px">
                        ${modes[sstvTransmitMode]?.description || ''}
                    </div>
                </div>

                <!-- Source Selection -->
                <div class="form-group">
                    <label class="form-label">Image Source</label>
                    <div style="display:flex;gap:8px;flex-wrap:wrap">
                        <button class="chip ${sstvTransmitSource === 'camera' ? 'chip--active' : ''}" data-sstv-source="camera">
                            üì∑ Camera
                        </button>
                        <button class="chip ${sstvTransmitSource === 'gallery' ? 'chip--active' : ''}" data-sstv-source="gallery">
                            üñºÔ∏è Gallery
                        </button>
                        <button class="chip ${sstvTransmitSource === 'map' ? 'chip--active' : ''}" data-sstv-source="map">
                            üó∫Ô∏è Map View
                        </button>
                    </div>
                </div>

                <!-- Annotation Toolbar -->
                <div id="sstv-annotation-toolbar" style="background:var(--bg-secondary);border-radius:8px;padding:8px;margin-bottom:8px;display:none">
                    <div style="display:flex;flex-wrap:wrap;gap:4px;align-items:center">
                        <!-- Drawing Tools -->
                        <button class="btn btn--small sstv-tool-btn sstv-tool-active" data-tool="pen" title="Pen">‚úèÔ∏è</button>
                        <button class="btn btn--small sstv-tool-btn" data-tool="arrow" title="Arrow">‚û°Ô∏è</button>
                        <button class="btn btn--small sstv-tool-btn" data-tool="circle" title="Circle">‚≠ï</button>
                        <button class="btn btn--small sstv-tool-btn" data-tool="rect" title="Rectangle">‚ñ¢</button>
                        <button class="btn btn--small sstv-tool-btn" data-tool="text" title="Text">T</button>
                        <button class="btn btn--small sstv-tool-btn" data-tool="eraser" title="Eraser">üßπ</button>
                        
                        <div style="width:1px;height:24px;background:var(--border);margin:0 4px"></div>
                        
                        <!-- Color Picker -->
                        <input type="color" id="sstv-annotation-color" value="#ff0000" title="Color" 
                            style="width:32px;height:28px;padding:0;border:none;cursor:pointer;border-radius:4px">
                        
                        <!-- Line Width -->
                        <select id="sstv-annotation-width" title="Line width" 
                            style="padding:4px;border-radius:4px;background:var(--bg-primary);color:var(--text-primary);border:1px solid var(--border)">
                            <option value="2">Thin</option>
                            <option value="4" selected>Medium</option>
                            <option value="8">Thick</option>
                            <option value="12">Bold</option>
                        </select>
                        
                        <div style="width:1px;height:24px;background:var(--border);margin:0 4px"></div>
                        
                        <!-- Actions -->
                        <button class="btn btn--small btn--secondary" id="sstv-annotation-undo" title="Undo">‚Ü©Ô∏è</button>
                        <button class="btn btn--small btn--secondary" id="sstv-annotation-clear" title="Clear all">üóëÔ∏è</button>
                    </div>
                    
                    <!-- Text input (shown when text tool selected) -->
                    <div id="sstv-text-input-container" style="display:none;margin-top:8px">
                        <input type="text" id="sstv-annotation-text" placeholder="Enter text, then click on image" 
                            style="width:100%;padding:6px 8px;border-radius:4px;background:var(--bg-primary);color:var(--text-primary);border:1px solid var(--border)">
                    </div>
                </div>

                <!-- Image Preview with Annotation Layer -->
                <div id="sstv-tx-preview" style="background:#000;border-radius:8px;aspect-ratio:4/3;display:flex;align-items:center;justify-content:center;margin-bottom:16px;position:relative;overflow:hidden">
                    <canvas id="sstv-tx-canvas" style="max-width:100%;max-height:100%;display:none;position:absolute"></canvas>
                    <canvas id="sstv-annotation-canvas" style="max-width:100%;max-height:100%;display:none;position:absolute;cursor:crosshair"></canvas>
                    <span id="sstv-tx-placeholder" style="color:var(--text-secondary)">${sstvCapturedImageData ? 'Loading preview...' : 'Select image source'}</span>
                    ${settings.callsign && settings.autoCallsignOverlay ? `
                        <div style="position:absolute;bottom:8px;left:8px;background:rgba(0,0,0,0.6);padding:4px 8px;border-radius:4px;font-family:monospace;font-size:12px;z-index:10;pointer-events:none">
                            ${settings.callsign}${settings.gridSquare ? ' ' + settings.gridSquare : ''}
                        </div>
                    ` : ''}
                    ${sstvCapturedImageData ? `
                        <button id="sstv-clear-preview-btn" style="position:absolute;top:8px;right:8px;background:rgba(0,0,0,0.6);border:none;border-radius:4px;padding:4px 8px;font-size:11px;color:#fff;cursor:pointer;z-index:10" title="Clear image">‚úï</button>
                    ` : ''}
                </div>

                <!-- Hidden file input -->
                <input type="file" id="sstv-file-input" accept="image/*" style="display:none">

                <!-- Transmit Button -->
                <button class="btn btn--primary" id="sstv-transmit-btn" style="width:100%" 
                    ${!settings.callsign || isTransmitting ? 'disabled' : ''}>
                    ${isTransmitting ? `
                        ${Icons.get('broadcast')} Transmitting...
                    ` : `
                        üì° Transmit SSTV
                    `}
                </button>
                
                <p style="font-size:11px;color:var(--text-secondary);margin-top:8px;text-align:center">
                    Requires valid amateur radio license. Audio outputs to speaker/headphone jack.
                </p>
            </div>

            <div class="card">
                <div class="card__title">Transmission Guide</div>
                <ol style="padding-left:20px;color:var(--text-secondary);font-size:13px;line-height:1.6">
                    <li>Connect device audio output to radio mic input (use appropriate interface)</li>
                    <li>Set radio to SSTV frequency and enable TX</li>
                    <li>Select image source and verify preview</li>
                    <li>Key PTT (or use VOX) and click Transmit</li>
                    <li>Wait for transmission to complete before releasing PTT</li>
                </ol>
            </div>
        `;
    }

    function renderSSTVHistory() {
        const images = typeof SSTVModule !== 'undefined' ? SSTVModule.getReceivedImages() : [];

        if (images.length === 0) {
            return `
                <div class="empty-state">
                    <div class="empty-state__icon">${Icons.get('image')}</div>
                    <div class="empty-state__title">No Received Images</div>
                    <div class="empty-state__desc">Received SSTV images will appear here</div>
                </div>
            `;
        }

        return `
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                <span style="color:var(--text-secondary)">${images.length} image${images.length !== 1 ? 's' : ''}</span>
                <button class="btn btn--secondary btn--small" id="sstv-clear-history">
                    ${Icons.get('trash')} Clear All
                </button>
            </div>

            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
                ${images.map(img => `
                    <div class="card" style="padding:8px;cursor:pointer" data-sstv-image="${img.id}">
                        <div style="background:#000;border-radius:4px;aspect-ratio:4/3;overflow:hidden;margin-bottom:8px">
                            <img src="${img.imageData ? SSTVModule.imageDataToDataURL(img.imageData) : ''}" 
                                 style="width:100%;height:100%;object-fit:contain"
                                 alt="SSTV ${img.mode}">
                        </div>
                        <div style="font-size:11px">
                            <div style="font-weight:500">${img.mode}</div>
                            <div style="color:var(--text-secondary)">${new Date(img.timestamp).toLocaleString()}</div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }

    function renderSSTVEnhance() {
        const images = typeof SSTVModule !== 'undefined' ? SSTVModule.getReceivedImages() : [];
        const enhanceAvailable = typeof SSTVEnhanceModule !== 'undefined';
        const isProcessing = enhanceAvailable && SSTVEnhanceModule.isProcessing();
        
        // Initialize enhance module if needed
        if (enhanceAvailable && !sstvEnhanceInitialized) {
            SSTVEnhanceModule.init().then(() => {
                sstvEnhanceInitialized = true;
                
                // Subscribe to progress events
                if (typeof Events !== 'undefined') {
                    Events.on('sstvEnhance:progress', handleEnhanceProgress);
                }
            }).catch(err => {
                console.warn('[Panels] SSTV Enhance init failed:', err.message);
            });
        }

        if (!enhanceAvailable) {
            return `
                <div class="empty-state">
                    <div class="empty-state__icon">${Icons.get('zoomIn')}</div>
                    <div class="empty-state__title">AI Enhancement Not Available</div>
                    <div class="empty-state__desc">Enhancement module not loaded</div>
                </div>
            `;
        }

        return `
            <div class="card" style="margin-bottom:16px">
                <div class="card__title">‚ú® AI Image Enhancement</div>
                <p style="color:var(--text-secondary);font-size:13px;margin-bottom:16px">
                    Upscale, denoise, and extract text from SSTV images using neural networks.
                </p>

                <!-- Processing Status -->
                ${isProcessing ? `
                    <div class="alert alert--info" style="margin-bottom:12px">
                        <div style="display:flex;align-items:center;gap:8px">
                            <span class="spinner"></span>
                            <span id="enhance-status">Processing...</span>
                        </div>
                        <div style="background:var(--bg-secondary);border-radius:4px;height:4px;margin-top:8px;overflow:hidden">
                            <div id="enhance-progress-bar" style="background:var(--accent);height:100%;width:0%;transition:width 0.2s"></div>
                        </div>
                    </div>
                ` : ''}

                <!-- Enhancement Settings -->
                <div class="form-group">
                    <label class="form-label">Upscale Method</label>
                    <select id="enhance-method" class="form-select" ${isProcessing ? 'disabled' : ''}>
                        <option value="none" ${sstvEnhanceMethod === 'none' ? 'selected' : ''}>None (Denoise only)</option>
                        <option value="local-2x" ${sstvEnhanceMethod === 'local-2x' ? 'selected' : ''}>2√ó Upscale (Local, ~2MB model)</option>
                        <option value="local-4x" ${sstvEnhanceMethod === 'local-4x' ? 'selected' : ''}>4√ó Upscale (Local, ~17MB model)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Denoise Strength: ${Math.round(sstvEnhanceDenoiseStrength * 100)}%</label>
                    <input type="range" id="enhance-denoise" min="0" max="100" 
                        value="${Math.round(sstvEnhanceDenoiseStrength * 100)}"
                        style="width:100%" ${isProcessing ? 'disabled' : ''}>
                </div>

                <div class="form-group">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                        <input type="checkbox" id="enhance-ocr" ${sstvEnhanceOCR ? 'checked' : ''} ${isProcessing ? 'disabled' : ''}>
                        <span>Extract text (callsigns, coordinates)</span>
                    </label>
                </div>
            </div>

            <!-- Image Selection -->
            <div class="card" style="margin-bottom:16px">
                <div class="card__title">Select Image to Enhance</div>
                
                ${images.length === 0 ? `
                    <div style="text-align:center;padding:20px;color:var(--text-secondary)">
                        <p>No received images yet.</p>
                        <p style="font-size:12px">Receive SSTV images first, then enhance them here.</p>
                    </div>
                ` : `
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;max-height:200px;overflow-y:auto">
                        ${images.slice(0, 12).map(img => `
                            <div class="enhance-thumb ${sstvEnhanceSelectedImage === img.id ? 'enhance-thumb--selected' : ''}" 
                                 data-enhance-select="${img.id}"
                                 style="cursor:pointer;border:2px solid ${sstvEnhanceSelectedImage === img.id ? 'var(--accent)' : 'transparent'};
                                        border-radius:4px;overflow:hidden;aspect-ratio:4/3">
                                <img src="${img.imageData ? SSTVModule.imageDataToDataURL(img.imageData) : ''}" 
                                     style="width:100%;height:100%;object-fit:cover"
                                     alt="${img.mode}">
                            </div>
                        `).join('')}
                    </div>
                    
                    ${sstvEnhanceSelectedImage ? `
                        <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">
                            <div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px">
                                Selected: ${images.find(i => i.id === sstvEnhanceSelectedImage)?.mode || 'Unknown'}
                            </div>
                            <button class="btn btn--primary" id="enhance-start-btn" style="width:100%" ${isProcessing ? 'disabled' : ''}>
                                ${isProcessing ? '‚è≥ Processing...' : '‚ú® Enhance Image'}
                            </button>
                        </div>
                    ` : `
                        <p style="text-align:center;padding:12px;color:var(--text-secondary);font-size:12px">
                            Click an image above to select it
                        </p>
                    `}
                `}
            </div>

            <!-- Enhanced Result -->
            <div class="card" id="enhance-result-card" style="display:none">
                <div class="card__title">Enhanced Result</div>
                <div id="enhance-preview" style="background:#000;border-radius:8px;aspect-ratio:4/3;display:flex;align-items:center;justify-content:center;margin-bottom:12px">
                    <canvas id="enhance-result-canvas" style="max-width:100%;max-height:100%"></canvas>
                </div>
                
                <!-- OCR Results -->
                <div id="enhance-ocr-results" style="display:none;margin-bottom:12px">
                    <div style="font-weight:500;margin-bottom:8px">üìù Extracted Text</div>
                    <div id="enhance-ocr-content" style="background:var(--bg-secondary);border-radius:4px;padding:12px;font-family:var(--font-mono);font-size:12px"></div>
                </div>
                
                <div style="display:flex;gap:8px">
                    <button class="btn btn--primary" id="enhance-save-btn" style="flex:1">
                        ${Icons.get('download')} Save Enhanced
                    </button>
                    <button class="btn btn--secondary" id="enhance-compare-btn">
                        Compare
                    </button>
                </div>
            </div>

            <!-- Model Management -->
            <div class="card">
                <div class="card__title">üß† AI Models</div>
                <p style="font-size:12px;color:var(--text-secondary);margin-bottom:12px">
                    Models are downloaded separately to keep GridDown lightweight (~600KB).<br>
                    Import ONNX models for offline AI enhancement.
                </p>
                
                <!-- Installed Models -->
                <div style="margin-bottom:12px">
                    <div style="font-weight:500;margin-bottom:8px">Installed Models</div>
                    <div id="enhance-models-list" style="display:flex;flex-direction:column;gap:8px">
                        <!-- Model cards rendered by loadModelsList() -->
                        <div style="color:var(--text-secondary);font-size:12px">Loading...</div>
                    </div>
                </div>
                
                <!-- Import Model -->
                <div style="border-top:1px solid var(--border);padding-top:12px;margin-top:12px">
                    <div style="font-weight:500;margin-bottom:8px">Import Model</div>
                    <div style="display:flex;gap:8px;margin-bottom:8px">
                        <select id="enhance-import-model-type" class="form-select" style="flex:1">
                            <optgroup label="Upscaling (Recommended)">
                                <option value="realcugan-x2">Real-CUGAN 2√ó (2.9 MB) ‚≠ê</option>
                                <option value="realesrgan-x2">Real-ESRGAN 2√ó (6.5 MB)</option>
                                <option value="realesrgan-x4">Real-ESRGAN 4√ó (16.7 MB)</option>
                            </optgroup>
                            <optgroup label="Denoising">
                                <option value="scunet">SCUNet (9.2 MB)</option>
                                <option value="nafnet">NAFNet (8.4 MB)</option>
                            </optgroup>
                            <optgroup label="Face Enhancement">
                                <option value="gfpgan">GFPGAN (348 MB)</option>
                            </optgroup>
                        </select>
                        <button class="btn btn--secondary btn--small" id="enhance-import-btn">
                            üìÅ Import
                        </button>
                    </div>
                    <input type="file" id="enhance-model-file" accept=".onnx,.bin" style="display:none">
                    
                    <!-- Download Links -->
                    <div id="enhance-download-links" style="background:var(--bg-secondary);border-radius:4px;padding:10px;margin-top:8px">
                        <div style="font-size:11px;font-weight:500;margin-bottom:6px">üì• Download Sources</div>
                        <div style="font-size:11px;color:var(--text-secondary);line-height:1.5">
                            <strong>Real-CUGAN (Recommended for SSTV):</strong><br>
                            <a href="https://github.com/bilibili/ailab/tree/main/Real-CUGAN" target="_blank" rel="noopener" style="color:var(--accent)">GitHub (bilibili)</a> - Download up2x-latest-denoise3x.onnx<br>
                            <a href="https://huggingface.co/maadaa/Real-CUGAN/tree/main" target="_blank" rel="noopener" style="color:var(--accent)">Hugging Face</a> - Alternative mirror<br><br>
                            
                            <strong>Real-ESRGAN (General upscaling):</strong><br>
                            <a href="https://github.com/xinntao/Real-ESRGAN/releases" target="_blank" rel="noopener" style="color:var(--accent)">GitHub Releases</a> - Download realesrgan-x2/x4.onnx<br>
                            <a href="https://huggingface.co/ai-forever/Real-ESRGAN/tree/main" target="_blank" rel="noopener" style="color:var(--accent)">Hugging Face</a> - ONNX models<br><br>
                            
                            <strong>SCUNet (Denoising):</strong><br>
                            <a href="https://github.com/cszn/SCUNet" target="_blank" rel="noopener" style="color:var(--accent)">GitHub</a> - Best for radio interference patterns<br><br>
                            
                            <strong>NAFNet (Fast denoise):</strong><br>
                            <a href="https://github.com/megvii-research/NAFNet" target="_blank" rel="noopener" style="color:var(--accent)">GitHub</a> - Lightweight denoising
                        </div>
                    </div>
                </div>
                
                <!-- Cache Info -->
                <div style="border-top:1px solid var(--border);padding-top:12px;margin-top:12px">
                    <div id="enhance-cache-info" style="font-size:12px;color:var(--text-secondary)">
                        Loading cache info...
                    </div>
                    <button class="btn btn--secondary btn--small" id="enhance-clear-cache" style="margin-top:8px">
                        üóëÔ∏è Clear All Models
                    </button>
                </div>
            </div>
            
            <!-- OCR Info -->
            <div class="card">
                <div class="card__title">üìù OCR (Text Recognition)</div>
                <p style="font-size:12px;color:var(--text-secondary)">
                    OCR uses <a href="https://tesseract.projectnaptha.com/" target="_blank" rel="noopener" 
                    style="color:var(--accent)">Tesseract.js</a> loaded from CDN on demand (~3MB download).<br>
                    Extracts callsigns, grid squares, coordinates, and frequencies from images.<br><br>
                    <strong>No model download required</strong> - loaded automatically when OCR is enabled.
                </p>
            </div>
            
            <!-- Processing Tips -->
            <div class="card">
                <div class="card__title">üí° Tips</div>
                <ul style="font-size:12px;color:var(--text-secondary);margin:0;padding-left:16px;line-height:1.6">
                    <li><strong>Real-CUGAN 2√ó</strong> is recommended for SSTV - optimized for the noise patterns</li>
                    <li>Enable <strong>WebGPU</strong> in Chrome for 5-10√ó faster processing</li>
                    <li>Denoise before upscaling for best results with noisy SSTV images</li>
                    <li>OCR works best on enhanced images - run it after upscaling</li>
                    <li>Face enhancement (GFPGAN) is a large model - only needed for portraits</li>
                </ul>
            </div>
        `;
    }

    function handleEnhanceProgress(data) {
        const statusEl = document.getElementById('enhance-status');
        const progressBar = document.getElementById('enhance-progress-bar');
        
        if (statusEl) statusEl.textContent = data.message;
        if (progressBar) progressBar.style.width = `${Math.round(data.progress * 100)}%`;
        
        if (data.phase === 'complete' || data.phase === 'error') {
            sstvEnhanceProcessing = false;
        }
    }

    async function runEnhancement() {
        if (!sstvEnhanceSelectedImage || sstvEnhanceProcessing) return;
        
        const images = SSTVModule.getReceivedImages();
        const selectedImg = images.find(i => i.id === sstvEnhanceSelectedImage);
        if (!selectedImg || !selectedImg.imageData) return;
        
        sstvEnhanceProcessing = true;
        getSstvContent().innerHTML = renderSSTVEnhance();
        attachSSTVHandlers();
        
        try {
            const result = await SSTVEnhanceModule.enhance(selectedImg.imageData, {
                upscaleMethod: sstvEnhanceMethod,
                denoiseStrength: sstvEnhanceDenoiseStrength,
                runOcr: sstvEnhanceOCR
            });
            
            // Show result
            const resultCard = document.getElementById('enhance-result-card');
            const canvas = domCache.get('enhance-result-canvas');
            const ocrResults = document.getElementById('enhance-ocr-results');
            const ocrContent = document.getElementById('enhance-ocr-content');
            
            if (resultCard && canvas) {
                resultCard.style.display = 'block';
                canvas.width = result.imageData.width;
                canvas.height = result.imageData.height;
                canvas.getContext('2d').putImageData(result.imageData, 0, 0);
                
                // Store for saving
                window._enhancedImageData = result.imageData;
                window._enhancedMetadata = result.metadata;
            }
            
            // Show OCR results
            if (ocrResults && ocrContent && result.metadata.ocr) {
                const ocr = result.metadata.ocr.extracted || {};
                let ocrHtml = '';
                
                if (ocr.callsigns && ocr.callsigns.length > 0) {
                    ocrHtml += `<div><strong>Callsigns:</strong> ${ocr.callsigns.join(', ')}</div>`;
                }
                if (ocr.gridSquares && ocr.gridSquares.length > 0) {
                    ocrHtml += `<div><strong>Grid Squares:</strong> ${ocr.gridSquares.join(', ')}</div>`;
                }
                if (ocr.coordinates && ocr.coordinates.length > 0) {
                    ocrHtml += `<div><strong>Coordinates:</strong> ${ocr.coordinates.join('; ')}</div>`;
                }
                if (ocr.frequencies && ocr.frequencies.length > 0) {
                    ocrHtml += `<div><strong>Frequencies:</strong> ${ocr.frequencies.join(', ')}</div>`;
                }
                
                if (ocrHtml) {
                    ocrContent.innerHTML = ocrHtml;
                    ocrResults.style.display = 'block';
                } else if (result.metadata.ocr.raw) {
                    ocrContent.innerHTML = `<em>Raw text:</em><br><pre style="white-space:pre-wrap;font-size:11px">${Helpers.escapeHtml(result.metadata.ocr.raw.substring(0, 500))}</pre>`;
                    ocrResults.style.display = 'block';
                } else {
                    ocrContent.innerHTML = '<em>No text detected</em>';
                    ocrResults.style.display = 'block';
                }
            }
            
            if (typeof ModalsModule !== 'undefined') {
                ModalsModule.showToast(`Enhanced in ${result.metadata.processingTime}ms`, 'success');
            }
            
        } catch (err) {
            console.error('[SSTV Enhance] Error:', err);
            if (typeof ModalsModule !== 'undefined') {
                ModalsModule.showToast(`Enhancement failed: ${err.message}`, 'error');
            }
        }
        
        sstvEnhanceProcessing = false;
        getSstvContent().innerHTML = renderSSTVEnhance();
        attachSSTVHandlers();
    }

    function saveEnhancedImage() {
        if (!window._enhancedImageData) return;
        
        const canvas = document.createElement('canvas');
        canvas.width = window._enhancedImageData.width;
        canvas.height = window._enhancedImageData.height;
        canvas.getContext('2d').putImageData(window._enhancedImageData, 0, 0);
        
        const dataURL = canvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.href = dataURL;
        link.download = `sstv_enhanced_${Date.now()}.png`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        if (typeof ModalsModule !== 'undefined') {
            ModalsModule.showToast('Enhanced image saved', 'success');
        }
    }

    async function loadEnhanceCacheInfo() {
        const infoEl = document.getElementById('enhance-cache-info');
        const modelsListEl = document.getElementById('enhance-models-list');
        
        if (typeof SSTVEnhanceModule === 'undefined') {
            if (infoEl) infoEl.innerHTML = 'Enhancement module not loaded';
            if (modelsListEl) modelsListEl.innerHTML = '<div style="color:var(--text-secondary);font-size:12px">Module not loaded</div>';
            return;
        }
        
        try {
            // Load available models with cache status
            const models = await SSTVEnhanceModule.getAvailableModels();
            const cached = await SSTVEnhanceModule.getCachedModels();
            
            // Render models list
            if (modelsListEl) {
                modelsListEl.innerHTML = models.map(m => `
                    <div style="background:var(--bg-secondary);border-radius:4px;padding:8px;display:flex;justify-content:space-between;align-items:center">
                        <div>
                            <div style="font-weight:500;font-size:13px">${m.name}</div>
                            <div style="font-size:11px;color:var(--text-secondary)">
                                ${m.description} ‚Ä¢ ${m.size}
                            </div>
                        </div>
                        <div>
                            ${m.cached ? 
                                `<span style="color:var(--success);font-size:12px">‚úì Cached</span>` :
                                `<span style="color:var(--text-secondary);font-size:12px">Not cached</span>`
                            }
                        </div>
                    </div>
                `).join('');
            }
            
            // Update cache info
            if (infoEl) {
                if (cached.length === 0) {
                    infoEl.innerHTML = 'No models cached. Import ONNX models for offline AI enhancement.';
                } else {
                    const totalSize = cached.reduce((sum, m) => sum + (m.size || 0), 0);
                    infoEl.innerHTML = `
                        <strong>${cached.length}</strong> model(s) cached 
                        (<strong>${(totalSize / 1024 / 1024).toFixed(1)} MB</strong>)
                    `;
                }
            }
        } catch (err) {
            console.error('[SSTV Enhance] Cache info error:', err);
            if (infoEl) infoEl.innerHTML = 'Cache info unavailable';
            if (modelsListEl) modelsListEl.innerHTML = '<div style="color:var(--warning);font-size:12px">Error loading models</div>';
        }
    }

    async function importEnhanceModel() {
        if (typeof SSTVEnhanceModule === 'undefined') return;
        
        const modelTypeSelect = document.getElementById('enhance-import-model-type');
        const modelId = modelTypeSelect?.value;
        if (!modelId) return;
        
        const fileInput = document.getElementById('enhance-model-file');
        if (!fileInput) return;
        
        // Trigger file selection
        fileInput.onchange = async () => {
            const file = fileInput.files?.[0];
            if (!file) return;
            
            try {
                if (typeof ModalsModule !== 'undefined') {
                    ModalsModule.showToast(`Importing ${file.name}...`, 'info');
                }
                
                // Map select values to MODEL_REGISTRY IDs
                const modelIdMap = {
                    'realcugan-x2': 'realcugan-x2',
                    'realesrgan-x2': 'realesrgan-x2',
                    'realesrgan-x4': 'realesrgan-x4',
                    'scunet': 'scunet',
                    'nafnet': 'nafnet',
                    'gfpgan': 'gfpgan'
                };
                
                const actualModelId = modelIdMap[modelId] || modelId;
                await SSTVEnhanceModule.importModel(actualModelId, file);
                
                if (typeof ModalsModule !== 'undefined') {
                    ModalsModule.showToast('Model imported successfully!', 'success');
                }
                
                // Refresh the display
                await loadEnhanceCacheInfo();
                
            } catch (err) {
                console.error('[SSTV Enhance] Import error:', err);
                if (typeof ModalsModule !== 'undefined') {
                    ModalsModule.showToast(`Import failed: ${err.message}`, 'error');
                }
            }
            
            // Clear file input
            fileInput.value = '';
        };
        
        fileInput.click();
    }

    async function clearEnhanceModels() {
        if (typeof SSTVEnhanceModule === 'undefined') return;
        
        if (typeof ModalsModule !== 'undefined') {
            const confirmed = await ModalsModule.confirm(
                'Clear All Models',
                'Are you sure you want to delete all downloaded AI models? You will need to re-import them to use AI enhancement.'
            );
            if (!confirmed) return;
        }
        
        try {
            const count = await SSTVEnhanceModule.clearAllModels();
            if (typeof ModalsModule !== 'undefined') {
                ModalsModule.showToast(`Cleared ${count} model(s)`, 'success');
            }
            await loadEnhanceCacheInfo();
        } catch (err) {
            console.error('[SSTV Enhance] Clear error:', err);
            if (typeof ModalsModule !== 'undefined') {
                ModalsModule.showToast(`Failed to clear models: ${err.message}`, 'error');
            }
        }
    }

    function renderSSTVSettings() {
        const settings = typeof SSTVModule !== 'undefined' ? SSTVModule.getSettings() : {};

        return `
            <div class="card" style="margin-bottom:16px">
                <div class="card__title">Station Information</div>
                
                <div class="form-group">
                    <label class="form-label">Callsign</label>
                    <input type="text" id="sstv-callsign" class="form-input" 
                        value="${settings.callsign || ''}" 
                        placeholder="e.g., W1ABC"
                        style="text-transform:uppercase">
                    <div style="font-size:11px;color:var(--text-secondary);margin-top:4px">
                        Required for transmission. Auto-added to images.
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Grid Square</label>
                    <div style="display:flex;gap:8px">
                        <input type="text" id="sstv-grid" class="form-input" 
                            value="${settings.gridSquare || ''}" 
                            placeholder="e.g., EM48wu"
                            style="flex:1;text-transform:uppercase">
                        <button class="btn btn--secondary" id="sstv-grid-gps" title="Get from GPS">
                            ${Icons.get('locate')}
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Default Mode</label>
                    <select id="sstv-default-mode" class="form-select">
                        ${Object.entries(typeof SSTVModule !== 'undefined' ? SSTVModule.MODES : {}).map(([key, mode]) => `
                            <option value="${key}" ${settings.defaultMode === key ? 'selected' : ''}>
                                ${mode.name}
                            </option>
                        `).join('')}
                    </select>
                </div>

                <div class="form-group">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                        <input type="checkbox" id="sstv-auto-callsign" 
                            ${settings.autoCallsignOverlay ? 'checked' : ''}>
                        <span>Auto-add callsign overlay to images</span>
                    </label>
                </div>
            </div>

            <div class="card" style="margin-bottom:16px">
                <div class="card__title">Audio Settings</div>
                
                <div class="form-group">
                    <label class="form-label">Output Volume</label>
                    <input type="range" id="sstv-gain" min="0" max="100" 
                        value="${Math.round((settings.gainLevel || 1) * 100)}"
                        style="width:100%">
                </div>

                <div class="form-group">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                        <input type="checkbox" id="sstv-vox" 
                            ${settings.voxEnabled ? 'checked' : ''}>
                        <span>VOX mode (auto-trigger on audio)</span>
                    </label>
                </div>
            </div>

            <div class="card">
                <div class="card__title">License Acknowledgment</div>
                <p style="color:var(--text-secondary);font-size:13px;margin-bottom:12px">
                    SSTV transmission requires a valid amateur radio license and compliance with 
                    applicable regulations (FCC Part 97 in the US).
                </p>
                <label style="display:flex;align-items:flex-start;gap:8px;cursor:pointer">
                    <input type="checkbox" id="sstv-license-ack" 
                        ${settings.licenseAcknowledged ? 'checked' : ''}>
                    <span style="font-size:13px">I hold a valid amateur radio license and will comply with all applicable regulations</span>
                </label>
            </div>

            <button class="btn btn--primary" id="sstv-save-settings" style="width:100%;margin-top:16px">
                Save Settings
            </button>
        `;
    }

    // Waterfall update interval ID
    let waterfallUpdateInterval = null;

    /**
     * Initialize SSTV waterfall display
     */
    async function initSSTVWaterfall() {
        if (typeof SSTVDSPModule === 'undefined' || typeof SSTVModule === 'undefined') {
            console.warn('[SSTV] DSP module not available for waterfall');
            return;
        }

        const canvas = domCache.get('sstv-waterfall-canvas');
        if (!canvas) {
            console.warn('[SSTV] Waterfall canvas not found');
            return;
        }

        // Get audio context and source from SSTVModule
        // Note: SSTVModule needs to expose these for waterfall integration
        const audioState = SSTVModule._getAudioState ? SSTVModule._getAudioState() : null;
        
        if (audioState && audioState.context && audioState.source) {
            const success = SSTVDSPModule.initWaterfall(
                canvas, 
                audioState.context, 
                audioState.source
            );
            
            if (success) {
                SSTVDSPModule.startWaterfall();
                startWaterfallUpdateLoop();
                console.log('[SSTV] Waterfall display initialized');
            }
        } else {
            console.warn('[SSTV] Audio state not available for waterfall');
        }
    }

    /**
     * Start waterfall update loop for frequency/signal display
     */
    function startWaterfallUpdateLoop() {
        if (waterfallUpdateInterval) {
            clearInterval(waterfallUpdateInterval);
        }

        waterfallUpdateInterval = setInterval(() => {
            if (typeof SSTVDSPModule === 'undefined') return;
            if (!SSTVModule.isReceiving()) {
                clearInterval(waterfallUpdateInterval);
                waterfallUpdateInterval = null;
                return;
            }

            // Update dominant frequency display
            const freqInfo = SSTVDSPModule.getDominantFrequency();
            const freqDisplay = domCache.get('sstv-dominant-freq');
            if (freqDisplay && freqInfo) {
                freqDisplay.textContent = `${freqInfo.frequency.toFixed(0)} Hz (${(freqInfo.amplitude * 100).toFixed(0)}%)`;
            }

            // Update signal quality guidance
            const signalQuality = SSTVDSPModule.analyzeSignalQuality();
            const guidanceDisplay = domCache.get('sstv-signal-guidance');
            if (guidanceDisplay && signalQuality) {
                guidanceDisplay.textContent = signalQuality.guidance;
                
                // Color based on status
                const colors = {
                    none: 'var(--text-secondary)',
                    weak: 'var(--warning)',
                    overload: 'var(--danger)',
                    noise: 'var(--text-secondary)',
                    signal: 'var(--accent)',
                    sstv: 'var(--success)'
                };
                guidanceDisplay.style.color = colors[signalQuality.status] || 'var(--text-secondary)';
            }

            // Update slant display
            updateSlantDisplay();

            // Update drift display
            updateDriftDisplay();
        }, 200);
    }

    /**
     * Update slant correction display
     */
    function updateSlantDisplay() {
        if (typeof SSTVDSPModule === 'undefined') return;

        const factor = SSTVDSPModule.getSlantFactor();
        const config = SSTVDSPModule.getConfig();
        
        const expectedEl = domCache.get('sstv-slant-expected');
        const measuredEl = domCache.get('sstv-slant-measured');
        const correctionEl = domCache.get('sstv-slant-correction');

        // These would be populated by slant analysis events
        // For now just show current factor
        if (correctionEl) {
            const percent = ((factor - 1) * 100).toFixed(2);
            correctionEl.textContent = `${percent}%`;
            correctionEl.style.color = Math.abs(factor - 1) < 0.01 ? 'var(--text-secondary)' : 'var(--accent)';
        }
    }

    /**
     * Handle slant analysis events from DSP module
     */
    if (typeof Events !== 'undefined') {
        Events.on('sstv:slantAnalysis', (data) => {
            const expectedEl = domCache.get('sstv-slant-expected');
            const measuredEl = domCache.get('sstv-slant-measured');
            const correctionEl = domCache.get('sstv-slant-correction');

            if (expectedEl) expectedEl.textContent = `${data.expectedLineTime.toFixed(2)} ms`;
            if (measuredEl) measuredEl.textContent = `${data.measuredLineTime.toFixed(2)} ms`;
            if (correctionEl) {
                correctionEl.textContent = `${data.slantPercent.toFixed(2)}%`;
                correctionEl.style.color = Math.abs(data.slantPercent) < 1 ? 'var(--text-secondary)' : 'var(--accent)';
            }
        });

        Events.on('sstv:driftAnalysis', (data) => {
            const measuredEl = domCache.get('sstv-drift-measured');
            const driftEl = domCache.get('sstv-drift-value');
            const confidenceEl = domCache.get('sstv-drift-confidence');

            if (measuredEl) measuredEl.textContent = `${data.measuredSyncFreq.toFixed(1)} Hz`;
            if (driftEl) {
                driftEl.textContent = `${data.driftHz >= 0 ? '+' : ''}${data.driftHz.toFixed(1)} Hz`;
                driftEl.style.color = Math.abs(data.driftHz) < 5 ? 'var(--text-secondary)' : 'var(--accent)';
            }
            if (confidenceEl) {
                confidenceEl.textContent = `${(data.confidence * 100).toFixed(0)}%`;
            }
        });
    }

    /**
     * Update drift compensation display
     */
    function updateDriftDisplay() {
        if (typeof SSTVDSPModule === 'undefined') return;

        const status = SSTVDSPModule.getDriftAnalysisStatus();
        
        const measuredEl = domCache.get('sstv-drift-measured');
        const driftEl = domCache.get('sstv-drift-value');
        const confidenceEl = domCache.get('sstv-drift-confidence');

        if (measuredEl) {
            measuredEl.textContent = status.measurementCount > 0 ? 
                `${status.lastSyncFreq.toFixed(1)} Hz` : '-- Hz';
        }
        if (driftEl) {
            const drift = status.driftHz;
            driftEl.textContent = `${drift >= 0 ? '+' : ''}${drift.toFixed(1)} Hz`;
            driftEl.style.color = Math.abs(drift) < 5 ? 'var(--text-secondary)' : 'var(--accent)';
        }
        if (confidenceEl) {
            confidenceEl.textContent = status.measurementCount > 0 ? 
                `${(status.confidence * 100).toFixed(0)}%` : '--';
        }
    }

    // SSTV Expanded View state
    let sstvExpandedModal = null;
    let sstvExpandedCanvas = null;
    let sstvExpandedType = null;
    let sstvExpandedUpdateInterval = null;

    /**
     * Open SSTV expanded view modal
     * @param {string} type - 'waterfall' or 'preview'
     */
    function openSSTVExpandedView(type) {
        // Close any existing expanded view
        closeSSTVExpandedView();
        
        sstvExpandedType = type;
        
        // Create modal overlay
        sstvExpandedModal = document.createElement('div');
        sstvExpandedModal.id = 'sstv-expanded-modal';
        sstvExpandedModal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        `;
        
        // Create header
        const header = document.createElement('div');
        header.style.cssText = `
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 1200px;
            margin-bottom: 16px;
            color: #fff;
        `;
        
        const title = document.createElement('span');
        title.style.cssText = 'font-size: 18px; font-weight: 500;';
        title.textContent = type === 'waterfall' ? 'üìä Waterfall Display' : 'üñºÔ∏è Received Image';
        
        const closeBtn = document.createElement('button');
        closeBtn.style.cssText = `
            background: var(--bg-secondary, #2a2a3e);
            border: 1px solid var(--border, #444);
            color: #fff;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        `;
        closeBtn.innerHTML = '‚úï Close (Esc)';
        closeBtn.onclick = closeSSTVExpandedView;
        
        header.appendChild(title);
        header.appendChild(closeBtn);
        
        // Create canvas container
        const canvasContainer = document.createElement('div');
        canvasContainer.style.cssText = `
            background: #000;
            border-radius: 8px;
            padding: 8px;
            max-width: 100%;
            max-height: calc(100vh - 150px);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        `;
        
        // Create expanded canvas
        sstvExpandedCanvas = document.createElement('canvas');
        
        if (type === 'waterfall') {
            // Larger waterfall canvas
            sstvExpandedCanvas.width = 800;
            sstvExpandedCanvas.height = 300;
            sstvExpandedCanvas.style.cssText = `
                width: 100%;
                max-width: 800px;
                height: auto;
                border-radius: 4px;
            `;
            
            // Add frequency scale
            const freqScale = document.createElement('div');
            freqScale.style.cssText = `
                display: flex;
                justify-content: space-between;
                width: 100%;
                max-width: 800px;
                padding: 8px 4px 0;
                font-size: 12px;
                color: #888;
            `;
            freqScale.innerHTML = `
                <span>1100 Hz</span>
                <span style="color:#f44">SYNC</span>
                <span style="color:#44f">BLACK</span>
                <span style="color:#ff0">VIS</span>
                <span style="color:#0f0">WHITE</span>
                <span>2400 Hz</span>
            `;
            
            canvasContainer.appendChild(sstvExpandedCanvas);
            canvasContainer.appendChild(freqScale);
            
            // Add info row
            const infoRow = document.createElement('div');
            infoRow.style.cssText = `
                display: flex;
                gap: 24px;
                margin-top: 12px;
                font-size: 14px;
                color: #fff;
            `;
            infoRow.innerHTML = `
                <span>Dominant Freq: <span id="sstv-expanded-freq" style="color:var(--accent,#4da6ff)">--</span></span>
                <span>Status: <span id="sstv-expanded-status" style="color:#888">--</span></span>
            `;
            canvasContainer.appendChild(infoRow);
            
            // Start expanded waterfall updates
            startExpandedWaterfallUpdates();
            
        } else {
            // Preview canvas - copy from original
            const originalCanvas = domCache.get('sstv-rx-canvas');
            if (originalCanvas && originalCanvas.width > 0) {
                sstvExpandedCanvas.width = originalCanvas.width;
                sstvExpandedCanvas.height = originalCanvas.height;
                sstvExpandedCanvas.style.cssText = `
                    max-width: 100%;
                    max-height: calc(100vh - 200px);
                    object-fit: contain;
                    border-radius: 4px;
                `;
                
                // Copy image data
                const ctx = sstvExpandedCanvas.getContext('2d');
                ctx.drawImage(originalCanvas, 0, 0);
                
                // Add image info
                const infoRow = document.createElement('div');
                infoRow.style.cssText = `
                    display: flex;
                    gap: 24px;
                    margin-top: 12px;
                    font-size: 14px;
                    color: #fff;
                `;
                
                const decoderState = typeof SSTVModule !== 'undefined' ? SSTVModule.getDecoderState() : {};
                const mode = decoderState.mode || '--';
                const dimensions = originalCanvas.width > 0 ? 
                    `${originalCanvas.width}√ó${originalCanvas.height}` : '--';
                
                infoRow.innerHTML = `
                    <span>Mode: <span style="color:var(--accent,#4da6ff)">${mode}</span></span>
                    <span>Size: <span style="color:#888">${dimensions}</span></span>
                `;
                canvasContainer.appendChild(sstvExpandedCanvas);
                canvasContainer.appendChild(infoRow);
                
                // Start preview update interval (to track live decode progress)
                startExpandedPreviewUpdates();
            } else {
                // No image to display
                const noImage = document.createElement('div');
                noImage.style.cssText = `
                    color: #666;
                    font-size: 16px;
                    padding: 60px;
                `;
                noImage.textContent = 'No image to display';
                canvasContainer.appendChild(noImage);
            }
        }
        
        sstvExpandedModal.appendChild(header);
        sstvExpandedModal.appendChild(canvasContainer);
        
        // Add keyboard handler
        sstvExpandedModal._keyHandler = (e) => {
            if (e.key === 'Escape') {
                closeSSTVExpandedView();
            }
        };
        document.addEventListener('keydown', sstvExpandedModal._keyHandler);
        
        // Click outside to close
        sstvExpandedModal.onclick = (e) => {
            if (e.target === sstvExpandedModal) {
                closeSSTVExpandedView();
            }
        };
        
        document.body.appendChild(sstvExpandedModal);
        
        // Prevent body scroll
        document.body.style.overflow = 'hidden';
    }

    /**
     * Close SSTV expanded view
     */
    function closeSSTVExpandedView() {
        if (sstvExpandedUpdateInterval) {
            clearInterval(sstvExpandedUpdateInterval);
            sstvExpandedUpdateInterval = null;
        }
        
        if (sstvExpandedModal) {
            if (sstvExpandedModal._keyHandler) {
                document.removeEventListener('keydown', sstvExpandedModal._keyHandler);
            }
            sstvExpandedModal.remove();
            sstvExpandedModal = null;
        }
        
        sstvExpandedCanvas = null;
        sstvExpandedType = null;
        document.body.style.overflow = '';
    }

    /**
     * Start waterfall updates in expanded view
     */
    function startExpandedWaterfallUpdates() {
        if (!sstvExpandedCanvas || sstvExpandedType !== 'waterfall') return;
        
        const ctx = sstvExpandedCanvas.getContext('2d');
        const width = sstvExpandedCanvas.width;
        const height = sstvExpandedCanvas.height;
        
        // Get colormap
        const colormapSelect = domCache.get('sstv-waterfall-colormap');
        const colormap = colormapSelect?.value || 'viridis';
        
        sstvExpandedUpdateInterval = setInterval(() => {
            if (!sstvExpandedCanvas || typeof SSTVDSPModule === 'undefined') {
                clearInterval(sstvExpandedUpdateInterval);
                return;
            }
            
            // Scroll down
            const imageData = ctx.getImageData(0, 0, width, height);
            ctx.putImageData(imageData, 0, 1);
            
            // Draw new line from DSP module
            const freqInfo = SSTVDSPModule.getDominantFrequency();
            const signalQuality = SSTVDSPModule.analyzeSignalQuality();
            
            // Update info display
            const freqEl = domCache.get('sstv-expanded-freq');
            const statusEl = domCache.get('sstv-expanded-status');
            
            if (freqEl && freqInfo) {
                freqEl.textContent = `${freqInfo.frequency.toFixed(0)} Hz (${(freqInfo.amplitude * 100).toFixed(0)}%)`;
            }
            if (statusEl && signalQuality) {
                statusEl.textContent = signalQuality.guidance;
                const colors = {
                    none: '#666', weak: '#f90', overload: '#f44',
                    noise: '#888', signal: '#4da6ff', sstv: '#4c4'
                };
                statusEl.style.color = colors[signalQuality.status] || '#888';
            }
            
            // Draw spectrum line (simplified - in real implementation would use FFT data)
            for (let x = 0; x < width; x++) {
                const freq = 1100 + (x / width) * 1300;
                let value = Math.random() * 0.3;
                
                // Boost at key frequencies if signal present
                if (signalQuality?.levels) {
                    if (Math.abs(freq - 1200) < 50) value += signalQuality.levels.sync * 0.7;
                    if (Math.abs(freq - 1500) < 30) value += signalQuality.levels.black * 0.5;
                    if (Math.abs(freq - 1900) < 40) value += signalQuality.levels.vis * 0.6;
                    if (Math.abs(freq - 2300) < 30) value += signalQuality.levels.white * 0.5;
                }
                
                value = Math.min(1, value);
                const color = getColormapColor(value, colormap);
                ctx.fillStyle = `rgb(${color[0]},${color[1]},${color[2]})`;
                ctx.fillRect(x, 0, 1, 1);
            }
        }, 50);
    }

    /**
     * Start preview updates in expanded view (for live decode)
     */
    function startExpandedPreviewUpdates() {
        if (!sstvExpandedCanvas || sstvExpandedType !== 'preview') return;
        
        sstvExpandedUpdateInterval = setInterval(() => {
            if (!sstvExpandedCanvas) {
                clearInterval(sstvExpandedUpdateInterval);
                return;
            }
            
            const originalCanvas = domCache.get('sstv-rx-canvas');
            if (originalCanvas && originalCanvas.width > 0) {
                // Check if dimensions changed
                if (sstvExpandedCanvas.width !== originalCanvas.width ||
                    sstvExpandedCanvas.height !== originalCanvas.height) {
                    sstvExpandedCanvas.width = originalCanvas.width;
                    sstvExpandedCanvas.height = originalCanvas.height;
                }
                
                // Copy latest image
                const ctx = sstvExpandedCanvas.getContext('2d');
                ctx.drawImage(originalCanvas, 0, 0);
            }
        }, 100);
    }

    /**
     * Get color from colormap
     */
    function getColormapColor(value, colormap) {
        const t = Math.max(0, Math.min(1, value));
        let r, g, b;
        
        if (colormap === 'viridis') {
            r = Math.round(255 * Math.max(0, Math.min(1, 0.267 + 0.003*t + 2.79*t*t - 3.55*t*t*t + 1.5*t*t*t*t)));
            g = Math.round(255 * Math.max(0, Math.min(1, 0.004 + 1.42*t - 1.12*t*t + 0.62*t*t*t)));
            b = Math.round(255 * Math.max(0, Math.min(1, 0.329 + 1.42*t - 2.32*t*t + 1.56*t*t*t)));
        } else if (colormap === 'plasma') {
            r = Math.round(255 * Math.max(0, Math.min(1, 0.05 + 2.86*t - 2.13*t*t)));
            g = Math.round(255 * Math.max(0, Math.min(1, 0.02 + 0.74*t + 0.27*t*t)));
            b = Math.round(255 * Math.max(0, Math.min(1, 0.53 + 0.87*t - 1.64*t*t + 0.74*t*t*t)));
        } else if (colormap === 'thermal') {
            if (t < 0.33) { r = 0; g = 0; b = Math.round(255*(t/0.33)); }
            else if (t < 0.66) { const u = (t-0.33)/0.33; r = Math.round(255*u); g = 0; b = Math.round(255*(1-u)); }
            else { const u = (t-0.66)/0.34; r = 255; g = Math.round(255*u); b = Math.round(255*u*0.5); }
        } else {
            r = g = b = Math.round(t * 255);
        }
        
        return [r, g, b];
    }

    // ==========================================
    // SSTV ANNOTATION FUNCTIONS
    // ==========================================

    /**
     * Initialize annotation canvas to match base canvas
     */
    function initAnnotationCanvas() {
        const baseCanvas = domCache.get('sstv-tx-canvas');
        const annotationCanvas = domCache.get('sstv-annotation-canvas');
        const toolbar = domCache.get('sstv-annotation-toolbar');
        
        if (!baseCanvas || !annotationCanvas) return;
        
        // Match dimensions
        annotationCanvas.width = baseCanvas.width;
        annotationCanvas.height = baseCanvas.height;
        annotationCanvas.style.display = baseCanvas.style.display;
        
        // Clear annotation canvas
        const ctx = annotationCanvas.getContext('2d');
        ctx.clearRect(0, 0, annotationCanvas.width, annotationCanvas.height);
        
        // Show toolbar if image is loaded
        if (toolbar && baseCanvas.style.display !== 'none') {
            toolbar.style.display = 'block';
        }
        
        // Reset history
        sstvAnnotationHistory = [];
        
        // Attach drawing handlers
        attachAnnotationHandlers(annotationCanvas);
    }

    /**
     * Attach mouse/touch handlers for drawing
     */
    function attachAnnotationHandlers(canvas) {
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        
        // Get coordinates relative to canvas
        function getCoords(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            let clientX, clientY;
            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            return {
                x: (clientX - rect.left) * scaleX,
                y: (clientY - rect.top) * scaleY
            };
        }
        
        // Save current state for undo
        function saveState() {
            sstvAnnotationHistory.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
            // Limit history size
            if (sstvAnnotationHistory.length > 20) {
                sstvAnnotationHistory.shift();
            }
        }
        
        // Start drawing
        function startDraw(e) {
            e.preventDefault();
            const coords = getCoords(e);
            sstvIsDrawing = true;
            sstvDrawStart = coords;
            sstvLastPoint = coords;
            
            // Save state before drawing (for undo)
            saveState();
            
            // For text tool, place text immediately
            if (sstvAnnotationTool === 'text') {
                const textInput = domCache.get('sstv-annotation-text');
                const text = textInput?.value || 'Text';
                if (text) {
                    ctx.font = `bold ${sstvAnnotationWidth * 4}px sans-serif`;
                    ctx.fillStyle = sstvAnnotationColor;
                    ctx.fillText(text, coords.x, coords.y);
                }
                sstvIsDrawing = false;
            }
            
            // For pen/eraser, start path
            if (sstvAnnotationTool === 'pen' || sstvAnnotationTool === 'eraser') {
                ctx.beginPath();
                ctx.moveTo(coords.x, coords.y);
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.lineWidth = sstvAnnotationTool === 'eraser' ? sstvAnnotationWidth * 3 : sstvAnnotationWidth;
                ctx.strokeStyle = sstvAnnotationTool === 'eraser' ? 'rgba(0,0,0,1)' : sstvAnnotationColor;
                
                if (sstvAnnotationTool === 'eraser') {
                    ctx.globalCompositeOperation = 'destination-out';
                } else {
                    ctx.globalCompositeOperation = 'source-over';
                }
            }
        }
        
        // Continue drawing
        function draw(e) {
            if (!sstvIsDrawing) return;
            e.preventDefault();
            
            const coords = getCoords(e);
            
            if (sstvAnnotationTool === 'pen' || sstvAnnotationTool === 'eraser') {
                ctx.lineTo(coords.x, coords.y);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(coords.x, coords.y);
            }
            
            // For shapes, show preview (redraw from saved state)
            if (['arrow', 'circle', 'rect'].includes(sstvAnnotationTool)) {
                // Restore to pre-draw state
                if (sstvAnnotationHistory.length > 0) {
                    ctx.putImageData(sstvAnnotationHistory[sstvAnnotationHistory.length - 1], 0, 0);
                }
                
                ctx.strokeStyle = sstvAnnotationColor;
                ctx.fillStyle = sstvAnnotationColor;
                ctx.lineWidth = sstvAnnotationWidth;
                ctx.lineCap = 'round';
                ctx.globalCompositeOperation = 'source-over';
                
                drawShape(ctx, sstvAnnotationTool, sstvDrawStart, coords);
            }
            
            sstvLastPoint = coords;
        }
        
        // End drawing
        function endDraw(e) {
            if (!sstvIsDrawing) return;
            
            const coords = e ? getCoords(e) : sstvLastPoint;
            
            // Finalize shapes
            if (['arrow', 'circle', 'rect'].includes(sstvAnnotationTool)) {
                // Already drawn in preview, state is saved
            }
            
            sstvIsDrawing = false;
            ctx.globalCompositeOperation = 'source-over';
        }
        
        // Remove existing handlers
        canvas.onmousedown = null;
        canvas.onmousemove = null;
        canvas.onmouseup = null;
        canvas.onmouseleave = null;
        canvas.ontouchstart = null;
        canvas.ontouchmove = null;
        canvas.ontouchend = null;
        
        // Add handlers
        canvas.onmousedown = startDraw;
        canvas.onmousemove = draw;
        canvas.onmouseup = endDraw;
        canvas.onmouseleave = endDraw;
        
        canvas.ontouchstart = startDraw;
        canvas.ontouchmove = draw;
        canvas.ontouchend = endDraw;
    }

    /**
     * Draw a shape on the canvas
     */
    function drawShape(ctx, tool, start, end) {
        ctx.beginPath();
        
        if (tool === 'arrow') {
            // Line
            ctx.moveTo(start.x, start.y);
            ctx.lineTo(end.x, end.y);
            ctx.stroke();
            
            // Arrowhead
            const angle = Math.atan2(end.y - start.y, end.x - start.x);
            const headLen = sstvAnnotationWidth * 4;
            
            ctx.beginPath();
            ctx.moveTo(end.x, end.y);
            ctx.lineTo(
                end.x - headLen * Math.cos(angle - Math.PI / 6),
                end.y - headLen * Math.sin(angle - Math.PI / 6)
            );
            ctx.moveTo(end.x, end.y);
            ctx.lineTo(
                end.x - headLen * Math.cos(angle + Math.PI / 6),
                end.y - headLen * Math.sin(angle + Math.PI / 6)
            );
            ctx.stroke();
            
        } else if (tool === 'circle') {
            const radiusX = Math.abs(end.x - start.x) / 2;
            const radiusY = Math.abs(end.y - start.y) / 2;
            const centerX = (start.x + end.x) / 2;
            const centerY = (start.y + end.y) / 2;
            
            ctx.ellipse(centerX, centerY, radiusX, radiusY, 0, 0, Math.PI * 2);
            ctx.stroke();
            
        } else if (tool === 'rect') {
            const width = end.x - start.x;
            const height = end.y - start.y;
            ctx.strokeRect(start.x, start.y, width, height);
        }
    }

    /**
     * Undo last annotation
     */
    function undoAnnotation() {
        const canvas = domCache.get('sstv-annotation-canvas');
        if (!canvas || sstvAnnotationHistory.length === 0) return;
        
        const ctx = canvas.getContext('2d');
        
        // Pop current state and restore previous
        sstvAnnotationHistory.pop();
        
        if (sstvAnnotationHistory.length > 0) {
            ctx.putImageData(sstvAnnotationHistory[sstvAnnotationHistory.length - 1], 0, 0);
        } else {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
    }

    /**
     * Clear all annotations
     */
    function clearAnnotations() {
        const canvas = domCache.get('sstv-annotation-canvas');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        sstvAnnotationHistory = [];
    }

    /**
     * Flatten annotation layer onto base canvas
     * Called before transmit to merge annotations
     */
    function flattenAnnotations() {
        const baseCanvas = domCache.get('sstv-tx-canvas');
        const annotationCanvas = domCache.get('sstv-annotation-canvas');
        
        if (!baseCanvas || !annotationCanvas) return false;
        
        const baseCtx = baseCanvas.getContext('2d');
        
        // Draw annotation layer on top of base
        baseCtx.drawImage(annotationCanvas, 0, 0);
        
        // Clear annotation layer after flattening
        const annotationCtx = annotationCanvas.getContext('2d');
        annotationCtx.clearRect(0, 0, annotationCanvas.width, annotationCanvas.height);
        sstvAnnotationHistory = [];
        
        console.log('[SSTV] Annotations flattened to base canvas');
        return true;
    }

    /**
     * Check if there are annotations to flatten
     */
    function hasAnnotations() {
        const canvas = domCache.get('sstv-annotation-canvas');
        if (!canvas) return false;
        
        const ctx = canvas.getContext('2d');
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        
        // Check if any pixel has alpha > 0
        for (let i = 3; i < imageData.data.length; i += 4) {
            if (imageData.data[i] > 0) return true;
        }
        return false;
    }

    /**
     * Open received image in annotation editor
     */
    function openImageForAnnotation(imageData) {
        if (!imageData) return;
        
        // Switch to transmit tab
        sstvActiveTab = 'transmit';
        getSstvContent().innerHTML = renderSSTVTabContent();
        attachSSTVHandlers();
        
        // Load image to TX canvas
        const canvas = domCache.get('sstv-tx-canvas');
        const placeholder = domCache.get('sstv-tx-placeholder');
        
        if (canvas) {
            canvas.width = imageData.width;
            canvas.height = imageData.height;
            const ctx = canvas.getContext('2d');
            ctx.putImageData(imageData, 0, 0);
            canvas.style.display = 'block';
            if (placeholder) placeholder.style.display = 'none';
            
            // Initialize annotation layer
            setTimeout(() => initAnnotationCanvas(), 50);
        }
    }

    function attachSSTVHandlers() {
        // Receive handlers
        const startRxBtn = container.querySelector('#sstv-start-rx');
        if (startRxBtn) {
            startRxBtn.onclick = async () => {
                const success = await SSTVModule.startReceive();
                if (success) {
                    // Initialize waterfall if DSP module available
                    if (typeof SSTVDSPModule !== 'undefined') {
                        initSSTVWaterfall();
                    }
                    renderSSTV();
                }
            };
        }

        const stopRxBtn = container.querySelector('#sstv-stop-rx');
        if (stopRxBtn) {
            stopRxBtn.onclick = () => {
                SSTVModule.stopReceive();
                // Stop waterfall
                if (typeof SSTVDSPModule !== 'undefined') {
                    SSTVDSPModule.stopWaterfall();
                }
                renderSSTV();
            };
        }

        // Waterfall colormap selector
        const waterfallColormapSelect = container.querySelector('#sstv-waterfall-colormap');
        if (waterfallColormapSelect && typeof SSTVDSPModule !== 'undefined') {
            waterfallColormapSelect.onchange = () => {
                SSTVDSPModule.setColormap(waterfallColormapSelect.value);
            };
        }

        // Slant correction toggle
        const slantEnabledCheckbox = container.querySelector('#sstv-slant-enabled');
        if (slantEnabledCheckbox && typeof SSTVDSPModule !== 'undefined') {
            slantEnabledCheckbox.onchange = () => {
                SSTVDSPModule.setSlantCorrectionEnabled(slantEnabledCheckbox.checked);
            };
        }

        // Slant reset button
        const slantResetBtn = container.querySelector('#sstv-slant-reset');
        if (slantResetBtn && typeof SSTVDSPModule !== 'undefined') {
            slantResetBtn.onclick = () => {
                SSTVDSPModule.resetSlantAnalysis();
                updateSlantDisplay();
                if (typeof ModalsModule !== 'undefined') {
                    ModalsModule.showToast('Slant analysis reset', 'info');
                }
            };
        }

        // Manual slant slider
        const slantManualSlider = container.querySelector('#sstv-slant-manual');
        const slantManualValue = container.querySelector('#sstv-slant-manual-value');
        if (slantManualSlider && slantManualValue) {
            slantManualSlider.oninput = () => {
                slantManualValue.textContent = `${parseFloat(slantManualSlider.value).toFixed(1)}%`;
            };
        }

        // Drift correction toggle
        const driftEnabledCheckbox = container.querySelector('#sstv-drift-enabled');
        if (driftEnabledCheckbox && typeof SSTVDSPModule !== 'undefined') {
            driftEnabledCheckbox.onchange = () => {
                SSTVDSPModule.setDriftCorrectionEnabled(driftEnabledCheckbox.checked);
            };
        }

        // Drift reset button
        const driftResetBtn = container.querySelector('#sstv-drift-reset');
        if (driftResetBtn && typeof SSTVDSPModule !== 'undefined') {
            driftResetBtn.onclick = () => {
                SSTVDSPModule.resetDriftAnalysis();
                updateDriftDisplay();
                if (typeof ModalsModule !== 'undefined') {
                    ModalsModule.showToast('Drift analysis reset', 'info');
                }
            };
        }

        // Manual drift slider
        const driftManualSlider = container.querySelector('#sstv-drift-manual');
        const driftManualValue = container.querySelector('#sstv-drift-manual-value');
        if (driftManualSlider && driftManualValue && typeof SSTVDSPModule !== 'undefined') {
            driftManualSlider.oninput = () => {
                const hz = parseInt(driftManualSlider.value);
                driftManualValue.textContent = `${hz} Hz`;
                SSTVDSPModule.setManualDriftCompensation(hz);
            };
        }

        // Expand waterfall button
        const waterfallExpandBtn = container.querySelector('#sstv-waterfall-expand');
        if (waterfallExpandBtn) {
            waterfallExpandBtn.onclick = () => {
                openSSTVExpandedView('waterfall');
            };
        }

        // Expand preview button
        const previewExpandBtn = container.querySelector('#sstv-preview-expand');
        if (previewExpandBtn) {
            previewExpandBtn.onclick = () => {
                openSSTVExpandedView('preview');
            };
        }

        // Start waterfall update loop if receiving
        if (typeof SSTVModule !== 'undefined' && SSTVModule.isReceiving()) {
            startWaterfallUpdateLoop();
        }

        // Transmit handlers
        const txModeSelect = container.querySelector('#sstv-tx-mode');
        if (txModeSelect) {
            txModeSelect.onchange = () => {
                sstvTransmitMode = txModeSelect.value;
                getSstvContent().innerHTML = renderSSTVTabContent();
                attachSSTVHandlers();
            };
        }

        container.querySelectorAll('[data-sstv-source]').forEach(btn => {
            btn.onclick = async () => {
                sstvTransmitSource = btn.dataset.sstvSource;
                
                // Update active state
                container.querySelectorAll('[data-sstv-source]').forEach(b => 
                    b.classList.toggle('chip--active', b.dataset.sstvSource === sstvTransmitSource));
                
                // Load image based on source
                if (sstvTransmitSource === 'map') {
                    await loadMapForTransmit();
                } else if (sstvTransmitSource === 'gallery') {
                    document.getElementById('sstv-file-input').click();
                } else if (sstvTransmitSource === 'camera') {
                    await loadCameraForTransmit();
                }
            };
        });

        const fileInput = container.querySelector('#sstv-file-input');
        if (fileInput) {
            fileInput.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    loadImageFile(file);
                }
            };
        }

        // Clear preview button
        const clearPreviewBtn = container.querySelector('#sstv-clear-preview-btn');
        if (clearPreviewBtn) {
            clearPreviewBtn.onclick = () => {
                clearTXPreview();
                getSstvContent().innerHTML = renderSSTVTabContent();
                attachSSTVHandlers();
            };
        }

        const transmitBtn = container.querySelector('#sstv-transmit-btn');
        if (transmitBtn) {
            transmitBtn.onclick = async () => {
                const canvas = domCache.get('sstv-tx-canvas');
                if (canvas && canvas.style.display !== 'none') {
                    // Auto-flatten annotations before transmit
                    if (hasAnnotations()) {
                        flattenAnnotations();
                        if (typeof ModalsModule !== 'undefined') {
                            ModalsModule.showToast('Annotations merged', 'info');
                        }
                    }
                    await SSTVModule.transmit(canvas, sstvTransmitMode);
                    
                    // Clear stored image after successful transmit
                    sstvCapturedImageData = null;
                    sstvPreviewDisplayed = false;
                    sstvAnnotationHistory = [];
                    
                    renderSSTV();
                } else {
                    if (typeof ModalsModule !== 'undefined') {
                        ModalsModule.showToast('Select an image first', 'error');
                    }
                }
            };
        }

        // Annotation toolbar handlers
        const toolButtons = container.querySelectorAll('.sstv-tool-btn');
        toolButtons.forEach(btn => {
            btn.onclick = () => {
                const tool = btn.dataset.tool;
                sstvAnnotationTool = tool;
                
                // Update active state
                toolButtons.forEach(b => b.classList.remove('sstv-tool-active'));
                btn.classList.add('sstv-tool-active');
                
                // Show/hide text input
                const textContainer = document.getElementById('sstv-text-input-container');
                if (textContainer) {
                    textContainer.style.display = tool === 'text' ? 'block' : 'none';
                }
                
                // Update cursor
                const annotationCanvas = domCache.get('sstv-annotation-canvas');
                if (annotationCanvas) {
                    annotationCanvas.style.cursor = tool === 'eraser' ? 'cell' : 'crosshair';
                }
            };
        });

        // Color picker
        const colorPicker = container.querySelector('#sstv-annotation-color');
        if (colorPicker) {
            colorPicker.oninput = () => {
                sstvAnnotationColor = colorPicker.value;
            };
        }

        // Line width
        const widthSelect = container.querySelector('#sstv-annotation-width');
        if (widthSelect) {
            widthSelect.onchange = () => {
                sstvAnnotationWidth = parseInt(widthSelect.value);
            };
        }

        // Undo button
        const undoBtn = container.querySelector('#sstv-annotation-undo');
        if (undoBtn) {
            undoBtn.onclick = undoAnnotation;
        }

        // Clear button
        const clearBtn = container.querySelector('#sstv-annotation-clear');
        if (clearBtn) {
            clearBtn.onclick = () => {
                if (typeof ModalsModule !== 'undefined') {
                    ModalsModule.confirm({
                        title: 'Clear Annotations',
                        message: 'Remove all annotations from the image?',
                        confirmText: 'Clear',
                        onConfirm: () => {
                            clearAnnotations();
                        }
                    });
                } else {
                    clearAnnotations();
                }
            };
        }

        // History handlers
        container.querySelectorAll('[data-sstv-image]').forEach(card => {
            card.onclick = () => {
                const id = card.dataset.sstvImage;
                showSSTVImageDetail(id);
            };
        });

        const clearHistoryBtn = container.querySelector('#sstv-clear-history');
        if (clearHistoryBtn) {
            clearHistoryBtn.onclick = async () => {
                if (typeof ModalsModule !== 'undefined') {
                    ModalsModule.confirm({
                        title: 'Clear History',
                        message: 'Delete all received images?',
                        confirmText: 'Delete All',
                        onConfirm: async () => {
                            await SSTVModule.clearHistory();
                            getSstvContent().innerHTML = renderSSTVHistory();
                            attachSSTVHandlers();
                        }
                    });
                }
            };
        }

        // Settings handlers
        const saveSettingsBtn = container.querySelector('#sstv-save-settings');
        if (saveSettingsBtn) {
            saveSettingsBtn.onclick = async () => {
                const newSettings = {
                    callsign: document.getElementById('sstv-callsign')?.value?.toUpperCase() || '',
                    gridSquare: domCache.get('sstv-grid')?.value?.toUpperCase() || '',
                    defaultMode: document.getElementById('sstv-default-mode')?.value || 'Robot36',
                    autoCallsignOverlay: document.getElementById('sstv-auto-callsign')?.checked || false,
                    gainLevel: (parseInt(document.getElementById('sstv-gain')?.value) || 100) / 100,
                    voxEnabled: document.getElementById('sstv-vox')?.checked || false,
                    licenseAcknowledged: document.getElementById('sstv-license-ack')?.checked || false
                };
                
                await SSTVModule.updateSettings(newSettings);
                
                if (typeof ModalsModule !== 'undefined') {
                    ModalsModule.showToast('Settings saved', 'success');
                }
            };
        }

        const gridGpsBtn = container.querySelector('#sstv-grid-gps');
        if (gridGpsBtn) {
            gridGpsBtn.onclick = async () => {
                const grid = await SSTVModule.updateGridSquareFromGPS();
                if (grid) {
                    const input = domCache.get('sstv-grid');
                    if (input) input.value = grid;
                    if (typeof ModalsModule !== 'undefined') {
                        ModalsModule.showToast(`Grid: ${grid}`, 'success');
                    }
                } else {
                    if (typeof ModalsModule !== 'undefined') {
                        ModalsModule.showToast('GPS position not available', 'error');
                    }
                }
            };
        }

        // Enhance tab handlers
        const enhanceMethodSelect = container.querySelector('#enhance-method');
        if (enhanceMethodSelect) {
            enhanceMethodSelect.onchange = () => {
                sstvEnhanceMethod = enhanceMethodSelect.value;
            };
        }

        const enhanceDenoiseSlider = container.querySelector('#enhance-denoise');
        if (enhanceDenoiseSlider) {
            enhanceDenoiseSlider.oninput = () => {
                sstvEnhanceDenoiseStrength = parseInt(enhanceDenoiseSlider.value) / 100;
                const label = enhanceDenoiseSlider.parentElement.querySelector('.form-label');
                if (label) label.textContent = `Denoise Strength: ${enhanceDenoiseSlider.value}%`;
            };
        }

        const enhanceOcrCheckbox = container.querySelector('#enhance-ocr');
        if (enhanceOcrCheckbox) {
            enhanceOcrCheckbox.onchange = () => {
                sstvEnhanceOCR = enhanceOcrCheckbox.checked;
            };
        }

        // Image selection for enhance
        container.querySelectorAll('[data-enhance-select]').forEach(thumb => {
            thumb.onclick = () => {
                sstvEnhanceSelectedImage = thumb.dataset.enhanceSelect;
                getSstvContent().innerHTML = renderSSTVEnhance();
                attachSSTVHandlers();
            };
        });

        const enhanceStartBtn = container.querySelector('#enhance-start-btn');
        if (enhanceStartBtn) {
            enhanceStartBtn.onclick = () => runEnhancement();
        }

        const enhanceSaveBtn = container.querySelector('#enhance-save-btn');
        if (enhanceSaveBtn) {
            enhanceSaveBtn.onclick = () => saveEnhancedImage();
        }

        const enhanceCompareBtn = container.querySelector('#enhance-compare-btn');
        if (enhanceCompareBtn) {
            enhanceCompareBtn.onclick = () => {
                // Toggle between original and enhanced
                const canvas = domCache.get('enhance-result-canvas');
                if (canvas && window._enhancedImageData && sstvEnhanceSelectedImage) {
                    const images = SSTVModule.getReceivedImages();
                    const original = images.find(i => i.id === sstvEnhanceSelectedImage);
                    
                    if (canvas.dataset.showing === 'enhanced' && original?.imageData) {
                        canvas.width = original.imageData.width;
                        canvas.height = original.imageData.height;
                        canvas.getContext('2d').putImageData(original.imageData, 0, 0);
                        canvas.dataset.showing = 'original';
                        enhanceCompareBtn.textContent = 'Show Enhanced';
                    } else {
                        canvas.width = window._enhancedImageData.width;
                        canvas.height = window._enhancedImageData.height;
                        canvas.getContext('2d').putImageData(window._enhancedImageData, 0, 0);
                        canvas.dataset.showing = 'enhanced';
                        enhanceCompareBtn.textContent = 'Compare';
                    }
                }
            };
        }

        // Import model button
        const enhanceImportBtn = container.querySelector('#enhance-import-btn');
        if (enhanceImportBtn) {
            enhanceImportBtn.onclick = () => importEnhanceModel();
        }

        const enhanceClearCacheBtn = container.querySelector('#enhance-clear-cache');
        if (enhanceClearCacheBtn) {
            enhanceClearCacheBtn.onclick = () => clearEnhanceModels();
        }

        // Load cache info if on enhance tab
        if (sstvActiveTab === 'enhance') {
            loadEnhanceCacheInfo();
        }
        
        // Restore TX preview if we have a captured image and are on transmit tab
        restoreTXPreview();
    }

    async function loadMapForTransmit() {
        try {
            const imageData = await SSTVModule.captureMapView();
            displayTransmitPreview(imageData);
        } catch (err) {
            console.error('[SSTV] Failed to capture map:', err);
            if (typeof ModalsModule !== 'undefined') {
                ModalsModule.showToast('Failed to capture map view', 'error');
            }
        }
    }

    async function loadCameraForTransmit() {
        try {
            // Show loading indicator
            if (typeof ModalsModule !== 'undefined') {
                ModalsModule.showToast('üì∑ Initializing camera...', 'info');
            }
            
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'environment',
                    width: { ideal: 640 },
                    height: { ideal: 480 }
                } 
            });
            
            const video = document.createElement('video');
            video.srcObject = stream;
            video.setAttribute('playsinline', 'true'); // Required for iOS
            video.muted = true;
            
            // Wait for video metadata to load
            await new Promise((resolve, reject) => {
                const timeout = setTimeout(() => {
                    reject(new Error('Video metadata timeout'));
                }, 10000);
                
                video.onloadedmetadata = () => {
                    clearTimeout(timeout);
                    resolve();
                };
                
                video.onerror = (e) => {
                    clearTimeout(timeout);
                    reject(new Error('Video error: ' + (e.message || 'Unknown')));
                };
            });
            
            await video.play();
            
            // Ensure we have valid dimensions
            if (video.videoWidth === 0 || video.videoHeight === 0) {
                throw new Error('Invalid video dimensions');
            }
            
            // Camera warm-up delay: Allow auto-exposure and auto-white-balance to adjust
            // Many cameras need 1-2 seconds to properly adjust to lighting conditions
            console.log('[SSTV] Camera warming up (auto-exposure adjustment)...');
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            // Capture frame
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            // Stop stream
            stream.getTracks().forEach(t => t.stop());
            
            const imageData = canvas.getContext('2d').getImageData(0, 0, canvas.width, canvas.height);
            displayTransmitPreview(imageData);
            
            console.log(`[SSTV] Camera capture complete: ${canvas.width}x${canvas.height} (after 1.5s warm-up)`);
            
        } catch (err) {
            console.error('[SSTV] Failed to access camera:', err);
            if (typeof ModalsModule !== 'undefined') {
                ModalsModule.showToast('Camera access failed: ' + err.message, 'error');
            }
        }
    }

    function loadImageFile(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                canvas.getContext('2d').drawImage(img, 0, 0);
                const imageData = canvas.getContext('2d').getImageData(0, 0, canvas.width, canvas.height);
                displayTransmitPreview(imageData);
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function displayTransmitPreview(imageData, retryCount = 0) {
        const MAX_RETRIES = 5;
        const RETRY_DELAY = 200;
        
        // Store the image data so it persists across re-renders
        if (imageData && imageData.width > 0 && imageData.height > 0) {
            sstvCapturedImageData = imageData;
        }
        
        const canvas = domCache.get('sstv-tx-canvas');
        const placeholder = domCache.get('sstv-tx-placeholder');
        
        // If canvas doesn't exist yet, retry after a delay
        if (!canvas || !placeholder) {
            if (retryCount < MAX_RETRIES) {
                console.log(`[SSTV] TX canvas not ready, retry ${retryCount + 1}/${MAX_RETRIES} in ${RETRY_DELAY}ms`);
                setTimeout(() => {
                    displayTransmitPreview(sstvCapturedImageData, retryCount + 1);
                }, RETRY_DELAY);
            } else {
                console.warn('[SSTV] TX canvas not found after max retries - image saved for manual restore');
            }
            return;
        }
        
        // Use stored image data if current is invalid
        const dataToUse = (imageData && imageData.width > 0) ? imageData : sstvCapturedImageData;
        
        if (!dataToUse || !dataToUse.width || !dataToUse.height || dataToUse.width === 0 || dataToUse.height === 0) {
            console.error('[SSTV] Invalid image data:', dataToUse?.width, 'x', dataToUse?.height);
            if (typeof ModalsModule !== 'undefined') {
                ModalsModule.showToast('Invalid image data', 'error');
            }
            return;
        }
        
        // Get target dimensions from selected mode
        const mode = typeof SSTVModule !== 'undefined' ? SSTVModule.MODES[sstvTransmitMode] : null;
        if (!mode) {
            console.error('[SSTV] Invalid mode:', sstvTransmitMode);
            return;
        }
        
        try {
            canvas.width = mode.width;
            canvas.height = mode.height;
            
            // Draw scaled image
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = dataToUse.width;
            tempCanvas.height = dataToUse.height;
            tempCanvas.getContext('2d').putImageData(dataToUse, 0, 0);
            
            canvas.getContext('2d').drawImage(tempCanvas, 0, 0, mode.width, mode.height);
            
            canvas.style.display = 'block';
            placeholder.style.display = 'none';
            
            // Mark preview as displayed
            sstvPreviewDisplayed = true;
            
            // Initialize annotation canvas
            setTimeout(() => initAnnotationCanvas(), 50);
            
            console.log(`[SSTV] Preview loaded: ${dataToUse.width}x${dataToUse.height} ‚Üí ${mode.width}x${mode.height}`);
            
        } catch (err) {
            console.error('[SSTV] Failed to display preview:', err);
            if (typeof ModalsModule !== 'undefined') {
                ModalsModule.showToast('Failed to load image preview', 'error');
            }
        }
    }
    
    /**
     * Restore captured TX image after re-render
     */
    function restoreTXPreview() {
        // Only restore if we have captured data, on transmit tab, and not already restoring/displayed
        if (!sstvCapturedImageData || sstvActiveTab !== 'transmit') {
            return;
        }
        
        // Prevent multiple concurrent restore operations
        if (sstvRestorePending) {
            return;
        }
        
        // If preview is already displayed and canvas is visible, don't restore again
        const existingCanvas = domCache.get('sstv-tx-canvas');
        if (sstvPreviewDisplayed && existingCanvas && existingCanvas.style.display === 'block') {
            return;
        }
        
        sstvRestorePending = true;
        
        // Small delay to ensure DOM is ready
        setTimeout(() => {
            const canvas = domCache.get('sstv-tx-canvas');
            const placeholder = domCache.get('sstv-tx-placeholder');
            
            if (canvas && placeholder && sstvCapturedImageData) {
                displayTransmitPreview(sstvCapturedImageData);
                console.log('[SSTV] TX preview restored after re-render');
            }
            
            sstvRestorePending = false;
        }, 100);
    }
    
    /**
     * Clear stored TX image (call when user wants to start fresh)
     */
    function clearTXPreview() {
        sstvCapturedImageData = null;
        sstvPreviewDisplayed = false;
        sstvRestorePending = false;
        
        const canvas = domCache.get('sstv-tx-canvas');
        const placeholder = domCache.get('sstv-tx-placeholder');
        const annotationCanvas = domCache.get('sstv-annotation-canvas');
        const toolbar = domCache.get('sstv-annotation-toolbar');
        
        if (canvas) {
            canvas.style.display = 'none';
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        if (placeholder) placeholder.style.display = '';
        if (annotationCanvas) annotationCanvas.style.display = 'none';
        if (toolbar) toolbar.style.display = 'none';
        
        sstvAnnotationHistory = [];
        console.log('[SSTV] TX preview cleared');
    }

    function showSSTVImageDetail(id) {
        const images = SSTVModule.getReceivedImages();
        const img = images.find(i => i.id === id);
        if (!img) return;

        if (typeof ModalsModule !== 'undefined') {
            const dataURL = SSTVModule.imageDataToDataURL(img.imageData);
            
            ModalsModule.show({
                title: `SSTV Image - ${img.mode}`,
                content: `
                    <div style="text-align:center">
                        <img src="${dataURL}" style="max-width:100%;border-radius:8px;margin-bottom:16px">
                        <div style="color:var(--text-secondary);font-size:13px">
                            ${new Date(img.timestamp).toLocaleString()}<br>
                            ${img.width}√ó${img.height} ‚Ä¢ ${img.duration?.toFixed(1) || '--'}s
                        </div>
                    </div>
                `,
                buttons: [
                    {
                        label: '‚úèÔ∏è Annotate & TX',
                        class: 'btn--primary',
                        onClick: () => {
                            // Clone image data to avoid modifying original
                            const clonedData = new ImageData(
                                new Uint8ClampedArray(img.imageData.data),
                                img.imageData.width,
                                img.imageData.height
                            );
                            openImageForAnnotation(clonedData);
                        }
                    },
                    {
                        label: 'Export PNG',
                        class: 'btn--secondary',
                        onClick: () => {
                            SSTVModule.exportImage(id);
                        }
                    },
                    {
                        label: 'Delete',
                        class: 'btn--danger',
                        onClick: async () => {
                            await SSTVModule.deleteImage(id);
                            getSstvContent().innerHTML = renderSSTVHistory();
                            attachSSTVHandlers();
                        }
                    },
                    {
                        label: 'Close',
                        class: 'btn--secondary'
                    }
                ]
            });
        }
    }

    // SSTV Event Handlers
    function handleSSTVStatus(status) {
        const signalBar = document.getElementById('sstv-signal-bar');
        const signalLevel = document.getElementById('sstv-signal-level');
        
        if (signalBar) {
            signalBar.style.width = `${Math.round(status.signalStrength * 100)}%`;
        }
        if (signalLevel) {
            signalLevel.textContent = status.signalStrength > 0 ? 
                `${Math.round(status.signalStrength * 100)}%` : '--';
        }
    }

    function handleSSTVModeDetected(data) {
        const rxMode = document.getElementById('sstv-rx-mode');
        const rxPhase = document.getElementById('sstv-rx-phase');
        
        if (rxMode) rxMode.textContent = data.mode;
        if (rxPhase) rxPhase.textContent = 'RECEIVING';
        
        // Setup canvas for receiving
        const canvas = domCache.get('sstv-rx-canvas');
        if (canvas) {
            canvas.width = data.config.width;
            canvas.height = data.config.height;
            canvas.style.display = 'block';
            canvas.parentElement.querySelector('span').style.display = 'none';
        }
    }

    function handleSSTVProgress(data) {
        const rxProgress = document.getElementById('sstv-rx-progress');
        if (rxProgress) {
            rxProgress.textContent = `${data.line}/${data.total}`;
        }
        
        // Update preview canvas
        const canvas = domCache.get('sstv-rx-canvas');
        if (canvas && data.imageData) {
            canvas.getContext('2d').putImageData(data.imageData, 0, 0);
        }
    }

    function handleSSTVImageComplete(data) {
        if (typeof ModalsModule !== 'undefined') {
            ModalsModule.showToast(`SSTV image received: ${data.mode}`, 'success');
        }
        
        // Refresh if on history tab
        if (sstvActiveTab === 'history') {
            getSstvContent().innerHTML = renderSSTVHistory();
            attachSSTVHandlers();
        }
    }

    function handleSSTVTransmitStarted(data) {
        if (typeof ModalsModule !== 'undefined') {
            ModalsModule.showToast(`Transmitting ${data.mode} (${Math.round(data.duration)}s)...`, 'info');
        }
    }

    function handleSSTVTransmitComplete(data) {
        if (typeof ModalsModule !== 'undefined') {
            ModalsModule.showToast(`Transmission complete: ${data.mode}`, 'success');
        }
        renderSSTV();
    }

    function renderMedical() {
        _saveScroll(); _restoreScroll();
        if (typeof MedicalModule === 'undefined') {
            container.innerHTML = `
                <div class="panel__header">
                    <h2 class="panel__title">üè• Medical Reference</h2>
                </div>
                <div class="empty-state">
                    <div class="empty-state__icon">${Icons.get('medical')}</div>
                    <div class="empty-state__title">Medical Module Not Loaded</div>
                    <div class="empty-state__desc">Medical reference features are not available</div>
                </div>
            `;
            return;
        }

        // Load bookmarks if needed
        if (medicalState.bookmarks.length === 0) {
            loadMedicalBookmarks();
        }

        const categories = MedicalModule.getCategories();
        const medCategories = MedicalModule.getMedCategories();

        container.innerHTML = `
            <div class="panel__header">
                <h2 class="panel__title">üè• Medical Reference</h2>
                ${medicalState.activeView !== 'categories' ? `
                    <button class="btn btn--secondary" id="medical-back" style="padding:8px">
                        ${Icons.get('back')}
                    </button>
                ` : ''}
            </div>

            <!-- Disclaimer -->
            <div style="padding:10px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:8px;margin-bottom:16px">
                <div style="font-size:11px;color:#ef4444;font-weight:600;margin-bottom:4px">‚ö†Ô∏è DISCLAIMER</div>
                <div style="font-size:10px;color:rgba(255,255,255,0.7);line-height:1.4">
                    For educational reference only. Not a substitute for professional medical training or emergency care. 
                    Always seek professional help when available.
                </div>
            </div>

            <!-- Search Bar -->
            <div style="position:relative;margin-bottom:16px">
                <input type="text" id="medical-search" 
                    placeholder="Search protocols, medications, symptoms..." 
                    value="${medicalState.searchQuery}"
                    style="padding-left:36px">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);opacity:0.5">
                    ${Icons.get('search')}
                </span>
            </div>

            <!-- Quick Access Bookmarks -->
            ${medicalState.bookmarks.length > 0 && medicalState.activeView === 'categories' ? `
                <div style="margin-bottom:16px">
                    <div class="section-label" style="display:flex;justify-content:space-between;align-items:center">
                        <span>${Icons.get('bookmark')} Bookmarked</span>
                        <button class="btn btn--secondary" id="view-all-bookmarks" style="padding:4px 8px;font-size:10px">
                            View All (${medicalState.bookmarks.length})
                        </button>
                    </div>
                    <div style="display:flex;gap:8px;overflow-x:auto;padding:4px 0">
                        ${medicalState.bookmarks.slice(0, 3).map(b => {
                            const item = MedicalModule.getProtocol(b) || MedicalModule.getMedication(b);
                            if (!item) return '';
                            const isProtocol = !!MedicalModule.getProtocol(b);
                            return `
                                <button class="chip chip--active" 
                                    data-bookmark="${b}" 
                                    data-type="${isProtocol ? 'protocol' : 'medication'}"
                                    style="white-space:nowrap">
                                    ${isProtocol ? 'üìã' : 'üíä'} ${item.title || item.name}
                                </button>
                            `;
                        }).join('')}
                    </div>
                </div>
            ` : ''}

            <!-- Content Area -->
            <div id="medical-content">
                ${renderMedicalContent()}
            </div>
        `;

        attachMedicalHandlers();
    }

    function renderMedicalContent() {
        // Check for search results first
        if (medicalState.searchQuery && medicalState.searchQuery.length >= 2) {
            return renderMedicalSearchResults();
        }

        switch (medicalState.activeView) {
            case 'protocol':
                return renderMedicalProtocol();
            case 'medication':
                return renderMedicalMedication();
            case 'category':
                return renderMedicalCategory();
            case 'medications':
                return renderMedicationsList();
            case 'bookmarks':
                return renderMedicalBookmarks();
            case 'quickref':
                return renderQuickReferences();
            default:
                return renderMedicalCategories();
        }
    }

    function renderMedicalCategories() {
        const categories = MedicalModule.getCategories();
        const medCategories = MedicalModule.getMedCategories();
        
        return `
            <!-- Protocol Categories -->
            <div class="section-label">üìã Protocols & Procedures</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:20px">
                ${Object.entries(categories).map(([key, cat]) => `
                    <button class="card" data-category="${key}" style="text-align:center;padding:16px">
                        <div style="font-size:24px;margin-bottom:8px">${cat.icon}</div>
                        <div style="font-size:13px;font-weight:500">${cat.name}</div>
                        <div style="font-size:10px;color:rgba(255,255,255,0.5);margin-top:4px">
                            ${MedicalModule.getProtocolsByCategory(key).length} protocols
                        </div>
                    </button>
                `).join('')}
            </div>

            <!-- Medications Section -->
            <div class="section-label">üíä Medications Reference</div>
            <button class="card" data-view="medications" style="width:100%;margin-bottom:12px">
                <div class="card__header">
                    <div class="card__icon" style="background:rgba(245,158,11,0.15)">üíä</div>
                    <div>
                        <div class="card__title">Drug Reference & Interactions</div>
                        <div class="card__subtitle">${Object.keys(MedicalModule.getAllMedications()).length} medications with dosing & warnings</div>
                    </div>
                </div>
            </button>

            <!-- Quick References -->
            <div class="section-label">üìä Quick References</div>
            <button class="card" data-view="quickref" style="width:100%;margin-bottom:12px">
                <div class="card__header">
                    <div class="card__icon" style="background:rgba(59,130,246,0.15)">üìä</div>
                    <div>
                        <div class="card__title">Vital Signs, CPR, Burns, etc.</div>
                        <div class="card__subtitle">Essential reference tables</div>
                    </div>
                </div>
            </button>
        `;
    }

    function renderMedicalCategory() {
        const cat = medicalState.activeCategory;
        if (!cat) return renderMedicalCategories();

        const categoryInfo = MedicalModule.getCategories()[cat];
        const protocols = MedicalModule.getProtocolsByCategory(cat);

        return `
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
                <div style="font-size:32px">${categoryInfo.icon}</div>
                <div>
                    <div style="font-size:16px;font-weight:600">${categoryInfo.name}</div>
                    <div style="font-size:12px;color:rgba(255,255,255,0.5)">${protocols.length} protocols</div>
                </div>
            </div>

            <div style="display:flex;flex-direction:column;gap:8px">
                ${protocols.map(p => `
                    <button class="card" data-protocol="${p.id}" style="text-align:left">
                        <div class="card__header">
                            <div class="card__icon" style="background:${getSeverityColor(p.severity)}22;color:${getSeverityColor(p.severity)}">
                                ${getSeverityIcon(p.severity)}
                            </div>
                            <div style="flex:1">
                                <div class="card__title">${p.title}</div>
                                <div class="card__subtitle" style="display:flex;gap:8px;align-items:center">
                                    <span style="padding:2px 6px;background:${getSeverityColor(p.severity)}33;color:${getSeverityColor(p.severity)};border-radius:4px;font-size:9px;font-weight:600">
                                        ${p.severity.toUpperCase()}
                                    </span>
                                </div>
                            </div>
                            ${medicalState.bookmarks.includes(p.id) ? `<span style="color:#f59e0b">${Icons.get('bookmarkFilled')}</span>` : ''}
                        </div>
                    </button>
                `).join('')}
            </div>
        `;
    }

    function renderMedicalProtocol() {
        const p = medicalState.selectedProtocol;
        if (!p) return renderMedicalCategories();

        const protocol = MedicalModule.getProtocol(p);
        if (!protocol) return '<div class="empty-state">Protocol not found</div>';

        const isBookmarked = medicalState.bookmarks.includes(p);

        return `
            <div style="margin-bottom:16px">
                <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">
                    <div style="font-size:18px;font-weight:600">${protocol.title}</div>
                    <button class="btn btn--secondary" id="toggle-bookmark" data-id="${p}" style="padding:8px">
                        ${isBookmarked ? Icons.get('bookmarkFilled') : Icons.get('bookmark')}
                    </button>
                </div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">
                    <span style="padding:4px 10px;background:${getSeverityColor(protocol.severity)}33;color:${getSeverityColor(protocol.severity)};border-radius:20px;font-size:11px;font-weight:600">
                        ${protocol.severity.toUpperCase()}
                    </span>
                    ${protocol.tags.slice(0, 3).map(t => `
                        <span style="padding:4px 10px;background:rgba(255,255,255,0.1);border-radius:20px;font-size:11px;color:rgba(255,255,255,0.6)">
                            ${t}
                        </span>
                    `).join('')}
                </div>
                <div style="font-size:13px;color:rgba(255,255,255,0.8);line-height:1.5;padding:12px;background:rgba(255,255,255,0.05);border-radius:8px">
                    ${protocol.overview}
                </div>
            </div>

            <!-- Steps -->
            <div class="section-label">üìã Protocol Steps</div>
            <div style="display:flex;flex-direction:column;gap:12px;margin-bottom:16px">
                ${protocol.steps.map((step, i) => `
                    <div style="padding:14px;background:rgba(255,255,255,0.03);border-radius:10px;border-left:3px solid ${getSeverityColor(protocol.severity)}">
                        <div style="font-size:13px;font-weight:600;margin-bottom:8px;color:#fff">
                            ${step.title}
                        </div>
                        <div style="font-size:12px;color:rgba(255,255,255,0.75);line-height:1.5;white-space:pre-wrap">
                            ${step.content}
                        </div>
                        ${step.warning ? `
                            <div style="margin-top:10px;padding:10px;background:rgba(239,68,68,0.15);border-radius:6px;border-left:3px solid #ef4444">
                                <div style="font-size:11px;font-weight:600;color:#ef4444;margin-bottom:4px">‚ö†Ô∏è WARNING</div>
                                <div style="font-size:11px;color:rgba(255,255,255,0.8)">${step.warning}</div>
                            </div>
                        ` : ''}
                    </div>
                `).join('')}
            </div>

            ${protocol.equipment && protocol.equipment.length > 0 ? `
                <div class="section-label">üéí Equipment Needed</div>
                <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px">
                    ${protocol.equipment.map(e => `
                        <span style="padding:6px 12px;background:rgba(59,130,246,0.15);border-radius:20px;font-size:11px;color:#3b82f6">
                            ${e}
                        </span>
                    `).join('')}
                </div>
            ` : ''}

            ${protocol.medications && protocol.medications.length > 0 ? `
                <div class="section-label">üíä Medications</div>
                <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px">
                    ${protocol.medications.map(m => `
                        <div style="padding:12px;background:rgba(245,158,11,0.1);border-radius:8px">
                            <div style="font-size:13px;font-weight:600;color:#f59e0b">${m.name}</div>
                            <div style="font-size:11px;color:rgba(255,255,255,0.6)">Dose: ${m.dose}</div>
                            <div style="font-size:11px;color:rgba(255,255,255,0.5)">${m.purpose}</div>
                        </div>
                    `).join('')}
                </div>
            ` : ''}

            ${protocol.notes ? `
                <div class="section-label">üìù Notes</div>
                <div style="padding:12px;background:rgba(255,255,255,0.05);border-radius:8px;font-size:12px;color:rgba(255,255,255,0.7);line-height:1.5">
                    ${protocol.notes}
                </div>
            ` : ''}
        `;
    }

    function renderMedicationsList() {
        const medCategories = MedicalModule.getMedCategories();
        const allMeds = MedicalModule.getAllMedications();

        return `
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
                <div style="font-size:32px">üíä</div>
                <div>
                    <div style="font-size:16px;font-weight:600">Medications Reference</div>
                    <div style="font-size:12px;color:rgba(255,255,255,0.5)">Dosing, interactions, and warnings</div>
                </div>
            </div>

            ${Object.entries(medCategories).map(([catKey, catInfo]) => {
                const meds = MedicalModule.getMedicationsByCategory(catKey);
                if (meds.length === 0) return '';
                
                return `
                    <div class="section-label">${catInfo.icon} ${catInfo.name}</div>
                    <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px">
                        ${meds.map(m => `
                            <button class="card" data-medication="${Object.keys(MedicalModule.MEDICATIONS).find(k => MedicalModule.MEDICATIONS[k] === m)}" style="text-align:left">
                                <div class="card__header">
                                    <div class="card__icon" style="background:rgba(245,158,11,0.15)">${catInfo.icon}</div>
                                    <div style="flex:1">
                                        <div class="card__title">${m.name}</div>
                                        <div class="card__subtitle">${m.uses.slice(0, 2).join(', ')}</div>
                                    </div>
                                </div>
                            </button>
                        `).join('')}
                    </div>
                `;
            }).join('')}
        `;
    }

    function renderMedicalMedication() {
        const key = medicalState.selectedMedication;
        if (!key) return renderMedicationsList();

        const med = MedicalModule.getMedication(key);
        if (!med) return '<div class="empty-state">Medication not found</div>';

        const isBookmarked = medicalState.bookmarks.includes(key);

        return `
            <div style="margin-bottom:16px">
                <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">
                    <div style="font-size:18px;font-weight:600">${med.name}</div>
                    <button class="btn btn--secondary" id="toggle-bookmark" data-id="${key}" style="padding:8px">
                        ${isBookmarked ? Icons.get('bookmarkFilled') : Icons.get('bookmark')}
                    </button>
                </div>
                <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px">
                    ${med.uses.map(u => `
                        <span style="padding:4px 10px;background:rgba(59,130,246,0.2);color:#3b82f6;border-radius:20px;font-size:11px">
                            ${u}
                        </span>
                    `).join('')}
                </div>
            </div>

            <!-- Dosing -->
            <div class="section-label">üíä Dosing</div>
            <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px">
                <div style="padding:12px;background:rgba(34,197,94,0.1);border-radius:8px">
                    <div style="font-size:11px;color:#22c55e;font-weight:600;margin-bottom:4px">ADULT DOSE</div>
                    <div style="font-size:13px;color:#fff">${med.adultDose}</div>
                </div>
                ${med.pediatricDose ? `
                    <div style="padding:12px;background:rgba(59,130,246,0.1);border-radius:8px">
                        <div style="font-size:11px;color:#3b82f6;font-weight:600;margin-bottom:4px">PEDIATRIC DOSE</div>
                        <div style="font-size:13px;color:#fff">${med.pediatricDose}</div>
                    </div>
                ` : ''}
            </div>

            <!-- Contraindications -->
            ${med.contraindications && med.contraindications.length > 0 ? `
                <div class="section-label">üö´ Contraindications</div>
                <div style="padding:12px;background:rgba(239,68,68,0.1);border-radius:8px;margin-bottom:16px">
                    <ul style="margin:0;padding-left:20px;color:rgba(255,255,255,0.8);font-size:12px;line-height:1.6">
                        ${med.contraindications.map(c => `<li>${c}</li>`).join('')}
                    </ul>
                </div>
            ` : ''}

            <!-- Drug Interactions -->
            ${med.interactions && med.interactions.length > 0 ? `
                <div class="section-label">‚ö†Ô∏è Drug Interactions</div>
                <div style="padding:12px;background:rgba(245,158,11,0.1);border-radius:8px;margin-bottom:16px">
                    <ul style="margin:0;padding-left:20px;color:rgba(255,255,255,0.8);font-size:12px;line-height:1.6">
                        ${med.interactions.map(i => `<li>${i}</li>`).join('')}
                    </ul>
                </div>
            ` : ''}

            <!-- Warnings -->
            ${med.warnings ? `
                <div class="section-label">‚ö†Ô∏è Warnings</div>
                <div style="padding:12px;background:rgba(239,68,68,0.15);border:1px solid rgba(239,68,68,0.3);border-radius:8px;margin-bottom:16px">
                    <div style="font-size:12px;color:rgba(255,255,255,0.9);line-height:1.5">${med.warnings}</div>
                </div>
            ` : ''}

            <!-- Notes -->
            ${med.notes ? `
                <div class="section-label">üìù Clinical Notes</div>
                <div style="padding:12px;background:rgba(255,255,255,0.05);border-radius:8px;font-size:12px;color:rgba(255,255,255,0.7);line-height:1.5">
                    ${med.notes}
                </div>
            ` : ''}
        `;
    }

    function renderMedicalSearchResults() {
        const results = MedicalModule.search(medicalState.searchQuery);
        const totalResults = results.protocols.length + results.medications.length;

        if (totalResults === 0) {
            return `
                <div class="empty-state">
                    <div class="empty-state__icon">${Icons.get('search')}</div>
                    <div class="empty-state__title">No Results</div>
                    <div class="empty-state__desc">Try different search terms</div>
                </div>
            `;
        }

        return `
            <div style="font-size:12px;color:rgba(255,255,255,0.5);margin-bottom:12px">
                Found ${totalResults} result${totalResults !== 1 ? 's' : ''} for "${medicalState.searchQuery}"
            </div>

            ${results.protocols.length > 0 ? `
                <div class="section-label">üìã Protocols (${results.protocols.length})</div>
                <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px">
                    ${results.protocols.map(p => `
                        <button class="card" data-protocol="${p.id}" style="text-align:left">
                            <div class="card__header">
                                <div class="card__icon" style="background:${getSeverityColor(p.severity)}22;color:${getSeverityColor(p.severity)}">
                                    ${getSeverityIcon(p.severity)}
                                </div>
                                <div style="flex:1">
                                    <div class="card__title">${p.title}</div>
                                    <div class="card__subtitle">${p.overview.substring(0, 60)}...</div>
                                </div>
                            </div>
                        </button>
                    `).join('')}
                </div>
            ` : ''}

            ${results.medications.length > 0 ? `
                <div class="section-label">üíä Medications (${results.medications.length})</div>
                <div style="display:flex;flex-direction:column;gap:8px">
                    ${results.medications.map(m => {
                        const key = Object.keys(MedicalModule.MEDICATIONS).find(k => MedicalModule.MEDICATIONS[k] === m);
                        return `
                            <button class="card" data-medication="${key}" style="text-align:left">
                                <div class="card__header">
                                    <div class="card__icon" style="background:rgba(245,158,11,0.15)">üíä</div>
                                    <div style="flex:1">
                                        <div class="card__title">${m.name}</div>
                                        <div class="card__subtitle">${m.uses.slice(0, 2).join(', ')}</div>
                                    </div>
                                </div>
                            </button>
                        `;
                    }).join('')}
                </div>
            ` : ''}
        `;
    }

    function renderQuickReferences() {
        const refs = MedicalModule.getQuickReferences();

        return `
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
                <div style="font-size:32px">üìä</div>
                <div>
                    <div style="font-size:16px;font-weight:600">Quick Reference Tables</div>
                    <div style="font-size:12px;color:rgba(255,255,255,0.5)">Essential medical reference data</div>
                </div>
            </div>

            <div style="display:flex;flex-direction:column;gap:16px">
                ${Object.entries(refs).map(([key, ref]) => `
                    <div style="padding:14px;background:rgba(255,255,255,0.03);border-radius:10px">
                        <div style="font-size:14px;font-weight:600;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid rgba(255,255,255,0.1)">
                            ${ref.title}
                        </div>
                        <div style="display:flex;flex-direction:column;gap:4px">
                            ${ref.content.map(item => `
                                <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.05)">
                                    <span style="font-size:12px;color:rgba(255,255,255,0.6)">${item.label}</span>
                                    <span style="font-size:12px;font-weight:600;color:#fff">${item.value}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }

    function renderMedicalBookmarks() {
        if (medicalState.bookmarks.length === 0) {
            return `
                <div class="empty-state">
                    <div class="empty-state__icon">${Icons.get('bookmark')}</div>
                    <div class="empty-state__title">No Bookmarks</div>
                    <div class="empty-state__desc">Bookmark protocols and medications for quick access</div>
                </div>
            `;
        }

        return `
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
                <div style="font-size:32px">üîñ</div>
                <div>
                    <div style="font-size:16px;font-weight:600">Bookmarked Items</div>
                    <div style="font-size:12px;color:rgba(255,255,255,0.5)">${medicalState.bookmarks.length} saved</div>
                </div>
            </div>

            <div style="display:flex;flex-direction:column;gap:8px">
                ${medicalState.bookmarks.map(id => {
                    const protocol = MedicalModule.getProtocol(id);
                    const medication = MedicalModule.getMedication(id);
                    
                    if (protocol) {
                        return `
                            <button class="card" data-protocol="${id}" style="text-align:left">
                                <div class="card__header">
                                    <div class="card__icon" style="background:${getSeverityColor(protocol.severity)}22;color:${getSeverityColor(protocol.severity)}">
                                        üìã
                                    </div>
                                    <div style="flex:1">
                                        <div class="card__title">${protocol.title}</div>
                                        <div class="card__subtitle">${protocol.severity.toUpperCase()} ‚Ä¢ Protocol</div>
                                    </div>
                                    <span style="color:#f59e0b">${Icons.get('bookmarkFilled')}</span>
                                </div>
                            </button>
                        `;
                    } else if (medication) {
                        return `
                            <button class="card" data-medication="${id}" style="text-align:left">
                                <div class="card__header">
                                    <div class="card__icon" style="background:rgba(245,158,11,0.15)">üíä</div>
                                    <div style="flex:1">
                                        <div class="card__title">${medication.name}</div>
                                        <div class="card__subtitle">Medication</div>
                                    </div>
                                    <span style="color:#f59e0b">${Icons.get('bookmarkFilled')}</span>
                                </div>
                            </button>
                        `;
                    }
                    return '';
                }).join('')}
            </div>
        `;
    }

    function getSeverityColor(severity) {
        const colors = {
            critical: '#ef4444',
            urgent: '#f59e0b',
            moderate: '#3b82f6',
            minor: '#22c55e',
            info: '#6b7280'
        };
        return colors[severity] || colors.info;
    }

    function getSeverityIcon(severity) {
        const icons = {
            critical: 'üî¥',
            urgent: 'üü†',
            moderate: 'üîµ',
            minor: 'üü¢',
            info: '‚ÑπÔ∏è'
        };
        return icons[severity] || icons.info;
    }

    function attachMedicalHandlers() {
        // Back button
        const backBtn = container.querySelector('#medical-back');
        if (backBtn) {
            backBtn.onclick = () => {
                if (medicalState.searchQuery) {
                    medicalState.searchQuery = '';
                    const searchInput = container.querySelector('#medical-search');
                    if (searchInput) searchInput.value = '';
                } else if (medicalState.activeView === 'protocol' || medicalState.activeView === 'medication') {
                    if (medicalState.activeCategory) {
                        medicalState.activeView = 'category';
                    } else {
                        medicalState.activeView = 'categories';
                    }
                } else if (medicalState.activeView === 'category') {
                    medicalState.activeView = 'categories';
                    medicalState.activeCategory = null;
                } else {
                    medicalState.activeView = 'categories';
                }
                medicalState.selectedProtocol = null;
                medicalState.selectedMedication = null;
                renderMedical();
            };
        }

        // Search input
        const searchInput = container.querySelector('#medical-search');
        if (searchInput) {
            searchInput.oninput = Helpers.debounce((e) => {
                medicalState.searchQuery = e.target.value;
                document.getElementById('medical-content').innerHTML = renderMedicalContent();
                attachMedicalContentHandlers();
            }, 300);
        }

        // View all bookmarks
        const viewBookmarks = container.querySelector('#view-all-bookmarks');
        if (viewBookmarks) {
            viewBookmarks.onclick = () => {
                medicalState.activeView = 'bookmarks';
                renderMedical();
            };
        }

        // Bookmark chips
        container.querySelectorAll('[data-bookmark]').forEach(btn => {
            btn.onclick = () => {
                const id = btn.dataset.bookmark;
                const type = btn.dataset.type;
                if (type === 'protocol') {
                    medicalState.selectedProtocol = id;
                    medicalState.activeView = 'protocol';
                } else {
                    medicalState.selectedMedication = id;
                    medicalState.activeView = 'medication';
                }
                renderMedical();
            };
        });

        attachMedicalContentHandlers();
    }

    function attachMedicalContentHandlers() {
        // Category buttons
        container.querySelectorAll('[data-category]').forEach(btn => {
            btn.onclick = () => {
                medicalState.activeCategory = btn.dataset.category;
                medicalState.activeView = 'category';
                renderMedical();
            };
        });

        // View buttons (medications, quickref)
        container.querySelectorAll('[data-view]').forEach(btn => {
            btn.onclick = () => {
                medicalState.activeView = btn.dataset.view;
                renderMedical();
            };
        });

        // Protocol buttons
        container.querySelectorAll('[data-protocol]').forEach(btn => {
            btn.onclick = () => {
                medicalState.selectedProtocol = btn.dataset.protocol;
                medicalState.activeView = 'protocol';
                renderMedical();
            };
        });

        // Medication buttons
        container.querySelectorAll('[data-medication]').forEach(btn => {
            btn.onclick = () => {
                medicalState.selectedMedication = btn.dataset.medication;
                medicalState.activeView = 'medication';
                renderMedical();
            };
        });

        // Toggle bookmark
        const bookmarkBtn = container.querySelector('#toggle-bookmark');
        if (bookmarkBtn) {
            bookmarkBtn.onclick = () => {
                const id = bookmarkBtn.dataset.id;
                const idx = medicalState.bookmarks.indexOf(id);
                if (idx > -1) {
                    medicalState.bookmarks.splice(idx, 1);
                } else {
                    medicalState.bookmarks.push(id);
                }
                saveMedicalBookmarks();
                renderMedical();
                ModalsModule.showToast(idx > -1 ? 'Bookmark removed' : 'Bookmarked!', 'success');
            };
        }
    }

    // =====================================================
    // FIELD GUIDES PANEL
    // =====================================================
    
    let fieldGuidesState = {
        activeCategory: null,
        activeSubcategory: null,
        selectedItem: null,
        searchQuery: '',
        view: 'categories' // 'categories', 'subcategories', 'items', 'detail', 'search', 'bookmarks'
    };

    function renderFieldGuides() {
        _saveScroll(); _restoreScroll();
        if (typeof FieldGuidesModule === 'undefined') {
            container.innerHTML = `
                <div class="panel__header">
                    <h2 class="panel__title">üìö Field Guides</h2>
                </div>
                <div class="empty-state">
                    <div class="empty-state__icon">${Icons.get('book')}</div>
                    <div class="empty-state__title">Field Guides Not Loaded</div>
                    <div class="empty-state__desc">Survival reference features are not available</div>
                </div>
            `;
            return;
        }

        const showBack = fieldGuidesState.view !== 'categories' || fieldGuidesState.searchQuery;

        container.innerHTML = `
            <div class="panel__header">
                ${showBack ? `<button class="btn btn--icon" id="fg-back" title="Back">${Icons.get('arrowLeft')}</button>` : ''}
                <h2 class="panel__title">üìö Field Guides</h2>
                <button class="btn btn--icon" id="fg-bookmarks" title="Bookmarks" style="${fieldGuidesState.view === 'bookmarks' ? 'color:#f59e0b' : ''}">
                    ${Icons.get('bookmarkFilled')}
                </button>
            </div>

            <!-- Search -->
            <div class="form-group" style="margin-bottom:12px">
                <div style="position:relative">
                    <input type="text" id="fg-search" placeholder="Search guides..." 
                        value="${fieldGuidesState.searchQuery}" style="padding-left:36px">
                    <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);opacity:0.4">
                        ${Icons.get('zoomIn')}
                    </span>
                </div>
            </div>

            <div id="fg-content">
                ${renderFieldGuidesContent()}
            </div>
        `;

        attachFieldGuidesHandlers();
    }

    function renderFieldGuidesContent() {
        if (fieldGuidesState.searchQuery && fieldGuidesState.searchQuery.length >= 2) {
            return renderFieldGuidesSearch();
        }

        switch (fieldGuidesState.view) {
            case 'bookmarks': return renderFieldGuidesBookmarks();
            case 'subcategories': return renderFieldGuidesSubcategories();
            case 'items': return renderFieldGuidesItems();
            case 'detail': return renderFieldGuidesDetail();
            default: return renderFieldGuidesCategories();
        }
    }

    function renderFieldGuidesCategories() {
        const categories = FieldGuidesModule.getCategories();
        
        return `
            <div style="margin-bottom:12px;padding:12px;background:rgba(34,197,94,0.1);border-radius:10px;font-size:12px">
                <strong>üìö Offline Survival Reference</strong><br>
                Fire, water, shelter, navigation, knots, edible plants & more.
            </div>

            <div style="display:flex;flex-direction:column;gap:8px">
                ${categories.map(cat => `
                    <button class="card" data-fg-category="${cat.id}" style="text-align:left;border-left:4px solid ${cat.color}">
                        <div class="card__header" style="align-items:center">
                            <div>
                                <span style="font-size:24px;margin-right:8px">${cat.icon}</span>
                                <span class="card__title">${cat.name}</span>
                            </div>
                            <span style="font-size:11px;opacity:0.6">${cat.subcategoryCount} topics</span>
                        </div>
                    </button>
                `).join('')}
            </div>

            <div style="margin-top:16px;padding:10px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.2);border-radius:8px;font-size:11px;color:#fca5a5">
                <strong>‚ö†Ô∏è Disclaimer:</strong> This information is for educational reference only. 
                Proper plant identification requires hands-on training. When in doubt, don't eat it.
            </div>
        `;
    }

    function renderFieldGuidesSubcategories() {
        const cat = FieldGuidesModule.getCategory(fieldGuidesState.activeCategory);
        if (!cat) return renderFieldGuidesCategories();

        const subcats = FieldGuidesModule.getSubcategories(fieldGuidesState.activeCategory);

        return `
            <div style="margin-bottom:12px;display:flex;align-items:center;gap:8px">
                <span style="font-size:28px">${cat.icon}</span>
                <div>
                    <div style="font-weight:600;font-size:16px">${cat.name}</div>
                    <div style="font-size:11px;opacity:0.6">${subcats.length} topics</div>
                </div>
            </div>

            <div style="display:flex;flex-direction:column;gap:8px">
                ${subcats.map(sub => `
                    <button class="card" data-fg-subcategory="${sub.id}" style="text-align:left">
                        <div class="card__header" style="align-items:center">
                            <div>
                                <span style="font-size:18px;margin-right:8px">${sub.icon}</span>
                                <span class="card__title">${sub.name}</span>
                            </div>
                            <span style="font-size:11px;opacity:0.6">${sub.itemCount} guides</span>
                        </div>
                    </button>
                `).join('')}
            </div>
        `;
    }

    function renderFieldGuidesItems() {
        const cat = FieldGuidesModule.getCategory(fieldGuidesState.activeCategory);
        const subcats = FieldGuidesModule.getSubcategories(fieldGuidesState.activeCategory);
        const subcat = subcats.find(s => s.id === fieldGuidesState.activeSubcategory);
        const items = FieldGuidesModule.getItems(fieldGuidesState.activeCategory, fieldGuidesState.activeSubcategory);

        if (!items.length) {
            return `<div class="empty-state"><div class="empty-state__title">No guides available</div></div>`;
        }

        return `
            <div style="margin-bottom:12px;display:flex;align-items:center;gap:8px">
                <span style="font-size:24px">${subcat?.icon || cat?.icon || 'üìñ'}</span>
                <div>
                    <div style="font-weight:600">${subcat?.name || 'Guides'}</div>
                    <div style="font-size:11px;opacity:0.6">${items.length} entries</div>
                </div>
            </div>

            <div style="display:flex;flex-direction:column;gap:6px">
                ${items.map(item => {
                    const isBookmarked = FieldGuidesModule.isBookmarked(item.id);
                    return `
                        <button class="card" data-fg-item="${item.id}" style="text-align:left">
                            <div class="card__header">
                                <span class="card__title">${item.title}</span>
                                ${isBookmarked ? `<span style="color:#f59e0b">${Icons.get('bookmarkFilled')}</span>` : ''}
                            </div>
                            <div class="card__subtitle" style="font-size:11px;opacity:0.7">${item.summary || ''}</div>
                            ${item.confidence ? `<div style="margin-top:4px;font-size:10px"><span class="chip chip--small">${item.confidence}</span></div>` : ''}
                        </button>
                    `;
                }).join('')}
            </div>
        `;
    }

    function renderFieldGuidesDetail() {
        const item = FieldGuidesModule.getItem(fieldGuidesState.selectedItem);
        if (!item) return renderFieldGuidesCategories();

        const isBookmarked = FieldGuidesModule.isBookmarked(item.id);

        // Parse content - handle markdown-like formatting
        const formatContent = (content) => {
            if (!content) return '';
            if (Array.isArray(content)) {
                return content.map(line => {
                    if (line.startsWith('## ')) {
                        return `<h4 style="margin:16px 0 8px;color:#60a5fa;font-size:13px">${line.substring(3)}</h4>`;
                    } else if (line.startsWith('**') && line.endsWith('**')) {
                        return `<p style="font-weight:600;margin:8px 0 4px">${line.slice(2, -2)}</p>`;
                    } else if (line.startsWith('‚Ä¢ ')) {
                        return `<div style="padding-left:12px;margin:2px 0">‚Ä¢ ${formatInline(line.substring(2))}</div>`;
                    } else if (line.match(/^\d+\.\s/)) {
                        return `<div style="padding-left:12px;margin:2px 0">${formatInline(line)}</div>`;
                    } else if (line === '') {
                        return '<div style="height:8px"></div>';
                    } else {
                        return `<p style="margin:4px 0">${formatInline(line)}</p>`;
                    }
                }).join('');
            }
            return content;
        };

        const formatInline = (text) => {
            return text
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/‚ö†Ô∏è/g, '<span style="color:#f59e0b">‚ö†Ô∏è</span>')
                .replace(/‚úì/g, '<span style="color:#22c55e">‚úì</span>')
                .replace(/‚úó/g, '<span style="color:#ef4444">‚úó</span>');
        };

        return `
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px">
                <h3 style="font-size:18px;margin:0">${item.title}</h3>
                <button class="btn btn--icon" id="fg-toggle-bookmark" data-id="${item.id}" 
                        style="color:${isBookmarked ? '#f59e0b' : 'inherit'}">
                    ${Icons.get(isBookmarked ? 'bookmarkFilled' : 'bookmark')}
                </button>
            </div>

            ${item.summary ? `<p style="font-size:13px;opacity:0.8;margin-bottom:16px;padding:10px;background:rgba(255,255,255,0.05);border-radius:8px">${item.summary}</p>` : ''}

            ${item.habitat ? `
                <div style="display:flex;gap:12px;margin-bottom:12px;font-size:11px">
                    <div><strong>Habitat:</strong> ${item.habitat}</div>
                    ${item.season ? `<div><strong>Season:</strong> ${item.season}</div>` : ''}
                </div>
            ` : ''}

            <div class="fg-content" style="font-size:12px;line-height:1.6">
                ${formatContent(item.content)}
            </div>

            ${item.tips && item.tips.length > 0 ? `
                <div style="margin-top:16px;padding:12px;background:rgba(59,130,246,0.1);border-radius:8px">
                    <div style="font-weight:600;margin-bottom:8px;color:#60a5fa">üí° Tips</div>
                    ${item.tips.map(tip => `<div style="font-size:11px;margin:4px 0;padding-left:8px;border-left:2px solid rgba(59,130,246,0.3)">‚Ä¢ ${tip}</div>`).join('')}
                </div>
            ` : ''}

            ${item.diagram ? `
                <div style="margin-top:16px;padding:12px;background:rgba(255,255,255,0.05);border-radius:8px;text-align:center">
                    <div style="font-size:11px;opacity:0.6;margin-bottom:8px">üìê Diagram: ${item.diagram}</div>
                    ${renderKnotDiagram(item.diagram)}
                </div>
            ` : ''}
        `;
    }

    function renderKnotDiagram(diagramId) {
        // ASCII/SVG diagrams for common knots
        const diagrams = {
            'bowline': `<pre style="font-family:monospace;font-size:10px;line-height:1.2;text-align:left;color:#60a5fa">
     ‚Üë Standing
     ‚îÇ    ‚ï≠‚îÄ‚îÄ‚îÄ‚ïÆ
     ‚îÇ   ‚ï±     ‚ï≤
     ‚îú‚îÄ‚îÄ‚óè       ‚îÇ
     ‚îÇ   ‚ï≤     ‚ï±
     ‚îÇ    ‚ï∞‚îÄ‚îÄ‚îÄ‚ïØ
     ‚îÇ      ‚îÇ
     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    Working end
</pre>`,
            'clove-hitch': `<pre style="font-family:monospace;font-size:10px;line-height:1.2;text-align:left;color:#60a5fa">
    ‚ïë Post ‚ïë
    ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
   ‚ï±‚îÇ      ‚îÇ‚ï≤
  ‚ï± ‚îÇ      ‚îÇ ‚ï≤
 ‚ï±  ‚îÇ      ‚îÇ  ‚ï≤
‚ï±   ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£   ‚ï≤
    ‚ïë      ‚ïë
</pre>`,
            'taut-line': `<pre style="font-family:monospace;font-size:10px;line-height:1.2;text-align:left;color:#60a5fa">
  Anchor ‚óè
         ‚îÇ‚ï≤
         ‚îÇ ‚ï≤
         ‚îÇ‚ï± ‚ï≤  ‚Üê 2 wraps inside
         ‚îÇ‚ï≤  ‚ï≤
         ‚îÇ ‚ï≤  ‚ï≤
         ‚îÇ  ‚ï≤ ‚ï± ‚Üê 1 wrap outside
         ‚îÇ   X
         ‚îÇ  ‚ï±
         ‚Üì Stake
</pre>`,
            'sheet-bend': `<pre style="font-family:monospace;font-size:10px;line-height:1.2;text-align:left;color:#60a5fa">
Larger rope (bight)
    ‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïÆ
   ‚ï±       ‚ï≤
  ‚îÇ    ‚Üë    ‚îÇ ‚Üê Smaller rope
  ‚îÇ   ‚ï±‚îÇ‚ï≤   ‚îÇ    goes UP through
   ‚ï≤ ‚ï± ‚îÇ ‚ï≤ ‚ï±     then AROUND
    ‚ï≥  ‚îÇ  ‚ï≥      then UNDER itself
   ‚ï±   ‚îÇ   ‚ï≤
  ‚Üê‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚Üí
</pre>`,
            'truckers-hitch': `<pre style="font-family:monospace;font-size:10px;line-height:1.2;text-align:left;color:#60a5fa">
Anchor 1
    ‚îÇ
    ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïÆ Slip loop
    ‚îÇ      ‚îÇ (midline)
    ‚îÇ      ‚Üì
    ‚îÇ    ‚ï≠‚îÄ‚óè‚îÄ‚ïÆ
    ‚îÇ    ‚îÇ   ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ    ‚Üì Pull for
         ‚îÇ      mechanical
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚óè‚ïê‚ïê‚ïê‚ïê‚ïê  advantage
    Anchor 2
</pre>`,
            'prusik': `<pre style="font-family:monospace;font-size:10px;line-height:1.2;text-align:left;color:#60a5fa">
  Main rope
     ‚ïë
   ‚ïî‚ïê‚ï¨‚ïê‚ïó
   ‚ïë ‚ïë ‚ïë  ‚Üê 3 wraps
   ‚ïë ‚ïë ‚ïë    of loop
   ‚ïë ‚ïë ‚ïë
   ‚ïö‚ïê‚ï¨‚ïê‚ïù
     ‚ïë
   ‚ï≠‚îÄ‚ï®‚îÄ‚ïÆ
   ‚îÇ   ‚îÇ ‚Üê Loop ends
   ‚ï∞‚îÄ‚óè‚îÄ‚ïØ
</pre>`,
            'square-lash': `<pre style="font-family:monospace;font-size:10px;line-height:1.2;text-align:left;color:#60a5fa">
      ‚îÇ Vertical
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Horizontal
      ‚îÇ
  ‚ïî‚ïê‚ïê‚ïê‚ï™‚ïê‚ïê‚ïê‚ïó
  ‚ïë   ‚îÇ   ‚ïë Wrapping
  ‚ï†‚ïê‚ïê‚ïê‚ï™‚ïê‚ïê‚ïê‚ï£ turns
  ‚ïë   ‚îÇ   ‚ïë
  ‚ïö‚ïê‚ïê‚ïê‚ï™‚ïê‚ïê‚ïê‚ïù
      ‚îÇ
  ~~~‚îÇ~~~ Frapping
  ~~~‚îÇ~~~ turns
</pre>`,
            'debris-hut': `<pre style="font-family:monospace;font-size:10px;line-height:1.2;text-align:left;color:#60a5fa">
Side view:
         ‚ï±‚îÇ
        ‚ï± ‚îÇ Ridgepole
       ‚ï±  ‚îÇ
      ‚ï±   ‚îÇ
     ‚ï±    ‚îÇ
    ‚ï±     ‚îÇ  ‚Üê Debris
   ‚ï±~~~~~~‚îÇ    2-3ft thick
  ‚ï±~~~~~~~‚îÇ
 ‚ï±~~~~~~~~‚îÇ
‚ï±~~~~~~~~~‚îÇ
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïß‚ïê‚ïê‚ïê‚ïê Ground
 ‚Üë Entrance
</pre>`,
            'solar-still': `<pre style="font-family:monospace;font-size:10px;line-height:1.2;text-align:left;color:#60a5fa">
  ‚ï≠‚îÄ‚îÄ‚îÄ Clear plastic ‚îÄ‚îÄ‚îÄ‚ïÆ
 ‚ï±    ‚Üò  Rock   ‚Üô      ‚ï≤
‚ï±       ‚ï≤     ‚ï±          ‚ï≤
‚îÇ Green   ‚ï≤ ‚ï±  Green      ‚îÇ
‚îÇ plants   ‚óä   plants     ‚îÇ
‚îÇ         ‚îÇ ‚îÇ             ‚îÇ
‚îÇ      ‚îå‚îÄ‚îÄ‚î¥‚îÄ‚î¥‚îÄ‚îÄ‚îê          ‚îÇ
‚îÇ      ‚îÇ Cup   ‚îÇ          ‚îÇ
‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïØ
     Hole in ground
</pre>`,
            'quinzee': `<pre style="font-family:monospace;font-size:10px;line-height:1.2;text-align:left;color:#60a5fa">
Cross section:
      ‚ï±‚ï≤ Vent hole
     ‚ï±‚ñë‚ñë‚ï≤
    ‚ï±‚ñë‚ñë‚ñë‚ñë‚ï≤ ‚Üê Dome ceiling
   ‚ï±‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ï≤
  ‚îÇ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚îÇ ‚Üê 12" thick walls
  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
  ‚îÇ  ‚îÇAir‚îÇ ‚îÇ ‚Üê Sleeping platform
‚ïî‚ïê‚ïß‚ïê‚ïê‚ïß‚ïê‚ïê‚ïê‚ïß‚ïê‚ïß‚ïê‚ïó   (raised)
‚ïë   Entrance  ‚ïë
 ‚Üò slopes up ‚Üô
</pre>`,
            'tripod-lash': `<pre style="font-family:monospace;font-size:10px;line-height:1.2;text-align:left;color:#60a5fa">
Top view (before spreading):
  ‚îÇ   ‚îÇ   ‚îÇ
  ‚îÇ   ‚îÇ   ‚îÇ ‚Üê 3 poles
‚ïê‚ïê‚ï™‚ïê‚ïê‚ïê‚ï™‚ïê‚ïê‚ïê‚ï™‚ïê‚ïê Lashing
  ‚îÇ   ‚îÇ   ‚îÇ
  
After spreading:
     ‚ï±‚îÇ‚ï≤
    ‚ï± ‚îÇ ‚ï≤
   ‚ï±  ‚îÇ  ‚ï≤
  ‚ï±   ‚îÇ   ‚ï≤
 ‚óè‚îÄ‚îÄ‚îÄ‚îÄ‚óè‚îÄ‚îÄ‚îÄ‚îÄ‚óè
</pre>`,
            'bow-drill': `<pre style="font-family:monospace;font-size:10px;line-height:1.2;text-align:left;color:#60a5fa">
    Bearing block
        ‚îå‚îÄ‚óè‚îÄ‚îê ‚Üê Hand pressure
        ‚îÇ ‚îÇ ‚îÇ
        ‚îî‚îÄ‚îº‚îÄ‚îò
          ‚îÇ Spindle
    ‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïÆ
    ‚îÇ  ‚ï±‚ï±‚ï±‚îÇ     ‚îÇ Bow
    ‚îú‚îÄ‚ï±‚ï±‚ï±‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
    ‚îÇ‚ï±‚ï±‚ï±  ‚îÇ     ‚îÇ
    ‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïØ
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï™‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê Fireboard
          V
    Coal catcher
</pre>`
        };
        return diagrams[diagramId] || `<div style="opacity:0.5">Diagram not available</div>`;
    }

    function renderFieldGuidesSearch() {
        const results = FieldGuidesModule.search(fieldGuidesState.searchQuery);

        if (results.length === 0) {
            return `
                <div class="empty-state" style="padding:20px">
                    <div class="empty-state__title">No results found</div>
                    <div class="empty-state__desc">Try different search terms</div>
                </div>
            `;
        }

        return `
            <div class="section-label">Search Results (${results.length})</div>
            <div style="display:flex;flex-direction:column;gap:6px">
                ${results.map(item => `
                    <button class="card" data-fg-item="${item.id}" style="text-align:left">
                        <div class="card__header">
                            <span class="card__title">${item.title}</span>
                            <span class="chip chip--small">${item._subcategoryName}</span>
                        </div>
                        <div class="card__subtitle" style="font-size:11px;opacity:0.7">${item.summary || ''}</div>
                    </button>
                `).join('')}
            </div>
        `;
    }

    function renderFieldGuidesBookmarks() {
        const bookmarked = FieldGuidesModule.getBookmarkedItems();

        if (bookmarked.length === 0) {
            return `
                <div class="empty-state" style="padding:20px">
                    <div class="empty-state__icon">${Icons.get('bookmark')}</div>
                    <div class="empty-state__title">No Bookmarks</div>
                    <div class="empty-state__desc">Bookmark guides for quick access</div>
                </div>
            `;
        }

        return `
            <div class="section-label">Bookmarked Guides (${bookmarked.length})</div>
            <div style="display:flex;flex-direction:column;gap:6px">
                ${bookmarked.map(item => `
                    <button class="card" data-fg-item="${item.id}" style="text-align:left">
                        <div class="card__header">
                            <span class="card__title">${item.title}</span>
                            <span style="color:#f59e0b">${Icons.get('bookmarkFilled')}</span>
                        </div>
                        <div class="card__subtitle" style="font-size:11px;opacity:0.7">${item.summary || ''}</div>
                    </button>
                `).join('')}
            </div>
        `;
    }

    function attachFieldGuidesHandlers() {
        // Back button
        const backBtn = container.querySelector('#fg-back');
        if (backBtn) {
            backBtn.onclick = () => {
                if (fieldGuidesState.searchQuery) {
                    fieldGuidesState.searchQuery = '';
                    const input = container.querySelector('#fg-search');
                    if (input) input.value = '';
                } else if (fieldGuidesState.view === 'detail') {
                    fieldGuidesState.view = 'items';
                    fieldGuidesState.selectedItem = null;
                } else if (fieldGuidesState.view === 'items') {
                    fieldGuidesState.view = 'subcategories';
                    fieldGuidesState.activeSubcategory = null;
                } else if (fieldGuidesState.view === 'subcategories') {
                    fieldGuidesState.view = 'categories';
                    fieldGuidesState.activeCategory = null;
                } else if (fieldGuidesState.view === 'bookmarks') {
                    fieldGuidesState.view = 'categories';
                }
                renderFieldGuides();
            };
        }

        // Bookmarks button
        const bookmarksBtn = container.querySelector('#fg-bookmarks');
        if (bookmarksBtn) {
            bookmarksBtn.onclick = () => {
                fieldGuidesState.view = fieldGuidesState.view === 'bookmarks' ? 'categories' : 'bookmarks';
                fieldGuidesState.searchQuery = '';
                renderFieldGuides();
            };
        }

        // Search
        const searchInput = container.querySelector('#fg-search');
        if (searchInput) {
            searchInput.oninput = (e) => {
                fieldGuidesState.searchQuery = e.target.value;
                document.getElementById('fg-content').innerHTML = renderFieldGuidesContent();
                attachFieldGuidesContentHandlers();
            };
        }

        attachFieldGuidesContentHandlers();
    }

    function attachFieldGuidesContentHandlers() {
        // Category buttons
        container.querySelectorAll('[data-fg-category]').forEach(btn => {
            btn.onclick = () => {
                fieldGuidesState.activeCategory = btn.dataset.fgCategory;
                fieldGuidesState.view = 'subcategories';
                renderFieldGuides();
            };
        });

        // Subcategory buttons
        container.querySelectorAll('[data-fg-subcategory]').forEach(btn => {
            btn.onclick = () => {
                fieldGuidesState.activeSubcategory = btn.dataset.fgSubcategory;
                fieldGuidesState.view = 'items';
                renderFieldGuides();
            };
        });

        // Item buttons
        container.querySelectorAll('[data-fg-item]').forEach(btn => {
            btn.onclick = () => {
                fieldGuidesState.selectedItem = btn.dataset.fgItem;
                fieldGuidesState.view = 'detail';
                renderFieldGuides();
            };
        });

        // Toggle bookmark
        const bookmarkBtn = container.querySelector('#fg-toggle-bookmark');
        if (bookmarkBtn) {
            bookmarkBtn.onclick = () => {
                const id = bookmarkBtn.dataset.id;
                const isNowBookmarked = FieldGuidesModule.toggleBookmark(id);
                ModalsModule.showToast(isNowBookmarked ? 'Bookmarked!' : 'Bookmark removed', 'success');
                renderFieldGuides();
            };
        }
    }

    // ==================== SARSAT Panel ====================
    
    function renderSarsat() {
        _saveScroll(); _restoreScroll();
        const container = document.getElementById('panel-content');
        if (!container) return;
        
        const moduleAvailable = typeof SarsatModule !== 'undefined';
        const isConnected = moduleAvailable && SarsatModule.isConnected();
        const isConnecting = moduleAvailable && SarsatModule.isConnecting();
        const beacons = moduleAvailable ? SarsatModule.getBeacons() : [];
        const emergencyBeacons = moduleAvailable ? SarsatModule.getEmergencyBeacons() : [];
        const stats = moduleAvailable ? SarsatModule.getStats() : { beaconsReceived: 0, messagesDecoded: 0 };
        const settings = moduleAvailable ? SarsatModule.getSettings() : {};
        const BEACON_TYPES = moduleAvailable ? SarsatModule.BEACON_TYPES : {};
        
        const hasEmergency = emergencyBeacons.length > 0;
        
        container.innerHTML = `
            <div class="panel__header">
                <h2 class="panel__title" id="panel-title">
                    ${Icons.get('broadcast')}
                    SARSAT Beacons
                </h2>
                <div class="flex items-center gap-2">
                    ${hasEmergency ? '<span class="text-xs" style="color:#ef4444;animation:pulse 1s infinite">‚óè EMERGENCY</span>' : ''}
                    ${isConnected ? '<span class="text-xs" style="color:#22c55e">‚óè Connected</span>' : ''}
                </div>
            </div>
            
            <div class="panel__body" role="region" aria-label="SARSAT beacon receiver">
                <!-- Module Check -->
                ${!moduleAvailable ? `
                    <div class="alert alert--warning" style="margin-bottom:16px">
                        ‚ö†Ô∏è SARSAT module not loaded. Check console for errors.
                    </div>
                ` : ''}
                
                <!-- Connection Card -->
                <div class="card" style="margin-bottom:16px;${hasEmergency ? 'border-left:3px solid #ef4444' : isConnected ? 'border-left:3px solid #22c55e' : ''}">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                        <span style="font-weight:600">PLB/ELT Receiver</span>
                        <span style="font-size:12px;padding:2px 8px;border-radius:4px;${isConnected ? 'background:rgba(34,197,94,0.2);color:#22c55e' : isConnecting ? 'background:rgba(245,158,11,0.2);color:#f59e0b' : 'background:rgba(100,116,139,0.2);color:#64748b'}">
                            ${isConnected ? 'Connected' : isConnecting ? 'Connecting...' : 'Disconnected'}
                        </span>
                    </div>
                    
                    ${!isConnected ? `
                        <div class="form-group" style="margin-bottom:12px">
                            <label class="form-label">WebSocket Server</label>
                            <input type="text" id="sarsat-ws-url" value="${settings.wsServerUrl || 'ws://localhost:8406'}" 
                                placeholder="ws://raspberrypi.local:8406"
                                style="width:100%;padding:8px;background:var(--bg-primary);border:1px solid var(--border);border-radius:6px;color:var(--text-primary)">
                        </div>
                        
                        <div style="display:flex;gap:8px">
                            <button class="btn btn--primary" id="sarsat-connect-ws" style="flex:1">
                                ${Icons.get('wifi')} Connect WebSocket
                            </button>
                            <button class="btn btn--secondary" id="sarsat-connect-serial">
                                ${Icons.get('usb')} Serial
                            </button>
                        </div>
                        
                        <p style="font-size:11px;color:var(--text-secondary);margin-top:8px">
                            Requires external 406 MHz SDR receiver (Raspberry Pi + RTL-SDR)
                        </p>
                    ` : `
                        <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:8px">
                            <span>Beacons Received:</span>
                            <span style="font-weight:500">${stats.beaconsReceived}</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:12px">
                            <span>Messages Decoded:</span>
                            <span style="font-weight:500">${stats.messagesDecoded}</span>
                        </div>
                        <button class="btn btn--danger" id="sarsat-disconnect" style="width:100%">
                            ${Icons.get('x')} Disconnect
                        </button>
                    `}
                </div>
                
                <!-- Emergency Alert -->
                ${hasEmergency ? `
                    <div class="card" style="margin-bottom:16px;background:rgba(239,68,68,0.1);border:1px solid #ef4444">
                        <div class="card__title" style="color:#ef4444">üö® Active Emergency Beacons</div>
                        ${emergencyBeacons.map(b => `
                            <div style="padding:8px;background:rgba(0,0,0,0.2);border-radius:6px;margin-bottom:8px">
                                <div style="display:flex;justify-content:space-between;align-items:center">
                                    <span style="font-weight:600">${BEACON_TYPES[b.type]?.icon || 'üìç'} ${b.type}</span>
                                    <span style="font-size:11px;color:var(--text-secondary)">${b.countryName}</span>
                                </div>
                                <div style="font-family:monospace;font-size:12px;margin-top:4px">${b.hexId}</div>
                                ${b.lat !== undefined ? `
                                    <div style="font-size:11px;color:var(--text-secondary);margin-top:4px">
                                        üìç ${b.lat.toFixed(4)}¬∞, ${b.lon.toFixed(4)}¬∞
                                    </div>
                                ` : ''}
                                <div style="font-size:10px;color:var(--text-secondary);margin-top:4px">
                                    Last heard: ${new Date(b.lastHeard).toLocaleTimeString()}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                
                <!-- Beacon Types Reference -->
                <div class="card" style="margin-bottom:16px">
                    <div class="card__title">406 MHz Beacon Types</div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px">
                        <div style="display:flex;align-items:center;gap:8px">
                            <span style="font-size:16px">‚úàÔ∏è</span>
                            <div>
                                <div style="font-weight:500">ELT</div>
                                <div style="color:var(--text-secondary);font-size:10px">Aviation</div>
                            </div>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px">
                            <span style="font-size:16px">‚öì</span>
                            <div>
                                <div style="font-weight:500">EPIRB</div>
                                <div style="color:var(--text-secondary);font-size:10px">Maritime</div>
                            </div>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px">
                            <span style="font-size:16px">üö∂</span>
                            <div>
                                <div style="font-weight:500">PLB</div>
                                <div style="color:var(--text-secondary);font-size:10px">Personal</div>
                            </div>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px">
                            <span style="font-size:16px">üö®</span>
                            <div>
                                <div style="font-weight:500">SSAS</div>
                                <div style="color:var(--text-secondary);font-size:10px">Ship Security</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- All Beacons List -->
                <div class="card" style="margin-bottom:16px">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                        <span class="card__title" style="margin:0">Received Beacons (${beacons.length})</span>
                        ${beacons.length > 0 ? `
                            <button class="btn btn--small btn--secondary" id="sarsat-clear">Clear</button>
                        ` : ''}
                    </div>
                    
                    ${beacons.length === 0 ? `
                        <div style="text-align:center;padding:24px;color:var(--text-secondary)">
                            <div style="font-size:32px;margin-bottom:8px">üì°</div>
                            <div>No beacons received</div>
                            <div style="font-size:11px;margin-top:4px">Connect receiver to monitor 406 MHz</div>
                        </div>
                    ` : `
                        <div style="max-height:300px;overflow-y:auto">
                            ${beacons.sort((a, b) => b.lastHeard - a.lastHeard).map(b => `
                                <div style="padding:10px;background:var(--bg-secondary);border-radius:6px;margin-bottom:8px;${b.isTest ? 'opacity:0.7' : ''}" 
                                     data-sarsat-beacon="${b.hexId}">
                                    <div style="display:flex;justify-content:space-between;align-items:center">
                                        <div style="display:flex;align-items:center;gap:8px">
                                            <span style="font-size:18px">${BEACON_TYPES[b.type]?.icon || 'üìç'}</span>
                                            <div>
                                                <div style="font-weight:500">${b.type}${b.isTest ? ' <span style="color:#f59e0b;font-size:10px">[TEST]</span>' : ''}</div>
                                                <div style="font-family:monospace;font-size:11px;color:var(--text-secondary)">${b.hexId}</div>
                                            </div>
                                        </div>
                                        <div style="text-align:right;font-size:11px;color:var(--text-secondary)">
                                            <div>${b.countryName}</div>
                                            <div>${new Date(b.lastHeard).toLocaleTimeString()}</div>
                                        </div>
                                    </div>
                                    ${b.lat !== undefined ? `
                                        <div style="display:flex;justify-content:space-between;margin-top:6px;padding-top:6px;border-top:1px solid var(--border);font-size:11px">
                                            <span>üìç ${b.lat.toFixed(4)}¬∞, ${b.lon.toFixed(4)}¬∞</span>
                                            <button class="btn btn--small" data-sarsat-goto="${b.hexId}">Go To</button>
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>
                
                <!-- Settings -->
                <div class="card">
                    <div class="card__title">Settings</div>
                    
                    <label style="display:flex;align-items:center;gap:8px;margin-bottom:12px;cursor:pointer">
                        <input type="checkbox" id="sarsat-auto-waypoints" ${settings.autoCreateWaypoints ? 'checked' : ''}>
                        <span style="font-size:13px">Auto-create waypoints for beacons</span>
                    </label>
                    
                    <label style="display:flex;align-items:center;gap:8px;margin-bottom:12px;cursor:pointer">
                        <input type="checkbox" id="sarsat-play-alert" ${settings.playAlertSound ? 'checked' : ''}>
                        <span style="font-size:13px">Play alert sound for emergencies</span>
                    </label>
                    
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                        <input type="checkbox" id="sarsat-show-test" ${settings.showTestBeacons ? 'checked' : ''}>
                        <span style="font-size:13px">Show test beacons</span>
                    </label>
                </div>
                
                <!-- Info -->
                <div style="margin-top:16px;padding:12px;background:var(--bg-secondary);border-radius:8px;font-size:11px;color:var(--text-secondary)">
                    <strong>About COSPAS-SARSAT:</strong> International satellite-based search and rescue system. 
                    406 MHz beacons transmit distress signals to orbiting satellites which relay position data to rescue coordination centers.
                    This receiver is for <strong>supplementary monitoring only</strong> - always contact official rescue services in emergencies.
                </div>
            </div>
        `;
        
        attachSarsatHandlers();
    }
    
    function attachSarsatHandlers() {
        const container = document.getElementById('panel-content');
        if (!container || typeof SarsatModule === 'undefined') return;
        
        // Connect WebSocket
        const connectWsBtn = container.querySelector('#sarsat-connect-ws');
        if (connectWsBtn) {
            connectWsBtn.onclick = async () => {
                const urlInput = container.querySelector('#sarsat-ws-url');
                const url = urlInput?.value || 'ws://localhost:8406';
                
                try {
                    SarsatModule.updateSettings({ wsServerUrl: url });
                    await SarsatModule.connectWebSocket(url);
                    renderSarsat();
                } catch (e) {
                    if (typeof ModalsModule !== 'undefined') {
                        ModalsModule.showToast('Connection failed: ' + e.message, 'error');
                    }
                }
            };
        }
        
        // Connect Serial
        const connectSerialBtn = container.querySelector('#sarsat-connect-serial');
        if (connectSerialBtn) {
            connectSerialBtn.onclick = async () => {
                try {
                    await SarsatModule.connectSerial();
                    renderSarsat();
                } catch (e) {
                    if (typeof ModalsModule !== 'undefined') {
                        ModalsModule.showToast('Serial connection failed: ' + e.message, 'error');
                    }
                }
            };
        }
        
        // Disconnect
        const disconnectBtn = container.querySelector('#sarsat-disconnect');
        if (disconnectBtn) {
            disconnectBtn.onclick = () => {
                SarsatModule.disconnect();
                renderSarsat();
            };
        }
        
        // Clear beacons
        const clearBtn = container.querySelector('#sarsat-clear');
        if (clearBtn) {
            clearBtn.onclick = () => {
                if (typeof ModalsModule !== 'undefined') {
                    ModalsModule.confirm({
                        title: 'Clear Beacons',
                        message: 'Remove all received beacons from the list?',
                        confirmText: 'Clear',
                        onConfirm: () => {
                            SarsatModule.clearBeacons();
                            renderSarsat();
                        }
                    });
                } else {
                    SarsatModule.clearBeacons();
                    renderSarsat();
                }
            };
        }
        
        // Go to beacon location
        container.querySelectorAll('[data-sarsat-goto]').forEach(btn => {
            btn.onclick = () => {
                const hexId = btn.dataset.sarsatGoto;
                const beacon = SarsatModule.getBeacon(hexId);
                if (beacon && beacon.lat !== undefined) {
                    if (typeof MapModule !== 'undefined') {
                        MapModule.setView(beacon.lat, beacon.lon, 14);
                    }
                    State.set('isPanelOpen', false);
                }
            };
        });
        
        // Settings checkboxes
        const autoWaypointsCheckbox = container.querySelector('#sarsat-auto-waypoints');
        if (autoWaypointsCheckbox) {
            autoWaypointsCheckbox.onchange = () => {
                SarsatModule.updateSettings({ autoCreateWaypoints: autoWaypointsCheckbox.checked });
            };
        }
        
        const playAlertCheckbox = container.querySelector('#sarsat-play-alert');
        if (playAlertCheckbox) {
            playAlertCheckbox.onchange = () => {
                SarsatModule.updateSettings({ playAlertSound: playAlertCheckbox.checked });
            };
        }
        
        const showTestCheckbox = container.querySelector('#sarsat-show-test');
        if (showTestCheckbox) {
            showTestCheckbox.onchange = () => {
                SarsatModule.updateSettings({ showTestBeacons: showTestCheckbox.checked });
                renderSarsat();
            };
        }
        
        // Listen for beacon updates
        if (typeof Events !== 'undefined') {
            Events.on('sarsat:beacon_received', () => {
                if (State.get('activePanel') === 'sarsat') {
                    renderSarsat();
                }
            });
        }
    }

    // ==================== RF Sentinel Panel ====================
    
    function renderRFSentinel() {
        _saveScroll(); _restoreScroll();
        const container = document.getElementById('panel-content');
        if (!container) return;
        
        const isConnected = typeof RFSentinelModule !== 'undefined' && RFSentinelModule.isConnected();
        const isConnecting = typeof RFSentinelModule !== 'undefined' && RFSentinelModule.isConnecting();
        const connectionMode = isConnected ? RFSentinelModule.getConnectionMode() : null;
        const connectionMethod = typeof RFSentinelModule !== 'undefined' ? RFSentinelModule.getConnectionMethod() : 'auto';
        const trackCounts = isConnected ? RFSentinelModule.getTrackCounts() : { aircraft: 0, ship: 0, drone: 0, fpv: 0, radiosonde: 0, aprs: 0 };
        const trackTypeSettings = typeof RFSentinelModule !== 'undefined' ? RFSentinelModule.getTrackTypeSettings() : {};
        const weatherSource = typeof RFSentinelModule !== 'undefined' ? RFSentinelModule.getWeatherSource() : 'internet';
        const fisBData = typeof RFSentinelModule !== 'undefined' ? RFSentinelModule.getFisBData() : { isStale: true };
        const emergencyTracks = isConnected ? RFSentinelModule.getEmergencyTracks() : [];
        const fpvTracks = isConnected ? RFSentinelModule.getTracksByType('fpv') : [];
        const host = typeof RFSentinelModule !== 'undefined' ? RFSentinelModule.getHost() : 'rfsentinel.local';
        const port = typeof RFSentinelModule !== 'undefined' ? RFSentinelModule.getPort() : 8080;
        const mqttPort = typeof RFSentinelModule !== 'undefined' ? RFSentinelModule.getMqttPort() : 9001;
        const useHttps = typeof RFSentinelModule !== 'undefined' ? RFSentinelModule.getUseHttps() : 'auto';
        const stats = isConnected ? RFSentinelModule.getStats() : null;
        
        const totalTracks = Object.values(trackCounts).reduce((a, b) => a + b, 0);
        
        container.innerHTML = `
            <div class="panel__header">
                <h2 class="panel__title" id="panel-title">
                    ${Icons.get('radar')}
                    RF Sentinel
                </h2>
                <div class="flex items-center gap-2">
                    ${isConnected ? `<span class="text-xs" style="color:#22c55e">‚óè ${connectionMode?.toUpperCase()}</span>` : ''}
                </div>
            </div>
            
            <div class="panel__body" role="region" aria-label="RF Sentinel controls">
                <!-- Connection Status -->
                <div class="card" style="margin-bottom:1rem;${isConnected ? 'border-left:3px solid #22c55e' : emergencyTracks.length > 0 ? 'border-left:3px solid #ef4444' : ''}">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem">
                        <span style="font-weight:600;color:#f8fafc">Connection</span>
                        <span style="font-size:0.75rem;padding:2px 8px;border-radius:4px;${isConnected ? 'background:#22c55e20;color:#22c55e' : isConnecting ? 'background:#f59e0b20;color:#f59e0b' : 'background:#64748b20;color:#64748b'}">
                            ${isConnected ? 'Connected' : isConnecting ? 'Connecting...' : 'Disconnected'}
                        </span>
                    </div>
                    
                    ${!isConnected ? `
                        <div style="margin-bottom:0.75rem">
                            <label style="display:block;font-size:0.75rem;color:#94a3b8;margin-bottom:0.25rem">Connection Method</label>
                            <select id="rfs-connection-method" style="width:100%;padding:0.5rem;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#f8fafc;font-size:0.875rem">
                                <option value="auto" ${connectionMethod === 'auto' ? 'selected' : ''}>Auto (recommended)</option>
                                <option value="websocket" ${connectionMethod === 'websocket' ? 'selected' : ''}>WebSocket</option>
                                <option value="mqtt" ${connectionMethod === 'mqtt' ? 'selected' : ''}>MQTT</option>
                                <option value="rest" ${connectionMethod === 'rest' ? 'selected' : ''}>REST Polling</option>
                            </select>
                            <div style="font-size:0.65rem;color:#64748b;margin-top:0.25rem">
                                ${connectionMethod === 'auto' ? 'Tries WebSocket first, falls back to REST' :
                                  connectionMethod === 'websocket' ? 'Real-time push via native WebSocket' :
                                  connectionMethod === 'mqtt' ? 'Pub/sub via MQTT over WebSocket (requires broker on port ' + mqttPort + ')' :
                                  'Periodic fetch every 5 seconds'}
                            </div>
                        </div>
                        <div style="margin-bottom:0.75rem">
                            <label style="display:block;font-size:0.75rem;color:#94a3b8;margin-bottom:0.25rem">Host / IP Address</label>
                            <input type="text" id="rfs-host" value="${host}" placeholder="rfsentinel.local or 192.168.1.x" 
                                   style="width:100%;padding:0.5rem;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#f8fafc;font-size:0.875rem">
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;margin-bottom:0.75rem">
                            <div>
                                <label style="display:block;font-size:0.75rem;color:#94a3b8;margin-bottom:0.25rem">API Port</label>
                                <input type="number" id="rfs-port" value="${port}" placeholder="8080" 
                                       style="width:100%;padding:0.5rem;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#f8fafc;font-size:0.875rem">
                            </div>
                            <div id="rfs-mqtt-port-container" style="${connectionMethod === 'mqtt' ? '' : 'opacity:0.5'}">
                                <label style="display:block;font-size:0.75rem;color:#94a3b8;margin-bottom:0.25rem">MQTT Port</label>
                                <input type="number" id="rfs-mqtt-port" value="${mqttPort}" placeholder="9001" 
                                       style="width:100%;padding:0.5rem;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#f8fafc;font-size:0.875rem"
                                       ${connectionMethod === 'mqtt' ? '' : 'disabled'}>
                            </div>
                        </div>
                        <div style="margin-bottom:0.75rem">
                            <label style="display:block;font-size:0.75rem;color:#94a3b8;margin-bottom:0.25rem">Protocol</label>
                            <select id="rfs-protocol" style="width:100%;padding:0.5rem;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#f8fafc;font-size:0.875rem">
                                <option value="auto" ${useHttps === 'auto' ? 'selected' : ''}>Auto (HTTP for local, match page for remote)</option>
                                <option value="false" ${useHttps === false ? 'selected' : ''}>HTTP / WS</option>
                                <option value="true" ${useHttps === true ? 'selected' : ''}>HTTPS / WSS</option>
                            </select>
                            <div style="font-size:0.65rem;color:#64748b;margin-top:0.25rem">
                                ${useHttps === 'auto' ? 'Uses HTTP for .local and private IPs, HTTPS for remote hosts' :
                                  useHttps === true ? 'Force HTTPS/WSS ‚Äî requires RF Sentinel TLS enabled' :
                                  'Force HTTP/WS ‚Äî standard for local network connections'}
                            </div>
                        </div>
                    ` : `
                        <div style="font-size:0.75rem;color:#94a3b8;margin-bottom:0.5rem">
                            ${host}:${connectionMode === 'mqtt' ? mqttPort : port} (${connectionMode})
                        </div>
                    `}
                    
                    ${isConnected ? `
                        <button id="rfs-disconnect" class="btn btn--secondary" style="width:100%">
                            Disconnect
                        </button>
                    ` : `
                        <button id="rfs-connect" class="btn btn--primary" style="width:100%" ${isConnecting ? 'disabled' : ''}>
                            ${isConnecting ? 'Connecting...' : 'Connect'}
                        </button>
                    `}
                </div>
                
                <!-- Emergency Alerts -->
                ${emergencyTracks.length > 0 ? `
                    <div class="card" style="margin-bottom:1rem;background:#ef444420;border:1px solid #ef4444">
                        <div style="font-weight:600;color:#ef4444;margin-bottom:0.5rem;display:flex;align-items:center;gap:0.5rem">
                            ${Icons.get('alertTriangle')}
                            Emergency Alerts (${emergencyTracks.length})
                        </div>
                        ${emergencyTracks.slice(0, 3).map(e => `
                            <div style="font-size:0.75rem;color:#fca5a5;padding:0.25rem 0;border-top:1px solid #ef444440">
                                ${e.squawk ? `üö® Squawk ${e.squawk} (${e.info.name})` : `üÜò AIS ${e.deviceType}`}
                                - ${e.track.callsign || e.track.name || e.track.id?.slice(0, 8)}
                            </div>
                        `).join('')}
                        ${emergencyTracks.length > 3 ? `<div style="font-size:0.7rem;color:#94a3b8">+${emergencyTracks.length - 3} more</div>` : ''}
                    </div>
                ` : ''}
                
                <!-- Track Statistics -->
                ${isConnected ? `
                    <div class="card" style="margin-bottom:1rem">
                        <div style="font-weight:600;color:#f8fafc;margin-bottom:0.75rem">
                            Active Tracks: ${totalTracks}
                        </div>
                        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:0.5rem">
                            <div style="text-align:center;padding:0.5rem;background:#3b82f620;border-radius:6px">
                                <div style="font-size:1.25rem">‚úàÔ∏è</div>
                                <div style="font-size:1.125rem;font-weight:600;color:#3b82f6">${trackCounts.aircraft}</div>
                                <div style="font-size:0.65rem;color:#94a3b8">Aircraft</div>
                            </div>
                            <div style="text-align:center;padding:0.5rem;background:#06b6d420;border-radius:6px">
                                <div style="font-size:1.25rem">üö¢</div>
                                <div style="font-size:1.125rem;font-weight:600;color:#06b6d4">${trackCounts.ship}</div>
                                <div style="font-size:0.65rem;color:#94a3b8">Ships</div>
                            </div>
                            <div style="text-align:center;padding:0.5rem;background:#f59e0b20;border-radius:6px">
                                <div style="font-size:1.25rem">üõ∏</div>
                                <div style="font-size:1.125rem;font-weight:600;color:#f59e0b">${trackCounts.drone}</div>
                                <div style="font-size:0.65rem;color:#94a3b8">Drones (RID)</div>
                            </div>
                            <div style="text-align:center;padding:0.5rem;background:#ef444420;border-radius:6px">
                                <div style="font-size:1.25rem">üì°</div>
                                <div style="font-size:1.125rem;font-weight:600;color:#ef4444">${trackCounts.fpv || 0}</div>
                                <div style="font-size:0.65rem;color:#94a3b8">Drones (FPV)</div>
                            </div>
                        </div>
                        ${stats ? `
                            <div style="font-size:0.7rem;color:#64748b;margin-top:0.5rem;text-align:right">
                                Last update: ${stats.lastUpdate ? new Date(stats.lastUpdate).toLocaleTimeString() : 'N/A'}
                            </div>
                        ` : ''}
                    </div>
                ` : ''}
                
                <!-- FPV Drone Detections (RF Signal Only) -->
                ${isConnected && (trackCounts.fpv > 0 || trackTypeSettings.fpv?.enabled) ? `
                    <div class="card" style="margin-bottom:1rem;border:1px solid #ef444440">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem">
                            <div style="font-weight:600;color:#ef4444;display:flex;align-items:center;gap:0.5rem">
                                üì° FPV Drone Detections
                                <span style="font-size:0.7rem;font-weight:400;color:#94a3b8;background:#1e293b;padding:0.125rem 0.375rem;border-radius:4px">Pro</span>
                            </div>
                            <span style="font-size:0.75rem;color:#94a3b8">${trackCounts.fpv || 0} active</span>
                        </div>
                        
                        ${fpvTracks.length > 0 ? `
                            <div style="display:flex;flex-direction:column;gap:0.5rem;max-height:300px;overflow-y:auto">
                                ${fpvTracks.slice(0, 10).map(track => renderFPVTrackCard(track)).join('')}
                                ${fpvTracks.length > 10 ? `
                                    <div style="font-size:0.7rem;color:#64748b;text-align:center;padding:0.5rem">
                                        +${fpvTracks.length - 10} more detections
                                    </div>
                                ` : ''}
                            </div>
                        ` : `
                            <div style="text-align:center;padding:1rem;color:#64748b;font-size:0.8rem">
                                <div style="font-size:1.5rem;margin-bottom:0.5rem">üì°</div>
                                No FPV signals detected
                                <div style="font-size:0.7rem;margin-top:0.25rem">
                                    Monitoring 5.8 GHz / 2.4 GHz / 915 MHz bands
                                </div>
                            </div>
                        `}
                        
                        <div style="margin-top:0.75rem;padding-top:0.75rem;border-top:1px solid #334155">
                            <div style="font-size:0.65rem;color:#64748b;line-height:1.4">
                                <strong>‚ö†Ô∏è RF-Only Detection:</strong> FPV tracks are detected by radio frequency analysis only. 
                                No GPS position is available unless correlated with Remote ID broadcasts.
                            </div>
                            <div style="font-size:0.6rem;color:#475569;margin-top:0.375rem;line-height:1.3">
                                FPV detection requires RF Sentinel Pro license and compatible SDR hardware (Ettus B210).
                                Intended for authorized security, safety, and research applications only.
                            </div>
                        </div>
                    </div>
                ` : ''}
                
                <!-- Map Layer Toggles -->
                <div class="card" style="margin-bottom:1rem">
                    <div style="font-weight:600;color:#f8fafc;margin-bottom:0.75rem">
                        Map Layers
                    </div>
                    <div style="font-size:0.7rem;color:#94a3b8;margin-bottom:0.75rem">
                        Toggle which detection types appear on the map
                    </div>
                    
                    ${renderTrackTypeToggle('aircraft', '‚úàÔ∏è', 'Aircraft', trackCounts.aircraft, trackTypeSettings.aircraft?.enabled, '#3b82f6', 'ADS-B 1090 MHz', isConnected)}
                    ${renderTrackTypeToggle('ship', 'üö¢', 'Ships', trackCounts.ship, trackTypeSettings.ship?.enabled, '#06b6d4', 'AIS 162 MHz', isConnected)}
                    ${renderTrackTypeToggle('drone', 'üõ∏', 'Drones (Remote ID)', trackCounts.drone, trackTypeSettings.drone?.enabled, '#f59e0b', 'WiFi/BLE with GPS', isConnected)}
                    ${renderTrackTypeToggle('radiosonde', 'üéà', 'Radiosondes', trackCounts.radiosonde, trackTypeSettings.radiosonde?.enabled, '#8b5cf6', '400 MHz', isConnected)}
                    ${renderTrackTypeToggle('aprs', 'üìª', 'APRS', trackCounts.aprs, trackTypeSettings.aprs?.enabled, '#22c55e', '144.39 MHz', isConnected)}
                    
                    ${trackCounts.fpv > 0 ? `
                        <div style="margin-top:0.5rem;padding:0.5rem;background:#ef444410;border-radius:6px;border:1px dashed #ef444440">
                            <div style="font-size:0.7rem;color:#fca5a5;display:flex;align-items:center;gap:0.375rem">
                                üì° <span style="color:#ef4444;font-weight:500">${trackCounts.fpv}</span> FPV drone${trackCounts.fpv !== 1 ? 's' : ''} detected (RF-only, no map position)
                            </div>
                        </div>
                    ` : ''}
                </div>
                
                <!-- Weather Source Toggle -->
                <div class="card" style="margin-bottom:1rem">
                    <div style="font-weight:600;color:#f8fafc;margin-bottom:0.75rem">
                        Weather Data Source
                    </div>
                    <div style="font-size:0.7rem;color:#94a3b8;margin-bottom:0.75rem">
                        Choose between internet weather services or off-grid FIS-B data
                    </div>
                    
                    <div style="display:flex;flex-direction:column;gap:0.5rem">
                        <label style="display:flex;align-items:center;gap:0.75rem;padding:0.75rem;background:${weatherSource === 'internet' ? '#3b82f620' : '#1e293b'};border:1px solid ${weatherSource === 'internet' ? '#3b82f6' : '#334155'};border-radius:8px;cursor:pointer">
                            <input type="radio" name="weather-source" value="internet" ${weatherSource === 'internet' ? 'checked' : ''} 
                                   style="accent-color:#3b82f6" id="rfs-weather-internet">
                            <div style="flex:1">
                                <div style="font-weight:500;color:#f8fafc">üåê Internet (NWS/IEM)</div>
                                <div style="font-size:0.7rem;color:#94a3b8">Reliable, always available when online</div>
                            </div>
                        </label>
                        
                        <label style="display:flex;align-items:center;gap:0.75rem;padding:0.75rem;background:${weatherSource === 'fisb' ? '#22c55e20' : '#1e293b'};border:1px solid ${weatherSource === 'fisb' ? '#22c55e' : '#334155'};border-radius:8px;cursor:pointer;${!isConnected ? 'opacity:0.5' : ''}">
                            <input type="radio" name="weather-source" value="fisb" ${weatherSource === 'fisb' ? 'checked' : ''} 
                                   style="accent-color:#22c55e" id="rfs-weather-fisb" ${!isConnected ? 'disabled' : ''}>
                            <div style="flex:1">
                                <div style="font-weight:500;color:#f8fafc">üì° RF Sentinel FIS-B</div>
                                <div style="font-size:0.7rem;color:#94a3b8">Off-grid via 978 MHz UAT receiver</div>
                            </div>
                        </label>
                    </div>
                    
                    ${weatherSource === 'fisb' && isConnected ? `
                        <div style="margin-top:0.75rem;padding:0.5rem;background:#0f172a;border-radius:6px">
                            <div style="display:flex;justify-content:space-between;align-items:center">
                                <span style="font-size:0.75rem;color:#94a3b8">FIS-B Status:</span>
                                <span style="font-size:0.75rem;color:${fisBData.isStale ? '#f59e0b' : '#22c55e'}">
                                    ${fisBData.isStale ? '‚ö†Ô∏è Stale' : '‚óè Receiving'}
                                </span>
                            </div>
                            ${fisBData.lastUpdate ? `
                                <div style="font-size:0.65rem;color:#64748b;margin-top:0.25rem">
                                    Last update: ${new Date(fisBData.lastUpdate).toLocaleTimeString()}
                                </div>
                            ` : ''}
                            ${fisBData.isStale ? `
                                <div style="font-size:0.65rem;color:#f59e0b;margin-top:0.25rem">
                                    ‚ö†Ô∏è No FIS-B data received recently. Weather panel will use cached data or fall back to internet.
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                </div>
                
                <!-- Help Info -->
                <div class="card" style="background:#0f172a">
                    <div style="font-weight:600;color:#f8fafc;margin-bottom:0.5rem">
                        About RF Sentinel
                    </div>
                    <div style="font-size:0.75rem;color:#94a3b8;line-height:1.5">
                        RF Sentinel is a separate SDR-based detection system that tracks aircraft, ships, drones, and other RF signals. 
                        Connect GridDown to RF Sentinel running on your local network for real-time situational awareness without internet dependency.
                    </div>
                    <div style="font-size:0.7rem;color:#64748b;margin-top:0.5rem">
                        Supported signals: ADS-B, AIS, Remote ID, 978 UAT (FIS-B weather), Radiosondes, APRS
                    </div>
                </div>
            </div>
        `;
        
        attachRFSentinelHandlers();
    }
    
    function renderTrackTypeToggle(type, icon, name, count, enabled, color, freq, isConnected) {
        return `
            <div style="display:flex;align-items:center;justify-content:space-between;padding:0.5rem 0;border-bottom:1px solid #1e293b">
                <div style="display:flex;align-items:center;gap:0.5rem">
                    <span style="font-size:1rem">${icon}</span>
                    <div>
                        <div style="font-size:0.875rem;color:#f8fafc">${name}</div>
                        <div style="font-size:0.65rem;color:#64748b">${freq}</div>
                    </div>
                </div>
                <div style="display:flex;align-items:center;gap:0.75rem">
                    ${isConnected ? `<span style="font-size:0.75rem;color:${color};font-weight:500">${count}</span>` : ''}
                    <label class="toggle-switch" style="--toggle-color:${color}">
                        <input type="checkbox" id="rfs-toggle-${type}" ${enabled ? 'checked' : ''}>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
        `;
    }
    
    /**
     * Render an FPV drone track card for the RF Sentinel panel
     * Shows protocol, frequency, signal strength, and correlation status
     */
    function renderFPVTrackCard(track) {
        // Extract track data with fallbacks
        const protocol = track.primary_protocol || track.protocol || 'unknown';
        const protocolDisplay = formatFPVProtocol(protocol);
        const freqMhz = track.primary_frequency_mhz || track.frequency_mhz || 0;
        const band = track.primary_band || track.band || '';
        const signalDbm = track.primary_signal_dbm || track.signal_strength_dbm || -100;
        const channelName = track.video_link?.channel_name || track.channel_name || '';
        const bandwidthMhz = track.video_link?.bandwidth_mhz || track.bandwidth_mhz || 0;
        
        // Active links
        const hasVideo = !!track.video_link;
        const hasTelemetry = !!track.telemetry_link;
        const hasControl = !!track.control_link;
        
        // Correlation with Remote ID
        const correlatedId = track.correlated_remoteid_id;
        const correlationConfidence = track.correlation_confidence || 0;
        
        // Time since first seen
        const firstSeen = track.first_seen ? new Date(track.first_seen) : null;
        const timeSinceFirst = firstSeen ? formatTimeSince(firstSeen) : 'Unknown';
        
        // Signal strength bar (map -100 to -30 dBm to 0-100%)
        const signalPercent = Math.max(0, Math.min(100, ((signalDbm + 100) / 70) * 100));
        const signalColor = signalPercent > 60 ? '#22c55e' : signalPercent > 30 ? '#f59e0b' : '#ef4444';
        
        // Protocol color coding
        const protocolColors = {
            'dji_digital': '#ef4444',      // Red - DJI
            'dji_control': '#ef4444',
            'analog_fpv': '#f97316',        // Orange - Analog
            'walksnail': '#8b5cf6',         // Purple - Walksnail
            'hdzero': '#06b6d4',            // Cyan - HDZero
            'elrs_900': '#22c55e',          // Green - ELRS
            'elrs_2400': '#22c55e',
            'crossfire_915': '#3b82f6',     // Blue - Crossfire
            'crossfire_868': '#3b82f6',
            'frsky': '#eab308',             // Yellow - FrSky
            'rfd900': '#a855f7',            // Purple - RFD
            'unknown': '#64748b'            // Gray - Unknown
        };
        const protocolColor = protocolColors[protocol] || protocolColors['unknown'];
        
        return `
            <div style="background:#1e293b;border-radius:8px;padding:0.75rem;border-left:3px solid ${protocolColor}">
                <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:0.5rem">
                    <div>
                        <div style="font-weight:600;color:${protocolColor};font-size:0.85rem">${protocolDisplay.icon} ${protocolDisplay.name}</div>
                        <div style="font-size:0.7rem;color:#94a3b8">
                            ${freqMhz.toFixed(1)} MHz${channelName ? ` (${channelName})` : ''}${bandwidthMhz ? ` ‚Ä¢ ${bandwidthMhz} MHz wide` : ''}
                        </div>
                    </div>
                    <div style="text-align:right">
                        <div style="font-size:0.8rem;font-weight:600;color:${signalColor}">${signalDbm.toFixed(0)} dBm</div>
                        <div style="width:50px;height:4px;background:#0f172a;border-radius:2px;overflow:hidden;margin-top:2px">
                            <div style="width:${signalPercent}%;height:100%;background:${signalColor}"></div>
                        </div>
                    </div>
                </div>
                
                <div style="display:flex;gap:0.375rem;flex-wrap:wrap;margin-bottom:0.375rem">
                    ${hasVideo ? `<span style="font-size:0.6rem;background:#ef444430;color:#fca5a5;padding:0.125rem 0.375rem;border-radius:4px">üì∫ Video</span>` : ''}
                    ${hasControl ? `<span style="font-size:0.6rem;background:#3b82f630;color:#93c5fd;padding:0.125rem 0.375rem;border-radius:4px">üéÆ Control</span>` : ''}
                    ${hasTelemetry ? `<span style="font-size:0.6rem;background:#22c55e30;color:#86efac;padding:0.125rem 0.375rem;border-radius:4px">üìä Telemetry</span>` : ''}
                    ${track.fhss_detected ? `<span style="font-size:0.6rem;background:#8b5cf630;color:#c4b5fd;padding:0.125rem 0.375rem;border-radius:4px">‚ö° FHSS</span>` : ''}
                </div>
                
                ${correlatedId ? `
                    <div style="font-size:0.65rem;color:#22c55e;background:#22c55e15;padding:0.25rem 0.5rem;border-radius:4px;margin-bottom:0.375rem">
                        üîó Correlated with Remote ID: ${correlatedId.slice(0, 12)}${correlatedId.length > 12 ? '...' : ''}
                        ${correlationConfidence > 0 ? ` (${(correlationConfidence * 100).toFixed(0)}%)` : ''}
                    </div>
                ` : ''}
                
                <div style="font-size:0.6rem;color:#64748b">
                    First detected: ${timeSinceFirst}${track.detection_count ? ` ‚Ä¢ ${track.detection_count} updates` : ''}
                </div>
            </div>
        `;
    }
    
    /**
     * Format FPV protocol name for display
     */
    function formatFPVProtocol(protocol) {
        const protocols = {
            'unknown': { name: 'Unknown Signal', icon: '‚ùì' },
            'analog_fpv': { name: 'Analog FPV', icon: 'üì∫' },
            'dji_digital': { name: 'DJI Digital', icon: 'üî¥' },
            'dji_control': { name: 'DJI Control', icon: 'üéÆ' },
            'walksnail': { name: 'Walksnail Avatar', icon: 'üü£' },
            'hdzero': { name: 'HDZero', icon: 'üîµ' },
            'shark_byte': { name: 'SharkByte', icon: 'ü¶à' },
            'elrs_900': { name: 'ELRS 900', icon: 'üü¢' },
            'elrs_2400': { name: 'ELRS 2.4G', icon: 'üü¢' },
            'elrs_868': { name: 'ELRS 868', icon: 'üü¢' },
            'crossfire_915': { name: 'Crossfire', icon: 'üîµ' },
            'crossfire_868': { name: 'Crossfire EU', icon: 'üîµ' },
            'frsky': { name: 'FrSky', icon: 'üü°' },
            'spektrum': { name: 'Spektrum', icon: 'üü†' },
            'flysky': { name: 'FlySky', icon: '‚ö™' },
            'rfd900': { name: 'RFD900', icon: 'üü£' },
            'rfd868': { name: 'RFD868', icon: 'üü£' },
            'sik': { name: 'SiK Radio', icon: 'üìª' },
            '3dr': { name: '3DR Telemetry', icon: 'üìª' },
            'dragonlink': { name: 'DragonLink', icon: 'üêâ' },
            'mlrs': { name: 'MLRS', icon: 'üì°' },
            'wifi_drone': { name: 'WiFi Drone', icon: 'üì∂' }
        };
        
        return protocols[protocol] || protocols['unknown'];
    }
    
    /**
     * Format time since a given date
     */
    function formatTimeSince(date) {
        const now = new Date();
        const seconds = Math.floor((now - date) / 1000);
        
        if (seconds < 60) return `${seconds}s ago`;
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return `${minutes}m ago`;
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours}h ago`;
        const days = Math.floor(hours / 24);
        return `${days}d ago`;
    }
    
    function attachRFSentinelHandlers() {
        // Connection method dropdown
        const methodSelect = document.getElementById('rfs-connection-method');
        if (methodSelect) {
            methodSelect.onchange = () => {
                if (typeof RFSentinelModule !== 'undefined') {
                    RFSentinelModule.setConnectionMethod(methodSelect.value);
                    
                    // Update MQTT port field visibility
                    const mqttPortContainer = document.getElementById('rfs-mqtt-port-container');
                    const mqttPortInput = domCache.get('rfs-mqtt-port');
                    if (mqttPortContainer && mqttPortInput) {
                        if (methodSelect.value === 'mqtt') {
                            mqttPortContainer.style.opacity = '1';
                            mqttPortInput.disabled = false;
                        } else {
                            mqttPortContainer.style.opacity = '0.5';
                            mqttPortInput.disabled = true;
                        }
                    }
                    
                    // Re-render to update description text
                    renderRFSentinel();
                }
            };
        }
        
        // Protocol selector
        const protocolSelect = document.getElementById('rfs-protocol');
        if (protocolSelect) {
            protocolSelect.onchange = () => {
                if (typeof RFSentinelModule !== 'undefined') {
                    const val = protocolSelect.value;
                    RFSentinelModule.setUseHttps(val === 'true' ? true : val === 'false' ? false : 'auto');
                    renderRFSentinel();
                }
            };
        }
        
        // Connect button
        const connectBtn = document.getElementById('rfs-connect');
        if (connectBtn) {
            connectBtn.onclick = async () => {
                const hostInput = document.getElementById('rfs-host');
                const portInput = document.getElementById('rfs-port');
                const mqttPortInput = domCache.get('rfs-mqtt-port');
                const host = hostInput?.value || 'rfsentinel.local';
                const port = parseInt(portInput?.value) || 8080;
                const mqttPort = parseInt(mqttPortInput?.value) || 9001;
                
                if (typeof RFSentinelModule !== 'undefined') {
                    connectBtn.disabled = true;
                    connectBtn.textContent = 'Connecting...';
                    
                    // Set MQTT port before connecting
                    RFSentinelModule.setMqttPort(mqttPort);
                    
                    const success = await RFSentinelModule.connect(host, port, mqttPort);
                    
                    if (success) {
                        const mode = RFSentinelModule.getConnectionMode();
                        ModalsModule.showToast(`Connected to RF Sentinel (${mode})`, 'success');
                    } else {
                        ModalsModule.showToast('Failed to connect to RF Sentinel', 'error');
                    }
                    
                    renderRFSentinel();
                }
            };
        }
        
        // Disconnect button
        const disconnectBtn = document.getElementById('rfs-disconnect');
        if (disconnectBtn) {
            disconnectBtn.onclick = () => {
                if (typeof RFSentinelModule !== 'undefined') {
                    RFSentinelModule.disconnect();
                    ModalsModule.showToast('Disconnected from RF Sentinel', 'info');
                    renderRFSentinel();
                }
            };
        }
        
        // Track type toggles
        ['aircraft', 'ship', 'drone', 'radiosonde', 'aprs'].forEach(type => {
            const toggle = document.getElementById(`rfs-toggle-${type}`);
            if (toggle) {
                toggle.onchange = () => {
                    if (typeof RFSentinelModule !== 'undefined') {
                        RFSentinelModule.setTrackTypeEnabled(type, toggle.checked);
                        // Don't re-render, just update map
                        if (typeof MapModule !== 'undefined') {
                            MapModule.render();
                        }
                    }
                };
            }
        });
        
        // Weather source toggles
        const weatherInternet = document.getElementById('rfs-weather-internet');
        const weatherFisb = document.getElementById('rfs-weather-fisb');
        
        if (weatherInternet) {
            weatherInternet.onchange = () => {
                if (weatherInternet.checked && typeof RFSentinelModule !== 'undefined') {
                    RFSentinelModule.setWeatherSource('internet');
                    ModalsModule.showToast('Weather source: Internet (NWS/IEM)', 'info');
                    renderRFSentinel();
                }
            };
        }
        
        if (weatherFisb) {
            weatherFisb.onchange = () => {
                if (weatherFisb.checked && typeof RFSentinelModule !== 'undefined') {
                    RFSentinelModule.setWeatherSource('fisb');
                    ModalsModule.showToast('Weather source: RF Sentinel FIS-B (off-grid)', 'info');
                    // Fetch current FIS-B data
                    RFSentinelModule.fetchFisBWeather();
                    renderRFSentinel();
                }
            };
        }
    }

    return { init, render };
})();
window.PanelsModule = PanelsModule;